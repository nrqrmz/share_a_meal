// mapbox-gl@3.11.1 downloaded from https://ga.jspm.io/npm:mapbox-gl@3.11.1/dist/mapbox-gl.js

var F=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var Me={};(function(F,Le){Me=Le()})(0,(function(){var Me,Le,Oe;function define(F,Fe){if(Me)if(Le){var je="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+Me+")(sharedChunk); ("+Le+")(sharedChunk); self.onerror = null;";var qe={};Me(qe);Oe=Fe(qe);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(Oe.workerUrl=window.URL.createObjectURL(new Blob([je],{type:"text/javascript"})))}else Le=Fe;else Me=Fe}define(["exports"],(function(Me){function e(F){return F&&F.__esModule&&Object.prototype.hasOwnProperty.call(F,"default")?F.default:F}var Le,Oe={},Fe={};function s(){if(Le)return Fe;Le=1,Object.defineProperty(Fe,"__esModule",{value:!0}),Fe.setMatrixArrayType=function(F){Fe.ARRAY_TYPE=Me=F},Fe.toRadian=function(F){return F*je},Fe.equals=function(Me,Le){return Math.abs(Me-Le)<=F*Math.max(1,Math.abs(Me),Math.abs(Le))},Fe.RANDOM=Fe.ARRAY_TYPE=Fe.EPSILON=void 0;var F=1e-6;Fe.EPSILON=F;var Me="undefined"!=typeof Float32Array?Float32Array:Array;Fe.ARRAY_TYPE=Me;var Oe=Math.random;Fe.RANDOM=Oe;var je=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var F=0,Me=arguments.length;Me--;)F+=arguments[Me]*arguments[Me];return Math.sqrt(F)}),Fe}var je,qe={};function l(){if(je)return qe;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}je=1,Object.defineProperty(qe,"__esModule",{value:!0}),qe.create=function(){var Me=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Me[1]=0,Me[2]=0),Me[0]=1,Me[3]=1,Me},qe.clone=function(Me){var Le=new F.ARRAY_TYPE(4);return Le[0]=Me[0],Le[1]=Me[1],Le[2]=Me[2],Le[3]=Me[3],Le},qe.copy=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[3],F},qe.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F},qe.fromValues=function(Me,Le,Oe,Fe){var je=new F.ARRAY_TYPE(4);return je[0]=Me,je[1]=Le,je[2]=Oe,je[3]=Fe,je},qe.set=function(F,Me,Le,Oe,Fe){return F[0]=Me,F[1]=Le,F[2]=Oe,F[3]=Fe,F},qe.transpose=function(F,Me){if(F===Me){var Le=Me[1];F[1]=Me[2],F[2]=Le}else F[0]=Me[0],F[1]=Me[2],F[2]=Me[1],F[3]=Me[3];return F},qe.invert=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Le*je-Fe*Oe;return qe?(F[0]=je*(qe=1/qe),F[1]=-Oe*qe,F[2]=-Fe*qe,F[3]=Le*qe,F):null},qe.adjoint=function(F,Me){var Le=Me[0];return F[0]=Me[3],F[1]=-Me[1],F[2]=-Me[2],F[3]=Le,F},qe.determinant=function(F){return F[0]*F[3]-F[2]*F[1]},qe.multiply=n,qe.rotate=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Math.sin(Le),xt=Math.cos(Le);return F[0]=Oe*xt+je*He,F[1]=Fe*xt+qe*He,F[2]=Oe*-He+je*xt,F[3]=Fe*-He+qe*xt,F},qe.scale=function(F,Me,Le){var Oe=Me[1],Fe=Me[2],je=Me[3],qe=Le[0],He=Le[1];return F[0]=Me[0]*qe,F[1]=Oe*qe,F[2]=Fe*He,F[3]=je*He,F},qe.fromRotation=function(F,Me){var Le=Math.sin(Me),Oe=Math.cos(Me);return F[0]=Oe,F[1]=Le,F[2]=-Le,F[3]=Oe,F},qe.fromScaling=function(F,Me){return F[0]=Me[0],F[1]=0,F[2]=0,F[3]=Me[1],F},qe.str=function(F){return"mat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},qe.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3])},qe.LDU=function(F,Me,Le,Oe){return F[2]=Oe[2]/Oe[0],Le[0]=Oe[0],Le[1]=Oe[1],Le[3]=Oe[3]-F[2]*Le[1],[F,Me,Le]},qe.add=function(F,Me,Le){return F[0]=Me[0]+Le[0],F[1]=Me[1]+Le[1],F[2]=Me[2]+Le[2],F[3]=Me[3]+Le[3],F},qe.subtract=i,qe.exactEquals=function(F,Me){return F[0]===Me[0]&&F[1]===Me[1]&&F[2]===Me[2]&&F[3]===Me[3]},qe.equals=function(Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Le[0],xt=Le[1],Pt=Le[2],jt=Le[3];return Math.abs(Oe-He)<=F.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(He))&&Math.abs(Fe-xt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(xt))&&Math.abs(je-Pt)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(Pt))&&Math.abs(qe-jt)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(jt))},qe.multiplyScalar=function(F,Me,Le){return F[0]=Me[0]*Le,F[1]=Me[1]*Le,F[2]=Me[2]*Le,F[3]=Me[3]*Le,F},qe.multiplyScalarAndAdd=function(F,Me,Le,Oe){return F[0]=Me[0]+Le[0]*Oe,F[1]=Me[1]+Le[1]*Oe,F[2]=Me[2]+Le[2]*Oe,F[3]=Me[3]+Le[3]*Oe,F},qe.sub=qe.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Me=r(void 0);if(Me&&Me.has(F))return Me.get(F);var Le={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in F)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(F,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(F,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Le,Fe,je):Le[Fe]=F[Fe]}return Le.default=F,Me&&Me.set(F,Le),Le}(s());function r(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(r=function(F){return F?Le:Me})(F)}function n(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Le[0],xt=Le[1],Pt=Le[2],jt=Le[3];return F[0]=Oe*He+je*xt,F[1]=Fe*He+qe*xt,F[2]=Oe*Pt+je*jt,F[3]=Fe*Pt+qe*jt,F}function i(F,Me,Le){return F[0]=Me[0]-Le[0],F[1]=Me[1]-Le[1],F[2]=Me[2]-Le[2],F[3]=Me[3]-Le[3],F}return qe.mul=n,qe.sub=i,qe}var He,xt={};function h(){if(He)return xt;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}He=1,Object.defineProperty(xt,"__esModule",{value:!0}),xt.create=function(){var Me=new F.ARRAY_TYPE(6);return F.ARRAY_TYPE!=Float32Array&&(Me[1]=0,Me[2]=0,Me[4]=0,Me[5]=0),Me[0]=1,Me[3]=1,Me},xt.clone=function(Me){var Le=new F.ARRAY_TYPE(6);return Le[0]=Me[0],Le[1]=Me[1],Le[2]=Me[2],Le[3]=Me[3],Le[4]=Me[4],Le[5]=Me[5],Le},xt.copy=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[3],F[4]=Me[4],F[5]=Me[5],F},xt.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F},xt.fromValues=function(Me,Le,Oe,Fe,je,qe){var He=new F.ARRAY_TYPE(6);return He[0]=Me,He[1]=Le,He[2]=Oe,He[3]=Fe,He[4]=je,He[5]=qe,He},xt.set=function(F,Me,Le,Oe,Fe,je,qe){return F[0]=Me,F[1]=Le,F[2]=Oe,F[3]=Fe,F[4]=je,F[5]=qe,F},xt.invert=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Me[4],He=Me[5],xt=Le*je-Oe*Fe;return xt?(F[0]=je*(xt=1/xt),F[1]=-Oe*xt,F[2]=-Fe*xt,F[3]=Le*xt,F[4]=(Fe*He-je*qe)*xt,F[5]=(Oe*qe-Le*He)*xt,F):null},xt.determinant=function(F){return F[0]*F[3]-F[1]*F[2]},xt.multiply=n,xt.rotate=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Math.sin(Le),jt=Math.cos(Le);return F[0]=Oe*jt+je*Pt,F[1]=Fe*jt+qe*Pt,F[2]=Oe*-Pt+je*jt,F[3]=Fe*-Pt+qe*jt,F[4]=He,F[5]=xt,F},xt.scale=function(F,Me,Le){var Oe=Me[1],Fe=Me[2],je=Me[3],qe=Me[4],He=Me[5],xt=Le[0],Pt=Le[1];return F[0]=Me[0]*xt,F[1]=Oe*xt,F[2]=Fe*Pt,F[3]=je*Pt,F[4]=qe,F[5]=He,F},xt.translate=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Le[0],jt=Le[1];return F[0]=Oe,F[1]=Fe,F[2]=je,F[3]=qe,F[4]=Oe*Pt+je*jt+He,F[5]=Fe*Pt+qe*jt+xt,F},xt.fromRotation=function(F,Me){var Le=Math.sin(Me),Oe=Math.cos(Me);return F[0]=Oe,F[1]=Le,F[2]=-Le,F[3]=Oe,F[4]=0,F[5]=0,F},xt.fromScaling=function(F,Me){return F[0]=Me[0],F[1]=0,F[2]=0,F[3]=Me[1],F[4]=0,F[5]=0,F},xt.fromTranslation=function(F,Me){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F[4]=Me[0],F[5]=Me[1],F},xt.str=function(F){return"mat2d("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+")"},xt.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],1)},xt.add=function(F,Me,Le){return F[0]=Me[0]+Le[0],F[1]=Me[1]+Le[1],F[2]=Me[2]+Le[2],F[3]=Me[3]+Le[3],F[4]=Me[4]+Le[4],F[5]=Me[5]+Le[5],F},xt.subtract=i,xt.multiplyScalar=function(F,Me,Le){return F[0]=Me[0]*Le,F[1]=Me[1]*Le,F[2]=Me[2]*Le,F[3]=Me[3]*Le,F[4]=Me[4]*Le,F[5]=Me[5]*Le,F},xt.multiplyScalarAndAdd=function(F,Me,Le,Oe){return F[0]=Me[0]+Le[0]*Oe,F[1]=Me[1]+Le[1]*Oe,F[2]=Me[2]+Le[2]*Oe,F[3]=Me[3]+Le[3]*Oe,F[4]=Me[4]+Le[4]*Oe,F[5]=Me[5]+Le[5]*Oe,F},xt.exactEquals=function(F,Me){return F[0]===Me[0]&&F[1]===Me[1]&&F[2]===Me[2]&&F[3]===Me[3]&&F[4]===Me[4]&&F[5]===Me[5]},xt.equals=function(Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Le[0],jt=Le[1],Gt=Le[2],bi=Le[3],wi=Le[4],qr=Le[5];return Math.abs(Oe-Pt)<=F.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(Pt))&&Math.abs(Fe-jt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(jt))&&Math.abs(je-Gt)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(Gt))&&Math.abs(qe-bi)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(bi))&&Math.abs(He-wi)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(wi))&&Math.abs(xt-qr)<=F.EPSILON*Math.max(1,Math.abs(xt),Math.abs(qr))},xt.sub=xt.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Me=r(void 0);if(Me&&Me.has(F))return Me.get(F);var Le={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in F)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(F,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(F,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Le,Fe,je):Le[Fe]=F[Fe]}return Le.default=F,Me&&Me.set(F,Le),Le}(s());function r(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(r=function(F){return F?Le:Me})(F)}function n(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Le[0],jt=Le[1],Gt=Le[2],bi=Le[3],wi=Le[4],qr=Le[5];return F[0]=Oe*Pt+je*jt,F[1]=Fe*Pt+qe*jt,F[2]=Oe*Gt+je*bi,F[3]=Fe*Gt+qe*bi,F[4]=Oe*wi+je*qr+He,F[5]=Fe*wi+qe*qr+xt,F}function i(F,Me,Le){return F[0]=Me[0]-Le[0],F[1]=Me[1]-Le[1],F[2]=Me[2]-Le[2],F[3]=Me[3]-Le[3],F[4]=Me[4]-Le[4],F[5]=Me[5]-Le[5],F}return xt.mul=n,xt.sub=i,xt}var Pt,jt={};function d(){if(Pt)return jt;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Pt=1,Object.defineProperty(jt,"__esModule",{value:!0}),jt.create=function(){var Me=new F.ARRAY_TYPE(9);return F.ARRAY_TYPE!=Float32Array&&(Me[1]=0,Me[2]=0,Me[3]=0,Me[5]=0,Me[6]=0,Me[7]=0),Me[0]=1,Me[4]=1,Me[8]=1,Me},jt.fromMat4=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[4],F[4]=Me[5],F[5]=Me[6],F[6]=Me[8],F[7]=Me[9],F[8]=Me[10],F},jt.clone=function(Me){var Le=new F.ARRAY_TYPE(9);return Le[0]=Me[0],Le[1]=Me[1],Le[2]=Me[2],Le[3]=Me[3],Le[4]=Me[4],Le[5]=Me[5],Le[6]=Me[6],Le[7]=Me[7],Le[8]=Me[8],Le},jt.copy=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[3],F[4]=Me[4],F[5]=Me[5],F[6]=Me[6],F[7]=Me[7],F[8]=Me[8],F},jt.fromValues=function(Me,Le,Oe,Fe,je,qe,He,xt,Pt){var jt=new F.ARRAY_TYPE(9);return jt[0]=Me,jt[1]=Le,jt[2]=Oe,jt[3]=Fe,jt[4]=je,jt[5]=qe,jt[6]=He,jt[7]=xt,jt[8]=Pt,jt},jt.set=function(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt){return F[0]=Me,F[1]=Le,F[2]=Oe,F[3]=Fe,F[4]=je,F[5]=qe,F[6]=He,F[7]=xt,F[8]=Pt,F},jt.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=1,F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},jt.transpose=function(F,Me){if(F===Me){var Le=Me[1],Oe=Me[2],Fe=Me[5];F[1]=Me[3],F[2]=Me[6],F[3]=Le,F[5]=Me[7],F[6]=Oe,F[7]=Fe}else F[0]=Me[0],F[1]=Me[3],F[2]=Me[6],F[3]=Me[1],F[4]=Me[4],F[5]=Me[7],F[6]=Me[2],F[7]=Me[5],F[8]=Me[8];return F},jt.invert=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Me[4],He=Me[5],xt=Me[6],Pt=Me[7],jt=Me[8],Gt=jt*qe-He*Pt,bi=-jt*je+He*xt,wi=Pt*je-qe*xt,qr=Le*Gt+Oe*bi+Fe*wi;return qr?(F[0]=Gt*(qr=1/qr),F[1]=(-jt*Oe+Fe*Pt)*qr,F[2]=(He*Oe-Fe*qe)*qr,F[3]=bi*qr,F[4]=(jt*Le-Fe*xt)*qr,F[5]=(-He*Le+Fe*je)*qr,F[6]=wi*qr,F[7]=(-Pt*Le+Oe*xt)*qr,F[8]=(qe*Le-Oe*je)*qr,F):null},jt.adjoint=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Me[4],He=Me[5],xt=Me[6],Pt=Me[7],jt=Me[8];return F[0]=qe*jt-He*Pt,F[1]=Fe*Pt-Oe*jt,F[2]=Oe*He-Fe*qe,F[3]=He*xt-je*jt,F[4]=Le*jt-Fe*xt,F[5]=Fe*je-Le*He,F[6]=je*Pt-qe*xt,F[7]=Oe*xt-Le*Pt,F[8]=Le*qe-Oe*je,F},jt.determinant=function(F){var Me=F[3],Le=F[4],Oe=F[5],Fe=F[6],je=F[7],qe=F[8];return F[0]*(qe*Le-Oe*je)+F[1]*(-qe*Me+Oe*Fe)+F[2]*(je*Me-Le*Fe)},jt.multiply=n,jt.translate=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Me[6],jt=Me[7],Gt=Me[8],bi=Le[0],wi=Le[1];return F[0]=Oe,F[1]=Fe,F[2]=je,F[3]=qe,F[4]=He,F[5]=xt,F[6]=bi*Oe+wi*qe+Pt,F[7]=bi*Fe+wi*He+jt,F[8]=bi*je+wi*xt+Gt,F},jt.rotate=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Me[6],jt=Me[7],Gt=Me[8],bi=Math.sin(Le),wi=Math.cos(Le);return F[0]=wi*Oe+bi*qe,F[1]=wi*Fe+bi*He,F[2]=wi*je+bi*xt,F[3]=wi*qe-bi*Oe,F[4]=wi*He-bi*Fe,F[5]=wi*xt-bi*je,F[6]=Pt,F[7]=jt,F[8]=Gt,F},jt.scale=function(F,Me,Le){var Oe=Le[0],Fe=Le[1];return F[0]=Oe*Me[0],F[1]=Oe*Me[1],F[2]=Oe*Me[2],F[3]=Fe*Me[3],F[4]=Fe*Me[4],F[5]=Fe*Me[5],F[6]=Me[6],F[7]=Me[7],F[8]=Me[8],F},jt.fromTranslation=function(F,Me){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=1,F[5]=0,F[6]=Me[0],F[7]=Me[1],F[8]=1,F},jt.fromRotation=function(F,Me){var Le=Math.sin(Me),Oe=Math.cos(Me);return F[0]=Oe,F[1]=Le,F[2]=0,F[3]=-Le,F[4]=Oe,F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},jt.fromScaling=function(F,Me){return F[0]=Me[0],F[1]=0,F[2]=0,F[3]=0,F[4]=Me[1],F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},jt.fromMat2d=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=0,F[3]=Me[2],F[4]=Me[3],F[5]=0,F[6]=Me[4],F[7]=Me[5],F[8]=1,F},jt.fromQuat=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Le+Le,He=Oe+Oe,xt=Fe+Fe,Pt=Le*qe,jt=Oe*qe,Gt=Oe*He,bi=Fe*qe,wi=Fe*He,qr=Fe*xt,Xn=je*qe,Yn=je*He,yo=je*xt;return F[0]=1-Gt-qr,F[3]=jt-yo,F[6]=bi+Yn,F[1]=jt+yo,F[4]=1-Pt-qr,F[7]=wi-Xn,F[2]=bi-Yn,F[5]=wi+Xn,F[8]=1-Pt-Gt,F},jt.normalFromMat4=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Me[4],He=Me[5],xt=Me[6],Pt=Me[7],jt=Me[8],Gt=Me[9],bi=Me[10],wi=Me[11],qr=Me[12],Xn=Me[13],Yn=Me[14],yo=Me[15],bo=Le*He-Oe*qe,Ro=Le*xt-Fe*qe,Do=Le*Pt-je*qe,zs=Oe*xt-Fe*He,Zs=Oe*Pt-je*He,na=Fe*Pt-je*xt,el=jt*Xn-Gt*qr,nl=jt*Yn-bi*qr,hl=jt*yo-wi*qr,pl=Gt*Yn-bi*Xn,bl=Gt*yo-wi*Xn,Tl=bi*yo-wi*Yn,kl=bo*Tl-Ro*bl+Do*pl+zs*hl-Zs*nl+na*el;return kl?(F[0]=(He*Tl-xt*bl+Pt*pl)*(kl=1/kl),F[1]=(xt*hl-qe*Tl-Pt*nl)*kl,F[2]=(qe*bl-He*hl+Pt*el)*kl,F[3]=(Fe*bl-Oe*Tl-je*pl)*kl,F[4]=(Le*Tl-Fe*hl+je*nl)*kl,F[5]=(Oe*hl-Le*bl-je*el)*kl,F[6]=(Xn*na-Yn*Zs+yo*zs)*kl,F[7]=(Yn*Do-qr*na-yo*Ro)*kl,F[8]=(qr*Zs-Xn*Do+yo*bo)*kl,F):null},jt.projection=function(F,Me,Le){return F[0]=2/Me,F[1]=0,F[2]=0,F[3]=0,F[4]=-2/Le,F[5]=0,F[6]=-1,F[7]=1,F[8]=1,F},jt.str=function(F){return"mat3("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+", "+F[8]+")"},jt.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8])},jt.add=function(F,Me,Le){return F[0]=Me[0]+Le[0],F[1]=Me[1]+Le[1],F[2]=Me[2]+Le[2],F[3]=Me[3]+Le[3],F[4]=Me[4]+Le[4],F[5]=Me[5]+Le[5],F[6]=Me[6]+Le[6],F[7]=Me[7]+Le[7],F[8]=Me[8]+Le[8],F},jt.subtract=i,jt.multiplyScalar=function(F,Me,Le){return F[0]=Me[0]*Le,F[1]=Me[1]*Le,F[2]=Me[2]*Le,F[3]=Me[3]*Le,F[4]=Me[4]*Le,F[5]=Me[5]*Le,F[6]=Me[6]*Le,F[7]=Me[7]*Le,F[8]=Me[8]*Le,F},jt.multiplyScalarAndAdd=function(F,Me,Le,Oe){return F[0]=Me[0]+Le[0]*Oe,F[1]=Me[1]+Le[1]*Oe,F[2]=Me[2]+Le[2]*Oe,F[3]=Me[3]+Le[3]*Oe,F[4]=Me[4]+Le[4]*Oe,F[5]=Me[5]+Le[5]*Oe,F[6]=Me[6]+Le[6]*Oe,F[7]=Me[7]+Le[7]*Oe,F[8]=Me[8]+Le[8]*Oe,F},jt.exactEquals=function(F,Me){return F[0]===Me[0]&&F[1]===Me[1]&&F[2]===Me[2]&&F[3]===Me[3]&&F[4]===Me[4]&&F[5]===Me[5]&&F[6]===Me[6]&&F[7]===Me[7]&&F[8]===Me[8]},jt.equals=function(Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Me[6],jt=Me[7],Gt=Me[8],bi=Le[0],wi=Le[1],qr=Le[2],Xn=Le[3],Yn=Le[4],yo=Le[5],bo=Le[6],Ro=Le[7],Do=Le[8];return Math.abs(Oe-bi)<=F.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(bi))&&Math.abs(Fe-wi)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(wi))&&Math.abs(je-qr)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(qr))&&Math.abs(qe-Xn)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(Xn))&&Math.abs(He-Yn)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(Yn))&&Math.abs(xt-yo)<=F.EPSILON*Math.max(1,Math.abs(xt),Math.abs(yo))&&Math.abs(Pt-bo)<=F.EPSILON*Math.max(1,Math.abs(Pt),Math.abs(bo))&&Math.abs(jt-Ro)<=F.EPSILON*Math.max(1,Math.abs(jt),Math.abs(Ro))&&Math.abs(Gt-Do)<=F.EPSILON*Math.max(1,Math.abs(Gt),Math.abs(Do))},jt.sub=jt.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Me=r(void 0);if(Me&&Me.has(F))return Me.get(F);var Le={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in F)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(F,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(F,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Le,Fe,je):Le[Fe]=F[Fe]}return Le.default=F,Me&&Me.set(F,Le),Le}(s());function r(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(r=function(F){return F?Le:Me})(F)}function n(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Me[6],jt=Me[7],Gt=Me[8],bi=Le[0],wi=Le[1],qr=Le[2],Xn=Le[3],Yn=Le[4],yo=Le[5],bo=Le[6],Ro=Le[7],Do=Le[8];return F[0]=bi*Oe+wi*qe+qr*Pt,F[1]=bi*Fe+wi*He+qr*jt,F[2]=bi*je+wi*xt+qr*Gt,F[3]=Xn*Oe+Yn*qe+yo*Pt,F[4]=Xn*Fe+Yn*He+yo*jt,F[5]=Xn*je+Yn*xt+yo*Gt,F[6]=bo*Oe+Ro*qe+Do*Pt,F[7]=bo*Fe+Ro*He+Do*jt,F[8]=bo*je+Ro*xt+Do*Gt,F}function i(F,Me,Le){return F[0]=Me[0]-Le[0],F[1]=Me[1]-Le[1],F[2]=Me[2]-Le[2],F[3]=Me[3]-Le[3],F[4]=Me[4]-Le[4],F[5]=Me[5]-Le[5],F[6]=Me[6]-Le[6],F[7]=Me[7]-Le[7],F[8]=Me[8]-Le[8],F}return jt.mul=n,jt.sub=i,jt}var Gt,bi={};function g(){if(Gt)return bi;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Gt=1,Object.defineProperty(bi,"__esModule",{value:!0}),bi.create=function(){var Me=new F.ARRAY_TYPE(16);return F.ARRAY_TYPE!=Float32Array&&(Me[1]=0,Me[2]=0,Me[3]=0,Me[4]=0,Me[6]=0,Me[7]=0,Me[8]=0,Me[9]=0,Me[11]=0,Me[12]=0,Me[13]=0,Me[14]=0),Me[0]=1,Me[5]=1,Me[10]=1,Me[15]=1,Me},bi.clone=function(Me){var Le=new F.ARRAY_TYPE(16);return Le[0]=Me[0],Le[1]=Me[1],Le[2]=Me[2],Le[3]=Me[3],Le[4]=Me[4],Le[5]=Me[5],Le[6]=Me[6],Le[7]=Me[7],Le[8]=Me[8],Le[9]=Me[9],Le[10]=Me[10],Le[11]=Me[11],Le[12]=Me[12],Le[13]=Me[13],Le[14]=Me[14],Le[15]=Me[15],Le},bi.copy=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[3],F[4]=Me[4],F[5]=Me[5],F[6]=Me[6],F[7]=Me[7],F[8]=Me[8],F[9]=Me[9],F[10]=Me[10],F[11]=Me[11],F[12]=Me[12],F[13]=Me[13],F[14]=Me[14],F[15]=Me[15],F},bi.fromValues=function(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn){var yo=new F.ARRAY_TYPE(16);return yo[0]=Me,yo[1]=Le,yo[2]=Oe,yo[3]=Fe,yo[4]=je,yo[5]=qe,yo[6]=He,yo[7]=xt,yo[8]=Pt,yo[9]=jt,yo[10]=Gt,yo[11]=bi,yo[12]=wi,yo[13]=qr,yo[14]=Xn,yo[15]=Yn,yo},bi.set=function(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn){return F[0]=Me,F[1]=Le,F[2]=Oe,F[3]=Fe,F[4]=je,F[5]=qe,F[6]=He,F[7]=xt,F[8]=Pt,F[9]=jt,F[10]=Gt,F[11]=bi,F[12]=wi,F[13]=qr,F[14]=Xn,F[15]=Yn,F},bi.identity=n,bi.transpose=function(F,Me){if(F===Me){var Le=Me[1],Oe=Me[2],Fe=Me[3],je=Me[6],qe=Me[7],He=Me[11];F[1]=Me[4],F[2]=Me[8],F[3]=Me[12],F[4]=Le,F[6]=Me[9],F[7]=Me[13],F[8]=Oe,F[9]=je,F[11]=Me[14],F[12]=Fe,F[13]=qe,F[14]=He}else F[0]=Me[0],F[1]=Me[4],F[2]=Me[8],F[3]=Me[12],F[4]=Me[1],F[5]=Me[5],F[6]=Me[9],F[7]=Me[13],F[8]=Me[2],F[9]=Me[6],F[10]=Me[10],F[11]=Me[14],F[12]=Me[3],F[13]=Me[7],F[14]=Me[11],F[15]=Me[15];return F},bi.invert=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Me[4],He=Me[5],xt=Me[6],Pt=Me[7],jt=Me[8],Gt=Me[9],bi=Me[10],wi=Me[11],qr=Me[12],Xn=Me[13],Yn=Me[14],yo=Me[15],bo=Le*He-Oe*qe,Ro=Le*xt-Fe*qe,Do=Le*Pt-je*qe,zs=Oe*xt-Fe*He,Zs=Oe*Pt-je*He,na=Fe*Pt-je*xt,el=jt*Xn-Gt*qr,nl=jt*Yn-bi*qr,hl=jt*yo-wi*qr,pl=Gt*Yn-bi*Xn,bl=Gt*yo-wi*Xn,Tl=bi*yo-wi*Yn,kl=bo*Tl-Ro*bl+Do*pl+zs*hl-Zs*nl+na*el;return kl?(F[0]=(He*Tl-xt*bl+Pt*pl)*(kl=1/kl),F[1]=(Fe*bl-Oe*Tl-je*pl)*kl,F[2]=(Xn*na-Yn*Zs+yo*zs)*kl,F[3]=(bi*Zs-Gt*na-wi*zs)*kl,F[4]=(xt*hl-qe*Tl-Pt*nl)*kl,F[5]=(Le*Tl-Fe*hl+je*nl)*kl,F[6]=(Yn*Do-qr*na-yo*Ro)*kl,F[7]=(jt*na-bi*Do+wi*Ro)*kl,F[8]=(qe*bl-He*hl+Pt*el)*kl,F[9]=(Oe*hl-Le*bl-je*el)*kl,F[10]=(qr*Zs-Xn*Do+yo*bo)*kl,F[11]=(Gt*Do-jt*Zs-wi*bo)*kl,F[12]=(He*nl-qe*pl-xt*el)*kl,F[13]=(Le*pl-Oe*nl+Fe*el)*kl,F[14]=(Xn*Ro-qr*zs-Yn*bo)*kl,F[15]=(jt*zs-Gt*Ro+bi*bo)*kl,F):null},bi.adjoint=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Me[4],He=Me[5],xt=Me[6],Pt=Me[7],jt=Me[8],Gt=Me[9],bi=Me[10],wi=Me[11],qr=Me[12],Xn=Me[13],Yn=Me[14],yo=Me[15];return F[0]=He*(bi*yo-wi*Yn)-Gt*(xt*yo-Pt*Yn)+Xn*(xt*wi-Pt*bi),F[1]=-(Oe*(bi*yo-wi*Yn)-Gt*(Fe*yo-je*Yn)+Xn*(Fe*wi-je*bi)),F[2]=Oe*(xt*yo-Pt*Yn)-He*(Fe*yo-je*Yn)+Xn*(Fe*Pt-je*xt),F[3]=-(Oe*(xt*wi-Pt*bi)-He*(Fe*wi-je*bi)+Gt*(Fe*Pt-je*xt)),F[4]=-(qe*(bi*yo-wi*Yn)-jt*(xt*yo-Pt*Yn)+qr*(xt*wi-Pt*bi)),F[5]=Le*(bi*yo-wi*Yn)-jt*(Fe*yo-je*Yn)+qr*(Fe*wi-je*bi),F[6]=-(Le*(xt*yo-Pt*Yn)-qe*(Fe*yo-je*Yn)+qr*(Fe*Pt-je*xt)),F[7]=Le*(xt*wi-Pt*bi)-qe*(Fe*wi-je*bi)+jt*(Fe*Pt-je*xt),F[8]=qe*(Gt*yo-wi*Xn)-jt*(He*yo-Pt*Xn)+qr*(He*wi-Pt*Gt),F[9]=-(Le*(Gt*yo-wi*Xn)-jt*(Oe*yo-je*Xn)+qr*(Oe*wi-je*Gt)),F[10]=Le*(He*yo-Pt*Xn)-qe*(Oe*yo-je*Xn)+qr*(Oe*Pt-je*He),F[11]=-(Le*(He*wi-Pt*Gt)-qe*(Oe*wi-je*Gt)+jt*(Oe*Pt-je*He)),F[12]=-(qe*(Gt*Yn-bi*Xn)-jt*(He*Yn-xt*Xn)+qr*(He*bi-xt*Gt)),F[13]=Le*(Gt*Yn-bi*Xn)-jt*(Oe*Yn-Fe*Xn)+qr*(Oe*bi-Fe*Gt),F[14]=-(Le*(He*Yn-xt*Xn)-qe*(Oe*Yn-Fe*Xn)+qr*(Oe*xt-Fe*He)),F[15]=Le*(He*bi-xt*Gt)-qe*(Oe*bi-Fe*Gt)+jt*(Oe*xt-Fe*He),F},bi.determinant=function(F){var Me=F[0],Le=F[1],Oe=F[2],Fe=F[3],je=F[4],qe=F[5],He=F[6],xt=F[7],Pt=F[8],jt=F[9],Gt=F[10],bi=F[11],wi=F[12],qr=F[13],Xn=F[14],Yn=F[15];return(Me*qe-Le*je)*(Gt*Yn-bi*Xn)-(Me*He-Oe*je)*(jt*Yn-bi*qr)+(Me*xt-Fe*je)*(jt*Xn-Gt*qr)+(Le*He-Oe*qe)*(Pt*Yn-bi*wi)-(Le*xt-Fe*qe)*(Pt*Xn-Gt*wi)+(Oe*xt-Fe*He)*(Pt*qr-jt*wi)},bi.multiply=i,bi.translate=function(F,Me,Le){var Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn=Le[0],Yn=Le[1],yo=Le[2];return Me===F?(F[12]=Me[0]*Xn+Me[4]*Yn+Me[8]*yo+Me[12],F[13]=Me[1]*Xn+Me[5]*Yn+Me[9]*yo+Me[13],F[14]=Me[2]*Xn+Me[6]*Yn+Me[10]*yo+Me[14],F[15]=Me[3]*Xn+Me[7]*Yn+Me[11]*yo+Me[15]):(Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Me[6],jt=Me[7],Gt=Me[8],bi=Me[9],wi=Me[10],qr=Me[11],F[0]=Oe=Me[0],F[1]=Fe,F[2]=je,F[3]=qe,F[4]=He,F[5]=xt,F[6]=Pt,F[7]=jt,F[8]=Gt,F[9]=bi,F[10]=wi,F[11]=qr,F[12]=Oe*Xn+He*Yn+Gt*yo+Me[12],F[13]=Fe*Xn+xt*Yn+bi*yo+Me[13],F[14]=je*Xn+Pt*Yn+wi*yo+Me[14],F[15]=qe*Xn+jt*Yn+qr*yo+Me[15]),F},bi.scale=function(F,Me,Le){var Oe=Le[0],Fe=Le[1],je=Le[2];return F[0]=Me[0]*Oe,F[1]=Me[1]*Oe,F[2]=Me[2]*Oe,F[3]=Me[3]*Oe,F[4]=Me[4]*Fe,F[5]=Me[5]*Fe,F[6]=Me[6]*Fe,F[7]=Me[7]*Fe,F[8]=Me[8]*je,F[9]=Me[9]*je,F[10]=Me[10]*je,F[11]=Me[11]*je,F[12]=Me[12],F[13]=Me[13],F[14]=Me[14],F[15]=Me[15],F},bi.rotate=function(Me,Le,Oe,Fe){var je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do,zs,Zs,na,el,nl,hl,pl,bl,Tl=Fe[0],kl=Fe[1],ec=Fe[2],tc=Math.hypot(Tl,kl,ec);return tc<F.EPSILON?null:(Tl*=tc=1/tc,kl*=tc,ec*=tc,je=Math.sin(Oe),qe=Math.cos(Oe),Pt=Le[1],jt=Le[2],Gt=Le[3],wi=Le[5],qr=Le[6],Xn=Le[7],yo=Le[9],bo=Le[10],Ro=Le[11],Do=Tl*Tl*(He=1-qe)+qe,na=Tl*kl*He-ec*je,el=kl*kl*He+qe,nl=ec*kl*He+Tl*je,hl=Tl*ec*He+kl*je,pl=kl*ec*He-Tl*je,bl=ec*ec*He+qe,Me[0]=(xt=Le[0])*Do+(bi=Le[4])*(zs=kl*Tl*He+ec*je)+(Yn=Le[8])*(Zs=ec*Tl*He-kl*je),Me[1]=Pt*Do+wi*zs+yo*Zs,Me[2]=jt*Do+qr*zs+bo*Zs,Me[3]=Gt*Do+Xn*zs+Ro*Zs,Me[4]=xt*na+bi*el+Yn*nl,Me[5]=Pt*na+wi*el+yo*nl,Me[6]=jt*na+qr*el+bo*nl,Me[7]=Gt*na+Xn*el+Ro*nl,Me[8]=xt*hl+bi*pl+Yn*bl,Me[9]=Pt*hl+wi*pl+yo*bl,Me[10]=jt*hl+qr*pl+bo*bl,Me[11]=Gt*hl+Xn*pl+Ro*bl,Le!==Me&&(Me[12]=Le[12],Me[13]=Le[13],Me[14]=Le[14],Me[15]=Le[15]),Me)},bi.rotateX=function(F,Me,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le),je=Me[4],qe=Me[5],He=Me[6],xt=Me[7],Pt=Me[8],jt=Me[9],Gt=Me[10],bi=Me[11];return Me!==F&&(F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[3],F[12]=Me[12],F[13]=Me[13],F[14]=Me[14],F[15]=Me[15]),F[4]=je*Fe+Pt*Oe,F[5]=qe*Fe+jt*Oe,F[6]=He*Fe+Gt*Oe,F[7]=xt*Fe+bi*Oe,F[8]=Pt*Fe-je*Oe,F[9]=jt*Fe-qe*Oe,F[10]=Gt*Fe-He*Oe,F[11]=bi*Fe-xt*Oe,F},bi.rotateY=function(F,Me,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le),je=Me[0],qe=Me[1],He=Me[2],xt=Me[3],Pt=Me[8],jt=Me[9],Gt=Me[10],bi=Me[11];return Me!==F&&(F[4]=Me[4],F[5]=Me[5],F[6]=Me[6],F[7]=Me[7],F[12]=Me[12],F[13]=Me[13],F[14]=Me[14],F[15]=Me[15]),F[0]=je*Fe-Pt*Oe,F[1]=qe*Fe-jt*Oe,F[2]=He*Fe-Gt*Oe,F[3]=xt*Fe-bi*Oe,F[8]=je*Oe+Pt*Fe,F[9]=qe*Oe+jt*Fe,F[10]=He*Oe+Gt*Fe,F[11]=xt*Oe+bi*Fe,F},bi.rotateZ=function(F,Me,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le),je=Me[0],qe=Me[1],He=Me[2],xt=Me[3],Pt=Me[4],jt=Me[5],Gt=Me[6],bi=Me[7];return Me!==F&&(F[8]=Me[8],F[9]=Me[9],F[10]=Me[10],F[11]=Me[11],F[12]=Me[12],F[13]=Me[13],F[14]=Me[14],F[15]=Me[15]),F[0]=je*Fe+Pt*Oe,F[1]=qe*Fe+jt*Oe,F[2]=He*Fe+Gt*Oe,F[3]=xt*Fe+bi*Oe,F[4]=Pt*Fe-je*Oe,F[5]=jt*Fe-qe*Oe,F[6]=Gt*Fe-He*Oe,F[7]=bi*Fe-xt*Oe,F},bi.fromTranslation=function(F,Me){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=Me[0],F[13]=Me[1],F[14]=Me[2],F[15]=1,F},bi.fromScaling=function(F,Me){return F[0]=Me[0],F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=Me[1],F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=Me[2],F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},bi.fromRotation=function(Me,Le,Oe){var Fe,je,qe,He=Oe[0],xt=Oe[1],Pt=Oe[2],jt=Math.hypot(He,xt,Pt);return jt<F.EPSILON?null:(He*=jt=1/jt,xt*=jt,Pt*=jt,Fe=Math.sin(Le),je=Math.cos(Le),Me[0]=He*He*(qe=1-je)+je,Me[1]=xt*He*qe+Pt*Fe,Me[2]=Pt*He*qe-xt*Fe,Me[3]=0,Me[4]=He*xt*qe-Pt*Fe,Me[5]=xt*xt*qe+je,Me[6]=Pt*xt*qe+He*Fe,Me[7]=0,Me[8]=He*Pt*qe+xt*Fe,Me[9]=xt*Pt*qe-He*Fe,Me[10]=Pt*Pt*qe+je,Me[11]=0,Me[12]=0,Me[13]=0,Me[14]=0,Me[15]=1,Me)},bi.fromXRotation=function(F,Me){var Le=Math.sin(Me),Oe=Math.cos(Me);return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=Oe,F[6]=Le,F[7]=0,F[8]=0,F[9]=-Le,F[10]=Oe,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},bi.fromYRotation=function(F,Me){var Le=Math.sin(Me),Oe=Math.cos(Me);return F[0]=Oe,F[1]=0,F[2]=-Le,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=Le,F[9]=0,F[10]=Oe,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},bi.fromZRotation=function(F,Me){var Le=Math.sin(Me),Oe=Math.cos(Me);return F[0]=Oe,F[1]=Le,F[2]=0,F[3]=0,F[4]=-Le,F[5]=Oe,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},bi.fromRotationTranslation=a,bi.fromQuat2=function(Me,Le){var Oe=new F.ARRAY_TYPE(3),Fe=-Le[0],je=-Le[1],qe=-Le[2],He=Le[3],xt=Le[4],Pt=Le[5],jt=Le[6],Gt=Le[7],bi=Fe*Fe+je*je+qe*qe+He*He;return bi>0?(Oe[0]=2*(xt*He+Gt*Fe+Pt*qe-jt*je)/bi,Oe[1]=2*(Pt*He+Gt*je+jt*Fe-xt*qe)/bi,Oe[2]=2*(jt*He+Gt*qe+xt*je-Pt*Fe)/bi):(Oe[0]=2*(xt*He+Gt*Fe+Pt*qe-jt*je),Oe[1]=2*(Pt*He+Gt*je+jt*Fe-xt*qe),Oe[2]=2*(jt*He+Gt*qe+xt*je-Pt*Fe)),a(Me,Le,Oe),Me},bi.getTranslation=function(F,Me){return F[0]=Me[12],F[1]=Me[13],F[2]=Me[14],F},bi.getScaling=o,bi.getRotation=function(Me,Le){var Oe=new F.ARRAY_TYPE(3);o(Oe,Le);var Fe=1/Oe[0],je=1/Oe[1],qe=1/Oe[2],He=Le[0]*Fe,xt=Le[1]*je,Pt=Le[2]*qe,jt=Le[4]*Fe,Gt=Le[5]*je,bi=Le[6]*qe,wi=Le[8]*Fe,qr=Le[9]*je,Xn=Le[10]*qe,Yn=He+Gt+Xn,yo=0;return Yn>0?(yo=2*Math.sqrt(Yn+1),Me[3]=.25*yo,Me[0]=(bi-qr)/yo,Me[1]=(wi-Pt)/yo,Me[2]=(xt-jt)/yo):He>Gt&&He>Xn?(yo=2*Math.sqrt(1+He-Gt-Xn),Me[3]=(bi-qr)/yo,Me[0]=.25*yo,Me[1]=(xt+jt)/yo,Me[2]=(wi+Pt)/yo):Gt>Xn?(yo=2*Math.sqrt(1+Gt-He-Xn),Me[3]=(wi-Pt)/yo,Me[0]=(xt+jt)/yo,Me[1]=.25*yo,Me[2]=(bi+qr)/yo):(yo=2*Math.sqrt(1+Xn-He-Gt),Me[3]=(xt-jt)/yo,Me[0]=(wi+Pt)/yo,Me[1]=(bi+qr)/yo,Me[2]=.25*yo),Me},bi.fromRotationTranslationScale=function(F,Me,Le,Oe){var Fe=Me[0],je=Me[1],qe=Me[2],He=Me[3],xt=Fe+Fe,Pt=je+je,jt=qe+qe,Gt=Fe*xt,bi=Fe*Pt,wi=Fe*jt,qr=je*Pt,Xn=je*jt,Yn=qe*jt,yo=He*xt,bo=He*Pt,Ro=He*jt,Do=Oe[0],zs=Oe[1],Zs=Oe[2];return F[0]=(1-(qr+Yn))*Do,F[1]=(bi+Ro)*Do,F[2]=(wi-bo)*Do,F[3]=0,F[4]=(bi-Ro)*zs,F[5]=(1-(Gt+Yn))*zs,F[6]=(Xn+yo)*zs,F[7]=0,F[8]=(wi+bo)*Zs,F[9]=(Xn-yo)*Zs,F[10]=(1-(Gt+qr))*Zs,F[11]=0,F[12]=Le[0],F[13]=Le[1],F[14]=Le[2],F[15]=1,F},bi.fromRotationTranslationScaleOrigin=function(F,Me,Le,Oe,Fe){var je=Me[0],qe=Me[1],He=Me[2],xt=Me[3],Pt=je+je,jt=qe+qe,Gt=He+He,bi=je*Pt,wi=je*jt,qr=je*Gt,Xn=qe*jt,Yn=qe*Gt,yo=He*Gt,bo=xt*Pt,Ro=xt*jt,Do=xt*Gt,zs=Oe[0],Zs=Oe[1],na=Oe[2],el=Fe[0],nl=Fe[1],hl=Fe[2],pl=(1-(Xn+yo))*zs,bl=(wi+Do)*zs,Tl=(qr-Ro)*zs,kl=(wi-Do)*Zs,ec=(1-(bi+yo))*Zs,tc=(Yn+bo)*Zs,ic=(qr+Ro)*na,oc=(Yn-bo)*na,sc=(1-(bi+Xn))*na;return F[0]=pl,F[1]=bl,F[2]=Tl,F[3]=0,F[4]=kl,F[5]=ec,F[6]=tc,F[7]=0,F[8]=ic,F[9]=oc,F[10]=sc,F[11]=0,F[12]=Le[0]+el-(pl*el+kl*nl+ic*hl),F[13]=Le[1]+nl-(bl*el+ec*nl+oc*hl),F[14]=Le[2]+hl-(Tl*el+tc*nl+sc*hl),F[15]=1,F},bi.fromQuat=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Le+Le,He=Oe+Oe,xt=Fe+Fe,Pt=Le*qe,jt=Oe*qe,Gt=Oe*He,bi=Fe*qe,wi=Fe*He,qr=Fe*xt,Xn=je*qe,Yn=je*He,yo=je*xt;return F[0]=1-Gt-qr,F[1]=jt+yo,F[2]=bi-Yn,F[3]=0,F[4]=jt-yo,F[5]=1-Pt-qr,F[6]=wi+Xn,F[7]=0,F[8]=bi+Yn,F[9]=wi-Xn,F[10]=1-Pt-Gt,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},bi.frustum=function(F,Me,Le,Oe,Fe,je,qe){var He=1/(Le-Me),xt=1/(Fe-Oe),Pt=1/(je-qe);return F[0]=2*je*He,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=2*je*xt,F[6]=0,F[7]=0,F[8]=(Le+Me)*He,F[9]=(Fe+Oe)*xt,F[10]=(qe+je)*Pt,F[11]=-1,F[12]=0,F[13]=0,F[14]=qe*je*2*Pt,F[15]=0,F},bi.perspectiveNO=l,bi.perspectiveZO=function(F,Me,Le,Oe,Fe){var je,qe=1/Math.tan(Me/2);return F[0]=qe/Le,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=qe,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=-1,F[12]=0,F[13]=0,F[15]=0,null!=Fe&&Fe!==1/0?(F[10]=Fe*(je=1/(Oe-Fe)),F[14]=Fe*Oe*je):(F[10]=-1,F[14]=-Oe),F},bi.perspectiveFromFieldOfView=function(F,Me,Le,Oe){var Fe=Math.tan(Me.upDegrees*Math.PI/180),je=Math.tan(Me.downDegrees*Math.PI/180),qe=Math.tan(Me.leftDegrees*Math.PI/180),He=Math.tan(Me.rightDegrees*Math.PI/180),xt=2/(qe+He),Pt=2/(Fe+je);return F[0]=xt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=Pt,F[6]=0,F[7]=0,F[8]=-(qe-He)*xt*.5,F[9]=(Fe-je)*Pt*.5,F[10]=Oe/(Le-Oe),F[11]=-1,F[12]=0,F[13]=0,F[14]=Oe*Le/(Le-Oe),F[15]=0,F},bi.orthoNO=u,bi.orthoZO=function(F,Me,Le,Oe,Fe,je,qe){var He=1/(Me-Le),xt=1/(Oe-Fe),Pt=1/(je-qe);return F[0]=-2*He,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=-2*xt,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=Pt,F[11]=0,F[12]=(Me+Le)*He,F[13]=(Fe+Oe)*xt,F[14]=je*Pt,F[15]=1,F},bi.lookAt=function(Me,Le,Oe,Fe){var je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn=Le[0],Yn=Le[1],yo=Le[2],bo=Fe[0],Ro=Fe[1],Do=Fe[2],zs=Oe[0],Zs=Oe[1],na=Oe[2];return Math.abs(Xn-zs)<F.EPSILON&&Math.abs(Yn-Zs)<F.EPSILON&&Math.abs(yo-na)<F.EPSILON?n(Me):(Gt=Xn-zs,bi=Yn-Zs,wi=yo-na,je=Ro*(wi*=qr=1/Math.hypot(Gt,bi,wi))-Do*(bi*=qr),qe=Do*(Gt*=qr)-bo*wi,He=bo*bi-Ro*Gt,(qr=Math.hypot(je,qe,He))?(je*=qr=1/qr,qe*=qr,He*=qr):(je=0,qe=0,He=0),xt=bi*He-wi*qe,Pt=wi*je-Gt*He,jt=Gt*qe-bi*je,(qr=Math.hypot(xt,Pt,jt))?(xt*=qr=1/qr,Pt*=qr,jt*=qr):(xt=0,Pt=0,jt=0),Me[0]=je,Me[1]=xt,Me[2]=Gt,Me[3]=0,Me[4]=qe,Me[5]=Pt,Me[6]=bi,Me[7]=0,Me[8]=He,Me[9]=jt,Me[10]=wi,Me[11]=0,Me[12]=-(je*Xn+qe*Yn+He*yo),Me[13]=-(xt*Xn+Pt*Yn+jt*yo),Me[14]=-(Gt*Xn+bi*Yn+wi*yo),Me[15]=1,Me)},bi.targetTo=function(F,Me,Le,Oe){var Fe=Me[0],je=Me[1],qe=Me[2],He=Oe[0],xt=Oe[1],Pt=Oe[2],jt=Fe-Le[0],Gt=je-Le[1],bi=qe-Le[2],wi=jt*jt+Gt*Gt+bi*bi;wi>0&&(jt*=wi=1/Math.sqrt(wi),Gt*=wi,bi*=wi);var qr=xt*bi-Pt*Gt,Xn=Pt*jt-He*bi,Yn=He*Gt-xt*jt;return(wi=qr*qr+Xn*Xn+Yn*Yn)>0&&(qr*=wi=1/Math.sqrt(wi),Xn*=wi,Yn*=wi),F[0]=qr,F[1]=Xn,F[2]=Yn,F[3]=0,F[4]=Gt*Yn-bi*Xn,F[5]=bi*qr-jt*Yn,F[6]=jt*Xn-Gt*qr,F[7]=0,F[8]=jt,F[9]=Gt,F[10]=bi,F[11]=0,F[12]=Fe,F[13]=je,F[14]=qe,F[15]=1,F},bi.str=function(F){return"mat4("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+", "+F[8]+", "+F[9]+", "+F[10]+", "+F[11]+", "+F[12]+", "+F[13]+", "+F[14]+", "+F[15]+")"},bi.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8],F[9],F[10],F[11],F[12],F[13],F[14],F[15])},bi.add=function(F,Me,Le){return F[0]=Me[0]+Le[0],F[1]=Me[1]+Le[1],F[2]=Me[2]+Le[2],F[3]=Me[3]+Le[3],F[4]=Me[4]+Le[4],F[5]=Me[5]+Le[5],F[6]=Me[6]+Le[6],F[7]=Me[7]+Le[7],F[8]=Me[8]+Le[8],F[9]=Me[9]+Le[9],F[10]=Me[10]+Le[10],F[11]=Me[11]+Le[11],F[12]=Me[12]+Le[12],F[13]=Me[13]+Le[13],F[14]=Me[14]+Le[14],F[15]=Me[15]+Le[15],F},bi.subtract=c,bi.multiplyScalar=function(F,Me,Le){return F[0]=Me[0]*Le,F[1]=Me[1]*Le,F[2]=Me[2]*Le,F[3]=Me[3]*Le,F[4]=Me[4]*Le,F[5]=Me[5]*Le,F[6]=Me[6]*Le,F[7]=Me[7]*Le,F[8]=Me[8]*Le,F[9]=Me[9]*Le,F[10]=Me[10]*Le,F[11]=Me[11]*Le,F[12]=Me[12]*Le,F[13]=Me[13]*Le,F[14]=Me[14]*Le,F[15]=Me[15]*Le,F},bi.multiplyScalarAndAdd=function(F,Me,Le,Oe){return F[0]=Me[0]+Le[0]*Oe,F[1]=Me[1]+Le[1]*Oe,F[2]=Me[2]+Le[2]*Oe,F[3]=Me[3]+Le[3]*Oe,F[4]=Me[4]+Le[4]*Oe,F[5]=Me[5]+Le[5]*Oe,F[6]=Me[6]+Le[6]*Oe,F[7]=Me[7]+Le[7]*Oe,F[8]=Me[8]+Le[8]*Oe,F[9]=Me[9]+Le[9]*Oe,F[10]=Me[10]+Le[10]*Oe,F[11]=Me[11]+Le[11]*Oe,F[12]=Me[12]+Le[12]*Oe,F[13]=Me[13]+Le[13]*Oe,F[14]=Me[14]+Le[14]*Oe,F[15]=Me[15]+Le[15]*Oe,F},bi.exactEquals=function(F,Me){return F[0]===Me[0]&&F[1]===Me[1]&&F[2]===Me[2]&&F[3]===Me[3]&&F[4]===Me[4]&&F[5]===Me[5]&&F[6]===Me[6]&&F[7]===Me[7]&&F[8]===Me[8]&&F[9]===Me[9]&&F[10]===Me[10]&&F[11]===Me[11]&&F[12]===Me[12]&&F[13]===Me[13]&&F[14]===Me[14]&&F[15]===Me[15]},bi.equals=function(Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Me[6],jt=Me[7],Gt=Me[8],bi=Me[9],wi=Me[10],qr=Me[11],Xn=Me[12],Yn=Me[13],yo=Me[14],bo=Me[15],Ro=Le[0],Do=Le[1],zs=Le[2],Zs=Le[3],na=Le[4],el=Le[5],nl=Le[6],hl=Le[7],pl=Le[8],bl=Le[9],Tl=Le[10],kl=Le[11],ec=Le[12],tc=Le[13],ic=Le[14],oc=Le[15];return Math.abs(Oe-Ro)<=F.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(Ro))&&Math.abs(Fe-Do)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(Do))&&Math.abs(je-zs)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(zs))&&Math.abs(qe-Zs)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(Zs))&&Math.abs(He-na)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(na))&&Math.abs(xt-el)<=F.EPSILON*Math.max(1,Math.abs(xt),Math.abs(el))&&Math.abs(Pt-nl)<=F.EPSILON*Math.max(1,Math.abs(Pt),Math.abs(nl))&&Math.abs(jt-hl)<=F.EPSILON*Math.max(1,Math.abs(jt),Math.abs(hl))&&Math.abs(Gt-pl)<=F.EPSILON*Math.max(1,Math.abs(Gt),Math.abs(pl))&&Math.abs(bi-bl)<=F.EPSILON*Math.max(1,Math.abs(bi),Math.abs(bl))&&Math.abs(wi-Tl)<=F.EPSILON*Math.max(1,Math.abs(wi),Math.abs(Tl))&&Math.abs(qr-kl)<=F.EPSILON*Math.max(1,Math.abs(qr),Math.abs(kl))&&Math.abs(Xn-ec)<=F.EPSILON*Math.max(1,Math.abs(Xn),Math.abs(ec))&&Math.abs(Yn-tc)<=F.EPSILON*Math.max(1,Math.abs(Yn),Math.abs(tc))&&Math.abs(yo-ic)<=F.EPSILON*Math.max(1,Math.abs(yo),Math.abs(ic))&&Math.abs(bo-oc)<=F.EPSILON*Math.max(1,Math.abs(bo),Math.abs(oc))},bi.sub=bi.mul=bi.ortho=bi.perspective=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Me=r(void 0);if(Me&&Me.has(F))return Me.get(F);var Le={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in F)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(F,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(F,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Le,Fe,je):Le[Fe]=F[Fe]}return Le.default=F,Me&&Me.set(F,Le),Le}(s());function r(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(r=function(F){return F?Le:Me})(F)}function n(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F}function i(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Me[6],jt=Me[7],Gt=Me[8],bi=Me[9],wi=Me[10],qr=Me[11],Xn=Me[12],Yn=Me[13],yo=Me[14],bo=Me[15],Ro=Le[0],Do=Le[1],zs=Le[2],Zs=Le[3];return F[0]=Ro*Oe+Do*He+zs*Gt+Zs*Xn,F[1]=Ro*Fe+Do*xt+zs*bi+Zs*Yn,F[2]=Ro*je+Do*Pt+zs*wi+Zs*yo,F[3]=Ro*qe+Do*jt+zs*qr+Zs*bo,F[4]=(Ro=Le[4])*Oe+(Do=Le[5])*He+(zs=Le[6])*Gt+(Zs=Le[7])*Xn,F[5]=Ro*Fe+Do*xt+zs*bi+Zs*Yn,F[6]=Ro*je+Do*Pt+zs*wi+Zs*yo,F[7]=Ro*qe+Do*jt+zs*qr+Zs*bo,F[8]=(Ro=Le[8])*Oe+(Do=Le[9])*He+(zs=Le[10])*Gt+(Zs=Le[11])*Xn,F[9]=Ro*Fe+Do*xt+zs*bi+Zs*Yn,F[10]=Ro*je+Do*Pt+zs*wi+Zs*yo,F[11]=Ro*qe+Do*jt+zs*qr+Zs*bo,F[12]=(Ro=Le[12])*Oe+(Do=Le[13])*He+(zs=Le[14])*Gt+(Zs=Le[15])*Xn,F[13]=Ro*Fe+Do*xt+zs*bi+Zs*Yn,F[14]=Ro*je+Do*Pt+zs*wi+Zs*yo,F[15]=Ro*qe+Do*jt+zs*qr+Zs*bo,F}function a(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Oe+Oe,xt=Fe+Fe,Pt=je+je,jt=Oe*He,Gt=Oe*xt,bi=Oe*Pt,wi=Fe*xt,qr=Fe*Pt,Xn=je*Pt,Yn=qe*He,yo=qe*xt,bo=qe*Pt;return F[0]=1-(wi+Xn),F[1]=Gt+bo,F[2]=bi-yo,F[3]=0,F[4]=Gt-bo,F[5]=1-(jt+Xn),F[6]=qr+Yn,F[7]=0,F[8]=bi+yo,F[9]=qr-Yn,F[10]=1-(jt+wi),F[11]=0,F[12]=Le[0],F[13]=Le[1],F[14]=Le[2],F[15]=1,F}function o(F,Me){var Le=Me[4],Oe=Me[5],Fe=Me[6],je=Me[8],qe=Me[9],He=Me[10];return F[0]=Math.hypot(Me[0],Me[1],Me[2]),F[1]=Math.hypot(Le,Oe,Fe),F[2]=Math.hypot(je,qe,He),F}function l(F,Me,Le,Oe,Fe){var je,qe=1/Math.tan(Me/2);return F[0]=qe/Le,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=qe,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=-1,F[12]=0,F[13]=0,F[15]=0,null!=Fe&&Fe!==1/0?(F[10]=(Fe+Oe)*(je=1/(Oe-Fe)),F[14]=2*Fe*Oe*je):(F[10]=-1,F[14]=-2*Oe),F}function u(F,Me,Le,Oe,Fe,je,qe){var He=1/(Me-Le),xt=1/(Oe-Fe),Pt=1/(je-qe);return F[0]=-2*He,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=-2*xt,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=2*Pt,F[11]=0,F[12]=(Me+Le)*He,F[13]=(Fe+Oe)*xt,F[14]=(qe+je)*Pt,F[15]=1,F}function c(F,Me,Le){return F[0]=Me[0]-Le[0],F[1]=Me[1]-Le[1],F[2]=Me[2]-Le[2],F[3]=Me[3]-Le[3],F[4]=Me[4]-Le[4],F[5]=Me[5]-Le[5],F[6]=Me[6]-Le[6],F[7]=Me[7]-Le[7],F[8]=Me[8]-Le[8],F[9]=Me[9]-Le[9],F[10]=Me[10]-Le[10],F[11]=Me[11]-Le[11],F[12]=Me[12]-Le[12],F[13]=Me[13]-Le[13],F[14]=Me[14]-Le[14],F[15]=Me[15]-Le[15],F}return bi.perspective=l,bi.ortho=u,bi.mul=i,bi.sub=c,bi}var wi,qr={},Xn={};function _(){if(wi)return Xn;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}wi=1,Object.defineProperty(Xn,"__esModule",{value:!0}),Xn.create=n,Xn.clone=function(Me){var Le=new F.ARRAY_TYPE(3);return Le[0]=Me[0],Le[1]=Me[1],Le[2]=Me[2],Le},Xn.length=i,Xn.fromValues=function(Me,Le,Oe){var Fe=new F.ARRAY_TYPE(3);return Fe[0]=Me,Fe[1]=Le,Fe[2]=Oe,Fe},Xn.copy=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F},Xn.set=function(F,Me,Le,Oe){return F[0]=Me,F[1]=Le,F[2]=Oe,F},Xn.add=function(F,Me,Le){return F[0]=Me[0]+Le[0],F[1]=Me[1]+Le[1],F[2]=Me[2]+Le[2],F},Xn.subtract=a,Xn.multiply=o,Xn.divide=l,Xn.ceil=function(F,Me){return F[0]=Math.ceil(Me[0]),F[1]=Math.ceil(Me[1]),F[2]=Math.ceil(Me[2]),F},Xn.floor=function(F,Me){return F[0]=Math.floor(Me[0]),F[1]=Math.floor(Me[1]),F[2]=Math.floor(Me[2]),F},Xn.min=function(F,Me,Le){return F[0]=Math.min(Me[0],Le[0]),F[1]=Math.min(Me[1],Le[1]),F[2]=Math.min(Me[2],Le[2]),F},Xn.max=function(F,Me,Le){return F[0]=Math.max(Me[0],Le[0]),F[1]=Math.max(Me[1],Le[1]),F[2]=Math.max(Me[2],Le[2]),F},Xn.round=function(F,Me){return F[0]=Math.round(Me[0]),F[1]=Math.round(Me[1]),F[2]=Math.round(Me[2]),F},Xn.scale=function(F,Me,Le){return F[0]=Me[0]*Le,F[1]=Me[1]*Le,F[2]=Me[2]*Le,F},Xn.scaleAndAdd=function(F,Me,Le,Oe){return F[0]=Me[0]+Le[0]*Oe,F[1]=Me[1]+Le[1]*Oe,F[2]=Me[2]+Le[2]*Oe,F},Xn.distance=u,Xn.squaredDistance=c,Xn.squaredLength=h,Xn.negate=function(F,Me){return F[0]=-Me[0],F[1]=-Me[1],F[2]=-Me[2],F},Xn.inverse=function(F,Me){return F[0]=1/Me[0],F[1]=1/Me[1],F[2]=1/Me[2],F},Xn.normalize=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Le*Le+Oe*Oe+Fe*Fe;return je>0&&(je=1/Math.sqrt(je)),F[0]=Me[0]*je,F[1]=Me[1]*je,F[2]=Me[2]*je,F},Xn.dot=p,Xn.cross=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Le[0],He=Le[1],xt=Le[2];return F[0]=Fe*xt-je*He,F[1]=je*qe-Oe*xt,F[2]=Oe*He-Fe*qe,F},Xn.lerp=function(F,Me,Le,Oe){var Fe=Me[0],je=Me[1],qe=Me[2];return F[0]=Fe+Oe*(Le[0]-Fe),F[1]=je+Oe*(Le[1]-je),F[2]=qe+Oe*(Le[2]-qe),F},Xn.hermite=function(F,Me,Le,Oe,Fe,je){var qe=je*je,He=qe*(2*je-3)+1,xt=qe*(je-2)+je,Pt=qe*(je-1),jt=qe*(3-2*je);return F[0]=Me[0]*He+Le[0]*xt+Oe[0]*Pt+Fe[0]*jt,F[1]=Me[1]*He+Le[1]*xt+Oe[1]*Pt+Fe[1]*jt,F[2]=Me[2]*He+Le[2]*xt+Oe[2]*Pt+Fe[2]*jt,F},Xn.bezier=function(F,Me,Le,Oe,Fe,je){var qe=1-je,He=qe*qe,xt=je*je,Pt=He*qe,jt=3*je*He,Gt=3*xt*qe,bi=xt*je;return F[0]=Me[0]*Pt+Le[0]*jt+Oe[0]*Gt+Fe[0]*bi,F[1]=Me[1]*Pt+Le[1]*jt+Oe[1]*Gt+Fe[1]*bi,F[2]=Me[2]*Pt+Le[2]*jt+Oe[2]*Gt+Fe[2]*bi,F},Xn.random=function(Me,Le){Le=Le||1;var Oe=2*F.RANDOM()*Math.PI,Fe=2*F.RANDOM()-1,je=Math.sqrt(1-Fe*Fe)*Le;return Me[0]=Math.cos(Oe)*je,Me[1]=Math.sin(Oe)*je,Me[2]=Fe*Le,Me},Xn.transformMat4=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Le[3]*Oe+Le[7]*Fe+Le[11]*je+Le[15];return F[0]=(Le[0]*Oe+Le[4]*Fe+Le[8]*je+Le[12])/(qe=qe||1),F[1]=(Le[1]*Oe+Le[5]*Fe+Le[9]*je+Le[13])/qe,F[2]=(Le[2]*Oe+Le[6]*Fe+Le[10]*je+Le[14])/qe,F},Xn.transformMat3=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2];return F[0]=Oe*Le[0]+Fe*Le[3]+je*Le[6],F[1]=Oe*Le[1]+Fe*Le[4]+je*Le[7],F[2]=Oe*Le[2]+Fe*Le[5]+je*Le[8],F},Xn.transformQuat=function(F,Me,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Me[0],He=Me[1],xt=Me[2],Pt=Fe*xt-je*He,jt=je*qe-Oe*xt,Gt=Oe*He-Fe*qe,bi=Fe*Gt-je*jt,wi=je*Pt-Oe*Gt,qr=Oe*jt-Fe*Pt,Xn=2*Le[3];return jt*=Xn,Gt*=Xn,wi*=2,qr*=2,F[0]=qe+(Pt*=Xn)+(bi*=2),F[1]=He+jt+wi,F[2]=xt+Gt+qr,F},Xn.rotateX=function(F,Me,Le,Oe){var Fe=[],je=[];return Fe[0]=Me[0]-Le[0],Fe[1]=Me[1]-Le[1],Fe[2]=Me[2]-Le[2],je[0]=Fe[0],je[1]=Fe[1]*Math.cos(Oe)-Fe[2]*Math.sin(Oe),je[2]=Fe[1]*Math.sin(Oe)+Fe[2]*Math.cos(Oe),F[0]=je[0]+Le[0],F[1]=je[1]+Le[1],F[2]=je[2]+Le[2],F},Xn.rotateY=function(F,Me,Le,Oe){var Fe=[],je=[];return Fe[0]=Me[0]-Le[0],Fe[1]=Me[1]-Le[1],Fe[2]=Me[2]-Le[2],je[0]=Fe[2]*Math.sin(Oe)+Fe[0]*Math.cos(Oe),je[1]=Fe[1],je[2]=Fe[2]*Math.cos(Oe)-Fe[0]*Math.sin(Oe),F[0]=je[0]+Le[0],F[1]=je[1]+Le[1],F[2]=je[2]+Le[2],F},Xn.rotateZ=function(F,Me,Le,Oe){var Fe=[],je=[];return Fe[0]=Me[0]-Le[0],Fe[1]=Me[1]-Le[1],Fe[2]=Me[2]-Le[2],je[0]=Fe[0]*Math.cos(Oe)-Fe[1]*Math.sin(Oe),je[1]=Fe[0]*Math.sin(Oe)+Fe[1]*Math.cos(Oe),je[2]=Fe[2],F[0]=je[0]+Le[0],F[1]=je[1]+Le[1],F[2]=je[2]+Le[2],F},Xn.angle=function(F,Me){var Le=F[0],Oe=F[1],Fe=F[2],je=Me[0],qe=Me[1],He=Me[2],xt=Math.sqrt(Le*Le+Oe*Oe+Fe*Fe)*Math.sqrt(je*je+qe*qe+He*He),Pt=xt&&p(F,Me)/xt;return Math.acos(Math.min(Math.max(Pt,-1),1))},Xn.zero=function(F){return F[0]=0,F[1]=0,F[2]=0,F},Xn.str=function(F){return"vec3("+F[0]+", "+F[1]+", "+F[2]+")"},Xn.exactEquals=function(F,Me){return F[0]===Me[0]&&F[1]===Me[1]&&F[2]===Me[2]},Xn.equals=function(Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Le[0],He=Le[1],xt=Le[2];return Math.abs(Oe-qe)<=F.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(qe))&&Math.abs(Fe-He)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(He))&&Math.abs(je-xt)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(xt))},Xn.forEach=Xn.sqrLen=Xn.len=Xn.sqrDist=Xn.dist=Xn.div=Xn.mul=Xn.sub=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Me=r(void 0);if(Me&&Me.has(F))return Me.get(F);var Le={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in F)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(F,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(F,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Le,Fe,je):Le[Fe]=F[Fe]}return Le.default=F,Me&&Me.set(F,Le),Le}(s());function r(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(r=function(F){return F?Le:Me})(F)}function n(){var Me=new F.ARRAY_TYPE(3);return F.ARRAY_TYPE!=Float32Array&&(Me[0]=0,Me[1]=0,Me[2]=0),Me}function i(F){return Math.hypot(F[0],F[1],F[2])}function a(F,Me,Le){return F[0]=Me[0]-Le[0],F[1]=Me[1]-Le[1],F[2]=Me[2]-Le[2],F}function o(F,Me,Le){return F[0]=Me[0]*Le[0],F[1]=Me[1]*Le[1],F[2]=Me[2]*Le[2],F}function l(F,Me,Le){return F[0]=Me[0]/Le[0],F[1]=Me[1]/Le[1],F[2]=Me[2]/Le[2],F}function u(F,Me){return Math.hypot(Me[0]-F[0],Me[1]-F[1],Me[2]-F[2])}function c(F,Me){var Le=Me[0]-F[0],Oe=Me[1]-F[1],Fe=Me[2]-F[2];return Le*Le+Oe*Oe+Fe*Fe}function h(F){var Me=F[0],Le=F[1],Oe=F[2];return Me*Me+Le*Le+Oe*Oe}function p(F,Me){return F[0]*Me[0]+F[1]*Me[1]+F[2]*Me[2]}Xn.sub=a,Xn.mul=o,Xn.div=l,Xn.dist=u,Xn.sqrDist=c,Xn.len=i,Xn.sqrLen=h;var Me,Le=(Me=n(),function(F,Le,Oe,Fe,je,qe){var He,xt;for(Le||(Le=3),Oe||(Oe=0),xt=Fe?Math.min(Fe*Le+Oe,F.length):F.length,He=Oe;He<xt;He+=Le)Me[0]=F[He],Me[1]=F[He+1],Me[2]=F[He+2],je(Me,Me,qe),F[He]=Me[0],F[He+1]=Me[1],F[He+2]=Me[2];return F});return Xn.forEach=Le,Xn}var Yn,yo,bo={};function I(){if(Yn)return bo;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Yn=1,Object.defineProperty(bo,"__esModule",{value:!0}),bo.create=n,bo.clone=function(Me){var Le=new F.ARRAY_TYPE(4);return Le[0]=Me[0],Le[1]=Me[1],Le[2]=Me[2],Le[3]=Me[3],Le},bo.fromValues=function(Me,Le,Oe,Fe){var je=new F.ARRAY_TYPE(4);return je[0]=Me,je[1]=Le,je[2]=Oe,je[3]=Fe,je},bo.copy=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[3],F},bo.set=function(F,Me,Le,Oe,Fe){return F[0]=Me,F[1]=Le,F[2]=Oe,F[3]=Fe,F},bo.add=function(F,Me,Le){return F[0]=Me[0]+Le[0],F[1]=Me[1]+Le[1],F[2]=Me[2]+Le[2],F[3]=Me[3]+Le[3],F},bo.subtract=i,bo.multiply=a,bo.divide=o,bo.ceil=function(F,Me){return F[0]=Math.ceil(Me[0]),F[1]=Math.ceil(Me[1]),F[2]=Math.ceil(Me[2]),F[3]=Math.ceil(Me[3]),F},bo.floor=function(F,Me){return F[0]=Math.floor(Me[0]),F[1]=Math.floor(Me[1]),F[2]=Math.floor(Me[2]),F[3]=Math.floor(Me[3]),F},bo.min=function(F,Me,Le){return F[0]=Math.min(Me[0],Le[0]),F[1]=Math.min(Me[1],Le[1]),F[2]=Math.min(Me[2],Le[2]),F[3]=Math.min(Me[3],Le[3]),F},bo.max=function(F,Me,Le){return F[0]=Math.max(Me[0],Le[0]),F[1]=Math.max(Me[1],Le[1]),F[2]=Math.max(Me[2],Le[2]),F[3]=Math.max(Me[3],Le[3]),F},bo.round=function(F,Me){return F[0]=Math.round(Me[0]),F[1]=Math.round(Me[1]),F[2]=Math.round(Me[2]),F[3]=Math.round(Me[3]),F},bo.scale=function(F,Me,Le){return F[0]=Me[0]*Le,F[1]=Me[1]*Le,F[2]=Me[2]*Le,F[3]=Me[3]*Le,F},bo.scaleAndAdd=function(F,Me,Le,Oe){return F[0]=Me[0]+Le[0]*Oe,F[1]=Me[1]+Le[1]*Oe,F[2]=Me[2]+Le[2]*Oe,F[3]=Me[3]+Le[3]*Oe,F},bo.distance=l,bo.squaredDistance=u,bo.length=c,bo.squaredLength=h,bo.negate=function(F,Me){return F[0]=-Me[0],F[1]=-Me[1],F[2]=-Me[2],F[3]=-Me[3],F},bo.inverse=function(F,Me){return F[0]=1/Me[0],F[1]=1/Me[1],F[2]=1/Me[2],F[3]=1/Me[3],F},bo.normalize=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Le*Le+Oe*Oe+Fe*Fe+je*je;return qe>0&&(qe=1/Math.sqrt(qe)),F[0]=Le*qe,F[1]=Oe*qe,F[2]=Fe*qe,F[3]=je*qe,F},bo.dot=function(F,Me){return F[0]*Me[0]+F[1]*Me[1]+F[2]*Me[2]+F[3]*Me[3]},bo.cross=function(F,Me,Le,Oe){var Fe=Le[0]*Oe[1]-Le[1]*Oe[0],je=Le[0]*Oe[2]-Le[2]*Oe[0],qe=Le[0]*Oe[3]-Le[3]*Oe[0],He=Le[1]*Oe[2]-Le[2]*Oe[1],xt=Le[1]*Oe[3]-Le[3]*Oe[1],Pt=Le[2]*Oe[3]-Le[3]*Oe[2],jt=Me[0],Gt=Me[1],bi=Me[2],wi=Me[3];return F[0]=Gt*Pt-bi*xt+wi*He,F[1]=-jt*Pt+bi*qe-wi*je,F[2]=jt*xt-Gt*qe+wi*Fe,F[3]=-jt*He+Gt*je-bi*Fe,F},bo.lerp=function(F,Me,Le,Oe){var Fe=Me[0],je=Me[1],qe=Me[2],He=Me[3];return F[0]=Fe+Oe*(Le[0]-Fe),F[1]=je+Oe*(Le[1]-je),F[2]=qe+Oe*(Le[2]-qe),F[3]=He+Oe*(Le[3]-He),F},bo.random=function(Me,Le){var Oe,Fe,je,qe,He,xt;Le=Le||1;do{He=(Oe=2*F.RANDOM()-1)*Oe+(Fe=2*F.RANDOM()-1)*Fe}while(He>=1);do{xt=(je=2*F.RANDOM()-1)*je+(qe=2*F.RANDOM()-1)*qe}while(xt>=1);var Pt=Math.sqrt((1-He)/xt);return Me[0]=Le*Oe,Me[1]=Le*Fe,Me[2]=Le*je*Pt,Me[3]=Le*qe*Pt,Me},bo.transformMat4=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3];return F[0]=Le[0]*Oe+Le[4]*Fe+Le[8]*je+Le[12]*qe,F[1]=Le[1]*Oe+Le[5]*Fe+Le[9]*je+Le[13]*qe,F[2]=Le[2]*Oe+Le[6]*Fe+Le[10]*je+Le[14]*qe,F[3]=Le[3]*Oe+Le[7]*Fe+Le[11]*je+Le[15]*qe,F},bo.transformQuat=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Le[0],He=Le[1],xt=Le[2],Pt=Le[3],jt=Pt*Oe+He*je-xt*Fe,Gt=Pt*Fe+xt*Oe-qe*je,bi=Pt*je+qe*Fe-He*Oe,wi=-qe*Oe-He*Fe-xt*je;return F[0]=jt*Pt+wi*-qe+Gt*-xt-bi*-He,F[1]=Gt*Pt+wi*-He+bi*-qe-jt*-xt,F[2]=bi*Pt+wi*-xt+jt*-He-Gt*-qe,F[3]=Me[3],F},bo.zero=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=0,F},bo.str=function(F){return"vec4("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},bo.exactEquals=function(F,Me){return F[0]===Me[0]&&F[1]===Me[1]&&F[2]===Me[2]&&F[3]===Me[3]},bo.equals=function(Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Le[0],xt=Le[1],Pt=Le[2],jt=Le[3];return Math.abs(Oe-He)<=F.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(He))&&Math.abs(Fe-xt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(xt))&&Math.abs(je-Pt)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(Pt))&&Math.abs(qe-jt)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(jt))},bo.forEach=bo.sqrLen=bo.len=bo.sqrDist=bo.dist=bo.div=bo.mul=bo.sub=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Me=r(void 0);if(Me&&Me.has(F))return Me.get(F);var Le={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in F)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(F,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(F,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Le,Fe,je):Le[Fe]=F[Fe]}return Le.default=F,Me&&Me.set(F,Le),Le}(s());function r(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(r=function(F){return F?Le:Me})(F)}function n(){var Me=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Me[0]=0,Me[1]=0,Me[2]=0,Me[3]=0),Me}function i(F,Me,Le){return F[0]=Me[0]-Le[0],F[1]=Me[1]-Le[1],F[2]=Me[2]-Le[2],F[3]=Me[3]-Le[3],F}function a(F,Me,Le){return F[0]=Me[0]*Le[0],F[1]=Me[1]*Le[1],F[2]=Me[2]*Le[2],F[3]=Me[3]*Le[3],F}function o(F,Me,Le){return F[0]=Me[0]/Le[0],F[1]=Me[1]/Le[1],F[2]=Me[2]/Le[2],F[3]=Me[3]/Le[3],F}function l(F,Me){return Math.hypot(Me[0]-F[0],Me[1]-F[1],Me[2]-F[2],Me[3]-F[3])}function u(F,Me){var Le=Me[0]-F[0],Oe=Me[1]-F[1],Fe=Me[2]-F[2],je=Me[3]-F[3];return Le*Le+Oe*Oe+Fe*Fe+je*je}function c(F){return Math.hypot(F[0],F[1],F[2],F[3])}function h(F){var Me=F[0],Le=F[1],Oe=F[2],Fe=F[3];return Me*Me+Le*Le+Oe*Oe+Fe*Fe}bo.sub=i,bo.mul=a,bo.div=o,bo.dist=l,bo.sqrDist=u,bo.len=c,bo.sqrLen=h;var Me,Le=(Me=n(),function(F,Le,Oe,Fe,je,qe){var He,xt;for(Le||(Le=4),Oe||(Oe=0),xt=Fe?Math.min(Fe*Le+Oe,F.length):F.length,He=Oe;He<xt;He+=Le)Me[0]=F[He],Me[1]=F[He+1],Me[2]=F[He+2],Me[3]=F[He+3],je(Me,Me,qe),F[He]=Me[0],F[He+1]=Me[1],F[He+2]=Me[2],F[He+3]=Me[3];return F});return bo.forEach=Le,bo}function S(){if(yo)return qr;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}yo=1,Object.defineProperty(qr,"__esModule",{value:!0}),qr.create=l,qr.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F},qr.setAxisAngle=u,qr.getAxisAngle=function(Me,Le){var Oe=2*Math.acos(Le[3]),Fe=Math.sin(Oe/2);return Fe>F.EPSILON?(Me[0]=Le[0]/Fe,Me[1]=Le[1]/Fe,Me[2]=Le[2]/Fe):(Me[0]=1,Me[1]=0,Me[2]=0),Oe},qr.getAngle=function(F,Me){var Le=je(F,Me);return Math.acos(2*Le*Le-1)},qr.multiply=c,qr.rotateX=function(F,Me,Le){Le*=.5;var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Math.sin(Le),xt=Math.cos(Le);return F[0]=Oe*xt+qe*He,F[1]=Fe*xt+je*He,F[2]=je*xt-Fe*He,F[3]=qe*xt-Oe*He,F},qr.rotateY=function(F,Me,Le){Le*=.5;var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Math.sin(Le),xt=Math.cos(Le);return F[0]=Oe*xt-je*He,F[1]=Fe*xt+qe*He,F[2]=je*xt+Oe*He,F[3]=qe*xt-Fe*He,F},qr.rotateZ=function(F,Me,Le){Le*=.5;var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Math.sin(Le),xt=Math.cos(Le);return F[0]=Oe*xt+Fe*He,F[1]=Fe*xt-Oe*He,F[2]=je*xt+qe*He,F[3]=qe*xt-je*He,F},qr.calculateW=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2];return F[0]=Le,F[1]=Oe,F[2]=Fe,F[3]=Math.sqrt(Math.abs(1-Le*Le-Oe*Oe-Fe*Fe)),F},qr.exp=h,qr.ln=p,qr.pow=function(F,Me,Le){return p(F,Me),Fe(F,F,Le),h(F,F),F},qr.slerp=f,qr.random=function(Me){var Le=F.RANDOM(),Oe=F.RANDOM(),Fe=F.RANDOM(),je=Math.sqrt(1-Le),qe=Math.sqrt(Le);return Me[0]=je*Math.sin(2*Math.PI*Oe),Me[1]=je*Math.cos(2*Math.PI*Oe),Me[2]=qe*Math.sin(2*Math.PI*Fe),Me[3]=qe*Math.cos(2*Math.PI*Fe),Me},qr.invert=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Le*Le+Oe*Oe+Fe*Fe+je*je,He=qe?1/qe:0;return F[0]=-Le*He,F[1]=-Oe*He,F[2]=-Fe*He,F[3]=je*He,F},qr.conjugate=function(F,Me){return F[0]=-Me[0],F[1]=-Me[1],F[2]=-Me[2],F[3]=Me[3],F},qr.fromMat3=m,qr.fromEuler=function(F,Me,Le,Oe){var Fe=.5*Math.PI/180;Me*=Fe,Le*=Fe,Oe*=Fe;var je=Math.sin(Me),qe=Math.cos(Me),He=Math.sin(Le),xt=Math.cos(Le),Pt=Math.sin(Oe),jt=Math.cos(Oe);return F[0]=je*xt*jt-qe*He*Pt,F[1]=qe*He*jt+je*xt*Pt,F[2]=qe*xt*Pt-je*He*jt,F[3]=qe*xt*jt+je*He*Pt,F},qr.str=function(F){return"quat("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},qr.setAxes=qr.sqlerp=qr.rotationTo=qr.equals=qr.exactEquals=qr.normalize=qr.sqrLen=qr.squaredLength=qr.len=qr.length=qr.lerp=qr.dot=qr.scale=qr.mul=qr.add=qr.set=qr.copy=qr.fromValues=qr.clone=void 0;var F=o(s()),Me=o(d()),Le=o(_()),Oe=o(I());function a(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(a=function(F){return F?Le:Me})(F)}function o(F,Me){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=a(Me);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}function l(){var Me=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Me[0]=0,Me[1]=0,Me[2]=0),Me[3]=1,Me}function u(F,Me,Le){Le*=.5;var Oe=Math.sin(Le);return F[0]=Oe*Me[0],F[1]=Oe*Me[1],F[2]=Oe*Me[2],F[3]=Math.cos(Le),F}function c(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Le[0],xt=Le[1],Pt=Le[2],jt=Le[3];return F[0]=Oe*jt+qe*He+Fe*Pt-je*xt,F[1]=Fe*jt+qe*xt+je*He-Oe*Pt,F[2]=je*jt+qe*Pt+Oe*xt-Fe*He,F[3]=qe*jt-Oe*He-Fe*xt-je*Pt,F}function h(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Math.sqrt(Le*Le+Oe*Oe+Fe*Fe),He=Math.exp(je),xt=qe>0?He*Math.sin(qe)/qe:0;return F[0]=Le*xt,F[1]=Oe*xt,F[2]=Fe*xt,F[3]=He*Math.cos(qe),F}function p(F,Me){var Le=Me[0],Oe=Me[1],Fe=Me[2],je=Me[3],qe=Math.sqrt(Le*Le+Oe*Oe+Fe*Fe),He=qe>0?Math.atan2(qe,je)/qe:0;return F[0]=Le*He,F[1]=Oe*He,F[2]=Fe*He,F[3]=.5*Math.log(Le*Le+Oe*Oe+Fe*Fe+je*je),F}function f(Me,Le,Oe,Fe){var je,qe,He,xt,Pt,jt=Le[0],Gt=Le[1],bi=Le[2],wi=Le[3],qr=Oe[0],Xn=Oe[1],Yn=Oe[2],yo=Oe[3];return(qe=jt*qr+Gt*Xn+bi*Yn+wi*yo)<0&&(qe=-qe,qr=-qr,Xn=-Xn,Yn=-Yn,yo=-yo),1-qe>F.EPSILON?(je=Math.acos(qe),He=Math.sin(je),xt=Math.sin((1-Fe)*je)/He,Pt=Math.sin(Fe*je)/He):(xt=1-Fe,Pt=Fe),Me[0]=xt*jt+Pt*qr,Me[1]=xt*Gt+Pt*Xn,Me[2]=xt*bi+Pt*Yn,Me[3]=xt*wi+Pt*yo,Me}function m(F,Me){var Le,Oe=Me[0]+Me[4]+Me[8];if(Oe>0)Le=Math.sqrt(Oe+1),F[3]=.5*Le,F[0]=(Me[5]-Me[7])*(Le=.5/Le),F[1]=(Me[6]-Me[2])*Le,F[2]=(Me[1]-Me[3])*Le;else{var Fe=0;Me[4]>Me[0]&&(Fe=1),Me[8]>Me[3*Fe+Fe]&&(Fe=2);var je=(Fe+1)%3,qe=(Fe+2)%3;Le=Math.sqrt(Me[3*Fe+Fe]-Me[3*je+je]-Me[3*qe+qe]+1),F[Fe]=.5*Le,F[3]=(Me[3*je+qe]-Me[3*qe+je])*(Le=.5/Le),F[je]=(Me[3*je+Fe]+Me[3*Fe+je])*Le,F[qe]=(Me[3*qe+Fe]+Me[3*Fe+qe])*Le}return F}qr.clone=Oe.clone,qr.fromValues=Oe.fromValues,qr.copy=Oe.copy,qr.set=Oe.set,qr.add=Oe.add,qr.mul=c;var Fe=Oe.scale;qr.scale=Fe;var je=Oe.dot;qr.dot=je,qr.lerp=Oe.lerp;var qe=Oe.length;qr.length=qe,qr.len=qe;var He=Oe.squaredLength;qr.squaredLength=He,qr.sqrLen=He;var xt=Oe.normalize;qr.normalize=xt,qr.exactEquals=Oe.exactEquals,qr.equals=Oe.equals;var Pt,jt,Gt,bi=(Pt=Le.create(),jt=Le.fromValues(1,0,0),Gt=Le.fromValues(0,1,0),function(F,Me,Oe){var Fe=Le.dot(Me,Oe);return Fe<-.999999?(Le.cross(Pt,jt,Me),Le.len(Pt)<1e-6&&Le.cross(Pt,Gt,Me),Le.normalize(Pt,Pt),u(F,Pt,Math.PI),F):Fe>.999999?(F[0]=0,F[1]=0,F[2]=0,F[3]=1,F):(Le.cross(Pt,Me,Oe),F[0]=Pt[0],F[1]=Pt[1],F[2]=Pt[2],F[3]=1+Fe,xt(F,F))});qr.rotationTo=bi;var wi,Xn,Yn=(wi=l(),Xn=l(),function(F,Me,Le,Oe,Fe,je){return f(wi,Me,Fe,je),f(Xn,Le,Oe,je),f(F,wi,Xn,2*je*(1-je)),F});qr.sqlerp=Yn;var bo,Ro=(bo=Me.create(),function(F,Me,Le,Oe){return bo[0]=Le[0],bo[3]=Le[1],bo[6]=Le[2],bo[1]=Oe[0],bo[4]=Oe[1],bo[7]=Oe[2],bo[2]=-Me[0],bo[5]=-Me[1],bo[8]=-Me[2],xt(F,m(F,bo))});return qr.setAxes=Ro,qr}var Ro,Do={};function z(){if(Ro)return Do;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Ro=1,Object.defineProperty(Do,"__esModule",{value:!0}),Do.create=function(){var Me=new F.ARRAY_TYPE(8);return F.ARRAY_TYPE!=Float32Array&&(Me[0]=0,Me[1]=0,Me[2]=0,Me[4]=0,Me[5]=0,Me[6]=0,Me[7]=0),Me[3]=1,Me},Do.clone=function(Me){var Le=new F.ARRAY_TYPE(8);return Le[0]=Me[0],Le[1]=Me[1],Le[2]=Me[2],Le[3]=Me[3],Le[4]=Me[4],Le[5]=Me[5],Le[6]=Me[6],Le[7]=Me[7],Le},Do.fromValues=function(Me,Le,Oe,Fe,je,qe,He,xt){var Pt=new F.ARRAY_TYPE(8);return Pt[0]=Me,Pt[1]=Le,Pt[2]=Oe,Pt[3]=Fe,Pt[4]=je,Pt[5]=qe,Pt[6]=He,Pt[7]=xt,Pt},Do.fromRotationTranslationValues=function(Me,Le,Oe,Fe,je,qe,He){var xt=new F.ARRAY_TYPE(8);xt[0]=Me,xt[1]=Le,xt[2]=Oe,xt[3]=Fe;var Pt=.5*je,jt=.5*qe,Gt=.5*He;return xt[4]=Pt*Fe+jt*Oe-Gt*Le,xt[5]=jt*Fe+Gt*Me-Pt*Oe,xt[6]=Gt*Fe+Pt*Le-jt*Me,xt[7]=-Pt*Me-jt*Le-Gt*Oe,xt},Do.fromRotationTranslation=o,Do.fromTranslation=function(F,Me){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=.5*Me[0],F[5]=.5*Me[1],F[6]=.5*Me[2],F[7]=0,F},Do.fromRotation=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[3],F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},Do.fromMat4=function(Oe,Fe){var je=Me.create();Le.getRotation(je,Fe);var qe=new F.ARRAY_TYPE(3);return Le.getTranslation(qe,Fe),o(Oe,je,qe),Oe},Do.copy=l,Do.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},Do.set=function(F,Me,Le,Oe,Fe,je,qe,He,xt){return F[0]=Me,F[1]=Le,F[2]=Oe,F[3]=Fe,F[4]=je,F[5]=qe,F[6]=He,F[7]=xt,F},Do.getDual=function(F,Me){return F[0]=Me[4],F[1]=Me[5],F[2]=Me[6],F[3]=Me[7],F},Do.setDual=function(F,Me){return F[4]=Me[0],F[5]=Me[1],F[6]=Me[2],F[7]=Me[3],F},Do.getTranslation=function(F,Me){var Le=Me[4],Oe=Me[5],Fe=Me[6],je=Me[7],qe=-Me[0],He=-Me[1],xt=-Me[2],Pt=Me[3];return F[0]=2*(Le*Pt+je*qe+Oe*xt-Fe*He),F[1]=2*(Oe*Pt+je*He+Fe*qe-Le*xt),F[2]=2*(Fe*Pt+je*xt+Le*He-Oe*qe),F},Do.translate=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=.5*Le[0],xt=.5*Le[1],Pt=.5*Le[2],jt=Me[4],Gt=Me[5],bi=Me[6],wi=Me[7];return F[0]=Oe,F[1]=Fe,F[2]=je,F[3]=qe,F[4]=qe*He+Fe*Pt-je*xt+jt,F[5]=qe*xt+je*He-Oe*Pt+Gt,F[6]=qe*Pt+Oe*xt-Fe*He+bi,F[7]=-Oe*He-Fe*xt-je*Pt+wi,F},Do.rotateX=function(F,Le,Oe){var Fe=-Le[0],je=-Le[1],qe=-Le[2],He=Le[3],xt=Le[4],Pt=Le[5],jt=Le[6],Gt=Le[7],bi=xt*He+Gt*Fe+Pt*qe-jt*je,wi=Pt*He+Gt*je+jt*Fe-xt*qe,qr=jt*He+Gt*qe+xt*je-Pt*Fe,Xn=Gt*He-xt*Fe-Pt*je-jt*qe;return Me.rotateX(F,Le,Oe),F[4]=bi*(He=F[3])+Xn*(Fe=F[0])+wi*(qe=F[2])-qr*(je=F[1]),F[5]=wi*He+Xn*je+qr*Fe-bi*qe,F[6]=qr*He+Xn*qe+bi*je-wi*Fe,F[7]=Xn*He-bi*Fe-wi*je-qr*qe,F},Do.rotateY=function(F,Le,Oe){var Fe=-Le[0],je=-Le[1],qe=-Le[2],He=Le[3],xt=Le[4],Pt=Le[5],jt=Le[6],Gt=Le[7],bi=xt*He+Gt*Fe+Pt*qe-jt*je,wi=Pt*He+Gt*je+jt*Fe-xt*qe,qr=jt*He+Gt*qe+xt*je-Pt*Fe,Xn=Gt*He-xt*Fe-Pt*je-jt*qe;return Me.rotateY(F,Le,Oe),F[4]=bi*(He=F[3])+Xn*(Fe=F[0])+wi*(qe=F[2])-qr*(je=F[1]),F[5]=wi*He+Xn*je+qr*Fe-bi*qe,F[6]=qr*He+Xn*qe+bi*je-wi*Fe,F[7]=Xn*He-bi*Fe-wi*je-qr*qe,F},Do.rotateZ=function(F,Le,Oe){var Fe=-Le[0],je=-Le[1],qe=-Le[2],He=Le[3],xt=Le[4],Pt=Le[5],jt=Le[6],Gt=Le[7],bi=xt*He+Gt*Fe+Pt*qe-jt*je,wi=Pt*He+Gt*je+jt*Fe-xt*qe,qr=jt*He+Gt*qe+xt*je-Pt*Fe,Xn=Gt*He-xt*Fe-Pt*je-jt*qe;return Me.rotateZ(F,Le,Oe),F[4]=bi*(He=F[3])+Xn*(Fe=F[0])+wi*(qe=F[2])-qr*(je=F[1]),F[5]=wi*He+Xn*je+qr*Fe-bi*qe,F[6]=qr*He+Xn*qe+bi*je-wi*Fe,F[7]=Xn*He-bi*Fe-wi*je-qr*qe,F},Do.rotateByQuatAppend=function(F,Me,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Me[0],xt=Me[1],Pt=Me[2],jt=Me[3];return F[0]=He*qe+jt*Oe+xt*je-Pt*Fe,F[1]=xt*qe+jt*Fe+Pt*Oe-He*je,F[2]=Pt*qe+jt*je+He*Fe-xt*Oe,F[3]=jt*qe-He*Oe-xt*Fe-Pt*je,F[4]=(He=Me[4])*qe+(jt=Me[7])*Oe+(xt=Me[5])*je-(Pt=Me[6])*Fe,F[5]=xt*qe+jt*Fe+Pt*Oe-He*je,F[6]=Pt*qe+jt*je+He*Fe-xt*Oe,F[7]=jt*qe-He*Oe-xt*Fe-Pt*je,F},Do.rotateByQuatPrepend=function(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Le[0],xt=Le[1],Pt=Le[2],jt=Le[3];return F[0]=Oe*jt+qe*He+Fe*Pt-je*xt,F[1]=Fe*jt+qe*xt+je*He-Oe*Pt,F[2]=je*jt+qe*Pt+Oe*xt-Fe*He,F[3]=qe*jt-Oe*He-Fe*xt-je*Pt,F[4]=Oe*(jt=Le[7])+qe*(He=Le[4])+Fe*(Pt=Le[6])-je*(xt=Le[5]),F[5]=Fe*jt+qe*xt+je*He-Oe*Pt,F[6]=je*jt+qe*Pt+Oe*xt-Fe*He,F[7]=qe*jt-Oe*He-Fe*xt-je*Pt,F},Do.rotateAroundAxis=function(Me,Le,Oe,Fe){if(Math.abs(Fe)<F.EPSILON)return l(Me,Le);var je=Math.hypot(Oe[0],Oe[1],Oe[2]);Fe*=.5;var qe=Math.sin(Fe),He=qe*Oe[0]/je,xt=qe*Oe[1]/je,Pt=qe*Oe[2]/je,jt=Math.cos(Fe),Gt=Le[0],bi=Le[1],wi=Le[2],qr=Le[3];Me[0]=Gt*jt+qr*He+bi*Pt-wi*xt,Me[1]=bi*jt+qr*xt+wi*He-Gt*Pt,Me[2]=wi*jt+qr*Pt+Gt*xt-bi*He,Me[3]=qr*jt-Gt*He-bi*xt-wi*Pt;var Xn=Le[4],Yn=Le[5],yo=Le[6],bo=Le[7];return Me[4]=Xn*jt+bo*He+Yn*Pt-yo*xt,Me[5]=Yn*jt+bo*xt+yo*He-Xn*Pt,Me[6]=yo*jt+bo*Pt+Xn*xt-Yn*He,Me[7]=bo*jt-Xn*He-Yn*xt-yo*Pt,Me},Do.add=function(F,Me,Le){return F[0]=Me[0]+Le[0],F[1]=Me[1]+Le[1],F[2]=Me[2]+Le[2],F[3]=Me[3]+Le[3],F[4]=Me[4]+Le[4],F[5]=Me[5]+Le[5],F[6]=Me[6]+Le[6],F[7]=Me[7]+Le[7],F},Do.multiply=u,Do.scale=function(F,Me,Le){return F[0]=Me[0]*Le,F[1]=Me[1]*Le,F[2]=Me[2]*Le,F[3]=Me[3]*Le,F[4]=Me[4]*Le,F[5]=Me[5]*Le,F[6]=Me[6]*Le,F[7]=Me[7]*Le,F},Do.lerp=function(F,Me,Le,Fe){var je=1-Fe;return Oe(Me,Le)<0&&(Fe=-Fe),F[0]=Me[0]*je+Le[0]*Fe,F[1]=Me[1]*je+Le[1]*Fe,F[2]=Me[2]*je+Le[2]*Fe,F[3]=Me[3]*je+Le[3]*Fe,F[4]=Me[4]*je+Le[4]*Fe,F[5]=Me[5]*je+Le[5]*Fe,F[6]=Me[6]*je+Le[6]*Fe,F[7]=Me[7]*je+Le[7]*Fe,F},Do.invert=function(F,Me){var Le=je(Me);return F[0]=-Me[0]/Le,F[1]=-Me[1]/Le,F[2]=-Me[2]/Le,F[3]=Me[3]/Le,F[4]=-Me[4]/Le,F[5]=-Me[5]/Le,F[6]=-Me[6]/Le,F[7]=Me[7]/Le,F},Do.conjugate=function(F,Me){return F[0]=-Me[0],F[1]=-Me[1],F[2]=-Me[2],F[3]=Me[3],F[4]=-Me[4],F[5]=-Me[5],F[6]=-Me[6],F[7]=Me[7],F},Do.normalize=function(F,Me){var Le=je(Me);if(Le>0){Le=Math.sqrt(Le);var Oe=Me[0]/Le,Fe=Me[1]/Le,qe=Me[2]/Le,He=Me[3]/Le,xt=Me[4],Pt=Me[5],jt=Me[6],Gt=Me[7],bi=Oe*xt+Fe*Pt+qe*jt+He*Gt;F[0]=Oe,F[1]=Fe,F[2]=qe,F[3]=He,F[4]=(xt-Oe*bi)/Le,F[5]=(Pt-Fe*bi)/Le,F[6]=(jt-qe*bi)/Le,F[7]=(Gt-He*bi)/Le}return F},Do.str=function(F){return"quat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+")"},Do.exactEquals=function(F,Me){return F[0]===Me[0]&&F[1]===Me[1]&&F[2]===Me[2]&&F[3]===Me[3]&&F[4]===Me[4]&&F[5]===Me[5]&&F[6]===Me[6]&&F[7]===Me[7]},Do.equals=function(Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Me[4],xt=Me[5],Pt=Me[6],jt=Me[7],Gt=Le[0],bi=Le[1],wi=Le[2],qr=Le[3],Xn=Le[4],Yn=Le[5],yo=Le[6],bo=Le[7];return Math.abs(Oe-Gt)<=F.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(Gt))&&Math.abs(Fe-bi)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(bi))&&Math.abs(je-wi)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(wi))&&Math.abs(qe-qr)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(qr))&&Math.abs(He-Xn)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(Xn))&&Math.abs(xt-Yn)<=F.EPSILON*Math.max(1,Math.abs(xt),Math.abs(Yn))&&Math.abs(Pt-yo)<=F.EPSILON*Math.max(1,Math.abs(Pt),Math.abs(yo))&&Math.abs(jt-bo)<=F.EPSILON*Math.max(1,Math.abs(jt),Math.abs(bo))},Do.sqrLen=Do.squaredLength=Do.len=Do.length=Do.dot=Do.mul=Do.setReal=Do.getReal=void 0;var F=a(s()),Me=a(S()),Le=a(g());function i(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(i=function(F){return F?Le:Me})(F)}function a(F,Me){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=i(Me);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}function o(F,Me,Le){var Oe=.5*Le[0],Fe=.5*Le[1],je=.5*Le[2],qe=Me[0],He=Me[1],xt=Me[2],Pt=Me[3];return F[0]=qe,F[1]=He,F[2]=xt,F[3]=Pt,F[4]=Oe*Pt+Fe*xt-je*He,F[5]=Fe*Pt+je*qe-Oe*xt,F[6]=je*Pt+Oe*He-Fe*qe,F[7]=-Oe*qe-Fe*He-je*xt,F}function l(F,Me){return F[0]=Me[0],F[1]=Me[1],F[2]=Me[2],F[3]=Me[3],F[4]=Me[4],F[5]=Me[5],F[6]=Me[6],F[7]=Me[7],F}function u(F,Me,Le){var Oe=Me[0],Fe=Me[1],je=Me[2],qe=Me[3],He=Le[4],xt=Le[5],Pt=Le[6],jt=Le[7],Gt=Me[4],bi=Me[5],wi=Me[6],qr=Me[7],Xn=Le[0],Yn=Le[1],yo=Le[2],bo=Le[3];return F[0]=Oe*bo+qe*Xn+Fe*yo-je*Yn,F[1]=Fe*bo+qe*Yn+je*Xn-Oe*yo,F[2]=je*bo+qe*yo+Oe*Yn-Fe*Xn,F[3]=qe*bo-Oe*Xn-Fe*Yn-je*yo,F[4]=Oe*jt+qe*He+Fe*Pt-je*xt+Gt*bo+qr*Xn+bi*yo-wi*Yn,F[5]=Fe*jt+qe*xt+je*He-Oe*Pt+bi*bo+qr*Yn+wi*Xn-Gt*yo,F[6]=je*jt+qe*Pt+Oe*xt-Fe*He+wi*bo+qr*yo+Gt*Yn-bi*Xn,F[7]=qe*jt-Oe*He-Fe*xt-je*Pt+qr*bo-Gt*Xn-bi*Yn-wi*yo,F}Do.getReal=Me.copy,Do.setReal=Me.copy,Do.mul=u;var Oe=Me.dot;Do.dot=Oe;var Fe=Me.length;Do.length=Fe,Do.len=Fe;var je=Me.squaredLength;return Do.squaredLength=je,Do.sqrLen=je,Do}var zs,Zs,na={};function V(){if(zs)return na;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}zs=1,Object.defineProperty(na,"__esModule",{value:!0}),na.create=n,na.clone=function(Me){var Le=new F.ARRAY_TYPE(2);return Le[0]=Me[0],Le[1]=Me[1],Le},na.fromValues=function(Me,Le){var Oe=new F.ARRAY_TYPE(2);return Oe[0]=Me,Oe[1]=Le,Oe},na.copy=function(F,Me){return F[0]=Me[0],F[1]=Me[1],F},na.set=function(F,Me,Le){return F[0]=Me,F[1]=Le,F},na.add=function(F,Me,Le){return F[0]=Me[0]+Le[0],F[1]=Me[1]+Le[1],F},na.subtract=i,na.multiply=a,na.divide=o,na.ceil=function(F,Me){return F[0]=Math.ceil(Me[0]),F[1]=Math.ceil(Me[1]),F},na.floor=function(F,Me){return F[0]=Math.floor(Me[0]),F[1]=Math.floor(Me[1]),F},na.min=function(F,Me,Le){return F[0]=Math.min(Me[0],Le[0]),F[1]=Math.min(Me[1],Le[1]),F},na.max=function(F,Me,Le){return F[0]=Math.max(Me[0],Le[0]),F[1]=Math.max(Me[1],Le[1]),F},na.round=function(F,Me){return F[0]=Math.round(Me[0]),F[1]=Math.round(Me[1]),F},na.scale=function(F,Me,Le){return F[0]=Me[0]*Le,F[1]=Me[1]*Le,F},na.scaleAndAdd=function(F,Me,Le,Oe){return F[0]=Me[0]+Le[0]*Oe,F[1]=Me[1]+Le[1]*Oe,F},na.distance=l,na.squaredDistance=u,na.length=c,na.squaredLength=h,na.negate=function(F,Me){return F[0]=-Me[0],F[1]=-Me[1],F},na.inverse=function(F,Me){return F[0]=1/Me[0],F[1]=1/Me[1],F},na.normalize=function(F,Me){var Le=Me[0],Oe=Me[1],Fe=Le*Le+Oe*Oe;return Fe>0&&(Fe=1/Math.sqrt(Fe)),F[0]=Me[0]*Fe,F[1]=Me[1]*Fe,F},na.dot=function(F,Me){return F[0]*Me[0]+F[1]*Me[1]},na.cross=function(F,Me,Le){var Oe=Me[0]*Le[1]-Me[1]*Le[0];return F[0]=F[1]=0,F[2]=Oe,F},na.lerp=function(F,Me,Le,Oe){var Fe=Me[0],je=Me[1];return F[0]=Fe+Oe*(Le[0]-Fe),F[1]=je+Oe*(Le[1]-je),F},na.random=function(Me,Le){Le=Le||1;var Oe=2*F.RANDOM()*Math.PI;return Me[0]=Math.cos(Oe)*Le,Me[1]=Math.sin(Oe)*Le,Me},na.transformMat2=function(F,Me,Le){var Oe=Me[0],Fe=Me[1];return F[0]=Le[0]*Oe+Le[2]*Fe,F[1]=Le[1]*Oe+Le[3]*Fe,F},na.transformMat2d=function(F,Me,Le){var Oe=Me[0],Fe=Me[1];return F[0]=Le[0]*Oe+Le[2]*Fe+Le[4],F[1]=Le[1]*Oe+Le[3]*Fe+Le[5],F},na.transformMat3=function(F,Me,Le){var Oe=Me[0],Fe=Me[1];return F[0]=Le[0]*Oe+Le[3]*Fe+Le[6],F[1]=Le[1]*Oe+Le[4]*Fe+Le[7],F},na.transformMat4=function(F,Me,Le){var Oe=Me[0],Fe=Me[1];return F[0]=Le[0]*Oe+Le[4]*Fe+Le[12],F[1]=Le[1]*Oe+Le[5]*Fe+Le[13],F},na.rotate=function(F,Me,Le,Oe){var Fe=Me[0]-Le[0],je=Me[1]-Le[1],qe=Math.sin(Oe),He=Math.cos(Oe);return F[0]=Fe*He-je*qe+Le[0],F[1]=Fe*qe+je*He+Le[1],F},na.angle=function(F,Me){var Le=F[0],Oe=F[1],Fe=Me[0],je=Me[1],qe=Math.sqrt(Le*Le+Oe*Oe)*Math.sqrt(Fe*Fe+je*je);return Math.acos(Math.min(Math.max(qe&&(Le*Fe+Oe*je)/qe,-1),1))},na.zero=function(F){return F[0]=0,F[1]=0,F},na.str=function(F){return"vec2("+F[0]+", "+F[1]+")"},na.exactEquals=function(F,Me){return F[0]===Me[0]&&F[1]===Me[1]},na.equals=function(Me,Le){var Oe=Me[0],Fe=Me[1],je=Le[0],qe=Le[1];return Math.abs(Oe-je)<=F.EPSILON*Math.max(1,Math.abs(Oe),Math.abs(je))&&Math.abs(Fe-qe)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(qe))},na.forEach=na.sqrLen=na.sqrDist=na.dist=na.div=na.mul=na.sub=na.len=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Me=r(void 0);if(Me&&Me.has(F))return Me.get(F);var Le={},Oe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Fe in F)if("default"!==Fe&&Object.prototype.hasOwnProperty.call(F,Fe)){var je=Oe?Object.getOwnPropertyDescriptor(F,Fe):null;je&&(je.get||je.set)?Object.defineProperty(Le,Fe,je):Le[Fe]=F[Fe]}return Le.default=F,Me&&Me.set(F,Le),Le}(s());function r(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(r=function(F){return F?Le:Me})(F)}function n(){var Me=new F.ARRAY_TYPE(2);return F.ARRAY_TYPE!=Float32Array&&(Me[0]=0,Me[1]=0),Me}function i(F,Me,Le){return F[0]=Me[0]-Le[0],F[1]=Me[1]-Le[1],F}function a(F,Me,Le){return F[0]=Me[0]*Le[0],F[1]=Me[1]*Le[1],F}function o(F,Me,Le){return F[0]=Me[0]/Le[0],F[1]=Me[1]/Le[1],F}function l(F,Me){return Math.hypot(Me[0]-F[0],Me[1]-F[1])}function u(F,Me){var Le=Me[0]-F[0],Oe=Me[1]-F[1];return Le*Le+Oe*Oe}function c(F){return Math.hypot(F[0],F[1])}function h(F){var Me=F[0],Le=F[1];return Me*Me+Le*Le}na.len=c,na.sub=i,na.mul=a,na.div=o,na.dist=l,na.sqrDist=u,na.sqrLen=h;var Me,Le=(Me=n(),function(F,Le,Oe,Fe,je,qe){var He,xt;for(Le||(Le=2),Oe||(Oe=0),xt=Fe?Math.min(Fe*Le+Oe,F.length):F.length,He=Oe;He<xt;He+=Le)Me[0]=F[He],Me[1]=F[He+1],je(Me,Me,qe),F[He]=Me[0],F[He+1]=Me[1];return F});return na.forEach=Le,na}function C(){if(Zs)return Oe;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Zs=1,Object.defineProperty(Oe,"__esModule",{value:!0}),Oe.vec4=Oe.vec3=Oe.vec2=Oe.quat2=Oe.quat=Oe.mat4=Oe.mat3=Oe.mat2d=Oe.mat2=Oe.glMatrix=void 0;var F=x(s());Oe.glMatrix=F;var Me=x(l());Oe.mat2=Me;var Le=x(h());Oe.mat2d=Le;var Fe=x(d());Oe.mat3=Fe;var je=x(g());Oe.mat4=je;var qe=x(S());Oe.quat=qe;var He=x(z());Oe.quat2=He;var xt=x(V());Oe.vec2=xt;var Pt=x(_());Oe.vec3=Pt;var jt=x(I());function y(F){if("function"!=typeof WeakMap)return null;var Me=new WeakMap,Le=new WeakMap;return(y=function(F){return F?Le:Me})(F)}function x(F,Me){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=y(Me);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}return Oe.vec4=jt,Oe}var el,nl,hl,pl,bl=C(),Tl=function(){if(nl)return el;function t(Me,Le,Oe,Fe){(this||F).cx=3*Me,(this||F).bx=3*(Oe-Me)-(this||F).cx,(this||F).ax=1-(this||F).cx-(this||F).bx,(this||F).cy=3*Le,(this||F).by=3*(Fe-Le)-(this||F).cy,(this||F).ay=1-(this||F).cy-(this||F).by,(this||F).p1x=Me,(this||F).p1y=Le,(this||F).p2x=Oe,(this||F).p2y=Fe}return nl=1,el=t,t.prototype={sampleCurveX:function(Me){return(((this||F).ax*Me+(this||F).bx)*Me+(this||F).cx)*Me},sampleCurveY:function(Me){return(((this||F).ay*Me+(this||F).by)*Me+(this||F).cy)*Me},sampleCurveDerivativeX:function(Me){return(3*(this||F).ax*Me+2*(this||F).bx)*Me+(this||F).cx},solveCurveX:function(F,Me){if(void 0===Me&&(Me=1e-6),F<0)return 0;if(F>1)return 1;for(var Le=F,Oe=0;Oe<8;Oe++){var Fe=this.sampleCurveX(Le)-F;if(Math.abs(Fe)<Me)return Le;var je=this.sampleCurveDerivativeX(Le);if(Math.abs(je)<1e-6)break;Le-=Fe/je}var qe=0,He=1;for(Le=F,Oe=0;Oe<20&&(Fe=this.sampleCurveX(Le),!(Math.abs(Fe-F)<Me));Oe++)F>Fe?qe=Le:He=Le,Le=.5*(He-qe)+qe;return Le},solve:function(F,Me){return this.sampleCurveY(this.solveCurveX(F,Me))}},el}(),kl=e(Tl);function j(){if(pl)return hl;function t(Me,Le){(this||F).x=Me,(this||F).y=Le}return pl=1,hl=t,t.prototype={clone:function(){return new t((this||F).x,(this||F).y)},add:function(F){return this.clone()._add(F)},sub:function(F){return this.clone()._sub(F)},multByPoint:function(F){return this.clone()._multByPoint(F)},divByPoint:function(F){return this.clone()._divByPoint(F)},mult:function(F){return this.clone()._mult(F)},div:function(F){return this.clone()._div(F)},rotate:function(F){return this.clone()._rotate(F)},rotateAround:function(F,Me){return this.clone()._rotateAround(F,Me)},matMult:function(F){return this.clone()._matMult(F)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||F).x*(this||F).x+(this||F).y*(this||F).y)},equals:function(Me){return(this||F).x===Me.x&&(this||F).y===Me.y},dist:function(F){return Math.sqrt(this.distSqr(F))},distSqr:function(Me){var Le=Me.x-(this||F).x,Oe=Me.y-(this||F).y;return Le*Le+Oe*Oe},angle:function(){return Math.atan2((this||F).y,(this||F).x)},angleTo:function(Me){return Math.atan2((this||F).y-Me.y,(this||F).x-Me.x)},angleWith:function(F){return this.angleWithSep(F.x,F.y)},angleWithSep:function(Me,Le){return Math.atan2((this||F).x*Le-(this||F).y*Me,(this||F).x*Me+(this||F).y*Le)},_matMult:function(Me){var Le=Me[2]*(this||F).x+Me[3]*(this||F).y;return(this||F).x=Me[0]*(this||F).x+Me[1]*(this||F).y,(this||F).y=Le,this||F},_add:function(Me){return(this||F).x+=Me.x,(this||F).y+=Me.y,this||F},_sub:function(Me){return(this||F).x-=Me.x,(this||F).y-=Me.y,this||F},_mult:function(Me){return(this||F).x*=Me,(this||F).y*=Me,this||F},_div:function(Me){return(this||F).x/=Me,(this||F).y/=Me,this||F},_multByPoint:function(Me){return(this||F).x*=Me.x,(this||F).y*=Me.y,this||F},_divByPoint:function(Me){return(this||F).x/=Me.x,(this||F).y/=Me.y,this||F},_unit:function(){return this._div(this.mag()),this||F},_perp:function(){var Me=(this||F).y;return(this||F).y=(this||F).x,(this||F).x=-Me,this||F},_rotate:function(Me){var Le=Math.cos(Me),Oe=Math.sin(Me),Fe=Oe*(this||F).x+Le*(this||F).y;return(this||F).x=Le*(this||F).x-Oe*(this||F).y,(this||F).y=Fe,this||F},_rotateAround:function(Me,Le){var Oe=Math.cos(Me),Fe=Math.sin(Me),je=Le.y+Fe*((this||F).x-Le.x)+Oe*((this||F).y-Le.y);return(this||F).x=Le.x+Oe*((this||F).x-Le.x)-Fe*((this||F).y-Le.y),(this||F).y=je,this||F},_round:function(){return(this||F).x=Math.round((this||F).x),(this||F).y=Math.round((this||F).y),this||F}},t.convert=function(F){return F instanceof t?F:Array.isArray(F)?new t(F[0],F[1]):F},hl}var ec=e(j());function $(F,Me){if(Array.isArray(F)){if(!Array.isArray(Me)||F.length!==Me.length)return!1;for(let Le=0;Le<F.length;Le++)if(!$(F[Le],Me[Le]))return!1;return!0}if("object"==typeof F&&null!==F&&null!==Me){if("object"!=typeof Me)return!1;if(Object.keys(F).length!==Object.keys(Me).length)return!1;for(const Le in F)if(!$(F[Le],Me[Le]))return!1;return!0}return F===Me}const tc=Math.PI/180,ic=180/Math.PI;function H(F){return F*tc}function X(F){return F*ic}const oc=[[0,0],[1,0],[1,1],[0,1]];function W(F){if(F<=0)return 0;if(F>=1)return 1;const Me=F*F,Le=Me*F;return 4*(F<.5?Le:3*(F-Me)+Le-.75)}function K(F,Me,Le,Oe){const Fe=new kl(F,Me,Le,Oe);return function(F){return Fe.solve(F)}}const sc=K(.25,.1,.25,1);function Q(F,Me,Le){return Math.min(Le,Math.max(Me,F))}function tt(F,Me,Le){return(Le=Q((Le-F)/(Me-F),0,1))*Le*(3-2*Le)}function et(F,Me,Le){const Oe=Le-Me,Fe=((F-Me)%Oe+Oe)%Oe+Me;return Fe===Me?Le:Fe}function rt(F,Me,Le){if(!F.length)return Le(null,[]);let Oe=F.length;const Fe=new Array(F.length);let je=null;F.forEach(((F,qe)=>{Me(F,((F,Me)=>{F&&(je=F),Fe[qe]=Me,0==--Oe&&Le(je,Fe)}))}))}function nt(F,...Me){for(const Le of Me)for(const Me in Le)F[Me]=Le[Me];return F}let ac=1;function st(){return ac++}function at(F){return F<=1?1:Math.pow(2,Math.ceil(Math.log(F)/Math.LN2))}function ot(F,Me){F.forEach((F=>{Me[F]&&(Me[F]=Me[F].bind(Me))}))}function lt(Me,Le,Oe){const Fe={};for(const Oe in Me)Fe[Oe]=Le.call(this||F,Me[Oe],Oe,Me);return Fe}function ut(Me,Le,Oe){const Fe={};for(const Oe in Me)Le.call(this||F,Me[Oe],Oe,Me)&&(Fe[Oe]=Me[Oe]);return Fe}function ct(F){return Array.isArray(F)?F.map(ct):"object"==typeof F&&F?lt(F,ct):F}const mc={};function pt(F){mc[F]||("undefined"!=typeof console&&console.warn(F),mc[F]=!0)}function ft(F,Me,Le){return(Le.y-F.y)*(Me.x-F.x)>(Me.y-F.y)*(Le.x-F.x)}function dt(F){let Me=0;for(let Le,Oe,Fe=0,je=F.length,qe=je-1;Fe<je;qe=Fe++)Le=F[Fe],Oe=F[qe],Me+=(Oe.x-Le.x)*(Le.y+Oe.y);return Me}function mt([F,Me,Le]){const Oe=H(Me+90),Fe=H(Le);return{x:F*Math.cos(Oe)*Math.sin(Fe),y:F*Math.sin(Oe)*Math.sin(Fe),z:F*Math.cos(Fe),azimuthal:Me,polar:Le}}function yt(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function gt(F){const Me={};if(F.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((F,Le,Oe,Fe)=>{const je=Oe||Fe;return Me[Le]=!je||je.toLowerCase(),""})),Me["max-age"]){const F=parseInt(Me["max-age"],10);isNaN(F)?delete Me["max-age"]:Me["max-age"]=F}return Me}let gc=null;function vt(F,Me){return[F[4*Me],F[4*Me+1],F[4*Me+2],F[4*Me+3]]}function bt(F,Me,Le,Oe){for(;Me<Le;){const Fe=Me+Le>>1;F[Fe]<Oe?Me=Fe+1:Le=Fe}return Me}function _t(F,Me,Le,Oe){for(;Me<Le;){const Fe=Me+Le>>1;F[Fe]<=Oe?Me=Fe+1:Le=Fe}return Me}function wt(F){return F>0?1/(1.001-F):1+F}function Mt(F){return F>0?1-1/(1.001-F):-F}const yc={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!yc.API_URL)return null;try{const F=new URL(yc.API_URL);return"api.mapbox.cn"===F.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===F.hostname?"https://events.mapbox.com/events/v2":null}catch(F){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function It(F){return yc.API_URL_REGEX.test(F)}function St(F){return yc.API_SPRITE_REGEX.test(F)}let xc,Zc,Wc,Kc,Jc,Qc;function Vt(){return null==xc&&(xc=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),xc}const eh={now:()=>void 0!==Kc?Kc:performance.now(),setNow(F){Kc=F},restoreNow(){Kc=void 0},frame(F){const Me=requestAnimationFrame(F);return{cancel:()=>cancelAnimationFrame(Me)}},getImageData(F,Me=0){const{width:Le,height:Oe}=F;Jc||(Jc=document.createElement("canvas"));const Fe=Jc.getContext("2d",{willReadFrequently:!0});if(!Fe)throw new Error("failed to create canvas 2d context");return(Le>Jc.width||Oe>Jc.height)&&(Jc.width=Le,Jc.height=Oe),Fe.clearRect(-Me,-Me,Le+2*Me,Oe+2*Me),Fe.drawImage(F,0,0,Le,Oe),Fe.getImageData(-Me,-Me,Le+2*Me,Oe+2*Me)},resolveURL:F=>(Zc||(Zc=document.createElement("a")),Zc.href=F,Zc.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==Wc&&(Wc=window.matchMedia("(prefers-reduced-motion: reduce)")),Wc.matches)},hasCanvasFingerprintNoise(){if(void 0!==Qc)return Qc;if(!Vt())return Qc=!1,!1;const F=new OffscreenCanvas(85,1),Me=F.getContext("2d",{willReadFrequently:!0});let Le=0;for(let Oe=0;Oe<F.width;++Oe)Me.fillStyle=`rgba(${Le++},${Le++},${Le++}, 255)`,Me.fillRect(Oe,0,1,1);const Oe=Me.getImageData(0,0,F.width,F.height);Le=0;for(let F=0;F<Oe.data.length;++F)if(F%4!=3&&Le++!==Oe.data[F])return Qc=!0,!0;return Qc=!1,!1}};function Dt(F,Me){const Le=F.indexOf("?");if(Le<0)return`${F}?${new URLSearchParams(Me).toString()}`;const Oe=new URLSearchParams(F.slice(Le));for(const F in Me)Oe.set(F,Me[F]);return`${F.slice(0,Le)}?${Oe.toString()}`}function Rt(F,Me={persistentParams:[]}){const Le=F.indexOf("?");if(Le<0)return F;const Oe=new URLSearchParams,Fe=new URLSearchParams(F.slice(Le));for(const F of Me.persistentParams){const Me=Fe.get(F);Me&&Oe.set(F,Me)}const je=Oe.toString();return`${F.slice(0,Le)}${je.length>0?`?${je}`:""}`}const th="mapbox-tiles";let rh=500,oh=50;const ah=["language","worldview","jobid"];let lh,hh;function qt(){try{return caches}catch(F){}}function $t(){const F=qt();F&&null==lh&&(lh=F.open(th))}let ph=1/0;const wh={supported:!1,testSupport:function(F){!Ah&&Mh&&(Ih?Jt(F):Th=F)}};let Th,Mh,Ah=!1,Ih=!1;const Ch="undefined"!=typeof self?self:{};function Jt(F){const Me=F.createTexture();F.bindTexture(F.TEXTURE_2D,Me);try{if(F.texImage2D(F.TEXTURE_2D,0,F.RGBA,F.RGBA,F.UNSIGNED_BYTE,Mh),F.isContextLost())return;wh.supported=!0}catch(F){}F.deleteTexture(Me),Ah=!0}Ch.document&&(Mh=Ch.document.createElement("img"),Mh.onload=function(){Th&&Jt(Th),Th=null,Ih=!0},Mh.onerror=function(){Ah=!0,Th=null},Mh.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const zh={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(zh);class te extends Error{constructor(F,Me,Le){401===Me&&It(Le)&&(F+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(F),this.status=Me,this.url=Le}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Dh=yt()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href;const re=function(F,Me){if(!(/^file:/.test(Le=F.url)||/^file:/.test(Dh())&&!/^\w+:/.test(Le))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(F,Me){const Le=new AbortController,Oe=new Request(F.url,{method:F.method||"GET",body:F.body,credentials:F.credentials,headers:F.headers,referrer:Dh(),referrerPolicy:F.referrerPolicy,signal:Le.signal});let Fe=!1,je=!1;const qe=(He=Oe.url).indexOf("sku=")>0&&It(He);var He;"json"===F.type&&Oe.headers.set("Accept","application/json");const l=(Le,Fe,He)=>{if(je)return;if(Le&&"SecurityError"!==Le.message&&pt(Le.toString()),Fe&&He)return u(Fe);const xt=Date.now();fetch(Oe).then((Le=>{if(Le.ok){const F=qe?Le.clone():null;return u(Le,F,xt)}return Me(new te(Le.statusText,Le.status,F.url))})).catch((Le=>{"AbortError"!==Le.name&&Me(new Error(`${Le.message} ${F.url}`))}))},u=(Le,qe,He)=>{("arrayBuffer"===F.type?Le.arrayBuffer():"json"===F.type?Le.json():Le.text()).then((F=>{je||(qe&&He&&function(F,Me,Le){if($t(),null==lh)return;const Oe=gt(Me.headers.get("Cache-Control")||"");if(Oe["no-store"])return;const Fe={status:Me.status,statusText:Me.statusText,headers:new Headers};Me.headers.forEach(((F,Me)=>Fe.headers.set(Me,F))),Oe["max-age"]&&Fe.headers.set("Expires",new Date(Le+1e3*Oe["max-age"]).toUTCString());const je=Fe.headers.get("Expires");if(!je)return;if(new Date(je).getTime()-Le<42e4)return;let qe=Rt(F.url,{persistentParams:ah});if(206===Me.status){const Me=F.headers.get("Range");if(!Me)return;Fe.status=200,qe=Dt(qe,{range:Me})}!function(F,Me){if(void 0===hh)try{new Response(new ReadableStream),hh=!0}catch(F){hh=!1}hh?Me(F.body):F.blob().then(Me)}(Me,(F=>{const Le=new Response(200!==(Oe=Me.status)&&404!==Oe&&[101,103,204,205,304].includes(Oe)?null:F,Fe);var Oe;$t(),null!=lh&&lh.then((F=>F.put(qe,Le))).catch((F=>pt(F.message)))}))}(Oe,qe,He),Fe=!0,Me(null,F,Le.headers.get("Cache-Control"),Le.headers.get("Expires")))})).catch((F=>{je||Me(new Error(F.message))}))};return qe?function(F,Me){if($t(),null==lh)return Me(null);lh.then((Le=>{let Oe=Rt(F.url,{persistentParams:ah});const Fe=F.headers.get("Range");Fe&&(Oe=Dt(Oe,{range:Fe})),Le.match(Oe).then((F=>{const Fe=function(F){if(!F)return!1;const Me=new Date(F.headers.get("Expires")||0),Le=gt(F.headers.get("Cache-Control")||"");return Me>Date.now()&&!Le["no-cache"]}(F);Le.delete(Oe),Fe&&Le.put(Oe,F.clone()),Me(null,F,Fe)})).catch(Me)})).catch(Me)}(Oe,l):l(null,null),{cancel:()=>{je=!0,Fe||Le.abort()}}}(F,Me);if(yt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",F,Me,void 0,!0)}var Le;return function(F,Me){const Le=new XMLHttpRequest;Le.open(F.method||"GET",F.url,!0),"arrayBuffer"===F.type&&(Le.responseType="arraybuffer");for(const Me in F.headers)Le.setRequestHeader(Me,F.headers[Me]);return"json"===F.type&&(Le.responseType="text",Le.setRequestHeader("Accept","application/json")),Le.withCredentials="include"===F.credentials,Le.onerror=()=>{Me(new Error(Le.statusText))},Le.onload=()=>{if((Le.status>=200&&Le.status<300||0===Le.status)&&null!==Le.response){let Oe=Le.response;if("json"===F.type)try{Oe=JSON.parse(Le.response)}catch(F){return Me(F)}Me(null,Oe,Le.getResponseHeader("Cache-Control"),Le.getResponseHeader("Expires"))}else Me(new te(Le.statusText,Le.status,F.url))},Le.send(F.body),{cancel:()=>Le.abort()}}(F,Me)},ne=function(F,Me){return re(nt(F,{type:"arrayBuffer"}),Me)};function ie(F){const Me=document.createElement("a");return Me.href=F,Me.protocol===location.protocol&&Me.host===location.host}const kh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Bh,Vh;Bh=[],Vh=0;const le=function(Me,Le){if(wh.supported&&(Me.headers||(Me.headers={}),Me.headers.accept="image/webp,*/*"),Vh>=yc.MAX_PARALLEL_IMAGE_REQUESTS){const Oe={requestParameters:Me,callback:Le,cancelled:!1,cancel(){(this||F).cancelled=!0}};return Bh.push(Oe),Oe}Vh++;let Oe=!1;const n=()=>{if(!Oe)for(Oe=!0,Vh--;Bh.length&&Vh<yc.MAX_PARALLEL_IMAGE_REQUESTS;){const F=Bh.shift(),{requestParameters:Me,callback:Le,cancelled:Oe}=F;Oe||(F.cancel=le(Me,Le).cancel)}},Fe=ne(Me,((F,Me,Oe,Fe)=>{n(),F?Le(F):Me&&(self.createImageBitmap?function(F,Me){const Le=new Blob([new Uint8Array(F)],{type:"image/png"});createImageBitmap(Le).then((F=>{Me(null,F)})).catch((F=>{Me(new Error(`Could not load image because of ${F.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(Me,((F,Me)=>Le(F,Me,Oe,Fe))):function(F,Me){const Le=new Image;Le.onload=()=>{Me(null,Le),URL.revokeObjectURL(Le.src),Le.onload=null,requestAnimationFrame((()=>{Le.src=kh}))},Le.onerror=()=>Me(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const Oe=new Blob([new Uint8Array(F)],{type:"image/png"});Le.src=F.byteLength?URL.createObjectURL(Oe):kh}(Me,((F,Me)=>Le(F,Me,Oe,Fe))))}));return{cancel:()=>{Fe.cancel(),n()}}};var Uh,Qh,iu,ru={exports:{}},nu={exports:{}},su={exports:{}},au=function(){if(iu)return ru.exports;iu=1;var F=(Uh||(Uh=1,nu.exports=function(F,Me){var Le,Oe,Fe,je,qe,He,xt,Pt;for(Oe=F.length-(Le=3&F.length),Fe=Me,qe=3432918353,He=461845907,Pt=0;Pt<Oe;)xt=255&F.charCodeAt(Pt)|(255&F.charCodeAt(++Pt))<<8|(255&F.charCodeAt(++Pt))<<16|(255&F.charCodeAt(++Pt))<<24,++Pt,Fe=27492+(65535&(je=5*(65535&(Fe=(Fe^=xt=(65535&(xt=(xt=(65535&xt)*qe+(((xt>>>16)*qe&65535)<<16)&4294967295)<<15|xt>>>17))*He+(((xt>>>16)*He&65535)<<16)&4294967295)<<13|Fe>>>19))+((5*(Fe>>>16)&65535)<<16)&4294967295))+((58964+(je>>>16)&65535)<<16);switch(xt=0,Le){case 3:xt^=(255&F.charCodeAt(Pt+2))<<16;case 2:xt^=(255&F.charCodeAt(Pt+1))<<8;case 1:Fe^=xt=(65535&(xt=(xt=(65535&(xt^=255&F.charCodeAt(Pt)))*qe+(((xt>>>16)*qe&65535)<<16)&4294967295)<<15|xt>>>17))*He+(((xt>>>16)*He&65535)<<16)&4294967295}return Fe^=F.length,Fe=2246822507*(65535&(Fe^=Fe>>>16))+((2246822507*(Fe>>>16)&65535)<<16)&4294967295,Fe=3266489909*(65535&(Fe^=Fe>>>13))+((3266489909*(Fe>>>16)&65535)<<16)&4294967295,(Fe^=Fe>>>16)>>>0}),nu.exports),Me=(Qh||(Qh=1,su.exports=function(F,Me){for(var Le,Oe=F.length,Fe=Me^Oe,je=0;Oe>=4;)Le=1540483477*(65535&(Le=255&F.charCodeAt(je)|(255&F.charCodeAt(++je))<<8|(255&F.charCodeAt(++je))<<16|(255&F.charCodeAt(++je))<<24))+((1540483477*(Le>>>16)&65535)<<16),Fe=1540483477*(65535&Fe)+((1540483477*(Fe>>>16)&65535)<<16)^(Le=1540483477*(65535&(Le^=Le>>>24))+((1540483477*(Le>>>16)&65535)<<16)),Oe-=4,++je;switch(Oe){case 3:Fe^=(255&F.charCodeAt(je+2))<<16;case 2:Fe^=(255&F.charCodeAt(je+1))<<8;case 1:Fe=1540483477*(65535&(Fe^=255&F.charCodeAt(je)))+((1540483477*(Fe>>>16)&65535)<<16)}return Fe=1540483477*(65535&(Fe^=Fe>>>13))+((1540483477*(Fe>>>16)&65535)<<16),(Fe^=Fe>>>15)>>>0}),su.exports);return ru.exports=F,ru.exports.murmur3=F,ru.exports.murmur2=Me,ru.exports}(),hu=e(au);class ge{constructor(F,...Me){nt(this,Me[0]||{}),this.type=F}}class xe extends ge{constructor(F,Me={}){super("error",nt({error:F},Me))}}function ve(F,Me,Le){Le[F]&&-1!==Le[F].indexOf(Me)||(Le[F]=Le[F]||[],Le[F].push(Me))}function be(F,Me,Le){if(Le&&Le[F]){const Oe=Le[F].indexOf(Me);-1!==Oe&&Le[F].splice(Oe,1)}}class _e{on(F,Me){return this._listeners=this._listeners||{},ve(F,Me,this._listeners),this}off(F,Me){return be(F,Me,this._listeners),be(F,Me,this._oneTimeListeners),this}once(F,Me){return Me?(this._oneTimeListeners=this._oneTimeListeners||{},ve(F,Me,this._oneTimeListeners),this):new Promise((Me=>{this.once(F,Me)}))}fire(F,Me){const Le="string"==typeof F?new ge(F,Me):F,Oe=Le.type;if(this.listens(Oe)){Le.target=this;const F=this._listeners&&this._listeners[Oe]?this._listeners[Oe].slice():[];for(const Me of F)Me.call(this,Le);const Me=this._oneTimeListeners&&this._oneTimeListeners[Oe]?this._oneTimeListeners[Oe].slice():[];for(const F of Me)be(Oe,F,this._oneTimeListeners),F.call(this,Le);const Fe=this._eventedParent;Fe&&(nt(Le,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),Fe.fire(Le))}else Le instanceof xe&&console.error(Le.error);return this}listens(F){return!!(this._listeners&&this._listeners[F]&&this._listeners[F].length>0||this._oneTimeListeners&&this._oneTimeListeners[F]&&this._oneTimeListeners[F].length>0||this._eventedParent&&this._eventedParent.listens(F))}setEventedParent(F,Me){return this._eventedParent=F,this._eventedParentData=Me,this}}class we{constructor(F){"string"==typeof F?this.name=F:(this.name=F.name,this.iconsetId=F.iconsetId)}static from(F){return new we(F)}static toString(F){return F.iconsetId?`${F.name}${F.iconsetId}`:F.name}static parse(F){const[Me,Le]=F.split("");return new we({name:Me,iconsetId:Le})}static isEqual(F,Me){return F.name===Me.name&&F.iconsetId===Me.iconsetId}toString(){return we.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var du,pu={},fu=function(){if(du)return pu;du=1;var F={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(F){return(F=Math.round(F))<0?0:F>255?255:F}function r(F){return e("%"===F[F.length-1]?parseFloat(F)/100*255:parseInt(F))}function n(F){return(Me="%"===F[F.length-1]?parseFloat(F)/100:parseFloat(F))<0?0:Me>1?1:Me;var Me}function i(F,Me,Le){return Le<0?Le+=1:Le>1&&(Le-=1),6*Le<1?F+(Me-F)*Le*6:2*Le<1?Me:3*Le<2?F+(Me-F)*(2/3-Le)*6:F}try{pu.parseCSSColor=function(Me){var Le,Oe=Me.replace(/ /g,"").toLowerCase();if(Oe in F)return F[Oe].slice();if("#"===Oe[0])return 4===Oe.length?(Le=parseInt(Oe.substr(1),16))>=0&&Le<=4095?[(3840&Le)>>4|(3840&Le)>>8,240&Le|(240&Le)>>4,15&Le|(15&Le)<<4,1]:null:7===Oe.length&&(Le=parseInt(Oe.substr(1),16))>=0&&Le<=16777215?[(16711680&Le)>>16,(65280&Le)>>8,255&Le,1]:null;var Fe=Oe.indexOf("("),je=Oe.indexOf(")");if(-1!==Fe&&je+1===Oe.length){var qe=Oe.substr(0,Fe),He=Oe.substr(Fe+1,je-(Fe+1)).split(","),xt=1;switch(qe){case"rgba":if(4!==He.length)return null;xt=n(He.pop());case"rgb":return 3!==He.length?null:[r(He[0]),r(He[1]),r(He[2]),xt];case"hsla":if(4!==He.length)return null;xt=n(He.pop());case"hsl":if(3!==He.length)return null;var Pt=(parseFloat(He[0])%360+360)%360/360,jt=n(He[1]),Gt=n(He[2]),bi=Gt<=.5?Gt*(jt+1):Gt+jt-Gt*jt,wi=2*Gt-bi;return[e(255*i(wi,bi,Pt+1/3)),e(255*i(wi,bi,Pt)),e(255*i(wi,bi,Pt-1/3)),xt];default:return null}}return null}}catch(F){}return pu}();class Se{constructor(F,Me,Le,Oe=1){this.r=F,this.g=Me,this.b=Le,this.a=Oe}static parse(F){if(!F)return;if(F instanceof Se)return F;if("string"!=typeof F)return;const Me=fu.parseCSSColor(F);return Me?new Se(Me[0]/255*Me[3],Me[1]/255*Me[3],Me[2]/255*Me[3],Me[3]):void 0}toStringPremultipliedAlpha(){const[F,Me,Le,Oe]=0===this.a?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(F)},${Math.round(Me)},${Math.round(Le)},${Oe})`}toString(){const[F,Me,Le,Oe]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*F)},${Math.round(255*Me)},${Math.round(255*Le)},${Oe})`}toRenderColor(F){const{r:Me,g:Le,b:Oe,a:Fe}=this;return new Pe(F,Me,Le,Oe,Fe)}clone(){return new Se(this.r,this.g,this.b,this.a)}}class Pe{constructor(F,Me,Le,Oe,Fe){if(F){const je=F.image.height,qe=je*je;Me=0===Fe?0:Me/Fe*(je-1),Le=0===Fe?0:Le/Fe*(je-1),Oe=0===Fe?0:Oe/Fe*(je-1);const He=Math.floor(Me),xt=Math.floor(Le),Pt=Math.floor(Oe),jt=Math.ceil(Me),Gt=Math.ceil(Le),bi=Math.ceil(Oe),wi=Me-He,qr=Le-xt,Xn=Oe-Pt,Yn=F.image.data,yo=4*(He+xt*qe+Pt*je),bo=4*(He+xt*qe+bi*je),Ro=4*(He+Gt*qe+Pt*je),Do=4*(He+Gt*qe+bi*je),zs=4*(jt+xt*qe+Pt*je),Zs=4*(jt+xt*qe+bi*je),na=4*(jt+Gt*qe+Pt*je),el=4*(jt+Gt*qe+bi*je);if(yo<0||el>=Yn.length)throw new Error("out of range");this.r=Ee(Ee(Ee(Yn[yo],Yn[bo],Xn),Ee(Yn[Ro],Yn[Do],Xn),qr),Ee(Ee(Yn[zs],Yn[Zs],Xn),Ee(Yn[na],Yn[el],Xn),qr),wi)/255*Fe,this.g=Ee(Ee(Ee(Yn[yo+1],Yn[bo+1],Xn),Ee(Yn[Ro+1],Yn[Do+1],Xn),qr),Ee(Ee(Yn[zs+1],Yn[Zs+1],Xn),Ee(Yn[na+1],Yn[el+1],Xn),qr),wi)/255*Fe,this.b=Ee(Ee(Ee(Yn[yo+2],Yn[bo+2],Xn),Ee(Yn[Ro+2],Yn[Do+2],Xn),qr),Ee(Ee(Yn[zs+2],Yn[Zs+2],Xn),Ee(Yn[na+2],Yn[el+2],Xn),qr),wi)/255*Fe,this.a=Fe}else this.r=Me,this.g=Le,this.b=Oe,this.a=Fe}toArray(){const{r:F,g:Me,b:Le,a:Oe}=this;return 0===Oe?[0,0,0,0]:[255*F/Oe,255*Me/Oe,255*Le/Oe,Oe]}toHslaArray(){if(0===this.a)return[0,0,0,0];const{r:F,g:Me,b:Le,a:Oe}=this,Fe=Math.min(Math.max(F/Oe,0),1),je=Math.min(Math.max(Me/Oe,0),1),qe=Math.min(Math.max(Le/Oe,0),1),He=Math.min(Fe,je,qe),xt=Math.max(Fe,je,qe),Pt=(He+xt)/2;if(He===xt)return[0,0,100*Pt,Oe];const jt=xt-He,Gt=Pt>.5?jt/(2-xt-He):jt/(xt+He);let bi=0;return xt===Fe?bi=(je-qe)/jt+(je<qe?6:0):xt===je?bi=(qe-Fe)/jt+2:xt===qe&&(bi=(Fe-je)/jt+4),bi*=60,[Math.min(Math.max(bi,0),360),Math.min(Math.max(100*Gt,0),100),Math.min(Math.max(100*Pt,0),100),Oe]}toArray01(){const{r:F,g:Me,b:Le,a:Oe}=this;return 0===Oe?[0,0,0,0]:[F/Oe,Me/Oe,Le/Oe,Oe]}toArray01Scaled(F){const{r:Me,g:Le,b:Oe,a:Fe}=this;return 0===Fe?[0,0,0]:[Me/Fe*F,Le/Fe*F,Oe/Fe*F]}toArray01PremultipliedAlpha(){const{r:F,g:Me,b:Le,a:Oe}=this;return[F,Me,Le,Oe]}toArray01Linear(){const{r:F,g:Me,b:Le,a:Oe}=this;return 0===Oe?[0,0,0,0]:[Math.pow(F/Oe,2.2),Math.pow(Me/Oe,2.2),Math.pow(Le/Oe,2.2),Oe]}}function Ee(F,Me,Le){return F*(1-Le)+Me*Le}function ze(F,Me,Le){return F.map(((F,Oe)=>Ee(F,Me[Oe],Le)))}function ke(F){return F*F*F*F*F}Se.black=new Se(0,0,0,1),Se.white=new Se(1,1,1,1),Se.transparent=new Se(0,0,0,0),Se.red=new Se(1,0,0,1),Se.blue=new Se(0,0,1,1);var mu=Object.freeze({__proto__:null,array:ze,color:function(F,Me,Le){return new Se(Ee(F.r,Me.r,Le),Ee(F.g,Me.g,Le),Ee(F.b,Me.b,Le),Ee(F.a,Me.a,Le))},easeIn:ke,number:Ee});function Be(F,...Me){for(const Le of Me)for(const Me in Le)F[Me]=Le[Me];return F}class Ve extends Error{constructor(F,Me){super(Me),this.message=Me,this.key=F}}class Ce{constructor(F,Me=[]){this.parent=F,this.bindings={};for(const[F,Le]of Me)this.bindings[F]=Le}concat(F){return new Ce(this,F)}get(F){if(this.bindings[F])return this.bindings[F];if(this.parent)return this.parent.get(F);throw new Error(`${F} not found in scope.`)}has(F){return!!this.bindings[F]||!!this.parent&&this.parent.has(F)}}const Su={kind:"null"},Fu={kind:"number"},Hu={kind:"string"},Zu={kind:"boolean"},Wu={kind:"color"},Xu={kind:"object"},hd={kind:"value"},md={kind:"collator"},_d={kind:"formatted"},xd={kind:"resolvedImage"};function Ge(F,Me){return{kind:"array",itemType:F,N:Me}}function Ye(F){if("array"===F.kind){const Me=Ye(F.itemType);return"number"==typeof F.N?`array<${Me}, ${F.N}>`:"value"===F.itemType.kind?"array":`array<${Me}>`}return F.kind}const vd=[Su,Fu,Hu,Zu,Wu,_d,Xu,Ge(hd),xd];function Xe(F,Me){if("error"===Me.kind)return null;if("array"===F.kind){if("array"===Me.kind&&(0===Me.N&&"value"===Me.itemType.kind||!Xe(F.itemType,Me.itemType))&&("number"!=typeof F.N||F.N===Me.N))return null}else{if(F.kind===Me.kind)return null;if("value"===F.kind)for(const F of vd)if(!Xe(F,Me))return null}return`Expected ${Ye(F)} but found ${Ye(Me)} instead.`}function Ze(F,Me){return Me.some((Me=>Me.kind===F.kind))}function We(F,Me){return Me.some((Me=>"null"===Me?null===F:"array"===Me?Array.isArray(F):"object"===Me?F&&!Array.isArray(F)&&"object"==typeof F:Me===typeof F))}class Ke{constructor(F,Me,Le){this.sensitivity=F?Me?"variant":"case":Me?"accent":"base",this.locale=Le,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(F,Me){return this.collator.compare(F,Me)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Je{constructor(F,Me,Le,Oe,Fe){this.text=F.normalize?F.normalize():F,this.image=Me,this.scale=Le,this.fontStack=Oe,this.textColor=Fe}}class Qe{constructor(F){this.sections=F}static fromString(F){return new Qe([new Je(F,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((F=>0!==F.text.length||!!F.image&&F.image.hasPrimary()))}static factory(F){return F instanceof Qe?F:Qe.fromString(F)}toString(){return 0===this.sections.length?"":this.sections.map((F=>F.text)).join("")}serialize(){const F=["format"];for(const Me of this.sections){if(Me.image){const Le=Me.image.getPrimary().id.toString();F.push(["image",Le]);continue}F.push(Me.text);const Le={};Me.fontStack&&(Le["text-font"]=["literal",Me.fontStack.split(",")]),Me.scale&&(Le["font-scale"]=Me.scale),Me.textColor&&(Le["text-color"]=["rgba"].concat(Me.textColor.toRenderColor(null).toArray())),F.push(Le)}return F}}class tr{constructor(F,Me={}){if(this.id=we.from(F),this.options=Object.assign({},Me),Me.transform){const{a:F,b:Le,c:Oe,d:Fe,e:je,f:qe}=Me.transform;this.options.transform=new DOMMatrix([F,Le,Oe,Fe,je,qe])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:F,b:Me,c:Le,d:Oe,e:Fe,f:je}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:F,b:Me,c:Le,d:Oe,e:Fe,f:je}})}static parse(F){let Me,Le,Oe,Fe;try{({name:Me,iconsetId:Le,params:Oe,transform:Fe}=JSON.parse(F)||{})}catch(F){return null}if(!Me)return null;const{a:je,b:qe,c:He,d:xt,e:Pt,f:jt}=Fe||{};return new tr({name:Me,iconsetId:Le},{params:Oe,transform:new DOMMatrix([je,qe,He,xt,Pt,jt])})}scaleSelf(F){return this.options.transform.scaleSelf(F),this}}class er{constructor(F,Me,Le,Oe,Fe=!1){this.primaryId=we.from(F),this.primaryOptions=Me,Le&&(this.secondaryId=we.from(Le)),this.secondaryOptions=Oe,this.available=Fe}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new tr(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new tr(this.secondaryId,this.secondaryOptions):null}static from(F){return"string"==typeof F?er.build({name:F}):F}static build(F,Me,Le,Oe){return!F||"object"==typeof F&&!("name"in F)?null:new er(F,Le,Me,Oe)}}function rr(F,Me,Le,Oe){return"number"==typeof F&&F>=0&&F<=255&&"number"==typeof Me&&Me>=0&&Me<=255&&"number"==typeof Le&&Le>=0&&Le<=255?void 0===Oe||"number"==typeof Oe&&Oe>=0&&Oe<=1?null:`Invalid rgba value [${[F,Me,Le,Oe].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof Oe?[F,Me,Le,Oe]:[F,Me,Le]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function nr(F){if(null===F)return!0;if("string"==typeof F)return!0;if("boolean"==typeof F)return!0;if("number"==typeof F)return!0;if(F instanceof Se)return!0;if(F instanceof Ke)return!0;if(F instanceof Qe)return!0;if(F instanceof er)return!0;if(Array.isArray(F)){for(const Me of F)if(!nr(Me))return!1;return!0}if("object"==typeof F){for(const Me in F)if(!nr(F[Me]))return!1;return!0}return!1}function ir(F){if(null===F)return Su;if("string"==typeof F)return Hu;if("boolean"==typeof F)return Zu;if("number"==typeof F)return Fu;if(F instanceof Se)return Wu;if(F instanceof Ke)return md;if(F instanceof Qe)return _d;if(F instanceof er)return xd;if(Array.isArray(F)){const Me=F.length;let Le;for(const Me of F){const F=ir(Me);if(Le){if(Le===F)continue;Le=hd;break}Le=F}return Ge(Le||hd,Me)}return Xu}function sr(F){const Me=typeof F;return null===F?"":"string"===Me||"number"===Me||"boolean"===Me?String(F):F instanceof Se?F.toStringPremultipliedAlpha():F instanceof Qe||F instanceof er?F.toString():JSON.stringify(F)}class ar{constructor(F,Me){this.type=F,this.value=Me}static parse(F,Me){if(2!==F.length)return Me.error(`'literal' expression requires exactly one argument, but found ${F.length-1} instead.`);if(!nr(F[1]))return Me.error("invalid value");const Le=F[1];let Oe=ir(Le);const Fe=Me.expectedType;return"array"!==Oe.kind||0!==Oe.N||!Fe||"array"!==Fe.kind||"number"==typeof Fe.N&&0!==Fe.N||(Oe=Fe),new ar(Oe,Le)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Se?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof Qe?this.value.serialize():this.value}}class or{constructor(F){this.name="ExpressionEvaluationError",this.message=F}toJSON(){return this.message}}const Bd={string:Hu,number:Fu,boolean:Zu,object:Xu};class ur{constructor(F,Me){this.type=F,this.args=Me}static parse(F,Me){if(F.length<2)return Me.error("Expected at least one argument.");let Le,Oe=1;const Fe=F[0];if("array"===Fe){let Fe,je;if(F.length>2){const Le=F[1];if("string"!=typeof Le||!(Le in Bd)||"object"===Le)return Me.error('The item type argument of "array" must be one of string, number, boolean',1);Fe=Bd[Le],Oe++}else Fe=hd;if(F.length>3){if(null!==F[2]&&("number"!=typeof F[2]||F[2]<0||F[2]!==Math.floor(F[2])))return Me.error('The length argument to "array" must be a positive integer literal',2);je=F[2],Oe++}Le=Ge(Fe,je)}else Le=Bd[Fe];const je=[];for(;Oe<F.length;Oe++){const Le=Me.parse(F[Oe],Oe,hd);if(!Le)return null;je.push(Le)}return new ur(Le,je)}evaluate(F){for(let Me=0;Me<this.args.length;Me++){const Le=this.args[Me].evaluate(F);if(!Xe(this.type,ir(Le)))return Le;if(Me===this.args.length-1)throw new or(`The expression ${JSON.stringify(this.args[Me].serialize())} evaluated to ${Ye(ir(Le))} but was expected to be of type ${Ye(this.type)}.`)}return null}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){const F=this.type,Me=[F.kind];if("array"===F.kind){const Le=F.itemType;if("string"===Le.kind||"number"===Le.kind||"boolean"===Le.kind){Me.push(Le.kind);const Oe=F.N;("number"==typeof Oe||this.args.length>1)&&Me.push(Oe)}}return Me.concat(this.args.map((F=>F.serialize())))}}class cr{constructor(F){this.type=_d,this.sections=F}static parse(F,Me){if(F.length<2)return Me.error("Expected at least one argument.");const Le=F[1];if(!Array.isArray(Le)&&"object"==typeof Le)return Me.error("First argument must be an image or text section.");const Oe=[];let Fe=!1;for(let Le=1;Le<=F.length-1;++Le){const je=F[Le];if(Fe&&"object"==typeof je&&!Array.isArray(je)){Fe=!1;let F=null;if(je["font-scale"]&&(F=Me.parseObjectValue(je["font-scale"],Le,"font-scale",Fu),!F))return null;let qe=null;if(je["text-font"]&&(qe=Me.parseObjectValue(je["text-font"],Le,"text-font",Ge(Hu)),!qe))return null;let He=null;if(je["text-color"]&&(He=Me.parseObjectValue(je["text-color"],Le,"text-color",Wu),!He))return null;const xt=Oe[Oe.length-1];xt.scale=F,xt.font=qe,xt.textColor=He}else{const je=Me.parse(F[Le],Le,hd);if(!je)return null;const qe=je.type.kind;if("string"!==qe&&"value"!==qe&&"null"!==qe&&"resolvedImage"!==qe)return Me.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");Fe=!0,Oe.push({content:je,scale:null,font:null,textColor:null})}}return new cr(Oe)}evaluate(F){return new Qe(this.sections.map((Me=>{const Le=Me.content.evaluate(F);return ir(Le)===xd?new Je("",Le,null,null,null):new Je(sr(Le),null,Me.scale?Me.scale.evaluate(F):null,Me.font?Me.font.evaluate(F).join(","):null,Me.textColor?Me.textColor.evaluate(F):null)})))}eachChild(F){for(const Me of this.sections)F(Me.content),Me.scale&&F(Me.scale),Me.font&&F(Me.font),Me.textColor&&F(Me.textColor)}outputDefined(){return!1}serialize(){const F=["format"];for(const Me of this.sections){F.push(Me.content.serialize());const Le={};Me.scale&&(Le["font-scale"]=Me.scale.serialize()),Me.font&&(Le["text-font"]=Me.font.serialize()),Me.textColor&&(Le["text-color"]=Me.textColor.serialize()),F.push(Le)}return F}}class hr{constructor(F,Me,Le,Oe){this._imageWarnHistory={},this.type=xd,this.namePrimary=F,this.nameSecondary=Me,Le&&(this.paramsPrimary=Le.params,this.iconsetIdPrimary=Le.iconset?Le.iconset.id:void 0),Oe&&(this.paramsSecondary=Oe.params,this.iconsetIdSecondary=Oe.iconset?Oe.iconset.id:void 0)}static parse(F,Me){if(F.length<2)return Me.error("Expected two or more arguments.");let Le=1;const Oe=[];function i(){if(Le<F.length){const Fe=Me.parse(F[Le],Le++,Hu);return Fe?(Oe.push({image:Fe,options:{}}),!0):(Me.error(Oe.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function s(){if(Le<F.length){const je=F[Le];if(null===(Fe=je)||"object"!=typeof Fe||Array.isArray(Fe))return!0;const qe=je.params,He=je.iconset,xt=Me.concat(Le);if(!qe&&!He)return Le++,!0;if(qe){if("object"!=typeof qe||qe.constructor!==Object)return xt.error('Image options "params" should be an object'),!1;const F={},Me=xt.concat(void 0,"params");for(const Le in qe){if(!Le)return Me.error("Image parameter name should be non-empty"),!1;const Oe=Me.concat(void 0,Le).parse(qe[Le],void 0,Wu,void 0,{typeAnnotation:"coerce"});if(!Oe)return!1;F[Le]=Oe}Oe[Oe.length-1].options.params=F}if(He){if("object"!=typeof He||He.constructor!==Object)return xt.error('Image options "iconset" should be an object'),!1;if(!He.id)return xt.error('Image options "iconset" should have an "id" property'),!1;Oe[Oe.length-1].options.iconset=He}return Le++,!0}var Fe;return!0}for(let F=0;F<2;F++)if(!i()||!s())return;return new hr(Oe[0].image,Oe[1]?Oe[1].image:void 0,Oe[0].options,Oe[1]?Oe[1].options:void 0)}evaluateParams(F,Me){const Le={};if(Me){for(const Oe in Me)if(Me[Oe])try{Le[Oe]=Me[Oe].evaluate(F)}catch(F){continue}if(0!==Object.keys(Le).length)return{params:Le}}}evaluate(F){const Me={name:this.namePrimary.evaluate(F),iconsetId:this.iconsetIdPrimary},Le=this.nameSecondary?{name:this.nameSecondary.evaluate(F),iconsetId:this.iconsetIdSecondary}:void 0,Oe=er.build(Me,Le,this.paramsPrimary?this.evaluateParams(F,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(F,this.paramsSecondary):void 0);if(Oe&&F.availableImages){const Me=Oe.getPrimary().id;if(Oe.available=F.availableImages.some((F=>we.isEqual(F,Me))),Oe.available){const Me=Oe.getSecondary()?Oe.getSecondary().id:null;Me&&(Oe.available=F.availableImages.some((F=>we.isEqual(F,Me))))}}return Oe}eachChild(F){if(F(this.namePrimary),this.paramsPrimary)for(const Me in this.paramsPrimary)this.paramsPrimary[Me]&&F(this.paramsPrimary[Me]);if(this.nameSecondary&&(F(this.nameSecondary),this.paramsSecondary))for(const Me in this.paramsSecondary)this.paramsSecondary[Me]&&F(this.paramsSecondary[Me])}outputDefined(){return!1}serializeOptions(F,Me){const Le={};if(Me&&(Le.iconset={id:Me}),F){Le.params={};for(const Me in F)F[Me]&&(Le.params[Me]=F[Me].serialize())}return Object.keys(Le).length>0?Le:void 0}serialize(){const F=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const Me=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);Me&&F.push(Me)}if(this.nameSecondary&&(F.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const Me=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);Me&&F.push(Me)}return F}}function pr(F){return F instanceof Number?"number":F instanceof String?"string":F instanceof Boolean?"boolean":Array.isArray(F)?"array":null===F?"null":typeof F}const Vd={"to-boolean":Zu,"to-color":Wu,"to-number":Fu,"to-string":Hu};class dr{constructor(F,Me){this.type=F,this.args=Me}static parse(F,Me){if(F.length<2)return Me.error("Expected at least one argument.");const Le=F[0],Oe=[];let Fe=Su;if("to-array"===Le){if(!Array.isArray(F[1]))return null;const Le=F[1].length;if(Me.expectedType){if("array"!==Me.expectedType.kind)return Me.error(`Expected ${Me.expectedType.kind} but found array.`);Fe=Ge(Me.expectedType.itemType,Le)}else{if(!(Le>0&&nr(F[1][0])))return null;Fe=Ge(ir(F[1][0]),Le)}for(let je=0;je<Le;je++){const Le=F[1][je];let qe;if("array"===pr(Le))qe=Me.parse(Le,void 0,Fe.itemType);else{const F=pr(Le);if(F!==Fe.itemType.kind)return Me.error(`Expected ${Fe.itemType.kind} but found ${F}.`);qe=Me.registry.literal.parse(["literal",void 0===Le?null:Le],Me)}if(!qe)return null;Oe.push(qe)}}else{if(("to-boolean"===Le||"to-string"===Le)&&2!==F.length)return Me.error("Expected one argument.");Fe=Vd[Le];for(let Le=1;Le<F.length;Le++){const Fe=Me.parse(F[Le],Le,hd);if(!Fe)return null;Oe.push(Fe)}}return new dr(Fe,Oe)}evaluate(F){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(F));if("color"===this.type.kind){let Me,Le;for(const Oe of this.args){if(Me=Oe.evaluate(F),Le=null,Me instanceof Se)return Me;if("string"==typeof Me){const Le=F.parseColor(Me);if(Le)return Le}else if(Array.isArray(Me)&&(Le=Me.length<3||Me.length>4?`Invalid rbga value ${JSON.stringify(Me)}: expected an array containing either three or four numeric values.`:rr(Me[0],Me[1],Me[2],Me[3]),!Le))return new Se(Me[0]/255,Me[1]/255,Me[2]/255,Me[3])}throw new or(Le||`Could not parse color from value '${"string"==typeof Me?Me:String(JSON.stringify(Me))}'`)}if("number"===this.type.kind){let Me=null;for(const Le of this.args){if(Me=Le.evaluate(F),null===Me)return 0;const Oe=Number(Me);if(!isNaN(Oe))return Oe}throw new or(`Could not convert ${JSON.stringify(Me)} to number.`)}return"formatted"===this.type.kind?Qe.fromString(sr(this.args[0].evaluate(F))):"resolvedImage"===this.type.kind?er.build(sr(this.args[0].evaluate(F))):"array"===this.type.kind?this.args.map((Me=>Me.evaluate(F))):sr(this.args[0].evaluate(F))}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new cr([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new hr(this.args[0]).serialize();const F="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((Me=>{F.push(Me.serialize())})),F}}const qd=["Unknown","Point","LineString","Polygon"];class yr{constructor(F,Me){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=F,this.options=Me}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?qd[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(F){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const F=this.featureDistanceData.center,Me=this.featureDistanceData.scale,{x:Le,y:Oe}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(Le*Me-F[0])+this.featureDistanceData.bearing[1]*(Oe*Me-F[1])}return 0}parseColor(F){let Me=this._parseColorCache[F];return Me||(Me=this._parseColorCache[F]=Se.parse(F)),Me}getConfig(F){return this.options?this.options.get(F):null}}class gr{constructor(F,Me,Le,Oe,Fe){this.name=F,this.type=Me,this._evaluate=Le,this.args=Oe,this._overloadIndex=Fe}evaluate(F){if(!this._evaluate){const F=gr.definitions[this.name];this._evaluate=Array.isArray(F)?F[2]:F.overloads[this._overloadIndex][1]}return this._evaluate(F,this.args)}eachChild(F){this.args.forEach(F)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((F=>F.serialize())))}static parse(F,Me){const Le=F[0],Oe=gr.definitions[Le];if(!Oe)return Me.error(`Unknown expression "${Le}". If you wanted a literal array, use ["literal", [...]].`,0);const Fe=Array.isArray(Oe)?Oe[0]:Oe.type,je=Array.isArray(Oe)?[[Oe[1],Oe[2]]]:Oe.overloads,qe=[];let He=null,xt=-1;for(const[Oe,Pt]of je){if(Array.isArray(Oe)&&Oe.length!==F.length-1)continue;qe.push(Oe),xt++,He=new ap(Me.registry,Me.path,null,Me.scope,void 0,Me._scope,Me.options);const je=[];let jt=!1;for(let Me=1;Me<F.length;Me++){const Le=F[Me],Fe=Array.isArray(Oe)?Oe[Me-1]:Oe.type,qe=He.parse(Le,1+je.length,Fe);if(!qe){jt=!0;break}je.push(qe)}if(!jt)if(Array.isArray(Oe)&&Oe.length!==je.length)He.error(`Expected ${Oe.length} arguments, but found ${je.length} instead.`);else{for(let F=0;F<je.length;F++){const Me=Array.isArray(Oe)?Oe[F]:Oe.type,Le=je[F];He.concat(F+1).checkSubtype(Me,Le.type)}if(0===He.errors.length)return new gr(Le,Fe,Pt,je,xt)}}if(1===qe.length)Me.errors.push(...He.errors);else{const Le=(qe.length?qe:je.map((([F])=>F))).map(xr).join(" | "),Oe=[];for(let Le=1;Le<F.length;Le++){const Fe=Me.parse(F[Le],1+Oe.length);if(!Fe)return null;Oe.push(Ye(Fe.type))}Me.error(`Expected arguments of type ${Le}, but found (${Oe.join(", ")}) instead.`)}return null}static register(F,Me){gr.definitions=Me;for(const Le in Me)F[Le]=gr}}function xr(F){return Array.isArray(F)?`(${F.map(Ye).join(", ")})`:`(${Ye(F.type)}...)`}class vr{constructor(F,Me,Le){this.type=md,this.locale=Le,this.caseSensitive=F,this.diacriticSensitive=Me}static parse(F,Me){if(2!==F.length)return Me.error("Expected one argument.");const Le=F[1];if("object"!=typeof Le||Array.isArray(Le))return Me.error("Collator options argument must be an object.");const Oe=void 0===Le["case-sensitive"]?Me.parse(!1,1,Zu):Me.parseObjectValue(Le["case-sensitive"],1,"case-sensitive",Zu);if(!Oe)return null;const Fe=void 0===Le["diacritic-sensitive"]?Me.parse(!1,1,Zu):Me.parseObjectValue(Le["diacritic-sensitive"],1,"diacritic-sensitive",Zu);if(!Fe)return null;let je=null;return Le.locale&&(je=Me.parseObjectValue(Le.locale,1,"locale",Hu),!je)?null:new vr(Oe,Fe,je)}evaluate(F){return new Ke(this.caseSensitive.evaluate(F),this.diacriticSensitive.evaluate(F),this.locale?this.locale.evaluate(F):null)}eachChild(F){F(this.caseSensitive),F(this.diacriticSensitive),this.locale&&F(this.locale)}outputDefined(){return!1}serialize(){const F={};return F["case-sensitive"]=this.caseSensitive.serialize(),F["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(F.locale=this.locale.serialize()),["collator",F]}}function br(F,Me,Le=0,Oe=F.length-1,Fe=wr){for(;Oe>Le;){if(Oe-Le>600){const je=Oe-Le+1,qe=Me-Le+1,He=Math.log(je),xt=.5*Math.exp(2*He/3),Pt=.5*Math.sqrt(He*xt*(je-xt)/je)*(qe-je/2<0?-1:1);br(F,Me,Math.max(Le,Math.floor(Me-qe*xt/je+Pt)),Math.min(Oe,Math.floor(Me+(je-qe)*xt/je+Pt)),Fe)}const je=F[Me];let qe=Le,He=Oe;for(_r(F,Le,Me),Fe(F[Oe],je)>0&&_r(F,Le,Oe);qe<He;){for(_r(F,qe,He),qe++,He--;Fe(F[qe],je)<0;)qe++;for(;Fe(F[He],je)>0;)He--}0===Fe(F[Le],je)?_r(F,Le,He):(He++,_r(F,He,Oe)),He<=Me&&(Le=He+1),Me<=He&&(Oe=He-1)}}function _r(F,Me,Le){const Oe=F[Me];F[Me]=F[Le],F[Le]=Oe}function wr(F,Me){return F<Me?-1:F>Me?1:0}function Mr(F){let Me=0;for(let Le,Oe,Fe=0,je=F.length,qe=je-1;Fe<je;qe=Fe++)Le=F[Fe],Oe=F[qe],Me+=(Oe.x-Le.x)*(Le.y+Oe.y);return Me}function Ar(F,Me){F[0]=Math.min(F[0],Me[0]),F[1]=Math.min(F[1],Me[1]),F[2]=Math.max(F[2],Me[0]),F[3]=Math.max(F[3],Me[1])}function Ir(F,Me){return!(F[0]<=Me[0]||F[2]>=Me[2]||F[1]<=Me[1]||F[3]>=Me[3])}function Sr(F,Me,Le){const Oe=F[0]-Me[0],Fe=F[1]-Me[1],je=F[0]-Le[0],qe=F[1]-Le[1];return Oe*qe-je*Fe==0&&Oe*je<=0&&Fe*qe<=0}function Pr(F,Me,Le=!1){let Oe=!1;for(let He=0,xt=Me.length;He<xt;He++){const xt=Me[He];for(let Me=0,He=xt.length,Pt=He-1;Me<He;Pt=Me++){const He=xt[Pt],jt=xt[Me];if(Sr(F,He,jt))return Le;(je=He)[1]>(Fe=F)[1]!=(qe=jt)[1]>Fe[1]&&Fe[0]<(qe[0]-je[0])*(Fe[1]-je[1])/(qe[1]-je[1])+je[0]&&(Oe=!Oe)}}var Fe,je,qe;return Oe}function Er(F,Me,Le,Oe){const Fe=Oe[0]-Le[0],je=Oe[1]-Le[1],qe=(F[0]-Le[0])*je-Fe*(F[1]-Le[1]),He=(Me[0]-Le[0])*je-Fe*(Me[1]-Le[1]);return qe>0&&He<0||qe<0&&He>0}function zr(F,Me,Le,Oe){return 0!=(Fe=[Oe[0]-Le[0],Oe[1]-Le[1]])[0]*(je=[Me[0]-F[0],Me[1]-F[1]])[1]-Fe[1]*je[0]&&!(!Er(F,Me,Le,Oe)||!Er(Le,Oe,F,Me));var Fe,je}const $d=8192;function Tr(F,Me){const Le=(180+F[0])/360,Oe=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+F[1]*Math.PI/360)))/360,Fe=Math.pow(2,Me.z);return[Math.round(Le*Fe*$d),Math.round(Oe*Fe*$d)]}function Br(F,Me){for(let Le=0;Le<Me.length;Le++)if(Pr(F,Me[Le]))return!0;return!1}function Vr(F,Me,Le){for(const Oe of Le)for(let Le=0,Fe=Oe.length,je=Fe-1;Le<Fe;je=Le++)if(zr(F,Me,Oe[je],Oe[Le]))return!0;return!1}function Cr(F,Me){for(let Le=0;Le<F.length;++Le)if(!Pr(F[Le],Me))return!1;for(let Le=0;Le<F.length-1;++Le)if(Vr(F[Le],F[Le+1],Me))return!1;return!0}function Dr(F,Me){for(let Le=0;Le<Me.length;Le++)if(Cr(F,Me[Le]))return!0;return!1}function Rr(F,Me,Le){const Oe=[];for(let Fe=0;Fe<F.length;Fe++){const je=[];for(let Oe=0;Oe<F[Fe].length;Oe++){const qe=Tr(F[Fe][Oe],Le);Ar(Me,qe),je.push(qe)}Oe.push(je)}return Oe}function Lr(F,Me,Le){const Oe=[];for(let Fe=0;Fe<F.length;Fe++){const je=Rr(F[Fe],Me,Le);Oe.push(je)}return Oe}function Fr(F,Me,Le,Oe){if(F[0]<Le[0]||F[0]>Le[2]){const Me=.5*Oe;let Fe=F[0]-Le[0]>Me?-Oe:Le[0]-F[0]>Me?Oe:0;0===Fe&&(Fe=F[0]-Le[2]>Me?-Oe:Le[2]-F[0]>Me?Oe:0),F[0]+=Fe}Ar(Me,F)}function Or(F,Me,Le,Oe){const Fe=Math.pow(2,Oe.z)*$d,je=[Oe.x*$d,Oe.y*$d],qe=[];if(!F)return qe;for(const Oe of F)for(const F of Oe){const Oe=[F.x+je[0],F.y+je[1]];Fr(Oe,Me,Le,Fe),qe.push(Oe)}return qe}function Nr(F,Me,Le,Oe){const Fe=Math.pow(2,Oe.z)*$d,je=[Oe.x*$d,Oe.y*$d],qe=[];if(!F)return qe;for(const Le of F){const F=[];for(const Oe of Le){const Le=[Oe.x+je[0],Oe.y+je[1]];Ar(Me,Le),F.push(Le)}qe.push(F)}if(Me[2]-Me[0]<=Fe/2){(He=Me)[0]=He[1]=1/0,He[2]=He[3]=-1/0;for(const F of qe)for(const Oe of F)Fr(Oe,Me,Le,Fe)}var He;return qe}class Ur{constructor(F,Me){this.type=Zu,this.geojson=F,this.geometries=Me}static parse(F,Me){if(2!==F.length)return Me.error(`'within' expression requires exactly one argument, but found ${F.length-1} instead.`);if(nr(F[1])){const Me=F[1];if("FeatureCollection"===Me.type)for(let F=0;F<Me.features.length;++F){const Le=Me.features[F].geometry.type;if("Polygon"===Le||"MultiPolygon"===Le)return new Ur(Me,Me.features[F].geometry)}else if("Feature"===Me.type){const F=Me.geometry.type;if("Polygon"===F||"MultiPolygon"===F)return new Ur(Me,Me.geometry)}else if("Polygon"===Me.type||"MultiPolygon"===Me.type)return new Ur(Me,Me)}return Me.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(F){if(null!=F.geometry()&&null!=F.canonicalID()){if("Point"===F.geometryType())return function(F,Me){const Le=[1/0,1/0,-1/0,-1/0],Oe=[1/0,1/0,-1/0,-1/0],Fe=F.canonicalID();if(!Fe)return!1;if("Polygon"===Me.type){const je=Rr(Me.coordinates,Oe,Fe),qe=Or(F.geometry(),Le,Oe,Fe);if(!Ir(Le,Oe))return!1;for(const F of qe)if(!Pr(F,je))return!1}if("MultiPolygon"===Me.type){const je=Lr(Me.coordinates,Oe,Fe),qe=Or(F.geometry(),Le,Oe,Fe);if(!Ir(Le,Oe))return!1;for(const F of qe)if(!Br(F,je))return!1}return!0}(F,this.geometries);if("LineString"===F.geometryType())return function(F,Me){const Le=[1/0,1/0,-1/0,-1/0],Oe=[1/0,1/0,-1/0,-1/0],Fe=F.canonicalID();if(!Fe)return!1;if("Polygon"===Me.type){const je=Rr(Me.coordinates,Oe,Fe),qe=Nr(F.geometry(),Le,Oe,Fe);if(!Ir(Le,Oe))return!1;for(const F of qe)if(!Cr(F,je))return!1}if("MultiPolygon"===Me.type){const je=Lr(Me.coordinates,Oe,Fe),qe=Nr(F.geometry(),Le,Oe,Fe);if(!Ir(Le,Oe))return!1;for(const F of qe)if(!Dr(F,je))return!1}return!0}(F,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Qd={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},ep=1/298.257223563,ip=ep*(2-ep),rp=Math.PI/180;class Yr{static fromTile(F,Me,Le){const Oe=Math.PI*(1-2*(F+.5)/Math.pow(2,Me)),Fe=Math.atan(.5*(Math.exp(Oe)-Math.exp(-Oe)))/rp;return new Yr(Fe,Le)}static get units(){return Qd}constructor(F,Me){if(void 0===F)throw new Error("No latitude given.");if(Me&&!Qd[Me])throw new Error(`Unknown unit ${Me}. Use one of: ${Object.keys(Qd).join(", ")}`);const Le=6378.137*rp*(Me?Qd[Me]:1),Oe=Math.cos(F*rp),Fe=1/(1-ip*(1-Oe*Oe)),je=Math.sqrt(Fe);this.kx=Le*je*Oe,this.ky=Le*je*Fe*(1-ip)}distance(F,Me){const Le=Zr(F[0]-Me[0])*this.kx,Oe=(F[1]-Me[1])*this.ky;return Math.sqrt(Le*Le+Oe*Oe)}bearing(F,Me){const Le=Zr(Me[0]-F[0])*this.kx;return Math.atan2(Le,(Me[1]-F[1])*this.ky)/rp}destination(F,Me,Le){const Oe=Le*rp;return this.offset(F,Math.sin(Oe)*Me,Math.cos(Oe)*Me)}offset(F,Me,Le){return[F[0]+Me/this.kx,F[1]+Le/this.ky]}lineDistance(F){let Me=0;for(let Le=0;Le<F.length-1;Le++)Me+=this.distance(F[Le],F[Le+1]);return Me}area(F){let Me=0;for(let Le=0;Le<F.length;Le++){const Oe=F[Le];for(let F=0,Fe=Oe.length,je=Fe-1;F<Fe;je=F++)Me+=Zr(Oe[F][0]-Oe[je][0])*(Oe[F][1]+Oe[je][1])*(Le?-1:1)}return Math.abs(Me)/2*this.kx*this.ky}along(F,Me){let Le=0;if(Me<=0)return F[0];for(let Oe=0;Oe<F.length-1;Oe++){const Fe=F[Oe],je=F[Oe+1],qe=this.distance(Fe,je);if(Le+=qe,Le>Me)return Xr(Fe,je,(Me-(Le-qe))/qe)}return F[F.length-1]}pointToSegmentDistance(F,Me,Le){let[Oe,Fe]=Me,je=Zr(Le[0]-Oe)*this.kx,qe=(Le[1]-Fe)*this.ky;if(0!==je||0!==qe){const Me=(Zr(F[0]-Oe)*this.kx*je+(F[1]-Fe)*this.ky*qe)/(je*je+qe*qe);Me>1?(Oe=Le[0],Fe=Le[1]):Me>0&&(Oe+=je/this.kx*Me,Fe+=qe/this.ky*Me)}return je=Zr(F[0]-Oe)*this.kx,qe=(F[1]-Fe)*this.ky,Math.sqrt(je*je+qe*qe)}pointOnLine(F,Me){let Le=1/0,Oe=F[0][0],Fe=F[0][1],je=0,qe=0;for(let He=0;He<F.length-1;He++){let xt=F[He][0],Pt=F[He][1],jt=Zr(F[He+1][0]-xt)*this.kx,Gt=(F[He+1][1]-Pt)*this.ky,bi=0;0===jt&&0===Gt||(bi=(Zr(Me[0]-xt)*this.kx*jt+(Me[1]-Pt)*this.ky*Gt)/(jt*jt+Gt*Gt),bi>1?(xt=F[He+1][0],Pt=F[He+1][1]):bi>0&&(xt+=jt/this.kx*bi,Pt+=Gt/this.ky*bi)),jt=Zr(Me[0]-xt)*this.kx,Gt=(Me[1]-Pt)*this.ky;const wi=jt*jt+Gt*Gt;wi<Le&&(Le=wi,Oe=xt,Fe=Pt,je=He,qe=bi)}return{point:[Oe,Fe],index:je,t:Math.max(0,Math.min(1,qe))}}lineSlice(F,Me,Le){let Oe=this.pointOnLine(Le,F),Fe=this.pointOnLine(Le,Me);if(Oe.index>Fe.index||Oe.index===Fe.index&&Oe.t>Fe.t){const F=Oe;Oe=Fe,Fe=F}const je=[Oe.point],qe=Oe.index+1,He=Fe.index;!Hr(Le[qe],je[0])&&qe<=He&&je.push(Le[qe]);for(let F=qe+1;F<=He;F++)je.push(Le[F]);return Hr(Le[He],Fe.point)||je.push(Fe.point),je}lineSliceAlong(F,Me,Le){let Oe=0;const Fe=[];for(let je=0;je<Le.length-1;je++){const qe=Le[je],He=Le[je+1],xt=this.distance(qe,He);if(Oe+=xt,Oe>F&&0===Fe.length&&Fe.push(Xr(qe,He,(F-(Oe-xt))/xt)),Oe>=Me)return Fe.push(Xr(qe,He,(Me-(Oe-xt))/xt)),Fe;Oe>F&&Fe.push(He)}return Fe}bufferPoint(F,Me){const Le=Me/this.ky,Oe=Me/this.kx;return[F[0]-Oe,F[1]-Le,F[0]+Oe,F[1]+Le]}bufferBBox(F,Me){const Le=Me/this.ky,Oe=Me/this.kx;return[F[0]-Oe,F[1]-Le,F[2]+Oe,F[3]+Le]}insideBBox(F,Me){return Zr(F[0]-Me[0])>=0&&Zr(F[0]-Me[2])<=0&&F[1]>=Me[1]&&F[1]<=Me[3]}}function Hr(F,Me){return F[0]===Me[0]&&F[1]===Me[1]}function Xr(F,Me,Le){const Oe=Zr(Me[0]-F[0]);return[F[0]+Oe*Le,F[1]+(Me[1]-F[1])*Le]}function Zr(F){for(;F<-180;)F+=360;for(;F>180;)F-=360;return F}class Wr{constructor(F=[],Me=(F,Me)=>F<Me?-1:F>Me?1:0){if(this.data=F,this.length=this.data.length,this.compare=Me,this.length>0)for(let F=(this.length>>1)-1;F>=0;F--)this._down(F)}push(F){this.data.push(F),this._up(this.length++)}pop(){if(0===this.length)return;const F=this.data[0],Me=this.data.pop();return--this.length>0&&(this.data[0]=Me,this._down(0)),F}peek(){return this.data[0]}_up(F){const{data:Me,compare:Le}=this,Oe=Me[F];for(;F>0;){const Fe=F-1>>1,je=Me[Fe];if(Le(Oe,je)>=0)break;Me[F]=je,F=Fe}Me[F]=Oe}_down(F){const{data:Me,compare:Le}=this,Oe=this.length>>1,Fe=Me[F];for(;F<Oe;){let Oe=1+(F<<1);const je=Oe+1;if(je<this.length&&Le(Me[je],Me[Oe])<0&&(Oe=je),Le(Me[Oe],Fe)>=0)break;Me[F]=Me[Oe],F=Oe}Me[F]=Fe}}var np=8192;function Jr(F,Me){return Me.dist-F.dist}const op=100,sp=50;function en(F){const Me=[1/0,1/0,-1/0,-1/0];if(Me.length!==F.length)return!1;for(let Le=0;Le<Me.length;Le++)if(Me[Le]!==F[Le])return!1;return!0}function rn(F){return F[1]-F[0]+1}function nn(F,Me){const Le=F[1]>=F[0]&&F[1]<Me;return Le||console.warn("Distance Expression: Index is out of range"),Le}function sn(F,Me){if(F[0]>F[1])return[null,null];const Le=rn(F);if(Me){if(2===Le)return[F,null];const Me=Math.floor(Le/2);return[[F[0],F[0]+Me],[F[0]+Me,F[1]]]}{if(1===Le)return[F,null];const Me=Math.floor(Le/2)-1;return[[F[0],F[0]+Me],[F[0]+Me+1,F[1]]]}}function an(F,Me){const Le=[1/0,1/0,-1/0,-1/0];if(!nn(Me,F.length))return Le;for(let Oe=Me[0];Oe<=Me[1];++Oe)Ar(Le,F[Oe]);return Le}function on(F){const Me=[1/0,1/0,-1/0,-1/0];for(let Le=0;Le<F.length;++Le)for(let Oe=0;Oe<F[Le].length;++Oe)Ar(Me,F[Le][Oe]);return Me}function ln(F,Me,Le){if(en(F)||en(Me))return NaN;let Oe=0,Fe=0;return F[2]<Me[0]&&(Oe=Me[0]-F[2]),F[0]>Me[2]&&(Oe=F[0]-Me[2]),F[1]>Me[3]&&(Fe=F[1]-Me[3]),F[3]<Me[1]&&(Fe=Me[1]-F[3]),Le.distance([0,0],[Oe,Fe])}function un(F){return 360*F-180}function cn(F){return 360/Math.PI*Math.atan(Math.exp((180-360*F)*Math.PI/180))-90}function hn(F,Me){const Le=Math.pow(2,Me.z),Oe=(F.y/np+Me.y)/Le;return[un((F.x/np+Me.x)/Le),cn(Oe)]}function pn(F,Me){const Le=[];for(let Oe=0;Oe<F.length;++Oe)Le.push(hn(F[Oe],Me));return Le}function fn(F,Me,Le){const Oe=Le.pointOnLine(Me,F).point;return Le.distance(F,Oe)}function dn(F,Me,Le,Oe,Fe){const je=Le.slice(Oe[0],Oe[1]+1);let qe=1/0;for(let Le=Me[0];Le<=Me[1];++Le)if(0===(qe=Math.min(qe,fn(F[Le],je,Fe))))return 0;return qe}function mn(F,Me,Le,Oe,Fe){const je=Math.min(Fe.pointToSegmentDistance(F,Le,Oe),Fe.pointToSegmentDistance(Me,Le,Oe)),qe=Math.min(Fe.pointToSegmentDistance(Le,F,Me),Fe.pointToSegmentDistance(Oe,F,Me));return Math.min(je,qe)}function yn(F,Me,Le,Oe,Fe){if(!nn(Me,F.length)||!nn(Oe,Le.length))return NaN;let je=1/0;for(let qe=Me[0];qe<Me[1];++qe)for(let Me=Oe[0];Me<Oe[1];++Me){if(zr(F[qe],F[qe+1],Le[Me],Le[Me+1]))return 0;je=Math.min(je,mn(F[qe],F[qe+1],Le[Me],Le[Me+1],Fe))}return je}function gn(F,Me,Le,Oe,Fe){if(!nn(Me,F.length)||!nn(Oe,Le.length))return NaN;let je=1/0;for(let qe=Me[0];qe<=Me[1];++qe)for(let Me=Oe[0];Me<=Oe[1];++Me)if(0===(je=Math.min(je,Fe.distance(F[qe],Le[Me]))))return je;return je}function xn(F,Me,Le){if(Pr(F,Me,!0))return 0;let Oe=1/0;for(const Fe of Me){const Me=Fe.length;if(Me<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(Fe[0]!==Fe[Me-1]&&0===(Oe=Math.min(Oe,Le.pointToSegmentDistance(F,Fe[Me-1],Fe[0]))))return Oe;if(0===(Oe=Math.min(Oe,fn(F,Fe,Le))))return Oe}return Oe}function vn(F,Me,Le,Oe){if(!nn(Me,F.length))return NaN;for(let Oe=Me[0];Oe<=Me[1];++Oe)if(Pr(F[Oe],Le,!0))return 0;let Fe=1/0;for(let je=Me[0];je<Me[1];++je)for(const Me of Le)for(let Le=0,qe=Me.length,He=qe-1;Le<qe;He=Le++){if(zr(F[je],F[je+1],Me[He],Me[Le]))return 0;Fe=Math.min(Fe,mn(F[je],F[je+1],Me[He],Me[Le],Oe))}return Fe}function bn(F,Me){for(const Le of F)for(let F=0;F<=Le.length-1;++F)if(Pr(Le[F],Me,!0))return!0;return!1}function _n(F,Me,Le,Oe=1/0){const Fe=on(F),je=on(Me);if(Oe!==1/0&&ln(Fe,je,Le)>=Oe)return Oe;if(Ir(Fe,je)){if(bn(F,Me))return 0}else if(bn(Me,F))return 0;let qe=Oe;for(const Oe of F)for(let F=0,Fe=Oe.length,je=Fe-1;F<Fe;je=F++)for(const Fe of Me)for(let Me=0,He=Fe.length,xt=He-1;Me<He;xt=Me++){if(zr(Oe[je],Oe[F],Fe[xt],Fe[Me]))return 0;qe=Math.min(qe,mn(Oe[je],Oe[F],Fe[xt],Fe[Me],Le))}return qe}function wn(F,Me,Le,Oe,Fe,je,qe){if(null===je||null===qe)return;const He=ln(an(Oe,je),an(Fe,qe),Le);He<Me&&F.push({dist:He,range1:je,range2:qe})}function Mn(F,Me,Le,Oe,Fe=1/0){let je=Math.min(Oe.distance(F[0],Le[0][0]),Fe);if(0===je)return je;const qe=new Wr([{dist:0,range1:[0,F.length-1],range2:[0,0]}],Jr),He=Me?sp:op,xt=on(Le);for(;qe.length;){const Fe=qe.pop();if(Fe.dist>=je)continue;const Pt=Fe.range1;if(rn(Pt)<=He){if(!nn(Pt,F.length))return NaN;if(Me){const Me=vn(F,Pt,Le,Oe);if(0===(je=Math.min(je,Me)))return je}else for(let Me=Pt[0];Me<=Pt[1];++Me){const Fe=xn(F[Me],Le,Oe);if(0===(je=Math.min(je,Fe)))return je}}else{const Le=sn(Pt,Me);if(null!==Le[0]){const Me=ln(an(F,Le[0]),xt,Oe);Me<je&&qe.push({dist:Me,range1:Le[0],range2:[0,0]})}if(null!==Le[1]){const Me=ln(an(F,Le[1]),xt,Oe);Me<je&&qe.push({dist:Me,range1:Le[1],range2:[0,0]})}}}return je}function An(F,Me,Le,Oe,Fe,je=1/0){let qe=Math.min(je,Fe.distance(F[0],Le[0]));if(0===qe)return qe;const He=new Wr([{dist:0,range1:[0,F.length-1],range2:[0,Le.length-1]}],Jr),xt=Me?sp:op,Pt=Oe?sp:op;for(;He.length;){const je=He.pop();if(je.dist>=qe)continue;const jt=je.range1,Gt=je.range2;if(rn(jt)<=xt&&rn(Gt)<=Pt){if(!nn(jt,F.length)||!nn(Gt,Le.length))return NaN;if(Me&&Oe?qe=Math.min(qe,yn(F,jt,Le,Gt,Fe)):Me||Oe?Me&&!Oe?qe=Math.min(qe,dn(Le,Gt,F,jt,Fe)):!Me&&Oe&&(qe=Math.min(qe,dn(F,jt,Le,Gt,Fe))):qe=Math.min(qe,gn(F,jt,Le,Gt,Fe)),0===qe)return qe}else{const je=sn(jt,Me),xt=sn(Gt,Oe);wn(He,qe,Fe,F,Le,je[0],xt[0]),wn(He,qe,Fe,F,Le,je[0],xt[1]),wn(He,qe,Fe,F,Le,je[1],xt[0]),wn(He,qe,Fe,F,Le,je[1],xt[1])}}return qe}function In(F,Me,Le,Oe,Fe=1/0){let je=Fe;const qe=an(F,[0,F.length-1]);for(const Fe of Le)if(!(je!==1/0&&ln(qe,an(Fe,[0,Fe.length-1]),Oe)>=je)&&(je=Math.min(je,An(F,Me,Fe,!0,Oe,je)),0===je))return je;return je}function Sn(F,Me,Le,Oe,Fe=1/0){let je=Fe;const qe=an(F,[0,F.length-1]);for(const Fe of Le){if(je!==1/0&&ln(qe,on(Fe),Oe)>=je)continue;const Le=Mn(F,Me,Fe,Oe,je);if(isNaN(Le))return Le;if(0===(je=Math.min(je,Le)))return je}return je}function Pn(F){return"Point"===F||"MultiPoint"===F||"LineString"===F||"MultiLineString"===F||"Polygon"===F||"MultiPolygon"===F}class En{constructor(F,Me){this.type=Fu,this.geojson=F,this.geometries=Me}static parse(F,Me){if(2!==F.length)return Me.error(`'distance' expression requires either one argument, but found ' ${F.length-1} instead.`);if(nr(F[1])){const Me=F[1];if("FeatureCollection"===Me.type){for(let F=0;F<Me.features.length;++F)if(Pn(Me.features[F].geometry.type))return new En(Me,Me.features[F].geometry)}else if("Feature"===Me.type){if(Pn(Me.geometry.type))return new En(Me,Me.geometry)}else if(Pn(Me.type))return new En(Me,Me)}return Me.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(F){const Me=F.geometry(),Le=F.canonicalID();if(null!=Me&&null!=Le){if("Point"===F.geometryType())return function(F,Me,Le){const Oe=[];for(const Le of F)for(const F of Le)Oe.push(hn(F,Me));const Fe=new Yr(Oe[0][1],"meters");return"Point"===Le.type||"MultiPoint"===Le.type||"LineString"===Le.type?An(Oe,!1,"Point"===Le.type?[Le.coordinates]:Le.coordinates,"LineString"===Le.type,Fe):"MultiLineString"===Le.type?In(Oe,!1,Le.coordinates,Fe):"Polygon"===Le.type||"MultiPolygon"===Le.type?Sn(Oe,!1,"Polygon"===Le.type?[Le.coordinates]:Le.coordinates,Fe):null}(Me,Le,this.geometries);if("LineString"===F.geometryType())return function(F,Me,Le){const Oe=[];for(const Le of F){const F=[];for(const Oe of Le)F.push(hn(Oe,Me));Oe.push(F)}const Fe=new Yr(Oe[0][0][1],"meters");if("Point"===Le.type||"MultiPoint"===Le.type||"LineString"===Le.type)return In("Point"===Le.type?[Le.coordinates]:Le.coordinates,"LineString"===Le.type,Oe,Fe);if("MultiLineString"===Le.type){let F=1/0;for(let Me=0;Me<Le.coordinates.length;Me++){const je=In(Le.coordinates[Me],!0,Oe,Fe,F);if(isNaN(je))return je;if(0===(F=Math.min(F,je)))return F}return F}if("Polygon"===Le.type||"MultiPolygon"===Le.type){let F=1/0;for(let Me=0;Me<Oe.length;Me++){const je=Sn(Oe[Me],!0,"Polygon"===Le.type?[Le.coordinates]:Le.coordinates,Fe,F);if(isNaN(je))return je;if(0===(F=Math.min(F,je)))return F}return F}return null}(Me,Le,this.geometries);if("Polygon"===F.geometryType())return function(F,Me,Le){const Oe=[];for(const Le of function(F){const Me=F.length;if(Me<=1)return[F];const Le=[];let Oe,Fe;for(let je=0;je<Me;je++){const Me=Mr(F[je]);0!==Me&&(F[je].area=Math.abs(Me),void 0===Fe&&(Fe=Me<0),Fe===Me<0?(Oe&&Le.push(Oe),Oe=[F[je]]):Oe.push(F[je]))}return Oe&&Le.push(Oe),Le}(F)){const F=[];for(let Oe=0;Oe<Le.length;++Oe)F.push(pn(Le[Oe],Me));Oe.push(F)}const Fe=new Yr(Oe[0][0][0][1],"meters");if("Point"===Le.type||"MultiPoint"===Le.type||"LineString"===Le.type)return Sn("Point"===Le.type?[Le.coordinates]:Le.coordinates,"LineString"===Le.type,Oe,Fe);if("MultiLineString"===Le.type){let F=1/0;for(let Me=0;Me<Le.coordinates.length;Me++){const je=Sn(Le.coordinates[Me],!0,Oe,Fe,F);if(isNaN(je))return je;if(0===(F=Math.min(F,je)))return F}return F}return"Polygon"===Le.type||"MultiPolygon"===Le.type?function(F,Me,Le){let Oe=1/0;for(const Fe of F)for(const F of Me){const Me=_n(Fe,F,Le,Oe);if(isNaN(Me))return Me;if(0===(Oe=Math.min(Oe,Me)))return Oe}return Oe}("Polygon"===Le.type?[Le.coordinates]:Le.coordinates,Oe,Fe):null}(Me,Le,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function zn(F,Me){switch(F){case"string":return sr(Me);case"number":return+Me;case"boolean":return!!Me;case"color":return Se.parse(Me);case"formatted":return Qe.fromString(sr(Me));case"resolvedImage":return er.build(sr(Me))}return Me}function kn(F,Me,Le,Oe){return void 0!==Oe&&(F=Oe*Math.round(F/Oe)),void 0!==Me&&F<Me&&(F=Me),void 0!==Le&&F>Le&&(F=Le),F}class Tn{constructor(F,Me,Le){this.type=F,this.key=Me,this.scope=Le}static parse(F,Me){let Le=Me.expectedType;if(null==Le&&(Le=hd),F.length<2||F.length>3)return Me.error("Invalid number of arguments for 'config' expression.");const Oe=Me.parse(F[1],1);if(!(Oe instanceof ar))return Me.error("Key name of 'config' expression must be a string literal.");if(F.length>=3){const Fe=Me.parse(F[2],2);return Fe instanceof ar?new Tn(Le,sr(Oe.value),sr(Fe.value)):Me.error("Scope of 'config' expression must be a string literal.")}return new Tn(Le,sr(Oe.value))}evaluate(F){const Me=[this.key,this.scope,F.scope].filter(Boolean).join(""),Le=F.getConfig(Me);if(!Le)return null;const{type:Oe,value:Fe,values:je,minValue:qe,maxValue:He,stepValue:xt}=Le,Pt=Le.default.evaluate(F);let jt=Pt;if(Fe){const Me=F.scope;F.scope=(Me||"").split("").slice(1).join(""),jt=Fe.evaluate(F),F.scope=Me}return Oe&&(jt=zn(Oe,jt)),void 0===jt||void 0===qe&&void 0===He&&void 0===xt||("number"==typeof jt?jt=kn(jt,qe,He,xt):Array.isArray(jt)&&(jt=jt.map((F=>"number"==typeof F?kn(F,qe,He,xt):F)))),void 0!==Fe&&void 0!==jt&&je&&!je.includes(jt)&&(jt=Pt,Oe&&(jt=zn(Oe,jt))),(Oe&&Oe!==this.type||void 0!==jt&&ir(jt)!==this.type)&&(jt=zn(this.type.kind,jt)),jt}eachChild(){}outputDefined(){return!1}serialize(){const F=["config",this.key];return this.scope&&F.concat(this.key),F}}function Bn(F){if(F instanceof gr){if("get"===F.name&&1===F.args.length)return!1;if("feature-state"===F.name)return!1;if("has"===F.name&&1===F.args.length)return!1;if("properties"===F.name||"geometry-type"===F.name||"id"===F.name)return!1;if(/^filter-/.test(F.name))return!1}if(F instanceof Ur)return!1;if(F instanceof En)return!1;let Me=!0;return F.eachChild((F=>{Me&&!Bn(F)&&(Me=!1)})),Me}function Vn(F){if(F instanceof gr&&"feature-state"===F.name)return!1;let Me=!0;return F.eachChild((F=>{Me&&!Vn(F)&&(Me=!1)})),Me}function Cn(F){if(F instanceof Tn)return new Set([F.key]);let Me=new Set;return F.eachChild((F=>{Me=new Set([...Me,...Cn(F)])})),Me}function Dn(F,Me){if(F instanceof gr&&Me.indexOf(F.name)>=0)return!1;let Le=!0;return F.eachChild((F=>{Le&&!Dn(F,Me)&&(Le=!1)})),Le}class Rn{constructor(F,Me){this.type=Me.type,this.name=F,this.boundExpression=Me}static parse(F,Me){if(2!==F.length||"string"!=typeof F[1])return Me.error("'var' expression requires exactly one string literal argument.");const Le=F[1];return Me.scope.has(Le)?new Rn(Le,Me.scope.get(Le)):Me.error(`Unknown variable "${Le}". Make sure "${Le}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(F){return this.boundExpression.evaluate(F)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ln{constructor(F,Me=[],Le,Oe=new Ce,Fe=[],je,qe){this.registry=F,this.path=Me,this.key=Me.map((F=>"string"==typeof F?`['${F}']`:`[${F}]`)).join(""),this.scope=Oe,this.errors=Fe,this.expectedType=Le,this._scope=je,this.options=qe}parse(F,Me,Le,Oe,Fe={}){return Me||Le?this.concat(Me,null,Le,Oe)._parse(F,Fe):this._parse(F,Fe)}parseObjectValue(F,Me,Le,Oe,Fe,je={}){return this.concat(Me,Le,Oe,Fe)._parse(F,je)}_parse(F,Me){function r(F,Me,Le){return"assert"===Le?new ur(Me,[F]):"coerce"===Le?new dr(Me,[F]):F}if(null!==F&&"string"!=typeof F&&"boolean"!=typeof F&&"number"!=typeof F||(F=["literal",F]),Array.isArray(F)){if(0===F.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const Le="string"==typeof F[0]?this.registry[F[0]]:void 0;if(Le){let Oe=Le.parse(F,this);if(!Oe)return null;if(this.expectedType){const F=this.expectedType,Le=Oe.type;if("string"!==F.kind&&"number"!==F.kind&&"boolean"!==F.kind&&"object"!==F.kind&&"array"!==F.kind||"value"!==Le.kind)if("color"!==F.kind&&"formatted"!==F.kind&&"resolvedImage"!==F.kind||"value"!==Le.kind&&"string"!==Le.kind){if(this.checkSubtype(F,Le))return null}else Oe=r(Oe,F,Me.typeAnnotation||"coerce");else Oe=r(Oe,F,Me.typeAnnotation||"assert")}if(!(Oe instanceof ar)&&"resolvedImage"!==Oe.type.kind&&On(Oe)){const Me=new yr(this._scope,this.options);try{Oe=new ar(Oe.type,Oe.evaluate(Me))}catch(F){return this.error(F.message),null}}return Oe}return dr.parse(["to-array",F],this)}return this.error(void 0===F?"'undefined' value invalid. Use null instead.":"object"==typeof F?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof F} instead.`)}concat(F,Me,Le,Oe){let Fe="number"==typeof F?this.path.concat(F):this.path;Fe="string"==typeof Me?Fe.concat(Me):Fe;const je=Oe?this.scope.concat(Oe):this.scope;return new Ln(this.registry,Fe,Le||null,je,this.errors,this._scope,this.options)}error(F,...Me){const Le=`${this.key}${Me.map((F=>`[${F}]`)).join("")}`;this.errors.push(new Ve(Le,F))}checkSubtype(F,Me){const Le=Xe(F,Me);return Le&&this.error(Le),Le}}var ap=Ln;function On(F){if(F instanceof Rn)return On(F.boundExpression);if(F instanceof gr&&"error"===F.name)return!1;if(F instanceof vr)return!1;if(F instanceof Ur)return!1;if(F instanceof En)return!1;if(F instanceof Tn)return!1;const Me=F instanceof dr||F instanceof ur;let Le=!0;return F.eachChild((F=>{Le=Me?Le&&On(F):Le&&F instanceof ar})),!!Le&&Bn(F)&&Dn(F,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Nn(F,Me){const Le=F.length-1;let Oe,Fe,je=0,qe=Le,He=0;for(;je<=qe;)if(He=Math.floor((je+qe)/2),Oe=F[He],Fe=F[He+1],Oe<=Me){if(He===Le||Me<Fe)return He;je=He+1}else{if(!(Oe>Me))throw new or("Input is not a number.");qe=He-1}return 0}class Un{constructor(F,Me,Le){this.type=F,this.input=Me,this.labels=[],this.outputs=[];for(const[F,Me]of Le)this.labels.push(F),this.outputs.push(Me)}static parse(F,Me){if(F.length-1<4)return Me.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if((F.length-1)%2!=0)return Me.error("Expected an even number of arguments.");const Le=Me.parse(F[1],1,Fu);if(!Le)return null;const Oe=[];let Fe=null;Me.expectedType&&"value"!==Me.expectedType.kind&&(Fe=Me.expectedType);for(let Le=1;Le<F.length;Le+=2){const je=1===Le?-1/0:F[Le],qe=F[Le+1],He=Le,xt=Le+1;if("number"!=typeof je)return Me.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',He);if(Oe.length&&Oe[Oe.length-1][0]>=je)return Me.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',He);const Pt=Me.parse(qe,xt,Fe);if(!Pt)return null;Fe=Fe||Pt.type,Oe.push([je,Pt])}return new Un(Fe,Le,Oe)}evaluate(F){const Me=this.labels,Le=this.outputs;if(1===Me.length)return Le[0].evaluate(F);const Oe=this.input.evaluate(F);if(Oe<=Me[0])return Le[0].evaluate(F);const Fe=Me.length;return Oe>=Me[Fe-1]?Le[Fe-1].evaluate(F):Le[Nn(Me,Oe)].evaluate(F)}eachChild(F){F(this.input);for(const Me of this.outputs)F(Me)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))}serialize(){const F=["step",this.input.serialize()];for(let Me=0;Me<this.labels.length;Me++)Me>0&&F.push(this.labels[Me]),F.push(this.outputs[Me].serialize());return F}}const yp=.95047,Tp=1.08883,Rp=4/29,Dp=6/29,Lp=3*Dp*Dp,Op=Dp*Dp*Dp,kp=Math.PI/180,Fp=180/Math.PI;function Wn(F){return F>Op?Math.pow(F,1/3):F/Lp+Rp}function Kn(F){return F>Dp?F*F*F:Lp*(F-Rp)}function Jn(F){return 255*(F<=.0031308?12.92*F:1.055*Math.pow(F,1/2.4)-.055)}function Qn(F){return(F/=255)<=.04045?F/12.92:Math.pow((F+.055)/1.055,2.4)}function ti(F){const Me=Qn(F.r),Le=Qn(F.g),Oe=Qn(F.b),Fe=Wn((.4124564*Me+.3575761*Le+.1804375*Oe)/yp),je=Wn((.2126729*Me+.7151522*Le+.072175*Oe)/1);return{l:116*je-16,a:500*(Fe-je),b:200*(je-Wn((.0193339*Me+.119192*Le+.9503041*Oe)/Tp)),alpha:F.a}}function ei(F){let Me=(F.l+16)/116,Le=isNaN(F.a)?Me:Me+F.a/500,Oe=isNaN(F.b)?Me:Me-F.b/200;return Me=1*Kn(Me),Le=yp*Kn(Le),Oe=Tp*Kn(Oe),new Se(Jn(3.2404542*Le-1.5371385*Me-.4985314*Oe),Jn(-.969266*Le+1.8760108*Me+.041556*Oe),Jn(.0556434*Le-.2040259*Me+1.0572252*Oe),F.alpha)}function ri(F,Me,Le){const Oe=Me-F;return F+Le*(Oe>180||Oe<-180?Oe-360*Math.round(Oe/360):Oe)}const Np={forward:ti,reverse:ei,interpolate:function(F,Me,Le){return{l:Ee(F.l,Me.l,Le),a:Ee(F.a,Me.a,Le),b:Ee(F.b,Me.b,Le),alpha:Ee(F.alpha,Me.alpha,Le)}}},Up={forward:function(F){const{l:Me,a:Le,b:Oe}=ti(F),Fe=Math.atan2(Oe,Le)*Fp;return{h:Fe<0?Fe+360:Fe,c:Math.sqrt(Le*Le+Oe*Oe),l:Me,alpha:F.a}},reverse:function(F){const Me=F.h*kp,Le=F.c;return ei({l:F.l,a:Math.cos(Me)*Le,b:Math.sin(Me)*Le,alpha:F.alpha})},interpolate:function(F,Me,Le){return{h:ri(F.h,Me.h,Le),c:Ee(F.c,Me.c,Le),l:Ee(F.l,Me.l,Le),alpha:Ee(F.alpha,Me.alpha,Le)}}};var Gp=Object.freeze({__proto__:null,hcl:Up,lab:Np});class ai{constructor(F,Me,Le,Oe,Fe){this.type=F,this.operator=Me,this.interpolation=Le,this.input=Oe,this.labels=[],this.outputs=[];for(const[F,Me]of Fe)this.labels.push(F),this.outputs.push(Me)}static interpolationFactor(F,Me,Le,Oe){let Fe=0;if("exponential"===F.name)Fe=oi(Me,F.base,Le,Oe);else if("linear"===F.name)Fe=oi(Me,1,Le,Oe);else if("cubic-bezier"===F.name){const je=F.controlPoints;Fe=new kl(je[0],je[1],je[2],je[3]).solve(oi(Me,1,Le,Oe))}return Fe}static parse(F,Me){let[Le,Oe,Fe,...je]=F;if(!Array.isArray(Oe)||0===Oe.length)return Me.error("Expected an interpolation type expression.",1);if("linear"===Oe[0])Oe={name:"linear"};else if("exponential"===Oe[0]){const F=Oe[1];if("number"!=typeof F)return Me.error("Exponential interpolation requires a numeric base.",1,1);Oe={name:"exponential",base:F}}else{if("cubic-bezier"!==Oe[0])return Me.error(`Unknown interpolation type ${String(Oe[0])}`,1,0);{const F=Oe.slice(1);if(4!==F.length||F.some((F=>"number"!=typeof F||F<0||F>1)))return Me.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);Oe={name:"cubic-bezier",controlPoints:F}}}if(F.length-1<4)return Me.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if(F.length-1>3&&(F.length-1)%2!=0)return Me.error("Expected an even number of arguments.");if(Fe=Me.parse(Fe,2,Fu),!Fe)return null;const qe=[];let He=null;"interpolate-hcl"===Le||"interpolate-lab"===Le?He=Wu:Me.expectedType&&"value"!==Me.expectedType.kind&&(He=Me.expectedType);for(let F=0;F<je.length;F+=2){const Le=je[F],Oe=je[F+1],Fe=F+3,xt=F+4;if("number"!=typeof Le)return Me.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',Fe);if(qe.length&&qe[qe.length-1][0]>=Le)return Me.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',Fe);const Pt=Me.parse(Oe,xt,He);if(!Pt)return null;He=He||Pt.type,qe.push([Le,Pt])}return"number"===He.kind||"color"===He.kind||"array"===He.kind&&"number"===He.itemType.kind&&"number"==typeof He.N?new ai(He,Le,Oe,Fe,qe):Me.error(`Type ${Ye(He)} is not interpolatable.`)}evaluate(F){const Me=this.labels,Le=this.outputs;if(1===Me.length)return Le[0].evaluate(F);const Oe=this.input.evaluate(F);if(Oe<=Me[0])return Le[0].evaluate(F);const Fe=Me.length;if(Oe>=Me[Fe-1])return Le[Fe-1].evaluate(F);const je=Nn(Me,Oe),qe=ai.interpolationFactor(this.interpolation,Oe,Me[je],Me[je+1]),He=Le[je].evaluate(F),xt=Le[je+1].evaluate(F);return"interpolate"===this.operator?mu[this.type.kind.toLowerCase()](He,xt,qe):"interpolate-hcl"===this.operator?Up.reverse(Up.interpolate(Up.forward(He),Up.forward(xt),qe)):Np.reverse(Np.interpolate(Np.forward(He),Np.forward(xt),qe))}eachChild(F){F(this.input);for(const Me of this.outputs)F(Me)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))}serialize(){let F;F="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const Me=[this.operator,F,this.input.serialize()];for(let F=0;F<this.labels.length;F++)Me.push(this.labels[F],this.outputs[F].serialize());return Me}}function oi(F,Me,Le,Oe){const Fe=Oe-Le,je=F-Le;return 0===Fe?0:1===Me?je/Fe:(Math.pow(Me,je)-1)/(Math.pow(Me,Fe)-1)}class li{constructor(F,Me){this.type=F,this.args=Me}static parse(F,Me){if(F.length<2)return Me.error("Expectected at least one argument.");let Le=null;const Oe=Me.expectedType;Oe&&"value"!==Oe.kind&&(Le=Oe);const Fe=[];for(const Oe of F.slice(1)){const F=Me.parse(Oe,1+Fe.length,Le,void 0,{typeAnnotation:"omit"});if(!F)return null;Le=Le||F.type,Fe.push(F)}const je=Oe&&Fe.some((F=>Xe(Oe,F.type)));return new li(je?hd:Le,Fe)}evaluate(F){let Me,Le=null,Oe=0;for(const Fe of this.args){if(Oe++,Le=Fe.evaluate(F),Le&&Le instanceof er&&!Le.available&&(Me||(Me=Le),Le=null,Oe===this.args.length))return Me;if(null!==Le)break}return Le}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){const F=["coalesce"];return this.eachChild((Me=>{F.push(Me.serialize())})),F}}class ui{constructor(F,Me){this.type=Me.type,this.bindings=[].concat(F),this.result=Me}evaluate(F){return this.result.evaluate(F)}eachChild(F){for(const Me of this.bindings)F(Me[1]);F(this.result)}static parse(F,Me){if(F.length<4)return Me.error(`Expected at least 3 arguments, but found ${F.length-1} instead.`);const Le=[];for(let Oe=1;Oe<F.length-1;Oe+=2){const Fe=F[Oe];if("string"!=typeof Fe)return Me.error(`Expected string, but found ${typeof Fe} instead.`,Oe);if(/[^a-zA-Z0-9_]/.test(Fe))return Me.error("Variable names must contain only alphanumeric characters or '_'.",Oe);const je=Me.parse(F[Oe+1],Oe+1);if(!je)return null;Le.push([Fe,je])}const Oe=Me.parse(F[F.length-1],F.length-1,Me.expectedType,Le);return Oe?new ui(Le,Oe):null}outputDefined(){return this.result.outputDefined()}serialize(){const F=["let"];for(const[Me,Le]of this.bindings)F.push(Me,Le.serialize());return F.push(this.result.serialize()),F}}class ci{constructor(F,Me,Le){this.type=F,this.index=Me,this.input=Le}static parse(F,Me){if(3!==F.length)return Me.error(`Expected 2 arguments, but found ${F.length-1} instead.`);const Le=Me.parse(F[1],1,Fu),Oe=Me.parse(F[2],2,Ge(Me.expectedType||hd));return Le&&Oe?new ci(Oe.type.itemType,Le,Oe):null}evaluate(F){const Me=this.index.evaluate(F),Le=this.input.evaluate(F);if(Me<0)throw new or(`Array index out of bounds: ${Me} < 0.`);if(Me>=Le.length)throw new or(`Array index out of bounds: ${Me} > ${Le.length-1}.`);if(Me!==Math.floor(Me))throw new or(`Array index must be an integer, but found ${Me} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return Le[Me]}eachChild(F){F(this.index),F(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class hi{constructor(F,Me,Le){this.type=F,this.index=Me,this.input=Le}static parse(F,Me){if(3!==F.length)return Me.error(`Expected 2 arguments, but found ${F.length-1} instead.`);const Le=Me.parse(F[1],1,Fu),Oe=Me.parse(F[2],2,Ge(Me.expectedType||hd));return Le&&Oe?new hi(Oe.type.itemType,Le,Oe):null}evaluate(F){const Me=this.index.evaluate(F),Le=this.input.evaluate(F);if(Me<0)throw new or(`Array index out of bounds: ${Me} < 0.`);if(Me>Le.length-1)throw new or(`Array index out of bounds: ${Me} > ${Le.length-1}.`);if(Me===Math.floor(Me))return Le[Me];const Oe=Math.floor(Me),Fe=Math.ceil(Me),je=Le[Oe],qe=Le[Fe];if("number"!=typeof je||"number"!=typeof qe)throw new or(`Cannot interpolate between non-number values at index ${Me}.`);const He=Me-Oe;return je*(1-He)+qe*He}eachChild(F){F(this.index),F(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class pi{constructor(F,Me){this.type=Zu,this.needle=F,this.haystack=Me}static parse(F,Me){if(3!==F.length)return Me.error(`Expected 2 arguments, but found ${F.length-1} instead.`);const Le=Me.parse(F[1],1,hd),Oe=Me.parse(F[2],2,hd);return Le&&Oe?Ze(Le.type,[Zu,Hu,Fu,Su,hd])?new pi(Le,Oe):Me.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(Le.type)} instead`):null}evaluate(F){const Me=this.needle.evaluate(F),Le=this.haystack.evaluate(F);if(null==Le)return!1;if(!We(Me,["boolean","string","number","null"]))throw new or(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(ir(Me))} instead.`);if(!We(Le,["string","array"]))throw new or(`Expected second argument to be of type array or string, but found ${Ye(ir(Le))} instead.`);return Le.indexOf(Me)>=0}eachChild(F){F(this.needle),F(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class fi{constructor(F,Me,Le){this.type=Fu,this.needle=F,this.haystack=Me,this.fromIndex=Le}static parse(F,Me){if(F.length<=2||F.length>=5)return Me.error(`Expected 3 or 4 arguments, but found ${F.length-1} instead.`);const Le=Me.parse(F[1],1,hd),Oe=Me.parse(F[2],2,hd);if(!Le||!Oe)return null;if(!Ze(Le.type,[Zu,Hu,Fu,Su,hd]))return Me.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(Le.type)} instead`);if(4===F.length){const Fe=Me.parse(F[3],3,Fu);return Fe?new fi(Le,Oe,Fe):null}return new fi(Le,Oe)}evaluate(F){const Me=this.needle.evaluate(F),Le=this.haystack.evaluate(F);if(!We(Me,["boolean","string","number","null"]))throw new or(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(ir(Me))} instead.`);if(!We(Le,["string","array"]))throw new or(`Expected second argument to be of type array or string, but found ${Ye(ir(Le))} instead.`);if(this.fromIndex){const Oe=this.fromIndex.evaluate(F);return Le.indexOf(Me,Oe)}return Le.indexOf(Me)}eachChild(F){F(this.needle),F(this.haystack),this.fromIndex&&F(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const F=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),F]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class di{constructor(F,Me,Le,Oe,Fe,je){this.inputType=F,this.type=Me,this.input=Le,this.cases=Oe,this.outputs=Fe,this.otherwise=je}static parse(F,Me){if(F.length<5)return Me.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if(F.length%2!=1)return Me.error("Expected an even number of arguments.");let Le,Oe;Me.expectedType&&"value"!==Me.expectedType.kind&&(Oe=Me.expectedType);const Fe={},je=[];for(let qe=2;qe<F.length-1;qe+=2){let He=F[qe];const xt=F[qe+1];Array.isArray(He)||(He=[He]);const Pt=Me.concat(qe);if(0===He.length)return Pt.error("Expected at least one branch label.");for(const F of He){if("number"!=typeof F&&"string"!=typeof F)return Pt.error("Branch labels must be numbers or strings.");if("number"==typeof F&&Math.abs(F)>Number.MAX_SAFE_INTEGER)return Pt.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof F&&Math.floor(F)!==F)return Pt.error("Numeric branch labels must be integer values.");if(Le){if(Pt.checkSubtype(Le,ir(F)))return null}else Le=ir(F);if(void 0!==Fe[String(F)])return Pt.error("Branch labels must be unique.");Fe[String(F)]=je.length}const jt=Me.parse(xt,qe,Oe);if(!jt)return null;Oe=Oe||jt.type,je.push(jt)}const qe=Me.parse(F[1],1,hd);if(!qe)return null;const He=Me.parse(F[F.length-1],F.length-1,Oe);return He?"value"!==qe.type.kind&&Me.concat(1).checkSubtype(Le,qe.type)?null:new di(Le,Oe,qe,Fe,je,He):null}evaluate(F){const Me=this.input.evaluate(F);return(ir(Me)===this.inputType&&this.outputs[this.cases[Me]]||this.otherwise).evaluate(F)}eachChild(F){F(this.input),this.outputs.forEach(F),F(this.otherwise)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const F=["match",this.input.serialize()],Me=Object.keys(this.cases).sort(),Le=[],Oe={};for(const F of Me){const Me=Oe[this.cases[F]];void 0===Me?(Oe[this.cases[F]]=Le.length,Le.push([this.cases[F],[F]])):Le[Me][1].push(F)}const i=F=>"number"===this.inputType.kind?Number(F):F;for(const[Me,Oe]of Le)F.push(1===Oe.length?i(Oe[0]):Oe.map(i)),F.push(this.outputs[Me].serialize());return F.push(this.otherwise.serialize()),F}}class mi{constructor(F,Me,Le){this.type=F,this.branches=Me,this.otherwise=Le}static parse(F,Me){if(F.length<4)return Me.error(`Expected at least 3 arguments, but found only ${F.length-1}.`);if(F.length%2!=0)return Me.error("Expected an odd number of arguments.");let Le;Me.expectedType&&"value"!==Me.expectedType.kind&&(Le=Me.expectedType);const Oe=[];for(let Fe=1;Fe<F.length-1;Fe+=2){const je=Me.parse(F[Fe],Fe,Zu);if(!je)return null;const qe=Me.parse(F[Fe+1],Fe+1,Le);if(!qe)return null;Oe.push([je,qe]),Le=Le||qe.type}const Fe=Me.parse(F[F.length-1],F.length-1,Le);return Fe?new mi(Le,Oe,Fe):null}evaluate(F){for(const[Me,Le]of this.branches)if(Me.evaluate(F))return Le.evaluate(F);return this.otherwise.evaluate(F)}eachChild(F){for(const[Me,Le]of this.branches)F(Me),F(Le);F(this.otherwise)}outputDefined(){return this.branches.every((([F,Me])=>Me.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const F=["case"];return this.eachChild((Me=>{F.push(Me.serialize())})),F}}class yi{constructor(F,Me,Le,Oe){this.type=F,this.input=Me,this.beginIndex=Le,this.endIndex=Oe}static parse(F,Me){if(F.length<=2||F.length>=5)return Me.error(`Expected 3 or 4 arguments, but found ${F.length-1} instead.`);const Le=Me.parse(F[1],1,hd),Oe=Me.parse(F[2],2,Fu);if(!Le||!Oe)return null;if(!Ze(Le.type,[Ge(hd),Hu,hd]))return Me.error(`Expected first argument to be of type array or string, but found ${Ye(Le.type)} instead`);if(4===F.length){const Fe=Me.parse(F[3],3,Fu);return Fe?new yi(Le.type,Le,Oe,Fe):null}return new yi(Le.type,Le,Oe)}evaluate(F){const Me=this.input.evaluate(F),Le=this.beginIndex.evaluate(F);if(!We(Me,["string","array"]))throw new or(`Expected first argument to be of type array or string, but found ${Ye(ir(Me))} instead.`);if(this.endIndex){const Oe=this.endIndex.evaluate(F);return Me.slice(Le,Oe)}return Me.slice(Le)}eachChild(F){F(this.input),F(this.beginIndex),this.endIndex&&F(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const F=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),F]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function gi(F,Me){return"=="===F||"!="===F?"boolean"===Me.kind||"string"===Me.kind||"number"===Me.kind||"null"===Me.kind||"value"===Me.kind:"string"===Me.kind||"number"===Me.kind||"value"===Me.kind}function xi(F,Me,Le,Oe){return 0===Oe.compare(Me,Le)}function vi(F,Me,Le){const Oe="=="!==F&&"!="!==F;return class i{constructor(F,Me,Le){this.type=Zu,this.lhs=F,this.rhs=Me,this.collator=Le,this.hasUntypedArgument="value"===F.type.kind||"value"===Me.type.kind}static parse(F,Me){if(3!==F.length&&4!==F.length)return Me.error("Expected two or three arguments.");const Le=F[0];let Fe=Me.parse(F[1],1,hd);if(!Fe)return null;if(!gi(Le,Fe.type))return Me.concat(1).error(`"${Le}" comparisons are not supported for type '${Ye(Fe.type)}'.`);let je=Me.parse(F[2],2,hd);if(!je)return null;if(!gi(Le,je.type))return Me.concat(2).error(`"${Le}" comparisons are not supported for type '${Ye(je.type)}'.`);if(Fe.type.kind!==je.type.kind&&"value"!==Fe.type.kind&&"value"!==je.type.kind)return Me.error(`Cannot compare types '${Ye(Fe.type)}' and '${Ye(je.type)}'.`);Oe&&("value"===Fe.type.kind&&"value"!==je.type.kind?Fe=new ur(je.type,[Fe]):"value"!==Fe.type.kind&&"value"===je.type.kind&&(je=new ur(Fe.type,[je])));let qe=null;if(4===F.length){if("string"!==Fe.type.kind&&"string"!==je.type.kind&&"value"!==Fe.type.kind&&"value"!==je.type.kind)return Me.error("Cannot use collator to compare non-string types.");if(qe=Me.parse(F[3],3,md),!qe)return null}return new i(Fe,je,qe)}evaluate(Fe){const je=this.lhs.evaluate(Fe),qe=this.rhs.evaluate(Fe);if(Oe&&this.hasUntypedArgument){const Me=ir(je),Le=ir(qe);if(Me.kind!==Le.kind||"string"!==Me.kind&&"number"!==Me.kind)throw new or(`Expected arguments for "${F}" to be (string, string) or (number, number), but found (${Me.kind}, ${Le.kind}) instead.`)}if(this.collator&&!Oe&&this.hasUntypedArgument){const F=ir(je),Le=ir(qe);if("string"!==F.kind||"string"!==Le.kind)return Me(Fe,je,qe)}return this.collator?Le(Fe,je,qe,this.collator.evaluate(Fe)):Me(Fe,je,qe)}eachChild(F){F(this.lhs),F(this.rhs),this.collator&&F(this.collator)}outputDefined(){return!0}serialize(){const Me=[F];return this.eachChild((F=>{Me.push(F.serialize())})),Me}}}const qp=vi("==",(function(F,Me,Le){return Me===Le}),xi),$p=vi("!=",(function(F,Me,Le){return Me!==Le}),(function(F,Me,Le,Oe){return!xi(0,Me,Le,Oe)})),Zp=vi("<",(function(F,Me,Le){return Me<Le}),(function(F,Me,Le,Oe){return Oe.compare(Me,Le)<0})),Xp=vi(">",(function(F,Me,Le){return Me>Le}),(function(F,Me,Le,Oe){return Oe.compare(Me,Le)>0})),rf=vi("<=",(function(F,Me,Le){return Me<=Le}),(function(F,Me,Le,Oe){return Oe.compare(Me,Le)<=0})),af=vi(">=",(function(F,Me,Le){return Me>=Le}),(function(F,Me,Le,Oe){return Oe.compare(Me,Le)>=0}));class Si{constructor(F,Me,Le,Oe,Fe,je){this.type=Hu,this.number=F,this.locale=Me,this.currency=Le,this.unit=Oe,this.minFractionDigits=Fe,this.maxFractionDigits=je}static parse(F,Me){if(3!==F.length)return Me.error("Expected two arguments.");const Le=Me.parse(F[1],1,Fu);if(!Le)return null;const Oe=F[2];if("object"!=typeof Oe||Array.isArray(Oe))return Me.error("NumberFormat options argument must be an object.");let Fe=null;if(Oe.locale&&(Fe=Me.parseObjectValue(Oe.locale,2,"locale",Hu),!Fe))return null;let je=null;if(Oe.currency&&(je=Me.parseObjectValue(Oe.currency,2,"currency",Hu),!je))return null;let qe=null;if(Oe.unit&&(qe=Me.parseObjectValue(Oe.unit,2,"unit",Hu),!qe))return null;let He=null;if(Oe["min-fraction-digits"]&&(He=Me.parseObjectValue(Oe["min-fraction-digits"],2,"min-fraction-digits",Fu),!He))return null;let xt=null;return Oe["max-fraction-digits"]&&(xt=Me.parseObjectValue(Oe["max-fraction-digits"],2,"max-fraction-digits",Fu),!xt)?null:new Si(Le,Fe,je,qe,He,xt)}evaluate(F){return new Intl.NumberFormat(this.locale?this.locale.evaluate(F):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(F):void 0,unit:this.unit?this.unit.evaluate(F):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(F):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(F):void 0}).format(this.number.evaluate(F))}eachChild(F){F(this.number),this.locale&&F(this.locale),this.currency&&F(this.currency),this.unit&&F(this.unit),this.minFractionDigits&&F(this.minFractionDigits),this.maxFractionDigits&&F(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const F={};return this.locale&&(F.locale=this.locale.serialize()),this.currency&&(F.currency=this.currency.serialize()),this.unit&&(F.unit=this.unit.serialize()),this.minFractionDigits&&(F["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(F["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),F]}}class Pi{constructor(F){this.type=Fu,this.input=F}static parse(F,Me){if(2!==F.length)return Me.error(`Expected 1 argument, but found ${F.length-1} instead.`);const Le=Me.parse(F[1],1);return Le?"array"!==Le.type.kind&&"string"!==Le.type.kind&&"value"!==Le.type.kind?Me.error(`Expected argument of type string or array, but found ${Ye(Le.type)} instead.`):new Pi(Le):null}evaluate(F){const Me=this.input.evaluate(F);if("string"==typeof Me)return Me.length;if(Array.isArray(Me))return Me.length;throw new or(`Expected value to be of type string or array, but found ${Ye(ir(Me))} instead.`)}eachChild(F){F(this.input)}outputDefined(){return!1}serialize(){const F=["length"];return this.eachChild((Me=>{F.push(Me.serialize())})),F}}function Ei(F){return function(){F=1831565813+(F|=0)|0;let Me=Math.imul(F^F>>>15,1|F);return Me=Me+Math.imul(Me^Me>>>7,61|Me)^Me,((Me^Me>>>14)>>>0)/4294967296}}const lf={"==":qp,"!=":$p,">":Xp,"<":Zp,">=":af,"<=":rf,array:ur,at:ci,"at-interpolated":hi,boolean:ur,case:mi,coalesce:li,collator:vr,format:cr,image:hr,in:pi,"index-of":fi,interpolate:ai,"interpolate-hcl":ai,"interpolate-lab":ai,length:Pi,let:ui,literal:ar,match:di,number:ur,"number-format":Si,object:ur,slice:yi,step:Un,string:ur,"to-boolean":dr,"to-color":dr,"to-number":dr,"to-string":dr,var:Rn,within:Ur,distance:En,config:Tn};function ki(F,[Me,Le,Oe,Fe]){Me=Me.evaluate(F),Le=Le.evaluate(F),Oe=Oe.evaluate(F);const je=Fe?Fe.evaluate(F):1,qe=rr(Me,Le,Oe,je);if(qe)throw new or(qe);return new Se(Me/255*je,Le/255*je,Oe/255*je,je)}function Ti(F,[Me,Le,Oe,Fe]){Me=Me.evaluate(F),Le=Le.evaluate(F),Oe=Oe.evaluate(F);const je=Fe?Fe.evaluate(F):1,qe=function(F,Me,Le,Oe){return"number"==typeof F&&F>=0&&F<=360?"number"==typeof Me&&Me>=0&&Me<=100&&"number"==typeof Le&&Le>=0&&Le<=100?void 0===Oe||"number"==typeof Oe&&Oe>=0&&Oe<=1?null:`Invalid hsla value [${[F,Me,Le,Oe].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof Oe?[F,Me,Le,Oe]:[F,Me,Le]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof Oe?[F,Me,Le,Oe]:[F,Me,Le]).join(", ")}]: 'h' must be between 0 and 360.`}(Me,Le,Oe,je);if(qe)throw new or(qe);const He=`hsla(${Me}, ${Le}%, ${Oe}%, ${je})`,xt=Se.parse(He);if(!xt)throw new or(`Failed to parse HSLA color: ${He}`);return xt}function Bi(F,Me){return F in Me}function Vi(F,Me){const Le=Me[F];return void 0===Le?null:Le}function Ci(F){return{type:F}}function Di(F){return{result:"success",value:F}}function Ri(F){return{result:"error",value:F}}function Li(F,Me){return!!F&&!!F.parameters&&F.parameters.indexOf(Me)>-1}function Fi(F){return"data-driven"===F["property-type"]}function Oi(F){return Li(F.expression,"measure-light")}function Ni(F){return Li(F.expression,"zoom")}function Ui(F){return!!F.expression&&F.expression.interpolated}function ji(F){return"object"==typeof F&&null!==F&&!Array.isArray(F)}function qi(F){return F}function $i(F,Me){const Le="color"===Me.type,Oe=F.stops&&"object"==typeof F.stops[0][0],Fe=Oe||!(Oe||void 0!==F.property),je=F.type||(Ui(Me)?"exponential":"interval");if(Le&&((F=Be({},F)).stops&&(F.stops=F.stops.map((F=>[F[0],Se.parse(F[1])]))),F.default=Se.parse(F.default?F.default:Me.default)),F.colorSpace&&"rgb"!==F.colorSpace&&!Gp[F.colorSpace])throw new Error(`Unknown color space: ${F.colorSpace}`);let qe,He,xt;if("exponential"===je)qe=Xi;else if("interval"===je)qe=Hi;else if("categorical"===je){qe=Yi,He=Object.create(null);for(const Me of F.stops)He[Me[0]]=Me[1];xt=typeof F.stops[0][0]}else{if("identity"!==je)throw new Error(`Unknown function type "${je}"`);qe=Zi}if(Oe){const Le={},Oe=[];for(let Me=0;Me<F.stops.length;Me++){const Fe=F.stops[Me],je=Fe[0].zoom;void 0===Le[je]&&(Le[je]={zoom:je,type:F.type,property:F.property,default:F.default,stops:[]},Oe.push(je)),Le[je].stops.push([Fe[0].value,Fe[1]])}const Fe=[];for(const F of Oe)Fe.push([Le[F].zoom,$i(Le[F],Me)]);const je={name:"linear"};return{kind:"composite",interpolationType:je,interpolationFactor:ai.interpolationFactor.bind(void 0,je),zoomStops:Fe.map((F=>F[0])),evaluate:({zoom:Le},Oe)=>Xi({stops:Fe,base:F.base},Me,Le).evaluate(Le,Oe)}}if(Fe){const Le="exponential"===je?{name:"exponential",base:void 0!==F.base?F.base:1}:null;return{kind:"camera",interpolationType:Le,interpolationFactor:ai.interpolationFactor.bind(void 0,Le),zoomStops:F.stops.map((F=>F[0])),evaluate:({zoom:Le})=>qe(F,Me,Le,He,xt)}}return{kind:"source",evaluate(Le,Oe){const Fe=Oe&&Oe.properties?Oe.properties[F.property]:void 0;return void 0===Fe?Gi(F.default,Me.default):qe(F,Me,Fe,He,xt)}}}function Gi(F,Me,Le){return void 0!==F?F:void 0!==Me?Me:void 0!==Le?Le:void 0}function Yi(F,Me,Le,Oe,Fe){return Gi(typeof Le===Fe?Oe[Le]:void 0,F.default,Me.default)}function Hi(F,Me,Le){if("number"!==pr(Le))return Gi(F.default,Me.default);const Oe=F.stops.length;if(1===Oe)return F.stops[0][1];if(Le<=F.stops[0][0])return F.stops[0][1];if(Le>=F.stops[Oe-1][0])return F.stops[Oe-1][1];const Fe=Nn(F.stops.map((F=>F[0])),Le);return F.stops[Fe][1]}function Xi(F,Me,Le){const Oe=void 0!==F.base?F.base:1;if("number"!==pr(Le))return Gi(F.default,Me.default);const Fe=F.stops.length;if(1===Fe)return F.stops[0][1];if(Le<=F.stops[0][0])return F.stops[0][1];if(Le>=F.stops[Fe-1][0])return F.stops[Fe-1][1];const je=Nn(F.stops.map((F=>F[0])),Le),qe=function(F,Me,Le,Oe){const Fe=Oe-Le,je=F-Le;return 0===Fe?0:1===Me?je/Fe:(Math.pow(Me,je)-1)/(Math.pow(Me,Fe)-1)}(Le,Oe,F.stops[je][0],F.stops[je+1][0]),He=F.stops[je][1],xt=F.stops[je+1][1];let Pt=mu[Me.type]||qi;if(F.colorSpace&&"rgb"!==F.colorSpace){const Me=Gp[F.colorSpace];Pt=(F,Le)=>Me.reverse(Me.interpolate(Me.forward(F),Me.forward(Le),qe))}return"function"==typeof He.evaluate?{evaluate(...F){const Me=He.evaluate.apply(void 0,F),Le=xt.evaluate.apply(void 0,F);if(void 0!==Me&&void 0!==Le)return Pt(Me,Le,qe)}}:Pt(He,xt,qe)}function Zi(F,Me,Le){return"color"===Me.type?Le=Se.parse(Le):"formatted"===Me.type?Le=Qe.fromString(Le.toString()):"resolvedImage"===Me.type?Le=er.build(Le.toString()):pr(Le)===Me.type||"enum"===Me.type&&Me.values[Le]||(Le=void 0),Gi(Le,F.default,Me.default)}gr.register(lf,{error:[{kind:"error"},[Hu],(F,[Me])=>{throw new or(Me.evaluate(F))}],typeof:[Hu,[hd],(F,[Me])=>Ye(ir(Me.evaluate(F)))],"to-rgba":[Ge(Fu,4),[Wu],(F,[Me])=>Me.evaluate(F).toRenderColor(null).toArray()],"to-hsla":[Ge(Fu,4),[Wu],(F,[Me])=>Me.evaluate(F).toRenderColor(null).toHslaArray()],rgb:[Wu,[Fu,Fu,Fu],ki],rgba:[Wu,[Fu,Fu,Fu,Fu],ki],hsl:[Wu,[Fu,Fu,Fu],Ti],hsla:[Wu,[Fu,Fu,Fu,Fu],Ti],has:{type:Zu,overloads:[[[Hu],(F,[Me])=>Bi(Me.evaluate(F),F.properties())],[[Hu,Xu],(F,[Me,Le])=>Bi(Me.evaluate(F),Le.evaluate(F))]]},get:{type:hd,overloads:[[[Hu],(F,[Me])=>Vi(Me.evaluate(F),F.properties())],[[Hu,Xu],(F,[Me,Le])=>Vi(Me.evaluate(F),Le.evaluate(F))]]},"feature-state":[hd,[Hu],(F,[Me])=>Vi(Me.evaluate(F),F.featureState||{})],properties:[Xu,[],F=>F.properties()],"geometry-type":[Hu,[],F=>F.geometryType()],id:[hd,[],F=>F.id()],zoom:[Fu,[],F=>F.globals.zoom],pitch:[Fu,[],F=>F.globals.pitch||0],"distance-from-center":[Fu,[],F=>F.distanceFromCenter()],"measure-light":[Fu,[Hu],(F,[Me])=>F.measureLight(Me.evaluate(F))],"heatmap-density":[Fu,[],F=>F.globals.heatmapDensity||0],"line-progress":[Fu,[],F=>F.globals.lineProgress||0],"raster-value":[Fu,[],F=>F.globals.rasterValue||0],"raster-particle-speed":[Fu,[],F=>F.globals.rasterParticleSpeed||0],"sky-radial-progress":[Fu,[],F=>F.globals.skyRadialProgress||0],accumulated:[hd,[],F=>void 0===F.globals.accumulated?null:F.globals.accumulated],"+":[Fu,Ci(Fu),(F,Me)=>{let Le=0;for(const Oe of Me)Le+=Oe.evaluate(F);return Le}],"*":[Fu,Ci(Fu),(F,Me)=>{let Le=1;for(const Oe of Me)Le*=Oe.evaluate(F);return Le}],"-":{type:Fu,overloads:[[[Fu,Fu],(F,[Me,Le])=>Me.evaluate(F)-Le.evaluate(F)],[[Fu],(F,[Me])=>-Me.evaluate(F)]]},"/":[Fu,[Fu,Fu],(F,[Me,Le])=>Me.evaluate(F)/Le.evaluate(F)],"%":[Fu,[Fu,Fu],(F,[Me,Le])=>Me.evaluate(F)%Le.evaluate(F)],ln2:[Fu,[],()=>Math.LN2],pi:[Fu,[],()=>Math.PI],e:[Fu,[],()=>Math.E],"^":[Fu,[Fu,Fu],(F,[Me,Le])=>Math.pow(Me.evaluate(F),Le.evaluate(F))],sqrt:[Fu,[Fu],(F,[Me])=>Math.sqrt(Me.evaluate(F))],log10:[Fu,[Fu],(F,[Me])=>Math.log(Me.evaluate(F))/Math.LN10],ln:[Fu,[Fu],(F,[Me])=>Math.log(Me.evaluate(F))],log2:[Fu,[Fu],(F,[Me])=>Math.log(Me.evaluate(F))/Math.LN2],sin:[Fu,[Fu],(F,[Me])=>Math.sin(Me.evaluate(F))],cos:[Fu,[Fu],(F,[Me])=>Math.cos(Me.evaluate(F))],tan:[Fu,[Fu],(F,[Me])=>Math.tan(Me.evaluate(F))],asin:[Fu,[Fu],(F,[Me])=>Math.asin(Me.evaluate(F))],acos:[Fu,[Fu],(F,[Me])=>Math.acos(Me.evaluate(F))],atan:[Fu,[Fu],(F,[Me])=>Math.atan(Me.evaluate(F))],min:[Fu,Ci(Fu),(F,Me)=>Math.min(...Me.map((Me=>Me.evaluate(F))))],max:[Fu,Ci(Fu),(F,Me)=>Math.max(...Me.map((Me=>Me.evaluate(F))))],abs:[Fu,[Fu],(F,[Me])=>Math.abs(Me.evaluate(F))],round:[Fu,[Fu],(F,[Me])=>{const Le=Me.evaluate(F);return Le<0?-Math.round(-Le):Math.round(Le)}],floor:[Fu,[Fu],(F,[Me])=>Math.floor(Me.evaluate(F))],ceil:[Fu,[Fu],(F,[Me])=>Math.ceil(Me.evaluate(F))],"filter-==":[Zu,[Hu,hd],(F,[Me,Le])=>F.properties()[Me.value]===Le.value],"filter-id-==":[Zu,[hd],(F,[Me])=>F.id()===Me.value],"filter-type-==":[Zu,[Hu],(F,[Me])=>F.geometryType()===Me.value],"filter-<":[Zu,[Hu,hd],(F,[Me,Le])=>{const Oe=F.properties()[Me.value],Fe=Le.value;return typeof Oe==typeof Fe&&Oe<Fe}],"filter-id-<":[Zu,[hd],(F,[Me])=>{const Le=F.id(),Oe=Me.value;return typeof Le==typeof Oe&&Le<Oe}],"filter->":[Zu,[Hu,hd],(F,[Me,Le])=>{const Oe=F.properties()[Me.value],Fe=Le.value;return typeof Oe==typeof Fe&&Oe>Fe}],"filter-id->":[Zu,[hd],(F,[Me])=>{const Le=F.id(),Oe=Me.value;return typeof Le==typeof Oe&&Le>Oe}],"filter-<=":[Zu,[Hu,hd],(F,[Me,Le])=>{const Oe=F.properties()[Me.value],Fe=Le.value;return typeof Oe==typeof Fe&&Oe<=Fe}],"filter-id-<=":[Zu,[hd],(F,[Me])=>{const Le=F.id(),Oe=Me.value;return typeof Le==typeof Oe&&Le<=Oe}],"filter->=":[Zu,[Hu,hd],(F,[Me,Le])=>{const Oe=F.properties()[Me.value],Fe=Le.value;return typeof Oe==typeof Fe&&Oe>=Fe}],"filter-id->=":[Zu,[hd],(F,[Me])=>{const Le=F.id(),Oe=Me.value;return typeof Le==typeof Oe&&Le>=Oe}],"filter-has":[Zu,[hd],(F,[Me])=>Me.value in F.properties()],"filter-has-id":[Zu,[],F=>null!==F.id()&&void 0!==F.id()],"filter-type-in":[Zu,[Ge(Hu)],(F,[Me])=>Me.value.indexOf(F.geometryType())>=0],"filter-id-in":[Zu,[Ge(hd)],(F,[Me])=>Me.value.indexOf(F.id())>=0],"filter-in-small":[Zu,[Hu,Ge(hd)],(F,[Me,Le])=>Le.value.indexOf(F.properties()[Me.value])>=0],"filter-in-large":[Zu,[Hu,Ge(hd)],(F,[Me,Le])=>function(F,Me,Le,Oe){for(;Le<=Oe;){const Fe=Le+Oe>>1;if(Me[Fe]===F)return!0;Me[Fe]>F?Oe=Fe-1:Le=Fe+1}return!1}(F.properties()[Me.value],Le.value,0,Le.value.length-1)],all:{type:Zu,overloads:[[[Zu,Zu],(F,[Me,Le])=>Me.evaluate(F)&&Le.evaluate(F)],[Ci(Zu),(F,Me)=>{for(const Le of Me)if(!Le.evaluate(F))return!1;return!0}]]},any:{type:Zu,overloads:[[[Zu,Zu],(F,[Me,Le])=>Me.evaluate(F)||Le.evaluate(F)],[Ci(Zu),(F,Me)=>{for(const Le of Me)if(Le.evaluate(F))return!0;return!1}]]},"!":[Zu,[Zu],(F,[Me])=>!Me.evaluate(F)],"is-supported-script":[Zu,[Hu],(F,[Me])=>{const Le=F.globals&&F.globals.isSupportedScript;return!Le||Le(Me.evaluate(F))}],upcase:[Hu,[Hu],(F,[Me])=>Me.evaluate(F).toUpperCase()],downcase:[Hu,[Hu],(F,[Me])=>Me.evaluate(F).toLowerCase()],concat:[Hu,Ci(hd),(F,Me)=>Me.map((Me=>sr(Me.evaluate(F)))).join("")],"resolved-locale":[Hu,[md],(F,[Me])=>Me.evaluate(F).resolvedLocale()],random:[Fu,[Fu,Fu,hd],(F,Me)=>{const[Le,Oe,Fe]=Me.map((Me=>Me.evaluate(F)));if(Le>Oe)return Le;if(Le===Oe)return Le;let je;if("string"==typeof Fe)je=function(F){let Me=0;if(0===F.length)return Me;for(let Le=0;Le<F.length;Le++)Me=(Me<<5)-Me+F.charCodeAt(Le),Me|=0;return Me}(Fe);else{if("number"!=typeof Fe)throw new or(`Invalid seed input: ${Fe}`);je=Fe}return Le+Ei(je)()*(Oe-Le)}]});class Wi{constructor(F,Me,Le,Oe){this.expression=F,this._warningHistory={},this._evaluator=new yr(Le,Oe),this._defaultValue=Me?function(F){return"color"===F.type&&(ji(F.default)||Array.isArray(F.default))?new Se(0,0,0,0):"color"===F.type?Se.parse(F.default)||null:void 0===F.default?null:F.default}(Me):null,this._enumValues=Me&&"enum"===Me.type?Me.values:null,this.configDependencies=Cn(F)}evaluateWithoutErrorHandling(F,Me,Le,Oe,Fe,je,qe,He){return this._evaluator.globals=F,this._evaluator.feature=Me,this._evaluator.featureState=Le,this._evaluator.canonical=Oe||null,this._evaluator.availableImages=Fe||null,this._evaluator.formattedSection=je,this._evaluator.featureTileCoord=qe||null,this._evaluator.featureDistanceData=He||null,this.expression.evaluate(this._evaluator)}evaluate(F,Me,Le,Oe,Fe,je,qe,He){this._evaluator.globals=F,this._evaluator.feature=Me||null,this._evaluator.featureState=Le||null,this._evaluator.canonical=Oe||null,this._evaluator.availableImages=Fe||null,this._evaluator.formattedSection=je||null,this._evaluator.featureTileCoord=qe||null,this._evaluator.featureDistanceData=He||null;try{const F=this.expression.evaluate(this._evaluator);if(null==F||"number"==typeof F&&F!=F)return this._defaultValue;if(this._enumValues&&!(F in this._enumValues))throw new or(`Expected value to be one of ${Object.keys(this._enumValues).map((F=>JSON.stringify(F))).join(", ")}, but found ${JSON.stringify(F)} instead.`);return F}catch(F){return this._warningHistory[F.message]||(this._warningHistory[F.message]=!0,"undefined"!=typeof console&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${F.message}`)),this._defaultValue}}}function Ki(F){return Array.isArray(F)&&F.length>0&&"string"==typeof F[0]&&F[0]in lf}function Ji(F,Me,Le,Oe){const Fe=new ap(lf,[],Me?function(F){const Me={color:Wu,string:Hu,number:Fu,enum:Hu,boolean:Zu,formatted:_d,resolvedImage:xd};return"array"===F.type?Ge(Me[F.value]||hd,F.length):Me[F.type]}(Me):void 0,void 0,void 0,Le,Oe),je=Fe.parse(F,void 0,void 0,void 0,Me&&"string"===Me.type?{typeAnnotation:"coerce"}:void 0);return je?Di(new Wi(je,Me,Le,Oe)):Ri(Fe.errors)}class Qi{constructor(F,Me,Le,Oe){this.kind=F,this._styleExpression=Me,this.isLightConstant=Le,this.isLineProgressConstant=Oe,this.isStateDependent="constant"!==F&&!Vn(Me.expression),this.configDependencies=Cn(Me.expression)}evaluateWithoutErrorHandling(F,Me,Le,Oe,Fe,je){return this._styleExpression.evaluateWithoutErrorHandling(F,Me,Le,Oe,Fe,je)}evaluate(F,Me,Le,Oe,Fe,je){return this._styleExpression.evaluate(F,Me,Le,Oe,Fe,je)}}class ts{constructor(F,Me,Le,Oe,Fe,je){this.kind=F,this.zoomStops=Le,this._styleExpression=Me,this.isStateDependent="camera"!==F&&!Vn(Me.expression),this.isLightConstant=Fe,this.isLineProgressConstant=je,this.configDependencies=Cn(Me.expression),this.interpolationType=Oe}evaluateWithoutErrorHandling(F,Me,Le,Oe,Fe,je){return this._styleExpression.evaluateWithoutErrorHandling(F,Me,Le,Oe,Fe,je)}evaluate(F,Me,Le,Oe,Fe,je){return this._styleExpression.evaluate(F,Me,Le,Oe,Fe,je)}interpolationFactor(F,Me,Le){return this.interpolationType?ai.interpolationFactor(this.interpolationType,F,Me,Le):0}}function es(F,Me,Le,Oe){if("error"===(F=Ji(F,Me,Le,Oe)).result)return F;const Fe=F.value.expression,je=Bn(Fe);if(!je&&!Fi(Me))return Ri([new Ve("","data expressions not supported")]);const qe=Dn(Fe,["zoom","pitch","distance-from-center"]);if(!qe&&!Ni(Me))return Ri([new Ve("","zoom expressions not supported")]);const He=Dn(Fe,["measure-light"]);if(!He&&!Oi(Me))return Ri([new Ve("","measure-light expression not supported")]);const xt=Dn(Fe,["line-progress"]);if(!xt&&!function(F){return Li(F.expression,"line-progress")}(Me))return Ri([new Ve("","line-progress expression not supported")]);const Pt=Me.expression&&Me.expression.relaxZoomRestriction,jt=ns(Fe);return jt||qe||Pt?jt instanceof Ve?Ri([jt]):jt instanceof ai&&!Ui(Me)?Ri([new Ve("",'"interpolate" expressions cannot be used with this property')]):Di(jt?new ts(je&&xt?"camera":"composite",F.value,jt.labels,jt instanceof ai?jt.interpolation:void 0,He,xt):new Qi(je&&xt?"constant":"source",F.value,He,xt)):Ri([new Ve("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class rs{constructor(F,Me){this._parameters=F,this._specification=Me,Be(this,$i(this._parameters,this._specification))}static deserialize(F){return new rs(F._parameters,F._specification)}static serialize(F){return{_parameters:F._parameters,_specification:F._specification}}}function ns(F){let Me=null;if(F instanceof ui)Me=ns(F.result);else if(F instanceof li){for(const Le of F.args)if(Me=ns(Le),Me)break}else(F instanceof Un||F instanceof ai)&&F.input instanceof gr&&"zoom"===F.input.name&&(Me=F);return Me instanceof Ve||F.eachChild((F=>{const Le=ns(F);Le instanceof Ve?Me=Le:Me&&Le&&Me!==Le&&(Me=new Ve("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),Me}var cf,hf,uf=function(){if(hf)return cf;hf=1,cf=e;var Me=3;function e(Le,Oe,Fe){var je=(this||F).cells=[];if(Le instanceof ArrayBuffer){(this||F).arrayBuffer=Le;var qe=new Int32Array((this||F).arrayBuffer);Le=qe[0],(this||F).d=(Oe=qe[1])+2*(Fe=qe[2]);for(var He=0;He<(this||F).d*(this||F).d;He++){var xt=qe[Me+He],Pt=qe[Me+He+1];je.push(xt===Pt?null:qe.subarray(xt,Pt))}var jt=qe[Me+je.length+1];(this||F).keys=qe.subarray(qe[Me+je.length],jt),(this||F).bboxes=qe.subarray(jt),(this||F).insert=(this||F)._insertReadonly}else{(this||F).d=Oe+2*Fe;for(var Gt=0;Gt<(this||F).d*(this||F).d;Gt++)je.push([]);(this||F).keys=[],(this||F).bboxes=[]}(this||F).n=Oe,(this||F).extent=Le,(this||F).padding=Fe,(this||F).scale=Oe/Le,(this||F).uid=0;var bi=Fe/Oe*Le;(this||F).min=-bi,(this||F).max=Le+bi}return e.prototype.insert=function(Me,Le,Oe,Fe,je){this._forEachCell(Le,Oe,Fe,je,(this||F)._insertCell,(this||F).uid++),(this||F).keys.push(Me),(this||F).bboxes.push(Le),(this||F).bboxes.push(Oe),(this||F).bboxes.push(Fe),(this||F).bboxes.push(je)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(Me,Le,Oe,Fe,je,qe){(this||F).cells[je].push(qe)},e.prototype.query=function(Me,Le,Oe,Fe,je){var qe=(this||F).min,He=(this||F).max;if(Me<=qe&&Le<=qe&&He<=Oe&&He<=Fe&&!je)return Array.prototype.slice.call((this||F).keys);var xt=[];return this._forEachCell(Me,Le,Oe,Fe,(this||F)._queryCell,xt,{},je),xt},e.prototype._queryCell=function(Me,Le,Oe,Fe,je,qe,He,xt){var Pt=(this||F).cells[je];if(null!==Pt)for(var jt=(this||F).keys,Gt=(this||F).bboxes,bi=0;bi<Pt.length;bi++){var wi=Pt[bi];if(void 0===He[wi]){var qr=4*wi;(xt?xt(Gt[qr+0],Gt[qr+1],Gt[qr+2],Gt[qr+3]):Me<=Gt[qr+2]&&Le<=Gt[qr+3]&&Oe>=Gt[qr+0]&&Fe>=Gt[qr+1])?(He[wi]=!0,qe.push(jt[wi])):He[wi]=!1}}},e.prototype._forEachCell=function(Me,Le,Oe,Fe,je,qe,He,xt){for(var Pt=this._convertToCellCoord(Me),jt=this._convertToCellCoord(Le),Gt=this._convertToCellCoord(Oe),bi=this._convertToCellCoord(Fe),wi=Pt;wi<=Gt;wi++)for(var qr=jt;qr<=bi;qr++){var Xn=(this||F).d*qr+wi;if((!xt||xt(this._convertFromCellCoord(wi),this._convertFromCellCoord(qr),this._convertFromCellCoord(wi+1),this._convertFromCellCoord(qr+1)))&&je.call(this||F,Me,Le,Oe,Fe,Xn,qe,He,xt))return}},e.prototype._convertFromCellCoord=function(Me){return(Me-(this||F).padding)/(this||F).scale},e.prototype._convertToCellCoord=function(Me){return Math.max(0,Math.min((this||F).d-1,Math.floor(Me*(this||F).scale)+(this||F).padding))},e.prototype.toArrayBuffer=function(){if((this||F).arrayBuffer)return(this||F).arrayBuffer;for(var Le=(this||F).cells,Oe=Me+(this||F).cells.length+1+1,Fe=0,je=0;je<(this||F).cells.length;je++)Fe+=(this||F).cells[je].length;var qe=new Int32Array(Oe+Fe+(this||F).keys.length+(this||F).bboxes.length);qe[0]=(this||F).extent,qe[1]=(this||F).n,qe[2]=(this||F).padding;for(var He=Oe,xt=0;xt<Le.length;xt++){var Pt=Le[xt];qe[Me+xt]=He,qe.set(Pt,He),He+=Pt.length}return qe[Me+Le.length]=He,qe.set((this||F).keys,He),qe[Me+Le.length+1]=He+=(this||F).keys.length,qe.set((this||F).bboxes,He),He+=(this||F).bboxes.length,qe.buffer},cf}(),df=e(uf);const pf={};function us(F,Me,Le={}){Object.defineProperty(F,"_classRegistryKey",{value:Me,writable:!1}),pf[Me]={klass:F,omit:Le.omit||[]}}us(Object,"Object"),df.serialize=function(F,Me){const Le=F.toArrayBuffer();return Me&&Me.add(Le),{buffer:Le}},df.deserialize=function(F){return new df(F.buffer)},Object.defineProperty(df,"name",{value:"Grid"}),us(df,"Grid"),"undefined"!=typeof DOMMatrix&&us(DOMMatrix,"DOMMatrix"),us(Se,"Color"),us(Error,"Error"),us(Qe,"Formatted"),us(Je,"FormattedSection"),us(te,"AJAXError"),us(er,"ResolvedImage"),us(rs,"StylePropertyFunction"),us(Wi,"StyleExpression",{omit:["_evaluator"]}),us(we,"ImageId"),us(tr,"ImageVariant"),us(ts,"ZoomDependentExpression"),us(Qi,"ZoomConstantExpression"),us(gr,"CompoundExpression",{omit:["_evaluate"]});for(const F in lf)pf[lf[F]._classRegistryKey]||us(lf[F],`Expression${F}`);function cs(F){return F&&"undefined"!=typeof ArrayBuffer&&(F instanceof ArrayBuffer||F.constructor&&"ArrayBuffer"===F.constructor.name)}function hs(F){return self.ImageBitmap&&F instanceof ImageBitmap}function ps(F,Me){if(null==F||"boolean"==typeof F||"number"==typeof F||"string"==typeof F||F instanceof Boolean||F instanceof Number||F instanceof String||F instanceof Date||F instanceof RegExp)return F;if(cs(F)||hs(F))return Me&&Me.add(F),F;if(ArrayBuffer.isView(F))return Me&&Me.add(F.buffer),F;if(F instanceof ImageData)return Me&&Me.add(F.data.buffer),F;if(Array.isArray(F)){const Le=[];for(const Oe of F)Le.push(ps(Oe,Me));return Le}if(F instanceof Map){const Me={$name:"Map",entries:[]};for(const[Le,Oe]of F.entries())Me.entries.push(ps(Le),ps(Oe));return Me}if(F instanceof Set){const Me={$name:"Set"};let Le=0;for(const Oe of F.values())Me[++Le]=ps(Oe);return Me}if(F instanceof DOMMatrix){const Me={$name:"DOMMatrix"},Le=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const Oe of Le)Me[Oe]=F[Oe];return Me}if("bigint"==typeof F)return{$name:"BigInt",value:F.toString()};if("object"==typeof F){const Le=F.constructor,Oe=Le._classRegistryKey;if(!Oe)throw new Error(`Can't serialize object of unregistered class "${Le.name}".`);const Fe=Le.serialize?Le.serialize(F,Me):{};if(!Le.serialize){for(const Le in F)F.hasOwnProperty(Le)&&(pf[Oe].omit.indexOf(Le)>=0||(Fe[Le]=ps(F[Le],Me)));F instanceof Error&&(Fe.message=F.message)}if(Fe.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==Oe&&(Fe.$name=Oe),Fe}throw new Error("can't serialize object of type "+typeof F)}function fs(F){if(null==F||"boolean"==typeof F||"number"==typeof F||"string"==typeof F||F instanceof Boolean||F instanceof Number||F instanceof String||F instanceof Date||F instanceof RegExp||cs(F)||hs(F)||ArrayBuffer.isView(F)||F instanceof ImageData)return F;if(Array.isArray(F))return F.map(fs);if("object"==typeof F){const Me=F.$name||"Object";if("Map"===Me){const Me=F.entries||[],Le=new Map;for(let F=0;F<Me.length;F+=2)Le.set(fs(Me[F]),fs(Me[F+1]));return Le}if("Set"===Me){const Me=new Set;for(const Le of Object.keys(F))"$name"!==Le&&Me.add(fs(F[Le]));return Me}if("DOMMatrix"===Me){let Me;return Me=F.is2D?[F.a,F.b,F.c,F.d,F.e,F.f]:[F.m11,F.m12,F.m13,F.m14,F.m21,F.m22,F.m23,F.m24,F.m31,F.m32,F.m33,F.m34,F.m41,F.m42,F.m43,F.m44],new DOMMatrix(Me)}if("BigInt"===Me)return BigInt(F.value);const{klass:Le}=pf[Me];if(!Le)throw new Error(`Can't deserialize unregistered class "${Me}".`);if(Le.deserialize)return Le.deserialize(F);const Oe=Object.create(Le.prototype);for(const Me of Object.keys(F))"$name"!==Me&&(Oe[Me]=fs(F[Me]));return Oe}throw new Error("can't deserialize object of type "+typeof F)}const ff={"Latin-1 Supplement":F=>F>=128&&F<=255,Arabic:F=>F>=1536&&F<=1791,"Arabic Supplement":F=>F>=1872&&F<=1919,"Arabic Extended-A":F=>F>=2208&&F<=2303,"Hangul Jamo":F=>F>=4352&&F<=4607,"Unified Canadian Aboriginal Syllabics":F=>F>=5120&&F<=5759,Khmer:F=>F>=6016&&F<=6143,"Unified Canadian Aboriginal Syllabics Extended":F=>F>=6320&&F<=6399,"General Punctuation":F=>F>=8192&&F<=8303,"Letterlike Symbols":F=>F>=8448&&F<=8527,"Number Forms":F=>F>=8528&&F<=8591,"Miscellaneous Technical":F=>F>=8960&&F<=9215,"Control Pictures":F=>F>=9216&&F<=9279,"Optical Character Recognition":F=>F>=9280&&F<=9311,"Enclosed Alphanumerics":F=>F>=9312&&F<=9471,"Geometric Shapes":F=>F>=9632&&F<=9727,"Miscellaneous Symbols":F=>F>=9728&&F<=9983,"Miscellaneous Symbols and Arrows":F=>F>=11008&&F<=11263,"CJK Radicals Supplement":F=>F>=11904&&F<=12031,"Kangxi Radicals":F=>F>=12032&&F<=12255,"Ideographic Description Characters":F=>F>=12272&&F<=12287,"CJK Symbols and Punctuation":F=>F>=12288&&F<=12351,Hiragana:F=>F>=12352&&F<=12447,Katakana:F=>F>=12448&&F<=12543,Bopomofo:F=>F>=12544&&F<=12591,"Hangul Compatibility Jamo":F=>F>=12592&&F<=12687,Kanbun:F=>F>=12688&&F<=12703,"Bopomofo Extended":F=>F>=12704&&F<=12735,"CJK Strokes":F=>F>=12736&&F<=12783,"Katakana Phonetic Extensions":F=>F>=12784&&F<=12799,"Enclosed CJK Letters and Months":F=>F>=12800&&F<=13055,"CJK Compatibility":F=>F>=13056&&F<=13311,"CJK Unified Ideographs Extension A":F=>F>=13312&&F<=19903,"Yijing Hexagram Symbols":F=>F>=19904&&F<=19967,"CJK Unified Ideographs":F=>F>=19968&&F<=40959,"Yi Syllables":F=>F>=40960&&F<=42127,"Yi Radicals":F=>F>=42128&&F<=42191,"Hangul Jamo Extended-A":F=>F>=43360&&F<=43391,"Hangul Syllables":F=>F>=44032&&F<=55215,"Hangul Jamo Extended-B":F=>F>=55216&&F<=55295,"Private Use Area":F=>F>=57344&&F<=63743,"CJK Compatibility Ideographs":F=>F>=63744&&F<=64255,"Arabic Presentation Forms-A":F=>F>=64336&&F<=65023,"Vertical Forms":F=>F>=65040&&F<=65055,"CJK Compatibility Forms":F=>F>=65072&&F<=65103,"Small Form Variants":F=>F>=65104&&F<=65135,"Arabic Presentation Forms-B":F=>F>=65136&&F<=65279,"Halfwidth and Fullwidth Forms":F=>F>=65280&&F<=65519,Osage:F=>F>=66736&&F<=66815,"CJK Unified Ideographs Extension B":F=>F>=131072&&F<=173791};function ms(F){for(const Me of F)if(xs(Me.charCodeAt(0)))return!0;return!1}function ys(F){for(const Me of F)if(!gs(Me.charCodeAt(0)))return!1;return!0}function gs(F){return!(ff.Arabic(F)||ff["Arabic Supplement"](F)||ff["Arabic Extended-A"](F)||ff["Arabic Presentation Forms-A"](F)||ff["Arabic Presentation Forms-B"](F))}function xs(F){return!(746!==F&&747!==F&&(F<4352||!(ff["Bopomofo Extended"](F)||ff.Bopomofo(F)||ff["CJK Compatibility Forms"](F)&&!(F>=65097&&F<=65103)||ff["CJK Compatibility Ideographs"](F)||ff["CJK Compatibility"](F)||ff["CJK Radicals Supplement"](F)||ff["CJK Strokes"](F)||!(!ff["CJK Symbols and Punctuation"](F)||F>=12296&&F<=12305||F>=12308&&F<=12319||12336===F)||ff["CJK Unified Ideographs Extension A"](F)||ff["CJK Unified Ideographs"](F)||ff["Enclosed CJK Letters and Months"](F)||ff["Hangul Compatibility Jamo"](F)||ff["Hangul Jamo Extended-A"](F)||ff["Hangul Jamo Extended-B"](F)||ff["Hangul Jamo"](F)||ff["Hangul Syllables"](F)||ff.Hiragana(F)||ff["Ideographic Description Characters"](F)||ff.Kanbun(F)||ff["Kangxi Radicals"](F)||ff["Katakana Phonetic Extensions"](F)||ff.Katakana(F)&&12540!==F||!(!ff["Halfwidth and Fullwidth Forms"](F)||65288===F||65289===F||65293===F||F>=65306&&F<=65310||65339===F||65341===F||65343===F||F>=65371&&F<=65503||65507===F||F>=65512&&F<=65519)||!(!ff["Small Form Variants"](F)||F>=65112&&F<=65118||F>=65123&&F<=65126)||ff["Unified Canadian Aboriginal Syllabics"](F)||ff["Unified Canadian Aboriginal Syllabics Extended"](F)||ff["Vertical Forms"](F)||ff["Yijing Hexagram Symbols"](F)||ff["Yi Syllables"](F)||ff["Yi Radicals"](F))))}function vs(F){return!(xs(F)||function(F){return!!(ff["Latin-1 Supplement"](F)&&(167===F||169===F||174===F||177===F||188===F||189===F||190===F||215===F||247===F)||ff["General Punctuation"](F)&&(8214===F||8224===F||8225===F||8240===F||8241===F||8251===F||8252===F||8258===F||8263===F||8264===F||8265===F||8273===F)||ff["Letterlike Symbols"](F)||ff["Number Forms"](F)||ff["Miscellaneous Technical"](F)&&(F>=8960&&F<=8967||F>=8972&&F<=8991||F>=8996&&F<=9e3||9003===F||F>=9085&&F<=9114||F>=9150&&F<=9165||9167===F||F>=9169&&F<=9179||F>=9186&&F<=9215)||ff["Control Pictures"](F)&&9251!==F||ff["Optical Character Recognition"](F)||ff["Enclosed Alphanumerics"](F)||ff["Geometric Shapes"](F)||ff["Miscellaneous Symbols"](F)&&!(F>=9754&&F<=9759)||ff["Miscellaneous Symbols and Arrows"](F)&&(F>=11026&&F<=11055||F>=11088&&F<=11097||F>=11192&&F<=11243)||ff["CJK Symbols and Punctuation"](F)||ff.Katakana(F)||ff["Private Use Area"](F)||ff["CJK Compatibility Forms"](F)||ff["Small Form Variants"](F)||ff["Halfwidth and Fullwidth Forms"](F)||8734===F||8756===F||8757===F||F>=9984&&F<=10087||F>=10102&&F<=10131||65532===F||65533===F)}(F))}function bs(F){return ff.Arabic(F)||ff["Arabic Supplement"](F)||ff["Arabic Extended-A"](F)||ff["Arabic Presentation Forms-A"](F)||ff["Arabic Presentation Forms-B"](F)}function _s(F){return F>=1424&&F<=2303||ff["Arabic Presentation Forms-A"](F)||ff["Arabic Presentation Forms-B"](F)}function ws(F,Me){return!(!Me&&_s(F)||F>=2304&&F<=3583||F>=3840&&F<=4255||ff.Khmer(F))}function Ms(F){for(const Me of F)if(_s(Me.charCodeAt(0)))return!0;return!1}const mf="deferred",gf="loading",yf="loaded";let xf=null,Tf="unavailable",Ef=null;const ks=function(F){F&&"string"==typeof F&&F.indexOf("NetworkError")>-1&&(Tf="error"),xf&&xf(F)};function Ts(){Mf.fire(new ge("pluginStateChange",{pluginStatus:Tf,pluginURL:Ef}))}const Mf=new _e,Vs=function(){return Tf},Cs=function(){if(Tf!==mf||!Ef)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Tf=gf,Ts(),Ef&&ne({url:Ef},(F=>{F?ks(F):(Tf=yf,Ts())}))},If={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Tf===yf||null!=If.applyArabicShaping,isLoading:()=>Tf===gf,setState(F){Tf=F.pluginStatus,Ef=F.pluginURL},isParsed:()=>null!=If.applyArabicShaping&&null!=If.processBidirectionalText&&null!=If.processStyledBidirectionalText,getPluginURL:()=>Ef};class Rs{constructor(F,Me){this.zoom=F,Me?(this.now=Me.now,this.fadeDuration=Me.fadeDuration,this.transition=Me.transition,this.pitch=Me.pitch,this.brightness=Me.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(F){return function(F,Me){for(const Le of F)if(!ws(Le.charCodeAt(0),Me))return!1;return!0}(F,If.isLoaded())}}class Ls{constructor(F,Me,Le,Oe){this.property=F,this.value=Me,this.expression=function(F,Me,Le,Oe){if(ji(F))return new rs(F,Me);if(Ki(F)||Array.isArray(F)&&F.length>0){const Fe=es(F,Me,Le,Oe);if("error"===Fe.result)throw new Error(Fe.value.map((F=>`${F.key}: ${F.message}`)).join(", "));return Fe.value}{let Le=F;return"string"==typeof F&&"color"===Me.type&&(Le=Se.parse(F)),{kind:"constant",configDependencies:new Set,evaluate:()=>Le}}}(void 0===Me?F.specification.default:Me,F.specification,Le,Oe)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(F,Me,Le){return this.property.possiblyEvaluate(this,F,Me,Le)}}class Fs{constructor(F,Me,Le){this.property=F,this.value=new Ls(F,void 0,Me,Le)}transitioned(F,Me){return new Ns(this.property,this.value,Me,nt({},F.transition,this.transition),F.now)}untransitioned(){return new Ns(this.property,this.value,null,{},0)}}class Os{constructor(F,Me,Le){this._properties=F,this._values=Object.create(F.defaultTransitionablePropertyValues),this._scope=Me,this._options=Le,this.configDependencies=new Set}getValue(F){return ct(this._values[F].value.value)}setValue(F,Me){this._values.hasOwnProperty(F)||(this._values[F]=new Fs(this._values[F].property,this._scope,this._options)),this._values[F].value=new Ls(this._values[F].property,null===Me?void 0:ct(Me),this._scope,this._options),this._values[F].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[F].value.expression.configDependencies]))}setTransitionOrValue(F,Me){Me&&(this._options=Me);const Le=this._properties.properties;if(F)for(const Me in F){const Oe=F[Me];if(Me.endsWith("-transition")){const F=Me.slice(0,-11);Le[F]&&this.setTransition(F,Oe)}else Le.hasOwnProperty(Me)&&this.setValue(Me,Oe)}}getTransition(F){return ct(this._values[F].transition)}setTransition(F,Me){this._values.hasOwnProperty(F)||(this._values[F]=new Fs(this._values[F].property)),this._values[F].transition=ct(Me)||void 0}serialize(){const F={};for(const Me of Object.keys(this._values)){const Le=this.getValue(Me);void 0!==Le&&(F[Me]=Le);const Oe=this.getTransition(Me);void 0!==Oe&&(F[`${Me}-transition`]=Oe)}return F}transitioned(F,Me){const Le=new Us(this._properties);for(const Oe of Object.keys(this._values))Le._values[Oe]=this._values[Oe].transitioned(F,Me._values[Oe]);return Le}untransitioned(){const F=new Us(this._properties);for(const Me of Object.keys(this._values))F._values[Me]=this._values[Me].untransitioned();return F}}class Ns{constructor(F,Me,Le,Oe,Fe){const je=Oe.delay||0,qe=Oe.duration||0;Fe=Fe||0,this.property=F,this.value=Me,this.begin=Fe+je,this.end=this.begin+qe,F.specification.transition&&(Oe.delay||Oe.duration)&&(this.prior=Le)}possiblyEvaluate(F,Me,Le){const Oe=F.now||0,Fe=this.value.possiblyEvaluate(F,Me,Le),je=this.prior;if(je){if(Oe>this.end)return this.prior=null,Fe;if(this.value.isDataDriven())return this.prior=null,Fe;if(Oe<this.begin)return je.possiblyEvaluate(F,Me,Le);{const qe=(Oe-this.begin)/(this.end-this.begin);return this.property.interpolate(je.possiblyEvaluate(F,Me,Le),Fe,W(qe))}}return Fe}}class Us{constructor(F){this._properties=F,this._values=Object.create(F.defaultTransitioningPropertyValues)}possiblyEvaluate(F,Me,Le){const Oe=new $s(this._properties);for(const Fe of Object.keys(this._values))Oe._values[Fe]=this._values[Fe].possiblyEvaluate(F,Me,Le);return Oe}hasTransition(){for(const F of Object.keys(this._values))if(this._values[F].prior)return!0;return!1}}class js{constructor(F,Me,Le){this._properties=F,this._values=Object.create(F.defaultPropertyValues),this._scope=Me,this._options=Le,this.configDependencies=new Set}getValue(F){return ct(this._values[F].value)}setValue(F,Me){this._values[F]=new Ls(this._values[F].property,null===Me?void 0:ct(Me),this._scope,this._options),this._values[F].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[F].expression.configDependencies]))}serialize(){const F={};for(const Me of Object.keys(this._values)){const Le=this.getValue(Me);void 0!==Le&&(F[Me]=Le)}return F}possiblyEvaluate(F,Me,Le){const Oe=new $s(this._properties);for(const Fe of Object.keys(this._values))Oe._values[Fe]=this._values[Fe].possiblyEvaluate(F,Me,Le);return Oe}}class qs{constructor(F,Me,Le){this.property=F,this.value=Me,this.parameters=Le}isConstant(){return"constant"===this.value.kind}constantOr(F){return"constant"===this.value.kind?this.value.value:F}evaluate(F,Me,Le,Oe){return this.property.evaluate(this.value,this.parameters,F,Me,Le,Oe)}}class $s{constructor(F){this._properties=F,this._values=Object.create(F.defaultPossiblyEvaluatedValues)}get(F){return this._values[F]}}class Gs{constructor(F){this.specification=F}possiblyEvaluate(F,Me){return F.expression.evaluate(Me)}interpolate(F,Me,Le){const Oe=mu[this.specification.type];return Oe?Oe(F,Me,Le):F}}class Ys{constructor(F,Me){this.specification=F,this.overrides=Me}possiblyEvaluate(F,Me,Le,Oe){return new qs(this,"constant"===F.expression.kind||"camera"===F.expression.kind?{kind:"constant",value:F.expression.evaluate(Me,null,{},Le,Oe)}:F.expression,Me)}interpolate(F,Me,Le){if("constant"!==F.value.kind||"constant"!==Me.value.kind)return F;if(void 0===F.value.value||void 0===Me.value.value)return new qs(this,{kind:"constant",value:void 0},F.parameters);const Oe=mu[this.specification.type];return Oe?new qs(this,{kind:"constant",value:Oe(F.value.value,Me.value.value,Le)},F.parameters):F}evaluate(F,Me,Le,Oe,Fe,je){return"constant"===F.kind?F.value:F.evaluate(Me,Le,Oe,Fe,je)}}class Hs{constructor(F){this.specification=F}possiblyEvaluate(F,Me,Le,Oe){return!!F.expression.evaluate(Me,null,{},Le,Oe)}interpolate(){return!1}}class Xs{constructor(F){this.properties=F,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const Me=new Rs(0,{});for(const Le in F){const Oe=F[Le];Oe.specification.overridable&&this.overridableProperties.push(Le);const Fe=this.defaultPropertyValues[Le]=new Ls(Oe,void 0),je=this.defaultTransitionablePropertyValues[Le]=new Fs(Oe);this.defaultTransitioningPropertyValues[Le]=je.untransitioned(),this.defaultPossiblyEvaluatedValues[Le]=Fe.possiblyEvaluate(Me)}}}us(Ys,"DataDrivenProperty"),us(Gs,"DataConstantProperty"),us(Hs,"ColorRampProperty");var Cf=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"iconsets":{"experimental":true,"type":"iconsets"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"experimental":true,"type":"*"},"selectors":{"experimental":true,"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"experimental":true,"type":"string","required":true},"properties":{"experimental":true,"type":"selectorProperty","required":false},"featureNamespace":{"experimental":true,"type":"string","required":false},"_uniqueFeatureID":{"experimental":true,"type":"boolean","private":true,"required":false}},"selectorProperty":{"experimental":true,"*":{"experimental":true,"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"required":true,"type":"enum","values":{"sprite":1}},"url":{"required":true,"type":"string"}},"iconset_source":{"type":{"required":true,"type":"enum","values":{"source":1}},"source":{"required":true,"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","experimental":true,"private":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","experimental":true,"private":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","transition":true,"experimental":true,"private":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"*"}}}');function Ws(F){return F instanceof Number||F instanceof String||F instanceof Boolean?F.valueOf():F}function Ks(F){if(Array.isArray(F))return F.map(Ks);if(F instanceof Object&&!(F instanceof Number||F instanceof String||F instanceof Boolean)){const Me={};for(const Le in F)Me[Le]=Ks(F[Le]);return Me}return Ws(F)}function Js(F){if(!0===F||!1===F)return!0;if(!Array.isArray(F)||0===F.length)return!1;switch(F[0]){case"has":return F.length>=2&&"$id"!==F[1]&&"$type"!==F[1];case"in":return F.length>=3&&("string"!=typeof F[1]||Array.isArray(F[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==F.length||Array.isArray(F[1])||Array.isArray(F[2]);case"any":case"all":for(const Me of F.slice(1))if(!Js(Me)&&"boolean"!=typeof Me)return!1;return!0;default:return!0}}function Qs(F,Me="",Le=null,Oe="fill"){if(null==F)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Js(F)||(F=aa(F));const Fe=F;let je=!0;try{je=function(F){if(!ra(F))return F;let Me=Ks(F);return ea(Me),Me=ta(Me),Me}(Fe)}catch(F){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(Fe,null,2)}\n        `)}let qe=null,He=null;if("background"!==Oe&&"sky"!==Oe&&"slot"!==Oe){He=Cf[`filter_${Oe}`];const F=Ji(je,He,Me,Le);if("error"===F.result)throw new Error(F.value.map((F=>`${F.key}: ${F.message}`)).join(", "));qe=(Me,Le,Oe)=>F.value.evaluate(Me,Le,{},Oe)}let xt=null,Pt=null;if(je!==Fe){const F=Ji(Fe,He,Me,Le);if("error"===F.result)throw new Error(F.value.map((F=>`${F.key}: ${F.message}`)).join(", "));xt=(Me,Le,Oe,Fe,je)=>F.value.evaluate(Me,Le,{},Oe,void 0,void 0,Fe,je),Pt=!Bn(F.value.expression)}return{filter:qe,dynamicFilter:xt||void 0,needGeometry:sa(je),needFeature:!!Pt}}function ta(F){if(!Array.isArray(F))return F;const Me=function(F){if(zf.has(F[0]))for(let Me=1;Me<F.length;Me++)if(ra(F[Me]))return!0;return F}(F);return!0===Me?Me:Me.map((F=>ta(F)))}function ea(F){let Me=!1;const Le=[];if("case"===F[0]){for(let Oe=1;Oe<F.length-1;Oe+=2)Me=Me||ra(F[Oe]),Le.push(F[Oe+1]);Le.push(F[F.length-1])}else if("match"===F[0]){Me=Me||ra(F[1]);for(let Me=2;Me<F.length-1;Me+=2)Le.push(F[Me+1]);Le.push(F[F.length-1])}else if("step"===F[0]){Me=Me||ra(F[1]);for(let Me=1;Me<F.length-1;Me+=2)Le.push(F[Me+1])}Me&&(F.length=0,F.push("any",...Le));for(let Me=1;Me<F.length;Me++)ea(F[Me])}function ra(F){if(!Array.isArray(F))return!1;if("pitch"===(Me=F[0])||"distance-from-center"===Me)return!0;var Me;for(let Me=1;Me<F.length;Me++)if(ra(F[Me]))return!0;return!1}const zf=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function ia(F,Me){return F<Me?-1:F>Me?1:0}function sa(F){if(!Array.isArray(F))return!1;if("within"===F[0]||"distance"===F[0])return!0;for(let Me=1;Me<F.length;Me++)if(sa(F[Me]))return!0;return!1}function aa(F){if(!F)return!0;const Me=F[0];return F.length<=1?"any"!==Me:"=="===Me?oa(F[1],F[2],"=="):"!="===Me?ca(oa(F[1],F[2],"==")):"<"===Me||">"===Me||"<="===Me||">="===Me?oa(F[1],F[2],Me):"any"===Me?(Le=F.slice(1),["any"].concat(Le.map(aa))):"all"===Me?["all"].concat(F.slice(1).map(aa)):"none"===Me?["all"].concat(F.slice(1).map(aa).map(ca)):"in"===Me?la(F[1],F.slice(2)):"!in"===Me?ca(la(F[1],F.slice(2))):"has"===Me?ua(F[1]):"!has"!==Me||ca(ua(F[1]));var Le}function oa(F,Me,Le){switch(F){case"$type":return[`filter-type-${Le}`,Me];case"$id":return[`filter-id-${Le}`,Me];default:return[`filter-${Le}`,F,Me]}}function la(F,Me){if(0===Me.length)return!1;switch(F){case"$type":return["filter-type-in",["literal",Me]];case"$id":return["filter-id-in",["literal",Me]];default:return Me.length>200&&!Me.some((F=>typeof F!=typeof Me[0]))?["filter-in-large",F,["literal",Me.sort(ia)]]:["filter-in-small",F,["literal",Me]]}}function ua(F){switch(F){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",F]}}function ca(F){return["!",F]}const Df="";function pa(F,Me){return Me?`${F}${Df}${Me}`:F}const Of="-transition",kf=new Set(["fill","line","background","hillshade","raster"]);class ma extends _e{constructor(F,Me,Le,Oe,Fe){if(super(),this.id=F.id,this.fqid=pa(this.id,Le),this.type=F.type,this.scope=Le,this.lut=Oe,this.options=Fe,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,"custom"!==F.type){if(this.metadata=F.metadata,this.minzoom=F.minzoom,this.maxzoom=F.maxzoom,F.type&&"background"!==F.type&&"sky"!==F.type&&"slot"!==F.type){this.source=F.source,this.sourceLayer=F["source-layer"],this.filter=F.filter;const Me=Ji(this.filter,Cf[`filter_${F.type}`]);"error"!==Me.result&&(this.configDependencies=new Set([...this.configDependencies,...Me.value.configDependencies]))}if(F.slot&&(this.slot=F.slot),Me.layout&&(this._unevaluatedLayout=new js(Me.layout,this.scope,Fe),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),Me.paint){this._transitionablePaint=new Os(Me.paint,this.scope,Fe);for(const Me in F.paint)this.setPaintProperty(Me,F.paint[Me]);for(const Me in F.layout)this.setLayoutProperty(Me,F.layout[Me]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new $s(Me.paint)}}}onAdd(F){}onRemove(F){}isDraped(F){return!this.is3D(!0)&&kf.has(this.type)}getLayoutProperty(F){return"visibility"===F?this.visibility:this._unevaluatedLayout.getValue(F)}setLayoutProperty(F,Me){if("custom"===this.type&&"visibility"===F)return void(this.visibility=Me);const Le=this._unevaluatedLayout;Le._properties.properties[F]&&(Le.setValue(F,Me),this.configDependencies=new Set([...this.configDependencies,...Le.configDependencies]),"visibility"===F&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(F){return F.endsWith(Of)?this._transitionablePaint.getTransition(F.slice(0,-11)):this._transitionablePaint.getValue(F)}setPaintProperty(F,Me){const Le=this._transitionablePaint,Oe=Le._properties.properties;if(F.endsWith(Of)){const Fe=F.slice(0,-11);return Oe[Fe]&&Le.setTransition(Fe,Me||void 0),!1}if(!Oe[F])return!1;const Fe=Le._values[F],je=Fe.value.isDataDriven(),qe=Fe.value;Le.setValue(F,Me),this.configDependencies=new Set([...this.configDependencies,...Le.configDependencies]),this._handleSpecialPaintPropertyUpdate(F);const He=Le._values[F].value,xt=He.isDataDriven(),Pt=F.endsWith("pattern")||"line-dasharray"===F;return xt||je||Pt||this._handleOverridablePaintPropertyUpdate(F,qe,He)}_handleSpecialPaintPropertyUpdate(F){}getProgramIds(){return null}getDefaultProgramParams(F,Me,Le){return null}_handleOverridablePaintPropertyUpdate(F,Me,Le){return!1}isHidden(F){return!!(this.minzoom&&F<this.minzoom)||!!(this.maxzoom&&F>=this.maxzoom)||"none"===this.visibility}updateTransitions(F){this._transitioningPaint=this._transitionablePaint.transitioned(F,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(F,Me){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(F,void 0,Me)),this.paint=this._transitioningPaint.possiblyEvaluate(F,void 0,Me)}serialize(){return ut({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((F,Me)=>!(void 0===F||"layout"===Me&&!Object.keys(F).length||"paint"===Me&&!Object.keys(F).length)))}is3D(F){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const F in this.paint._values){const Me=this.paint.get(F);if(Me instanceof qs&&Fi(Me.property.specification)&&("source"===Me.value.kind||"composite"===Me.value.kind)&&Me.value.isStateDependent)return!0}return!1}compileFilter(F){this._filterCompiled||(this._featureFilter=Qs(this.filter,this.scope,F),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(F){this._stats&&("shadow"===F.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(F){}queryIntersectsFeature(F,Me,Le,Oe,Fe,je,qe,He,xt){}}const Nf={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ga{constructor(F,Me){this._structArray=F,this._pos1=Me*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class xa{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(F,Me){return F._trim(),Me&&(F.isTransferred=!0,Me.add(F.arrayBuffer)),{length:F.length,arrayBuffer:F.arrayBuffer}}static deserialize(F){const Me=Object.create(this.prototype);return Me.arrayBuffer=F.arrayBuffer,Me.length=F.length,Me.capacity=F.arrayBuffer.byteLength/Me.bytesPerElement,Me._refreshViews(),Me}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(F){this.reserve(F),this.length=F}reserve(F){if(F>this.capacity){this.capacity=Math.max(F,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const Me=this.uint8;this._refreshViews(),Me&&this.uint8.set(Me)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...F){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...F){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function va(F,Me=1){let Le=0,Oe=0;return{members:F.map((F=>{const Fe=Nf[F.type].BYTES_PER_ELEMENT,je=Le=ba(Le,Math.max(Me,Fe)),qe=F.components||1;return Oe=Math.max(Oe,Fe),Le+=Fe*qe,{name:F.name,type:F.type,components:qe,offset:je}})),size:ba(Le,Math.max(Oe,Me)),alignment:Me}}function ba(F,Me){return Math.ceil(F/Me)*Me}class _a extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Me){const Le=this.length;return this.resize(Le+1),this.emplace(Le,F,Me)}emplace(F,Me,Le){const Oe=2*F;return this.int16[Oe+0]=Me,this.int16[Oe+1]=Le,F}}_a.prototype.bytesPerElement=4,us(_a,"StructArrayLayout2i4");class wa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Me,Le){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Me,Le)}emplace(F,Me,Le,Oe){const Fe=3*F;return this.int16[Fe+0]=Me,this.int16[Fe+1]=Le,this.int16[Fe+2]=Oe,F}}wa.prototype.bytesPerElement=6,us(wa,"StructArrayLayout3i6");class Ma extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Me,Le,Oe)}emplace(F,Me,Le,Oe,Fe){const je=4*F;return this.int16[je+0]=Me,this.int16[je+1]=Le,this.int16[je+2]=Oe,this.int16[je+3]=Fe,F}}Ma.prototype.bytesPerElement=8,us(Ma,"StructArrayLayout4i8");class Aa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F){const Me=this.length;return this.resize(Me+1),this.emplace(Me,F)}emplace(F,Me){return this.float32[1*F+0]=Me,F}}Aa.prototype.bytesPerElement=4,us(Aa,"StructArrayLayout1f4");class Ia extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Me,Le)}emplace(F,Me,Le,Oe){const Fe=4*F,je=2*F;return this.int16[Fe+0]=Me,this.int16[Fe+1]=Le,this.float32[je+1]=Oe,F}}Ia.prototype.bytesPerElement=8,us(Ia,"StructArrayLayout2i1f8");class Sa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Me,Le){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Me,Le)}emplace(F,Me,Le,Oe){const Fe=4*F;return this.int16[Fe+0]=Me,this.int16[Fe+1]=Le,this.int16[Fe+2]=Oe,F}}Sa.prototype.bytesPerElement=8,us(Sa,"StructArrayLayout3i8");class Pa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,F,Me,Le,Oe,Fe)}emplace(F,Me,Le,Oe,Fe,je){const qe=5*F;return this.int16[qe+0]=Me,this.int16[qe+1]=Le,this.int16[qe+2]=Oe,this.int16[qe+3]=Fe,this.int16[qe+4]=je,F}}Pa.prototype.bytesPerElement=10,us(Pa,"StructArrayLayout5i10");class Ea extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe){const He=this.length;return this.resize(He+1),this.emplace(He,F,Me,Le,Oe,Fe,je,qe)}emplace(F,Me,Le,Oe,Fe,je,qe,He){const xt=6*F,Pt=12*F,jt=3*F;return this.int16[xt+0]=Me,this.int16[xt+1]=Le,this.uint8[Pt+4]=Oe,this.uint8[Pt+5]=Fe,this.uint8[Pt+6]=je,this.uint8[Pt+7]=qe,this.float32[jt+2]=He,F}}Ea.prototype.bytesPerElement=12,us(Ea,"StructArrayLayout2i4ub1f12");class za extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Me,Le)}emplace(F,Me,Le,Oe){const Fe=3*F;return this.float32[Fe+0]=Me,this.float32[Fe+1]=Le,this.float32[Fe+2]=Oe,F}}za.prototype.bytesPerElement=12,us(za,"StructArrayLayout3f12");class ka extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,F,Me,Le,Oe,Fe)}emplace(F,Me,Le,Oe,Fe,je){const qe=6*F,He=3*F;return this.uint16[qe+0]=Me,this.uint16[qe+1]=Le,this.uint16[qe+2]=Oe,this.uint16[qe+3]=Fe,this.float32[He+2]=je,F}}ka.prototype.bytesPerElement=12,us(ka,"StructArrayLayout4ui1f12");class Ta extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Me,Le,Oe)}emplace(F,Me,Le,Oe,Fe){const je=4*F;return this.uint16[je+0]=Me,this.uint16[je+1]=Le,this.uint16[je+2]=Oe,this.uint16[je+3]=Fe,F}}Ta.prototype.bytesPerElement=8,us(Ta,"StructArrayLayout4ui8");class Ba extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Me,Le,Oe,Fe,je)}emplace(F,Me,Le,Oe,Fe,je,qe){const He=6*F;return this.int16[He+0]=Me,this.int16[He+1]=Le,this.int16[He+2]=Oe,this.int16[He+3]=Fe,this.int16[He+4]=je,this.int16[He+5]=qe,F}}Ba.prototype.bytesPerElement=12,us(Ba,"StructArrayLayout6i12");class Va extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt){const bi=this.length;return this.resize(bi+1),this.emplace(bi,F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt)}emplace(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi){const wi=12*F;return this.int16[wi+0]=Me,this.int16[wi+1]=Le,this.int16[wi+2]=Oe,this.int16[wi+3]=Fe,this.uint16[wi+4]=je,this.uint16[wi+5]=qe,this.uint16[wi+6]=He,this.uint16[wi+7]=xt,this.int16[wi+8]=Pt,this.int16[wi+9]=jt,this.int16[wi+10]=Gt,this.int16[wi+11]=bi,F}}Va.prototype.bytesPerElement=24,us(Va,"StructArrayLayout4i4ui4i24");class Ca extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Me,Le,Oe,Fe,je)}emplace(F,Me,Le,Oe,Fe,je,qe){const He=10*F,xt=5*F;return this.int16[He+0]=Me,this.int16[He+1]=Le,this.int16[He+2]=Oe,this.float32[xt+2]=Fe,this.float32[xt+3]=je,this.float32[xt+4]=qe,F}}Ca.prototype.bytesPerElement=20,us(Ca,"StructArrayLayout3i3f20");class Da extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Me,Le,Oe)}emplace(F,Me,Le,Oe,Fe){const je=4*F;return this.float32[je+0]=Me,this.float32[je+1]=Le,this.float32[je+2]=Oe,this.float32[je+3]=Fe,F}}Da.prototype.bytesPerElement=16,us(Da,"StructArrayLayout4f16");class Ra extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F){const Me=this.length;return this.resize(Me+1),this.emplace(Me,F)}emplace(F,Me){return this.uint32[1*F+0]=Me,F}}Ra.prototype.bytesPerElement=4,us(Ra,"StructArrayLayout1ul4");class La extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Me){const Le=this.length;return this.resize(Le+1),this.emplace(Le,F,Me)}emplace(F,Me,Le){const Oe=2*F;return this.uint16[Oe+0]=Me,this.uint16[Oe+1]=Le,F}}La.prototype.bytesPerElement=4,us(La,"StructArrayLayout2ui4");class Fa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi){const wi=this.length;return this.resize(wi+1),this.emplace(wi,F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi)}emplace(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi){const qr=20*F,Xn=10*F;return this.int16[qr+0]=Me,this.int16[qr+1]=Le,this.int16[qr+2]=Oe,this.int16[qr+3]=Fe,this.int16[qr+4]=je,this.float32[Xn+3]=qe,this.float32[Xn+4]=He,this.float32[Xn+5]=xt,this.float32[Xn+6]=Pt,this.int16[qr+14]=jt,this.uint32[Xn+8]=Gt,this.uint16[qr+18]=bi,this.uint16[qr+19]=wi,F}}Fa.prototype.bytesPerElement=40,us(Fa,"StructArrayLayout5i4f1i1ul2ui40");class Oa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe){const He=this.length;return this.resize(He+1),this.emplace(He,F,Me,Le,Oe,Fe,je,qe)}emplace(F,Me,Le,Oe,Fe,je,qe,He){const xt=8*F;return this.int16[xt+0]=Me,this.int16[xt+1]=Le,this.int16[xt+2]=Oe,this.int16[xt+4]=Fe,this.int16[xt+5]=je,this.int16[xt+6]=qe,this.int16[xt+7]=He,F}}Oa.prototype.bytesPerElement=16,us(Oa,"StructArrayLayout3i2i2i16");class Na extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,F,Me,Le,Oe,Fe)}emplace(F,Me,Le,Oe,Fe,je){const qe=4*F,He=8*F;return this.float32[qe+0]=Me,this.float32[qe+1]=Le,this.float32[qe+2]=Oe,this.int16[He+6]=Fe,this.int16[He+7]=je,F}}Na.prototype.bytesPerElement=16,us(Na,"StructArrayLayout2f1f2i16");class Ua extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Me,Le,Oe,Fe,je)}emplace(F,Me,Le,Oe,Fe,je,qe){const He=20*F,xt=5*F;return this.uint8[He+0]=Me,this.uint8[He+1]=Le,this.float32[xt+1]=Oe,this.float32[xt+2]=Fe,this.float32[xt+3]=je,this.float32[xt+4]=qe,F}}Ua.prototype.bytesPerElement=20,us(Ua,"StructArrayLayout2ub4f20");class ja extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Me,Le){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Me,Le)}emplace(F,Me,Le,Oe){const Fe=3*F;return this.uint16[Fe+0]=Me,this.uint16[Fe+1]=Le,this.uint16[Fe+2]=Oe,F}}ja.prototype.bytesPerElement=6,us(ja,"StructArrayLayout3ui6");class qa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do){const zs=this.length;return this.resize(zs+1),this.emplace(zs,F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do)}emplace(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do,zs){const Zs=30*F,na=15*F,el=60*F;return this.int16[Zs+0]=Me,this.int16[Zs+1]=Le,this.int16[Zs+2]=Oe,this.float32[na+2]=Fe,this.float32[na+3]=je,this.uint16[Zs+8]=qe,this.uint16[Zs+9]=He,this.uint32[na+5]=xt,this.uint32[na+6]=Pt,this.uint32[na+7]=jt,this.uint16[Zs+16]=Gt,this.uint16[Zs+17]=bi,this.uint16[Zs+18]=wi,this.float32[na+10]=qr,this.float32[na+11]=Xn,this.uint8[el+48]=Yn,this.uint8[el+49]=yo,this.uint8[el+50]=bo,this.uint32[na+13]=Ro,this.int16[Zs+28]=Do,this.uint8[el+58]=zs,F}}qa.prototype.bytesPerElement=60,us(qa,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class $a extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do,zs,Zs,na,el,nl,hl,pl,bl,Tl,kl,ec,tc){const ic=this.length;return this.resize(ic+1),this.emplace(ic,F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do,zs,Zs,na,el,nl,hl,pl,bl,Tl,kl,ec,tc)}emplace(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do,zs,Zs,na,el,nl,hl,pl,bl,Tl,kl,ec,tc,ic){const oc=20*F,sc=40*F,ac=80*F;return this.float32[oc+0]=Me,this.float32[oc+1]=Le,this.int16[sc+4]=Oe,this.int16[sc+5]=Fe,this.int16[sc+6]=je,this.int16[sc+7]=qe,this.int16[sc+8]=He,this.int16[sc+9]=xt,this.int16[sc+10]=Pt,this.int16[sc+11]=jt,this.int16[sc+12]=Gt,this.uint16[sc+13]=bi,this.uint16[sc+14]=wi,this.uint16[sc+15]=qr,this.uint16[sc+16]=Xn,this.uint16[sc+17]=Yn,this.uint16[sc+18]=yo,this.uint16[sc+19]=bo,this.uint16[sc+20]=Ro,this.uint16[sc+21]=Do,this.uint16[sc+22]=zs,this.uint16[sc+23]=Zs,this.uint16[sc+24]=na,this.uint16[sc+25]=el,this.uint16[sc+26]=nl,this.uint16[sc+27]=hl,this.uint32[oc+14]=pl,this.float32[oc+15]=bl,this.float32[oc+16]=Tl,this.float32[oc+17]=kl,this.float32[oc+18]=ec,this.uint8[ac+76]=tc,this.uint16[sc+39]=ic,F}}$a.prototype.bytesPerElement=80,us($a,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Ga extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,F,Me,Le,Oe,Fe)}emplace(F,Me,Le,Oe,Fe,je){const qe=5*F;return this.float32[qe+0]=Me,this.float32[qe+1]=Le,this.float32[qe+2]=Oe,this.float32[qe+3]=Fe,this.float32[qe+4]=je,F}}Ga.prototype.bytesPerElement=20,us(Ga,"StructArrayLayout5f20");class Ya extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe){const He=this.length;return this.resize(He+1),this.emplace(He,F,Me,Le,Oe,Fe,je,qe)}emplace(F,Me,Le,Oe,Fe,je,qe,He){const xt=7*F;return this.float32[xt+0]=Me,this.float32[xt+1]=Le,this.float32[xt+2]=Oe,this.float32[xt+3]=Fe,this.float32[xt+4]=je,this.float32[xt+5]=qe,this.float32[xt+6]=He,F}}Ya.prototype.bytesPerElement=28,us(Ya,"StructArrayLayout7f28");class Ha extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt){const Gt=this.length;return this.resize(Gt+1),this.emplace(Gt,F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt)}emplace(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt){const bi=11*F;return this.float32[bi+0]=Me,this.float32[bi+1]=Le,this.float32[bi+2]=Oe,this.float32[bi+3]=Fe,this.float32[bi+4]=je,this.float32[bi+5]=qe,this.float32[bi+6]=He,this.float32[bi+7]=xt,this.float32[bi+8]=Pt,this.float32[bi+9]=jt,this.float32[bi+10]=Gt,F}}Ha.prototype.bytesPerElement=44,us(Ha,"StructArrayLayout11f44");class Xa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt=this.length;return this.resize(Pt+1),this.emplace(Pt,F,Me,Le,Oe,Fe,je,qe,He,xt)}emplace(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt){const jt=9*F;return this.float32[jt+0]=Me,this.float32[jt+1]=Le,this.float32[jt+2]=Oe,this.float32[jt+3]=Fe,this.float32[jt+4]=je,this.float32[jt+5]=qe,this.float32[jt+6]=He,this.float32[jt+7]=xt,this.float32[jt+8]=Pt,F}}Xa.prototype.bytesPerElement=36,us(Xa,"StructArrayLayout9f36");class Za extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me){const Le=this.length;return this.resize(Le+1),this.emplace(Le,F,Me)}emplace(F,Me,Le){const Oe=2*F;return this.float32[Oe+0]=Me,this.float32[Oe+1]=Le,F}}Za.prototype.bytesPerElement=8,us(Za,"StructArrayLayout2f8");class Wa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Me,Le,Oe)}emplace(F,Me,Le,Oe,Fe){const je=6*F;return this.uint32[3*F+0]=Me,this.uint16[je+2]=Le,this.uint16[je+3]=Oe,this.uint16[je+4]=Fe,F}}Wa.prototype.bytesPerElement=12,us(Wa,"StructArrayLayout1ul3ui12");class Ka extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F){const Me=this.length;return this.resize(Me+1),this.emplace(Me,F)}emplace(F,Me){return this.uint16[1*F+0]=Me,F}}Ka.prototype.bytesPerElement=2,us(Ka,"StructArrayLayout1ui2");class Ja extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn){const Yn=this.length;return this.resize(Yn+1),this.emplace(Yn,F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn)}emplace(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn){const yo=16*F;return this.float32[yo+0]=Me,this.float32[yo+1]=Le,this.float32[yo+2]=Oe,this.float32[yo+3]=Fe,this.float32[yo+4]=je,this.float32[yo+5]=qe,this.float32[yo+6]=He,this.float32[yo+7]=xt,this.float32[yo+8]=Pt,this.float32[yo+9]=jt,this.float32[yo+10]=Gt,this.float32[yo+11]=bi,this.float32[yo+12]=wi,this.float32[yo+13]=qr,this.float32[yo+14]=Xn,this.float32[yo+15]=Yn,F}}Ja.prototype.bytesPerElement=64,us(Ja,"StructArrayLayout16f64");class Qa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Me,Le,Oe,Fe,je,qe){const He=this.length;return this.resize(He+1),this.emplace(He,F,Me,Le,Oe,Fe,je,qe)}emplace(F,Me,Le,Oe,Fe,je,qe,He){const xt=10*F,Pt=5*F;return this.uint16[xt+0]=Me,this.uint16[xt+1]=Le,this.uint16[xt+2]=Oe,this.uint16[xt+3]=Fe,this.float32[Pt+2]=je,this.float32[Pt+3]=qe,this.float32[Pt+4]=He,F}}Qa.prototype.bytesPerElement=20,us(Qa,"StructArrayLayout4ui3f20");class to extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F){const Me=this.length;return this.resize(Me+1),this.emplace(Me,F)}emplace(F,Me){return this.int16[1*F+0]=Me,F}}to.prototype.bytesPerElement=2,us(to,"StructArrayLayout1i2");class eo extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(F){const Me=this.length;return this.resize(Me+1),this.emplace(Me,F)}emplace(F,Me){return this.uint8[1*F+0]=Me,F}}eo.prototype.bytesPerElement=1,us(eo,"StructArrayLayout1ub1");class ro extends ga{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}ro.prototype.size=40;class no extends Fa{get(F){return new ro(this,F)}}us(no,"CollisionBoxArray");class io extends ga{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(F){this._structArray.uint8[this._pos1+49]=F}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(F){this._structArray.uint8[this._pos1+50]=F}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(F){this._structArray.uint32[this._pos4+13]=F}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(F){this._structArray.uint8[this._pos1+58]=F}}io.prototype.size=60;class so extends qa{get(F){return new io(this,F)}}us(so,"PlacedSymbolArray");class ao extends ga{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(F){this._structArray.uint32[this._pos4+14]=F}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(F){this._structArray.float32[this._pos4+18]=F}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}ao.prototype.size=80;class oo extends $a{get(F){return new ao(this,F)}}us(oo,"SymbolInstanceArray");class lo extends Aa{getoffsetX(F){return this.float32[1*F+0]}}us(lo,"GlyphOffsetArray");class uo extends _a{getx(F){return this.int16[2*F+0]}gety(F){return this.int16[2*F+1]}}us(uo,"SymbolLineVertexArray");class co extends ga{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}co.prototype.size=12;class ho extends Wa{get(F){return new co(this,F)}}us(ho,"FeatureIndexArray");class po extends La{geta_centroid_pos0(F){return this.uint16[2*F+0]}geta_centroid_pos1(F){return this.uint16[2*F+1]}}us(po,"FillExtrusionCentroidArray");class fo extends ga{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}fo.prototype.size=6;class mo extends wa{get(F){return new fo(this,F)}}us(mo,"FillExtrusionWallArray");const Gf=va([{name:"a_pos",components:2,type:"Int16"}],4),$f=va([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class xo{constructor(F=[]){this.segments=F}_prepareSegment(F,Me,Le,Oe){let Fe=this.segments[this.segments.length-1];return F>xo.MAX_VERTEX_ARRAY_LENGTH&&pt(`Max vertices per segment is ${xo.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${F}`),(!Fe||Fe.vertexLength+F>xo.MAX_VERTEX_ARRAY_LENGTH||Fe.sortKey!==Oe)&&(Fe={vertexOffset:Me,primitiveOffset:Le,vertexLength:0,primitiveLength:0},void 0!==Oe&&(Fe.sortKey=Oe),this.segments.push(Fe)),Fe}prepareSegment(F,Me,Le,Oe){return this._prepareSegment(F,Me.length,Le.length,Oe)}get(){return this.segments}destroy(){for(const F of this.segments)for(const Me in F.vaos)F.vaos[Me].destroy()}static simpleSegment(F,Me,Le,Oe){return new xo([{vertexOffset:F,primitiveOffset:Me,vertexLength:Le,primitiveLength:Oe,vaos:{},sortKey:0}])}}function vo(F,Me){return 256*(F=Q(Math.floor(F),0,255))+Q(Math.floor(Me),0,255)}xo.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,us(xo,"SegmentVector");const im=va([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),rm=va([{name:"a_dash",components:4,type:"Uint16"}]);class wo{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(F,Me,Le,Oe){this.ids.push(Mo(F)),this.positions.push(Me,Le,Oe)}eachPosition(F,Me){const Le=Mo(F);let Oe=0,Fe=this.ids.length-1;for(;Oe<Fe;){const F=Oe+Fe>>1;this.ids[F]>=Le?Fe=F:Oe=F+1}for(;this.ids[Oe]===Le;)Me(this.positions[3*Oe],this.positions[3*Oe+1],this.positions[3*Oe+2]),Oe++}static serialize(F,Me){const Le=new Float64Array(F.ids),Oe=new Uint32Array(F.positions);return Ao(Le,Oe,0,Le.length-1),Me&&(Me.add(Le.buffer),Me.add(Oe.buffer)),{ids:Le,positions:Oe}}static deserialize(F){const Me=new wo;let Le;Me.ids=F.ids,Me.positions=F.positions;for(const F of Me.ids)F!==Le&&Me.uniqueIds.push(F),Le=F;return Me.indexed=!0,Me}}function Mo(F){const Me=+F;return!isNaN(Me)&&Number.MIN_SAFE_INTEGER<=Me&&Me<=Number.MAX_SAFE_INTEGER?Me:hu(String(F))}function Ao(F,Me,Le,Oe){for(;Le<Oe;){const Fe=F[Le+Oe>>1];let je=Le-1,qe=Oe+1;for(;;){do{je++}while(F[je]<Fe);do{qe--}while(F[qe]>Fe);if(je>=qe)break;Io(F,je,qe),Io(Me,3*je,3*qe),Io(Me,3*je+1,3*qe+1),Io(Me,3*je+2,3*qe+2)}qe-Le<Oe-qe?(Ao(F,Me,Le,qe),Le=qe+1):(Ao(F,Me,qe+1,Oe),Oe=qe)}}function Io(F,Me,Le){const Oe=F[Me];F[Me]=F[Le],F[Le]=Oe}us(wo,"FeaturePositionMap");class So{constructor(F){this.gl=F.gl,this.initialized=!1}fetchUniformLocation(F,Me){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(F,Me),this.initialized=!0),!!this.location}set(F,Me,Le){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Po extends So{constructor(F){super(F),this.current=0}set(F,Me,Le){this.fetchUniformLocation(F,Me)&&this.current!==Le&&(this.current=Le,this.gl.uniform1i(this.location,Le))}}class Eo extends So{constructor(F){super(F),this.current=0}set(F,Me,Le){this.fetchUniformLocation(F,Me)&&this.current!==Le&&(this.current=Le,this.gl.uniform1f(this.location,Le))}}class zo extends So{constructor(F){super(F),this.current=[0,0]}set(F,Me,Le){this.fetchUniformLocation(F,Me)&&(Le[0]===this.current[0]&&Le[1]===this.current[1]||(this.current=Le,this.gl.uniform2f(this.location,Le[0],Le[1])))}}class ko extends So{constructor(F){super(F),this.current=[0,0,0]}set(F,Me,Le){this.fetchUniformLocation(F,Me)&&(Le[0]===this.current[0]&&Le[1]===this.current[1]&&Le[2]===this.current[2]||(this.current=Le,this.gl.uniform3f(this.location,Le[0],Le[1],Le[2])))}}class To extends So{constructor(F){super(F),this.current=[0,0,0,0]}set(F,Me,Le){this.fetchUniformLocation(F,Me)&&(Le[0]===this.current[0]&&Le[1]===this.current[1]&&Le[2]===this.current[2]&&Le[3]===this.current[3]||(this.current=Le,this.gl.uniform4f(this.location,Le[0],Le[1],Le[2],Le[3])))}}class Bo extends So{constructor(F){super(F),this.current=Se.transparent.toRenderColor(null)}set(F,Me,Le){this.fetchUniformLocation(F,Me)&&(Le.r===this.current.r&&Le.g===this.current.g&&Le.b===this.current.b&&Le.a===this.current.a||(this.current=Le,this.gl.uniform4f(this.location,Le.r,Le.g,Le.b,Le.a)))}}const nm=new Float32Array(16);class Co extends So{constructor(F){super(F),this.current=nm}set(F,Me,Le){if(this.fetchUniformLocation(F,Me)){if(Le[12]!==this.current[12]||Le[0]!==this.current[0])return this.current=Le,void this.gl.uniformMatrix4fv(this.location,!1,Le);for(let F=1;F<16;F++)if(Le[F]!==this.current[F]){this.current=Le,this.gl.uniformMatrix4fv(this.location,!1,Le);break}}}}const sm=new Float32Array(9),am=new Float32Array(4);class Lo extends So{constructor(F){super(F),this.current=am}set(F,Me,Le){if(this.fetchUniformLocation(F,Me))for(let F=0;F<4;F++)if(Le[F]!==this.current[F]){this.current=Le,this.gl.uniformMatrix2fv(this.location,!1,Le);break}}}function Fo(F){return[vo(255*F.r,255*F.g),vo(255*F.b,255*F.a)]}class Oo{constructor(F,Me,Le,Oe){this.value=F,this.uniformNames=Me.map((F=>`u_${F}`)),this.type=Le,this.context=Oe}setUniform(F,Me,Le,Oe,Fe){const je=Oe.constantOr(this.value);Me.set(F,Fe,je instanceof Se?je.toRenderColor(this.lutExpression&&"none"===this.lutExpression.value?null:this.context.lut):je)}getBinding(F,Me){return"color"===this.type?new Bo(F):new Eo(F)}}class No{constructor(F,Me){this.uniformNames=Me.map((F=>`u_${F}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(F){this.pixelRatio=F.pixelRatio||1,this.pattern=F.tl.concat(F.br)}setUniform(F,Me,Le,Oe,Fe){const je="u_pattern"===Fe||"u_dash"===Fe?this.pattern:"u_pixel_ratio"===Fe?this.pixelRatio:null;je&&Me.set(F,Fe,je)}getBinding(F,Me){return"u_pattern"===Me||"u_dash"===Me?new To(F):new Eo(F)}}class Uo{constructor(F,Me,Le,Oe){this.expression=F,this.type=Le,this.maxValue=0,this.paintVertexAttributes=Me.map((F=>({name:`a_${F}`,type:"Float32",components:"color"===Le?2:1,offset:0}))),this.paintVertexArray=new Oe}populatePaintArray(F,Me,Le,Oe,Fe,je,qe){const He=this.paintVertexArray.length,xt="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Rs(0,{brightness:je}),Me,{},Fe,Oe,qe):"constant"===this.expression.kind&&this.expression.value,Pt=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:je}),Me,{},Fe,Oe,qe):this.lutExpression.value);this.paintVertexArray.resize(F),this._setPaintValue(He,F,xt,Pt?null:this.context.lut)}updatePaintArray(F,Me,Le,Oe,Fe,je,qe){const He="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:qe},Le,Oe,void 0,Fe):"constant"===this.expression.kind&&this.expression.value,xt=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:qe}),Le,Oe,void 0,Fe):this.lutExpression.value);this._setPaintValue(F,Me,He,xt?null:this.context.lut)}_setPaintValue(F,Me,Le,Oe){if("color"===this.type){const Fe=Fo(Le.toRenderColor(Oe));for(let Le=F;Le<Me;Le++)this.paintVertexArray.emplace(Le,Fe[0],Fe[1])}else{for(let Oe=F;Oe<Me;Oe++)this.paintVertexArray.emplace(Oe,Le);this.maxValue=Math.max(this.maxValue,Math.abs(Le))}}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class jo{constructor(F,Me,Le,Oe,Fe,je){this.expression=F,this.uniformNames=Me.map((F=>`u_${F}_t`)),this.type=Le,this.useIntegerZoom=Oe,this.context=Fe,this.maxValue=0,this.paintVertexAttributes=Me.map((F=>({name:`a_${F}`,type:"Float32",components:"color"===Le?4:2,offset:0}))),this.paintVertexArray=new je}populatePaintArray(F,Me,Le,Oe,Fe,je,qe){const He=this.expression.evaluate(new Rs(this.context.zoom,{brightness:je}),Me,{},Fe,Oe,qe),xt=this.expression.evaluate(new Rs(this.context.zoom+1,{brightness:je}),Me,{},Fe,Oe,qe),Pt=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:je}),Me,{},Fe,Oe,qe):this.lutExpression.value),jt=this.paintVertexArray.length;this.paintVertexArray.resize(F),this._setPaintValue(jt,F,He,xt,Pt?null:this.context.lut)}updatePaintArray(F,Me,Le,Oe,Fe,je,qe){const He=this.expression.evaluate({zoom:this.context.zoom,brightness:qe},Le,Oe,void 0,Fe),xt=this.expression.evaluate({zoom:this.context.zoom+1,brightness:qe},Le,Oe,void 0,Fe),Pt=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:qe}),Le,Oe,void 0,Fe):this.lutExpression.value);this._setPaintValue(F,Me,He,xt,Pt?null:this.context.lut)}_setPaintValue(F,Me,Le,Oe,Fe){if("color"===this.type){const Oe=Fo(Le.toRenderColor(Fe)),je=Fo(Le.toRenderColor(Fe));for(let Le=F;Le<Me;Le++)this.paintVertexArray.emplace(Le,Oe[0],Oe[1],je[0],je[1])}else{for(let Fe=F;Fe<Me;Fe++)this.paintVertexArray.emplace(Fe,Le,Oe);this.maxValue=Math.max(this.maxValue,Math.abs(Le),Math.abs(Oe))}}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(F,Me,Le,Oe,Fe){const je=this.useIntegerZoom?Math.floor(Le.zoom):Le.zoom,qe=Q(this.expression.interpolationFactor(je,this.context.zoom,this.context.zoom+1),0,1);Me.set(F,Fe,qe)}getBinding(F,Me){return new Eo(F)}}class qo{constructor(F,Me,Le,Oe,Fe){this.expression=F,this.layerId=Fe,this.paintVertexAttributes=("array"===Le?rm:im).members;for(let F=0;F<Me.length;++F);this.paintVertexArray=new Oe}populatePaintArray(F,Me,Le,Oe){const Fe=this.paintVertexArray.length;this.paintVertexArray.resize(F),this._setPaintValues(Fe,F,Me.patterns&&Me.patterns[this.layerId],Le)}updatePaintArray(F,Me,Le,Oe,Fe,je,qe){this._setPaintValues(F,Me,Le.patterns&&Le.patterns[this.layerId],je)}_setPaintValues(F,Me,Le,Oe){if(!Oe||!Le)return;const Fe=Oe[Le];if(!Fe)return;const{tl:je,br:qe,pixelRatio:He}=Fe;for(let Le=F;Le<Me;Le++)this.paintVertexArray.emplace(Le,je[0],je[1],qe[0],qe[1],He)}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class $o{constructor(F,Me,Le=()=>!0){this.binders={},this._buffers=[],this.context=Me;const Oe=[];for(const Fe in F.paint._values){const je=F.paint.get(Fe);if(Fe.endsWith("-use-theme"))continue;if(!Le(Fe))continue;if(!(je instanceof qs&&Fi(je.property.specification)))continue;const qe=Ho(Fe,F.type),He=je.value,xt=je.property.specification.type,Pt=!!je.property.useIntegerZoom,jt="line-dasharray"===Fe||Fe.endsWith("pattern"),Gt=F.paint.get(`${Fe}-use-theme`),bi="line-dasharray"===Fe&&"constant"!==F.layout.get("line-cap").value.kind||Gt&&"constant"!==Gt.value.kind;if("constant"!==He.kind||bi)if("source"===He.kind||bi||jt){const Me=Wo(Fe,xt,"source");this.binders[Fe]=jt?new qo(He,qe,xt,Me,F.id):new Uo(He,qe,xt,Me),Oe.push(`/a_${Fe}`)}else{const F=Wo(Fe,xt,"composite");this.binders[Fe]=new jo(He,qe,xt,Pt,Me,F),Oe.push(`/z_${Fe}`)}else this.binders[Fe]=jt?new No(He.value,qe):new Oo(He.value,qe,xt,Me),Oe.push(`/u_${Fe}`);Gt&&(this.binders[Fe].lutExpression=Gt.value)}this.cacheKey=Oe.sort().join("")}getMaxValue(F){const Me=this.binders[F];return Me instanceof Uo||Me instanceof jo?Me.maxValue:0}populatePaintArrays(F,Me,Le,Oe,Fe,je,qe){for(const He in this.binders){const xt=this.binders[He];xt.context=this.context,(xt instanceof Uo||xt instanceof jo||xt instanceof qo)&&xt.populatePaintArray(F,Me,Le,Oe,Fe,je,qe)}}setConstantPatternPositions(F){for(const Me in this.binders){const Le=this.binders[Me];Le instanceof No&&Le.setConstantPatternPositions(F)}}updatePaintArrays(F,Me,Le,Oe,Fe,je,qe,He,xt){let Pt=!1;const jt=Object.keys(F),Gt=0!==jt.length&&!He,bi=Gt?jt:Me.uniqueIds;this.context.lut=Fe.lut;for(const He in this.binders){const jt=this.binders[He];if(jt.context=this.context,(jt instanceof Uo||jt instanceof jo||jt instanceof qo)&&jt.expression&&jt.expression.kind&&"constant"!==jt.expression.kind&&(!0===jt.expression.isStateDependent||!1===jt.expression.isLightConstant)){const wi=Fe.paint.get(He);jt.expression=wi.value;for(const Le of bi){const Fe=F[Le.toString()];Me.eachPosition(Le,((F,Me,Le)=>{const He=Oe.feature(F);jt.updatePaintArray(Me,Le,He,Fe,je,qe,xt)}))}if(!Gt)for(const Me of Le.uniqueIds){const Fe=F[Me.toString()];Le.eachPosition(Me,((F,Me,Le)=>{const He=Oe.feature(F);jt.updatePaintArray(Me,Le,He,Fe,je,qe,xt)}))}Pt=!0}}return Pt}defines(){const F=[];for(const Me in this.binders){const Le=this.binders[Me];(Le instanceof Oo||Le instanceof No)&&F.push(...Le.uniformNames.map((F=>`#define HAS_UNIFORM_${F}`)))}return F}getBinderAttributes(){const F=[];for(const Me in this.binders){const Le=this.binders[Me];if(Le instanceof Uo||Le instanceof jo||Le instanceof qo)for(let Me=0;Me<Le.paintVertexAttributes.length;Me++)F.push(Le.paintVertexAttributes[Me].name)}return F}getBinderUniforms(){const F=[];for(const Me in this.binders){const Le=this.binders[Me];if(Le instanceof Oo||Le instanceof No||Le instanceof jo)for(const Me of Le.uniformNames)F.push(Me)}return F}getPaintVertexBuffers(){return this._buffers}getUniforms(F){const Me=[];for(const Le in this.binders){const Oe=this.binders[Le];if(Oe instanceof Oo||Oe instanceof No||Oe instanceof jo)for(const Fe of Oe.uniformNames)Me.push({name:Fe,property:Le,binding:Oe.getBinding(F,Fe)})}return Me}setUniforms(F,Me,Le,Oe,Fe){for(const{name:Me,property:je,binding:qe}of Le)this.binders[je].setUniform(F,qe,Fe,Oe.get(je),Me)}updatePaintBuffers(){this._buffers=[];for(const F in this.binders){const Me=this.binders[F];(Me instanceof Uo||Me instanceof jo||Me instanceof qo)&&Me.paintVertexBuffer&&this._buffers.push(Me.paintVertexBuffer)}}upload(F){for(const Me in this.binders){const Le=this.binders[Me];(Le instanceof Uo||Le instanceof jo||Le instanceof qo)&&Le.upload(F)}this.updatePaintBuffers()}destroy(){for(const F in this.binders){const Me=this.binders[F];(Me instanceof Uo||Me instanceof jo||Me instanceof qo)&&Me.destroy()}}}class Go{constructor(F,Me,Le=()=>!0){this.programConfigurations={};for(const Oe of F)this.programConfigurations[Oe.id]=new $o(Oe,Me,Le);this.needsUpload=!1,this._featureMap=new wo,this._featureMapWithoutIds=new wo,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(F,Me,Le,Oe,Fe,je,qe,He){for(const Le in this.programConfigurations)this.programConfigurations[Le].populatePaintArrays(F,Me,Oe,Fe,je,qe,He);void 0!==Me.id?this._featureMap.add(Me.id,Le,this._bufferOffset,F):(this._featureMapWithoutIds.add(this._idlessCounter,Le,this._bufferOffset,F),this._idlessCounter+=1),this._bufferOffset=F,this.needsUpload=!0}updatePaintArrays(F,Me,Le,Oe,Fe,je,qe){for(const He of Le)this.needsUpload=this.programConfigurations[He.id].updatePaintArrays(F,this._featureMap,this._featureMapWithoutIds,Me,He,Oe,Fe,je,qe||0)||this.needsUpload}get(F){return this.programConfigurations[F]}upload(F){if(this.needsUpload){for(const Me in this.programConfigurations)this.programConfigurations[Me].upload(F);this.needsUpload=!1}}destroy(){for(const F in this.programConfigurations)this.programConfigurations[F].destroy()}}const um={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function Ho(F,Me){return um[F]||[F.replace(`${Me}-`,"").replace(/-/g,"_")]}const fm={"line-pattern":{source:ka,composite:ka},"fill-pattern":{source:ka,composite:ka},"fill-extrusion-pattern":{source:ka,composite:ka},"line-dasharray":{source:Ta,composite:Ta}},mm={color:{source:Za,composite:Da},number:{source:Aa,composite:Za}};function Wo(F,Me,Le){const Oe=fm[F];return Oe&&Oe[Le]||mm[Me][Le]}us(Oo,"ConstantBinder"),us(No,"PatternConstantBinder"),us(Uo,"SourceExpressionBinder"),us(qo,"PatternCompositeBinder"),us(jo,"CompositeExpressionBinder"),us($o,"ProgramConfiguration",{omit:["_buffers"]}),us(Go,"ProgramConfigurationSet");const _m=np/Math.PI/2,bm=5,Tm=6,Rm=16383,Lm=64,Om=[Lm,32,16],km=-_m,Fm=_m;function sl(F,Me,Le,Oe=_m){return Le=H(Le),[F*Math.sin(Le)*Oe,-Me*Oe,F*Math.cos(Le)*Oe]}function al(F,Me,Le){return sl(Math.cos(H(F)),Math.sin(H(F)),Me,Le)}const Bm=6371008.8,Nm=2*Math.PI*Bm;class ul{constructor(F,Me){if(isNaN(F)||isNaN(Me))throw new Error(`Invalid LngLat object: (${F}, ${Me})`);if(this.lng=+F,this.lat=+Me,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new ul(et(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(F){const Me=Math.PI/180,Le=this.lat*Me,Oe=F.lat*Me,Fe=Math.sin(Le)*Math.sin(Oe)+Math.cos(Le)*Math.cos(Oe)*Math.cos((F.lng-this.lng)*Me);return Bm*Math.acos(Math.min(Fe,1))}toBounds(F=0){const Me=360*F/40075017,Le=Me/Math.cos(Math.PI/180*this.lat);return new cl({lng:this.lng-Le,lat:this.lat-Me},{lng:this.lng+Le,lat:this.lat+Me})}toEcef(F){return al(this.lat,this.lng,_m+F*_m/Bm)}static convert(F){if(F instanceof ul)return F;if(Array.isArray(F)&&(2===F.length||3===F.length))return new ul(Number(F[0]),Number(F[1]));if(!Array.isArray(F)&&"object"==typeof F&&null!==F)return new ul(Number("lng"in F?F.lng:F.lon),Number(F.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class cl{constructor(F,Me){if(F)if(Me)this.setSouthWest(F).setNorthEast(Me);else if(4===F.length){const Me=F;this.setSouthWest([Me[0],Me[1]]).setNorthEast([Me[2],Me[3]])}else{const Me=F;this.setSouthWest(Me[0]).setNorthEast(Me[1])}}setNorthEast(F){return this._ne=F instanceof ul?new ul(F.lng,F.lat):ul.convert(F),this}setSouthWest(F){return this._sw=F instanceof ul?new ul(F.lng,F.lat):ul.convert(F),this}extend(F){const Me=this._sw,Le=this._ne;let Oe,Fe;if(F instanceof ul)Oe=F,Fe=F;else{if(!(F instanceof cl))return Array.isArray(F)?4===F.length||F.every(Array.isArray)?this.extend(cl.convert(F)):this.extend(ul.convert(F)):"object"==typeof F&&null!==F&&F.hasOwnProperty("lat")&&(F.hasOwnProperty("lon")||F.hasOwnProperty("lng"))?this.extend(ul.convert(F)):this;if(Oe=F._sw,Fe=F._ne,!Oe||!Fe)return this}return Me||Le?(Me.lng=Math.min(Oe.lng,Me.lng),Me.lat=Math.min(Oe.lat,Me.lat),Le.lng=Math.max(Fe.lng,Le.lng),Le.lat=Math.max(Fe.lat,Le.lat)):(this._sw=new ul(Oe.lng,Oe.lat),this._ne=new ul(Fe.lng,Fe.lat)),this}getCenter(){return new ul((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new ul(this.getWest(),this.getNorth())}getSouthEast(){return new ul(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(F){const{lng:Me,lat:Le}=ul.convert(F);let Oe=this._sw.lng<=Me&&Me<=this._ne.lng;return this._sw.lng>this._ne.lng&&(Oe=this._sw.lng>=Me&&Me>=this._ne.lng),this._sw.lat<=Le&&Le<=this._ne.lat&&Oe}static convert(F){if(F)return F instanceof cl?F:new cl(F)}}const Zm=0,Km=25.5;function fl(F){return Nm*Math.cos(F*Math.PI/180)}function dl(F){return(180+F)/360}function ml(F){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+F*Math.PI/360)))/360}function yl(F,Me){return F/fl(Me)}function gl(F){return 360*F-180}function xl(F){return 360/Math.PI*Math.atan(Math.exp((180-360*F)*Math.PI/180))-90}function vl(F,Me){return F*fl(xl(Me))}const Jm=85.051129;function _l(F){return Math.cos(H(Q(F,-Jm,Jm)))}function wl(F,Me){const Le=Q(Me,Zm,Km),Oe=Math.pow(2,Le);return _l(F)*Nm/(512*Oe)}function Ml(F){return 1/Math.cos(F*Math.PI/180)}function Al(F,Me=0){const Le=Math.exp(Math.PI*(1-(F.y+Me/np)/(1<<F.z)*2));return 80150034*Le/(Le*Le+1)/np/(1<<F.z)}class Il{constructor(F,Me,Le=0){this.x=+F,this.y=+Me,this.z=+Le}static fromLngLat(F,Me=0){const Le=ul.convert(F);return new Il(dl(Le.lng),ml(Le.lat),yl(Me,Le.lat))}toLngLat(){return new ul(gl(this.x),xl(this.y))}toAltitude(){return vl(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Nm*Ml(xl(this.y))}}function Sl(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt=(Me+Oe)/2,jt=(Le+Fe)/2,Gt=new ec(Pt,jt);He(Gt),function(F,Me,Le,Oe,Fe,je){const qe=Le-Fe,He=Oe-je;return Math.abs((Oe-Me)*qe-(Le-F)*He)/Math.hypot(qe,He)}(Gt.x,Gt.y,je.x,je.y,qe.x,qe.y)>=xt?(Sl(F,Me,Le,Pt,jt,je,Gt,He,xt),Sl(F,Pt,jt,Oe,Fe,Gt,qe,He,xt)):F.push(qe)}function Pl(F,Me,Le){let Oe=F[0],Fe=Oe.x,je=Oe.y;Me(Oe);const qe=[Oe];for(let He=1;He<F.length;He++){const xt=F[He],{x:Pt,y:jt}=xt;Me(xt),Sl(qe,Fe,je,Pt,jt,Oe,xt,Me,Le),Fe=Pt,je=jt,Oe=xt}return qe}function El(F,Me,Le,Oe){if(Oe(Me,Le)){const Fe=Me.add(Le)._mult(.5);El(F,Me,Fe,Oe),El(F,Fe,Le,Oe)}else F.push(Le)}function zl(F,Me){let Le=F[0];const Oe=[Le];for(let Fe=1;Fe<F.length;Fe++){const je=F[Fe];El(Oe,Le,je,Me),Le=je}return Oe}const Qm=Math.pow(2,14)-1,e_=-Qm-1;function Bl(F,Me){const Le=Math.round(F.x*Me),Oe=Math.round(F.y*Me);return F.x=Q(Le,e_,Qm),F.y=Q(Oe,e_,Qm),(Le<F.x||Le>F.x+1||Oe<F.y||Oe>F.y+1)&&pt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),F}function Vl(F,Me,Le){const Oe=F.loadGeometry(),Fe=F.extent,je=np/Fe;if(Me&&Le&&Le.projection.isReprojectedInTileSpace){const je=1<<Me.z,{scale:qe,x:He,y:xt,projection:Pt}=Le,c=F=>{const Le=gl((Me.x+F.x/Fe)/je),Oe=xl((Me.y+F.y/Fe)/je),jt=Pt.project(Le,Oe);F.x=(jt.x*qe-He)*Fe,F.y=(jt.y*qe-xt)*Fe};for(let Me=0;Me<Oe.length;Me++)if(1!==F.type)Oe[Me]=Pl(Oe[Me],c,1);else{const F=[];for(const Le of Oe[Me])Le.x<0||Le.x>=Fe||Le.y<0||Le.y>=Fe||(c(Le),F.push(Le));Oe[Me]=F}}for(const F of Oe)for(const Me of F)Bl(Me,je);return Oe}function Cl(F,Me){return{type:F.type,id:F.id,properties:F.properties,geometry:Me?Vl(F):[]}}function Dl(F,Me,Le,Oe,Fe){F.emplaceBack(2*Me+(Oe+1)/2,2*Le+(Fe+1)/2)}function Rl(F,Me,Le){const Oe=16384;F.emplaceBack(Me.x,Me.y,Me.z,Le[0]*Oe,Le[1]*Oe,Le[2]*Oe)}class Ll{constructor(F){this.zoom=F.zoom,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.projection=F.projection,this.layoutVertexArray=new _a,this.indexArray=new ja,this.segments=new xo,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id))}updateFootprints(F,Me){}populate(F,Me,Le,Oe){const Fe=this.layers[0],je=[];let qe=null;"circle"===Fe.type&&(qe=Fe.layout.get("circle-sort-key"));for(const{feature:Me,id:Fe,index:He,sourceLayerIndex:xt}of F){const F=this.layers[0]._featureFilter.needGeometry,Pt=Cl(Me,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),Pt,Le))continue;const jt=qe?qe.evaluate(Pt,{},Le):void 0,Gt={id:Fe,properties:Me.properties,type:Me.type,sourceLayerIndex:xt,index:He,geometry:F?Pt.geometry:Vl(Me,Le,Oe),patterns:{},sortKey:jt};je.push(Gt)}qe&&je.sort(((F,Me)=>F.sortKey-Me.sortKey));let He=null;"globe"===Oe.projection.name&&(this.globeExtVertexArray=new Ba,He=Oe.projection);for(const Oe of je){const{geometry:Fe,index:je,sourceLayerIndex:qe}=Oe,xt=F[je].feature;this.addFeature(Oe,Fe,je,Me.availableImages,Le,He,Me.brightness),Me.featureIndex.insert(xt,Fe,je,qe,this.index)}}update(F,Me,Le,Oe,Fe,je,qe){this.programConfigurations.updatePaintArrays(F,Me,Fe,Le,Oe,je,qe)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,Gf.members),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=F.createVertexBuffer(this.globeExtVertexArray,$f.members))),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(F,Me,Le,Oe,Fe,je,qe){for(const Le of Me)for(const Me of Le){const Le=Me.x,Oe=Me.y;if(Le<0||Le>=np||Oe<0||Oe>=np)continue;if(je){const F=je.projectTilePoint(Le,Oe,Fe),Me=je.upVector(Fe,Le,Oe),qe=this.globeExtVertexArray;Rl(qe,F,Me),Rl(qe,F,Me),Rl(qe,F,Me),Rl(qe,F,Me)}const qe=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,F.sortKey),He=qe.vertexLength;Dl(this.layoutVertexArray,Le,Oe,-1,-1),Dl(this.layoutVertexArray,Le,Oe,1,-1),Dl(this.layoutVertexArray,Le,Oe,1,1),Dl(this.layoutVertexArray,Le,Oe,-1,1),this.indexArray.emplaceBack(He,He+1,He+2),this.indexArray.emplaceBack(He,He+2,He+3),qe.vertexLength+=4,qe.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Le,{},Oe,Fe,qe)}}function Fl(F,Me){for(let Le=0;Le<F.length;Le++)if(Hl(Me,F[Le]))return!0;for(let Le=0;Le<Me.length;Le++)if(Hl(F,Me[Le]))return!0;return!!jl(F,Me)}function Ol(F,Me,Le){return!!Hl(F,Me)||!!$l(Me,F,Le)}function Nl(F,Me){if(1===F.length)return Yl(Me,F[0]);for(let Le=0;Le<Me.length;Le++){const Oe=Me[Le];for(let Me=0;Me<Oe.length;Me++)if(Hl(F,Oe[Me]))return!0}for(let Le=0;Le<F.length;Le++)if(Yl(Me,F[Le]))return!0;for(let Le=0;Le<Me.length;Le++)if(jl(F,Me[Le]))return!0;return!1}function Ul(F,Me,Le){if(F.length>1){if(jl(F,Me))return!0;for(let Oe=0;Oe<Me.length;Oe++)if($l(Me[Oe],F,Le))return!0}for(let Oe=0;Oe<F.length;Oe++)if($l(F[Oe],Me,Le))return!0;return!1}function jl(F,Me){if(0===F.length||0===Me.length)return!1;for(let Le=0;Le<F.length-1;Le++){const Oe=F[Le],Fe=F[Le+1];for(let F=0;F<Me.length-1;F++)if(ql(Oe,Fe,Me[F],Me[F+1]))return!0}return!1}function ql(F,Me,Le,Oe){return ft(F,Le,Oe)!==ft(Me,Le,Oe)&&ft(F,Me,Le)!==ft(F,Me,Oe)}function $l(F,Me,Le){const Oe=Le*Le;if(1===Me.length)return F.distSqr(Me[0])<Oe;for(let Le=1;Le<Me.length;Le++)if(Gl(F,Me[Le-1],Me[Le])<Oe)return!0;return!1}function Gl(F,Me,Le){const Oe=Me.distSqr(Le);if(0===Oe)return F.distSqr(Me);const Fe=((F.x-Me.x)*(Le.x-Me.x)+(F.y-Me.y)*(Le.y-Me.y))/Oe;return F.distSqr(Fe<0?Me:Fe>1?Le:Le.sub(Me)._mult(Fe)._add(Me))}function Yl(F,Me){let Le,Oe,Fe,je=!1;for(let qe=0;qe<F.length;qe++){Le=F[qe];for(let F=0,qe=Le.length-1;F<Le.length;qe=F++)Oe=Le[F],Fe=Le[qe],Oe.y>Me.y!=Fe.y>Me.y&&Me.x<(Fe.x-Oe.x)*(Me.y-Oe.y)/(Fe.y-Oe.y)+Oe.x&&(je=!je)}return je}function Hl(F,Me){let Le=!1;for(let Oe=0,Fe=F.length-1;Oe<F.length;Fe=Oe++){const je=F[Oe],qe=F[Fe];je.y>Me.y!=qe.y>Me.y&&Me.x<(qe.x-je.x)*(Me.y-je.y)/(qe.y-je.y)+je.x&&(Le=!Le)}return Le}function Xl(F,Me,Le,Oe,Fe){for(const je of F)if(Me<=je.x&&Le<=je.y&&Oe>=je.x&&Fe>=je.y)return!0;const je=[new ec(Me,Le),new ec(Me,Fe),new ec(Oe,Fe),new ec(Oe,Le)];if(F.length>2)for(const Me of je)if(Hl(F,Me))return!0;for(let Me=0;Me<F.length-1;Me++)if(Zl(F[Me],F[Me+1],je))return!0;return!1}function Zl(F,Me,Le){const Oe=Le[0],Fe=Le[2];if(F.x<Oe.x&&Me.x<Oe.x||F.x>Fe.x&&Me.x>Fe.x||F.y<Oe.y&&Me.y<Oe.y||F.y>Fe.y&&Me.y>Fe.y)return!1;const je=ft(F,Me,Le[0]);return je!==ft(F,Me,Le[1])||je!==ft(F,Me,Le[2])||je!==ft(F,Me,Le[3])}function Wl(F,Me,Le,Oe,Fe,je){let qe=Me.y-F.y,He=F.x-Me.x;if(je=je||0){const F=qe*qe+He*He;if(0===F)return!0;const Me=Math.sqrt(F);qe/=Me,He/=Me}return!((Le.x-F.x)*qe+(Le.y-F.y)*He-je<0||(Oe.x-F.x)*qe+(Oe.y-F.y)*He-je<0||(Fe.x-F.x)*qe+(Fe.y-F.y)*He-je<0)}function Kl(F,Me,Le,Oe,Fe,je,qe){return!(Wl(F,Me,Oe,Fe,je,qe)||Wl(Me,Le,Oe,Fe,je,qe)||Wl(Le,F,Oe,Fe,je,qe)||Wl(Oe,Fe,F,Me,Le,qe)||Wl(Fe,je,F,Me,Le,qe)||Wl(je,Oe,F,Me,Le,qe))}function Jl(F,Me,Le){const Oe=Me.paint.get(F).value;return"constant"===Oe.kind?Oe.value:Le.programConfigurations.get(Me.id).getMaxValue(F)}function Ql(F){return Math.sqrt(F[0]*F[0]+F[1]*F[1])}function tu(F,Me,Le,Oe,Fe){if(!Me[0]&&!Me[1])return F;const je=ec.convert(Me)._mult(Fe);"viewport"===Le&&je._rotate(-Oe);const qe=[];for(let Me=0;Me<F.length;Me++)qe.push(F[Me].sub(je));return qe}function eu(F,Me,Le,Oe){const Fe=ec.convert(F)._mult(Oe);return"viewport"===Me&&Fe._rotate(-Le),Fe}let t_,i_;us(Ll,"CircleBucket",{omit:["layers"]});var r_,n_={exports:{}},o_=(r_||(r_=1,function(F,Me){!function(F){function e(F,Me,Le){var Oe=r(256*F,256*(Me=Math.pow(2,Le)-Me-1),Le),Fe=r(256*(F+1),256*(Me+1),Le);return Oe[0]+","+Oe[1]+","+Fe[0]+","+Fe[1]}function r(F,Me,Le){var Oe=2*Math.PI*6378137/256/Math.pow(2,Le);return[F*Oe-2*Math.PI*6378137/2,Me*Oe-2*Math.PI*6378137/2]}F.getURL=function(F,Me,Le,Oe,Fe,je){return je=je||{},F+"?"+["bbox="+e(Le,Oe,Fe),"format="+(je.format||"image/png"),"service="+(je.service||"WMS"),"version="+(je.version||"1.1.1"),"request="+(je.request||"GetMap"),"srs="+(je.srs||"EPSG:3857"),"width="+(je.width||256),"height="+(je.height||256),"layers="+Me].join("&")},F.getTileBBox=e,F.getMercCoords=r,Object.defineProperty(F,"__esModule",{value:!0})}(Me)}(0,n_.exports)),n_.exports);class ou{constructor(F,Me,Le){this.z=F,this.x=Me,this.y=Le,this.key=cu(0,F,F,Me,Le)}equals(F){return this.z===F.z&&this.x===F.x&&this.y===F.y}url(F,Me){const Le=o_.getTileBBox(this.x,this.y,this.z),Oe=function(F,Me,Le){let Oe,Fe="";for(let je=F;je>0;je--)Oe=1<<je-1,Fe+=(Me&Oe?1:0)+(Le&Oe?2:0);return Fe}(this.z,this.x,this.y);return F[(this.x+this.y)%F.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===Me?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",Oe).replace("{bbox-epsg-3857}",Le)}toString(){return`${this.z}/${this.x}/${this.y}`}}class lu{constructor(F,Me){this.wrap=F,this.canonical=Me,this.key=cu(F,Me.z,Me.z,Me.x,Me.y)}}class uu{constructor(F,Me,Le,Oe,Fe){this.overscaledZ=F,this.wrap=Me,this.canonical=new ou(Le,+Oe,+Fe),this.key=0===Me&&F===Le?this.canonical.key:cu(Me,F,Le,Oe,Fe)}equals(F){return this.overscaledZ===F.overscaledZ&&this.wrap===F.wrap&&this.canonical.equals(F.canonical)}scaledTo(F){const Me=this.canonical.z-F;return F>this.canonical.z?new uu(F,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new uu(F,this.wrap,F,this.canonical.x>>Me,this.canonical.y>>Me)}calculateScaledKey(F,Me=!0){if(this.overscaledZ===F&&Me)return this.key;if(F>this.canonical.z)return cu(this.wrap*+Me,F,this.canonical.z,this.canonical.x,this.canonical.y);{const Le=this.canonical.z-F;return cu(this.wrap*+Me,F,F,this.canonical.x>>Le,this.canonical.y>>Le)}}isChildOf(F){if(F.wrap!==this.wrap)return!1;const Me=this.canonical.z-F.canonical.z;return 0===F.overscaledZ||F.overscaledZ<this.overscaledZ&&F.canonical.z<this.canonical.z&&F.canonical.x===this.canonical.x>>Me&&F.canonical.y===this.canonical.y>>Me}children(F){if(this.overscaledZ>=F)return[new uu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const Me=this.canonical.z+1,Le=2*this.canonical.x,Oe=2*this.canonical.y;return[new uu(Me,this.wrap,Me,Le,Oe),new uu(Me,this.wrap,Me,Le+1,Oe),new uu(Me,this.wrap,Me,Le,Oe+1),new uu(Me,this.wrap,Me,Le+1,Oe+1)]}isLessThan(F){return this.wrap<F.wrap||!(this.wrap>F.wrap)&&(this.overscaledZ<F.overscaledZ||!(this.overscaledZ>F.overscaledZ)&&(this.canonical.x<F.canonical.x||!(this.canonical.x>F.canonical.x)&&this.canonical.y<F.canonical.y))}wrapped(){return new uu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(F){return new uu(this.overscaledZ,F,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new lu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function cu(F,Me,Le,Oe,Fe){const je=1<<Math.min(Le,22);let qe=je*(Fe%je)+Oe%je;return F&&Le<22&&(qe+=je*je*((F<0?-2*F-1:2*F)%(1<<2*(22-Le)))),16*(32*qe+Le)+(Me-Le)}const s_=[F=>{let Me=F.canonical.x-1,Le=F.wrap;return Me<0&&(Me=(1<<F.canonical.z)-1,Le--),new uu(F.overscaledZ,Le,F.canonical.z,Me,F.canonical.y)},F=>{let Me=F.canonical.x+1,Le=F.wrap;return Me===1<<F.canonical.z&&(Me=0,Le++),new uu(F.overscaledZ,Le,F.canonical.z,Me,F.canonical.y)},F=>new uu(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,(0===F.canonical.y?1<<F.canonical.z:F.canonical.y)-1),F=>new uu(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y===(1<<F.canonical.z)-1?0:F.canonical.y+1)];us(ou,"CanonicalTileID"),us(uu,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const a_=va([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:l_}=a_,c_=va([{name:"a_pos_3",components:3,type:"Int16"}]);var h_=va([{name:"a_pos",type:"Int16",components:2}]);class yu{constructor(F,Me){this.pos=F,this.dir=Me}intersectsPlane(F,Me,Le){const Oe=bl.vec2.dot(Me,this.dir);if(Math.abs(Oe)<1e-6)return!1;const Fe=((F[0]-this.pos[0])*Me[0]+(F[1]-this.pos[1])*Me[1])/Oe;return Le[0]=this.pos[0]+this.dir[0]*Fe,Le[1]=this.pos[1]+this.dir[1]*Fe,!0}}class gu{constructor(F,Me){this.pos=F,this.dir=Me}intersectsPlane(F,Me,Le){const Oe=bl.vec3.dot(Me,this.dir);if(Math.abs(Oe)<1e-6)return!1;const Fe=((F[0]-this.pos[0])*Me[0]+(F[1]-this.pos[1])*Me[1]+(F[2]-this.pos[2])*Me[2])/Oe;return Le[0]=this.pos[0]+this.dir[0]*Fe,Le[1]=this.pos[1]+this.dir[1]*Fe,Le[2]=this.pos[2]+this.dir[2]*Fe,!0}closestPointOnSphere(F,Me,Le){if(bl.vec3.equals(this.pos,F)||0===Me)return Le[0]=Le[1]=Le[2]=0,!1;const[Oe,Fe,je]=this.dir,qe=this.pos[0]-F[0],He=this.pos[1]-F[1],xt=this.pos[2]-F[2],Pt=Oe*Oe+Fe*Fe+je*je,jt=2*(qe*Oe+He*Fe+xt*je),Gt=jt*jt-4*Pt*(qe*qe+He*He+xt*xt-Me*Me);if(Gt<0){const F=Math.max(-jt/2,0),Pt=qe+Oe*F,Gt=He+Fe*F,bi=xt+je*F,wi=Math.hypot(Pt,Gt,bi);return Le[0]=Pt*Me/wi,Le[1]=Gt*Me/wi,Le[2]=bi*Me/wi,!1}{const F=(-jt-Math.sqrt(Gt))/(2*Pt);if(F<0){const F=Math.hypot(qe,He,xt);return Le[0]=qe*Me/F,Le[1]=He*Me/F,Le[2]=xt*Me/F,!1}return Le[0]=qe+Oe*F,Le[1]=He+Fe*F,Le[2]=xt+je*F,!0}}}class xu{constructor(F,Me,Le,Oe,Fe){this.TL=F,this.TR=Me,this.BR=Le,this.BL=Oe,this.horizon=Fe}static fromInvProjectionMatrix(F,Me,Le){const Oe=[-1,1,1],Fe=[1,1,1],je=[1,-1,1],qe=[-1,-1,1],He=bl.vec3.transformMat4(Oe,Oe,F),xt=bl.vec3.transformMat4(Fe,Fe,F),Pt=bl.vec3.transformMat4(je,je,F),jt=bl.vec3.transformMat4(qe,qe,F);return new xu(He,xt,Pt,jt,Me/Le)}}function vu(F,Me,Le){let Oe=1/0,Fe=-1/0;const je=[];for(const qe of F){bl.vec3.sub(je,qe,Me);const F=bl.vec3.dot(je,Le);Oe=Math.min(Oe,F),Fe=Math.max(Fe,F)}return[Oe,Fe]}function bu(F,Me){let Le=!0;for(let Oe=0;Oe<F.planes.length;Oe++){const Fe=F.planes[Oe];let je=0;for(let F=0;F<Me.length;F++)je+=bl.vec3.dot(Fe,Me[F])+Fe[3]>=0;if(0===je)return 0;je!==Me.length&&(Le=!1)}return Le?2:1}function _u(F,Me){for(const Le of F.projections){const Oe=vu(Me,F.points[0],Le.axis);if(Le.projection[1]<Oe[0]||Le.projection[0]>Oe[1])return 0}return 1}function wu(F,Me){let Le=0;const Oe=[0,0,0,0];for(let Fe=0;Fe<F.length;Fe++)Oe[0]=F[Fe][0],Oe[1]=F[Fe][1],Oe[2]=F[Fe][2],Oe[3]=1,bl.vec4.dot(Oe,Me)>=0&&Le++;return Le}class Mu{constructor(F,Me){this.points=F||new Array(8).fill([0,0,0]),this.planes=Me||new Array(6).fill([0,0,0,0]),this.bounds=Au.fromPoints(this.points),this.projections=[],this.frustumEdges=[bl.vec3.sub([],this.points[2],this.points[3]),bl.vec3.sub([],this.points[0],this.points[3]),bl.vec3.sub([],this.points[4],this.points[0]),bl.vec3.sub([],this.points[5],this.points[1]),bl.vec3.sub([],this.points[6],this.points[2]),bl.vec3.sub([],this.points[7],this.points[3])];for(const F of this.frustumEdges){const Me=[0,-F[2],F[1]],Le=[F[2],0,-F[0]];this.projections.push({axis:Me,projection:vu(this.points,this.points[0],Me)}),this.projections.push({axis:Le,projection:vu(this.points,this.points[0],Le)})}}static fromInvProjectionMatrix(F,Me,Le,Oe){const Fe=Math.pow(2,Le),je=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((Le=>{const je=bl.vec4.transformMat4([],Le,F),qe=1/je[3]/Me*Fe;return bl.vec4.mul(je,je,[qe,qe,Oe?1/je[3]:qe,qe])})),qe=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((F=>{const Me=bl.vec3.sub([],je[F[0]],je[F[1]]),Le=bl.vec3.sub([],je[F[2]],je[F[1]]),Oe=bl.vec3.normalize([],bl.vec3.cross([],Me,Le)),Fe=-bl.vec3.dot(Oe,je[F[1]]);return Oe.concat(Fe)})),He=[];for(let F=0;F<je.length;F++)He.push([je[F][0],je[F][1],je[F][2]]);return new Mu(He,qe)}intersectsPrecise(F,Me,Le){for(let Le=0;Le<Me.length;Le++)if(!wu(F,Me[Le]))return 0;for(let Me=0;Me<this.planes.length;Me++)if(!wu(F,this.planes[Me]))return 0;for(const Me of Le)for(const Le of this.frustumEdges){const Oe=bl.vec3.cross([],Me,Le),Fe=bl.vec3.length(Oe);if(0===Fe)continue;bl.vec3.scale(Oe,Oe,1/Fe);const je=vu(this.points,this.points[0],Oe),qe=vu(F,this.points[0],Oe);if(je[0]>qe[1]||qe[0]>je[1])return 0}return 1}containsPoint(F){for(const Me of this.planes){const Le=Me[3];if(bl.vec3.dot([Me[0],Me[1],Me[2]],F)+Le<0)return!1}return!0}}class Au{static fromPoints(F){const Me=[1/0,1/0,1/0],Le=[-1/0,-1/0,-1/0];for(const Oe of F)bl.vec3.min(Me,Me,Oe),bl.vec3.max(Le,Le,Oe);return new Au(Me,Le)}static fromTileIdAndHeight(F,Me,Le){const Oe=1<<F.canonical.z,Fe=F.canonical.x,je=F.canonical.y;return new Au([Fe/Oe,je/Oe,Me],[(Fe+1)/Oe,(je+1)/Oe,Le])}static applyTransform(F,Me){const Le=F.getCorners();for(let F=0;F<Le.length;++F)bl.vec3.transformMat4(Le[F],Le[F],Me);return Au.fromPoints(Le)}static applyTransformFast(F,Me){const Le=[Me[12],Me[13],Me[14]],Oe=[...Le];for(let Fe=0;Fe<3;Fe++)for(let je=0;je<3;je++){const qe=Me[4*je+Fe],He=qe*F.min[je],xt=qe*F.max[je];Le[Fe]+=Math.min(He,xt),Oe[Fe]+=Math.max(He,xt)}return new Au(Le,Oe)}static projectAabbCorners(F,Me){const Le=F.getCorners();for(let F=0;F<Le.length;++F)bl.vec3.transformMat4(Le[F],Le[F],Me);return Le}constructor(F,Me){this.min=F,this.max=Me,this.center=bl.vec3.scale([],bl.vec3.add([],this.min,this.max),.5)}quadrant(F){const Me=[F%2==0,F<2],Le=bl.vec3.clone(this.min),Oe=bl.vec3.clone(this.max);for(let F=0;F<Me.length;F++)Le[F]=Me[F]?this.min[F]:this.center[F],Oe[F]=Me[F]?this.center[F]:this.max[F];return Oe[2]=this.max[2],new Au(Le,Oe)}distanceX(F){return Math.max(Math.min(this.max[0],F[0]),this.min[0])-F[0]}distanceY(F){return Math.max(Math.min(this.max[1],F[1]),this.min[1])-F[1]}distanceZ(F){return Math.max(Math.min(this.max[2],F[2]),this.min[2])-F[2]}getCorners(){const F=this.min,Me=this.max;return[[F[0],F[1],F[2]],[Me[0],F[1],F[2]],[Me[0],Me[1],F[2]],[F[0],Me[1],F[2]],[F[0],F[1],Me[2]],[Me[0],F[1],Me[2]],[Me[0],Me[1],Me[2]],[F[0],Me[1],Me[2]]]}intersects(F){return this.intersectsAabb(F.bounds)?bu(F,this.getCorners()):0}intersectsFlat(F){return this.intersectsAabb(F.bounds)?bu(F,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(F,Me){return Me||this.intersects(F)?_u(F,this.getCorners()):0}intersectsPreciseFlat(F,Me){return Me||this.intersectsFlat(F)?_u(F,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(F){for(let Me=0;Me<3;++Me)if(this.min[Me]>F.max[Me]||F.min[Me]>this.max[Me])return!1;return!0}intersectsAabbXY(F){return!(this.min[0]>F.max[0]||F.min[0]>this.max[0]||this.min[1]>F.max[1]||F.min[1]>this.max[1])}encapsulate(F){for(let Me=0;Me<3;Me++)this.min[Me]=Math.min(this.min[Me],F.min[Me]),this.max[Me]=Math.max(this.max[Me],F.max[Me])}encapsulatePoint(F){for(let Me=0;Me<3;Me++)this.min[Me]=Math.min(this.min[Me],F[Me]),this.max[Me]=Math.max(this.max[Me],F[Me])}closestPoint(F){return[Math.max(Math.min(this.max[0],F[0]),this.min[0]),Math.max(Math.min(this.max[1],F[1]),this.min[1]),Math.max(Math.min(this.max[2],F[2]),this.min[2])]}}function Iu(F){return F*_m/Bm}us(Au,"Aabb");const u_=[new Au([km,km,km],[Fm,Fm,Fm]),new Au([km,km,km],[0,0,Fm]),new Au([0,km,km],[Fm,0,Fm]),new Au([km,0,km],[0,Fm,Fm]),new Au([0,0,km],[Fm,Fm,Fm])];function Pu(F,Me,Le,Oe=!0){const Fe=bl.vec3.scale([],F._camera.position,F.worldSize),je=[Me,Le,1,1];bl.vec4.transformMat4(je,je,F.pixelMatrixInverse),bl.vec4.scale(je,je,1/je[3]);const qe=bl.vec3.sub([],je,Fe),He=bl.vec3.normalize([],qe),xt=F.globeMatrix,Pt=[xt[12],xt[13],xt[14]],jt=bl.vec3.sub([],Pt,Fe),Gt=bl.vec3.length(jt),bi=bl.vec3.normalize([],jt),wi=F.worldSize/(2*Math.PI),qr=bl.vec3.dot(bi,He),Xn=Math.asin(wi/Gt);if(Xn<Math.acos(qr)){if(!Oe)return null;const F=[],Me=[];bl.vec3.scale(F,He,Gt/qr),bl.vec3.normalize(Me,bl.vec3.sub(Me,F,jt)),bl.vec3.normalize(He,bl.vec3.add(He,jt,bl.vec3.scale(He,Me,Math.tan(Xn)*Gt)))}const Yn=[];new gu(Fe,He).closestPointOnSphere(Pt,wi,Yn);const yo=bl.vec3.normalize([],vt(xt,0)),bo=bl.vec3.normalize([],vt(xt,1)),Ro=bl.vec3.normalize([],vt(xt,2)),Do=bl.vec3.dot(yo,Yn),zs=bl.vec3.dot(bo,Yn),Zs=bl.vec3.dot(Ro,Yn),na=X(Math.asin(-zs/wi));let el=X(Math.atan2(Do,Zs));el=F.center.lng+function(F,Me){const Le=(Me-F+180)%360-180;return Le<-180?Le+360:Le}(F.center.lng,el);const nl=dl(el),hl=Q(ml(na),0,1);return new Il(nl,hl)}class Eu{constructor(F,Me,Le){this.a=bl.vec3.sub([],F,Le),this.b=bl.vec3.sub([],Me,Le),this.center=Le;const Oe=bl.vec3.normalize([],this.a),Fe=bl.vec3.normalize([],this.b);this.angle=Math.acos(bl.vec3.dot(Oe,Fe))}}function zu(F,Me){if(0===F.angle)return null;let Le;return Le=0===F.a[Me]?1/F.angle*.5*Math.PI:1/F.angle*Math.atan(F.b[Me]/F.a[Me]/Math.sin(F.angle)-1/Math.tan(F.angle)),Le<0||Le>1?null:function(F,Me,Le,Oe){const Fe=Math.sin(Le);return F*(Math.sin((1-Oe)*Le)/Fe)+Me*(Math.sin(Oe*Le)/Fe)}(F.a[Me],F.b[Me],F.angle,Q(Le,0,1))+F.center[Me]}function ku(F){if(F.z<=1)return u_[F.z+2*F.y+F.x];const Me=Du(Cu(F));return Au.fromPoints(Me)}function Tu(F,Me,Le){return bl.vec3.scale(F,F,1-Le),bl.vec3.scaleAndAdd(F,F,Me,Le)}function Bu(F,Me,Le){for(const Oe of F)bl.vec3.transformMat4(Oe,Oe,Me),bl.vec3.scale(Oe,Oe,Le)}function Vu(F,Me,Le,Oe){const Fe=Me/F.worldSize,je=F.globeMatrix;if(Le.z<=1){const F=ku(Le).getCorners();return Bu(F,je,Fe),Au.fromPoints(F)}const qe=Cu(Le,Oe),He=Du(qe,_m+Iu(F._tileCoverLift));Bu(He,je,Fe);const xt=Number.MAX_VALUE,Pt=[-xt,-xt,-xt],jt=[xt,xt,xt];if(qe.contains(F.center)){for(const F of He)bl.vec3.min(jt,jt,F),bl.vec3.max(Pt,Pt,F);Pt[2]=0;const Me=F.point,Le=[Me.x*Fe,Me.y*Fe,0];return bl.vec3.min(jt,jt,Le),bl.vec3.max(Pt,Pt,Le),new Au(jt,Pt)}if(F._tileCoverLift>0){for(const F of He)bl.vec3.min(jt,jt,F),bl.vec3.max(Pt,Pt,F);return new Au(jt,Pt)}const Gt=[je[12]*Fe,je[13]*Fe,je[14]*Fe],bi=qe.getCenter(),wi=Q(F.center.lat,-Jm,Jm),qr=Q(bi.lat,-Jm,Jm),Xn=dl(F.center.lng),Yn=ml(wi);let yo=Xn-dl(bi.lng);const bo=Yn-ml(qr);yo>.5?yo-=1:yo<-.5&&(yo+=1);let Ro=0;if(Math.abs(yo)>Math.abs(bo))Ro=yo>=0?1:3;else{Ro=bo>=0?0:2;const F=[je[4]*Fe,je[5]*Fe,je[6]*Fe],Me=-Math.sin(H(bo>=0?qe.getSouth():qe.getNorth()))*_m;bl.vec3.scaleAndAdd(Gt,Gt,F,Me)}const Do=He[Ro],zs=He[(Ro+1)%4],Zs=new Eu(Do,zs,Gt),na=[zu(Zs,0)||Do[0],zu(Zs,1)||Do[1],zu(Zs,2)||Do[2]],el=$u(F.zoom);if(el>0){const Oe=function({x:F,y:Me,z:Le},Oe,Fe,je,qe){const He=1/(1<<Le);let xt=F*He,Pt=xt+He,jt=Me*He,Gt=jt+He,bi=0;const wi=(xt+Pt)/2-je;return wi>.5?bi=-1:wi<-.5&&(bi=1),xt=((xt+bi)*Oe-(je*=Oe))*Fe+je,Pt=((Pt+bi)*Oe-je)*Fe+je,jt=(jt*Oe-(qe*=Oe))*Fe+qe,Gt=(Gt*Oe-qe)*Fe+qe,[[xt,Gt,0],[Pt,Gt,0],[Pt,jt,0],[xt,jt,0]]}(Le,Me,F._pixelsPerMercatorPixel,Xn,Yn);for(let F=0;F<He.length;F++)Tu(He[F],Oe[F],el);const Fe=bl.vec3.add([],Oe[Ro],Oe[(Ro+1)%4]);bl.vec3.scale(Fe,Fe,.5),Tu(na,Fe,el)}for(const F of He)bl.vec3.min(jt,jt,F),bl.vec3.max(Pt,Pt,F);return jt[2]=Math.min(Do[2],zs[2]),bl.vec3.min(jt,jt,na),bl.vec3.max(Pt,Pt,na),new Au(jt,Pt)}function Cu({x:F,y:Me,z:Le},Oe=!1){const Fe=1/(1<<Le),je=new ul(gl(F*Fe),Me===(1<<Le)-1&&Oe?-90:xl((Me+1)*Fe)),qe=new ul(gl((F+1)*Fe),0===Me&&Oe?90:xl(Me*Fe));return new cl(je,qe)}function Du(F,Me=_m){const Le=H(F.getNorth()),Oe=H(F.getSouth()),Fe=Math.cos(Le),je=Math.cos(Oe),qe=Math.sin(Le),He=Math.sin(Oe),xt=F.getWest(),Pt=F.getEast();return[sl(je,He,xt,Me),sl(je,He,Pt,Me),sl(Fe,qe,Pt,Me),sl(Fe,qe,xt,Me)]}function Ru(F,Me,Le,Oe){const Fe=1<<Le.z,je=(F/np+Le.x)/Fe;return al(xl((Me/np+Le.y)/Fe),gl(je),Oe)}function Lu({min:F,max:Me}){return Rm/Math.max(Me[0]-F[0],Me[1]-F[1],Me[2]-F[2])}const d_=new Float64Array(16);function Ou(F){const Me=Lu(F),Le=bl.mat4.fromScaling(d_,[Me,Me,Me]);return bl.mat4.translate(Le,Le,bl.vec3.negate([],F.min))}function Nu(F){const Me=bl.mat4.fromTranslation(d_,F.min),Le=1/Lu(F);return bl.mat4.scale(Me,Me,[Le,Le,Le])}function Uu(F){const Me=np/(2*Math.PI);return F/(2*Math.PI)/Me}function ju(F,Me){return np/(512*Math.pow(2,F))*Lu(ku(Me))}function qu(F,Me,Le,Oe,Fe){const je=Uu(Le),qe=[F,Me,-Le/(2*Math.PI)],He=bl.mat4.identity(new Float64Array(16));return bl.mat4.translate(He,He,qe),bl.mat4.scale(He,He,[je,je,je]),bl.mat4.rotateX(He,He,H(-Fe)),bl.mat4.rotateY(He,He,H(-Oe)),He}function $u(F){return tt(bm,Tm,F)}function Gu(F,Me){const Le=al(Me.lat,Me.lng),Oe=function(F){const Me=al(F._center.lat,F._center.lng),Le=bl.vec3.fromValues(0,1,0);let Oe=bl.vec3.cross([],Le,Me);const Fe=bl.mat4.fromRotation([],-F.angle,Me);Oe=bl.vec3.transformMat4(Oe,Oe,Fe),bl.mat4.fromRotation(Fe,-F._pitch,Oe);const je=bl.vec3.normalize([],Me);return bl.vec3.scale(je,je,Iu(F.cameraToCenterDistance/F.pixelsPerMeter)),bl.vec3.transformMat4(je,je,Fe),bl.vec3.add([],Me,je)}(F),Fe=bl.vec3.subtract([],Oe,Le);return bl.vec3.angle(Fe,Le)}function Yu(F,Me){return Gu(F,Me)>Math.PI/2*1.01}const p_=H(85),f_=Math.cos(p_),m_=Math.sin(p_),__=bl.mat4.create(),Ku=F=>{const Me=[];return"map"===F.paint.get("circle-pitch-alignment")&&Me.push("PITCH_WITH_MAP"),"map"===F.paint.get("circle-pitch-scale")&&Me.push("SCALE_WITH_MAP"),Me};function Ju(F,Me,Le,Oe,Fe,je,qe,He,xt){if(je&&F.queryGeometry.isAboveHorizon)return!1;je&&(xt*=F.pixelToTileUnitsFactor);const Pt=F.tileID.canonical,jt=Le.projection.upVectorScale(Pt,Le.center.lat,Le.worldSize).metersToTile;for(const Gt of Me)for(const Me of Gt){const Gt=Me.add(He),bi=Fe&&Le.elevation?Le.elevation.exaggeration()*Fe.getElevationAt(Gt.x,Gt.y,!0):0,wi=Le.projection.projectTilePoint(Gt.x,Gt.y,Pt);if(bi>0){const F=Le.projection.upVector(Pt,Gt.x,Gt.y);wi.x+=F[0]*jt*bi,wi.y+=F[1]*jt*bi,wi.z+=F[2]*jt*bi}const qr=je?Gt:Qu(wi.x,wi.y,wi.z,Oe),Xn=je?F.tilespaceRays.map((F=>rc(F,bi))):F.queryGeometry.screenGeometry,Yn=bl.vec4.transformMat4([],[wi.x,wi.y,wi.z,1],Oe);if(!qe&&je?xt*=Yn[3]/Le.cameraToCenterDistance:qe&&!je&&(xt*=Le.cameraToCenterDistance/Yn[3]),je){const F=xl((Me.y/np+Pt.y)/(1<<Pt.z));xt/=Le.projection.pixelsPerMeter(F,1)/yl(1,F)}if(Ol(Xn,qr,xt))return!0}return!1}function Qu(F,Me,Le,Oe){const Fe=bl.vec4.transformMat4([],[F,Me,Le,1],Oe);return new ec(Fe[0]/Fe[3],Fe[1]/Fe[3])}const g_=bl.vec3.fromValues(0,0,0),y_=bl.vec3.fromValues(0,0,1);function rc(F,Me){const Le=bl.vec3.create();return g_[2]=Me,F.intersectsPlane(g_,y_,Le),new ec(Le[0],Le[1])}class nc extends Ll{}let x_,v_,b_,w_;function lc(F,{width:Me,height:Le},Oe,Fe){if(Fe){if(Fe instanceof Uint8ClampedArray)Fe=new Uint8Array(Fe.buffer);else if(Fe.length!==Me*Le*Oe)throw new RangeError("mismatched image size")}else Fe=new Uint8Array(Me*Le*Oe);return F.width=Me,F.height=Le,F.data=Fe,F}function uc(F,Me,Le){const{width:Oe,height:Fe}=Me;Oe===F.width&&Fe===F.height||(cc(F,Me,{x:0,y:0},{x:0,y:0},{width:Math.min(F.width,Oe),height:Math.min(F.height,Fe)},Le,null),F.width=Oe,F.height=Fe,F.data=Me.data)}function cc(F,Me,Le,Oe,Fe,je,qe,He){if(0===Fe.width||0===Fe.height)return Me;if(Fe.width>F.width||Fe.height>F.height||Le.x>F.width-Fe.width||Le.y>F.height-Fe.height)throw new RangeError("out of range source coordinates for image copy");if(Fe.width>Me.width||Fe.height>Me.height||Oe.x>Me.width-Fe.width||Oe.y>Me.height-Fe.height)throw new RangeError("out of range destination coordinates for image copy");const xt=F.data,Pt=Me.data,jt=4===je&&He;for(let He=0;He<Fe.height;He++){const Gt=((Le.y+He)*F.width+Le.x)*je,bi=((Oe.y+He)*Me.width+Oe.x)*je;if(jt)for(let F=0;F<Fe.width;F++){const Me=Gt+F*je+3,Le=bi+F*je;Pt[Le+0]=255,Pt[Le+1]=255,Pt[Le+2]=255,Pt[Le+3]=xt[Me]}else if(qe)for(let F=0;F<Fe.width;F++){const Me=Gt+F*je,Le=bi+F*je,Oe=xt[Me+3],Fe=new Se(xt[Me+0]/255*Oe,xt[Me+1]/255*Oe,xt[Me+2]/255*Oe,Oe).toRenderColor(qe).toArray();Pt[Le+0]=Fe[0],Pt[Le+1]=Fe[1],Pt[Le+2]=Fe[2],Pt[Le+3]=Fe[3]}else for(let F=0;F<Fe.width*je;F++)Pt[bi+F]=xt[Gt+F]}return Me}us(nc,"HeatmapBucket",{omit:["layers"]});class hc{constructor(F,Me){lc(this,F,1,Me)}resize(F){uc(this,new hc(F),1)}clone(){return new hc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(F,Me,Le,Oe,Fe){cc(F,Me,Le,Oe,Fe,1,null)}}class pc{constructor(F,Me){lc(this,F,4,Me)}resize(F){uc(this,new pc(F),4)}replace(F,Me){Me?this.data.set(F):this.data=F instanceof Uint8ClampedArray?new Uint8Array(F.buffer):F}clone(){return new pc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(F,Me,Le,Oe,Fe,je,qe){cc(F,Me,Le,Oe,Fe,4,je,qe)}}class fc{constructor(F,Me){this.width=F.width,this.height=F.height,this.data=Me instanceof Uint8Array?new Float32Array(Me.buffer):Me}}function dc(F){const Me={},Le=F.resolution||256,Oe=F.clips?F.clips.length:1,Fe=F.image||new pc({width:Le,height:Oe}),s=(Le,Oe,je)=>{Me[F.evaluationKey]=je;const qe=F.expression.evaluate(Me);qe&&(Fe.data[Le+Oe+0]=Math.floor(255*qe.r/qe.a),Fe.data[Le+Oe+1]=Math.floor(255*qe.g/qe.a),Fe.data[Le+Oe+2]=Math.floor(255*qe.b/qe.a),Fe.data[Le+Oe+3]=Math.floor(255*qe.a))};if(F.clips)for(let Me=0,Fe=0;Me<Oe;++Me,Fe+=4*Le)for(let Oe=0,je=0;Oe<Le;Oe++,je+=4){const qe=Oe/(Le-1),{start:He,end:xt}=F.clips[Me];s(Fe,je,He*(1-qe)+xt*qe)}else for(let F=0,Me=0;F<Le;F++,Me+=4)s(0,Me,F/(Le-1));return Fe}us(hc,"AlphaImage"),us(pc,"RGBAImage");const T_=va([{name:"a_pos",components:2,type:"Int16"}],4),S_=va([{name:"a_road_z_offset",components:1,type:"Float32"}],4),E_=va([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),M_=va([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function vc(F,Me,Le=2){const Oe=Me&&Me.length,Fe=Oe?Me[0]*Le:F.length;let je=bc(F,0,Fe,Le,!0);const qe=[];if(!je||je.next===je.prev)return qe;let He,xt,Pt;if(Oe&&(je=function(F,Me,Le,Oe){const Fe=[];for(let Le=0,je=Me.length;Le<je;Le++){const qe=bc(F,Me[Le]*Oe,Le<je-1?Me[Le+1]*Oe:F.length,Oe,!1);qe===qe.next&&(qe.steiner=!0),Fe.push(Tc(qe))}Fe.sort(Pc);for(let F=0;F<Fe.length;F++)Le=Ec(Fe[F],Le);return Le}(F,Me,je,Le)),F.length>80*Le){He=1/0,xt=1/0;let Me=-1/0,Oe=-1/0;for(let je=Le;je<Fe;je+=Le){const Le=F[je],Fe=F[je+1];Le<He&&(He=Le),Fe<xt&&(xt=Fe),Le>Me&&(Me=Le),Fe>Oe&&(Oe=Fe)}Pt=Math.max(Me-He,Oe-xt),Pt=0!==Pt?32767/Pt:0}return wc(je,qe,Le,He,xt,Pt,0),qe}function bc(F,Me,Le,Oe,Fe){let je;if(Fe===function(F,Me,Le,Oe){let Fe=0;for(let je=Me,qe=Le-Oe;je<Le;je+=Oe)Fe+=(F[qe]-F[je])*(F[je+1]+F[qe+1]),qe=je;return Fe}(F,Me,Le,Oe)>0)for(let Fe=Me;Fe<Le;Fe+=Oe)je=Uc(Fe/Oe|0,F[Fe],F[Fe+1],je);else for(let Fe=Le-Oe;Fe>=Me;Fe-=Oe)je=Uc(Fe/Oe|0,F[Fe],F[Fe+1],je);return je&&Dc(je,je.next)&&(jc(je),je=je.next),je}function _c(F,Me){if(!F)return F;Me||(Me=F);let Le,Oe=F;do{if(Le=!1,Oe.steiner||!Dc(Oe,Oe.next)&&0!==Cc(Oe.prev,Oe,Oe.next))Oe=Oe.next;else{if(jc(Oe),Oe=Me=Oe.prev,Oe===Oe.next)break;Le=!0}}while(Le||Oe!==Me);return Me}function wc(F,Me,Le,Oe,Fe,je,qe){if(!F)return;!qe&&je&&function(F,Me,Le,Oe){let Fe=F;do{0===Fe.z&&(Fe.z=kc(Fe.x,Fe.y,Me,Le,Oe)),Fe.prevZ=Fe.prev,Fe.nextZ=Fe.next,Fe=Fe.next}while(Fe!==F);Fe.prevZ.nextZ=null,Fe.prevZ=null,function(F){let Me,Le=1;do{let Oe,Fe=F;F=null;let je=null;for(Me=0;Fe;){Me++;let qe=Fe,He=0;for(let F=0;F<Le&&(He++,qe=qe.nextZ,qe);F++);let xt=Le;for(;He>0||xt>0&&qe;)0!==He&&(0===xt||!qe||Fe.z<=qe.z)?(Oe=Fe,Fe=Fe.nextZ,He--):(Oe=qe,qe=qe.nextZ,xt--),je?je.nextZ=Oe:F=Oe,Oe.prevZ=je,je=Oe;Fe=qe}je.nextZ=null,Le*=2}while(Me>1)}(Fe)}(F,Oe,Fe,je);let He=F;for(;F.prev!==F.next;){const xt=F.prev,Pt=F.next;if(je?Ac(F,Oe,Fe,je):Mc(F))Me.push(xt.i,F.i,Pt.i),jc(F),F=Pt.next,He=Pt.next;else if((F=Pt)===He){qe?1===qe?wc(F=Ic(_c(F),Me),Me,Le,Oe,Fe,je,2):2===qe&&Sc(F,Me,Le,Oe,Fe,je):wc(_c(F),Me,Le,Oe,Fe,je,1);break}}}function Mc(F){const Me=F.prev,Le=F,Oe=F.next;if(Cc(Me,Le,Oe)>=0)return!1;const Fe=Me.x,je=Le.x,qe=Oe.x,He=Me.y,xt=Le.y,Pt=Oe.y,jt=Fe<je?Fe<qe?Fe:qe:je<qe?je:qe,Gt=He<xt?He<Pt?He:Pt:xt<Pt?xt:Pt,bi=Fe>je?Fe>qe?Fe:qe:je>qe?je:qe,wi=He>xt?He>Pt?He:Pt:xt>Pt?xt:Pt;let qr=Oe.next;for(;qr!==Me;){if(qr.x>=jt&&qr.x<=bi&&qr.y>=Gt&&qr.y<=wi&&Bc(Fe,He,je,xt,qe,Pt,qr.x,qr.y)&&Cc(qr.prev,qr,qr.next)>=0)return!1;qr=qr.next}return!0}function Ac(F,Me,Le,Oe){const Fe=F.prev,je=F,qe=F.next;if(Cc(Fe,je,qe)>=0)return!1;const He=Fe.x,xt=je.x,Pt=qe.x,jt=Fe.y,Gt=je.y,bi=qe.y,wi=He<xt?He<Pt?He:Pt:xt<Pt?xt:Pt,qr=jt<Gt?jt<bi?jt:bi:Gt<bi?Gt:bi,Xn=He>xt?He>Pt?He:Pt:xt>Pt?xt:Pt,Yn=jt>Gt?jt>bi?jt:bi:Gt>bi?Gt:bi,yo=kc(wi,qr,Me,Le,Oe),bo=kc(Xn,Yn,Me,Le,Oe);let Ro=F.prevZ,Do=F.nextZ;for(;Ro&&Ro.z>=yo&&Do&&Do.z<=bo;){if(Ro.x>=wi&&Ro.x<=Xn&&Ro.y>=qr&&Ro.y<=Yn&&Ro!==Fe&&Ro!==qe&&Bc(He,jt,xt,Gt,Pt,bi,Ro.x,Ro.y)&&Cc(Ro.prev,Ro,Ro.next)>=0)return!1;if(Ro=Ro.prevZ,Do.x>=wi&&Do.x<=Xn&&Do.y>=qr&&Do.y<=Yn&&Do!==Fe&&Do!==qe&&Bc(He,jt,xt,Gt,Pt,bi,Do.x,Do.y)&&Cc(Do.prev,Do,Do.next)>=0)return!1;Do=Do.nextZ}for(;Ro&&Ro.z>=yo;){if(Ro.x>=wi&&Ro.x<=Xn&&Ro.y>=qr&&Ro.y<=Yn&&Ro!==Fe&&Ro!==qe&&Bc(He,jt,xt,Gt,Pt,bi,Ro.x,Ro.y)&&Cc(Ro.prev,Ro,Ro.next)>=0)return!1;Ro=Ro.prevZ}for(;Do&&Do.z<=bo;){if(Do.x>=wi&&Do.x<=Xn&&Do.y>=qr&&Do.y<=Yn&&Do!==Fe&&Do!==qe&&Bc(He,jt,xt,Gt,Pt,bi,Do.x,Do.y)&&Cc(Do.prev,Do,Do.next)>=0)return!1;Do=Do.nextZ}return!0}function Ic(F,Me){let Le=F;do{const Oe=Le.prev,Fe=Le.next.next;!Dc(Oe,Fe)&&Rc(Oe,Le,Le.next,Fe)&&Oc(Oe,Fe)&&Oc(Fe,Oe)&&(Me.push(Oe.i,Le.i,Fe.i),jc(Le),jc(Le.next),Le=F=Fe),Le=Le.next}while(Le!==F);return _c(Le)}function Sc(F,Me,Le,Oe,Fe,je){let qe=F;do{let F=qe.next.next;for(;F!==qe.prev;){if(qe.i!==F.i&&Vc(qe,F)){let He=Nc(qe,F);return qe=_c(qe,qe.next),He=_c(He,He.next),wc(qe,Me,Le,Oe,Fe,je,0),void wc(He,Me,Le,Oe,Fe,je,0)}F=F.next}qe=qe.next}while(qe!==F)}function Pc(F,Me){return F.x-Me.x}function Ec(F,Me){const Le=function(F,Me){let Le=Me;const Oe=F.x,Fe=F.y;let je,qe=-1/0;do{if(Fe<=Le.y&&Fe>=Le.next.y&&Le.next.y!==Le.y){const F=Le.x+(Fe-Le.y)*(Le.next.x-Le.x)/(Le.next.y-Le.y);if(F<=Oe&&F>qe&&(qe=F,je=Le.x<Le.next.x?Le:Le.next,F===Oe))return je}Le=Le.next}while(Le!==Me);if(!je)return null;const He=je,xt=je.x,Pt=je.y;let jt=1/0;Le=je;do{if(Oe>=Le.x&&Le.x>=xt&&Oe!==Le.x&&Bc(Fe<Pt?Oe:qe,Fe,xt,Pt,Fe<Pt?qe:Oe,Fe,Le.x,Le.y)){const Me=Math.abs(Fe-Le.y)/(Oe-Le.x);Oc(Le,F)&&(Me<jt||Me===jt&&(Le.x>je.x||Le.x===je.x&&zc(je,Le)))&&(je=Le,jt=Me)}Le=Le.next}while(Le!==He);return je}(F,Me);if(!Le)return Me;const Oe=Nc(Le,F);return _c(Oe,Oe.next),_c(Le,Le.next)}function zc(F,Me){return Cc(F.prev,F,Me.prev)<0&&Cc(Me.next,F,F.next)<0}function kc(F,Me,Le,Oe,Fe){return(F=1431655765&((F=858993459&((F=252645135&((F=16711935&((F=(F-Le)*Fe|0)|F<<8))|F<<4))|F<<2))|F<<1))|(Me=1431655765&((Me=858993459&((Me=252645135&((Me=16711935&((Me=(Me-Oe)*Fe|0)|Me<<8))|Me<<4))|Me<<2))|Me<<1))<<1}function Tc(F){let Me=F,Le=F;do{(Me.x<Le.x||Me.x===Le.x&&Me.y<Le.y)&&(Le=Me),Me=Me.next}while(Me!==F);return Le}function Bc(F,Me,Le,Oe,Fe,je,qe,He){return(Fe-qe)*(Me-He)>=(F-qe)*(je-He)&&(F-qe)*(Oe-He)>=(Le-qe)*(Me-He)&&(Le-qe)*(je-He)>=(Fe-qe)*(Oe-He)}function Vc(F,Me){return F.next.i!==Me.i&&F.prev.i!==Me.i&&!function(F,Me){let Le=F;do{if(Le.i!==F.i&&Le.next.i!==F.i&&Le.i!==Me.i&&Le.next.i!==Me.i&&Rc(Le,Le.next,F,Me))return!0;Le=Le.next}while(Le!==F);return!1}(F,Me)&&(Oc(F,Me)&&Oc(Me,F)&&function(F,Me){let Le=F,Oe=!1;const Fe=(F.x+Me.x)/2,je=(F.y+Me.y)/2;do{Le.y>je!=Le.next.y>je&&Le.next.y!==Le.y&&Fe<(Le.next.x-Le.x)*(je-Le.y)/(Le.next.y-Le.y)+Le.x&&(Oe=!Oe),Le=Le.next}while(Le!==F);return Oe}(F,Me)&&(Cc(F.prev,F,Me.prev)||Cc(F,Me.prev,Me))||Dc(F,Me)&&Cc(F.prev,F,F.next)>0&&Cc(Me.prev,Me,Me.next)>0)}function Cc(F,Me,Le){return(Me.y-F.y)*(Le.x-Me.x)-(Me.x-F.x)*(Le.y-Me.y)}function Dc(F,Me){return F.x===Me.x&&F.y===Me.y}function Rc(F,Me,Le,Oe){const Fe=Fc(Cc(F,Me,Le)),je=Fc(Cc(F,Me,Oe)),qe=Fc(Cc(Le,Oe,F)),He=Fc(Cc(Le,Oe,Me));return Fe!==je&&qe!==He||!(0!==Fe||!Lc(F,Le,Me))||!(0!==je||!Lc(F,Oe,Me))||!(0!==qe||!Lc(Le,F,Oe))||!(0!==He||!Lc(Le,Me,Oe))}function Lc(F,Me,Le){return Me.x<=Math.max(F.x,Le.x)&&Me.x>=Math.min(F.x,Le.x)&&Me.y<=Math.max(F.y,Le.y)&&Me.y>=Math.min(F.y,Le.y)}function Fc(F){return F>0?1:F<0?-1:0}function Oc(F,Me){return Cc(F.prev,F,F.next)<0?Cc(F,Me,F.next)>=0&&Cc(F,F.prev,Me)>=0:Cc(F,Me,F.prev)<0||Cc(F,F.next,Me)<0}function Nc(F,Me){const Le=qc(F.i,F.x,F.y),Oe=qc(Me.i,Me.x,Me.y),Fe=F.next,je=Me.prev;return F.next=Me,Me.prev=F,Le.next=Fe,Fe.prev=Le,Oe.next=Le,Le.prev=Oe,je.next=Oe,Oe.prev=je,Oe}function Uc(F,Me,Le,Oe){const Fe=qc(F,Me,Le);return Oe?(Fe.next=Oe.next,Fe.prev=Oe,Oe.next.prev=Fe,Oe.next=Fe):(Fe.prev=Fe,Fe.next=Fe),Fe}function jc(F){F.next.prev=F.prev,F.prev.next=F.next,F.prevZ&&(F.prevZ.nextZ=F.nextZ),F.nextZ&&(F.nextZ.prevZ=F.prevZ)}function qc(F,Me,Le){return{i:F,x:Me,y:Le,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function $c(F,Me){const Le=F.length;if(Le<=1)return[F];const Oe=[];let Fe,je;for(let Me=0;Me<Le;Me++){const Le=dt(F[Me]);0!==Le&&(F[Me].area=Math.abs(Le),void 0===je&&(je=Le<0),je===Le<0?(Fe&&Oe.push(Fe),Fe=[F[Me]]):Fe.push(F[Me]))}if(Fe&&Oe.push(Fe),Me>1)for(let F=0;F<Oe.length;F++)Oe[F].length<=Me||(br(Oe[F],Me,1,Oe[F].length-1,Gc),Oe[F]=Oe[F].slice(0,Me));return Oe}function Gc(F,Me){return Me.area-F.area}function Yc(F,Me,Le=1){if(!F)return null;const Oe="string"==typeof F?er.from(F).getPrimary():F.getPrimary(),Fe=Oe.id.toString();return Me.has(Fe)||Me.set(Fe,[]),Oe.scaleSelf(Le),Me.get(Fe).push(Oe),Oe.toString()}function Hc(F,Me,Le,Oe){const Fe=Oe.patternDependencies;let je=!1;for(const Oe of Me){const Me=Oe.paint.get(`${F}-pattern`);Me.isConstant()||(je=!0),Yc(Me.constantOr(null),Fe,Le)&&(je=!0)}return je}function Xc(F,Me,Le,Oe,Fe,je){const qe=je.patternDependencies;for(const He of Me){const Me=He.paint.get(`${F}-pattern`).value;if("constant"!==Me.kind){let F=Me.evaluate({zoom:Oe},Le,{},je.availableImages);F=F&&F.name?F.name:F;const xt=Yc(F,qe,Fe);xt&&(Le.patterns[He.id]=xt)}}return Le}var A_,I_,C_,P_,z_,R_,D_,L_={};function nh(){if(I_)return A_;I_=1;var Me=j();function e(Me,Le,Oe,Fe,je){(this||F).properties={},(this||F).extent=Oe,(this||F).type=0,(this||F)._pbf=Me,(this||F)._geometry=-1,(this||F)._keys=Fe,(this||F)._values=je,Me.readFields(r,this||F,Le)}function r(F,Me,Le){1==F?Me.id=Le.readVarint():2==F?function(F,Me){for(var Le=F.readVarint()+F.pos;F.pos<Le;){var Oe=Me._keys[F.readVarint()],Fe=Me._values[F.readVarint()];Me.properties[Oe]=Fe}}(Le,Me):3==F?Me.type=Le.readVarint():4==F&&(Me._geometry=Le.pos)}function n(F){for(var Me,Le,Oe=0,Fe=0,je=F.length,qe=je-1;Fe<je;qe=Fe++)Oe+=((Le=F[qe]).x-(Me=F[Fe]).x)*(Me.y+Le.y);return Oe}return A_=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var Le=(this||F)._pbf;Le.pos=(this||F)._geometry;for(var Oe,Fe=Le.readVarint()+Le.pos,je=1,qe=0,He=0,xt=0,Pt=[];Le.pos<Fe;){if(qe<=0){var jt=Le.readVarint();je=7&jt,qe=jt>>3}if(qe--,1===je||2===je)He+=Le.readSVarint(),xt+=Le.readSVarint(),1===je&&(Oe&&Pt.push(Oe),Oe=[]),Oe.push(new Me(He,xt));else{if(7!==je)throw new Error("unknown command "+je);Oe&&Oe.push(Oe[0].clone())}}return Oe&&Pt.push(Oe),Pt},e.prototype.bbox=function(){var Me=(this||F)._pbf;Me.pos=(this||F)._geometry;for(var Le=Me.readVarint()+Me.pos,Oe=1,Fe=0,je=0,qe=0,He=1/0,xt=-1/0,Pt=1/0,jt=-1/0;Me.pos<Le;){if(Fe<=0){var Gt=Me.readVarint();Oe=7&Gt,Fe=Gt>>3}if(Fe--,1===Oe||2===Oe)(je+=Me.readSVarint())<He&&(He=je),je>xt&&(xt=je),(qe+=Me.readSVarint())<Pt&&(Pt=qe),qe>jt&&(jt=qe);else if(7!==Oe)throw new Error("unknown command "+Oe)}return[He,Pt,xt,jt]},e.prototype.toGeoJSON=function(Me,Le,Oe){var Fe,je,qe=(this||F).extent*Math.pow(2,Oe),He=(this||F).extent*Me,xt=(this||F).extent*Le,Pt=this.loadGeometry(),jt=e.types[(this||F).type];function p(F){for(var Me=0;Me<F.length;Me++){var Le=F[Me];F[Me]=[360*(Le.x+He)/qe-180,360/Math.PI*Math.atan(Math.exp((180-360*(Le.y+xt)/qe)*Math.PI/180))-90]}}switch((this||F).type){case 1:var Gt=[];for(Fe=0;Fe<Pt.length;Fe++)Gt[Fe]=Pt[Fe][0];p(Pt=Gt);break;case 2:for(Fe=0;Fe<Pt.length;Fe++)p(Pt[Fe]);break;case 3:for(Pt=function(F){var Me=F.length;if(Me<=1)return[F];for(var Le,Oe,Fe=[],je=0;je<Me;je++){var qe=n(F[je]);0!==qe&&(void 0===Oe&&(Oe=qe<0),Oe===qe<0?(Le&&Fe.push(Le),Le=[F[je]]):Le.push(F[je]))}return Le&&Fe.push(Le),Fe}(Pt),Fe=0;Fe<Pt.length;Fe++)for(je=0;je<Pt[Fe].length;je++)p(Pt[Fe][je])}1===Pt.length?Pt=Pt[0]:jt="Multi"+jt;var bi={type:"Feature",geometry:{type:jt,coordinates:Pt},properties:(this||F).properties};return"id"in(this||F)&&(bi.id=(this||F).id),bi},A_}function ih(){if(P_)return C_;P_=1;var Me=nh();function e(Me,Le){(this||F).version=1,(this||F).name=null,(this||F).extent=4096,(this||F).length=0,(this||F)._pbf=Me,(this||F)._keys=[],(this||F)._values=[],(this||F)._features=[],Me.readFields(r,this||F,Le),(this||F).length=(this||F)._features.length}function r(F,Me,Le){15===F?Me.version=Le.readVarint():1===F?Me.name=Le.readString():5===F?Me.extent=Le.readVarint():2===F?Me._features.push(Le.pos):3===F?Me._keys.push(Le.readString()):4===F&&Me._values.push(function(F){for(var Me=null,Le=F.readVarint()+F.pos;F.pos<Le;){var Oe=F.readVarint()>>3;Me=1===Oe?F.readString():2===Oe?F.readFloat():3===Oe?F.readDouble():4===Oe?F.readVarint64():5===Oe?F.readVarint():6===Oe?F.readSVarint():7===Oe?F.readBoolean():null}return Me}(Le))}return C_=e,e.prototype.feature=function(Le){if(Le<0||Le>=(this||F)._features.length)throw new Error("feature index out of bounds");(this||F)._pbf.pos=(this||F)._features[Le];var Oe=(this||F)._pbf.readVarint()+(this||F)._pbf.pos;return new Me((this||F)._pbf,Oe,(this||F).extent,(this||F)._keys,(this||F)._values)},C_}function sh(){return D_||(D_=1,L_.VectorTile=function(){if(R_)return z_;R_=1;var Me=ih();function e(F,Le,Oe){if(3===F){var Fe=new Me(Oe,Oe.readVarint()+Oe.pos);Fe.length&&(Le[Fe.name]=Fe)}}return z_=function(Me,Le){(this||F).layers=Me.readFields(e,{},Le)},z_}(),L_.VectorTileFeature=nh(),L_.VectorTileLayer=ih()),L_}var O_=sh();const k_="3d_elevation_id",F_="level";class uh{constructor(){this._valid=!1}reset(F){return this.feature=F,this._valid=!0,this._geometry=F.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry(F,Me){return this._valid&&F(Me(this._geometry)),this}require(F,Me,Le){return this.get(F,!0,Me,Le)}optional(F,Me,Le){return this.get(F,!1,Me,Le)}success(){return this._valid}get(F,Me,Le,Oe){const Fe=this.feature.properties.hasOwnProperty(F)?+this.feature.properties[F]:void 0;return this._valid&&void 0!==Fe?Le(Oe?Oe(Fe):Fe):Me&&(this._valid=!1),this}}class ch{constructor(F,Me){this.featureFunc=F,this.vertexFunc=Me}parseFeature(F,Me,Le){return this.featureFunc(F,Me,Le)}parseVertex(F,Me,Le){return this.vertexFunc(F,Me,Le)}}const B_=new ch(((F,Me,Le)=>F.reset(Me).require(k_,(F=>{Le.id=F})).optional("fixed_height_relative",(F=>{Le.constantHeight=F}),fh.decodeRelativeHeight).geometry((F=>{Le.bounds=F}),fh.computeBounds).success()),((F,Me,Le)=>F.reset(Me).require(k_,(F=>{Le.id=F})).require("elevation_idx",(F=>{Le.idx=F})).require("extent",(F=>{Le.extent=F})).require("height_relative",(F=>{Le.height=F}),fh.decodeRelativeHeight).geometry((F=>{Le.position=F}),fh.getPoint).success())),N_=new ch(((F,Me,Le)=>F.reset(Me).require(k_,(F=>{Le.id=F})).optional("fixed_height",(F=>{Le.constantHeight=F}),fh.decodeMetricHeight).geometry((F=>{Le.bounds=F}),fh.computeBounds).success()),((F,Me,Le)=>F.reset(Me).require(k_,(F=>{Le.id=F})).require("elevation_idx",(F=>{Le.idx=F})).require("extent",(F=>{Le.extent=F})).require("height",(F=>{Le.height=F}),fh.decodeMetricHeight).geometry((F=>{Le.position=F}),fh.getPoint).success()));class fh{static computeBounds(F){const Me=new ec(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Le=new ec(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const Oe of F[0])Me.x>Oe.x&&(Me.x=Oe.x),Me.y>Oe.y&&(Me.y=Oe.y),Le.x<Oe.x&&(Le.x=Oe.x),Le.y<Oe.y&&(Le.y=Oe.y);return{min:Me,max:Le}}static getPoint(F){return bl.vec2.fromValues(F[0][0].x,F[0][0].y)}static decodeRelativeHeight(F){return 1e-4*F*5}static decodeMetricHeight(F){return 1e-4*F}static parse(F){const Me=[],Le=[],Oe=F.length,Fe=new uh;for(let qe=0;qe<Oe;qe++){const Oe=F.feature(qe),He=Oe.properties.hasOwnProperty("version")?String(Oe.properties.version):void 0,xt=(je=He)?"1.0.1"===je?N_:void 0:B_;if(void 0===xt){pt(`Unknown elevation feature version number ${He||"(unknown)"}`);continue}const Pt=Oe.properties.hasOwnProperty("type")?Oe.properties.type:void 0;if(Pt)if("Point"===O_.VectorTileFeature.types[Oe.type]&&"curve_point"===Pt){const F={};xt.parseVertex(Fe,Oe,F)&&Me.push(F)}else if("Polygon"===O_.VectorTileFeature.types[Oe.type]&&"curve_meta"===Pt){const F={};xt.parseFeature(Fe,Oe,F)&&Le.push(F)}}var je;return{vertices:Me,features:Le}}}class dh{constructor(F,Me,Le,Oe,Fe,je){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=F,this.heightRange={min:Le,max:Le},this.safeArea=Me,this.constantHeight=Le,null==this.constantHeight&&(null!=this.constantHeight||0!==Oe.length)){this.vertices=Oe,this.edges=Fe,this.edges=this.edges.filter((F=>F.a<this.vertices.length&&F.b<this.vertices.length&&!bl.vec2.exactEquals(this.vertices[F.a].position,this.vertices[F.b].position))),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const F of this.vertices)this.vertexProps.push({dir:bl.vec2.fromValues(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,F.height),this.heightRange.max=Math.max(this.heightRange.max,F.height);for(const F of this.edges){const Me=this.vertices[F.a].position,Le=this.vertices[F.b].position,Oe=bl.vec2.subtract(bl.vec2.create(),Le,Me),Fe=bl.vec2.length(Oe),je=bl.vec2.scale(bl.vec2.create(),Oe,1/Fe);this.edgeProps.push({vec:Oe,dir:je,len:Fe});const qe=this.vertexProps[F.a].dir,He=this.vertexProps[F.b].dir;bl.vec2.add(qe,qe,je),bl.vec2.add(He,He,je)}for(const F of this.vertexProps)0===F.dir[0]&&0===F.dir[1]||bl.vec2.normalize(F.dir,F.dir);this.tessellate(je)}}pointElevation(F){if(null!=this.constantHeight)return this.constantHeight;const Me=this.getClosestEdge(F);if(null==Me)return 0;const[Le,Oe]=Me;return((F,Me,Le)=>(1-Le)*F+Le*Me)(this.vertices[this.edges[Le].a].height,this.vertices[this.edges[Le].b].height,Oe)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(F){if(0===this.edges.length)return;let Me=0,Le=Number.POSITIVE_INFINITY,Oe=0;const Fe=bl.vec2.fromValues(F.x,F.y);for(let F=0;F<this.edges.length;F++){const je=this.edges[F],qe=this.edgeProps[F].dir,He=new yu(Fe,this.edgeProps[F].dir),xt=this.vertices[je.a].position,Pt=this.vertices[je.b].position,jt=bl.vec2.create(),Gt=bl.vec2.create(),bi=He.intersectsPlane(xt,this.vertexProps[je.a].dir,jt),wi=He.intersectsPlane(Pt,this.vertexProps[je.b].dir,Gt);if(!bi||!wi)continue;const qr=bl.vec2.subtract(bl.vec2.create(),Gt,jt),Xn=bl.vec2.subtract(bl.vec2.create(),Fe,jt),Yn=bl.vec2.dot(qr,qr),yo=Yn>0?bl.vec2.dot(Xn,qr)/Yn:0,bo=Q(yo,0,1),Ro=Math.abs((yo-bo)*this.edgeProps[F].len),Do=bl.vec2.subtract(bl.vec2.create(),Fe,xt),zs=Ro+Math.abs(bl.vec2.dot(Do,bl.vec2.fromValues(qe[1],-qe[0])));zs<Le&&(Me=F,Le=zs,Oe=bo)}return[Me,Oe]}tessellate(F){for(let Me=this.edges.length-1;Me>=0;--Me){const Le=this.edges[Me].a,Oe=this.edges[Me].b,{position:Fe,height:je,extent:qe}=this.vertices[Le],{position:He,height:xt,extent:Pt}=this.vertices[Oe],jt=this.vertexProps[Le].dir,Gt=this.vertexProps[Oe].dir,bi=bl.vec3.fromValues(Fe[0]/F,Fe[1]/F,je),wi=bl.vec3.fromValues(He[0]/F,He[1]/F,xt),qr=bl.vec3.fromValues(jt[1],-jt[0],0);bl.vec3.scale(qr,qr,qe);const Xn=bl.vec3.fromValues(Gt[1],-Gt[0],0);if(bl.vec3.scale(Xn,Xn,Pt),this.distSqLines(bl.vec3.fromValues(bi[0]+.5*qr[0],bi[1]+.5*qr[1],bi[2]+.5*qr[2]),bl.vec3.fromValues(wi[0]-.5*Xn[0],wi[1]-.5*Xn[1],wi[2]-.5*Xn[2]),bl.vec3.fromValues(bi[0]-.5*qr[0],bi[1]-.5*qr[1],bi[2]-.5*qr[2]),bl.vec3.fromValues(wi[0]+.5*Xn[0],wi[1]+.5*Xn[1],wi[2]+.5*Xn[2]))<=.05*.05)continue;const Yn=this.vertices.length,yo=bl.vec2.add(bl.vec2.create(),Fe,He);this.vertices.push({position:bl.vec2.scale(yo,yo,.5),height:.5*(je+xt),extent:.5*(qe+Pt)});const bo=bl.vec2.add(bl.vec2.create(),jt,Gt);this.vertexProps.push({dir:bl.vec2.normalize(bo,bo)}),this.edges.splice(Me,1),this.edgeProps.splice(Me,1),this.edges.push({a:Le,b:Yn}),this.edges.push({a:Yn,b:Oe});const Ro=bl.vec2.subtract(bl.vec2.create(),this.vertices[Yn].position,Fe),Do=bl.vec2.length(Ro),zs={vec:Ro,dir:bl.vec2.scale(bl.vec2.create(),Ro,1/Do),len:Do};this.edgeProps.push(zs),this.edgeProps.push(zs)}}distSqLines(F,Me,Le,Oe){const Fe=bl.vec3.subtract(bl.vec3.create(),Me,F),je=bl.vec3.subtract(bl.vec3.create(),Oe,Le),qe=bl.vec3.subtract(bl.vec3.create(),F,Le),He=bl.vec3.dot(Fe,Fe),xt=bl.vec3.dot(Fe,je),Pt=bl.vec3.dot(Fe,qe),jt=bl.vec3.dot(je,je),Gt=bl.vec3.dot(je,qe),bi=He*jt-xt*xt;if(0===bi){const Me=bl.vec3.dot(qe,je)/bl.vec3.dot(je,je),Fe=bl.vec3.lerp(bl.vec3.create(),Le,Oe,Me);return bl.vec3.squaredDistance(Fe,F)}const wi=(xt*Gt-Pt*jt)/bi,qr=(He*Gt-xt*Pt)/bi,Xn=bl.vec3.lerp(bl.vec3.create(),F,Me,wi),Yn=bl.vec3.lerp(bl.vec3.create(),Le,Oe,qr);return bl.vec3.squaredDistance(Xn,Yn)}}class mh{constructor(F,Me){this.zScale=1,this.xOffset=0,this.yOffset=0,F.equals(Me)||(this.zScale=Math.pow(2,Me.z-F.z),this.xOffset=(F.x*this.zScale-Me.x)*np,this.yOffset=(F.y*this.zScale-Me.y)*np)}constantElevation(F,Me){if(null!=F.constantHeight)return this.computeBiasedHeight(F.constantHeight,Me)}pointElevation(F,Me,Le){const Oe=this.constantElevation(Me,Le);return null!=Oe?Oe:(F.x=F.x*this.zScale+this.xOffset,F.y=F.y*this.zScale+this.yOffset,this.computeBiasedHeight(Me.pointElevation(F),Le))}computeBiasedHeight(F,Me){return Me<=0?F:F+Me*tt(0,Me,F>=0?F:Math.abs(.5*F))}}us(dh,"ElevationFeature");class yh{constructor(){this.polygons=new Map}add(F,...Me){this.polygons.has(F)?this.polygons.get(F).push(...Me):this.polygons.set(F,Me)}merge(F){for(const[Me,Le]of F.polygons)this.add(Me,...Le)}}class gh{constructor(){this.portals=[]}static evaluate(F){if(0===F.length)return new gh;let Me=[];for(const Le of F)Me.push(...Le.portals);if(0===Me.length)return new gh;const r=(F,Me)=>F<=0&&Me<=0||F>=np&&Me>=np;for(const F of Me){const Me=F.va,Le=F.vb;(r(Me.x,Le.x)||r(Me.y,Le.y))&&(F.type="border")}const Le=Me.filter((F=>"unevaluated"!==F.type)),Oe=Me.filter((F=>"unevaluated"===F.type));if(0===Oe.length)return new gh;Oe.sort(((F,Me)=>F.hash===Me.hash?F.isTunnel===Me.isTunnel?0:F.isTunnel?-1:1:F.hash<Me.hash?1:-1)),Me=Le.concat(Oe);let Fe=Le.length,je=Fe,qe=Fe;do{if(je++,je===Me.length||Me[Fe].hash!==Me[je].hash){if(je-Fe==2){qe<Fe&&(Me[qe]=Me[Fe],Me[Fe]=null);const F=Me[qe],Le=Me[je-1];F.type=F.isTunnel!==Le.isTunnel?"tunnel":"polygon",F.connection={a:F.connection.a,b:Le.connection.a},qe++}Fe=je}}while(Fe!==Me.length);return Me.splice(qe),Me.sort(((F,Me)=>F.hash<Me.hash?1:-1)),{portals:Me}}}us(gh,"ElevationPortalGraph"),us(yh,"ElevationPolygons");class xh{constructor(F,Me,Le){this.outPositions=F,this.outNormals=Me,this.outIndices=Le,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(F,Me,Le){let Oe=F[2];null!=Le&&(Oe*=Le);const Fe=this.getVec3Bits(F)<<96n|this.getVec3Bits(Me),je=this.vertexLookup.get(Fe);if(null!=je)return je;const qe=this.outPositions.length;this.vertexLookup.set(Fe,qe);const He=Math.trunc(16384*Me[0]),xt=Math.trunc(16384*Me[1]),Pt=Math.trunc(16384*Me[2]);return this.outPositions.emplaceBack(F[0],F[1],Oe),this.outNormals.emplaceBack(He,xt,Pt),qe}addVertices(F,Me,...Le){const Oe=[];for(const Fe of Le){const Le=this.addVertex(Fe,F,Me);Oe.push(Le)}return Oe}addTriangles(F,Me,Le){if(Me&&Le){const Oe=1===Le.length,Fe=bl.vec3.fromValues(0,0,0);for(let je=0;je<F.length;je+=3){const qe=Me[F[je+0]],He=Me[F[je+1]],xt=Me[F[je+2]],Pt=Oe?Le[0]:Le[F[je+1]],jt=Oe?Le[0]:Le[F[je+2]],Gt=this.addVertex(bl.vec3.fromValues(qe.x,qe.y,Oe?Le[0]:Le[F[je+0]]),Fe),bi=this.addVertex(bl.vec3.fromValues(He.x,He.y,Pt),Fe),wi=this.addVertex(bl.vec3.fromValues(xt.x,xt.y,jt),Fe);this.outIndices.emplaceBack(Gt,bi,wi)}}else for(let Me=0;Me<F.length;Me+=3)this.outIndices.emplaceBack(F[Me+0],F[Me+1],F[Me+2])}addQuad(F,Me){const Le=this.addVertices(Me,void 0,...F.map((F=>bl.vec3.fromValues(F.coord.x,F.coord.y,F.height)))),[Oe,Fe,je,qe]=Le;this.addTriangles([Oe,Fe,je,je,qe,Oe])}getBits(F){return this.view.setFloat32(0,F),BigInt(this.view.getUint32(0))}getVec3Bits(F){return this.getBits(F[0])<<64n|this.getBits(F[1])<<32n|this.getBits(F[2])}}class vh{constructor(F){this.unevaluatedPortals=new gh,this.portalPolygons=new yh,this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Ia,this.vertexNormals=new Sa,this.indexArray=new ja,this.tileToMeters=Al(F)}addVertices(F,Me){const Le=this.unevalVertices.length;for(let Le=0;Le<F.length;Le++)this.unevalVertices.push(F[Le]),this.unevalHeights.push(Me[Le]);return Le}addTriangles(F,Me,Le){const Oe=Le?this.unevalTunnelTriangles:this.unevalTriangles;for(const Le of F)Oe.push(Le+Me)}addRenderableRing(F,Me,Le,Oe,Fe){const je=[new ec(Fe.min.x,Fe.min.y),new ec(Fe.max.x,Fe.min.y),new ec(Fe.max.x,Fe.max.y),new ec(Fe.min.x,Fe.max.y)];for(let qe=0;qe<Le-1;qe++){const Le=Me+qe,He=Le+1,xt=this.unevalVertices[Le],Pt=this.unevalVertices[He];if(!(xt.x>=Fe.min.x&&xt.x<=Fe.max.x&&xt.y>=Fe.min.y&&xt.y<=Fe.max.y||Pt.x>=Fe.min.x&&Pt.x<=Fe.max.x&&Pt.y>=Fe.min.y&&Pt.y<=Fe.max.y||Zl(xt,Pt,je)))continue;if(this.isOnBorder(xt.x,Pt.x)||this.isOnBorder(xt.y,Pt.y))continue;const jt=vh.computeEdgeHash(this.unevalVertices[Le],this.unevalVertices[He]);let Gt,bi=this.vertexHashLookup.get(vh.computePosHash(xt));null!=bi?Gt=bi.next:(bi=this.vertexHashLookup.get(vh.computePosHash(Pt)),Gt=null!=bi?bi.prev:jt),this.unevalEdges.push({polygonIdx:F,a:Le,b:He,hash:jt,portalHash:Gt,isTunnel:Oe,type:"unevaluated"})}}addPortalCandidates(F,Me,Le,Oe,Fe){if(0===Me.length)return;this.portalPolygons.add(F,{geometry:Me,zLevel:Fe});const je=Me[0];this.vertexHashLookup.clear();let qe=vh.computeEdgeHash(je[je.length-2],je[je.length-1]);for(let Me=0;Me<je.length-1;Me++){const Fe=je[Me+0],He=je[Me+1],xt=bl.vec2.fromValues(He.x-Fe.x,He.y-Fe.y),Pt=bl.vec2.length(xt);if(0===Pt)continue;let jt="unevaluated";const Gt=Oe.pointElevation(Fe),bi=Oe.pointElevation(He);Math.abs(Gt)<.01&&Math.abs(bi)<.01?jt="entrance":(this.isOnBorder(Fe.x,He.x)||this.isOnBorder(Fe.y,He.y))&&(jt="border");const wi=vh.computeEdgeHash(Fe,He);this.unevaluatedPortals.portals.push({connection:{a:F,b:void 0},va:Fe,vb:He,vab:xt,length:Pt,hash:wi,isTunnel:Le,type:jt});const qr=vh.computePosHash(Fe);this.vertexHashLookup.set(qr,{prev:qe,next:wi}),qe=wi}}construct(F){if(0===this.unevalVertices.length)return;const e=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),r=F=>{F.primitiveLength=this.indexArray.length-F.primitiveOffset},Me=new xh(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(F.portals,this.unevalEdges);const Le=e(),Oe=e(),Fe=e(),o=(F,Me)=>{F.sort(((F,Le)=>F.type===Me&&Le.type!==Me?-1:F.type!==Me&&Le.type===Me?1:0));const Le=F.findIndex((F=>F.type!==Me));return Le>=0?Le:F.length};let je=0;this.unevalEdges.length>0&&(je=o(this.unevalEdges,"none"),this.constructBridgeStructures(Me,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:je},this.tileToMeters));const qe=e();if(this.unevalEdges.length>0){const F=this.unevalEdges.splice(je),Le=o(F,"tunnel")+je;this.unevalEdges.push(...F),this.constructTunnelStructures(Me,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:je},{min:je,max:Le})}r(Fe),Me.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),r(qe),Me.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),r(Oe),Me.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),r(Le),this.maskSegments=xo.simpleSegment(0,qe.primitiveOffset,0,qe.primitiveLength),this.depthSegments=xo.simpleSegment(0,Oe.primitiveOffset,0,Oe.primitiveLength),this.renderableSegments=xo.simpleSegment(0,Fe.primitiveOffset,0,Fe.primitiveLength),this.shadowCasterSegments=xo.simpleSegment(0,Le.primitiveOffset,0,Le.primitiveLength)}upload(F){this.vertexBuffer||0===this.vertexPositions.length||0===this.vertexNormals.length||0===this.indexArray.length||(this.vertexBuffer=F.createVertexBuffer(this.vertexPositions,E_.members),this.vertexBufferNormal=F.createVertexBuffer(this.vertexNormals,M_.members),this.indexBuffer=F.createIndexBuffer(this.indexArray))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableSegments.destroy(),this.shadowCasterSegments.destroy())}computeVertexConnections(F,Me,Le,Oe){const Fe=new Map;for(let je=Le;je<Oe;je++){const Le=Me[je],Oe=Le.a,qe=Le.b;Fe.has(Oe)||Fe.set(Oe,{}),Fe.has(qe)||Fe.set(qe,{});const He=Fe.get(Oe),xt=Fe.get(qe);F[qe]>0&&(He.to=qe),F[Oe]>0&&(xt.from=Oe)}return Fe}constructBridgeStructures(F,Me,Le,Oe,Fe,je){const qe=this.computeVertexConnections(Le,Oe,Fe.min,Fe.max),He=1/je,xt=.5*He,u=F=>bl.vec3.fromValues(Me[F].x,Me[F].y,Le[F]*He),c=F=>{const Me=qe.get(F),Le=Me.from,Oe=Me.to;if(!Le||!Oe)return;const Fe=u(Le),je=u(F),He=u(Oe),xt=bl.vec3.fromValues(0,0,0);if(!bl.vec3.exactEquals(Fe,je)){const F=bl.vec3.sub(bl.vec3.create(),je,Fe);bl.vec3.add(xt,xt,bl.vec3.normalize(F,F))}if(!bl.vec3.exactEquals(He,je)){const F=bl.vec3.sub(bl.vec3.create(),He,je);bl.vec3.add(xt,xt,bl.vec3.normalize(F,F))}const Pt=bl.vec3.len(xt);return Pt>0?bl.vec3.scale(xt,xt,1/Pt):void 0};for(let qe=Fe.min;qe<Fe.max;qe++){const Fe=Oe[qe],Pt=this.prepareEdgePoints(Me,Le,Fe,((F,Me)=>F>=Me));if(null==Pt)continue;const jt=Pt[0],Gt=Pt[1],bi=bl.vec3.fromValues(jt.coord.x,jt.coord.y,He*jt.height),wi=bl.vec3.fromValues(Gt.coord.x,Gt.coord.y,He*Gt.height);if(bl.vec3.exactEquals(bi,wi))continue;const qr=bl.vec3.sub(bl.vec3.create(),wi,bi);bl.vec3.normalize(qr,qr);const y=F=>bl.vec3.normalize(F,F),Xn=c(Fe.a)||qr,Yn=c(Fe.b)||qr,yo=y(bl.vec3.fromValues(Xn[1],-Xn[0],0)),bo=y(bl.vec3.fromValues(Yn[1],-Yn[0],0)),Ro=y(bl.vec3.cross(bl.vec3.create(),yo,Xn)),Do=y(bl.vec3.cross(bl.vec3.create(),bo,Yn)),zs=bl.vec3.create(),Zs=[bl.vec3.add(bl.vec3.create(),bi,bl.vec3.scale(zs,bl.vec3.sub(zs,yo,Ro),xt)),bl.vec3.add(bl.vec3.create(),bi,bl.vec3.scale(zs,bl.vec3.add(zs,yo,Ro),xt)),bl.vec3.add(bl.vec3.create(),bi,bl.vec3.scale(zs,Ro,xt)),bi],na=[bl.vec3.add(bl.vec3.create(),wi,bl.vec3.scale(zs,bl.vec3.sub(zs,bo,Do),xt)),bl.vec3.add(bl.vec3.create(),wi,bl.vec3.scale(zs,bl.vec3.add(zs,bo,Do),xt)),bl.vec3.add(bl.vec3.create(),wi,bl.vec3.scale(zs,Do,xt)),wi],[el,nl]=F.addVertices(yo,je,Zs[0],Zs[1]),[hl,pl]=F.addVertices(bo,je,na[0],na[1]);F.addTriangles([el,nl,hl,nl,pl,hl]);const[Tl,kl]=F.addVertices(Ro,je,Zs[1],Zs[2]),[ec,tc]=F.addVertices(Do,je,na[1],na[2]);F.addTriangles([Tl,kl,ec,kl,tc,ec]);const[ic,oc]=F.addVertices(bl.vec3.negate(yo,yo),je,Zs[2],Zs[3]),[sc,ac]=F.addVertices(bl.vec3.negate(bo,bo),je,na[2],na[3]);F.addTriangles([ic,oc,sc,oc,ac,sc])}}constructTunnelStructures(F,Me,Le,Oe,Fe,je){const a=F=>bl.vec3.normalize(F,F);for(let je=Fe.min;je<Fe.max;je++){const Fe=this.prepareEdgePoints(Me,Le,Oe[je],((F,Me)=>F<=Me));if(null==Fe)continue;const[qe,He]=Fe,xt=a(bl.vec3.fromValues(He.coord.y-qe.coord.y,-(He.coord.x-qe.coord.x),0));F.addQuad([qe,He,{coord:He.coord,height:Oe[je].isTunnel?-.1:0},{coord:qe.coord,height:Oe[je].isTunnel?-.1:0}],xt)}for(let Fe=je.min;Fe<je.max;Fe++){const je=Oe[Fe],qe=Me[je.a],He=Me[je.b],xt=a(bl.vec3.fromValues(He.y-qe.y,-(He.x-qe.x),0));F.addQuad([{coord:He,height:0},{coord:qe,height:0},{coord:qe,height:Le[je.a]+4},{coord:He,height:Le[je.b]+4}],xt),F.addQuad([{coord:qe,height:0},{coord:He,height:0},{coord:He,height:Le[je.b]+4},{coord:qe,height:Le[je.a]+4}],xt)}}prepareEdgePoints(F,Me,Le,Oe){const Fe=F[Le.a],je=F[Le.b];let qe=Me[Le.a],He=Me[Le.b];if(!(0!==qe&&Oe(qe,0)||0!==He&&Oe(He,0)))return;const xt=Fe.clone(),Pt=je.clone();if(Oe(qe,0)){if(!Oe(He,0)){const F=He/(He-qe);Pt.x=Ee(Pt.x,xt.x,F),Pt.y=Ee(Pt.y,xt.y,F),He=Ee(He,qe,F)}}else{const F=qe/(qe-He);xt.x=Ee(xt.x,Pt.x,F),xt.y=Ee(xt.y,Pt.y,F),qe=Ee(qe,He,F)}return[{coord:xt,height:qe},{coord:Pt,height:He}]}prepareEdges(F,Me){if(0===Me.length)return;Me.sort(((F,Me)=>F.hash===Me.hash?Me.polygonIdx-F.polygonIdx:Me.hash>F.hash?1:-1));let Le=0,Oe=0,Fe=0,je=Me[Le].polygonIdx;do{Oe++,(Oe===Me.length||Me[Le].hash!==Me[Oe].hash)&&((1==Oe-Le||Me[Oe-1].polygonIdx!==je)&&(Fe<Le&&(Me[Fe]=Me[Le],Me[Le]=null),Me[Fe].type="none",Fe++),Le=Oe,Le!==Me.length&&(je=Me[Le].polygonIdx))}while(Le!==Me.length);if(Me.splice(Fe),0!==Me.length&&0!==F.length){Me.sort(((F,Me)=>F.hash<Me.hash?1:-1));let Le=0,Oe=0;for(;Le!==Me.length&&Oe!==F.length;){const Fe=Me[Le],je=F[Oe];Fe.portalHash>je.hash?Le++:je.hash>Fe.portalHash?Oe++:(Fe.type=je.type,Le++)}}}isOnBorder(F,Me){return F<=0&&Me<=0||F>=np&&Me>=np}static computeEdgeHash(F,Me){return(F.y===Me.y&&F.x>Me.x||F.y>Me.y)&&([F,Me]=[Me,F]),BigInt(vh.computePosHash(F))<<32n|BigInt(vh.computePosHash(Me))}static computePosHash(F){return((65535&F.x)<<16|65535&F.y)>>>0}}class bh{constructor(F,Me){this.layoutVertexArray=new _a,this.indexArray=new ja,this.lineIndexArray=new La,this.triangleSegments=new xo,this.lineSegments=new xo,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.uploaded=!1,Me&&(this.elevatedLayoutVertexArray=new Aa)}update(F,Me,Le,Oe,Fe,je,qe){this.programConfigurations.updatePaintArrays(F,Me,Fe,Le,Oe,je,qe)}isEmpty(){return 0===this.layoutVertexArray.length}needsUpload(){return this.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,T_.members),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.lineIndexBuffer=F.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=F.createVertexBuffer(this.elevatedLayoutVertexArray,S_.members))),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(F,Me,Le,Oe,Fe,je){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Me,Le,Oe,Fe,je)}}class _h{constructor(F){this.zoom=F.zoom,this.pixelRatio=F.pixelRatio,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.patternFeatures=[],this.bufferData=new bh(F,!1),this.elevationBufferData=new bh(F,!0),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.projection=F.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference")}updateFootprints(F,Me){}populate(F,Me,Le,Oe){this.hasPattern=Hc("fill",this.layers,this.pixelRatio,Me);const Fe=this.layers[0].layout.get("fill-sort-key"),je=[];for(const{feature:qe,id:He,index:xt,sourceLayerIndex:Pt}of F){const F=this.layers[0]._featureFilter.needGeometry,jt=Cl(qe,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),jt,Le))continue;const Gt=Fe?Fe.evaluate(jt,{},Le,Me.availableImages):void 0,bi={id:He,properties:qe.properties,type:qe.type,sourceLayerIndex:Pt,index:xt,geometry:F?jt.geometry:Vl(qe,Le,Oe),patterns:{},sortKey:Gt};je.push(bi)}Fe&&je.sort(((F,Me)=>F.sortKey-Me.sortKey));for(const Oe of je){const{geometry:Fe,index:je,sourceLayerIndex:qe}=Oe;if(this.hasPattern){const F=Xc("fill",this.layers,Oe,this.zoom,this.pixelRatio,Me);this.patternFeatures.push(F)}else this.addFeature(Oe,Fe,je,Le,{},Me.availableImages,Me.brightness,Me.elevationFeatures);Me.featureIndex.insert(F[je].feature,Fe,je,qe,this.index)}}update(F,Me,Le,Oe,Fe,je,qe){this.bufferData.update(F,Me,Le,Oe,Fe,je,qe),this.elevationBufferData.update(F,Me,Le,Oe,Fe,je,qe)}addFeatures(F,Me,Le,Oe,Fe,je){for(const Fe of this.patternFeatures)this.addFeature(Fe,Fe.geometry,Fe.index,Me,Le,Oe,je,F.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(F){this.bufferData.upload(F),this.elevationBufferData.upload(F),this.elevatedStructures&&this.elevatedStructures.upload(F)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(F,Me,Le,Oe,Fe,je=[],qe,He){const xt=$c(Me,500);"none"!==this.elevationMode?this.addElevatedRoadFeature(F,xt,Oe,Le,He):this.addGeometry(xt,this.bufferData),this.bufferData.populatePaintArrays(F,Le,Fe,je,Oe,qe),this.elevationBufferData.populatePaintArrays(F,Le,Fe,je,Oe,qe)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(F){this.elevatedStructures&&this.elevatedStructures.construct(F)}addElevatedRoadFeature(F,Me,Le,Oe,Fe){const je=new Array,qe=this.getElevationFeature(F,Fe);if(qe){je.push({polygons:Me,elevationFeature:qe,elevationTileID:Le});for(const Me of je)if(Me.elevationFeature){if("hd-road-base"===this.elevationMode){this.elevatedStructures||(this.elevatedStructures=new vh(Me.elevationTileID));const Le=Me.elevationFeature.isTunnel();let Oe=0;F.properties.hasOwnProperty(F_)&&(Oe=+F.properties[F_]);for(const F of Me.polygons)this.elevatedStructures.addPortalCandidates(Me.elevationFeature.id,F,Le,Me.elevationFeature,Oe)}const Fe=new mh(Le,Me.elevationTileID);this.addElevatedGeometry(Me.polygons,Fe,Me.elevationFeature,"hd-road-base"===this.elevationMode?0:.05,Oe)}}else this.addGeometry(Me,this.bufferData)}addElevatedGeometry(F,Me,Le,Oe,Fe){const je={elevation:Le,elevationSampler:Me,bias:Oe,index:Fe},[qe,He]=this.addGeometry(F,this.elevationBufferData,je);null==this.elevationBufferData.heightRange?this.elevationBufferData.heightRange={min:qe,max:He}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,qe),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,He))}addGeometry(F,Me,Le){let Oe=Number.POSITIVE_INFINITY,Fe=Number.NEGATIVE_INFINITY,je=null;Le&&(je=Le.elevationSampler.constantElevation(Le.elevation,Le.bias),null!=je&&(Oe=je,Fe=je));const a=(F,qe,He)=>{if(null!=Le)if(qe.push(F),null!=je)Me.elevatedLayoutVertexArray.emplaceBack(je),He.push(je);else{const je=Le.elevationSampler.pointElevation(F,Le.elevation,Le.bias);Me.elevatedLayoutVertexArray.emplaceBack(je),He.push(je),Oe=Math.min(Oe,je),Fe=Math.max(Fe,je)}};for(const Oe of F){let F=0;for(const Me of Oe)F+=Me.length;const Fe=Me.triangleSegments.prepareSegment(F,Me.layoutVertexArray,Me.indexArray),je=Fe.vertexLength,qe=[],He=[],xt=[],Pt=[],jt=[],Gt=Me.layoutVertexArray.length;for(const F of Oe){if(0===F.length)continue;F!==Oe[0]&&He.push(qe.length/2);const Fe=Me.lineSegments.prepareSegment(F.length,Me.layoutVertexArray,Me.lineIndexArray),je=Fe.vertexLength;Le&&jt.push(Me.layoutVertexArray.length-Gt),a(F[0],xt,Pt),Me.layoutVertexArray.emplaceBack(F[0].x,F[0].y),Me.lineIndexArray.emplaceBack(je+F.length-1,je),qe.push(F[0].x),qe.push(F[0].y);for(let Le=1;Le<F.length;Le++)a(F[Le],xt,Pt),Me.layoutVertexArray.emplaceBack(F[Le].x,F[Le].y),Me.lineIndexArray.emplaceBack(je+Le-1,je+Le),qe.push(F[Le].x),qe.push(F[Le].y);Fe.vertexLength+=F.length,Fe.primitiveLength+=F.length}const bi=vc(qe,He);for(let F=0;F<bi.length;F+=3)Me.indexArray.emplaceBack(je+bi[F],je+bi[F+1],je+bi[F+2]);if(Le&&"hd-road-base"===this.elevationMode){const F=Le.elevation.isTunnel(),Me=Le.elevation.safeArea,Oe=this.elevatedStructures.addVertices(xt,Pt);this.elevatedStructures.addTriangles(bi,Oe,F);const Fe=jt.length;if(Fe>0){for(let je=0;je<Fe-1;je++)this.elevatedStructures.addRenderableRing(Le.index,jt[je]+Oe,jt[je+1]-jt[je],F,Me);this.elevatedStructures.addRenderableRing(Le.index,jt[Fe-1]+Oe,xt.length-jt[Fe-1],F,Me)}}Fe.vertexLength+=F,Fe.primitiveLength+=bi.length/3}return[Oe,Fe]}getElevationFeature(F,Me){if(!Me)return;const Le=+F.properties[k_];return null!=Le?Me.find((F=>F.id===Le)):void 0}}let V_,U_,j_,G_;us(_h,"FillBucket",{omit:["layers","patternFeatures"]}),us(bh,"FillBufferData"),us(vh,"ElevatedStructures");class Sh{constructor(F,Me,Le,Oe){if(this.triangleCount=Me.length/3,this.min=new ec(0,0),this.max=new ec(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===F.length)return;const[Fe,je]=[F[0].clone(),F[0].clone()];for(let Me=1;Me<F.length;++Me){const Le=F[Me];Fe.x=Math.min(Fe.x,Le.x),Fe.y=Math.min(Fe.y,Le.y),je.x=Math.max(je.x,Le.x),je.y=Math.max(je.y,Le.y)}if(Oe){const F=Math.ceil(Math.max(je.x-Fe.x,je.y-Fe.y)/Oe);Le=Math.max(Le,F)}if(0===Le)return;this.min=Fe,this.max=je;const qe=this.max.sub(this.min);qe.x=Math.max(qe.x,1),qe.y=Math.max(qe.y,1);const He=Math.max(qe.x,qe.y)/Le;this.cellsX=Math.max(1,Math.ceil(qe.x/He)),this.cellsY=Math.max(1,Math.ceil(qe.y/He)),this.xScale=1/He,this.yScale=1/He;const xt=[];for(let Le=0;Le<this.triangleCount;Le++){const Oe=F[Me[3*Le+0]].sub(this.min),Fe=F[Me[3*Le+1]].sub(this.min),je=F[Me[3*Le+2]].sub(this.min),qe=Ph(Math.floor(Math.min(Oe.x,Fe.x,je.x)),this.xScale,this.cellsX),Pt=Ph(Math.floor(Math.max(Oe.x,Fe.x,je.x)),this.xScale,this.cellsX),jt=Ph(Math.floor(Math.min(Oe.y,Fe.y,je.y)),this.yScale,this.cellsY),Gt=Ph(Math.floor(Math.max(Oe.y,Fe.y,je.y)),this.yScale,this.cellsY),bi=new ec(0,0),wi=new ec(0,0),qr=new ec(0,0),Xn=new ec(0,0);for(let F=jt;F<=Gt;++F){bi.y=wi.y=F*He,qr.y=Xn.y=(F+1)*He;for(let Me=qe;Me<=Pt;++Me)bi.x=qr.x=Me*He,wi.x=Xn.x=(Me+1)*He,(Kl(Oe,Fe,je,bi,wi,Xn)||Kl(Oe,Fe,je,bi,Xn,qr))&&xt.push({cellIdx:F*this.cellsX+Me,triIdx:Le})}}if(0===xt.length)return;xt.sort(((F,Me)=>F.cellIdx-Me.cellIdx||F.triIdx-Me.triIdx));let Pt=0;for(;Pt<xt.length;){const F=xt[Pt].cellIdx,Me={start:this.payload.length,len:0};for(;Pt<xt.length&&xt[Pt].cellIdx===F;)++Me.len,this.payload.push(xt[Pt++].triIdx);this.cells[F]=Me}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(F,Me){if(0===this.triangleCount||0===this.cells.length)return;if(F.x>this.max.x||this.min.x>F.x||F.y>this.max.y||this.min.y>F.y)return;const Le=Ph(F.x-this.min.x,this.xScale,this.cellsX),Oe=Ph(F.y-this.min.y,this.yScale,this.cellsY),Fe=this.cells[Oe*this.cellsX+Le];if(Fe){this._lazyInitLookup();for(let F=0;F<Fe.len;F++){const Le=this.payload[Fe.start+F],Oe=Math.floor(Le/8),je=1<<Le%8;if(!(this.lookup[Oe]&je)&&(this.lookup[Oe]|=je,Me.push(Le),Me.length===this.triangleCount))return}}}query(F,Me,Le){if(0===this.triangleCount||0===this.cells.length)return;if(F.x>this.max.x||this.min.x>Me.x)return;if(F.y>this.max.y||this.min.y>Me.y)return;this._lazyInitLookup();const Oe=Ph(F.x-this.min.x,this.xScale,this.cellsX),Fe=Ph(Me.x-this.min.x,this.xScale,this.cellsX),je=Ph(F.y-this.min.y,this.yScale,this.cellsY),qe=Ph(Me.y-this.min.y,this.yScale,this.cellsY);for(let F=je;F<=qe;F++)for(let Me=Oe;Me<=Fe;Me++){const Oe=this.cells[F*this.cellsX+Me];if(Oe)for(let F=0;F<Oe.len;F++){const Me=this.payload[Oe.start+F],Fe=Math.floor(Me/8),je=1<<Me%8;if(!(this.lookup[Fe]&je)&&(this.lookup[Fe]|=je,Le.push(Me),Le.length===this.triangleCount))return}}}}function Ph(F,Me,Le){return Math.max(0,Math.min(Le-1,Math.floor(F*Me)))}us(Sh,"TriangleGridIndex");class Eh{constructor(F){this.zoom=F.zoom,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.footprints=[]}updateFootprints(F,Me){for(const Le of this.footprints)Me.push({footprint:Le,id:F})}populate(F,Me,Le,Oe){const Fe=[];for(const{feature:Me,id:je,index:qe,sourceLayerIndex:He}of F){const F=this.layers[0]._featureFilter.needGeometry,xt=Cl(Me,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),xt,Le))continue;const Pt={id:je,properties:Me.properties,type:Me.type,sourceLayerIndex:He,index:qe,geometry:F?xt.geometry:Vl(Me,Le,Oe),patterns:{}};Fe.push(Pt)}for(const Oe of Fe){const{geometry:Fe,index:je,sourceLayerIndex:qe}=Oe;this.addFeature(Oe,Fe,je,Le,{},Me.availableImages,Me.brightness),Me.featureIndex.insert(F[je].feature,Fe,je,qe,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(F){}update(F,Me,Le,Oe,Fe,je,qe){}destroy(){}addFeature(F,Me,Le,Oe,Fe,je=[],qe){for(const F of $c(Me,2)){const Me=[],Le=[],Oe=[],Fe=new ec(1/0,1/0),je=new ec(-1/0,-1/0);for(const qe of F)if(0!==qe.length){qe!==F[0]&&Oe.push(Le.length/2);for(let F=0;F<qe.length;F++)Le.push(qe[F].x),Le.push(qe[F].y),Me.push(qe[F]),Fe.x=Math.min(Fe.x,qe[F].x),Fe.y=Math.min(Fe.y,qe[F].y),je.x=Math.max(je.x,qe[F].x),je.y=Math.max(je.y,qe[F].y)}const qe=vc(Le,Oe),He=new Sh(Me,qe,8,256);this.footprints.push({vertices:Me,indices:qe,grid:He,min:Fe,max:je})}}}us(Eh,"ClipBucket",{omit:["layers"]});const q_=va([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),H_=va([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),$_=va([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Z_=va([{name:"a_join_normal_inside",components:3,type:"Int16"}]),W_=va([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),X_=va([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Y_}=q_;class Rh extends ec{constructor(F,Me,Le){super(F,Me),this.z=Le}}class Lh extends Rh{constructor(F,Me,Le,Oe){super(F,Me,Le),this.w=Oe}}function Fh(F,Me,Le,Oe){const Fe=[],je=0===Oe?(F,Me,Le,Oe,Fe,je)=>{F.push(new ec(je,Le+(je-Me)/(Oe-Me)*(Fe-Le)))}:(F,Me,Le,Oe,Fe,je)=>{F.push(new ec(Me+(je-Le)/(Fe-Le)*(Oe-Me),je))};for(const qe of F){const F=[];for(const Fe of qe){if(Fe.length<=2)continue;const qe=[];for(let F=0;F<Fe.length-1;F++){const He=Fe[F].x,xt=Fe[F].y,Pt=Fe[F+1].x,jt=Fe[F+1].y,Gt=0===Oe?He:xt,bi=0===Oe?Pt:jt;Gt<Me?bi>Me&&je(qe,He,xt,Pt,jt,Me):Gt>Le?bi<Le&&je(qe,He,xt,Pt,jt,Le):qe.push(Fe[F]),bi<Me&&Gt>=Me&&je(qe,He,xt,Pt,jt,Me),bi>Le&&Gt<=Le&&je(qe,He,xt,Pt,jt,Le)}let He=Fe[Fe.length-1];const xt=0===Oe?He.x:He.y;xt>=Me&&xt<=Le&&qe.push(He),qe.length&&(He=qe[qe.length-1],qe[0].x===He.x&&qe[0].y===He.y||qe.push(qe[0]),F.push(qe))}F.length&&Fe.push(F)}return Fe}function Oh(F,Me,Le,Oe){const Fe="x"===Le?"y":"x",je=(Oe-F[Le])/(Me[Le]-F[Le]);F[Fe]=F[Fe]+(Me[Fe]-F[Fe])*je,F[Le]=Oe,F.hasOwnProperty("z")&&(F.z=Ee(F.z,Me.z,je)),F.hasOwnProperty("w")&&(F.w=Ee(F.w,Me.w,je))}function Nh(F,Me,Le,Oe){const Fe=Le,je=Oe;for(const Le of["x","y"]){let Oe=F,qe=Me;Oe[Le]>=qe[Le]&&(Oe=Me,qe=F),Oe[Le]<Fe&&qe[Le]>Fe&&Oh(Oe,qe,Le,Fe),Oe[Le]<je&&qe[Le]>je&&Oh(qe,Oe,Le,je)}}const K_=Number.MAX_SAFE_INTEGER;function jh(F,Me,Le,Oe){return F.order<Me||F.order===K_||!(F.clipMask&Le)||function(F,Me){return 0!==Me.length&&void 0===Me.find((Me=>Me===F))}(Oe,F.clipScope)}function qh(F,Me){return F.x-Me.x||F.y-Me.y}function $h(F,Me){return 0===qh(F.min,Me.min)&&0===qh(F.max,Me.max)}function Gh(F,Me){return!(F.min.x>Me.max.x||F.max.x<Me.min.x||F.min.y>Me.max.y||F.max.y<Me.min.y)}function Yh(F,Me){if(F.length!==Me.length)return!1;for(let Le=0;Le<F.length;Le++)if(F[Le].sourceId!==Me[Le].sourceId||!$h(F[Le],Me[Le])||F[Le].order!==Me[Le].order||F[Le].clipMask!==Me[Le].clipMask||!$(F[Le].clipScope,Me[Le].clipScope))return!1;return!0}function Hh(F,Me,Le){const Oe=1/np,Fe=1/(1<<Le.canonical.z),je=(Me.x*Oe+Le.canonical.x)*Fe+Le.wrap,qe=(Me.y*Oe+Le.canonical.y)*Fe;return{min:new ec((F.x*Oe+Le.canonical.x)*Fe+Le.wrap,(F.y*Oe+Le.canonical.y)*Fe),max:new ec(je,qe)}}function Xh(F,Me,Le){const Oe=1<<Le.canonical.z,Fe=((Me.x-Le.wrap)*Oe-Le.canonical.x)*np,je=(Me.y*Oe-Le.canonical.y)*np;return{min:new ec(((F.x-Le.wrap)*Oe-Le.canonical.x)*np,(F.y*Oe-Le.canonical.y)*np),max:new ec(Fe,je)}}function Zh(F,Me,Le,Oe,Fe,je,qe){const He=F.indices,xt=F.vertices,Pt=[];for(let jt=Oe;jt<Oe+Fe;jt+=3){const Oe=Me[Le[jt+0]+je],Fe=Me[Le[jt+1]+je],Gt=Me[Le[jt+2]+je],bi=Math.min(Oe.x,Fe.x,Gt.x),wi=Math.max(Oe.x,Fe.x,Gt.x),qr=Math.min(Oe.y,Fe.y,Gt.y),Xn=Math.max(Oe.y,Fe.y,Gt.y);Pt.length=0,F.grid.query(new ec(bi,qr),new ec(wi,Xn),Pt);for(let F=0;F<Pt.length;F++){const Me=Pt[F];if(Kl(xt[He[3*Me+0]],xt[He[3*Me+1]],xt[He[3*Me+2]],Oe,Fe,Gt,qe))return!0}}return!1}function Wh(F,Me,Le,Oe){if(!F||!Le)return!1;let Fe=F.vertices;if(!Me.canonical.equals(Oe.canonical)||Me.wrap!==Oe.wrap){if(Le.vertices.length<F.vertices.length)return Wh(Le,Oe,F,Me);const je=Me.canonical,qe=Oe.canonical,He=Math.pow(2,qe.z-je.z);Fe=F.vertices.map((F=>new ec((F.x+je.x*np)*He-qe.x*np,(F.y+je.y*np)*He-qe.y*np)))}return Zh(Le,Fe,F.indices,0,F.indices.length,0,0)}function Kh(F,Me,Le,Oe){const Fe=Math.pow(2,Oe.z-Le.z);return new ec((F+Le.x*np)*Fe-Oe.x*np,(Me+Le.y*np)*Fe-Oe.y*np)}function Jh(F,Me){const Le=[];Me.grid.queryPoint(F,Le);const Oe=Me.indices,Fe=Me.vertices;for(let Me=0;Me<Le.length;Me++){const je=Le[Me];if(Hl([Fe[Oe[3*je+0]],Fe[Oe[3*je+1]],Fe[Oe[3*je+2]]],F))return!0}return!1}const J_=[new ec(0,0),new ec(np,0),new ec(np,np),new ec(0,np)];function tp(F,Me){const Le=[];let Oe=[];if(!Me||F.length<2)return[F];if(2===F.length)return Zl(F[0],F[1],J_)?[F]:[];for(let Me=0;Me<F.length+2;Me++){const Fe=F[Me%F.length],je=F[(Me+1)%F.length],qe=Zl(0===Me?F[F.length-1]:F[(Me-1)%F.length],Fe,J_),He=Zl(Fe,je,J_),xt=qe||He;xt&&Oe.push(Fe),xt&&He||Oe.length>0&&(Oe.length>1&&Le.push(Oe),Oe=[])}return Oe.length>1&&Le.push(Oe),Le}const Q_=O_.VectorTileFeature.types,eg=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],tg=["fill-extrusion-flood-light-ground-radius"],ig=Math.pow(2,13),og=Math.pow(2,15)-1,sg=new ec(0,1),lg=2147483648;function lp(F,Me,Le,Oe,Fe,je,qe,He){F.emplaceBack((Me<<1)+qe,(Le<<1)+je,(Math.floor(Oe*ig)<<1)+Fe,Math.round(He))}function up(F,Me,Le){F.emplaceBack(Me.x*np,Me.y*np,Le?1:0)}function cp(F,Me,Le,Oe,Fe,je){F.emplaceBack(Me.x,Me.y,(Le.x<<1)+Oe,(Le.y<<1)+Fe,je)}function hp(F,Me,Le){const Oe=16384;F.emplaceBack(Me.x,Me.y,Me.z,Le[0]*Oe,Le[1]*Oe,Le[2]*Oe)}class pp{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class fp{constructor(){this.centroidXY=new ec(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new ec(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new ec(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new ec(this.max.x-this.min.x,this.max.y-this.min.y)}}class dp{constructor(){this.acc=new ec(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(F,Me){F.min.x===Number.MAX_VALUE&&(F.min.x=F.max.x=Me.x,F.min.y=F.max.y=Me.y)}appendEdge(F,Me,Le){this.accCount++,this.acc._add(Me);let Oe=!!this.borders;Me.x<F.min.x?(F.min.x=Me.x,Oe=!0):Me.x>F.max.x&&(F.max.x=Me.x,Oe=!0),Me.y<F.min.y?(F.min.y=Me.y,Oe=!0):Me.y>F.max.y&&(F.max.y=Me.y,Oe=!0),((0===Me.x||Me.x===np)&&Me.x===Le.x)!=((0===Me.y||Me.y===np)&&Me.y===Le.y)&&this.processBorderOverlap(Me,Le),Oe&&this.checkBorderIntersection(Me,Le)}checkBorderIntersection(F,Me){Me.x<0!=F.x<0&&this.addBorderIntersection(0,Ee(Me.y,F.y,(0-Me.x)/(F.x-Me.x))),Me.x>np!=F.x>np&&this.addBorderIntersection(1,Ee(Me.y,F.y,(np-Me.x)/(F.x-Me.x))),Me.y<0!=F.y<0&&this.addBorderIntersection(2,Ee(Me.x,F.x,(0-Me.y)/(F.y-Me.y))),Me.y>np!=F.y>np&&this.addBorderIntersection(3,Ee(Me.x,F.x,(np-Me.y)/(F.y-Me.y)))}addBorderIntersection(F,Me){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const Le=this.borders[F];Me<Le[0]&&(Le[0]=Me),Me>Le[1]&&(Le[1]=Me)}processBorderOverlap(F,Me){if(F.x===Me.x){if(F.y===Me.y)return;const Le=0===F.x?0:1;this.addBorderIntersection(Le,Me.y),this.addBorderIntersection(Le,F.y)}else{const Le=0===F.y?2:3;this.addBorderIntersection(Le,Me.x),this.addBorderIntersection(Le,F.x)}}centroid(){return 0===this.accCount?new ec(0,0):new ec(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((F,Me)=>F+ +(Me[0]!==Number.MAX_VALUE)),0):0}}function mp(F,Me){const Le=F.add(Me)._unit(),Oe=Q(F.x*Le.x+F.y*Le.y,-1,1);var Fe,je,qe;return qe=Math.acos(Oe),Math.min(4,Math.max(-4,Math.tan(qe)))/4*og*((Fe=F).x*(je=Me).y-Fe.y*je.x<0?-1:1)}const cg=[F=>F.x<0,F=>F.x>np,F=>F.y<0,F=>F.y>np];function gp(F,Me,Le,Oe){const Fe=[4];if(0===Oe)return Fe;Le._mult(Oe);const je=F.sub(Le),qe=Me.sub(Le),He=[F,Me,je,qe];for(let F=0;F<4;F++)for(const Me of He)if(cg[F](Me)){Fe.push(F);break}return Fe}class xp{constructor(F){this.vertexArray=new Pa,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut},(F=>tg.includes(F))),this._segments=new xo,this.hiddenByLandmarkVertexArray=new eo,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new xo}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(F,Me,Le,Oe=!1){const Fe=F.length;if(Fe>2){let je=Math.max(0,this._segments.get().length-1);const qe=this._segments._prepareSegment(4*Fe,this.vertexArray.length,2*this._segmentToGroundQuads[je].length);let He;je!==this._segments.get().length-1&&(je++,this._segmentToGroundQuads[je]=[],this._segmentToRegionTriCounts[je]=[0,0,0,0,0]);{const Me=F[0],Le=F[1];He=mp(Me.sub(F[Fe-1])._perp()._unit(),Le.sub(Me)._perp()._unit())}for(let xt=0;xt<Fe;xt++){const Pt=xt===Fe-1?0:xt+1,jt=F[xt],Gt=F[Pt],bi=F[Pt===Fe-1?0:Pt+1],wi=Gt.sub(jt)._perp()._unit(),qr=mp(wi,bi.sub(Gt)._perp()._unit()),Xn=He,Yn=qr;if(Mp(jt,Gt,Me)||Oe&&Ap(jt,Me)&&Ap(Gt,Me)){He=qr;continue}const yo=qe.vertexLength;cp(this.vertexArray,jt,Gt,1,1,Xn),cp(this.vertexArray,jt,Gt,1,0,Xn),cp(this.vertexArray,jt,Gt,0,1,Yn),cp(this.vertexArray,jt,Gt,0,0,Yn),qe.vertexLength+=4;const bo=gp(jt,Gt,wi,Le);for(const F of bo)this._segmentToGroundQuads[je].push({id:yo,region:F}),this._segmentToRegionTriCounts[je][F]+=2,qe.primitiveLength+=2;He=qr}}}prepareBorderSegments(){if(!this.hasData())return;const F=this._segments.get(),Me=F.length;for(let F=0;F<Me;F++)this._segmentToGroundQuads[F].sort(((F,Me)=>F.region-Me.region));for(let Le=0;Le<Me;Le++){const Me=this._segmentToGroundQuads[Le],Oe=F[Le],Fe=this._segmentToRegionTriCounts[Le];Fe.reduce(((F,Me)=>F+Me),0);let je=0;for(let F=0;F<=4;F++){const Me=Fe[F];if(0!==Me){let Le=this.regionSegments[F];Le||(Le=this.regionSegments[F]=new xo);const Fe={vertexOffset:Oe.vertexOffset,primitiveOffset:Oe.primitiveOffset+je,vertexLength:Oe.vertexLength,primitiveLength:Me};Le.get().push(Fe)}je+=Me}for(let F=0;F<Me.length;F++){const Le=Me[F].id;this.indexArray.emplaceBack(Le,Le+1,Le+3),this.indexArray.emplaceBack(Le,Le+3,Le+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(F,Me,Le,Oe,Fe,je){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,F,Me,Le,Oe,Fe,je)}upload(F){this.hasData()&&(this.vertexBuffer=F.createVertexBuffer(this.vertexArray,H_.members),this.indexBuffer=F.createIndexBuffer(this.indexArray))}uploadPaintProperties(F){this.hasData()&&this.programConfigurations.upload(F)}update(F,Me,Le,Oe,Fe,je,qe){this.hasData()&&this.programConfigurations.updatePaintArrays(F,Me,Le,Oe,Fe,je,qe)}updateHiddenByLandmark(F){if(!this.hasData())return;const Me=F.groundVertexCount+F.groundVertexArrayOffset;if(0===F.groundVertexCount)return;const Le=F.flags&lg?1:0;for(let Oe=F.groundVertexArrayOffset;Oe<Me;++Oe)this.hiddenByLandmarkVertexArray.emplace(Oe,Le);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(F){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=F.createVertexBuffer(this.hiddenByLandmarkVertexArray,W_.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let F=0;F<=4;F++){const Me=this.regionSegments[F];Me&&Me.destroy()}}}}class vp{constructor(F){this.zoom=F.zoom,this.canonical=F.canonical,this.overscaling=F.overscaling,this.layers=F.layers,this.pixelRatio=F.pixelRatio,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=F.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ja,this.footprintVertices=new _a,this.footprintSegments=[],this.layoutVertexArray=new Ma,this.centroidVertexArray=new po,this.wallVertexArray=new mo,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut},(F=>eg.includes(F))),this.segments=new xo,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.groundEffect=new xp(F),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(F,Me){}populate(F,Me,Le,Oe){this.features=[],this.hasPattern=Hc("fill-extrusion",this.layers,this.pixelRatio,Me),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Al(Le),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:Fe,id:je,index:qe,sourceLayerIndex:He}of F){const F=this.layers[0]._featureFilter.needGeometry,xt=Cl(Fe,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),xt,Le))continue;const Pt={id:je,sourceLayerIndex:He,index:qe,geometry:F?xt.geometry:Vl(Fe,Le,Oe),properties:Fe.properties,type:Fe.type,patterns:{}},jt=this.layoutVertexArray.length,Gt="Polygon"===Q_[Pt.type];if(this.hasPattern)this.features.push(Xc("fill-extrusion",this.layers,Pt,this.zoom,this.pixelRatio,Me));else if(this.wallMode)for(const F of Pt.geometry)for(const Fe of tp(F,Gt))this.addFeature(Pt,[Fe],qe,Le,{},Me.availableImages,Oe,Me.brightness);else this.addFeature(Pt,Pt.geometry,qe,Le,{},Me.availableImages,Oe,Me.brightness);Me.featureIndex.insert(Fe,Pt.geometry,qe,He,this.index,jt)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(F,Me,Le,Oe,Fe,je){for(const F of this.features){const qe="Polygon"===Q_[F.type],{geometry:He}=F;if(this.wallMode)for(const xt of He)for(const He of tp(xt,qe))this.addFeature(F,[He],F.index,Me,Le,Oe,Fe,je);else this.addFeature(F,He,F.index,Me,Le,Oe,Fe,je)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(F,Me,Le,Oe,Fe,je,qe){this.programConfigurations.updatePaintArrays(F,Me,Fe,Le,Oe,je,qe),this.groundEffect.update(F,Me,Fe,Le,Oe,je,qe)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,Y_),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.wallVertexBuffer=F.createVertexBuffer(this.wallVertexArray,Z_.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=F.createVertexBuffer(this.layoutVertexExtArray,X_.members,!0)),this.groundEffect.upload(F)),this.groundEffect.uploadPaintProperties(F),this.programConfigurations.upload(F),this.uploaded=!0}uploadCentroid(F){this.groundEffect.uploadHiddenByLandmark(F),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=F.createVertexBuffer(this.centroidVertexArray,$_.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(F,Me,Le,Oe,Fe,je,qe,He){const xt=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(F,{})/this.tileToMeter,Pt=[new ec(0,0),new ec(np,np)],jt=qe.projection,Gt="globe"===jt.name,bi=this.wallMode||"Polygon"===Q_[F.type],wi=new dp;wi.centroidDataIndex=this.centroidData.length;const qr=new fp,Xn=this.layers[0].paint.get("fill-extrusion-base").evaluate(F,{},Oe)<=0,Yn=this.layers[0].paint.get("fill-extrusion-height").evaluate(F,{},Oe);let yo;if(qr.height=Yn,qr.vertexArrayOffset=this.layoutVertexArray.length,qr.groundVertexArrayOffset=this.groundEffect.vertexArray.length,Gt&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ba),this.wallMode){if(Gt)return void pt("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==Me.length)return;yo=function(F){const Me=F[0].x===F[F.length-1].x&&F[0].y===F[F.length-1].y,Le=function(F){let Me=0;const Le=F.length;for(let Oe=0;Oe<Le;Oe++)Me+=(F[(Oe+1)%Le].x-F[Oe].x)*(F[(Oe+1)%Le].y+F[Oe].y);return Me>=0}(F);Le||(F=F.reverse());const Oe={geometry:[],joinNormals:[],indices:[]},Fe=[],je=[],qe=[];let He=F.length;for(;He>=2&&F[He-1].equals(F[He-2]);)He--;if(He<(Me?3:2))return Oe;let xt,Pt,jt,Gt,bi,wi=0;for(;wi<He-1&&F[wi].equals(F[wi+1]);)wi++;Me&&(xt=F[He-2],bi=F[wi].sub(xt)._unit()._perp());for(let Le=wi;Le<He;Le++){if(jt=Le===He-1?Me?F[wi+1]:void 0:F[Le+1],jt&&F[Le].equals(jt))continue;bi&&(Gt=bi),xt&&(Pt=xt),xt=F[Le],bi=jt?jt.sub(xt)._unit()._perp():Gt,Gt=Gt||bi;let Oe=Gt.add(bi);0===Oe.x&&0===Oe.y||Oe._unit();const qr=Oe.x*bi.x+Oe.y*bi.y,Xn=0!==qr?1/qr:1/0,Yn=Gt.x*bi.y-Gt.y*bi.x>0;let yo="miter";const bo=2;"miter"===yo&&Xn>bo&&(yo="bevel"),"bevel"===yo&&(Xn>100&&(yo="flipbevel"),Xn<bo&&(yo="miter"));const v=(F,Me,Le,Oe)=>{const He=new ec(F.x,F.y),xt=new ec(F.x,F.y);He.x+=Me.x*Oe,He.y+=Me.y*Oe,xt.x-=Me.x*Math.max(Le,1),xt.y-=Me.y*Math.max(Le,1),qe.push(Me),Fe.push(He),je.push(xt)};if("miter"===yo)Oe._mult(Xn),v(xt,Oe,0,0);else if("flipbevel"===yo)Oe=bi.mult(-1),v(xt,Oe,0,0),v(xt,Oe.mult(-1),0,0);else{const F=-Math.sqrt(Xn*Xn-1),Me=Yn?F:0,Le=Yn?0:F;Pt&&v(xt,Gt,Me,Le),jt&&v(xt,bi,Me,Le)}}Oe.geometry=[...Fe,...je.reverse(),Fe[0]],Oe.joinNormals=[...qe,...qe.reverse(),qe[qe.length-1]];const qr=Oe.geometry.length-1;for(let F=0;F<qr/2;F++)if(F+1<qr/2){let Me=F,Le=F+1,Fe=qr-1-F,je=qr-2-F;Me=0===Me?qr-1:Me-1,Le=0===Le?qr-1:Le-1,Fe=0===Fe?qr-1:Fe-1,je=0===je?qr-1:je-1,Oe.indices.push(Fe),Oe.indices.push(Le),Oe.indices.push(Me),Oe.indices.push(Fe),Oe.indices.push(je),Oe.indices.push(Le)}return Oe}(Me[0]),Me=[yo.geometry]}const x=(F,Me)=>F<(Me.length-1)/2||F===Me.length-1,bo=this.wallMode?[Me]:$c(Me,500);for(let F=bo.length-1;F>=0;F--){const Me=bo[F];(0===Me.length||(Ro=Me[0]).every((F=>F.x<=0))||Ro.every((F=>F.x>=np))||Ro.every((F=>F.y<=0))||Ro.every((F=>F.y>=np)))&&bo.splice(F,1)}var Ro;let Do;if(Gt)Do=Ep(bo,Pt,Oe);else{Do=[];for(const F of bo)Do.push({polygon:F,bounds:Pt})}const zs=bi?this.edgeRadius:0,Zs=zs>0&&this.zoom<17,A=(F,Me)=>{if(0===F.length)return!1;const Le=F[F.length-1];return Me.x===Le.x&&Me.y===Le.y};for(const{polygon:F,bounds:Me}of Do){let Le=0,Fe=0;for(const Me of F)bi&&!Me[0].equals(Me[Me.length-1])&&Me.push(Me[0]),Fe+=bi?Me.length-1:Me.length;const je=this.segments.prepareSegment((bi?5:4)*Fe,this.layoutVertexArray,this.indexArray);qr.footprintSegIdx<0&&(qr.footprintSegIdx=this.footprintSegments.length),qr.polygonSegIdx<0&&(qr.polygonSegIdx=this.polygonSegments.length);const qe={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},He=new pp;if(He.vertexOffset=this.footprintVertices.length,He.indexOffset=3*this.footprintIndices.length,He.ringIndices=[],bi){const Fe=[],qe=[];Le=je.vertexLength;for(let Le=0;Le<F.length;Le++){const Pt=F[Le];Pt.length&&0!==Le&&qe.push(Fe.length/2);const bi=[];let wi,qr;wi=Pt[1].sub(Pt[0])._perp()._unit(),He.ringIndices.push(Pt.length-1);for(let F=1;F<Pt.length;F++){const Me=Pt[F],Le=Pt[F===Pt.length-1?1:F+1],qe=Me.clone();if(zs){qr=Le.sub(Me)._perp()._unit();const F=wi.add(qr)._unit(),Oe=zs*Math.min(4,1/(wi.x*F.x+wi.y*F.y));qe.x+=Oe*F.x,qe.y+=Oe*F.y,qe.x=Math.round(qe.x),qe.y=Math.round(qe.y),wi=qr}if(!Xn||0!==zs&&!Zs||A(bi,qe)||bi.push(qe),lp(this.layoutVertexArray,qe.x,qe.y,0,0,1,1,0),this.wallMode){const Me=x(F,Pt);up(this.wallVertexArray,yo.joinNormals[F],!Me)}je.vertexLength++,this.footprintVertices.emplaceBack(Me.x,Me.y),Fe.push(Me.x,Me.y),Gt&&hp(this.layoutVertexExtArray,jt.projectTilePoint(qe.x,qe.y,Oe),jt.upVector(Oe,qe.x,qe.y))}Xn&&(0===zs||Zs)&&(0!==bi.length&&A(bi,bi[0])&&bi.pop(),this.groundEffect.addData(bi,Me,xt))}const Pt=this.wallMode?yo.indices:vc(Fe,qe);for(let F=0;F<Pt.length;F+=3)this.footprintIndices.emplaceBack(He.vertexOffset+Pt[F+0],He.vertexOffset+Pt[F+1],He.vertexOffset+Pt[F+2]),this.indexArray.emplaceBack(Le+Pt[F],Le+Pt[F+2],Le+Pt[F+1]),je.primitiveLength++;He.indexCount+=Pt.length,He.vertexCount+=this.footprintVertices.length-He.vertexOffset}for(let Fe=0;Fe<F.length;Fe++){const qe=F[Fe];wi.startRing(qr,qe[0]);let He=qe.length>4&&Ip(qe[qe.length-2],qe[0],qe[1]),Pt=zs?_p(qe[qe.length-2],qe[0],qe[1],zs):0;const Yn=[];let bo,Ro,Do;Ro=qe[1].sub(qe[0])._perp()._unit();let Zs=!0;for(let F=1,Fe=0;F<qe.length;F++){let xt=qe[F-1],bi=qe[F];const na=qe[F===qe.length-1?1:F+1];if(wi.appendEdge(qr,bi,xt),Mp(bi,xt,Me)){zs&&(Ro=na.sub(bi)._perp()._unit(),Zs=!Zs);continue}const el=bi.sub(xt)._perp(),nl=el.x/(Math.abs(el.x)+Math.abs(el.y)),hl=el.y>0?1:0,pl=xt.dist(bi);if(Fe+pl>32768&&(Fe=0),zs){Do=na.sub(bi)._perp()._unit();let F=wp(xt,bi,na,bp(Ro,Do),zs);isNaN(F)&&(F=0);const Me=bi.sub(xt)._unit();xt=xt.add(Me.mult(Pt))._round(),bi=bi.add(Me.mult(-F))._round(),Pt=F,Ro=Do,Xn&&this.zoom>=17&&(A(Yn,xt)||Yn.push(xt),A(Yn,bi)||Yn.push(bi))}const bl=je.vertexLength,Tl=qe.length>4&&Ip(xt,bi,na);let kl=Sp(Fe,He,Zs);if(lp(this.layoutVertexArray,xt.x,xt.y,nl,hl,0,0,kl),lp(this.layoutVertexArray,xt.x,xt.y,nl,hl,0,1,kl),this.wallMode){const Me=x(F-1,qe),Le=yo.joinNormals[F-1];up(this.wallVertexArray,Le,Me),up(this.wallVertexArray,Le,Me)}if(Fe+=pl,kl=Sp(Fe,Tl,!Zs),He=Tl,lp(this.layoutVertexArray,bi.x,bi.y,nl,hl,0,0,kl),lp(this.layoutVertexArray,bi.x,bi.y,nl,hl,0,1,kl),this.wallMode){const Me=x(F,qe),Le=yo.joinNormals[F];up(this.wallVertexArray,Le,Me),up(this.wallVertexArray,Le,Me)}if(je.vertexLength+=4,this.indexArray.emplaceBack(bl+0,bl+1,bl+2),this.indexArray.emplaceBack(bl+1,bl+3,bl+2),je.primitiveLength+=2,zs){const Oe=Le+(1===F?qe.length-2:F-2),Fe=1===F?Le:Oe+1;if(this.indexArray.emplaceBack(bl+1,Oe,bl+3),this.indexArray.emplaceBack(Oe,Fe,bl+3),je.primitiveLength+=2,void 0===bo&&(bo=bl),!Mp(na,qe[F],Me)){const Me=F===qe.length-1?bo:je.vertexLength;this.indexArray.emplaceBack(bl+2,bl+3,Me),this.indexArray.emplaceBack(bl+3,Me+1,Me),this.indexArray.emplaceBack(bl+3,Fe,Me+1),je.primitiveLength+=3}Zs=!Zs}if(Gt){const F=this.layoutVertexExtArray,Me=jt.projectTilePoint(xt.x,xt.y,Oe),Le=jt.projectTilePoint(bi.x,bi.y,Oe),Fe=jt.upVector(Oe,xt.x,xt.y),je=jt.upVector(Oe,bi.x,bi.y);hp(F,Me,Fe),hp(F,Me,Fe),hp(F,Le,je),hp(F,Le,je)}}bi&&(Le+=qe.length-1),Xn&&zs&&this.zoom>=17&&(0!==Yn.length&&A(Yn,Yn[0])&&Yn.pop(),this.groundEffect.addData(Yn,Me,xt,zs>0))}this.footprintSegments.push(He),qe.triangleCount=this.indexArray.length-qe.triangleArrayOffset,this.polygonSegments.push(qe),++qr.footprintSegLen,++qr.polygonSegLen}if(qr.vertexCount=this.layoutVertexArray.length-qr.vertexArrayOffset,qr.groundVertexCount=this.groundEffect.vertexArray.length-qr.groundVertexArrayOffset,0!==qr.vertexCount){if(qr.centroidXY=wi.borders?sg:this.encodeCentroid(wi,qr),this.centroidData.push(qr),wi.borders){this.featuresOnBorder.push(wi);const F=this.featuresOnBorder.length-1;for(let Me=0;Me<wi.borders.length;Me++)wi.borders[Me][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Me].push(F)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Le,Fe,je,Oe,He),this.groundEffect.addPaintPropertiesData(F,Le,Fe,je,Oe,He),this.maxHeight=Math.max(this.maxHeight,Yn)}}sortBorders(){for(let F=0;F<this.borderFeatureIndices.length;F++)this.borderFeatureIndices[F].sort(((Me,Le)=>this.featuresOnBorder[Me].borders[F][0]-this.featuresOnBorder[Le].borders[F][0]))}splitToSubtiles(){const F=[];for(let Me=0;Me<this.centroidData.length;Me++){const Le=this.centroidData[Me],Oe=+(Le.min.y+Le.max.y>np),Fe=2*Oe+(+(Le.min.x+Le.max.x>np)^Oe);for(let Oe=0;Oe<Le.polygonSegLen;Oe++){const je=Le.polygonSegIdx+Oe;F.push({centroidIdx:Me,subtile:Fe,polygonSegmentIdx:je,triangleSegmentIdx:this.polygonSegments[je].triangleSegIdx})}}const Me=new ja;F.sort(((F,Me)=>F.triangleSegmentIdx===Me.triangleSegmentIdx?F.subtile-Me.subtile:F.triangleSegmentIdx-Me.triangleSegmentIdx));let Le=0,Oe=0,Fe=0;for(const Me of F){if(Me.triangleSegmentIdx!==Le)break;Fe++}const je=F.length;for(;Oe!==F.length;){Le=F[Oe].triangleSegmentIdx;let qe=0,He=Oe,xt=Oe;for(let Me=He;Me<Fe&&F[Me].subtile===qe;Me++)xt++;for(;He!==Fe;){const Oe=F[He];qe=Oe.subtile;const je=this.centroidData[Oe.centroidIdx].min.clone(),Pt=this.centroidData[Oe.centroidIdx].max.clone(),jt={vertexOffset:this.segments.segments[Le].vertexOffset,primitiveOffset:Me.length,vertexLength:this.segments.segments[Le].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let Le=He;Le<xt;Le++){const Oe=F[Le],Fe=this.polygonSegments[Oe.polygonSegmentIdx],qe=this.centroidData[Oe.centroidIdx].min,He=this.centroidData[Oe.centroidIdx].max,xt=this.indexArray.uint16;for(let F=Fe.triangleArrayOffset;F<Fe.triangleArrayOffset+Fe.triangleCount;F++)Me.emplaceBack(xt[3*F],xt[3*F+1],xt[3*F+2]);jt.primitiveLength+=Fe.triangleCount,je.x=Math.min(je.x,qe.x),je.y=Math.min(je.y,qe.y),Pt.x=Math.max(Pt.x,He.x),Pt.y=Math.max(Pt.y,He.y)}jt.primitiveLength>0&&this.triangleSubSegments.push({segment:jt,min:je,max:Pt}),He=xt;for(let Me=He;Me<Fe&&F[Me].subtile===F[He].subtile;Me++)xt++}Oe=Fe;for(let Me=Oe;Me<je&&F[Me].triangleSegmentIdx===F[Oe].triangleSegmentIdx;Me++)Fe++}Me._trim(),this.indexArray=Me}getVisibleSegments(F,Me,Le){const Oe=new xo;if(this.wallMode){for(const F of this.triangleSubSegments)Oe.segments.push(F.segment);return Oe}let Fe=0,je=0;const qe=1<<F.canonical.z;if(Me){const Le=Me.getMinMaxForTile(F);Le&&(Fe=Le.min,je=Le.max)}je+=this.maxHeight;const He=F.toUnwrapped();let xt;const Pt=[He.canonical.x/qe+He.wrap,He.canonical.y/qe],jt=[(He.canonical.x+1)/qe+He.wrap,(He.canonical.y+1)/qe],h=(F,Me,Le)=>[F[0]*(1-Le[0])+Me[0]*Le[0],F[1]*(1-Le[1])+Me[1]*Le[1]],Gt=[],bi=[];for(const F of this.triangleSubSegments){Gt[0]=F.min.x/np,Gt[1]=F.min.y/np,bi[0]=F.max.x/np,bi[1]=F.max.y/np;const Me=h(Pt,jt,Gt),qe=h(Pt,jt,bi);if(0===new Au([Me[0],Me[1],Fe],[qe[0],qe[1],je]).intersectsPrecise(Le)){xt&&(Oe.segments.push(xt),xt=void 0);continue}const He=F.segment;xt&&xt.vertexOffset!==He.vertexOffset&&(Oe.segments.push(xt),xt=void 0),xt?(xt.vertexLength+=He.vertexLength,xt.primitiveLength+=He.primitiveLength):xt={vertexOffset:He.vertexOffset,primitiveLength:He.primitiveLength,vertexLength:He.vertexLength,primitiveOffset:He.primitiveOffset,sortKey:void 0,vaos:{}}}return xt&&Oe.segments.push(xt),Oe}encodeCentroid(F,Me){const Le=F.centroid(),Oe=Me.span(),Fe=Math.min(7,Math.round(Oe.x*this.tileToMeter/10)),je=Math.min(7,Math.round(Oe.y*this.tileToMeter/10));return new ec(Q(Le.x,1,np-1)<<3|Fe,Q(Le.y,1,np-1)<<3|je)}encodeBorderCentroid(F){if(!F.borders)return new ec(0,0);const Me=F.borders,Le=Number.MAX_VALUE;if(Me[0][0]!==Le||Me[1][0]!==Le){const F=Me[0][0]!==Le?0:1;return new ec(6|(Me[0][0]!==Le?0:65528),(Me[F][0]+Me[F][1])/2<<3|6)}{const F=Me[2][0]!==Le?2:3;return new ec((Me[F][0]+Me[F][1])/2<<3|6,6|(Me[2][0]!==Le?0:65528))}}showCentroid(F){const Me=this.centroidData[F.centroidDataIndex];Me.flags&=lg,Me.centroidXY.x=0,Me.centroidXY.y=0,this.writeCentroidToBuffer(Me)}writeCentroidToBuffer(F){this.groundEffect.updateHiddenByLandmark(F);const Me=F.vertexArrayOffset,Le=F.vertexCount+F.vertexArrayOffset,Oe=F.flags&lg?sg:F.centroidXY,Fe=this.centroidVertexArray.geta_centroid_pos0(Me);if(this.centroidVertexArray.geta_centroid_pos1(Me)!==Oe.y||Fe!==Oe.x){for(let F=Me;F<Le;++F)this.centroidVertexArray.emplace(F,Oe.x,Oe.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const F of this.centroidData)this.writeCentroidToBuffer(F)}updateReplacement(F,Me,Le){if(Me.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=Me.updateTime;const Oe=Me.getReplacementRegionsForTile(F.toUnwrapped());if(Yh(this.activeReplacements,Oe))return;if(this.activeReplacements=Oe,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const F of this.centroidData)F.flags&=2147483647;const Fe=[];for(const Me of this.activeReplacements){if(Me.order<Le)continue;const Oe=Math.max(1,Math.pow(2,Me.footprintTileId.canonical.z-F.canonical.z));for(const Le of this.centroidData)if(!(Le.flags&lg||Me.min.x>Le.max.x||Le.min.x>Me.max.x||Me.min.y>Le.max.y||Le.min.y>Me.max.y))for(let je=0;je<Le.footprintSegLen;je++){const qe=this.footprintSegments[Le.footprintSegIdx+je];if(Fe.length=0,zp(this.footprintVertices,qe.vertexOffset,qe.vertexCount,Me.footprintTileId.canonical,F.canonical,Fe),Zh(Me.footprint,Fe,this.footprintIndices.uint16,qe.indexOffset,qe.indexCount,-qe.vertexOffset,-Oe)){Le.flags|=lg;break}}}for(const F of this.centroidData)this.writeCentroidToBuffer(F);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(F,Me,Le){let Oe=!1;for(let Fe=0;Fe<Le.footprintSegLen;Fe++){const je=this.footprintSegments[Le.footprintSegIdx+Fe];let qe=0;for(const Le of je.ringIndices){for(let Fe=qe,He=Le+qe-1;Fe<Le+qe;He=Fe++){const Le=this.footprintVertices.int16[2*(Fe+je.vertexOffset)+0],qe=this.footprintVertices.int16[2*(Fe+je.vertexOffset)+1],xt=this.footprintVertices.int16[2*(He+je.vertexOffset)+1];qe>Me!=xt>Me&&F<(this.footprintVertices.int16[2*(He+je.vertexOffset)+0]-Le)*(Me-qe)/(xt-qe)+Le&&(Oe=!Oe)}qe=Le}}return Oe}getHeightAtTileCoord(F,Me){let Le=Number.NEGATIVE_INFINITY,Oe=!0;const Fe=4*(F+np)*np+(Me+np);if(this.partLookup.hasOwnProperty(Fe)){const F=this.partLookup[Fe];return F?{height:F.height,hidden:!!(F.flags&lg)}:void 0}for(const je of this.centroidData)F>je.max.x||je.min.x>F||Me>je.max.y||je.min.y>Me||this.footprintContainsPoint(F,Me,je)&&je&&je.height>Le&&(Le=je.height,this.partLookup[Fe]=je,Oe=!!(je.flags&lg));if(Le!==Number.NEGATIVE_INFINITY)return{height:Le,hidden:Oe};this.partLookup[Fe]=void 0}}function bp(F,Me){const Le=F.add(Me)._unit();return F.x*Le.x+F.y*Le.y}function _p(F,Me,Le,Oe){const Fe=Me.sub(F)._perp()._unit(),je=Le.sub(Me)._perp()._unit();return wp(F,Me,Le,bp(Fe,je),Oe)}function wp(F,Me,Le,Oe,Fe){const je=Math.sqrt(1-Oe*Oe);return Math.min(F.dist(Me)/3,Me.dist(Le)/3,Fe*je/Oe)}function Mp(F,Me,Le){return F.x<Le[0].x&&Me.x<Le[0].x||F.x>Le[1].x&&Me.x>Le[1].x||F.y<Le[0].y&&Me.y<Le[0].y||F.y>Le[1].y&&Me.y>Le[1].y}function Ap(F,Me){return F.x<Me[0].x||F.x>Me[1].x||F.y<Me[0].y||F.y>Me[1].y}function Ip(F,Me,Le){if(F.x<0||F.x>=np||Me.x<0||Me.x>=np||Le.x<0||Le.x>=np)return!1;const Oe=Le.sub(Me),Fe=Oe.perp(),je=F.sub(Me);return(Oe.x*je.x+Oe.y*je.y)/Math.sqrt((Oe.x*Oe.x+Oe.y*Oe.y)*(je.x*je.x+je.y*je.y))>-.866&&Fe.x*je.x+Fe.y*je.y<0}function Sp(F,Me,Le){const Oe=Me?2|F:-3&F;return Le?1|Oe:-2&Oe}function Pp(){const F=Math.PI/32,Me=Math.tan(F),Le=Bm;return Le*Math.sqrt(1+2*Me*Me)-Le}function Ep(F,Me,Le){const Oe=1<<Le.z,Fe=gl(Le.x/Oe),je=gl((Le.x+1)/Oe),qe=xl(Le.y/Oe),He=xl((Le.y+1)/Oe);return function(F,Me,Le,Oe,Fe=0,je){const qe=[];if(!F.length||!Le||!Oe)return qe;const o=(F,Me)=>{for(const Le of F)qe.push({polygon:Le,bounds:Me})},He=Math.ceil(Math.log2(Le)),xt=Math.ceil(Math.log2(Oe)),Pt=He-xt,jt=[];for(let F=0;F<Math.abs(Pt);F++)jt.push(Pt>0?0:1);for(let F=0;F<Math.min(He,xt);F++)jt.push(0),jt.push(1);let Gt=F;if(Gt=Fh(Gt,Me[0].y-Fe,Me[1].y+Fe,1),Gt=Fh(Gt,Me[0].x-Fe,Me[1].x+Fe,0),!Gt.length)return qe;const bi=[];for(jt.length?bi.push({polygons:Gt,bounds:Me,depth:0}):o(Gt,Me);bi.length;){const F=bi.pop(),Me=F.depth,Le=jt[Me],Oe=F.bounds[0],qe=F.bounds[1],He=0===Le?Oe.x:Oe.y,xt=0===Le?qe.x:qe.y,Pt=je?je(Le,He,xt):.5*(He+xt),Gt=Fh(F.polygons,He-Fe,Pt+Fe,Le),wi=Fh(F.polygons,Pt-Fe,xt+Fe,Le);if(Gt.length){const F=[Oe,new ec(0===Le?Pt:qe.x,1===Le?Pt:qe.y)];jt.length>Me+1?bi.push({polygons:Gt,bounds:F,depth:Me+1}):o(Gt,F)}if(wi.length){const F=[new ec(0===Le?Pt:Oe.x,1===Le?Pt:Oe.y),qe];jt.length>Me+1?bi.push({polygons:wi,bounds:F,depth:Me+1}):o(wi,F)}}return qe}(F,Me,Math.ceil((je-Fe)/11.25),Math.ceil((qe-He)/11.25),1,((F,Me,Fe)=>{if(0===F)return.5*(Me+Fe);{const F=xl((Le.y+Me/np)/Oe);return(ml(.5*(xl((Le.y+Fe/np)/Oe)+F))*Oe-Le.y)*np}}))}function zp(F,Me,Le,Oe,Fe,je){const qe=Math.pow(2,Oe.z-Fe.z);for(let He=0;He<Le;He++){let Le=F.int16[2*(He+Me)+0],xt=F.int16[2*(He+Me)+1];Le=(Le+Fe.x*np)*qe-Oe.x*np,xt=(xt+Fe.y*np)*qe-Oe.y*np,je.push(new ec(Le,xt))}}let hg,ug;function Bp(F,Me){return F.x*Me.x+F.y*Me.y}function Vp(F,Me){if(1===F.length){let Le=0;const Oe=Me[Le++];let Fe;for(;!Fe||Oe.equals(Fe);)if(Fe=Me[Le++],!Fe)return 1/0;for(;Le<Me.length;Le++){const je=Me[Le],qe=F[0],He=Fe.sub(Oe),xt=je.sub(Oe),Pt=qe.sub(Oe),jt=Bp(He,He),Gt=Bp(He,xt),bi=Bp(xt,xt),wi=Bp(Pt,He),qr=Bp(Pt,xt),Xn=jt*bi-Gt*Gt,Yn=(bi*wi-Gt*qr)/Xn,yo=(jt*qr-Gt*wi)/Xn,bo=Oe.z*(1-Yn-yo)+Fe.z*Yn+je.z*yo;if(isFinite(bo))return bo}return 1/0}{let F=1/0;for(const Le of Me)F=Math.min(F,Le.z);return F}}function Cp(F,Me,Le,Oe,Fe,je,qe,He){const xt=qe*Fe.getElevationAt(F,Me,!0,!0),Pt=0!==je[0],jt=Pt?0===je[1]?qe*(je[0]/7-450):qe*function(F,Me,Le){const Oe=Math.floor(Me[0]/8),Fe=Math.floor(Me[1]/8),je=10*(Me[0]-8*Oe),qe=10*(Me[1]-8*Fe),He=F.getElevationAt(Oe,Fe,!0,!0),xt=F.getMeterToDEM(Le),Pt=Math.floor(.5*(je*xt-1)),jt=Math.floor(.5*(qe*xt-1)),Gt=F.tileCoordToPixel(Oe,Fe),bi=2*Pt+1,wi=2*jt+1,qr=function(F,Me,Le,Oe,Fe){return[F.getElevationAtPixel(Me,Le,!0),F.getElevationAtPixel(Me+Fe,Le,!0),F.getElevationAtPixel(Me,Le+Fe,!0),F.getElevationAtPixel(Me+Oe,Le+Fe,!0)]}(F,Gt.x-Pt,Gt.y-jt,bi,wi),Xn=Math.abs(qr[0]-qr[1]),Yn=Math.abs(qr[2]-qr[3]),yo=Math.abs(qr[0]-qr[2])+Math.abs(qr[1]-qr[3]),bo=Math.min(.25,.5*xt*(Xn+Yn)/bi),Ro=Math.min(.25,.5*xt*yo/wi);return He+Math.max(bo*je,Ro*qe)}(Fe,je,He):xt;return{base:xt+(0===Le?-1:Le),top:Pt?Math.max(jt+Oe,xt+Le+2):xt+Oe}}us(vp,"FillExtrusionBucket",{omit:["layers","features"]}),us(fp,"PartData"),us(pp,"FootprintSegment"),us(dp,"BorderCentroidData"),us(xp,"GroundEffect");const pg=va([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),fg=va([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:ey}=pg,ty=va([{name:"a_packed",components:3,type:"Float32"}]),{members:ly}=ty,my=va([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:_y}=my;class jp{constructor(F,Me){this.width=F,this.height=Me,this.nextRow=0,this.image=new hc({width:F,height:Me}),this.positions={},this.uploaded=!1}getDash(F,Me){const Le=this.getKey(F,Me);return this.positions[Le]}trim(){const F=this.width,Me=this.height=at(this.nextRow);this.image.resize({width:F,height:Me})}getKey(F,Me){return F.join(",")+Me}getDashRanges(F,Me,Le){const Oe=[];let Fe=F.length%2==1?-F[F.length-1]*Le:0,je=F[0]*Le,qe=!0;Oe.push({left:Fe,right:je,isDash:qe,zeroLength:0===F[0]});let He=F[0];for(let Me=1;Me<F.length;Me++){qe=!qe;const xt=F[Me];Fe=He*Le,He+=xt,je=He*Le,Oe.push({left:Fe,right:je,isDash:qe,zeroLength:0===xt})}return Oe}addRoundDash(F,Me,Le){const Oe=Me/2;for(let Me=-Le;Me<=Le;Me++){const Fe=this.width*(this.nextRow+Le+Me);let je=0,qe=F[je];for(let He=0;He<this.width;He++){He/qe.right>1&&(qe=F[++je]);const xt=Math.abs(He-qe.left),Pt=Math.abs(He-qe.right),jt=Math.min(xt,Pt);let Gt;const bi=Me/Le*(Oe+1);if(qe.isDash){const F=Oe-Math.abs(bi);Gt=Math.sqrt(jt*jt+F*F)}else Gt=Oe-Math.sqrt(jt*jt+bi*bi);this.image.data[Fe+He]=Math.max(0,Math.min(255,Gt+128))}}}addRegularDash(F,Me){for(let Me=F.length-1;Me>=0;--Me){const Le=F[Me],Oe=F[Me+1];Le.zeroLength?F.splice(Me,1):Oe&&Oe.isDash===Le.isDash&&(Oe.left=Le.left,F.splice(Me,1))}const Le=F[0],Oe=F[F.length-1];Le.isDash===Oe.isDash&&(Le.left=Oe.left-this.width,Oe.right=Le.right+this.width);const Fe=this.width*this.nextRow;let je=0,qe=F[je];for(let Le=0;Le<this.width;Le++){Le/qe.right>1&&(qe=F[++je]);const Oe=Math.abs(Le-qe.left),He=Math.abs(Le-qe.right),xt=Math.min(Oe,He);this.image.data[Fe+Le]=Math.max(0,Math.min(255,(qe.isDash?xt:-xt)+Me+128))}}addDash(F,Me){const Le=this.getKey(F,Me);if(this.positions[Le])return this.positions[Le];const Oe="round"===Me,Fe=Oe?7:0,je=2*Fe+1;if(this.nextRow+je>this.height)return pt("LineAtlas out of space"),null;0===F.length&&F.push(1);let qe=0;for(let Me=0;Me<F.length;Me++)F[Me]<0&&(pt("Negative value is found in line dasharray, replacing values with 0"),F[Me]=0),qe+=F[Me];if(0!==qe){const Le=this.width/qe,je=this.getDashRanges(F,this.width,Le);Oe?this.addRoundDash(je,Le,Fe):this.addRegularDash(je,"square"===Me?.5*Le:0)}const He=this.nextRow+Fe;this.nextRow+=je;const xt={tl:[He,Fe],br:[qe,0]};return this.positions[Le]=xt,xt}}us(jp,"LineAtlas");const gy=O_.VectorTileFeature.types,yy=Math.cos(Math.PI/180*37.5),xy=Math.cos(Math.PI/180*5);class Yp{constructor(F){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=F.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=F.overscaling,this.pixelRatio=F.pixelRatio,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.projection=F.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((F=>{this.gradients[F.id]={}})),this.layoutVertexArray=new Ea,this.layoutVertexArray2=new za,this.patternVertexArray=new za,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.segments=new xo,this.maxLineLength=0,this.zOffsetVertexArray=new za,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.tessellationStep=F.tessellationStep?F.tessellationStep:np/64}updateFootprints(F,Me){}populate(F,Me,Le,Oe){this.hasPattern=Hc("line",this.layers,this.pixelRatio,Me);const Fe=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Al(Le);const je=this.layers[0].layout.get("line-z-offset"),qe=je.isConstant()&&!je.constantOr(0),He=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset="sea"===He||"ground"===He||!qe&&"none"===He,this.hasZOffset&&"none"===He&&pt(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);const xt=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&void 0!==xt;const Pt=[];for(const{feature:Me,id:je,index:qe,sourceLayerIndex:He}of F){const F=this.layers[0]._featureFilter.needGeometry,xt=Cl(Me,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),xt,Le))continue;const jt=Fe?Fe.evaluate(xt,{},Le):void 0,Gt={id:je,properties:Me.properties,type:Me.type,sourceLayerIndex:He,index:qe,geometry:F?xt.geometry:Vl(Me,Le,Oe),patterns:{},sortKey:jt};Pt.push(Gt)}Fe&&Pt.sort(((F,Me)=>F.sortKey-Me.sortKey));const{lineAtlas:jt,featureIndex:Gt}=Me,bi=this.addConstantDashes(jt);for(const Oe of Pt){const{geometry:Fe,index:je,sourceLayerIndex:qe}=Oe;if(bi&&this.addFeatureDashes(Oe,jt),this.hasPattern){const F=Xc("line",this.layers,Oe,this.zoom,this.pixelRatio,Me);this.patternFeatures.push(F)}else this.addFeature(Oe,Fe,je,Le,jt.positions,Me.availableImages,Me.brightness);Gt.insert(F[je].feature,Fe,je,qe,this.index)}}addConstantDashes(F){let Me=!1;for(const Le of this.layers){const Oe=Le.paint.get("line-dasharray").value,Fe=Le.layout.get("line-cap").value;if("constant"!==Oe.kind||"constant"!==Fe.kind)Me=!0;else{const Me=Fe.value,Le=Oe.value;if(!Le)continue;F.addDash(Le,Me)}}return Me}addFeatureDashes(F,Me){const Le=this.zoom;for(const Oe of this.layers){const Fe=Oe.paint.get("line-dasharray").value,je=Oe.layout.get("line-cap").value;if("constant"===Fe.kind&&"constant"===je.kind)continue;let qe,He;if("constant"===Fe.kind){if(qe=Fe.value,!qe)continue}else qe=Fe.evaluate({zoom:Le},F);He="constant"===je.kind?je.value:je.evaluate({zoom:Le},F),Me.addDash(qe,He),F.patterns[Oe.id]=Me.getKey(qe,He)}}update(F,Me,Le,Oe,Fe,je,qe){this.programConfigurations.updatePaintArrays(F,Me,Fe,Le,Oe,je,qe)}addFeatures(F,Me,Le,Oe,Fe,je){for(const F of this.patternFeatures)this.addFeature(F,F.geometry,F.index,Me,Le,Oe,je)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=F.createVertexBuffer(this.layoutVertexArray2,ly)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=F.createVertexBuffer(this.patternVertexArray,_y)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=F.createVertexBuffer(this.zOffsetVertexArray,fg.members,!0)),this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,ey),this.indexBuffer=F.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(F){if(F.properties&&F.properties.hasOwnProperty("mapbox_clip_start")&&F.properties.hasOwnProperty("mapbox_clip_end"))return{start:+F.properties.mapbox_clip_start,end:+F.properties.mapbox_clip_end}}addFeature(F,Me,Le,Oe,Fe,je,qe){const He=this.layers[0].layout,xt=He.get("line-join").evaluate(F,{}),Pt=He.get("line-cap").evaluate(F,{}),jt=He.get("line-miter-limit"),Gt=He.get("line-round-limit");this.lineClips=this.lineFeatureClips(F),this.lineFeature=F,this.zOffsetValue=He.get("line-z-offset").value;const bi=this.layers[0].paint.get("line-width").value;"constant"!==bi.kind&&!1===bi.isLineProgressConstant&&(this.variableWidthValue=bi);for(const Le of Me)this.addLine(Le,F,Oe,xt,Pt,jt,Gt);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Le,Fe,je,Oe,qe)}addLine(F,Me,Le,Oe,Fe,je,qe){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const He="none"===Oe;if(this.patternJoinNone=this.hasPattern&&He,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Me=0;Me<F.length-1;Me++)this.totalDistance+=F[Me].dist(F[Me+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const xt="Polygon"===gy[Me.type];let Pt=F.length;for(;Pt>=2&&F[Pt-1].equals(F[Pt-2]);)Pt--;let jt=0;for(;jt<Pt-1&&F[jt].equals(F[jt+1]);)jt++;if(Pt<(xt?3:2))return;"bevel"===Oe&&(je=1.05);const Gt=this.segments.prepareSegment(10*Pt,this.layoutVertexArray,this.indexArray);let bi,wi,qr,Xn,Yn,yo;this.e1=this.e2=-1,xt&&(bi=F[Pt-2],Yn=F[jt].sub(bi)._unit()._perp());for(let Me=jt;Me<Pt;Me++){if(qr=Me===Pt-1?xt?F[jt+1]:void 0:F[Me+1],qr&&F[Me].equals(qr))continue;Yn&&(Xn=Yn),bi&&(wi=bi),bi=F[Me],yo=this.evaluateLineProgressFeatures(wi?wi.dist(bi):0),Yn=qr?qr.sub(bi)._unit()._perp():Xn,Xn=Xn||Yn;const Le=wi&&qr;let bo=Le?Oe:xt||He?"butt":Fe;const Ro=Xn.x*Yn.x+Xn.y*Yn.y;if(He){const t=function(F){if(F.patternJoinNone){const Me=F.segmentPoints.length/2,Le=F.lineSoFar-F.segmentStart;for(let Oe=0;Oe<Me;++Oe){const Me=F.segmentPoints[2*Oe+1],Fe=Math.round(F.segmentPoints[2*Oe])+.5+.25*Me;F.patternVertexArray.emplaceBack(Fe,Le,F.segmentStart),F.patternVertexArray.emplaceBack(Fe,Le,F.segmentStart)}F.segmentPoints.length=0}F.e1=F.e2=-1};if(Le&&Ro<xy){this.updateDistance(wi,bi),this.addCurrentVertex(bi,Xn,1,1,Gt,yo),t(this),this.addCurrentVertex(bi,Yn,-1,-1,Gt,yo);continue}if(wi){if(!qr){this.updateDistance(wi,bi),this.addCurrentVertex(bi,Xn,1,1,Gt,yo),t(this);continue}bo="miter"}}let Do=Xn.add(Yn);0===Do.x&&0===Do.y||Do._unit();const zs=Do.x*Yn.x+Do.y*Yn.y,Zs=0!==zs?1/zs:1/0,na=2*Math.sqrt(2-2*zs),el=zs<yy&&wi&&qr,nl=Xn.x*Yn.y-Xn.y*Yn.x>0,hl=this.overscaling<=16?15*np/(512*this.overscaling):0;if(Le&&"round"===bo)if(Zs<qe)bo="miter";else if(Zs<=2){const F=Hp(bi,-10,np+10);bo=this.hasZOffset&&(F||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===bo&&Zs>je&&(bo="bevel"),"bevel"===bo&&(Zs>2&&(bo="flipbevel"),Zs<je&&(bo="miter")),wi&&!("miter"===bo&&el)&&this.updateDistance(wi,bi),"miter"===bo)if(el){const F=bi.dist(wi);if(F>2*hl){const Me=bi.sub(bi.sub(wi)._mult(hl/F)._round());this.updateDistance(wi,Me),this.addCurrentVertex(Me,Xn,0,0,Gt,yo),wi=Me}this.updateDistance(wi,bi),Do._mult(Zs),this.addCurrentVertex(bi,Do,0,0,Gt,yo);const Me=bi.dist(qr);if(Me>2*hl){const F=bi.add(qr.sub(bi)._mult(hl/Me)._round());this.updateDistance(bi,F),this.addCurrentVertex(F,Yn,0,0,Gt,yo),bi=F}}else Do._mult(Zs),this.addCurrentVertex(bi,Do,0,0,Gt,yo);else if("flipbevel"===bo){if(Zs>100)Do=Yn.mult(-1);else{const F=Zs*Xn.add(Yn).mag()/Xn.sub(Yn).mag();Do._perp()._mult(F*(nl?-1:1))}this.addCurrentVertex(bi,Do,0,0,Gt,yo),this.addCurrentVertex(bi,Do.mult(-1),0,0,Gt,yo)}else if("bevel"===bo||"fakeround"===bo){null!=yo&&wi&&this.addCurrentVertex(bi,Xn,-1,-1,Gt,yo);const F=bi.dist(wi)<=2*hl&&"bevel"!==bo,Me=Do.mult(nl?1:-1);Me._mult(Zs);const Le=Yn.mult(nl?-1:1),Oe=Xn.mult(nl?-1:1),Fe=this.evaluateLineProgressFeatures(this.distance);if(null==yo&&(this.addHalfVertex(bi,Me.x,Me.y,!1,!nl,0,Gt,Fe),F||this.addHalfVertex(bi,Me.x+2*Oe.x,Me.y+2*Oe.y,!1,nl,0,Gt,Fe)),"fakeround"===bo){const F=Math.round(180*na/Math.PI/20);this.addHalfVertex(bi,Oe.x,Oe.y,!1,nl,0,Gt,Fe);for(let Me=0;Me<F;Me++){let je=Me/F;if(.5!==je){const F=je-.5;je+=je*F*(je-1)*((1.0904+Ro*(Ro*(3.55645-1.43519*Ro)-3.2452))*F*F+(.848013+Ro*(.215638*Ro-1.06021)))}const qe=Le.sub(Oe)._mult(je)._add(Oe)._unit();this.addHalfVertex(bi,qe.x,qe.y,!1,nl,0,Gt,Fe)}this.addHalfVertex(bi,Le.x,Le.y,!1,nl,0,Gt,Fe)}F||null!=yo||this.addHalfVertex(bi,Me.x+2*Le.x,Me.y+2*Le.y,!1,nl,0,Gt,Fe),null!=yo&&qr&&this.addCurrentVertex(bi,Yn,1,1,Gt,yo)}else"butt"===bo?this.addCurrentVertex(bi,Do,0,0,Gt,yo):"square"===bo?(wi||this.addCurrentVertex(bi,Do,-1,-1,Gt,yo),this.addCurrentVertex(bi,Do,0,0,Gt,yo),wi&&this.addCurrentVertex(bi,Do,1,1,Gt,yo)):"round"===bo&&(wi&&(this.addCurrentVertex(bi,Xn,0,0,Gt,yo),this.addCurrentVertex(bi,Xn,1,1,Gt,yo,!0)),qr&&(this.addCurrentVertex(bi,Yn,-1,-1,Gt,yo,!0),this.addCurrentVertex(bi,Yn,0,0,Gt,yo)))}}addVerticesTo(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt){const jt=(Me.w-F.w)/this.tessellationStep|0;let Gt=0;const bi=this.scaledDistance;if(jt>1){this.lineSoFar=F.w;const bi=(Me.x-F.x)/jt,wi=(Me.y-F.y)/jt,qr=(Me.z-F.z)/jt,Xn=(Me.w-F.w)/jt;for(let Me=1;Me<jt;++Me){F.x+=bi,F.y+=wi,F.z+=qr,this.lineSoFar+=Xn,Gt+=Xn;const Me=this.evaluateLineProgressFeatures(this.prevDistance+Gt);this.scaledDistance=(this.prevDistance+Gt)/this.totalDistance,this.addHalfVertex(F,Le,Oe,Pt,!1,qe,xt,Me),this.addHalfVertex(F,Fe,je,Pt,!0,-He,xt,Me)}}this.lineSoFar=Me.w,this.scaledDistance=bi;const wi=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(Me,Le,Oe,Pt,!1,qe,xt,wi),this.addHalfVertex(Me,Fe,je,Pt,!0,-He,xt,wi)}evaluateLineProgressFeatures(F){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+F)/this.totalFeatureLength):pt(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let Me=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(Me=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:Me}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:Me}:{zOffset:0,variableWidth:Me}}addCurrentVertex(F,Me,Le,Oe,Fe,je,qe=!1){const He=Me.x+Me.y*Le,xt=Me.y-Me.x*Le,Pt=Me.y*Oe-Me.x,jt=-Me.y-Me.x*Oe;if(null!=je){const Me=this.hasZOffset,Gt=-10,bi=np+10,wi=je.zOffset,qr=new Lh(F.x,F.y,wi,this.lineSoFar),Xn=!!Me&&Hp(F,Gt,bi),Yn=this.lineSoFar,yo=this.distance;if(this.currentVertex)if(Xn){const Me=this.currentVertexIsOutside,je=this.currentVertex,Xn=new Lh(F.x,F.y,wi,this.lineSoFar);if(Nh(je,Xn,Gt,bi),!Hp(Xn,Gt,bi)){if(Me){this.e1=this.e2=-1,this.distance-=je.dist(qr),this.lineSoFar=je.w;const F=this.evaluateLineProgressFeatures(je.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(je,He,xt,qe,!1,Le,Fe,F),this.addHalfVertex(je,Pt,jt,qe,!0,-Oe,Fe,F),this.prevDistance=this.distance}this.distance=this.prevDistance+je.dist(Xn),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(je,Xn,He,xt,Pt,jt,Le,Oe,Fe,qe),this.distance=yo,this.scaledDistance=this.distance/this.totalDistance}}else{const F=this.currentVertex;if(this.currentVertexIsOutside){Nh(F,qr,Gt,bi),this.e1=this.e2=-1,this.distance-=F.dist(qr),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=F.w;const Me=this.evaluateLineProgressFeatures(F.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(F,He,xt,qe,!1,Le,Fe,Me),this.addHalfVertex(F,Pt,jt,qe,!0,-Oe,Fe,Me),this.prevDistance=this.distance,this.distance=yo,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(F,qr,He,xt,Pt,jt,Le,Oe,Fe,qe)}else Xn||(this.addHalfVertex(F,He,xt,qe,!1,Le,Fe,je),this.addHalfVertex(F,Pt,jt,qe,!0,-Oe,Fe,je));this.currentVertex=qr,this.currentVertexIsOutside=Xn,this.lineSoFar=Yn}else this.addHalfVertex(F,He,xt,qe,!1,Le,Fe,je),this.addHalfVertex(F,Pt,jt,qe,!0,-Oe,Fe,je)}addHalfVertex({x:F,y:Me},Le,Oe,Fe,je,qe,He,xt){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),je||this.segmentPoints.push(this.lineSoFar-this.segmentStart,qe)),this.layoutVertexArray.emplaceBack((F<<1)+(Fe?1:0),(Me<<1)+(je?1:0),Math.round(63*Le)+128,Math.round(63*Oe)+128,1+(0===qe?0:qe<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const F=Ee(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,F)}const Pt=He.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,Pt),He.primitiveLength++),je?this.e2=Pt:this.e1=Pt,null!=xt&&this.zOffsetVertexArray.emplaceBack(xt.zOffset,xt.variableWidth,xt.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(F,Me){this.prevDistance=this.distance,this.distance+=F.dist(Me),this.updateScaledDistance()}}function Hp(F,Me,Le){return F.x<Me||F.x>Le||F.y<Me||F.y>Le}let vy,by;function Wp(F,Me,Le){return Me*(np/(F.tileSize*Math.pow(2,Le-F.tileID.overscaledZ)))}us(Yp,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Kp=(F,Me,Le)=>(1-Le)*F+Le*Me;function Jp(F,Me){return 1/Wp(F,1,Me.tileZoom)}function Qp(F,Me,Le,Oe){return F.translatePosMatrix(Oe||Me.tileID.projMatrix,Me,Le.paint.get("line-translate"),Le.paint.get("line-translate-anchor"))}const tf=F=>{const Me=[];ef(F)&&Me.push("RENDER_LINE_DASH"),F.paint.get("line-gradient")&&Me.push("RENDER_LINE_GRADIENT");const Le=F.paint.get("line-trim-offset");0===Le[0]&&0===Le[1]||Me.push("RENDER_LINE_TRIM_OFFSET"),0!==F.paint.get("line-border-width").constantOr(1)&&Me.push("RENDER_LINE_BORDER");const Oe="none"===F.layout.get("line-join").constantOr("miter"),Fe=!!F.paint.get("line-pattern").constantOr(1);return Oe&&Fe&&Me.push("LINE_JOIN_NONE"),Me};function ef(F){const Me=F.paint.get("line-dasharray").value;return Me.value||"constant"!==Me.kind}let wy;const nf=()=>wy||(wy={layout:vy||(vy=new Xs({"line-cap":new Ys(Cf.layout_line["line-cap"]),"line-join":new Ys(Cf.layout_line["line-join"]),"line-miter-limit":new Gs(Cf.layout_line["line-miter-limit"]),"line-round-limit":new Gs(Cf.layout_line["line-round-limit"]),"line-sort-key":new Ys(Cf.layout_line["line-sort-key"]),"line-z-offset":new Ys(Cf.layout_line["line-z-offset"]),"line-elevation-reference":new Gs(Cf.layout_line["line-elevation-reference"]),"line-cross-slope":new Gs(Cf.layout_line["line-cross-slope"]),visibility:new Gs(Cf.layout_line.visibility),"line-width-unit":new Gs(Cf.layout_line["line-width-unit"])})),paint:by||(by=new Xs({"line-opacity":new Ys(Cf.paint_line["line-opacity"]),"line-color":new Ys(Cf.paint_line["line-color"]),"line-translate":new Gs(Cf.paint_line["line-translate"]),"line-translate-anchor":new Gs(Cf.paint_line["line-translate-anchor"]),"line-width":new Ys(Cf.paint_line["line-width"]),"line-gap-width":new Ys(Cf.paint_line["line-gap-width"]),"line-offset":new Ys(Cf.paint_line["line-offset"]),"line-blur":new Ys(Cf.paint_line["line-blur"]),"line-dasharray":new Ys(Cf.paint_line["line-dasharray"]),"line-pattern":new Ys(Cf.paint_line["line-pattern"]),"line-gradient":new Hs(Cf.paint_line["line-gradient"]),"line-trim-offset":new Gs(Cf.paint_line["line-trim-offset"]),"line-trim-fade-range":new Gs(Cf.paint_line["line-trim-fade-range"]),"line-trim-color":new Gs(Cf.paint_line["line-trim-color"]),"line-emissive-strength":new Gs(Cf.paint_line["line-emissive-strength"]),"line-border-width":new Ys(Cf.paint_line["line-border-width"]),"line-border-color":new Ys(Cf.paint_line["line-border-color"]),"line-occlusion-opacity":new Gs(Cf.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},wy);class sf extends Ys{possiblyEvaluate(F,Me){return Me=new Rs(Math.floor(Me.zoom),{now:Me.now,fadeDuration:Me.fadeDuration,transition:Me.transition}),super.possiblyEvaluate(F,Me)}evaluate(F,Me,Le,Oe){return Me=nt({},Me,{zoom:Math.floor(Me.zoom)}),super.evaluate(F,Me,Le,Oe)}}let Ty;function of(F,Me){return Me>0?Me+2*F:F}const Ey=va([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),zy=va([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Oy=va([{name:"a_projected_pos",components:4,type:"Float32"}],4);va([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const ky=va([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Ny=va([{name:"a_texb",components:2,type:"Uint16"}]),qy=va([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Wy=va([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);va([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const lx=va([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Tx=va([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);va([{name:"triangle",components:3,type:"Uint16"}]),va([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),va([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),va([{type:"Float32",name:"offsetX"}]),va([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Sx=24;const Ex=128;function vf(F,Me,Le,Oe,Fe){if("camera"===F.kind)return F.maxSize;if("composite"===F.kind){const Oe=Me.possiblyEvaluate(new Rs(F.maxZoom),Le).evaluate(Fe,{},Le),je=Me.possiblyEvaluate(new Rs(F.minZoom),Le).evaluate(Fe,{},Le);return Math.max(Oe,je)}return Me.possiblyEvaluate(new Rs(Oe)).evaluate(Fe,{},Le)}function bf(F,Me){const{expression:Le}=Me;if("constant"===Le.kind)return{kind:"constant",layoutSize:Le.evaluate(new Rs(F+1))};if("source"===Le.kind)return{kind:"source"};{const{zoomStops:Me,interpolationType:Oe}=Le;let Fe=0;for(;Fe<Me.length&&Me[Fe]<=F;)Fe++;Fe=Math.max(0,Fe-1);let je=Fe;for(;je<Me.length&&Me[je]<F+1;)je++;je=Math.min(Me.length-1,je);const qe=Me[Fe],He=Me[je];return"composite"===Le.kind?{kind:"composite",minZoom:qe,maxZoom:He,interpolationType:Oe}:{kind:"camera",minZoom:qe,maxZoom:He,minSize:Le.evaluate(new Rs(qe)),maxSize:Le.evaluate(new Rs(He)),interpolationType:Oe}}}function _f(F,{uSize:Me,uSizeT:Le},{lowerSize:Oe,upperSize:Fe}){return"source"===F.kind?Oe/Ex:"composite"===F.kind?Ee(Oe/Ex,Fe/Ex,Le):Me}function wf(F,Me,Le=1){let Oe=0,Fe=0;if("constant"===F.kind)Fe=F.layoutSize*Le;else if("source"!==F.kind){const{interpolationType:je,minZoom:qe,maxZoom:He}=F,xt=je?Q(ai.interpolationFactor(je,Me,qe,He),0,1):0;"camera"===F.kind?Fe=Ee(F.minSize,F.maxSize,xt)*Le:Oe=xt*Le}return{uSizeT:Oe,uSize:Fe}}var Mx=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Ex,evaluateSizeForFeature:_f,evaluateSizeForZoom:wf,getRasterizedIconSize:vf,getSizeData:bf});function Af(F,Me,Le){return F.sections.forEach((F=>{F.text=function(F,Me,Le){const Oe=Me.layout.get("text-transform").evaluate(Le,{});return"uppercase"===Oe?F=F.toLocaleUpperCase():"lowercase"===Oe&&(F=F.toLocaleLowerCase()),If.applyArabicShaping&&(F=If.applyArabicShaping(F)),F}(F.text,Me,Le)})),F}const Ax={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function Sf(F){return"︶"===F||"﹈"===F||"︸"===F||"﹄"===F||"﹂"===F||"︾"===F||"︼"===F||"︺"===F||"︘"===F||"﹀"===F||"︐"===F||"︓"===F||"︔"===F||"｀"===F||"￣"===F||"︑"===F||"︒"===F}function Pf(F){return"︵"===F||"﹇"===F||"︷"===F||"﹃"===F||"﹁"===F||"︽"===F||"︻"===F||"︹"===F||"︗"===F||"︿"===F}var Ix,Cx,Px,Rx={};function Bf(){return Ix||(Ix=1,Rx.read=function(F,Me,Le,Oe,Fe){var je,qe,He=8*Fe-Oe-1,xt=(1<<He)-1,Pt=xt>>1,jt=-7,Gt=Le?Fe-1:0,bi=Le?-1:1,wi=F[Me+Gt];for(Gt+=bi,je=wi&(1<<-jt)-1,wi>>=-jt,jt+=He;jt>0;je=256*je+F[Me+Gt],Gt+=bi,jt-=8);for(qe=je&(1<<-jt)-1,je>>=-jt,jt+=Oe;jt>0;qe=256*qe+F[Me+Gt],Gt+=bi,jt-=8);if(0===je)je=1-Pt;else{if(je===xt)return qe?NaN:1/0*(wi?-1:1);qe+=Math.pow(2,Oe),je-=Pt}return(wi?-1:1)*qe*Math.pow(2,je-Oe)},Rx.write=function(F,Me,Le,Oe,Fe,je){var qe,He,xt,Pt=8*je-Fe-1,jt=(1<<Pt)-1,Gt=jt>>1,bi=23===Fe?Math.pow(2,-24)-Math.pow(2,-77):0,wi=Oe?0:je-1,qr=Oe?1:-1,Xn=Me<0||0===Me&&1/Me<0?1:0;for(Me=Math.abs(Me),isNaN(Me)||Me===1/0?(He=isNaN(Me)?1:0,qe=jt):(qe=Math.floor(Math.log(Me)/Math.LN2),Me*(xt=Math.pow(2,-qe))<1&&(qe--,xt*=2),(Me+=qe+Gt>=1?bi/xt:bi*Math.pow(2,1-Gt))*xt>=2&&(qe++,xt/=2),qe+Gt>=jt?(He=0,qe=jt):qe+Gt>=1?(He=(Me*xt-1)*Math.pow(2,Fe),qe+=Gt):(He=Me*Math.pow(2,Gt-1)*Math.pow(2,Fe),qe=0));Fe>=8;F[Le+wi]=255&He,wi+=qr,He/=256,Fe-=8);for(qe=qe<<Fe|He,Pt+=Fe;Pt>0;F[Le+wi]=255&qe,wi+=qr,qe/=256,Pt-=8);F[Le+wi-qr]|=128*Xn}),Rx}function Vf(){if(Px)return Cx;Px=1,Cx=e;var Me=Bf();function e(Me){(this||F).buf=ArrayBuffer.isView&&ArrayBuffer.isView(Me)?Me:new Uint8Array(Me||0),(this||F).pos=0,(this||F).type=0,(this||F).length=(this||F).buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var Le=4294967296,Oe=1/Le,Fe="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function s(F){return F.type===e.Bytes?F.readVarint()+F.pos:F.pos+1}function a(F,Me,Le){return Le?4294967296*Me+(F>>>0):4294967296*(Me>>>0)+(F>>>0)}function o(F,Me,Le){var Oe=Me<=16383?1:Me<=2097151?2:Me<=268435455?3:Math.floor(Math.log(Me)/(7*Math.LN2));Le.realloc(Oe);for(var Fe=Le.pos-1;Fe>=F;Fe--)Le.buf[Fe+Oe]=Le.buf[Fe]}function l(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeVarint(F[Le])}function u(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeSVarint(F[Le])}function c(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeFloat(F[Le])}function h(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeDouble(F[Le])}function p(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeBoolean(F[Le])}function f(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeFixed32(F[Le])}function d(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeSFixed32(F[Le])}function m(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeFixed64(F[Le])}function y(F,Me){for(var Le=0;Le<F.length;Le++)Me.writeSFixed64(F[Le])}function g(F,Me){return(F[Me]|F[Me+1]<<8|F[Me+2]<<16)+16777216*F[Me+3]}function x(F,Me,Le){F[Le]=Me,F[Le+1]=Me>>>8,F[Le+2]=Me>>>16,F[Le+3]=Me>>>24}function v(F,Me){return(F[Me]|F[Me+1]<<8|F[Me+2]<<16)+(F[Me+3]<<24)}return e.prototype={destroy:function(){(this||F).buf=null},readFields:function(Me,Le,Oe){for(Oe=Oe||(this||F).length;(this||F).pos<Oe;){var Fe=this.readVarint(),je=Fe>>3,qe=(this||F).pos;(this||F).type=7&Fe,Me(je,Le,this||F),(this||F).pos===qe&&this.skip(Fe)}return Le},readMessage:function(Me,Le){return this.readFields(Me,Le,this.readVarint()+(this||F).pos)},readFixed32:function(){var Me=g((this||F).buf,(this||F).pos);return(this||F).pos+=4,Me},readSFixed32:function(){var Me=v((this||F).buf,(this||F).pos);return(this||F).pos+=4,Me},readFixed64:function(){var Me=g((this||F).buf,(this||F).pos)+g((this||F).buf,(this||F).pos+4)*Le;return(this||F).pos+=8,Me},readSFixed64:function(){var Me=g((this||F).buf,(this||F).pos)+v((this||F).buf,(this||F).pos+4)*Le;return(this||F).pos+=8,Me},readFloat:function(){var Le=Me.read((this||F).buf,(this||F).pos,!0,23,4);return(this||F).pos+=4,Le},readDouble:function(){var Le=Me.read((this||F).buf,(this||F).pos,!0,52,8);return(this||F).pos+=8,Le},readVarint:function(Me){var Le,Oe,Fe=(this||F).buf;return Le=127&(Oe=Fe[(this||F).pos++]),Oe<128?Le:(Le|=(127&(Oe=Fe[(this||F).pos++]))<<7,Oe<128?Le:(Le|=(127&(Oe=Fe[(this||F).pos++]))<<14,Oe<128?Le:(Le|=(127&(Oe=Fe[(this||F).pos++]))<<21,Oe<128?Le:function(F,Me,Le){var Oe,Fe,je=Le.buf;if(Oe=(112&(Fe=je[Le.pos++]))>>4,Fe<128)return a(F,Oe,Me);if(Oe|=(127&(Fe=je[Le.pos++]))<<3,Fe<128)return a(F,Oe,Me);if(Oe|=(127&(Fe=je[Le.pos++]))<<10,Fe<128)return a(F,Oe,Me);if(Oe|=(127&(Fe=je[Le.pos++]))<<17,Fe<128)return a(F,Oe,Me);if(Oe|=(127&(Fe=je[Le.pos++]))<<24,Fe<128)return a(F,Oe,Me);if(Oe|=(1&(Fe=je[Le.pos++]))<<31,Fe<128)return a(F,Oe,Me);throw new Error("Expected varint not more than 10 bytes")}(Le|=(15&(Oe=Fe[(this||F).pos]))<<28,Me,this||F))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var F=this.readVarint();return F%2==1?(F+1)/-2:F/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var Me=this.readVarint()+(this||F).pos,Le=(this||F).pos;return(this||F).pos=Me,Me-Le>=12&&Fe?function(F,Me,Le){return Fe.decode(F.subarray(Me,Le))}((this||F).buf,Le,Me):function(F,Me,Le){for(var Oe="",Fe=Me;Fe<Le;){var je,qe,He,xt=F[Fe],Pt=null,jt=xt>239?4:xt>223?3:xt>191?2:1;if(Fe+jt>Le)break;1===jt?xt<128&&(Pt=xt):2===jt?128==(192&(je=F[Fe+1]))&&(Pt=(31&xt)<<6|63&je)<=127&&(Pt=null):3===jt?(qe=F[Fe+2],128==(192&(je=F[Fe+1]))&&128==(192&qe)&&((Pt=(15&xt)<<12|(63&je)<<6|63&qe)<=2047||Pt>=55296&&Pt<=57343)&&(Pt=null)):4===jt&&(qe=F[Fe+2],He=F[Fe+3],128==(192&(je=F[Fe+1]))&&128==(192&qe)&&128==(192&He)&&((Pt=(15&xt)<<18|(63&je)<<12|(63&qe)<<6|63&He)<=65535||Pt>=1114112)&&(Pt=null)),null===Pt?(Pt=65533,jt=1):Pt>65535&&(Pt-=65536,Oe+=String.fromCharCode(Pt>>>10&1023|55296),Pt=56320|1023&Pt),Oe+=String.fromCharCode(Pt),Fe+=jt}return Oe}((this||F).buf,Le,Me)},readBytes:function(){var Me=this.readVarint()+(this||F).pos,Le=(this||F).buf.subarray((this||F).pos,Me);return(this||F).pos=Me,Le},readPackedVarint:function(Me,Le){if((this||F).type!==e.Bytes)return Me.push(this.readVarint(Le));var Oe=s(this||F);for(Me=Me||[];(this||F).pos<Oe;)Me.push(this.readVarint(Le));return Me},readPackedSVarint:function(Me){if((this||F).type!==e.Bytes)return Me.push(this.readSVarint());var Le=s(this||F);for(Me=Me||[];(this||F).pos<Le;)Me.push(this.readSVarint());return Me},readPackedBoolean:function(Me){if((this||F).type!==e.Bytes)return Me.push(this.readBoolean());var Le=s(this||F);for(Me=Me||[];(this||F).pos<Le;)Me.push(this.readBoolean());return Me},readPackedFloat:function(Me){if((this||F).type!==e.Bytes)return Me.push(this.readFloat());var Le=s(this||F);for(Me=Me||[];(this||F).pos<Le;)Me.push(this.readFloat());return Me},readPackedDouble:function(Me){if((this||F).type!==e.Bytes)return Me.push(this.readDouble());var Le=s(this||F);for(Me=Me||[];(this||F).pos<Le;)Me.push(this.readDouble());return Me},readPackedFixed32:function(Me){if((this||F).type!==e.Bytes)return Me.push(this.readFixed32());var Le=s(this||F);for(Me=Me||[];(this||F).pos<Le;)Me.push(this.readFixed32());return Me},readPackedSFixed32:function(Me){if((this||F).type!==e.Bytes)return Me.push(this.readSFixed32());var Le=s(this||F);for(Me=Me||[];(this||F).pos<Le;)Me.push(this.readSFixed32());return Me},readPackedFixed64:function(Me){if((this||F).type!==e.Bytes)return Me.push(this.readFixed64());var Le=s(this||F);for(Me=Me||[];(this||F).pos<Le;)Me.push(this.readFixed64());return Me},readPackedSFixed64:function(Me){if((this||F).type!==e.Bytes)return Me.push(this.readSFixed64());var Le=s(this||F);for(Me=Me||[];(this||F).pos<Le;)Me.push(this.readSFixed64());return Me},skip:function(Me){var Le=7&Me;if(Le===e.Varint)for(;(this||F).buf[(this||F).pos++]>127;);else if(Le===e.Bytes)(this||F).pos=this.readVarint()+(this||F).pos;else if(Le===e.Fixed32)(this||F).pos+=4;else{if(Le!==e.Fixed64)throw new Error("Unimplemented type: "+Le);(this||F).pos+=8}},writeTag:function(F,Me){this.writeVarint(F<<3|Me)},realloc:function(Me){for(var Le=(this||F).length||16;Le<(this||F).pos+Me;)Le*=2;if(Le!==(this||F).length){var Oe=new Uint8Array(Le);Oe.set((this||F).buf),(this||F).buf=Oe,(this||F).length=Le}},finish:function(){return(this||F).length=(this||F).pos,(this||F).pos=0,(this||F).buf.subarray(0,(this||F).length)},writeFixed32:function(Me){this.realloc(4),x((this||F).buf,Me,(this||F).pos),(this||F).pos+=4},writeSFixed32:function(Me){this.realloc(4),x((this||F).buf,Me,(this||F).pos),(this||F).pos+=4},writeFixed64:function(Me){this.realloc(8),x((this||F).buf,-1&Me,(this||F).pos),x((this||F).buf,Math.floor(Me*Oe),(this||F).pos+4),(this||F).pos+=8},writeSFixed64:function(Me){this.realloc(8),x((this||F).buf,-1&Me,(this||F).pos),x((this||F).buf,Math.floor(Me*Oe),(this||F).pos+4),(this||F).pos+=8},writeVarint:function(Me){(Me=+Me||0)>268435455||Me<0?function(F,Me){var Le,Oe;if(F>=0?(Le=F%4294967296|0,Oe=F/4294967296|0):(Oe=~(-F/4294967296),4294967295^(Le=~(-F%4294967296))?Le=Le+1|0:(Le=0,Oe=Oe+1|0)),F>=0x10000000000000000||F<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");Me.realloc(10),function(F,Me,Le){Le.buf[Le.pos++]=127&F|128,F>>>=7,Le.buf[Le.pos++]=127&F|128,F>>>=7,Le.buf[Le.pos++]=127&F|128,F>>>=7,Le.buf[Le.pos++]=127&F|128,Le.buf[Le.pos]=127&(F>>>=7)}(Le,0,Me),function(F,Me){var Le=(7&F)<<4;Me.buf[Me.pos++]|=Le|((F>>>=3)?128:0),F&&(Me.buf[Me.pos++]=127&F|((F>>>=7)?128:0),F&&(Me.buf[Me.pos++]=127&F|((F>>>=7)?128:0),F&&(Me.buf[Me.pos++]=127&F|((F>>>=7)?128:0),F&&(Me.buf[Me.pos++]=127&F|((F>>>=7)?128:0),F&&(Me.buf[Me.pos++]=127&F)))))}(Oe,Me)}(Me,this||F):(this.realloc(4),(this||F).buf[(this||F).pos++]=127&Me|(Me>127?128:0),Me<=127||((this||F).buf[(this||F).pos++]=127&(Me>>>=7)|(Me>127?128:0),Me<=127||((this||F).buf[(this||F).pos++]=127&(Me>>>=7)|(Me>127?128:0),Me<=127||((this||F).buf[(this||F).pos++]=Me>>>7&127))))},writeSVarint:function(F){this.writeVarint(F<0?2*-F-1:2*F)},writeBoolean:function(F){this.writeVarint(Boolean(F))},writeString:function(Me){Me=String(Me),this.realloc(4*Me.length),(this||F).pos++;var Le=(this||F).pos;(this||F).pos=function(F,Me,Le){for(var Oe,Fe,je=0;je<Me.length;je++){if((Oe=Me.charCodeAt(je))>55295&&Oe<57344){if(!Fe){Oe>56319||je+1===Me.length?(F[Le++]=239,F[Le++]=191,F[Le++]=189):Fe=Oe;continue}if(Oe<56320){F[Le++]=239,F[Le++]=191,F[Le++]=189,Fe=Oe;continue}Oe=Fe-55296<<10|Oe-56320|65536,Fe=null}else Fe&&(F[Le++]=239,F[Le++]=191,F[Le++]=189,Fe=null);Oe<128?F[Le++]=Oe:(Oe<2048?F[Le++]=Oe>>6|192:(Oe<65536?F[Le++]=Oe>>12|224:(F[Le++]=Oe>>18|240,F[Le++]=Oe>>12&63|128),F[Le++]=Oe>>6&63|128),F[Le++]=63&Oe|128)}return Le}((this||F).buf,Me,(this||F).pos);var Oe=(this||F).pos-Le;Oe>=128&&o(Le,Oe,this||F),(this||F).pos=Le-1,this.writeVarint(Oe),(this||F).pos+=Oe},writeFloat:function(Le){this.realloc(4),Me.write((this||F).buf,Le,(this||F).pos,!0,23,4),(this||F).pos+=4},writeDouble:function(Le){this.realloc(8),Me.write((this||F).buf,Le,(this||F).pos,!0,52,8),(this||F).pos+=8},writeBytes:function(Me){var Le=Me.length;this.writeVarint(Le),this.realloc(Le);for(var Oe=0;Oe<Le;Oe++)(this||F).buf[(this||F).pos++]=Me[Oe]},writeRawMessage:function(Me,Le){(this||F).pos++;var Oe=(this||F).pos;Me(Le,this||F);var Fe=(this||F).pos-Oe;Fe>=128&&o(Oe,Fe,this||F),(this||F).pos=Oe-1,this.writeVarint(Fe),(this||F).pos+=Fe},writeMessage:function(F,Me,Le){this.writeTag(F,e.Bytes),this.writeRawMessage(Me,Le)},writePackedVarint:function(F,Me){Me.length&&this.writeMessage(F,l,Me)},writePackedSVarint:function(F,Me){Me.length&&this.writeMessage(F,u,Me)},writePackedBoolean:function(F,Me){Me.length&&this.writeMessage(F,p,Me)},writePackedFloat:function(F,Me){Me.length&&this.writeMessage(F,c,Me)},writePackedDouble:function(F,Me){Me.length&&this.writeMessage(F,h,Me)},writePackedFixed32:function(F,Me){Me.length&&this.writeMessage(F,f,Me)},writePackedSFixed32:function(F,Me){Me.length&&this.writeMessage(F,d,Me)},writePackedFixed64:function(F,Me){Me.length&&this.writeMessage(F,m,Me)},writePackedSFixed64:function(F,Me){Me.length&&this.writeMessage(F,y,Me)},writeBytesField:function(F,Me){this.writeTag(F,e.Bytes),this.writeBytes(Me)},writeFixed32Field:function(F,Me){this.writeTag(F,e.Fixed32),this.writeFixed32(Me)},writeSFixed32Field:function(F,Me){this.writeTag(F,e.Fixed32),this.writeSFixed32(Me)},writeFixed64Field:function(F,Me){this.writeTag(F,e.Fixed64),this.writeFixed64(Me)},writeSFixed64Field:function(F,Me){this.writeTag(F,e.Fixed64),this.writeSFixed64(Me)},writeVarintField:function(F,Me){this.writeTag(F,e.Varint),this.writeVarint(Me)},writeSVarintField:function(F,Me){this.writeTag(F,e.Varint),this.writeSVarint(Me)},writeStringField:function(F,Me){this.writeTag(F,e.Bytes),this.writeString(Me)},writeFloatField:function(F,Me){this.writeTag(F,e.Fixed32),this.writeFloat(Me)},writeDoubleField:function(F,Me){this.writeTag(F,e.Fixed64),this.writeDouble(Me)},writeBooleanField:function(F,Me){this.writeVarintField(F,Boolean(Me))}},Cx}var Dx=e(Vf());const Ox=3;function Rf(F,Me,Le){Me.glyphs=[],1===F&&Le.readMessage(Lf,Me)}function Lf(F,Me,Le){if(3===F){const{id:F,bitmap:Oe,width:Fe,height:je,left:qe,top:He,advance:xt}=Le.readMessage(Ff,{});Me.glyphs.push({id:F,bitmap:new hc({width:Fe+2*Ox,height:je+2*Ox},Oe),metrics:{width:Fe,height:je,left:qe,top:He,advance:xt}})}else 4===F?Me.ascender=Le.readSVarint():5===F&&(Me.descender=Le.readSVarint())}function Ff(F,Me,Le){1===F?Me.id=Le.readVarint():2===F?Me.bitmap=Le.readBytes():3===F?Me.width=Le.readVarint():4===F?Me.height=Le.readVarint():5===F?Me.left=Le.readSVarint():6===F?Me.top=Le.readSVarint():7===F&&(Me.advance=Le.readVarint())}const kx=Ox,Fx={horizontal:1,vertical:2,horizontalOnly:3};class Uf{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(F,Me){const Le=new Uf;return Le.scale=F||1,Le.fontStack=Me,Le}static forImage(F){const Me=new Uf;return Me.image=F,Me}}class jf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(F,Me,Le){const Oe=new jf;for(let Fe=0;Fe<F.sections.length;Fe++){const je=F.sections[Fe];je.image?Oe.addImageSection(je,Le):Oe.addTextSection(je,Me)}return Oe}length(){return this.text.length}getSection(F){return this.sections[this.sectionIndex[F]]}getSections(){return this.sections}getSectionIndex(F){return this.sectionIndex[F]}getCodePoint(F){return this.text.codePointAt(F)}verticalizePunctuation(F){this.text=function(F,Me){let Le="";for(let Oe=0;Oe<F.length;Oe++){const Fe=F.charCodeAt(Oe+1)||null,je=F.charCodeAt(Oe-1)||null;Le+=!Me&&(Fe&&vs(Fe)&&!Ax[F[Oe+1]]||je&&vs(je)&&!Ax[F[Oe-1]])||!Ax[F[Oe]]?F[Oe]:Ax[F[Oe]]}return Le}(this.text,F)}trim(){let F=0;for(let Me=0;Me<this.text.length&&Bx[this.text.charCodeAt(Me)];Me++)F++;let Me=this.text.length;for(let Le=this.text.length-1;Le>=0&&Le>=F&&Bx[this.text.charCodeAt(Le)];Le--)Me--;this.text=this.text.substring(F,Me),this.sectionIndex=this.sectionIndex.slice(F,Me)}substring(F,Me){const Le=new jf;return Le.text=this.text.substring(F,Me),Le.sectionIndex=this.sectionIndex.slice(F,Me),Le.sections=this.sections,Le}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((F,Me)=>Math.max(F,this.sections[Me].scale)),0)}addTextSection(F,Me){this.text+=F.text,this.sections.push(Uf.forText(F.scale,F.fontStack||Me));const Le=this.sections.length-1;for(let Me=0;Me<F.text.length;++Me)this.sectionIndex.push(Le)}addImageSection(F,Me){const Le=F.image?F.image.getPrimary():null;if(!Le)return void pt("Can't add FormattedSection with an empty image.");Le.scaleSelf(Me);const Oe=this.getNextImageSectionCharCode();Oe?(this.text+=String.fromCodePoint(Oe),this.sections.push(Uf.forImage(Le)),this.sectionIndex.push(this.sections.length-1)):pt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function qf(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn=1){const Yn=jf.fromFeature(F,Fe,Xn);Gt===Fx.vertical&&Yn.verticalizePunctuation(bi);let yo=[];const bo=function(F,Me,Le,Oe,Fe,je){if(!F)return[];const qe=[],He=function(F,Me,Le,Oe,Fe,je){let qe=0;for(let Le=0;Le<F.length();Le++){const He=F.getSection(Le);qe+=Yf(F.getCodePoint(Le),He,Oe,Fe,Me,je)}return qe/Math.max(1,Math.ceil(qe/Le))}(F,Me,Le,Oe,Fe,je),xt=F.text.indexOf("​")>=0;let Pt=0;for(let Le=0;Le<F.length();Le++){const Gt=F.getSection(Le),bi=F.getCodePoint(Le);if(Bx[bi]||(Pt+=Yf(bi,Gt,Oe,Fe,Me,je)),Le<F.length()-1){const Me=!((jt=bi)<11904||!(ff["Bopomofo Extended"](jt)||ff.Bopomofo(jt)||ff["CJK Compatibility Forms"](jt)||ff["CJK Compatibility Ideographs"](jt)||ff["CJK Compatibility"](jt)||ff["CJK Radicals Supplement"](jt)||ff["CJK Strokes"](jt)||ff["CJK Symbols and Punctuation"](jt)||ff["CJK Unified Ideographs Extension A"](jt)||ff["CJK Unified Ideographs"](jt)||ff["Enclosed CJK Letters and Months"](jt)||ff["Halfwidth and Fullwidth Forms"](jt)||ff.Hiragana(jt)||ff["Ideographic Description Characters"](jt)||ff["Kangxi Radicals"](jt)||ff["Katakana Phonetic Extensions"](jt)||ff.Katakana(jt)||ff["Vertical Forms"](jt)||ff["Yi Radicals"](jt)||ff["Yi Syllables"](jt)));(Nx[bi]||Me||Gt.image)&&qe.push(Zf(Le+1,Pt,He,qe,Xf(bi,F.getCodePoint(Le+1),Me&&xt),!1))}}var jt;return Wf(Zf(F.length(),Pt,He,qe,0,!0))}(Yn,Pt,je,Me,Oe,wi),{processBidirectionalText:Ro,processStyledBidirectionalText:Do}=If;if(Ro&&1===Yn.sections.length){const F=Ro(Yn.toString(),bo);for(const Me of F){const F=new jf;F.text=Me,F.sections=Yn.sections;for(let Le=0;Le<Me.length;Le++)F.sectionIndex.push(0);yo.push(F)}}else if(Do){const F=Do(Yn.text,Yn.sectionIndex,bo);for(const Me of F){const F=new jf;F.text=Me[0],F.sectionIndex=Me[1],F.sections=Yn.sections,yo.push(F)}}else yo=function(F,Me){const Le=[],Oe=F.text;let Fe=0;for(const Oe of Me)Le.push(F.substring(Fe,Oe)),Fe=Oe;return Fe<Oe.length&&Le.push(F.substring(Fe,Oe.length)),Le}(Yn,bo);const zs=[],Zs={positionedLines:zs,text:Yn.toString(),top:jt[1],bottom:jt[1],left:jt[0],right:jt[0],writingMode:Gt,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt){let bi=0,wi=0,qr=0;const Xn="right"===He?1:"left"===He?0:.5;let Yn=!1;for(const F of Fe){const Le=F.getSections();for(const F of Le){if(F.image)continue;const Le=Me[F.fontStack];if(Le&&(Yn=void 0!==Le.ascender&&void 0!==Le.descender,!Yn))break}if(!Yn)break}let yo=0;for(const qe of Fe){qe.trim();const Fe=qe.getMaxScale(),He=(Fe-1)*Sx,Ro={positionedGlyphs:[],lineOffset:0};F.positionedLines[yo]=Ro;const Do=Ro.positionedGlyphs;let zs=0;if(!qe.length()){wi+=je,++yo;continue}let Zs=0,na=0;for(let je=0;je<qe.length();je++){const He=qe.getSection(je),qr=qe.getSectionIndex(je),Xn=qe.getCodePoint(je);let yo=He.scale,Ro=null,el=null,nl=null,hl=Sx,pl=0;xt===Fx.vertical&&(12312===(bo=Xn)||12313===bo||12316===bo||12540===bo||12448===bo)&&(xt=Fx.horizontal);const bl=!(xt===Fx.horizontal||!jt&&!xs(Xn)||jt&&(Bx[Xn]||bs(Xn)));if(He.image){const Me=Oe.get(He.image.toString());if(!Me)continue;nl=He.image,F.iconsInText=F.iconsInText||!0,el=Me.paddedRect;const Le=Me.displaySize;yo=yo*Sx/Gt,Ro={width:Le[0],height:Le[1],left:0,top:-kx,advance:bl?Le[1]:Le[0],localGlyph:!1},pl=Yn?-Ro.height*yo:Fe*Sx-17-Le[1]*yo,hl=Ro.advance;const je=(bl?Le[0]:Le[1])*yo-Sx*Fe;je>0&&je>zs&&(zs=je)}else{const F=Le[He.fontStack];if(!F)continue;F[Xn]&&(el=F[Xn]);const Oe=Me[He.fontStack];if(!Oe)continue;const je=Oe.glyphs[Xn];if(!je)continue;if(Ro=je.metrics,hl=8203!==Xn?Sx:0,Yn){const F=void 0!==Oe.ascender?Math.abs(Oe.ascender):0,Me=void 0!==Oe.descender?Math.abs(Oe.descender):0,Le=(F+Me)*yo;Zs<Le&&(Zs=Le,na=(F-Me)/2*yo),pl=-F*yo}else pl=(Fe-yo)*Sx-17}bl?(F.verticalizable=!0,Do.push({glyph:Xn,image:nl,x:bi,y:wi+pl,vertical:bl,scale:yo,localGlyph:Ro.localGlyph,fontStack:He.fontStack,sectionIndex:qr,metrics:Ro,rect:el}),bi+=hl*yo+Pt):(Do.push({glyph:Xn,image:nl,x:bi,y:wi+pl,vertical:bl,scale:yo,localGlyph:Ro.localGlyph,fontStack:He.fontStack,sectionIndex:qr,metrics:Ro,rect:el}),bi+=Ro.advance*yo+Pt)}0!==Do.length&&(qr=Math.max(bi-Pt,qr),Yn?Jf(Do,Xn,zs,na,je*Fe/2):Jf(Do,Xn,zs,0,je/2)),bi=0;const el=je*Fe+zs;Ro.lineOffset=Math.max(zs,He),wi+=el,++yo}var bo;const Ro=wi,{horizontalAlign:Do,verticalAlign:zs}=Kf(qe);(function(F,Me,Le,Oe,Fe,je){const qe=(Me-Le)*Fe,He=-je*Oe;for(const Me of F)for(const F of Me.positionedGlyphs)F.x+=qe,F.y+=He})(F.positionedLines,Xn,Do,zs,qr,Ro),F.top+=-zs*Ro,F.bottom=F.top+Ro,F.left+=-Do*qr,F.right=F.left+qr,F.hasBaseline=Yn}(Zs,Me,Le,Oe,yo,qe,He,xt,Gt,Pt,bi,qr),!function(F){for(const Me of F)if(0!==Me.positionedGlyphs.length)return!1;return!0}(zs))return Zs}const Bx={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Nx={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Yf(F,Me,Le,Oe,Fe,je){if(Me.image){const F=Oe.get(Me.image.toString());return F?F.displaySize[0]*Me.scale*Sx/je+Fe:0}{const Oe=Le[Me.fontStack],je=Oe&&Oe.glyphs[F];return je?je.metrics.advance*Me.scale+Fe:0}}function Hf(F,Me,Le,Oe){const Fe=Math.pow(F-Me,2);return Oe?F<Me?Fe/2:2*Fe:Fe+Math.abs(Le)*Le}function Xf(F,Me,Le){let Oe=0;return 10===F&&(Oe-=1e4),Le&&(Oe+=150),40!==F&&65288!==F||(Oe+=50),41!==Me&&65289!==Me||(Oe+=50),Oe}function Zf(F,Me,Le,Oe,Fe,je){let qe=null,He=Hf(Me,Le,Fe,je);for(const F of Oe){const Oe=Hf(Me-F.x,Le,Fe,je)+F.badness;Oe<=He&&(qe=F,He=Oe)}return{index:F,x:Me,priorBreak:qe,badness:He}}function Wf(F){return F?Wf(F.priorBreak).concat(F.index):[]}function Kf(F){let Me=.5,Le=.5;switch(F){case"right":case"top-right":case"bottom-right":Me=1;break;case"left":case"top-left":case"bottom-left":Me=0}switch(F){case"bottom":case"bottom-right":case"bottom-left":Le=1;break;case"top":case"top-right":case"top-left":Le=0}return{horizontalAlign:Me,verticalAlign:Le}}function Jf(F,Me,Le,Oe,Fe){if(!(Me||Le||Oe||Fe))return;const je=F.length-1,qe=F[je],He=(qe.x+qe.metrics.advance*qe.scale)*Me;for(let Me=0;Me<=je;Me++)F[Me].x-=He,F[Me].y+=Le+Oe+Fe}function Qf(F,Me,Le,Oe){const{horizontalAlign:Fe,verticalAlign:je}=Kf(Oe),qe=Le[0]-F.displaySize[0]*Fe,He=Le[1]-F.displaySize[1]*je;return{imagePrimary:F,imageSecondary:Me,top:He,bottom:He+F.displaySize[1],left:qe,right:qe+F.displaySize[0]}}function td(F,Me,Le,Oe,Fe,je){const qe=F.imagePrimary;let He;if(qe.content){const F=qe.content,Me=qe.pixelRatio||1;He=[F[0]/Me,F[1]/Me,qe.displaySize[0]-F[2]/Me,qe.displaySize[1]-F[3]/Me]}const xt=Me.left*je,Pt=Me.right*je;let jt,Gt,bi,wi;"width"===Le||"both"===Le?(wi=Fe[0]+xt-Oe[3],Gt=Fe[0]+Pt+Oe[1]):(wi=Fe[0]+(xt+Pt-qe.displaySize[0])/2,Gt=wi+qe.displaySize[0]);const qr=Me.top*je,Xn=Me.bottom*je;return"height"===Le||"both"===Le?(jt=Fe[1]+qr-Oe[0],bi=Fe[1]+Xn+Oe[2]):(jt=Fe[1]+(qr+Xn-qe.displaySize[1])/2,bi=jt+qe.displaySize[1]),{imagePrimary:qe,imageSecondary:void 0,top:jt,right:Gt,bottom:bi,left:wi,collisionPadding:He}}class ed extends ec{constructor(F,Me,Le,Oe,Fe){super(F,Me),this.angle=Oe,this.z=Le,void 0!==Fe&&(this.segment=Fe)}clone(){return new ed(this.x,this.y,this.z,this.angle,this.segment)}}function rd(F,Me,Le,Oe,Fe){if(void 0===Me.segment)return!0;let je=Me,qe=Me.segment+1,He=0;for(;He>-Le/2;){if(qe--,qe<0)return!1;He-=F[qe].dist(je),je=F[qe]}He+=F[qe].dist(F[qe+1]),qe++;const xt=[];let Pt=0;for(;He<Le/2;){const Me=F[qe],Le=F[qe+1];if(!Le)return!1;let je=F[qe-1].angleTo(Me)-Me.angleTo(Le);for(je=Math.abs((je+3*Math.PI)%(2*Math.PI)-Math.PI),xt.push({distance:He,angleDelta:je}),Pt+=je;He-xt[0].distance>Oe;)Pt-=xt.shift().angleDelta;if(Pt>Fe)return!1;qe++,He+=Me.dist(Le)}return!0}function nd(F){let Me=0;for(let Le=0;Le<F.length-1;Le++)Me+=F[Le].dist(F[Le+1]);return Me}function id(F,Me,Le){return F?.6*Me*Le:0}function sd(F,Me){return Math.max(F?F.right-F.left:0,Me?Me.right-Me.left:0)}function ad(F,Me,Le,Oe,Fe,je){const qe=id(Le,Fe,je),He=sd(Le,Oe)*je;let xt=0;const Pt=nd(F)/2;for(let Le=0;Le<F.length-1;Le++){const Oe=F[Le],Fe=F[Le+1],je=Oe.dist(Fe);if(xt+je>Pt){const jt=(Pt-xt)/je,Gt=Ee(Oe.x,Fe.x,jt),bi=Ee(Oe.y,Fe.y,jt),wi=new ed(Gt,bi,0,Fe.angleTo(Oe),Le);return!qe||rd(F,wi,He,qe,Me)?wi:void 0}xt+=je}}function od(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt=id(Oe,je,qe),jt=sd(Oe,Fe),Gt=jt*qe,bi=0===F[0].x||F[0].x===xt||0===F[0].y||F[0].y===xt;return Me-Gt<Me/4&&(Me=Gt+Me/4),ld(F,bi?Me/2*He%Me:(jt/2+2*je)*qe*He%Me,Me,Pt,Le,Gt,bi,!1,xt)}function ld(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt=je/2,jt=nd(F);let Gt=0,bi=Me-Le,wi=[];for(let Me=0;Me<F.length-1;Me++){const qe=F[Me],He=F[Me+1],qr=qe.dist(He),Xn=He.angleTo(qe);for(;bi+Le<Gt+qr;){bi+=Le;const Yn=(bi-Gt)/qr,yo=Ee(qe.x,He.x,Yn),bo=Ee(qe.y,He.y,Yn);if(yo>=0&&yo<xt&&bo>=0&&bo<xt&&bi-Pt>=0&&bi+Pt<=jt){const Le=new ed(yo,bo,0,Xn,Me);Oe&&!rd(F,Le,je,Oe,Fe)||wi.push(Le)}}Gt+=qr}return He||wi.length||qe||(wi=ld(F,Gt/2,Le,Oe,Fe,je,qe,!0,xt)),wi}function ud(F,Me,Le,Oe,Fe){const je=[];for(let qe=0;qe<F.length;qe++){const He=F[qe];let xt;for(let F=0;F<He.length-1;F++){let qe=He[F],Pt=He[F+1];qe.x<Me&&Pt.x<Me||(qe.x<Me?qe=new ec(Me,qe.y+(Me-qe.x)/(Pt.x-qe.x)*(Pt.y-qe.y))._round():Pt.x<Me&&(Pt=new ec(Me,qe.y+(Me-qe.x)/(Pt.x-qe.x)*(Pt.y-qe.y))._round()),qe.y<Le&&Pt.y<Le||(qe.y<Le?qe=new ec(qe.x+(Le-qe.y)/(Pt.y-qe.y)*(Pt.x-qe.x),Le)._round():Pt.y<Le&&(Pt=new ec(qe.x+(Le-qe.y)/(Pt.y-qe.y)*(Pt.x-qe.x),Le)._round()),qe.x>=Oe&&Pt.x>=Oe||(qe.x>=Oe?qe=new ec(Oe,qe.y+(Oe-qe.x)/(Pt.x-qe.x)*(Pt.y-qe.y))._round():Pt.x>=Oe&&(Pt=new ec(Oe,qe.y+(Oe-qe.x)/(Pt.x-qe.x)*(Pt.y-qe.y))._round()),qe.y>=Fe&&Pt.y>=Fe||(qe.y>=Fe?qe=new ec(qe.x+(Fe-qe.y)/(Pt.y-qe.y)*(Pt.x-qe.x),Fe)._round():Pt.y>=Fe&&(Pt=new ec(qe.x+(Fe-qe.y)/(Pt.y-qe.y)*(Pt.x-qe.x),Fe)._round()),xt&&qe.equals(xt[xt.length-1])||(xt=[qe],je.push(xt)),xt.push(Pt)))))}}return je}function cd(F){let Me=0,Le=0;for(const Oe of F)Me+=Oe.w*Oe.h,Le=Math.max(Le,Oe.w);F.sort(((F,Me)=>Me.h-F.h));const Oe=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(Me/.95)),Le),h:1/0}];let Fe=0,je=0;for(const Me of F)for(let F=Oe.length-1;F>=0;F--){const Le=Oe[F];if(!(Me.w>Le.w||Me.h>Le.h)){if(Me.x=Le.x,Me.y=Le.y,je=Math.max(je,Me.y+Me.h),Fe=Math.max(Fe,Me.x+Me.w),Me.w===Le.w&&Me.h===Le.h){const Me=Oe.pop();F<Oe.length&&(Oe[F]=Me)}else Me.h===Le.h?(Le.x+=Me.w,Le.w-=Me.w):Me.w===Le.w?(Le.y+=Me.h,Le.h-=Me.h):(Oe.push({x:Le.x+Me.w,y:Le.y,w:Le.w-Me.w,h:Me.h}),Le.y+=Me.h,Le.h-=Me.h);break}}return{w:Fe,h:je,fill:Me/(Fe*je)||0}}us(ed,"Anchor");const Vx=1;class pd{static getImagePositionScale(F,Me,Le){if(Me&&F&&F.options&&F.options.transform){const Me=F.options.transform;return{x:Me.a,y:Me.d}}return{x:Le,y:Le}}constructor(F,Me,Le,Oe){this.paddedRect=F;const{pixelRatio:Fe,version:je,stretchX:qe,stretchY:He,content:xt,sdf:Pt,usvg:jt}=Me;this.pixelRatio=Fe,this.stretchX=qe,this.stretchY=He,this.content=xt,this.version=je,this.padding=Le,this.sdf=Pt,this.scale=pd.getImagePositionScale(Oe,jt,Fe)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function fd(F,Me,Le){const Oe=tr.parse(F),Fe=function(F,Me,Le=[1,1]){return{x:0,y:0,w:(F.data?F.data.width:F.width*Le[0])+2*Me,h:(F.data?F.data.height:F.height*Le[1])+2*Me}}(Me,Le,[Oe.options.transform.a,Oe.options.transform.d]);return{bin:Fe,imagePosition:new pd(Fe,Me,Le,Oe),imageVariant:Oe}}class dd{constructor(F,Me,Le){const Oe=new Map,Fe=new Map;this.haveRenderCallbacks=[];const je=[];this.addImages(F,Oe,Vx,je),this.addImages(Me,Fe,2,je);const{w:qe,h:He}=cd(je),xt=new pc({width:qe||1,height:He||1});for(const[Me,Fe]of F.entries()){const F=Oe.get(Me).paddedRect;pc.copy(Fe.data,xt,{x:0,y:0},{x:F.x+Vx,y:F.y+Vx},Fe.data,Le,Fe.sdf)}for(const[F,Oe]of Me.entries()){const Me=Fe.get(F),je=Me.paddedRect;let qe=Me.padding;const He=je.x+qe,Pt=je.y+qe,jt=Oe.data.width,Gt=Oe.data.height;qe=qe>1?qe-1:qe,pc.copy(Oe.data,xt,{x:0,y:0},{x:He,y:Pt},Oe.data,Le),pc.copy(Oe.data,xt,{x:0,y:Gt-qe},{x:He,y:Pt-qe},{width:jt,height:qe},Le),pc.copy(Oe.data,xt,{x:0,y:0},{x:He,y:Pt+Gt},{width:jt,height:qe},Le),pc.copy(Oe.data,xt,{x:jt-qe,y:0},{x:He-qe,y:Pt},{width:qe,height:Gt},Le),pc.copy(Oe.data,xt,{x:0,y:0},{x:He+jt,y:Pt},{width:qe,height:Gt},Le),pc.copy(Oe.data,xt,{x:jt-qe,y:Gt-qe},{x:He-qe,y:Pt-qe},{width:qe,height:qe},Le),pc.copy(Oe.data,xt,{x:0,y:Gt-qe},{x:He+jt,y:Pt-qe},{width:qe,height:qe},Le),pc.copy(Oe.data,xt,{x:0,y:0},{x:He+jt,y:Pt+Gt},{width:qe,height:qe},Le),pc.copy(Oe.data,xt,{x:jt-qe,y:0},{x:He-qe,y:Pt+Gt},{width:qe,height:qe},Le)}this.lut=Le,this.image=xt,this.iconPositions=Oe,this.patternPositions=Fe}addImages(F,Me,Le,Oe){for(const[Fe,je]of F.entries()){const{bin:F,imagePosition:qe,imageVariant:He}=fd(Fe,je,Le);Me.set(Fe,qe),Oe.push(F),je.hasRenderCallback&&this.haveRenderCallbacks.push(He.id)}}patchUpdatedImages(F,Me,Le){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((Me=>F.hasImage(Me,Le))),F.dispatchRenderCallbacks(this.haveRenderCallbacks,Le);for(const Oe of F.getUpdatedImages(Le)){for(const Fe of this.iconPositions.keys()){const je=tr.parse(Fe);if(we.isEqual(je.id,Oe)){const je=F.getImage(Oe,Le);this.patchUpdatedImage(this.iconPositions.get(Fe),je,Me)}}for(const Fe of this.patternPositions.keys()){const je=tr.parse(Fe);if(we.isEqual(je.id,Oe)){const je=F.getImage(Oe,Le);this.patchUpdatedImage(this.patternPositions.get(Fe),je,Me)}}}}patchUpdatedImage(F,Me,Le){if(!F||!Me)return;if(F.version===Me.version)return;F.version=Me.version;const[Oe,Fe]=F.tl,je=F.sdf;if(this.lut||je){const F={width:Me.data.width,height:Me.data.height},qe=new pc(F);pc.copy(Me.data,qe,{x:0,y:0},{x:0,y:0},F,this.lut,je),Le.update(qe,{position:{x:Oe,y:Fe}})}else Le.update(Me.data,{position:{x:Oe,y:Fe}})}}us(pd,"ImagePosition"),us(dd,"ImageAtlas");const Ux=1e20;function yd(F,Me,Le,Oe,Fe,je,qe,He,xt){for(let Pt=Me;Pt<Me+Oe;Pt++)gd(F,Le*je+Pt,je,Fe,qe,He,xt);for(let Pt=Le;Pt<Le+Fe;Pt++)gd(F,Pt*je+Me,1,Oe,qe,He,xt)}function gd(F,Me,Le,Oe,Fe,je,qe){je[0]=0,qe[0]=-Ux,qe[1]=Ux,Fe[0]=F[Me];for(let He=1,xt=0,Pt=0;He<Oe;He++){Fe[He]=F[Me+He*Le];const Oe=He*He;do{const F=je[xt];Pt=(Fe[He]-Fe[F]+Oe-F*F)/(He-F)/2}while(Pt<=qe[xt]&&--xt>-1);xt++,je[xt]=He,qe[xt]=Pt,qe[xt+1]=Ux}for(let He=0,xt=0;He<Oe;He++){for(;qe[xt+1]<He;)xt++;const Oe=je[xt],Pt=He-Oe;F[Me+He*Le]=Fe[Oe]+Pt*Pt}}const Gx=2,Hx={none:0,ideographs:1,all:2};class bd{constructor(F,Me,Le){this.requestManager=F,this.localGlyphMode=Me,this.localFontFamily=Le,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(F,Me){this.urls[Me]=F}getGlyphs(F,Me,Le){const Oe=[],Fe=this.urls[Me]||yc.GLYPHS_URL;for(const Me in F)for(const Le of F[Me])Oe.push({stack:Me,id:Le});rt(Oe,(({stack:F,id:Me},Le)=>{let Oe=this.entries[F];Oe||(Oe=this.entries[F]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let je=Oe.glyphs[Me];if(void 0!==je)return void Le(null,{stack:F,id:Me,glyph:je});if(je=this._tinySDF(Oe,F,Me),je)return Oe.glyphs[Me]=je,void Le(null,{stack:F,id:Me,glyph:je});const qe=Math.floor(Me/256);if(256*qe>65535)return pt("glyphs > 65535 not supported"),void Le(null,{stack:F,id:Me,glyph:je});if(Oe.ranges[qe])return void Le(null,{stack:F,id:Me,glyph:je});let He=Oe.requests[qe];He||(He=Oe.requests[qe]=[],bd.loadGlyphRange(F,qe,Fe,this.requestManager,((F,Me)=>{if(Me){Oe.ascender=Me.ascender,Oe.descender=Me.descender;for(const F in Me.glyphs)this._doesCharSupportLocalGlyph(+F)||(Oe.glyphs[+F]=Me.glyphs[+F]);Oe.ranges[qe]=!0}for(const Le of He)Le(F,Me);delete Oe.requests[qe]}))),He.push(((Oe,Fe)=>{Oe?Le(Oe):Fe&&Le(null,{stack:F,id:Me,glyph:Fe.glyphs[Me]||null})}))}),((F,Me)=>{if(F)Le(F);else if(Me){const F={};for(const{stack:Le,id:Oe,glyph:Fe}of Me)void 0===F[Le]&&(F[Le]={}),void 0===F[Le].glyphs&&(F[Le].glyphs={}),F[Le].glyphs[Oe]=Fe&&{id:Fe.id,bitmap:Fe.bitmap.clone(),metrics:Fe.metrics},F[Le].ascender=this.entries[Le].ascender,F[Le].descender=this.entries[Le].descender;Le(null,F)}}))}_doesCharSupportLocalGlyph(F){return this.localGlyphMode!==Hx.none&&(this.localGlyphMode===Hx.all?!!this.localFontFamily:!!this.localFontFamily&&(ff["CJK Unified Ideographs"](F)||ff["Hangul Syllables"](F)||ff.Hiragana(F)||ff.Katakana(F)||ff["CJK Symbols and Punctuation"](F)||ff["CJK Unified Ideographs Extension A"](F)||ff["CJK Unified Ideographs Extension B"](F)||ff.Osage(F)))}_tinySDF(F,Me,Le){const Oe=this.localFontFamily;if(!Oe||!this._doesCharSupportLocalGlyph(Le))return;let Fe=F.tinySDF;if(!Fe){let Le="400";/bold/i.test(Me)?Le="900":/medium/i.test(Me)?Le="500":/light/i.test(Me)&&(Le="200"),Fe=F.tinySDF=new bd.TinySDF({fontFamily:Oe,fontWeight:Le,fontSize:24*Gx,buffer:3*Gx,radius:8*Gx}),Fe.fontWeight=Le}if(this.localGlyphs[Fe.fontWeight][Le])return this.localGlyphs[Fe.fontWeight][Le];const je=String.fromCodePoint(Le),{data:qe,width:He,height:xt,glyphWidth:Pt,glyphHeight:jt,glyphLeft:Gt,glyphTop:bi,glyphAdvance:wi}=Fe.draw(je);return this.localGlyphs[Fe.fontWeight][Le]={id:Le,bitmap:new hc({width:He,height:xt},qe),metrics:{width:Pt/Gx,height:jt/Gx,left:Gt/Gx,top:bi/Gx-27,advance:wi/Gx,localGlyph:!0}}}}bd.loadGlyphRange=function(F,Me,Le,Oe,Fe){const je=256*Me,qe=je+255,He=Oe.transformRequest(Oe.normalizeGlyphsURL(Le).replace("{fontstack}",F).replace("{range}",`${je}-${qe}`),zh.Glyphs);ne(He,((F,Me)=>{if(F)Fe(F);else if(Me){const F={},Le=function(F){return new Dx(F).readFields(Rf,{})}(Me);for(const Me of Le.glyphs)F[Me.id]=Me;Fe(null,{glyphs:F,ascender:Le.ascender,descender:Le.descender})}}))},bd.TinySDF=class{constructor({fontSize:F=24,buffer:Me=3,radius:Le=8,cutoff:Oe=.25,fontFamily:Fe="sans-serif",fontWeight:je="normal",fontStyle:qe="normal"}={}){this.buffer=Me,this.cutoff=Oe,this.radius=Le;const He=this.size=F+4*Me,xt=this._createCanvas(He),Pt=this.ctx=xt.getContext("2d",{willReadFrequently:!0});Pt.font=`${qe} ${je} ${F}px ${Fe}`,Pt.textBaseline="alphabetic",Pt.textAlign="left",Pt.fillStyle="black",this.gridOuter=new Float64Array(He*He),this.gridInner=new Float64Array(He*He),this.f=new Float64Array(He),this.z=new Float64Array(He+1),this.v=new Uint16Array(He)}_createCanvas(F){const Me=document.createElement("canvas");return Me.width=Me.height=F,Me}draw(F){const{width:Me,actualBoundingBoxAscent:Le,actualBoundingBoxDescent:Oe,actualBoundingBoxLeft:Fe,actualBoundingBoxRight:je}=this.ctx.measureText(F),qe=Math.ceil(Le),He=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(je-Fe))),xt=Math.min(this.size-this.buffer,qe+Math.ceil(Oe)),Pt=He+2*this.buffer,jt=xt+2*this.buffer,Gt=Math.max(Pt*jt,0),bi=new Uint8ClampedArray(Gt),wi={data:bi,width:Pt,height:jt,glyphWidth:He,glyphHeight:xt,glyphTop:qe,glyphLeft:0,glyphAdvance:Me};if(0===He||0===xt)return wi;const{ctx:qr,buffer:Xn,gridInner:Yn,gridOuter:yo}=this;qr.clearRect(Xn,Xn,He,xt),qr.fillText(F,Xn,Xn+qe);const bo=qr.getImageData(Xn,Xn,He,xt);yo.fill(Ux,0,Gt),Yn.fill(0,0,Gt);for(let F=0;F<xt;F++)for(let Me=0;Me<He;Me++){const Le=bo.data[4*(F*He+Me)+3]/255;if(0===Le)continue;const Oe=(F+Xn)*Pt+Me+Xn;if(1===Le)yo[Oe]=0,Yn[Oe]=Ux;else{const F=.5-Le;yo[Oe]=F>0?F*F:0,Yn[Oe]=F<0?F*F:0}}yd(yo,0,0,Pt,jt,Pt,this.f,this.v,this.z),yd(Yn,Xn,Xn,He,xt,Pt,this.f,this.v,this.z);for(let F=0;F<Gt;F++){const Me=Math.sqrt(yo[F])-Math.sqrt(Yn[F]);bi[F]=Math.round(255-255*(Me/this.radius+this.cutoff))}return wi}};const Zx=Vx;function wd(F,Me){return F+Me[1]-Me[0]}function Md(F,Me,Le,Oe,Fe=1){const je=[],qe=F.imagePrimary,He=qe.pixelRatio,xt=qe.paddedRect.w-2*Zx,Pt=qe.paddedRect.h-2*Zx,jt=(F.right-F.left)*Fe,Gt=(F.bottom-F.top)*Fe,bi=qe.stretchX||[[0,xt]],wi=qe.stretchY||[[0,Pt]],qr=bi.reduce(wd,0),Xn=wi.reduce(wd,0),Yn=xt-qr,yo=Pt-Xn;let bo=0,Ro=qr,Do=0,zs=Xn,Zs=0,na=Yn,el=0,nl=yo;if(qe.content&&Oe){const F=qe.content;bo=Ad(bi,0,F[0]),Do=Ad(wi,0,F[1]),Ro=Ad(bi,F[0],F[2]),zs=Ad(wi,F[1],F[3]),Zs=F[0]-bo,el=F[1]-Do,na=F[2]-F[0]-Ro,nl=F[3]-F[1]-zs}const S=(Oe,je,xt,Pt)=>{const bi=Sd(Oe.stretch-bo,Ro,jt,F.left*Fe),wi=Pd(Oe.fixed-Zs,na,Oe.stretch,qr),Yn=Sd(je.stretch-Do,zs,Gt,F.top*Fe),yo=Pd(je.fixed-el,nl,je.stretch,Xn),hl=Sd(xt.stretch-bo,Ro,jt,F.left*Fe),pl=Pd(xt.fixed-Zs,na,xt.stretch,qr),bl=Sd(Pt.stretch-Do,zs,Gt,F.top*Fe),Tl=Pd(Pt.fixed-el,nl,Pt.stretch,Xn),kl=new ec(bi,Yn),tc=new ec(hl,Yn),ic=new ec(hl,bl),oc=new ec(bi,bl),sc=new ec(wi/He,yo/He),ac=new ec(pl/He,Tl/He),mc=Me*Math.PI/180;if(mc){const F=Math.sin(mc),Me=Math.cos(mc),Le=[Me,-F,F,Me];kl._matMult(Le),tc._matMult(Le),oc._matMult(Le),ic._matMult(Le)}const gc=Oe.stretch+Oe.fixed,yc=xt.stretch+xt.fixed,xc=je.stretch+je.fixed,Zc=Pt.stretch+Pt.fixed,Wc=F.imageSecondary;return{tl:kl,tr:tc,bl:oc,br:ic,texPrimary:{x:qe.paddedRect.x+Zx+gc,y:qe.paddedRect.y+Zx+xc,w:yc-gc,h:Zc-xc},texSecondary:Wc?{x:Wc.paddedRect.x+Zx+gc,y:Wc.paddedRect.y+Zx+xc,w:yc-gc,h:Zc-xc}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:sc,pixelOffsetBR:ac,minFontScaleX:na/He/jt,minFontScaleY:nl/He/Gt,isSDF:Le}};if(Oe&&(qe.stretchX||qe.stretchY)){const F=Id(bi,Yn,qr),Me=Id(wi,yo,Xn);for(let Le=0;Le<F.length-1;Le++){const Oe=F[Le],Fe=F[Le+1];for(let F=0;F<Me.length-1;F++)je.push(S(Oe,Me[F],Fe,Me[F+1]))}}else je.push(S({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:xt+1},{fixed:0,stretch:Pt+1}));return je}function Ad(F,Me,Le){let Oe=0;for(const Fe of F)Oe+=Math.max(Me,Math.min(Le,Fe[1]))-Math.max(Me,Math.min(Le,Fe[0]));return Oe}function Id(F,Me,Le){const Oe=[{fixed:-Zx,stretch:0}];for(const[Me,Le]of F){const F=Oe[Oe.length-1];Oe.push({fixed:Me-F.stretch,stretch:F.stretch}),Oe.push({fixed:Me-F.stretch,stretch:F.stretch+(Le-Me)})}return Oe.push({fixed:Me+Zx,stretch:Le}),Oe}function Sd(F,Me,Le,Oe){return F/Me*Le+Oe}function Pd(F,Me,Le,Oe){return F-Me*Le/Oe}function Ed(F,Me,Le,Oe){const Fe=Me+F.positionedLines[Oe].lineOffset;return 0===Oe?Le+Fe/2:Le+(Fe+(Me+F.positionedLines[Oe-1].lineOffset))/2}function zd(F,Me=1,Le=!1){let Oe=1/0,Fe=1/0,je=-1/0,qe=-1/0;const He=F[0];for(let F=0;F<He.length;F++){const Me=He[F];(!F||Me.x<Oe)&&(Oe=Me.x),(!F||Me.y<Fe)&&(Fe=Me.y),(!F||Me.x>je)&&(je=Me.x),(!F||Me.y>qe)&&(qe=Me.y)}const xt=Math.min(je-Oe,qe-Fe);let Pt=xt/2;const jt=new Wr([],kd);if(0===xt)return new ec(Oe,Fe);for(let Me=Oe;Me<je;Me+=xt)for(let Le=Fe;Le<qe;Le+=xt)jt.push(new Td(Me+Pt,Le+Pt,Pt,F));let Gt=function(F){let Me=0,Le=0,Oe=0;const Fe=F[0];for(let F=0,je=Fe.length,qe=je-1;F<je;qe=F++){const je=Fe[F],He=Fe[qe],xt=je.x*He.y-He.x*je.y;Le+=(je.x+He.x)*xt,Oe+=(je.y+He.y)*xt,Me+=3*xt}return new Td(Le/Me,Oe/Me,0,F)}(F),bi=jt.length;for(;jt.length;){const Oe=jt.pop();(Oe.d>Gt.d||!Gt.d)&&(Gt=Oe,Le&&console.log("found best %d after %d probes",Math.round(1e4*Oe.d)/1e4,bi)),Oe.max-Gt.d<=Me||(Pt=Oe.h/2,jt.push(new Td(Oe.p.x-Pt,Oe.p.y-Pt,Pt,F)),jt.push(new Td(Oe.p.x+Pt,Oe.p.y-Pt,Pt,F)),jt.push(new Td(Oe.p.x-Pt,Oe.p.y+Pt,Pt,F)),jt.push(new Td(Oe.p.x+Pt,Oe.p.y+Pt,Pt,F)),bi+=4)}return Le&&(console.log(`num probes: ${bi}`),console.log(`best distance: ${Gt.d}`)),Gt.p}function kd(F,Me){return Me.max-F.max}class Td{constructor(F,Me,Le,Oe){this.p=new ec(F,Me),this.h=Le,this.d=function(F,Me){let Le=!1,Oe=1/0;for(let Fe=0;Fe<Me.length;Fe++){const je=Me[Fe];for(let Me=0,Fe=je.length,qe=Fe-1;Me<Fe;qe=Me++){const Fe=je[Me],He=je[qe];Fe.y>F.y!=He.y>F.y&&F.x<(He.x-Fe.x)*(F.y-Fe.y)/(He.y-Fe.y)+Fe.x&&(Le=!Le),Oe=Math.min(Oe,Gl(F,Fe,He))}}return(Le?1:-1)*Math.sqrt(Oe)}(this.p,Oe),this.max=this.d+this.h*Math.SQRT2}}const Xx=Number.POSITIVE_INFINITY,Kx=Math.sqrt(2);function Cd(F,[Me,Le]){let Oe=0,Fe=0;if(Le===Xx){Me<0&&(Me=0);const Le=Me/Kx;switch(F){case"top-right":case"top-left":Fe=Le-7;break;case"bottom-right":case"bottom-left":Fe=7-Le;break;case"bottom":Fe=7-Me;break;case"top":Fe=Me-7}switch(F){case"top-right":case"bottom-right":Oe=-Le;break;case"top-left":case"bottom-left":Oe=Le;break;case"left":Oe=Me;break;case"right":Oe=-Me}}else{switch(Me=Math.abs(Me),Le=Math.abs(Le),F){case"top-right":case"top-left":case"top":Fe=Le-7;break;case"bottom-right":case"bottom-left":case"bottom":Fe=7-Le}switch(F){case"top-right":case"bottom-right":case"right":Oe=-Me;break;case"top-left":case"bottom-left":case"left":Oe=Me}}return[Oe,Fe]}function Dd(F,Me,Le,Oe,Fe,je,qe,He){if(!F)return;const xt=vf(Me,Le,Oe,Fe,je);return F.scaleSelf(xt*He*qe)}function Rd(F,Me,Le,Oe,Fe,je,qe,He){return{iconPrimary:Dd(F.getPrimary(),Me,Le,Oe,Fe,je,qe,He),iconSecondary:Dd(F.getSecondary(),Me,Le,Oe,Fe,je,qe,He)}}function Ld(F,Me,Le,Oe){if(!F)return;const Fe=Me.get(Le.toString());if(F.imagePrimary=Fe,Oe){const Le=Me.get(Oe.toString());F.imageSecondary=Le}}function Fd(F,Me){for(const Le in F.horizontal)Od(F.horizontal[Le],Me);Od(F.vertical,Me)}function Od(F,Me){if(F)for(const Le of F.positionedLines)for(const F of Le.positionedGlyphs)if(null!==F.image){const Le=F.image.toString();F.rect=Me.get(Le).paddedRect}}function Nd(F){switch(F){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Ud(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt=Yd(je.horizontal)||je.vertical,jt=Le.get("icon-text-fit-padding").evaluate(Oe,{},Fe);let Gt,bi=Me;return Me&&"none"!==xt&&(F.allowVerticalPlacement&&je.vertical&&(Gt=td(Me,je.vertical,xt,jt,He,qe)),Pt&&(bi=td(Me,Pt,xt,jt,He,qe))),{defaultShapedIcon:bi,verticallyShapedIcon:Gt}}function jd(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro){let Do=qe.textMaxSize.evaluate(Me,{},bi);void 0===Do?Do=He*qe.textScaleFactor:Do*=qe.textScaleFactor;const zs=F.layers[0].layout,Zs=Yd(Le.horizontal)||Le.vertical,na="globe"===wi.name,el=Sx,nl=F.tilePixelRatio*Do/el,hl=(tc=F.overscaling,F.zoom>18&&tc>2&&(tc>>=1),Math.max(np/(512*tc),1)*zs.get("symbol-spacing")),pl=zs.get("text-padding")*F.tilePixelRatio,bl=zs.get("icon-padding")*F.tilePixelRatio,Tl=H(zs.get("text-max-angle")),kl="map"===zs.get("icon-rotation-alignment")&&"point"!==Ro,ec=hl/2;var tc;!1===F.hasAnyIconTextFit&&"none"!==Yn&&(F.hasAnyIconTextFit=!0);const ic=Me.properties?+Me.properties[k_]:null,oc=ic&&F.elevationFeatureIdToIndex?F.elevationFeatureIdToIndex.get(ic):65535,D=(He,xt,Ro)=>{if(xt.x<0||xt.x>=np||xt.y<0||xt.y>=np)return;let Do=null;if(na){const{x:F,y:Me,z:Le}=wi.projectTilePoint(xt.x,xt.y,Ro);Do={anchor:new ed(F,Me,Le,0,void 0),up:wi.upVector(Ro,xt.x,xt.y)}}!function(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do,zs,Zs,na,el,nl,hl,pl,bl){const Tl=F.addToLineVertexArray(Me,Oe);let kl,ec,tc,ic,oc,sc,ac,mc=0,gc=0,yc=0,xc=0,Zc=-1,Wc=-1;const Kc={};let Jc=hu("");const Qc=Le?Le.anchor:Me,eh="none"!==pl;let th=0,rh=0;if(void 0===xt._unevaluatedLayout.getValue("text-radial-offset")?[th,rh]=xt.layout.get("text-offset").evaluate(Do,{},el).map((F=>F*Sx)):(th=xt.layout.get("text-radial-offset").evaluate(Do,{},el)*Sx,rh=Xx),F.allowVerticalPlacement&&Fe.vertical){const F=Fe.vertical;if(qr)sc=Xd(F),He&&(ac=Xd(He));else{const Le=xt.layout.get("text-rotate").evaluate(Do,{},el)+90;tc=Hd(Pt,Qc,Me,jt,Gt,bi,F,wi,Le,Xn),He&&(ic=Hd(Pt,Qc,Me,jt,Gt,bi,He,yo,Le))}}if(je){const Oe=F.iconSizeData,Fe=xt.layout.get("icon-rotate").evaluate(Do,{},el),qe=Md(je,Fe,Zs,eh,zs.iconScaleFactor),wi=He?Md(He,Fe,Zs,eh,zs.iconScaleFactor):void 0;ec=Hd(Pt,Qc,Me,jt,Gt,bi,je,yo,Fe,null),mc=4*qe.length;let qr=null;"source"===Oe.kind?(qr=[Ex*xt.layout.get("icon-size").evaluate(Do,{},el)*zs.iconScaleFactor],qr[0]>Qx&&pt(`${F.layerIds[0]}: Value for "icon-size" is >= ${Jx}. Reduce your "icon-size".`)):"composite"===Oe.kind&&(qr=[Ex*zs.compositeIconSizes[0].evaluate(Do,{},el)*zs.iconScaleFactor,Ex*zs.compositeIconSizes[1].evaluate(Do,{},el)*zs.iconScaleFactor],(qr[0]>Qx||qr[1]>Qx)&&pt(`${F.layerIds[0]}: Value for "icon-size" is >= ${Jx}. Reduce your "icon-size".`)),F.addSymbols(F.icon,qe,qr,Ro,bo,Do,!1,Le,Me,Tl.lineStartIndex,Tl.lineLength,-1,na,el,nl,hl),Zc=F.icon.placedSymbolArray.length-1,wi&&(gc=4*wi.length,F.addSymbols(F.icon,wi,qr,Ro,bo,Do,Fx.vertical,Le,Me,Tl.lineStartIndex,Tl.lineLength,-1,na,el,nl,hl),Wc=F.icon.placedSymbolArray.length-1)}for(const Oe in Fe.horizontal){const je=Fe.horizontal[Oe];kl||(Jc=hu(je.text),qr?oc=Xd(je):kl=Hd(Pt,Qc,Me,jt,Gt,bi,je,wi,xt.layout.get("text-rotate").evaluate(Do,{},el),Xn));const He=1===je.positionedLines.length;if(yc+=Gd(F,Le,Me,je,qe,xt,qr,Do,Xn,Tl,Fe.vertical?Fx.horizontal:Fx.horizontalOnly,He?Object.keys(Fe.horizontal):[Oe],Kc,Zc,zs,na,el,nl),He)break}Fe.vertical&&(xc+=Gd(F,Le,Me,Fe.vertical,qe,xt,qr,Do,Xn,Tl,Fx.vertical,["vertical"],Kc,Wc,zs,na,el,nl));let oh=-1;const W=(F,Me)=>F?Math.max(F,Me):Me;oh=W(oc,oh),oh=W(sc,oh),oh=W(ac,oh);const ah=oh>-1?1:0;F.glyphOffsetArray.length>=65535&&pt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==Do.sortKey&&F.addToSortKeyRanges(F.symbolInstances.length,Do.sortKey),F.symbolInstances.emplaceBack(Me.x,Me.y,Qc.x,Qc.y,Qc.z,Kc.right>=0?Kc.right:-1,Kc.center>=0?Kc.center:-1,Kc.left>=0?Kc.left:-1,Kc.vertical>=0?Kc.vertical:-1,Zc,Wc,Jc,void 0!==kl?kl:F.collisionBoxArray.length,void 0!==kl?kl+1:F.collisionBoxArray.length,void 0!==tc?tc:F.collisionBoxArray.length,void 0!==tc?tc+1:F.collisionBoxArray.length,void 0!==ec?ec:F.collisionBoxArray.length,void 0!==ec?ec+1:F.collisionBoxArray.length,ic||F.collisionBoxArray.length,ic?ic+1:F.collisionBoxArray.length,jt,yc,xc,mc,gc,ah,0,th,rh,oh,0,eh?1:0,bl)}(F,xt,Do,He,Le,Oe,je,Fe,F.layers[0],F.collisionBoxArray,Me.index,Me.sourceLayerIndex,F.index,pl,bo,Pt,0,bl,kl,yo,Me,qe,jt,Gt,bi,qr,Xn,Yn,oc)};if("line"===Ro)for(const Fe of ud(Me.geometry,0,0,np,np)){const Me=od(Fe,hl,Tl,Le.vertical||Zs,Oe,el,nl,F.overscaling,np);for(const Le of Me)Zs&&Zd(F,Zs.text,ec,Le)||D(Fe,Le,bi)}else if("line-center"===Ro){for(const F of Me.geometry)if(F.length>1){const Me=ad(F,Tl,Le.vertical||Zs,Oe,el,nl);Me&&D(F,Me,bi)}}else if("Polygon"===Me.type)for(const F of $c(Me.geometry,0)){const Me=zd(F,16);D(F[0],new ed(Me.x,Me.y,0,0,void 0),bi)}else if("LineString"===Me.type)for(const F of Me.geometry)D(F,new ed(F[0].x,F[0].y,0,0,void 0),bi);else if("Point"===Me.type)for(const F of Me.geometry)for(const Me of F)D([Me],new ed(Me.x,Me.y,0,0,void 0),bi)}const Jx=255,Qx=Jx*Ex;function Gd(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo){const bo=function(F,Me,Le,Oe,Fe,je,qe,He){const xt=[];if(0===Me.positionedLines.length)return xt;const Pt=Oe.layout.get("text-rotate").evaluate(je,{})*Math.PI/180,jt=function(F){const Me=F[0],Le=F[1],Oe=Me*Le;return Oe>0?[Me,-Le]:Oe<0?[-Me,Le]:0===Me?[Le,Me]:[Le,-Me]}(Le);let Gt=Math.abs(Me.top-Me.bottom);for(const F of Me.positionedLines)Gt-=F.lineOffset;const bi=Me.positionedLines.length,wi=Gt/bi;let qr=Me.top-Le[1];for(let F=0;F<bi;++F){const Oe=Me.positionedLines[F];qr=Ed(Me,wi,qr,F);for(const F of Oe.positionedGlyphs){if(!F.rect)continue;const Oe=F.rect||{};let je=kx+1,Gt=!0,bi=1,wi=0;if(F.image){const Me=qe.get(F.image.toString());if(!Me)continue;if(Me.sdf){pt("SDF images are not supported in formatted text and will be ignored.");continue}Gt=!1,bi=Me.pixelRatio,je=Vx/bi}const Xn=(Fe||He)&&F.vertical,Yn=F.metrics.advance*F.scale/2,yo=F.metrics,bo=F.rect;if(null===bo)continue;He&&Me.verticalizable&&(wi=F.image?Yn-F.metrics.width*F.scale/2:0);const Ro=Fe?[F.x+Yn,F.y]:[0,0];let Do=[0,0],zs=[0,0],Zs=!1;Fe||(Xn?(zs=[F.x+Yn+jt[0],F.y+jt[1]-wi],Zs=!0):Do=[F.x+Yn+Le[0],F.y+Le[1]-wi]);const na=bo.w*F.scale/(bi*(F.localGlyph?Gx:1)),el=bo.h*F.scale/(bi*(F.localGlyph?Gx:1));let nl,hl,pl,bl;if(Xn){const Me=F.y-qr,Le=new ec(-Yn,Yn-Me),Oe=-Math.PI/2,Fe=new ec(...zs);nl=new ec(-Yn+Do[0],Do[1]),nl._rotateAround(Oe,Le)._add(Fe),nl.x+=-Me+Yn,nl.y-=(yo.left-je)*F.scale;const qe=F.image?yo.advance*F.scale:Sx*F.scale,He=String.fromCodePoint(F.glyph);Sf(He)?nl.x+=(1-je)*F.scale:Pf(He)?nl.x+=qe-yo.height*F.scale+(-je-1)*F.scale:nl.x+=F.image||yo.width+2*je===bo.w&&yo.height+2*je===bo.h?(qe-el)/2:(qe-(yo.height+2*je)*F.scale)/2,hl=new ec(nl.x,nl.y-na),pl=new ec(nl.x+el,nl.y),bl=new ec(nl.x+el,nl.y-na)}else{const Me=(yo.left-je)*F.scale-Yn+Do[0],Le=(-yo.top-je)*F.scale+Do[1],Oe=Me+na,Fe=Le+el;nl=new ec(Me,Le),hl=new ec(Oe,Le),pl=new ec(Me,Fe),bl=new ec(Oe,Fe)}if(Pt){let F;F=Fe?new ec(0,0):Zs?new ec(jt[0],jt[1]):new ec(Le[0],Le[1]),nl._rotateAround(Pt,F),hl._rotateAround(Pt,F),pl._rotateAround(Pt,F),bl._rotateAround(Pt,F)}const Tl=new ec(0,0),kl=new ec(0,0);xt.push({tl:nl,tr:hl,bl:pl,br:bl,texPrimary:Oe,texSecondary:void 0,writingMode:Me.writingMode,glyphOffset:Ro,sectionIndex:F.sectionIndex,isSDF:Gt,pixelOffsetTL:Tl,pixelOffsetBR:kl,minFontScaleX:0,minFontScaleY:0})}}return xt}(0,Oe,xt,je,qe,He,Fe,F.allowVerticalPlacement),Ro=F.textSizeData;let Do=null;"source"===Ro.kind?(Do=[Ex*je.layout.get("text-size").evaluate(He,{},Yn)*qr.textScaleFactor],Do[0]>Qx&&pt(`${F.layerIds[0]}: Value for "text-size" is >= ${Jx}. Reduce your "text-size".`)):"composite"===Ro.kind&&(Do=[Ex*qr.compositeTextSizes[0].evaluate(He,{},Yn)*qr.textScaleFactor,Ex*qr.compositeTextSizes[1].evaluate(He,{},Yn)*qr.textScaleFactor],(Do[0]>Qx||Do[1]>Qx)&&pt(`${F.layerIds[0]}: Value for "text-size" is >= ${Jx}. Reduce your "text-size".`)),F.addSymbols(F.text,bo,Do,xt,qe,He,jt,Me,Le,Pt.lineStartIndex,Pt.lineLength,wi,Xn,Yn,yo,!1);for(const Me of Gt)bi[Me]=F.text.placedSymbolArray.length-1;return 4*bo.length}function Yd(F){for(const Me in F)return F[Me];return null}function Hd(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt){let jt=qe.top,Gt=qe.bottom,bi=qe.left,wi=qe.right;const qr=qe.collisionPadding;if(qr&&(bi-=qr[0],jt-=qr[1],wi+=qr[2],Gt+=qr[3]),xt){const F=new ec(bi,jt),Me=new ec(wi,jt),Le=new ec(bi,Gt),Oe=new ec(wi,Gt),Fe=H(xt);let je=new ec(0,0);Pt&&(je=new ec(Pt[0],Pt[1])),F._rotateAround(Fe,je),Me._rotateAround(Fe,je),Le._rotateAround(Fe,je),Oe._rotateAround(Fe,je),bi=Math.min(F.x,Me.x,Le.x,Oe.x),wi=Math.max(F.x,Me.x,Le.x,Oe.x),jt=Math.min(F.y,Me.y,Le.y,Oe.y),Gt=Math.max(F.y,Me.y,Le.y,Oe.y)}return F.emplaceBack(Me.x,Me.y,Me.z,Le.x,Le.y,bi,jt,wi,Gt,He,Oe,Fe,je),F.length-1}function Xd(F){F.collisionPadding&&(F.top-=F.collisionPadding[1],F.bottom+=F.collisionPadding[3]);const Me=F.bottom-F.top;return Me>0?Math.max(10,Me):null}function Zd(F,Me,Le,Oe){const Fe=F.compareText;if(Me in Fe){const F=Fe[Me];for(let Me=F.length-1;Me>=0;Me--)if(Oe.dist(F[Me])<Le)return!0}else Fe[Me]=[];return Fe[Me].push(Oe),!1}function Wd(F,Me){const Le=F.fovAboveCenter,Oe=F.elevation?F.elevation.getMinElevationBelowMSL()*Me:0,Fe=(F._camera.position[2]*F.worldSize-Oe)/Math.cos(F._pitch),je=Math.sin(Le)*Fe/Math.sin(Math.max(Math.PI/2-F._pitch-Le,.01));let qe=Math.sin(F._pitch)*je+Fe;const He=Fe*(1/F._horizonShift);if(!F.elevation||0===F.elevation.exaggeration()){let Me=Math.max(F.zoom-17,0);F.isOrthographic&&(Me/=10),qe*=1+Me}return Math.min(1.01*qe,He)}function Kd(F,Me){if(!Me.isReprojectedInTileSpace)return{scale:1<<F.z,x:F.x,y:F.y,x2:F.x+1,y2:F.y+1,projection:Me};const Le=Math.pow(2,-F.z),Oe=F.x*Le,Fe=(F.x+1)*Le,je=F.y*Le,qe=(F.y+1)*Le,He=gl(Oe),xt=gl(Fe),Pt=xl(je),jt=xl(qe),Gt=Me.project(He,Pt),bi=Me.project(xt,Pt),wi=Me.project(xt,jt),qr=Me.project(He,jt);let Xn=Math.min(Gt.x,bi.x,wi.x,qr.x),Yn=Math.min(Gt.y,bi.y,wi.y,qr.y),yo=Math.max(Gt.x,bi.x,wi.x,qr.x),bo=Math.max(Gt.y,bi.y,wi.y,qr.y);const Ro=Le/16;function b(F,Le,Oe,Fe,je,qe){const He=(Oe+je)/2,xt=(Fe+qe)/2,Pt=Me.project(gl(He),xl(xt)),jt=Math.max(0,Xn-Pt.x,Yn-Pt.y,Pt.x-yo,Pt.y-bo);Xn=Math.min(Xn,Pt.x),yo=Math.max(yo,Pt.x),Yn=Math.min(Yn,Pt.y),bo=Math.max(bo,Pt.y),jt>Ro&&(b(F,Pt,Oe,Fe,He,xt),b(Pt,Le,He,xt,je,qe))}b(Gt,bi,Oe,je,Fe,je),b(bi,wi,Fe,je,Fe,qe),b(wi,qr,Fe,qe,Oe,qe),b(qr,Gt,Oe,qe,Oe,je),Xn-=Ro,Yn-=Ro,yo+=Ro,bo+=Ro;const Do=1/Math.max(yo-Xn,bo-Yn);return{scale:Do,x:Xn*Do,y:Yn*Do,x2:yo*Do,y2:bo*Do,projection:Me}}function Jd(F,{x:Me,y:Le},Oe=0){return new ec(((Me-Oe)*F.scale-F.x)*np,(Le*F.scale-F.y)*np)}const tv=bl.mat4.identity(new Float32Array(16));class tm{constructor(F){this.spec=F,this.name=F.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(F,Me){return{x:0,y:0,z:0}}unproject(F,Me){return new ul(0,0)}projectTilePoint(F,Me,Le){return{x:F,y:Me,z:0}}locationPoint(F,Me,Le,Oe=!0){return F._coordinatePoint(F.locationCoordinate(Me,Le),Oe)}pixelsPerMeter(F,Me){return yl(1,F)*Me}pixelSpaceConversion(F,Me,Le){return 1}farthestPixelDistance(F){return Wd(F,F.pixelsPerMeter)}pointCoordinate(F,Me,Le,Oe){const Fe=F.horizonLineFromTop(!1),je=new ec(Me,Math.max(Fe,Le));return F.rayIntersectionCoordinate(F.pointRayIntersection(je,Oe))}pointCoordinate3D(F,Me,Le){const Oe=new ec(Me,Le);if(F.elevation)return F.elevation.pointCoordinate(Oe);{const Me=this.pointCoordinate(F,Oe.x,Oe.y,0);return[Me.x,Me.y,Me.z]}}isPointAboveHorizon(F,Me){if(F.elevation&&F.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(F,Me.x,Me.y);const Le=F.horizonLineFromTop();return Me.y<Le}createInversionMatrix(F,Me){return tv}createTileMatrix(F,Me,Le){let Oe,Fe,je;const qe=Le.canonical,He=bl.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const xt=Kd(qe,this);Oe=1,Fe=xt.x+Le.wrap*xt.scale,je=xt.y,bl.mat4.scale(He,He,[Oe/xt.scale,Oe/xt.scale,F.pixelsPerMeter/Me])}else Oe=Me/F.zoomScale(qe.z),Fe=(qe.x+Math.pow(2,qe.z)*Le.wrap)*Oe,je=qe.y*Oe;return bl.mat4.translate(He,He,[Fe,je,0]),bl.mat4.scale(He,He,[Oe/np,Oe/np,1]),He}upVector(F,Me,Le){return[0,0,1]}upVectorScale(F,Me,Le){return{metersToTile:1}}}class em extends tm{constructor(F){super(F),this.range=[4,7],this.center=F.center||[-96,37.5];const[Me,Le]=this.parallels=F.parallels||[29.5,45.5],Oe=Math.sin(H(Me));this.n=(Oe+Math.sin(H(Le)))/2,this.c=1+Oe*(2*this.n-Oe),this.r0=Math.sqrt(this.c)/this.n}project(F,Me){const{n:Le,c:Oe,r0:Fe}=this,je=H(F-this.center[0]),qe=H(Me),He=Math.sqrt(Oe-2*Le*Math.sin(qe))/Le;return{x:He*Math.sin(je*Le),y:He*Math.cos(je*Le)-Fe,z:0}}unproject(F,Me){const{n:Le,c:Oe,r0:Fe}=this,je=Fe+Me;let qe=Math.atan2(F,Math.abs(je))*Math.sign(je);je*Le<0&&(qe-=Math.PI*Math.sign(F)*Math.sign(je));const He=H(this.center[0])*Le;qe=et(qe,-Math.PI-He,Math.PI-He);const xt=Q(X(qe/Le)+this.center[0],-180,180),Pt=Math.asin(Q((Oe-(F*F+je*je)*Le*Le)/(2*Le),-1,1)),jt=Q(X(Pt),-Jm,Jm);return new ul(xt,jt)}}const iv=1.340264,ov=-.081106,sv=893e-6,av=.003796,lv=Math.sqrt(3)/2;class om extends tm{project(F,Me){Me=Me/180*Math.PI,F=F/180*Math.PI;const Le=Math.asin(lv*Math.sin(Me)),Oe=Le*Le,Fe=Oe*Oe*Oe;return{x:.5*(F*Math.cos(Le)/(lv*(iv+3*ov*Oe+Fe*(7*sv+9*av*Oe)))/Math.PI+.5),y:1-.5*(Le*(iv+ov*Oe+Fe*(sv+av*Oe))/Math.PI+1),z:0}}unproject(F,Me){F=(2*F-.5)*Math.PI;let Le=Me=(2*(1-Me)-1)*Math.PI,Oe=Le*Le,Fe=Oe*Oe*Oe;for(let F,je,qe,He=0;He<12&&(je=Le*(iv+ov*Oe+Fe*(sv+av*Oe))-Me,qe=iv+3*ov*Oe+Fe*(7*sv+9*av*Oe),F=je/qe,Le=Q(Le-F,-Math.PI/3,Math.PI/3),Oe=Le*Le,Fe=Oe*Oe*Oe,!(Math.abs(F)<1e-12));++He);const je=lv*F*(iv+3*ov*Oe+Fe*(7*sv+9*av*Oe))/Math.cos(Le),qe=Math.asin(Math.sin(Le)/lv),He=Q(180*je/Math.PI,-180,180),xt=Q(180*qe/Math.PI,-Jm,Jm);return new ul(He,xt)}}class lm extends tm{constructor(F){super(F),this.wrap=!0,this.supportsWorldCopies=!0}project(F,Me){return{x:.5+F/360,y:.5-Me/360,z:0}}unproject(F,Me){const Le=360*(F-.5),Oe=Q(360*(.5-Me),-Jm,Jm);return new ul(Le,Oe)}}const uv=Math.PI/2;function cm(F){return Math.tan((uv+F)/2)}class hm extends tm{constructor(F){super(F),this.center=F.center||[0,30];const[Me,Le]=this.parallels=F.parallels||[30,30];let Oe=H(Me),Fe=H(Le);this.southernCenter=Oe+Fe<0,this.southernCenter&&(Oe=-Oe,Fe=-Fe);const je=Math.cos(Oe),qe=cm(Oe);this.n=Oe===Fe?Math.sin(Oe):Math.log(je/Math.cos(Fe))/Math.log(cm(Fe)/qe),this.f=je*Math.pow(cm(Oe),this.n)/this.n}project(F,Me){Me=H(Me),this.southernCenter&&(Me=-Me),F=H(F-this.center[0]);const Le=1e-6,{n:Oe,f:Fe}=this;Fe>0?Me<-uv+Le&&(Me=-uv+Le):Me>uv-Le&&(Me=uv-Le);const je=Fe/Math.pow(cm(Me),Oe);let qe=je*Math.sin(Oe*F),He=Fe-je*Math.cos(Oe*F);return qe=.5*(qe/Math.PI+.5),He=.5*(He/Math.PI+.5),{x:qe,y:this.southernCenter?He:1-He,z:0}}unproject(F,Me){F=(2*F-.5)*Math.PI,this.southernCenter&&(Me=1-Me),Me=(2*(1-Me)-.5)*Math.PI;const{n:Le,f:Oe}=this,Fe=Oe-Me,je=Math.sign(Fe),qe=Math.sign(Le)*Math.sqrt(F*F+Fe*Fe);let He=Math.atan2(F,Math.abs(Fe))*je;Fe*Le<0&&(He-=Math.PI*Math.sign(F)*je);const xt=Q(X(He/Le)+this.center[0],-180,180),Pt=Q(X(2*Math.atan(Math.pow(Oe/qe,1/Le))-uv),-Jm,Jm);return new ul(xt,this.southernCenter?-Pt:Pt)}}class pm extends tm{constructor(F){super(F),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(F,Me){return{x:dl(F),y:ml(Me),z:0}}unproject(F,Me){const Le=gl(F),Oe=xl(Me);return new ul(Le,Oe)}}const dv=H(Jm);class dm extends tm{project(F,Me){const Le=(Me=H(Me))*Me,Oe=Le*Le;return{x:.5*((F=H(F))*(.8707-.131979*Le+Oe*(Oe*(.003971*Le-.001529*Oe)-.013791))/Math.PI+.5),y:1-.5*(Me*(1.007226+Le*(.015085+Oe*(.028874*Le-.044475-.005916*Oe)))/Math.PI+1),z:0}}unproject(F,Me){F=(2*F-.5)*Math.PI;let Le=Me=(2*(1-Me)-1)*Math.PI,Oe=25,Fe=0,je=Le*Le;do{je=Le*Le;const F=je*je;Fe=(Le*(1.007226+je*(.015085+F*(.028874*je-.044475-.005916*F)))-Me)/(1.007226+je*(.045255+F*(.259866*je-.311325-.005916*11*F))),Le=Q(Le-Fe,-dv,dv)}while(Math.abs(Fe)>1e-6&&--Oe>0);je=Le*Le;const qe=Q(X(F/(.8707+je*(je*(je*je*je*(.003971-.001529*je)-.013791)-.131979))),-180,180),He=X(Le);return new ul(qe,He)}}const pv=H(Jm);class ym extends tm{project(F,Me){Me=H(Me),F=H(F);const Le=Math.cos(Me),Oe=2/Math.PI,Fe=Math.acos(Le*Math.cos(F/2)),je=Math.sin(Fe)/Fe,qe=.5*(F*Oe+2*Le*Math.sin(F/2)/je)||0,He=.5*(Me+Math.sin(Me)/je)||0;return{x:.5*(qe/Math.PI+.5),y:1-.5*(He/Math.PI+1),z:0}}unproject(F,Me){let Le=F=(2*F-.5)*Math.PI,Oe=Me=(2*(1-Me)-1)*Math.PI,Fe=25;const je=1e-6;let qe=0,He=0;do{const Fe=Math.cos(Oe),je=Math.sin(Oe),xt=2*je*Fe,Pt=je*je,jt=Fe*Fe,Gt=Math.cos(Le/2),bi=Math.sin(Le/2),wi=2*Gt*bi,qr=bi*bi,Xn=1-jt*Gt*Gt,Yn=Xn?1/Xn:0,yo=Xn?Math.acos(Fe*Gt)*Math.sqrt(1/Xn):0,bo=.5*(2*yo*Fe*bi+2*Le/Math.PI)-F,Ro=.5*(yo*je+Oe)-Me,Do=.5*Yn*(jt*qr+yo*Fe*Gt*Pt)+1/Math.PI,zs=Yn*(wi*xt/4-yo*je*bi),Zs=.125*Yn*(xt*bi-yo*je*jt*wi),na=.5*Yn*(Pt*Gt+yo*qr*Fe)+.5,el=zs*Zs-na*Do;qe=(Ro*zs-bo*na)/el,He=(bo*Zs-Ro*Do)/el,Le=Q(Le-qe,-Math.PI,Math.PI),Oe=Q(Oe-He,-pv,pv)}while((Math.abs(qe)>je||Math.abs(He)>je)&&--Fe>0);return new ul(X(Le),X(Oe))}}class gm extends tm{constructor(F){super(F),this.center=F.center||[0,0],this.parallels=F.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(H(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(F,Me){const{scale:Le,cosPhi:Oe}=this;return{x:H(F)*Oe*Le+.5,y:-Math.sin(H(Me))/Oe*Le+.5,z:0}}unproject(F,Me){const{scale:Le,cosPhi:Oe}=this,Fe=-(Me-.5)/Le,je=Q(X((F-.5)/Le)/Oe,-180,180),qe=Math.asin(Q(Fe*Oe,-1,1)),He=Q(X(qe),-Jm,Jm);return new ul(je,He)}}class xm extends pm{constructor(F){super(F),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(F,Me,Le){const Oe=Ru(F,Me,Le),Fe=Ou(ku(Le));return bl.vec3.transformMat4(Oe,Oe,Fe),{x:Oe[0],y:Oe[1],z:Oe[2]}}locationPoint(F,Me,Le){const Oe=al(Me.lat,Me.lng),Fe=bl.vec3.normalize([],Oe),je=Le?F._centerAltitude+Le:F.elevation?F.elevation.getAtPointOrZero(F.locationCoordinate(Me),F._centerAltitude):F._centerAltitude,qe=yl(1,0)*np*je;bl.vec3.scaleAndAdd(Oe,Oe,Fe,qe);const He=bl.mat4.identity(new Float64Array(16));return bl.mat4.multiply(He,F.pixelMatrix,F.globeMatrix),bl.vec3.transformMat4(Oe,Oe,He),new ec(Oe[0],Oe[1])}pixelsPerMeter(F,Me){return yl(1,0)*Me}pixelSpaceConversion(F,Me,Le){const Oe=yl(1,F)*Me,Fe=Ee(yl(1,45)*Me,Oe,Le);return this.pixelsPerMeter(F,Me)/Fe}createTileMatrix(F,Me,Le){const Oe=Nu(ku(Le.canonical));return bl.mat4.multiply(new Float64Array(16),F.globeMatrix,Oe)}createInversionMatrix(F,Me){const{center:Le}=F,Oe=Ou(ku(Me));return bl.mat4.rotateY(Oe,Oe,H(Le.lng)),bl.mat4.rotateX(Oe,Oe,H(Le.lat)),bl.mat4.scale(Oe,Oe,[F._pixelsPerMercatorPixel,F._pixelsPerMercatorPixel,1]),Float32Array.from(Oe)}pointCoordinate(F,Me,Le,Oe){return Pu(F,Me,Le,!0)||new Il(0,0)}pointCoordinate3D(F,Me,Le){const Oe=this.pointCoordinate(F,Me,Le,0);return[Oe.x,Oe.y,Oe.z]}isPointAboveHorizon(F,Me){return!Pu(F,Me.x,Me.y,!1)}farthestPixelDistance(F){const Me=function(F,Me){const Le=F.cameraToCenterDistance,Oe=F._centerAltitude*Me,Fe=F._camera,je=F._camera.forward(),qe=bl.vec3.add([],bl.vec3.scale([],je,-Le),[0,0,Oe]),He=F.worldSize/(2*Math.PI),xt=[0,0,-He],Pt=F.width/F.height,jt=Math.tan(F.fovAboveCenter),Gt=bl.vec3.scale([],Fe.up(),jt),bi=bl.vec3.scale([],Fe.right(),jt*Pt),wi=bl.vec3.normalize([],bl.vec3.add([],bl.vec3.add([],je,Gt),bi)),qr=[];let Xn;if(new gu(qe,wi).closestPointOnSphere(xt,He,qr)){const Me=bl.vec3.add([],qr,xt),Le=bl.vec3.sub([],Me,qe);Xn=Math.cos(F.fovAboveCenter)*bl.vec3.length(Le)}else{const F=bl.vec3.sub([],qe,xt),Me=bl.vec3.sub([],xt,qe);bl.vec3.normalize(Me,Me);const Le=bl.vec3.length(F)-He;Xn=Math.sqrt(Le*(Le+2*He));const Oe=Math.acos(Xn/(He+Le))-Math.acos(bl.vec3.dot(je,Me));Xn*=Math.cos(Oe)}return 1.01*Xn}(F,this.pixelsPerMeter(F.center.lat,F.worldSize)),Le=$u(F.zoom);if(Le>0){const Oe=Wd(F,yl(1,F.center.lat)*F.worldSize),Fe=F.worldSize/(2*Math.PI),je=Math.max(F.width,F.height)/F.worldSize*Math.PI;return Ee(Me,Oe+Fe*(1-Math.cos(je)),Math.pow(Le,10))}return Me}upVector(F,Me,Le){return Ru(Me,Le,F,1)}upVectorScale(F){return{metersToTile:Iu(Lu(ku(F)))}}}function vm(F){const Me=F.parallels,Le=!!Me&&Math.abs(Me[0]+Me[1])<.01;switch(F.name){case"mercator":return new pm(F);case"equirectangular":return new lm(F);case"naturalEarth":return new dm(F);case"equalEarth":return new om(F);case"winkelTripel":return new ym(F);case"albers":return Le?new gm(F):new em(F);case"lambertConformalConic":return Le?new gm(F):new hm(F);case"globe":return new xm(F)}throw new Error(`Invalid projection name: ${F.name}`)}const fv=O_.VectorTileFeature.types,_v=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function wm(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi){const wi=He?Math.min(Qx,Math.round(He[0])):0,qr=He?Math.min(Qx,Math.round(He[1])):0;F.emplaceBack(Me,Le,Math.round(32*Oe),Math.round(32*Fe),je,qe,(wi<<1)+(xt?1:0),qr,16*Pt,16*jt,256*Gt,256*bi)}function Mm(F,Me,Le){F.emplaceBack(Me,Le)}function Am(F,Me,Le,Oe,Fe,je,qe){F.emplaceBack(Me,Le,Oe,Fe,je,qe)}function Im(F,Me,Le,Oe,Fe){F.emplaceBack(Me,Le,Oe,Fe),F.emplaceBack(Me,Le,Oe,Fe),F.emplaceBack(Me,Le,Oe,Fe),F.emplaceBack(Me,Le,Oe,Fe)}function Sm(F){for(const Me of F.sections)if(Ms(Me.text))return!0;return!1}class Pm{constructor(F){this.layoutVertexArray=new Va,this.indexArray=new ja,this.programConfigurations=F,this.segments=new xo,this.dynamicLayoutVertexArray=new Da,this.opacityVertexArray=new Ra,this.placedSymbolArray=new so,this.iconTransitioningVertexArray=new La,this.globeExtVertexArray=new Ca,this.zOffsetVertexArray=new Aa}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(F,Me,Le,Oe,Fe){this.isEmpty()||(Le&&(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,Ey.members),this.indexBuffer=F.createIndexBuffer(this.indexArray,Me),this.dynamicLayoutVertexBuffer=F.createVertexBuffer(this.dynamicLayoutVertexArray,Oy.members,!0),this.opacityVertexBuffer=F.createVertexBuffer(this.opacityVertexArray,_v,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=F.createVertexBuffer(this.iconTransitioningVertexArray,Ny.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=F.createVertexBuffer(this.globeExtVertexArray,zy.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||Fe)&&(this.zOffsetVertexBuffer=F.createVertexBuffer(this.zOffsetVertexArray,ky.members,!0)),this.opacityVertexBuffer.itemSize=1),(Le||Oe)&&this.programConfigurations.upload(F))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}us(Pm,"SymbolBuffers");class Em{constructor(F,Me,Le){this.layoutVertexArray=new F,this.layoutAttributes=Me,this.indexArray=new Le,this.segments=new xo,this.collisionVertexArray=new Ua,this.collisionVertexArrayExt=new Da}upload(F){this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=F.createVertexBuffer(this.collisionVertexArray,qy.members,!0),this.collisionVertexBufferExt=F.createVertexBuffer(this.collisionVertexArrayExt,Wy.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}us(Em,"CollisionBuffers");class zm{constructor(F){this.collisionBoxArray=F.collisionBoxArray,this.zoom=F.zoom,this.lut=F.lut,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.pixelRatio=F.pixelRatio,this.sourceLayerIndex=F.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=bl.mat4.identity([]),this.placementViewportMatrix=bl.mat4.identity([]);const Me=this.layers[0]._unevaluatedLayout._values;this.textSizeData=bf(this.zoom,Me["text-size"]),this.iconSizeData=bf(this.zoom,Me["icon-size"]);const Le=this.layers[0].layout,Oe=Le.get("symbol-sort-key"),Fe=Le.get("symbol-z-order");this.canOverlap=Le.get("text-allow-overlap")||Le.get("icon-allow-overlap")||Le.get("text-ignore-placement")||Le.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==Fe&&void 0!==Oe.constantOr(1),this.sortFeaturesByY=("viewport-y"===Fe||"auto"===Fe&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=Le.get("text-writing-mode").map((F=>Fx[F])),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.sourceID=F.sourceID,this.projection=F.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new Pm(new Go(this.layers,{zoom:this.zoom,lut:this.lut},(F=>F.startsWith("text")||F.startsWith("symbol")))),this.icon=new Pm(new Go(this.layers,{zoom:this.zoom,lut:this.lut},(F=>F.startsWith("icon")||F.startsWith("symbol")))),this.glyphOffsetArray=new lo,this.lineVertexArray=new uo,this.symbolInstances=new oo}calculateGlyphDependencies(F,Me,Le,Oe,Fe){for(const Le of F){const F=Le.codePointAt(0);if(void 0===F)break;if(Me[F]=!0,Oe&&Fe&&F<=65535){const F=Ax[Le];F&&(Me[F.charCodeAt(0)]=!0)}}}updateFootprints(F,Me){}updateReplacement(F,Me){if(Me.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=Me.updateTime;const Le=Me.getReplacementRegionsForTile(F.toUnwrapped(),!0);return!Yh(this.activeReplacements,Le)&&(this.activeReplacements=Le,!0)}populate(F,Me,Le,Oe){const Fe=this.layers[0],je=Fe.layout,qe="globe"===this.projection.name,He=je.get("text-font"),xt=je.get("text-field"),Pt=je.get("icon-image"),[jt,Gt]=je.get("icon-size-scale-range"),bi=Q(Me.scaleFactor||1,jt,Gt),wi=("constant"!==xt.value.kind||xt.value.value instanceof Qe&&!xt.value.value.isEmpty()||xt.value.value.toString().length>0)&&("constant"!==He.value.kind||He.value.value.length>0),qr="constant"!==Pt.value.kind||!!Pt.value.value||Object.keys(Pt.parameters).length>0,Xn=je.get("symbol-sort-key");if(this.features=[],!wi&&!qr)return;const Yn=Me.iconDependencies,yo=Me.glyphDependencies,bo=Me.availableImages,Ro=new Rs(this.zoom);for(const{feature:Me,id:xt,index:Pt,sourceLayerIndex:jt}of F){const F=Fe._featureFilter.needGeometry,Gt=Cl(Me,F);if(!Fe._featureFilter.filter(Ro,Gt,Le))continue;if(F||(Gt.geometry=Vl(Me,Le,Oe)),qe&&1!==Me.type&&Le.z<=5){const F=Gt.geometry,Me=.98078528056,n=(F,Oe)=>{const Fe=Ru(F.x,F.y,Le,1),je=Ru(Oe.x,Oe.y,Le,1);return bl.vec3.dot(Fe,je)<Me};for(let Me=0;Me<F.length;Me++)F[Me]=zl(F[Me],n)}let Do,zs;if(wi){const F=Fe.getValueAndResolveTokens("text-field",Gt,Le,bo),Me=Qe.factory(F);Sm(Me)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Vs()||this.hasRTLText&&If.isParsed())&&(Do=Af(Me,Fe,Gt))}if(qr){const F=Fe.getValueAndResolveTokens("icon-image",Gt,Le,bo);zs=F instanceof er?F:er.build(F)}if(!Do&&!zs)continue;const Zs=this.sortFeaturesByKey?Xn.evaluate(Gt,{},Le):void 0,na={id:xt,text:Do,icon:zs,index:Pt,sourceLayerIndex:jt,geometry:Gt.geometry,properties:Me.properties,type:fv[Me.type],sortKey:Zs};if(this.features.push(na),zs){const F=this.layers[0]._unevaluatedLayout._values,{iconPrimary:Me,iconSecondary:Oe}=Rd(zs,this.iconSizeData,F["icon-size"],Le,this.zoom,na,this.pixelRatio,bi),Fe=Me.id.toString();if(Yn.has(Fe)?Yn.get(Fe).push(Me):Yn.set(Fe,[Me]),Oe){const F=Oe.id.toString();Yn.has(F)?Yn.get(F).push(Oe):Yn.set(F,[Oe])}}if(Do){const F=He.evaluate(Gt,{},Le).join(","),Me="map"===je.get("text-rotation-alignment")&&"point"!==je.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Fx.vertical)>=0;for(const Le of Do.sections)if(Le.image){const F=Le.image.getPrimary().scaleSelf(this.pixelRatio),Me=F.id.toString(),Oe=Yn.get(Me)||[];Oe.push(F),Yn.set(Me,Oe)}else{const Oe=ms(Do.toString()),Fe=Le.fontStack||F,je=yo[Fe]=yo[Fe]||{};this.calculateGlyphDependencies(Le.text,je,Me,this.allowVerticalPlacement,Oe)}}}if("line"===je.get("symbol-placement")&&(this.features=function(F){const Me={},Le={},Oe=[];let Fe=0;function s(Me){Oe.push(F[Me]),Fe++}function a(F,Me,Fe){const je=Le[F];return delete Le[F],Le[Me]=je,Oe[je].geometry[0].pop(),Oe[je].geometry[0]=Oe[je].geometry[0].concat(Fe[0]),je}function o(F,Le,Fe){const je=Me[Le];return delete Me[Le],Me[F]=je,Oe[je].geometry[0].shift(),Oe[je].geometry[0]=Fe[0].concat(Oe[je].geometry[0]),je}function l(F,Me,Le){const Oe=Le?Me[0][Me[0].length-1]:Me[0][0];return`${F}:${Oe.x}:${Oe.y}`}for(let je=0;je<F.length;je++){const qe=F[je],He=qe.geometry,xt=qe.text?qe.text.toString():null;if(!xt){s(je);continue}const Pt=l(xt,He),jt=l(xt,He,!0);if(Pt in Le&&jt in Me&&Le[Pt]!==Me[jt]){const F=o(Pt,jt,He),Fe=a(Pt,jt,Oe[F].geometry);delete Me[Pt],delete Le[jt],Le[l(xt,Oe[Fe].geometry,!0)]=Fe,Oe[F].geometry=null}else Pt in Le?a(Pt,jt,He):jt in Me?o(Pt,jt,He):(s(je),Me[Pt]=Fe-1,Le[jt]=Fe-1)}return Oe.filter((F=>F.geometry))}(this.features)),"hd-road-markup"===je.get("symbol-elevation-reference")){if(this.elevationType="road",Me.elevationFeatures){!this.elevationFeatures&&Me.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const F of Me.elevationFeatures)this.elevationFeatureIdToIndex.set(F.id,this.elevationFeatures.length),this.elevationFeatures.push(F)}}else je.get("symbol-z-elevate")&&(this.elevationType="offset");"none"!==this.elevationType&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort(((F,Me)=>F.sortKey-Me.sortKey))}update(F,Me,Le,Oe,Fe,je,qe){this.text.programConfigurations.updatePaintArrays(F,Me,Fe,Le,Oe,je,qe),this.icon.programConfigurations.updatePaintArrays(F,Me,Fe,Le,Oe,je,qe)}updateRoadElevation(){if("road"!==this.elevationType||!this.elevationFeatures)return;if(this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let F=!1;for(let Me=0;Me<this.symbolInstances.length;Me++){const Le=this.symbolInstances.get(Me);if(65535===Le.elevationFeatureIndex)continue;const Oe=this.elevationFeatures[Le.elevationFeatureIndex];if(Oe){const Me=.05+Oe.pointElevation(new ec(Le.tileAnchorX,Le.tileAnchorY));Le.zOffset!==Me&&(F=!0,Le.zOffset=Me)}}F&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const t=(Me,Le,Oe)=>{F+=Le,F>Me.length&&Me.resize(F);for(let Fe=-Le;Fe<0;Fe++)Me.emplace(Fe+F,Oe)},e=(F,Le,Oe)=>{Me+=Le,Me>F.length&&F.resize(Me);for(let Fe=-Le;Fe<0;Fe++)F.emplace(Fe+Me,Oe)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let F=0,Me=0;for(let F=0;F<this.symbolInstances.length;F++){const Me=this.symbolInstances.get(F),{numHorizontalGlyphVertices:Le,numVerticalGlyphVertices:Oe,numIconVertices:Fe}=Me,je=Me.zOffset,qe=Fe>0;if((Le>0||Oe>0)&&(t(this.text.zOffsetVertexArray,Le,je),t(this.text.zOffsetVertexArray,Oe,je)),qe){const{placedIconSymbolIndex:F,verticalPlacedIconSymbolIndex:Le}=Me;F>=0&&e(this.icon.zOffsetVertexArray,Fe,je),Le>=0&&e(this.icon.zOffsetVertexArray,Me.numVerticalIconVertices,je)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(F){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(F),this.iconCollisionBox.upload(F)),this.text.upload(F,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(F,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=vm(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(F,Me){const Le=this.lineVertexArray.length;if(void 0!==F.segment)for(const{x:F,y:Le}of Me)this.lineVertexArray.emplaceBack(F,Le);return{lineStartIndex:Le,lineLength:this.lineVertexArray.length-Le}}addSymbols(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn){const Yn=F.indexArray,yo=F.layoutVertexArray,bo=F.globeExtVertexArray,Ro=F.segments.prepareSegment(4*Me.length,yo,Yn,this.canOverlap?je.sortKey:void 0),Do=this.glyphOffsetArray.length,zs=Ro.vertexLength,Zs=this.allowVerticalPlacement&&qe===Fx.vertical?Math.PI/2:0,na=je.text&&je.text.sections;for(let Oe=0;Oe<Me.length;Oe++){const{tl:Fe,tr:qe,bl:Pt,br:jt,texPrimary:Gt,texSecondary:Do,pixelOffsetTL:zs,pixelOffsetBR:el,minFontScaleX:nl,minFontScaleY:hl,glyphOffset:pl,isSDF:bl,sectionIndex:Tl}=Me[Oe],kl=Ro.vertexLength,ec=pl[1];if(wm(yo,xt.x,xt.y,Fe.x,ec+Fe.y,Gt.x,Gt.y,Le,bl,zs.x,zs.y,nl,hl),wm(yo,xt.x,xt.y,qe.x,ec+qe.y,Gt.x+Gt.w,Gt.y,Le,bl,el.x,zs.y,nl,hl),wm(yo,xt.x,xt.y,Pt.x,ec+Pt.y,Gt.x,Gt.y+Gt.h,Le,bl,zs.x,el.y,nl,hl),wm(yo,xt.x,xt.y,jt.x,ec+jt.y,Gt.x+Gt.w,Gt.y+Gt.h,Le,bl,el.x,el.y,nl,hl),He){const{x:Me,y:Le,z:Oe}=He.anchor,[Fe,je,qe]=He.up;Am(bo,Me,Le,Oe,Fe,je,qe),Am(bo,Me,Le,Oe,Fe,je,qe),Am(bo,Me,Le,Oe,Fe,je,qe),Am(bo,Me,Le,Oe,Fe,je,qe),Im(F.dynamicLayoutVertexArray,Me,Le,Oe,Zs)}else Im(F.dynamicLayoutVertexArray,xt.x,xt.y,xt.z,Zs);if(Xn){const Me=Do||Gt;Mm(F.iconTransitioningVertexArray,Me.x,Me.y),Mm(F.iconTransitioningVertexArray,Me.x+Me.w,Me.y),Mm(F.iconTransitioningVertexArray,Me.x,Me.y+Me.h),Mm(F.iconTransitioningVertexArray,Me.x+Me.w,Me.y+Me.h)}Yn.emplaceBack(kl,kl+1,kl+2),Yn.emplaceBack(kl+1,kl+2,kl+3),Ro.vertexLength+=4,Ro.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(pl[0]),Oe!==Me.length-1&&Tl===Me[Oe+1].sectionIndex||F.programConfigurations.populatePaintArrays(yo.length,je,je.index,{},bi,wi,qr,na&&na[Tl])}const el=He?He.anchor:xt;F.placedSymbolArray.emplaceBack(el.x,el.y,el.z,xt.x,xt.y,Do,this.glyphOffsetArray.length-Do,zs,Pt,jt,xt.segment,Le?Le[0]:0,Le?Le[1]:0,Oe[0],Oe[1],qe,0,!1,0,Gt,0)}_commitLayoutVertex(F,Me,Le,Oe,Fe,je,qe){F.emplaceBack(Me,Le,Oe,Fe,je,Math.round(qe.x),Math.round(qe.y))}_addCollisionDebugVertices(F,Me,Le,Oe,Fe,je,qe){const He=Le.segments.prepareSegment(4,Le.layoutVertexArray,Le.indexArray),xt=He.vertexLength,Pt=qe.tileAnchorX,jt=qe.tileAnchorY;for(let F=0;F<4;F++)Le.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(Le.collisionVertexArrayExt,Me,F.padding,qe.zOffset),this._commitLayoutVertex(Le.layoutVertexArray,Oe,Fe,je,Pt,jt,new ec(F.x1,F.y1)),this._commitLayoutVertex(Le.layoutVertexArray,Oe,Fe,je,Pt,jt,new ec(F.x2,F.y1)),this._commitLayoutVertex(Le.layoutVertexArray,Oe,Fe,je,Pt,jt,new ec(F.x2,F.y2)),this._commitLayoutVertex(Le.layoutVertexArray,Oe,Fe,je,Pt,jt,new ec(F.x1,F.y2)),He.vertexLength+=4;const Gt=Le.indexArray;Gt.emplaceBack(xt,xt+1),Gt.emplaceBack(xt+1,xt+2),Gt.emplaceBack(xt+2,xt+3),Gt.emplaceBack(xt+3,xt),He.primitiveLength+=4}_addTextDebugCollisionBoxes(F,Me,Le,Oe,Fe,je){for(let qe=Oe;qe<Fe;qe++){const Oe=Le.get(qe),Fe=this.getSymbolInstanceTextSize(F,je,Me,qe);this._addCollisionDebugVertices(Oe,Fe,this.textCollisionBox,Oe.projectedAnchorX,Oe.projectedAnchorY,Oe.projectedAnchorZ,je)}}_addIconDebugCollisionBoxes(F,Me,Le,Oe,Fe,je){for(let qe=Oe;qe<Fe;qe++){const Oe=Le.get(qe),Fe=this.getSymbolInstanceIconSize(F,Me,je.placedIconSymbolIndex);this._addCollisionDebugVertices(Oe,Fe,this.iconCollisionBox,Oe.projectedAnchorX,Oe.projectedAnchorY,Oe.projectedAnchorZ,je)}}generateCollisionDebugBuffers(F,Me,Le){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Em(Oa,lx.members,La),this.iconCollisionBox=new Em(Oa,lx.members,La);const Oe=wf(this.iconSizeData,F),Fe=wf(this.textSizeData,F,Le);for(let Le=0;Le<this.symbolInstances.length;Le++){const je=this.symbolInstances.get(Le);this._addTextDebugCollisionBoxes(Fe,F,Me,je.textBoxStartIndex,je.textBoxEndIndex,je),this._addTextDebugCollisionBoxes(Fe,F,Me,je.verticalTextBoxStartIndex,je.verticalTextBoxEndIndex,je),this._addIconDebugCollisionBoxes(Oe,F,Me,je.iconBoxStartIndex,je.iconBoxEndIndex,je),this._addIconDebugCollisionBoxes(Oe,F,Me,je.verticalIconBoxStartIndex,je.verticalIconBoxEndIndex,je)}}getSymbolInstanceTextSize(F,Me,Le,Oe){const Fe=this.text.placedSymbolArray.get(Me.rightJustifiedTextSymbolIndex>=0?Me.rightJustifiedTextSymbolIndex:Me.centerJustifiedTextSymbolIndex>=0?Me.centerJustifiedTextSymbolIndex:Me.leftJustifiedTextSymbolIndex>=0?Me.leftJustifiedTextSymbolIndex:Me.verticalPlacedTextSymbolIndex>=0?Me.verticalPlacedTextSymbolIndex:Oe),je=_f(this.textSizeData,F,Fe)/Sx;return this.tilePixelRatio*je}getSymbolInstanceIconSize(F,Me,Le){const Oe=this.icon.placedSymbolArray.get(Le),Fe=_f(this.iconSizeData,F,Oe);return this.tilePixelRatio*Fe}_commitDebugCollisionVertexUpdate(F,Me,Le,Oe){F.emplaceBack(Me,-Le,-Le,Oe),F.emplaceBack(Me,Le,-Le,Oe),F.emplaceBack(Me,Le,Le,Oe),F.emplaceBack(Me,-Le,Le,Oe)}_updateTextDebugCollisionBoxes(F,Me,Le,Oe,Fe,je,qe){for(let qe=Oe;qe<Fe;qe++){const Oe=Le.get(qe),Fe=this.getSymbolInstanceTextSize(F,je,Me,qe);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,Fe,Oe.padding,je.zOffset)}}_updateIconDebugCollisionBoxes(F,Me,Le,Oe,Fe,je,qe){for(let qe=Oe;qe<Fe;qe++){const Oe=Le.get(qe),Fe=this.getSymbolInstanceIconSize(F,Me,je.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,Fe,Oe.padding,je.zOffset)}}updateCollisionDebugBuffers(F,Me,Le,Oe){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const Fe=wf(this.iconSizeData,F,Oe),je=wf(this.textSizeData,F,Le);for(let qe=0;qe<this.symbolInstances.length;qe++){const He=this.symbolInstances.get(qe);this._updateTextDebugCollisionBoxes(je,F,Me,He.textBoxStartIndex,He.textBoxEndIndex,He,Le),this._updateTextDebugCollisionBoxes(je,F,Me,He.verticalTextBoxStartIndex,He.verticalTextBoxEndIndex,He,Le),this._updateIconDebugCollisionBoxes(Fe,F,Me,He.iconBoxStartIndex,He.iconBoxEndIndex,He,Oe),this._updateIconDebugCollisionBoxes(Fe,F,Me,He.verticalIconBoxStartIndex,He.verticalIconBoxEndIndex,He,Oe)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt={};if(Me<Le){const{x1:Le,y1:Oe,x2:Fe,y2:je,padding:qe,projectedAnchorX:He,projectedAnchorY:xt,projectedAnchorZ:jt,tileAnchorX:Gt,tileAnchorY:bi,featureIndex:wi}=F.get(Me);Pt.textBox={x1:Le,y1:Oe,x2:Fe,y2:je,padding:qe,projectedAnchorX:He,projectedAnchorY:xt,projectedAnchorZ:jt,tileAnchorX:Gt,tileAnchorY:bi},Pt.textFeatureIndex=wi}if(Oe<Fe){const{x1:Me,y1:Le,x2:Fe,y2:je,padding:qe,projectedAnchorX:He,projectedAnchorY:xt,projectedAnchorZ:jt,tileAnchorX:Gt,tileAnchorY:bi,featureIndex:wi}=F.get(Oe);Pt.verticalTextBox={x1:Me,y1:Le,x2:Fe,y2:je,padding:qe,projectedAnchorX:He,projectedAnchorY:xt,projectedAnchorZ:jt,tileAnchorX:Gt,tileAnchorY:bi},Pt.verticalTextFeatureIndex=wi}if(je<qe){const{x1:Me,y1:Le,x2:Oe,y2:Fe,padding:qe,projectedAnchorX:He,projectedAnchorY:xt,projectedAnchorZ:jt,tileAnchorX:Gt,tileAnchorY:bi,featureIndex:wi}=F.get(je);Pt.iconBox={x1:Me,y1:Le,x2:Oe,y2:Fe,padding:qe,projectedAnchorX:He,projectedAnchorY:xt,projectedAnchorZ:jt,tileAnchorX:Gt,tileAnchorY:bi},Pt.iconFeatureIndex=wi}if(He<xt){const{x1:Me,y1:Le,x2:Oe,y2:Fe,padding:je,projectedAnchorX:qe,projectedAnchorY:xt,projectedAnchorZ:jt,tileAnchorX:Gt,tileAnchorY:bi,featureIndex:wi}=F.get(He);Pt.verticalIconBox={x1:Me,y1:Le,x2:Oe,y2:Fe,padding:je,projectedAnchorX:qe,projectedAnchorY:xt,projectedAnchorZ:jt,tileAnchorX:Gt,tileAnchorY:bi},Pt.verticalIconFeatureIndex=wi}return Pt}deserializeCollisionBoxes(F){this.collisionArrays=[];for(let Me=0;Me<this.symbolInstances.length;Me++){const Le=this.symbolInstances.get(Me);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(F,Le.textBoxStartIndex,Le.textBoxEndIndex,Le.verticalTextBoxStartIndex,Le.verticalTextBoxEndIndex,Le.iconBoxStartIndex,Le.iconBoxEndIndex,Le.verticalIconBoxStartIndex,Le.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(F,Me){const Le=F.placedSymbolArray.get(Me),Oe=Le.vertexStartIndex+4*Le.numGlyphs;for(let Me=Le.vertexStartIndex;Me<Oe;Me+=4)F.indexArray.emplaceBack(Me,Me+1,Me+2),F.indexArray.emplaceBack(Me+1,Me+2,Me+3)}getSortedSymbolIndexes(F){if(this.sortedAngle===F&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const Me=Math.sin(F),Le=Math.cos(F),Oe=[],Fe=[],je=[];for(let F=0;F<this.symbolInstances.length;++F){je.push(F);const qe=this.symbolInstances.get(F);Oe.push(0|Math.round(Me*qe.tileAnchorX+Le*qe.tileAnchorY)),Fe.push(qe.featureIndex)}return je.sort(((F,Me)=>Oe[F]-Oe[Me]||Fe[Me]-Fe[F])),je}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let F=0;F<this.symbolInstances.length;++F)this.symbolInstanceIndexesSortedZOffset.push(F)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((F,Me)=>this.symbolInstances.get(Me).zOffset-this.symbolInstances.get(F).zOffset))}addToSortKeyRanges(F,Me){const Le=this.sortKeyRanges[this.sortKeyRanges.length-1];Le&&Le.sortKey===Me?Le.symbolInstanceEnd=F+1:this.sortKeyRanges.push({sortKey:Me,symbolInstanceStart:F,symbolInstanceEnd:F+1})}sortFeatures(F){if(this.sortFeaturesByY&&this.sortedAngle!==F&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(F),this.sortedAngle=F,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const F of this.symbolInstanceIndexes){const Me=this.symbolInstances.get(F);this.featureSortOrder.push(Me.featureIndex);const{rightJustifiedTextSymbolIndex:Le,centerJustifiedTextSymbolIndex:Oe,leftJustifiedTextSymbolIndex:Fe,verticalPlacedTextSymbolIndex:je,placedIconSymbolIndex:qe,verticalPlacedIconSymbolIndex:He}=Me;Le>=0&&this.addIndicesForPlacedSymbol(this.text,Le),Oe>=0&&Oe!==Le&&this.addIndicesForPlacedSymbol(this.text,Oe),Fe>=0&&Fe!==Oe&&Fe!==Le&&this.addIndicesForPlacedSymbol(this.text,Fe),je>=0&&this.addIndicesForPlacedSymbol(this.text,je),qe>=0&&this.addIndicesForPlacedSymbol(this.icon,qe),He>=0&&this.addIndicesForPlacedSymbol(this.icon,He)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let yv,xv,bv;us(zm,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),zm.addDynamicAttributes=Im;class Vm{constructor(F){this.type=F.property.overrides?F.property.overrides.runtimeType:Su,this.defaultValue=F}evaluate(F){if(F.formattedSection){const Me=this.defaultValue.property.overrides;if(Me&&Me.hasOverride(F.formattedSection))return Me.getOverride(F.formattedSection)}return F.feature&&F.featureState?this.defaultValue.evaluate(F.feature,F.featureState):this.defaultValue.property.specification.default}eachChild(F){this.defaultValue.isConstant()||F(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}us(Vm,"FormatSectionOverride",{omit:["defaultValue"]});const Cm=()=>bv||(bv={layout:yv||(yv=new Xs({"symbol-placement":new Gs(Cf.layout_symbol["symbol-placement"]),"symbol-spacing":new Gs(Cf.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Gs(Cf.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ys(Cf.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Gs(Cf.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Gs(Cf.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Gs(Cf.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Gs(Cf.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Gs(Cf.layout_symbol["icon-ignore-placement"]),"icon-optional":new Gs(Cf.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Gs(Cf.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ys(Cf.layout_symbol["icon-size"]),"icon-size-scale-range":new Gs(Cf.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Ys(Cf.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ys(Cf.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ys(Cf.layout_symbol["icon-image"]),"icon-rotate":new Ys(Cf.layout_symbol["icon-rotate"]),"icon-padding":new Gs(Cf.layout_symbol["icon-padding"]),"icon-keep-upright":new Gs(Cf.layout_symbol["icon-keep-upright"]),"icon-offset":new Ys(Cf.layout_symbol["icon-offset"]),"icon-anchor":new Ys(Cf.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Gs(Cf.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Gs(Cf.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Gs(Cf.layout_symbol["text-rotation-alignment"]),"text-field":new Ys(Cf.layout_symbol["text-field"]),"text-font":new Ys(Cf.layout_symbol["text-font"]),"text-size":new Ys(Cf.layout_symbol["text-size"]),"text-size-scale-range":new Gs(Cf.layout_symbol["text-size-scale-range"]),"text-max-width":new Ys(Cf.layout_symbol["text-max-width"]),"text-line-height":new Ys(Cf.layout_symbol["text-line-height"]),"text-letter-spacing":new Ys(Cf.layout_symbol["text-letter-spacing"]),"text-justify":new Ys(Cf.layout_symbol["text-justify"]),"text-radial-offset":new Ys(Cf.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Gs(Cf.layout_symbol["text-variable-anchor"]),"text-anchor":new Ys(Cf.layout_symbol["text-anchor"]),"text-max-angle":new Gs(Cf.layout_symbol["text-max-angle"]),"text-writing-mode":new Gs(Cf.layout_symbol["text-writing-mode"]),"text-rotate":new Ys(Cf.layout_symbol["text-rotate"]),"text-padding":new Gs(Cf.layout_symbol["text-padding"]),"text-keep-upright":new Gs(Cf.layout_symbol["text-keep-upright"]),"text-transform":new Ys(Cf.layout_symbol["text-transform"]),"text-offset":new Ys(Cf.layout_symbol["text-offset"]),"text-allow-overlap":new Gs(Cf.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Gs(Cf.layout_symbol["text-ignore-placement"]),"text-optional":new Gs(Cf.layout_symbol["text-optional"]),visibility:new Gs(Cf.layout_symbol.visibility)})),paint:xv||(xv=new Xs({"icon-opacity":new Ys(Cf.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Ys(Cf.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Ys(Cf.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Ys(Cf.paint_symbol["text-emissive-strength"]),"icon-color":new Ys(Cf.paint_symbol["icon-color"]),"icon-halo-color":new Ys(Cf.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ys(Cf.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ys(Cf.paint_symbol["icon-halo-blur"]),"icon-translate":new Gs(Cf.paint_symbol["icon-translate"]),"icon-translate-anchor":new Gs(Cf.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ys(Cf.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Ys(Cf.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Ys(Cf.paint_symbol["text-occlusion-opacity"]),"text-color":new Ys(Cf.paint_symbol["text-color"],{runtimeType:Wu,getOverride:F=>F.textColor,hasOverride:F=>!!F.textColor}),"text-halo-color":new Ys(Cf.paint_symbol["text-halo-color"]),"text-halo-width":new Ys(Cf.paint_symbol["text-halo-width"]),"text-halo-blur":new Ys(Cf.paint_symbol["text-halo-blur"]),"text-translate":new Gs(Cf.paint_symbol["text-translate"]),"text-translate-anchor":new Gs(Cf.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Gs(Cf.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Gs(Cf.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Gs(Cf.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Gs(Cf.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Ys(Cf.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},bv);class Dm extends ma{constructor(F,Me,Le,Oe){super(F,Cm(),Me,Le,Oe),this._colorAdjustmentMatrix=bl.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=void 0!==F.paint&&("icon-occlusion-opacity"in F.paint||"text-occlusion-opacity"in F.paint)}recalculate(F,Me){super.recalculate(F,Me),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const Le=this.layout.get("text-writing-mode");if(Le){const F=[];for(const Me of Le)F.indexOf(Me)<0&&F.push(Me);this.layout._values["text-writing-mode"]=F}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(F,Me,Le,Oe){return this._saturation===F&&this._contrast===Me&&this._brightnessMin===Le&&this._brightnessMax===Oe||(this._colorAdjustmentMatrix=function(F,Me,Le,Oe){F=Mt(F),Me=wt(Me);const Fe=bl.mat4.create(),je=F/3,qe=1-2*je,He=[qe,je,je,0,je,qe,je,0,je,je,qe,0,0,0,0,1],xt=.5-.5*Me,Pt=Oe-Le;return bl.mat4.multiply(Fe,[Pt,0,0,0,0,Pt,0,0,0,0,Pt,0,Le,Le,Le,1],[Me,0,0,0,0,Me,0,0,0,0,Me,0,xt,xt,xt,1]),bl.mat4.multiply(Fe,Fe,He),Fe}(F,Me,Le,Oe),this._saturation=F,this._contrast=Me,this._brightnessMin=Le,this._brightnessMax=Oe),this._colorAdjustmentMatrix}getValueAndResolveTokens(F,Me,Le,Oe){const Fe=this.layout.get(F).evaluate(Me,{},Le,Oe),je=this._unevaluatedLayout._values[F];return je.isDataDriven()||Ki(je.value)||!Fe?Fe:function(F,Me){return Me.replace(/{([^{}]+)}/g,((Me,Le)=>Le in F?String(F[Le]):""))}(Me.properties,Fe)}createBucket(F){return new zm(F)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const F of Cm().paint.overridableProperties){if(!Dm.hasPaintOverride(this.layout,F))continue;const Me=this.paint.get(F),Le=new Vm(Me),Oe=new Wi(Le,Me.property.specification,this.scope,this.options);let Fe=null;Fe="constant"===Me.value.kind||"source"===Me.value.kind?new Qi("source",Oe):new ts("composite",Oe,Me.value.zoomStops,Me.value._interpolationType),this.paint._values[F]=new qs(Me.property,Fe,Me.parameters)}}_handleOverridablePaintPropertyUpdate(F,Me,Le){return!(!this.layout||Me.isDataDriven()||Le.isDataDriven())&&Dm.hasPaintOverride(this.layout,F)}static hasPaintOverride(F,Me){const Le=F.get("text-field"),Oe=Cm().paint.properties[Me];let Fe=!1;const s=F=>{for(const Me of F)if(Oe.overrides&&Oe.overrides.hasOverride(Me))return void(Fe=!0)};if("constant"===Le.value.kind&&Le.value.value instanceof Qe)s(Le.value.value.sections);else if("source"===Le.value.kind){const t=F=>{Fe||(F instanceof ar&&ir(F.value)===_d?s(F.value.sections):F instanceof cr?s(F.sections):F.eachChild(t))},F=Le.value;F._styleExpression&&t(F._styleExpression.expression)}return Fe}getProgramIds(){return["symbol"]}getDefaultProgramParams(F,Me,Le){return{config:new $o(this,{zoom:Me,lut:Le}),overrideFog:!1}}}let Fv,qv,Wv,Kv;var Jv=va([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Um(F){switch(F){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function jm(F){switch(F){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class qm{constructor(F,Me,Le,Oe){this.context=F,this.format=Le,this.useMipmap=Oe&&Oe.useMipmap,this.texture=F.gl.createTexture(),this.update(Me,{premultiply:Oe&&Oe.premultiply})}update(F,Me){const Le=F&&F instanceof HTMLVideoElement&&0===F.width?F.videoWidth:F.width,Oe=F&&F instanceof HTMLVideoElement&&0===F.height?F.videoHeight:F.height,{context:Fe}=this,{gl:je}=Fe,{x:qe,y:He}=Me&&Me.position?Me.position:{x:0,y:0},xt=qe+Le,Pt=He+Oe;!this.size||this.size[0]===xt&&this.size[1]===Pt||(je.bindTexture(je.TEXTURE_2D,null),je.deleteTexture(this.texture),this.texture=je.createTexture(),this.size=null),je.bindTexture(je.TEXTURE_2D,this.texture),Fe.pixelStoreUnpackFlipY.set(!1),Fe.pixelStoreUnpack.set(1),Fe.pixelStoreUnpackPremultiplyAlpha.set(this.format===je.RGBA8&&(!Me||!1!==Me.premultiply));const jt=F instanceof HTMLImageElement||F instanceof HTMLCanvasElement||F instanceof HTMLVideoElement||F instanceof ImageData||ImageBitmap&&F instanceof ImageBitmap;if(!this.size&&xt>0&&Pt>0){const F=this.useMipmap?Math.floor(Math.log2(Math.max(xt,Pt)))+1:1;je.texStorage2D(je.TEXTURE_2D,F,this.format,xt,Pt),this.size=[xt,Pt]}if(this.size)if(jt)je.texSubImage2D(je.TEXTURE_2D,0,qe,He,Um(this.format),jm(this.format),F);else{const Me=F.data;Me&&je.texSubImage2D(je.TEXTURE_2D,0,qe,He,Le,Oe,Um(this.format),jm(this.format),Me)}this.useMipmap&&je.generateMipmap(je.TEXTURE_2D)}bind(F,Me,Le=!1){const{context:Oe}=this,{gl:Fe}=Oe;Fe.bindTexture(Fe.TEXTURE_2D,this.texture),F!==this.minFilter&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MAG_FILTER,F),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MIN_FILTER,this.useMipmap&&!Le?F===Fe.NEAREST?Fe.NEAREST_MIPMAP_NEAREST:Fe.LINEAR_MIPMAP_LINEAR:F),this.minFilter=F),Me!==this.wrapS&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_S,Me),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_T,Me),this.wrapS=Me)}bindExtraParam(F,Me,Le,Oe){const{context:Fe}=this,{gl:je}=Fe;je.bindTexture(je.TEXTURE_2D,this.texture),Me!==this.magFilter&&(je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MAG_FILTER,Me),this.magFilter=Me),F!==this.minFilter&&(je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MIN_FILTER,this.useMipmap?F===je.NEAREST?je.NEAREST_MIPMAP_NEAREST:je.LINEAR_MIPMAP_LINEAR:F),this.minFilter=F),Le!==this.wrapS&&(je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_S,Le),this.wrapS=Le),Oe!==this.wrapT&&(je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_T,Oe),this.wrapT=Oe)}destroy(){const{gl:F}=this.context;F.deleteTexture(this.texture),this.texture=null}}class $m{constructor(F,Me){this.context=F,this.texture=Me}bind(F,Me){const{context:Le}=this,{gl:Oe}=Le;Oe.bindTexture(Oe.TEXTURE_2D,this.texture),F!==this.minFilter&&(Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_MAG_FILTER,F),Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_MIN_FILTER,F),this.minFilter=F),Me!==this.wrapS&&(Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_WRAP_S,Me),Oe.texParameteri(Oe.TEXTURE_2D,Oe.TEXTURE_WRAP_T,Me),this.wrapS=Me)}}function Gm(F,Me,Le,Oe,Fe,je,qe,He){const xt=[F,Me,1,Le,Oe,1,Fe,je,1],Pt=[qe,He,1],jt=bl.mat3.adjoint([],xt),[Gt,bi,wi]=bl.vec3.transformMat3(Pt,Pt,jt);return bl.mat3.multiply(xt,xt,[Gt,0,0,0,bi,0,0,0,wi])}function Ym(F,Me,Le,Oe,Fe,je,qe,He){const xt=function(F,Me,Le,Oe,Fe,je,qe,He){const xt=Gm(0,0,1,0,1,1,0,1),Pt=Gm(F,Me,Le,Oe,Fe,je,qe,He),jt=bl.mat3.adjoint([],xt);return bl.mat3.multiply(Pt,Pt,jt)}(F,Me,Le,Oe,Fe,je,qe,He);return[xt[2]/xt[8]/np,xt[5]/xt[8]/np]}function Hm(F){return[F[0],Math.min(Math.max(F[1],-Jm),Jm)]}class Xm extends _e{constructor(F,Me,Le,Oe){super(),this.id=F,this.dispatcher=Le,this.coordinates=Me.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(Oe),this.options=Me,this._dirty=!1}load(F,Me){if(this._loaded=Me||!1,this.fire(new ge("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return F&&(this.coordinates=F),this._loaded=!0,void this._finishLoading();this._imageRequest=le(this.map._requestManager.transformRequest(this.url,zh.Image),((Me,Le)=>{this._imageRequest=null,this._loaded=!0,Me?this.fire(new xe(Me)):Le&&(this.image=Le instanceof HTMLImageElement?eh.getImageData(Le):Le,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,F&&(this.coordinates=F),this._finishLoading())}))}loaded(){return this._loaded}updateImage(F){return F.url?(this._imageRequest&&F.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=F.url,this.load(F.coordinates,this._loaded),this):this}setTexture(F){if(!(F.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new $m(this.map.painter.context,F.handle),this.width=F.dimensions[0],this.height=F.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new ge("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(F){this.map=F,this.load()}onRemove(F){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof $m||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(F){if(this.coordinates=F,this._boundsArray=void 0,this._unsupportedCoords=!1,!F.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let Me=F[0][1],Le=F[0][1];for(const Oe of F)Oe[1]>Le&&(Le=Oe[1]),Oe[1]<Me&&(Me=Oe[1]);const Oe=(Le+Me)/2;if(Oe>Jm?this.onNorthPole=!0:Oe<-Jm&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const Me=F.map(Il.fromLngLat);this.tileID=function(F){let Me=1/0,Le=1/0,Oe=-1/0,Fe=-1/0;for(const je of F)Me=Math.min(Me,je.x),Le=Math.min(Le,je.y),Oe=Math.max(Oe,je.x),Fe=Math.max(Fe,je.y);const je=Math.max(Oe-Me,Fe-Le),qe=Math.max(0,Math.floor(-Math.log(je)/Math.LN2)),He=Math.pow(2,qe);let xt=Math.floor((Me+Oe)/2*He);return xt>1&&(xt-=1),new ou(qe,xt,Math.floor((Le+Fe)/2*He))}(Me),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new ge("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(F){for(const F in this.tiles){const Me=this.tiles[F];"loaded"!==Me.state&&(Me.state="loaded",Me.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const Me=Kd(new ou(0,0,0),this.map.transform.projection),Le=[Me.projection.project(this.coordinates[0][0],this.coordinates[0][1]),Me.projection.project(this.coordinates[1][0],this.coordinates[1][1]),Me.projection.project(this.coordinates[2][0],this.coordinates[2][1]),Me.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(F){const Me=F[1].x-F[0].x,Le=F[1].y-F[0].y,Oe=F[2].x-F[1].x,Fe=F[2].y-F[1].y,je=F[3].x-F[2].x,qe=F[3].y-F[2].y,He=F[0].x-F[3].x,xt=F[0].y-F[3].y,Pt=Me*Fe-Oe*Le,jt=Oe*qe-je*Fe,Gt=je*xt-He*qe,bi=He*Le-Me*xt;return Pt>0&&jt>0&&Gt>0&&bi>0||Pt<0&&jt<0&&Gt<0&&bi<0}(Le))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const Oe=Kd(this.tileID,this.map.transform.projection),[Fe,je,qe,He]=this.coordinates.map((F=>{const Me=Oe.projection.project(F[0],F[1]);return Jd(Oe,Me)._round()}));this.perspectiveTransform=Ym(Fe.x,Fe.y,je.x,je.y,qe.x,qe.y,He.x,He.y);const xt=this._boundsArray=new Ma;xt.emplaceBack(Fe.x,Fe.y,0,0),xt.emplaceBack(je.x,je.y,np,0),xt.emplaceBack(He.x,He.y,0,np),xt.emplaceBack(qe.x,qe.y,np,np),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=F.createVertexBuffer(xt,Jv.members),this.boundsSegments=xo.simpleSegment(0,0,4,2);const Pt=[],jt=[Hm((Gt=this.coordinates)[0]),Hm(Gt[1]),Hm(Gt[2]),Hm(Gt[3])];var Gt;const[bi,wi,qr,Xn]=function(F){let Me=F[0][0],Le=Me,Oe=F[0][1],Fe=Oe;for(let je=1;je<F.length;je++)F[je][0]<Me?Me=F[je][0]:F[je][0]>Le&&(Le=F[je][0]),F[je][1]<Oe?Oe=F[je][1]:F[je][1]>Fe&&(Fe=F[je][1]);return[Me,Oe,Le-Me,Fe-Oe]}(jt);{const Oe=new Ma,[Fe,je,qe,He]=function(F){let Me=F[0].x,Le=Me,Oe=F[0].y,Fe=Oe;for(let je=1;je<F.length;je++)F[je].x<Me?Me=F[je].x:F[je].x>Le&&(Le=F[je].x),F[je].y<Oe?Oe=F[je].y:F[je].y>Fe&&(Fe=F[je].y);return[Me,Oe,Le-Me,Fe-Oe]}(Le),l=F=>[(F.x-Fe)/qe,(F.y-je)/He],[xt,jt,Gt,Yn]=Le.map(l),yo=function(F,Me,Le,Oe,Fe,je,qe,He){const xt=Gm(0,0,1,0,1,1,0,1),Pt=Gm(F,Me,Le,Oe,Fe,je,qe,He),jt=bl.mat3.adjoint([],Pt);return bl.mat3.multiply(xt,xt,jt)}(xt[0],xt[1],jt[0],jt[1],Gt[0],Gt[1],Yn[0],Yn[1]);this.elevatedGlobePerspectiveTransform=Ym(xt[0],xt[1],jt[0],jt[1],Gt[0],Gt[1],Yn[0],Yn[1]);const v=(F,Me)=>{Pt.push(F.lng);const Le=Math.round((F.lng-bi)/qr*np),Fe=Math.round((F.lat-wi)/Xn*np),je=l(Me),qe=bl.vec3.transformMat3([],[je[0],je[1],1],yo),He=Math.round(qe[0]/qe[2]*np),xt=Math.round(qe[1]/qe[2]*np);Oe.emplaceBack(Le,Fe,He,xt)},bo=Le[3].x-Le[0].x,Ro=Le[3].y-Le[0].y,Do=Le[2].x-Le[1].x,zs=Le[2].y-Le[1].y;for(let F=0;F<65;F++){const Oe=F/64,Fe=[Le[0].x+Oe*bo,Le[0].y+Oe*Ro],je=[Le[1].x+Oe*Do,Le[1].y+Oe*zs],qe=je[0]-Fe[0],He=je[1]-Fe[1];for(let F=0;F<65;F++){const Le=F/64,Oe={x:Fe[0]+qe*Le,y:Fe[1]+He*Le,z:0};v(Me.projection.unproject(Oe.x,Oe.y),Oe)}}this.elevatedGlobeVertexBuffer=F.createVertexBuffer(Oe,Jv.members)}{this.maxLongitudeTriangleSize=0;let Me=[],Le=new ja;const n=(F,Oe,Fe)=>{Le.emplaceBack(F,Oe,Fe);const je=Pt[F],qe=Pt[Oe],He=Pt[Fe],xt=Math.min(Math.min(je,qe),He),jt=Math.max(Math.max(je,qe),He)-xt;jt>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=jt),Me.push(xt+jt/2)};for(let F=0;F<64;F++)for(let Me=0;Me<64;Me++){const Le=65*F+Me,Oe=Le+1,Fe=Le+65,je=Fe+1;n(Le,Fe,Oe),n(Oe,Fe,je)}[Me,Le]=function(F,Me){const Le=Array.from({length:F.length},((F,Me)=>Me));Le.sort(((Me,Le)=>F[Me]-F[Le]));const Oe=[],Fe=new ja;for(let je=0;je<Le.length;je++){const qe=Le[je];Oe.push(F[qe]);const He=3*qe,xt=He+1;Fe.emplaceBack(Me.uint16[He],Me.uint16[xt],Me.uint16[xt+1])}return[Oe,Fe]}(Me,Le),this.elevatedGlobeTrianglesCenterLongitudes=Me,this.elevatedGlobeIndexBuffer=F.createIndexBuffer(Le)}this.elevatedGlobeSegments=xo.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,qr/np,0,Xn/np,0,0,wi,bi,0])}prepare(){const F=0!==Object.keys(this.tiles).length;if(this.tileID&&!F)return;const Me=this.map.painter.context,Le=Me.gl;!this._dirty||this.texture instanceof $m||(this.texture?this.texture.update(this.image):(this.texture=new qm(Me,this.image,Le.RGBA8),this.texture.bind(Le.LINEAR,Le.CLAMP_TO_EDGE)),this._dirty=!1),F&&this._prepareData(Me)}loadTile(F,Me){this.tileID&&this.tileID.equals(F.tileID.canonical)?(this.tiles[String(F.tileID.wrap)]=F,F.buckets={},Me(null)):(F.state="errored",Me(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(F){const Me=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!Me)return null;const Le=this.elevatedGlobeTrianglesCenterLongitudes;let Oe=(Fe=F+180)+360*Math.round((Le[0]-Fe)/360);var Fe;const je=new xo,a=(F,Le)=>{je.segments.push({vertexOffset:0,primitiveOffset:F,vertexLength:Me.segments[0].vertexLength,primitiveLength:Le,sortKey:void 0,vaos:{}})},qe=.51*this.maxLongitudeTriangleSize;if(Math.abs(Le[0]-Oe)<=qe){const F=_t(Le,0,Le.length,Oe+qe);return F===Le.length||a(F,bt(Le,F+1,Le.length,Oe+360-qe)-F),je}Oe<Le[0]&&(Oe+=360);const He=bt(Le,0,Le.length,Oe-qe);if(He===Le.length)return a(0,Le.length),je;a(0,He-0);const xt=_t(Le,He+1,Le.length,Oe+qe);return xt!==Le.length&&a(xt,Le.length-xt),je}}const Qv=(Math.pow(256,2)-1)/16907520;class Wm extends ma{constructor(F,Me,Le,Oe){super(F,{layout:Wv||(Wv=new Xs({visibility:new Gs(Cf.layout_raster.visibility)})),paint:Kv||(Kv=new Xs({"raster-opacity":new Gs(Cf.paint_raster["raster-opacity"]),"raster-color":new Hs(Cf.paint_raster["raster-color"]),"raster-color-mix":new Gs(Cf.paint_raster["raster-color-mix"]),"raster-color-range":new Gs(Cf.paint_raster["raster-color-range"]),"raster-hue-rotate":new Gs(Cf.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Gs(Cf.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Gs(Cf.paint_raster["raster-brightness-max"]),"raster-saturation":new Gs(Cf.paint_raster["raster-saturation"]),"raster-contrast":new Gs(Cf.paint_raster["raster-contrast"]),"raster-resampling":new Gs(Cf.paint_raster["raster-resampling"]),"raster-fade-duration":new Gs(Cf.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Gs(Cf.paint_raster["raster-emissive-strength"]),"raster-array-band":new Gs(Cf.paint_raster["raster-array-band"]),"raster-elevation":new Gs(Cf.paint_raster["raster-elevation"]),"raster-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(F){return!(F&&F._source instanceof Xm&&(F._source.onNorthPole||F._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(F){"raster-color"!==F&&"raster-color-range"!==F||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(F){if(!this.hasColorMap())return;if(!this._curRampRange)return;const Me=this._transitionablePaint._values["raster-color"].value.expression,[Le,Oe]=F||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(Le)&&isNaN(Oe)||Le===this._curRampRange[0]&&Oe===this._curRampRange[1]||(this.colorRamp=dc({expression:Me,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:Le,end:Oe}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[Le,Oe])}}let eb,tb,ib,rb,nb;class ry extends ma{constructor(F,Me,Le,Oe){super(F,{layout:eb||(eb=new Xs({visibility:new Gs(Cf["layout_raster-particle"].visibility)})),paint:tb||(tb=new Xs({"raster-particle-array-band":new Gs(Cf["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Gs(Cf["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Hs(Cf["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Gs(Cf["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Gs(Cf["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Gs(Cf["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Gs(Cf["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Gs(Cf["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe),this._updateColorRamp(),this.lastInvalidatedAt=eh.now()}onRemove(F){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(F){return!1}_handleSpecialPaintPropertyUpdate(F){"raster-particle-color"!==F&&"raster-particle-max-speed"!==F||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===F&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const F=this._transitionablePaint._values["raster-particle-color"].value.expression,Me=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=dc({expression:F,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:Me}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=eh.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class ny extends ma{constructor(F,Me){super(F,{},Me,null),this.implementation=F,F.slot&&(this.slot=F.slot)}is3D(F){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(F){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(F){this.implementation.onAdd&&this.implementation.onAdd(F,F.painter.context.gl)}onRemove(F){this.implementation.onRemove&&this.implementation.onRemove(F,F.painter.context.gl)}}function iy(F,Me,Le){const Oe=[0,0,1],Fe=bl.quat.identity([]);return bl.quat.rotateY(Fe,Fe,Le?-H(F)+Math.PI:H(F)),bl.quat.rotateX(Fe,Fe,-H(Me)),bl.vec3.transformQuat(Oe,Oe,Fe),bl.vec3.normalize(Oe,Oe)}function sy(F,Me){const Le=oy(F.projection,F.zoom,F.width,F.height),Oe=function(F,Me,Le,Oe,Fe){const je=new ul(Le.lng-180*ob,Le.lat),qe=new ul(Le.lng+180*ob,Le.lat),He=F.project(je.lng,je.lat),xt=F.project(qe.lng,qe.lat),Pt=-Math.atan2(xt.y-He.y,xt.x-He.x),jt=Il.fromLngLat(Le);jt.y=Q(jt.y,-1+ob,1-ob);const Gt=jt.toLngLat(),bi=F.project(Gt.lng,Gt.lat),wi=Il.fromLngLat(Gt);wi.x+=ob;const qr=wi.toLngLat(),Xn=F.project(qr.lng,qr.lat),Yn=cy(Xn.x-bi.x,Xn.y-bi.y,Pt),yo=Il.fromLngLat(Gt);yo.y+=ob;const bo=yo.toLngLat(),Ro=F.project(bo.lng,bo.lat),Do=cy(Ro.x-bi.x,Ro.y-bi.y,Pt),zs=Math.abs(Yn.x)/Math.abs(Do.y),Zs=bl.mat4.identity([]);bl.mat4.rotateZ(Zs,Zs,-Pt*(1-(Fe?0:Oe)));const na=bl.mat4.identity([]);return bl.mat4.scale(na,na,[1,1-(1-zs)*Oe,1]),na[4]=-Do.x/Do.y*Oe,bl.mat4.rotateZ(na,na,Pt),bl.mat4.multiply(na,Zs,na),na}(F.projection,0,F.center,Le,Me),Fe=ay(F);return bl.mat4.scale(Oe,Oe,[Fe,Fe,1]),Oe}function ay(F){const Me=F.projection,Le=oy(F.projection,F.zoom,F.width,F.height),Oe=uy(Me,F.center),Fe=uy(Me,ul.convert(Me.center));return Math.pow(2,Oe*Le+(1-Le)*Fe)}function oy(F,Me,Le,Oe,Fe=1/0){const je=F.range;if(!je)return 0;const qe=Math.min(Fe,Math.max(Le,Oe)),He=Math.log(qe/1024)/Math.LN2;return tt(je[0]+He,je[1]+He,Me)}const ob=1/4e4;function uy(F,Me){const Le=Q(Me.lat,-Jm,Jm),Oe=new ul(Me.lng-180*ob,Le),Fe=new ul(Me.lng+180*ob,Le),je=F.project(Oe.lng,Le),qe=F.project(Fe.lng,Le),He=Il.fromLngLat(Oe),xt=Il.fromLngLat(Fe),Pt=qe.x-je.x,jt=qe.y-je.y,Gt=xt.x-He.x,bi=xt.y-He.y,wi=Math.sqrt((Gt*Gt+bi*bi)/(Pt*Pt+jt*jt));return Math.log(wi)/Math.LN2}function cy(F,Me,Le){const Oe=Math.cos(Le),Fe=Math.sin(Le);return{x:F*Oe-Me*Fe,y:F*Fe+Me*Oe}}function hy(F,Me,Le){bl.mat4.identity(F),bl.mat4.rotateZ(F,F,H(Me[2])),bl.mat4.rotateX(F,F,H(Me[0])),bl.mat4.rotateY(F,F,H(Me[1])),bl.mat4.scale(F,F,Le),bl.mat4.multiply(F,F,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function py(F,Me,Le,Oe,Fe,je,qe,He){const xt=[Le[0]-Me[0],Le[1]-Me[1],0],Pt=[Oe[0]-Me[0],Oe[1]-Me[1],0];if(bl.vec3.length(xt)<1e-12||bl.vec3.length(Pt)<1e-12)return bl.quat.identity(F);const jt=bl.vec3.cross([],xt,Pt);bl.vec3.normalize(jt,jt),bl.vec3.subtract(Pt,Oe,Me),xt[2]=(je-Fe)*He,Pt[2]=(qe-Fe)*He;const Gt=xt;return bl.vec3.cross(Gt,xt,Pt),bl.vec3.normalize(Gt,Gt),bl.quat.rotationTo(F,jt,Gt)}function fy(F,Me,Le=!1){const Oe=$u(Me.zoom),Fe=function(F,Me,Le){const Oe=Me.worldSize,Fe=[F[12],F[13],F[14]],je=xl(Fe[1]/Oe),qe=gl(Fe[0]/Oe),He=bl.mat4.identity([]),xt=yl(1,je)*Oe,Pt=yl(1,0)*Oe*wl(je,Me.zoom),jt=1/Uu(Oe);let Gt=Pt*jt;if(Le){const F=oy(Me.projection,Me.zoom,Me.width,Me.height,1024);Gt=jt*Me.projection.pixelSpaceConversion(Me.center.lat,Oe,F)}const bi=al(je,qe);bl.vec3.add(bi,bi,bl.vec3.scale([],bl.vec3.normalize([],bi),xt*Gt*Fe[2]));const wi=function(F){const Me=[F[0],F[1],F[2]];let Le=[0,1,0];const Oe=bl.vec3.cross([],Le,Me);return bl.vec3.cross(Le,Me,Oe),0===bl.vec3.squaredLength(Le)&&(Le=[0,1,0],bl.vec3.cross(Oe,Me,Le)),bl.vec3.normalize(Oe,Oe),bl.vec3.normalize(Le,Le),bl.vec3.normalize(Me,Me),[Oe[0],Oe[1],Oe[2],0,Le[0],Le[1],Le[2],0,Me[0],Me[1],Me[2],0,F[0],F[1],F[2],1]}(bi);bl.mat4.scale(He,He,[Gt,Gt,Gt*xt]),bl.mat4.translate(He,He,[-Fe[0],-Fe[1],-Fe[2]]);const qr=bl.mat4.multiply([],Me.globeMatrix,wi);return bl.mat4.multiply(qr,qr,He),bl.mat4.multiply(qr,qr,F),qr}(F,Me,Le);if(Oe>0){const Le=function(F,Me){const Le=Me.worldSize,Oe=yl(1,0)*Le*wl(Me.center.lat,Me.zoom)/Uu(Le),Fe=yl(1,Me.center.lat)*Le,je=bl.mat4.identity([]);return bl.mat4.rotateY(je,je,H(Me.center.lng)),bl.mat4.rotateX(je,je,H(Me.center.lat)),bl.mat4.translate(je,je,[0,0,_m]),bl.mat4.scale(je,je,[Oe,Oe,Oe*Fe]),bl.mat4.translate(je,je,[Me.point.x-.5*Le,Me.point.y-.5*Le,0]),bl.mat4.multiply(je,je,F),bl.mat4.multiply(je,Me.globeMatrix,je)}(F,Me);return function(F,Me,Le){const n=(F,Me,Le)=>{const Oe=bl.vec3.length(F),Fe=bl.vec3.length(Me),je=Tu(F,Me,Le);return bl.vec3.scale(je,je,1/bl.vec3.length(je)*Ee(Oe,Fe,Le))},Oe=n([F[0],F[1],F[2]],[Me[0],Me[1],Me[2]],Le),Fe=n([F[4],F[5],F[6]],[Me[4],Me[5],Me[6]],Le),je=n([F[8],F[9],F[10]],[Me[8],Me[9],Me[10]],Le),qe=Tu([F[12],F[13],F[14]],[Me[12],Me[13],Me[14]],Le);return[Oe[0],Oe[1],Oe[2],0,Fe[0],Fe[1],Fe[2],0,je[0],je[1],je[2],0,qe[0],qe[1],qe[2],1]}(Fe,Le,Oe)}return Fe}function dy(F,Me,Le,Oe){const Fe=Au.projectAabbCorners(Oe,Le);let je=Number.MAX_VALUE,qe=-1;for(let F=0;F<Fe.length;++F){const Le=Fe[F];Le[0]=(.5*Le[0]+.5)*Me.width,Le[1]=(.5-.5*Le[1])*Me.height,Le[2]<je&&(qe=F,je=Le[2])}const o=F=>new ec(Fe[F][0],Fe[F][1]);let He;switch(qe){case 0:case 6:He=[o(1),o(5),o(4),o(7),o(3),o(2),o(1)];break;case 1:case 7:He=[o(0),o(4),o(5),o(6),o(2),o(3),o(0)];break;case 3:case 5:He=[o(1),o(0),o(4),o(7),o(6),o(2),o(1)];break;default:He=[o(1),o(5),o(6),o(7),o(3),o(0),o(1)]}if(Fl(F,He))return je}const sb=va([{name:"a_pos_3f",components:3,type:"Float32"}]),ab=va([{name:"a_color_3f",components:3,type:"Float32"}]),lb=va([{name:"a_color_4f",components:4,type:"Float32"}]),cb=va([{name:"a_uv_2f",components:2,type:"Float32"}]),hb=va([{name:"a_normal_3f",components:3,type:"Float32"}]),ub=va([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),db=va([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),pb={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class My{constructor(F,Me,Le,Oe){this.message=(F?`${F}: `:"")+Le,Oe&&(this.identifier=Oe),null!=Me&&Me.__line__&&(this.line=Me.__line__)}}function Ay(F,Me){const Le=-1===F.indexOf("://");try{return new URL(F,Le&&Me?"http://example.com":void 0),!0}catch(F){return!1}}class Iy{constructor(F,Me){this.feature=F,this.instancedDataOffset=Me,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Sy{constructor(){this.instancedDataArray=new Ja,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Py{constructor(F){this.zoom=F.zoom,this.canonical=F.canonical,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.projection=F.projection,this.index=F.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(F,Me){}populate(F,Me,Le,Oe){this.tileToMeter=Al(Le);const Fe=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:je,id:qe,index:He,sourceLayerIndex:xt}of F){const F=null!=qe?qe:je.properties&&je.properties.hasOwnProperty("id")?je.properties.id:void 0,Pt=Cl(je,Fe);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),Pt,Le))continue;const jt={id:F,sourceLayerIndex:xt,index:He,geometry:Fe?Pt.geometry:Vl(je,Le,Oe),properties:je.properties,type:je.type,patterns:{}},Gt=this.addFeature(jt,jt.geometry,Pt);Gt&&Me.featureIndex.insert(je,jt.geometry,He,xt,this.index,this.instancesPerModel[Gt].instancedDataArray.length,np/32)}this.lookup=null}update(F,Me,Le,Oe){for(const Me in this.instancesPerModel){const Le=this.instancesPerModel[Me];for(const Me in F)Le.idToFeaturesIndex.hasOwnProperty(Me)&&(this.evaluate(Le.features[Le.idToFeaturesIndex[Me]],F[Me],Le,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let F=!1;for(const Me in this.instancesPerModel){const Le=this.instancesPerModel[Me];for(const Me of Le.features){const Oe=this.layers[0],Fe=Me.feature,je=this.canonical,qe=Oe.paint.get("model-rotation").evaluate(Fe,{},je),He=Oe.paint.get("model-scale").evaluate(Fe,{},je),xt=Oe.paint.get("model-translation").evaluate(Fe,{},je);bl.vec3.exactEquals(Me.rotation,qe)&&bl.vec3.exactEquals(Me.scale,He)&&bl.vec3.exactEquals(Me.translation,xt)||(this.evaluate(Me,Me.featureStates,Le,!0),F=!0)}}return F}updateReplacement(F,Me,Le,Oe){if(Me.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=Me.updateTime;const Fe=Me.getReplacementRegionsForTile(F.toUnwrapped(),!0);if(Yh(this.activeReplacements,Fe))return!1;this.activeReplacements=Fe;let je=!1;for(const Me in this.instancesPerModel){const Fe=this.instancesPerModel[Me],qe=Fe.instancedDataArray;for(const Me of Fe.features){const Fe=Me.instancedDataOffset,He=Me.instancedDataCount;for(let Me=0;Me<He;Me++){const He=16*(Me+Fe);let xt=qe.float32[He+0];const Pt=xt>np;xt=Pt?xt-np:xt;const jt=Math.floor(xt),Gt=qe.float32[He+1];let bi=!1;for(const Me of this.activeReplacements)if(!jh(Me,Le,pb.Model,Oe)&&!(Me.min.x>jt||jt>Me.max.x||Me.min.y>Gt||Gt>Me.max.y)&&(bi=Jh(Kh(jt,Gt,F.canonical,Me.footprintTileId.canonical),Me.footprint),bi))break;qe.float32[He]=bi?xt+np:xt,je=je||bi!==Pt}}}return je}isEmpty(){for(const F in this.instancesPerModel)if(0!==this.instancesPerModel[F].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(F){if(!this.uploaded)for(const Me in this.instancesPerModel){const Le=this.instancesPerModel[Me];Le.instancedDataArray.length<0||0===Le.instancedDataArray.length||(Le.instancedDataBuffer?Le.instancedDataBuffer.updateData(Le.instancedDataArray):Le.instancedDataBuffer=F.createVertexBuffer(Le.instancedDataArray,ub.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const F in this.instancesPerModel){const Me=this.instancesPerModel[F];0!==Me.instancedDataArray.length&&Me.instancedDataBuffer&&Me.instancedDataBuffer.destroy()}const F=this.layers[0].modelManager;if(F&&this.modelUris)for(const Me of this.modelUris)F.removeModel(Me,"")}addFeature(F,Me,Le){const Oe=this.layers[0],Fe=Oe.layout.get("model-id").evaluate(Le,{},this.canonical);if(!Fe)return pt(`modelId is not evaluated for layer ${Oe.id} and it is not going to get rendered.`),Fe;Ay(Fe,!1)&&(this.modelUris.includes(Fe)||this.modelUris.push(Fe)),this.instancesPerModel[Fe]||(this.instancesPerModel[Fe]=new Sy);const je=this.instancesPerModel[Fe],qe=je.instancedDataArray,He=new Iy(Le,qe.length);for(const F of Me)for(const Me of F){if(Me.x<0||Me.x>=np||Me.y<0||Me.y>=np)continue;const F=(this.lookupDim-1)/np,Le=this.lookupDim*(Me.y*F|0)+Me.x*F|0;if(this.lookup){if(0!==this.lookup[Le])continue;this.lookup[Le]=1}this.instanceCount++;const Oe=qe.length;qe.resize(Oe+1),je.instancesEvaluatedElevation.push(0),qe.float32[16*Oe]=Me.x,qe.float32[16*Oe+1]=Me.y}return He.instancedDataCount=je.instancedDataArray.length-He.instancedDataOffset,He.instancedDataCount>0&&(F.id&&(je.idToFeaturesIndex[F.id]=je.features.length),je.features.push(He),this.evaluate(He,{},je,!1)),Fe}getModelUris(){return this.modelUris}evaluate(F,Me,Le,Oe){const Fe=this.layers[0],je=F.feature,qe=this.canonical,He=F.rotation=Fe.paint.get("model-rotation").evaluate(je,Me,qe),xt=F.scale=Fe.paint.get("model-scale").evaluate(je,Me,qe),Pt=F.translation=Fe.paint.get("model-translation").evaluate(je,Me,qe),jt=Fe.paint.get("model-color").evaluate(je,Me,qe);jt.a=Fe.paint.get("model-color-mix-intensity").evaluate(je,Me,qe);const Gt=[];this.maxVerticalOffset<Pt[2]&&(this.maxVerticalOffset=Pt[2]),this.maxScale=Math.max(Math.max(this.maxScale,xt[0]),Math.max(xt[1],xt[2])),hy(Gt,He,xt);const bi=Math.round(100*jt.a)+jt.b/1.05;for(let Me=0;Me<F.instancedDataCount;++Me){const Fe=F.instancedDataOffset+Me,je=16*Fe,He=Le.instancedDataArray.float32;let xt=0;Oe&&(xt=He[je+6]-Le.instancesEvaluatedElevation[Fe]);const wi=0|He[je+1];He[je]=(0|He[je])+jt.r/1.05,He[je+1]=wi+jt.g/1.05,He[je+2]=bi,He[je+3]=1/(qe.z>10?this.tileToMeter:Al(qe,wi)),He[je+4]=Pt[0],He[je+5]=Pt[1],He[je+6]=Pt[2]+xt,He[je+7]=Gt[0],He[je+8]=Gt[1],He[je+9]=Gt[2],He[je+10]=Gt[4],He[je+11]=Gt[5],He[je+12]=Gt[6],He[je+13]=Gt[8],He[je+14]=Gt[9],He[je+15]=Gt[10],Le.instancesEvaluatedElevation[Fe]=Pt[2]}}}let fb,mb;us(Py,"ModelBucket",{omit:["layers"]}),us(Sy,"PerModelAttributes"),us(Iy,"ModelFeature");const _b=64,gb={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function By(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt=!1){const jt=Le.zoom,Gt=Le.project(Oe),bi=wl(Oe.lat,jt),wi=1/bi;bl.mat4.identity(F),bl.mat4.translate(F,F,[Gt.x+qe[0]*wi,Gt.y+qe[1]*wi,qe[2]]);let qr=1,Xn=1;const Yn=Le.worldSize;if(Pt){if("mercator"===Le.projection.name){let F=0;Le.elevation&&(F=Le.elevation.getAtPointOrZero(new Il(Gt.x/Yn,Gt.y/Yn),0));const Me=bl.vec4.transformMat4([],[Gt.x,Gt.y,F,1],Le.projMatrix)[3]/Le.cameraToCenterDistance;qr=Me,Xn=Me*wl(Le.center.lat,jt)}else if("globe"===Le.projection.name){const Me=fy(F,Le),Fe=bl.mat4.multiply([],Le.projMatrix,Me),je=[0,0,0,1];bl.vec4.transformMat4(je,je,Fe);const qe=je[3]/Le.cameraToCenterDistance,He=$u(jt),xt=Le.projection.pixelsPerMeter(Oe.lat,Yn)*wl(Oe.lat,jt),Pt=Le.projection.pixelsPerMeter(Le.center.lat,Yn)*wl(Le.center.lat,jt);qr=qe/Ee(xt,_l(Le.center.lat),He),Xn=qe*bi/xt,qr*=Pt,Xn*=Pt}}else qr=wi;bl.mat4.scale(F,F,[qr,qr,Xn]);const yo=[...F],bo=Me.orientation,Ro=[];if(hy(Ro,[bo[0]+Fe[0],bo[1]+Fe[1],bo[2]+Fe[2]],je),bl.mat4.multiply(F,yo,Ro),He&&Le.elevation){let Fe=0;const je=[];if(xt&&Le.elevation){Fe=function(F,Me,Le,Oe,Fe){const je=Me.elevation;if(!je)return 0;const qe=Au.projectAabbCorners(Le,Oe),He=yl(1,Fe.lat)*Me.worldSize,xt=function(F,Me){const Le=[0,0,1],Oe=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Fe of Oe){const Oe=F[Fe.corners[0]],je=F[Fe.corners[1]],qe=F[Fe.corners[2]],He=[je[0]-Oe[0],je[1]-Oe[1],Me*(je[2]-Oe[2])],xt=bl.vec3.cross(He,He,[qe[0]-Oe[0],qe[1]-Oe[1],Me*(qe[2]-Oe[2])]);bl.vec3.normalize(xt,xt),Fe.dotProductWithUp=bl.vec3.dot(xt,Le)}return Oe.sort(((F,Me)=>F.dotProductWithUp-Me.dotProductWithUp)),Oe[0].corners}(qe,He),Pt=qe[xt[0]],jt=qe[xt[1]],Gt=qe[xt[2]],bi=qe[xt[3]],wi=je.getAtPointOrZero(new Il(Pt[0]/Me.worldSize,Pt[1]/Me.worldSize),0),qr=je.getAtPointOrZero(new Il(jt[0]/Me.worldSize,jt[1]/Me.worldSize),0),Xn=je.getAtPointOrZero(new Il(Gt[0]/Me.worldSize,Gt[1]/Me.worldSize),0),Yn=je.getAtPointOrZero(new Il(bi[0]/Me.worldSize,bi[1]/Me.worldSize),0),yo=(wi+Yn)/2,bo=(qr+Xn)/2;return yo>bo?qr<Xn?py(F,jt,bi,Pt,qr,Yn,wi,He):py(F,Gt,Pt,bi,Xn,wi,Yn,He):wi<Yn?py(F,Pt,jt,Gt,wi,qr,Xn,He):py(F,bi,Gt,jt,Yn,Xn,qr,He),Math.max(yo,bo)}(je,Le,Me.aabb,F,Oe);const qe=bl.mat4.fromQuat([],je),He=bl.mat4.multiply([],qe,Ro);bl.mat4.multiply(F,yo,He)}else Fe=Le.elevation.getAtPointOrZero(new Il(Gt.x/Yn,Gt.y/Yn),0);0!==Fe&&(F[14]+=Fe)}}function Vy(F,Me,Le=!1){F.uploaded||(F.gfxTexture=new qm(Me,F.image,Le?Me.gl.R8:Me.gl.RGBA8,{useMipmap:F.sampler.minFilter>=Me.gl.NEAREST_MIPMAP_NEAREST}),F.uploaded=!0,F.image=null)}function Cy(F,Me,Le){F.indexBuffer=Me.createIndexBuffer(F.indexArray,!1,!0),F.vertexBuffer=Me.createVertexBuffer(F.vertexArray,sb.members,!1,!0),F.normalArray&&(F.normalBuffer=Me.createVertexBuffer(F.normalArray,hb.members,!1,!0)),F.texcoordArray&&(F.texcoordBuffer=Me.createVertexBuffer(F.texcoordArray,cb.members,!1,!0)),F.colorArray&&(F.colorBuffer=Me.createVertexBuffer(F.colorArray,(12===F.colorArray.bytesPerElement?ab:lb).members,!1,!0)),F.featureArray&&(F.pbrBuffer=Me.createVertexBuffer(F.featureArray,db.members,!0)),F.segments=xo.simpleSegment(0,0,F.vertexArray.length,F.indexArray.length);const Oe=F.material;Oe.pbrMetallicRoughness.baseColorTexture&&Vy(Oe.pbrMetallicRoughness.baseColorTexture,Me),Oe.pbrMetallicRoughness.metallicRoughnessTexture&&Vy(Oe.pbrMetallicRoughness.metallicRoughnessTexture,Me),Oe.normalTexture&&Vy(Oe.normalTexture,Me),Oe.occlusionTexture&&Vy(Oe.occlusionTexture,Me,Le),Oe.emissionTexture&&Vy(Oe.emissionTexture,Me)}function Dy(F,Me,Le){if(F.meshes)for(const Oe of F.meshes)Cy(Oe,Me,Le);if(F.children)for(const Oe of F.children)Dy(Oe,Me,Le)}function Ry(F){if(F.meshes)for(const Me of F.meshes)Me.indexArray.destroy(),Me.vertexArray.destroy(),Me.colorArray&&Me.colorArray.destroy(),Me.normalArray&&Me.normalArray.destroy(),Me.texcoordArray&&Me.texcoordArray.destroy(),Me.featureArray&&Me.featureArray.destroy();if(F.children)for(const Me of F.children)Ry(Me)}function Ly(F){if(F.meshes)for(const Le of F.meshes)Le.vertexBuffer&&(Le.vertexBuffer.destroy(),Le.indexBuffer.destroy(),Le.normalBuffer&&Le.normalBuffer.destroy(),Le.texcoordBuffer&&Le.texcoordBuffer.destroy(),Le.colorBuffer&&Le.colorBuffer.destroy(),Le.pbrBuffer&&Le.pbrBuffer.destroy(),Le.segments.destroy(),Le.material&&((Me=Le.material).pbrMetallicRoughness.baseColorTexture&&Me.pbrMetallicRoughness.baseColorTexture.gfxTexture&&Me.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),Me.pbrMetallicRoughness.metallicRoughnessTexture&&Me.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&Me.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),Me.normalTexture&&Me.normalTexture.gfxTexture&&Me.normalTexture.gfxTexture.destroy(),Me.emissionTexture&&Me.emissionTexture.gfxTexture&&Me.emissionTexture.gfxTexture.destroy(),Me.occlusionTexture&&Me.occlusionTexture.gfxTexture&&Me.occlusionTexture.gfxTexture.destroy()));var Me;if(F.children)for(const Me of F.children)Ly(Me)}class Fy{constructor(F,Me,Le){this._demTile=F,this._dem=this._demTile.dem,this._scale=Me,this._offset=Le}static create(F,Me,Le){const Oe=Le||F.findDEMTileFor(Me);if(!Oe||!Oe.dem)return;const Fe=Oe.dem,je=Oe.tileID,qe=1<<Me.canonical.z-je.canonical.z;return new Fy(Oe,Fe.dim/np/qe,[(Me.canonical.x/qe-je.canonical.x)*Fe.dim,(Me.canonical.y/qe-je.canonical.y)*Fe.dim])}tileCoordToPixel(F,Me){const Le=Me*this._scale+this._offset[1],Oe=Math.floor(F*this._scale+this._offset[0]),Fe=Math.floor(Le);return new ec(Oe,Fe)}getElevationAt(F,Me,Le,Oe){const Fe=F*this._scale+this._offset[0],je=Me*this._scale+this._offset[1],qe=Math.floor(Fe),He=Math.floor(je),xt=this._dem;return Oe=!!Oe,Le?Ee(Ee(xt.get(qe,He,Oe),xt.get(qe,He+1,Oe),je-He),Ee(xt.get(qe+1,He,Oe),xt.get(qe+1,He+1,Oe),je-He),Fe-qe):xt.get(qe,He,Oe)}getElevationAtPixel(F,Me,Le){return this._dem.get(F,Me,!!Le)}getMeterToDEM(F){return(1<<this._demTile.tileID.canonical.z)*yl(1,F)*this._dem.stride}}const yb=new Float32Array(262144),xb=new Uint8Array(262144);function Uy(F){let Me=0;if(F.meshes)for(const Le of F.meshes)Me=Math.max(Me,Le.aabb.max[2]);if(F.children)for(const Le of F.children)Me=Math.max(Me,Uy(Le));return Me}function jy(F,Me,Le){if(F.meshes)for(const Oe of F.meshes){if(Oe.aabb.min[0]===1/0)continue;const Fe=Au.applyTransform(Oe.aabb,F.matrix);Le.insert(Me,Fe.min[0],Fe.min[1],Fe.max[0],Fe.max[1])}if(F.children)for(const Oe of F.children)jy(Oe,Me,Le)}const vb=["","wall","door","roof","window","lamp","logo"];class $y{constructor(F){this.node=F,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:F.id,geometry:[],properties:{height:Uy(F)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let F=0;const Me=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const Le of this.node.meshes)this.node.lightMeshIndex!==F&&(Le.transformedAabb=Au.applyTransformFast(Le.aabb,this.node.matrix),Me.encapsulate(Le.transformedAabb)),F++;this.aabb=Me}return this.aabb}}class Gy{constructor(F,Me,Le,Oe,Fe,je,qe){this.id=Le,this.layers=F,this.layerIds=this.layers.map((F=>F.fqid)),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.modelTraits|=gb.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,Oe&&(this.modelTraits|=gb.HasMapboxMeshFeatures),Fe&&(this.modelTraits|=gb.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=je,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const F of Me)this.nodesInfo.push(new $y(F)),jy(F,qe.featureIndexArray.length,qe.grid),qe.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,qe.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(F,Me){for(const Le of this.getNodesInfo()){const Oe=Le.node;Oe.footprint&&Me.push({footprint:Oe.footprint,id:F})}}update(F){const Me=0!==Object.keys(F).length;if(Me&&!this.stateDependentLayers.length)return;const Le=Me?this.stateDependentLayers:this.layers;if(!$(F,this.states))for(const Me of Le)this.evaluate(Me,F);this.states=structuredClone(F)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(F){if(!this.needsUpload)return;const Me=this.getNodesInfo();for(const Le of Me){const Me=Le.node;this.uploaded?this.updatePbrBuffer(Me):Dy(Me,F,!0)}for(const F of Me)Ry(F.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(F){let Me=!1;if(!F.meshes)return Me;for(const Le of F.meshes)Le.pbrBuffer&&(Le.pbrBuffer.updateData(Le.featureArray),Me=!0);return Me}needsReEvaluation(F,Me,Le){const Oe=F.transform.projectionOptions,Fe=F.style.getBrightness(),je=this.brightness!==Fe;if(!this.uploaded||this.dirty||Oe.name!==this.projection.name||Yy(Le.paint.get("model-color").value,je)||Yy(Le.paint.get("model-color-mix-intensity").value,je)||Yy(Le.paint.get("model-roughness").value,je)||Yy(Le.paint.get("model-emissive-strength").value,je)||Yy(Le.paint.get("model-height-based-emissive-strength-multiplier").value,je)){this.projection=Oe,this.brightness=Fe;const F=this.getNodesInfo();for(const Me of F)Me.state=null;return!0}return!1}evaluateScale(F,Me){if(F.transform.zoom===this.zoom)return;this.zoom=F.transform.zoom;const Le=this.getNodesInfo(),Oe=this.id.canonical;for(const F of Le){const Le=F.feature;F.evaluatedScale=Me.paint.get("model-scale").evaluate(Le,{},Oe)}}evaluate(F,Me){const Le=this.getNodesInfo();for(const Oe of Le){if(!Oe.node.meshes)continue;const Le=Oe.feature,Fe=Me&&Me[Le.id];if($(Fe,Oe.state))continue;Oe.state=structuredClone(Fe);const je=Oe.node.meshes&&Oe.node.meshes[0].featureData,qe=Oe.evaluatedColor[2],He=Oe.evaluatedRMEA[2],xt=this.id.canonical;if(Oe.hasTranslucentParts=!1,je){for(let Me=0;Me<vb.length;Me++){const je=vb[Me];je.length&&(Le.properties.part=je);const qe=F.paint.get("model-color").evaluate(Le,Fe,xt).toRenderColor(null),He=F.paint.get("model-color-mix-intensity").evaluate(Le,Fe,xt);Oe.evaluatedColor[Me]=[qe.r,qe.g,qe.b,He],Oe.evaluatedRMEA[Me][0]=F.paint.get("model-roughness").evaluate(Le,Fe,xt),Oe.evaluatedRMEA[Me][2]=F.paint.get("model-emissive-strength").evaluate(Le,Fe,xt),Oe.evaluatedRMEA[Me][3]=qe.a,Oe.emissionHeightBasedParams[Me]=F.paint.get("model-height-based-emissive-strength-multiplier").evaluate(Le,Fe,xt),!Oe.hasTranslucentParts&&qe.a<1&&(Oe.hasTranslucentParts=!0)}delete Le.properties.part,Xy(Oe,qe!==Oe.evaluatedColor[2]||He!==Oe.evaluatedRMEA[2],this.modelTraits)}else Oe.evaluatedRMEA[0][2]=F.paint.get("model-emissive-strength").evaluate(Le,Fe,xt);Oe.evaluatedScale=F.paint.get("model-scale").evaluate(Le,Fe,xt),this.updatePbrBuffer(Oe.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(F,Me,Le,Oe){const Fe=F.findDEMTileFor(Le);if(Fe&&(Fe.tileID.canonical!==this.terrainTile||Me!==this.terrainExaggeration)){if(Fe.dem&&Fe.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=Fe.tileID.overscaledZ;const Me=Fy.create(F,Le,Fe);if(!Me)return;this.modelTraits&gb.HasMapboxMeshFeatures&&this.updateDEM(F,Me,Le,Oe);for(const F of this.getNodesInfo()){const Le=F.node;if(!Le.footprint||!Le.footprint.vertices||!Le.footprint.vertices.length)continue;const Oe=Le.footprint.vertices;let Fe=Me.getElevationAt(Oe[0].x,Oe[0].y,!0,!0);for(let F=1;F<Oe.length;F++)Fe=Math.min(Fe,Me.getElevationAt(Oe[F].x,Oe[F].y,!0,!0));Le.elevation=Fe}}this.terrainTile=Fe.tileID.canonical,this.terrainExaggeration=Me}}updateDEM(F,Me,Le,Oe){let Fe=Me._dem._modifiedForSources[Oe];if(void 0===Fe&&(Me._dem._modifiedForSources[Oe]=[],Fe=Me._dem._modifiedForSources[Oe]),Fe.includes(Le.canonical))return;const je=Me._dem.dim;Fe.push(Le.canonical);let qe=!1;for(const F of this.getNodesInfo()){const Le=F.node;if(!Le.footprint||!Le.footprint.grid)continue;const Oe=Le.footprint.grid,Fe=Me.tileCoordToPixel(Oe.min.x,Oe.min.y),He=Me.tileCoordToPixel(Oe.max.x,Oe.max.y),xt=Math.min(Math.min(je-He.y,Fe.x),Math.min(Fe.y,je-He.x));if(xt<0)continue;const Pt=Q(xt,2,5);let jt=Math.max(0,Fe.x-Pt),Gt=Math.max(0,Fe.y-Pt),bi=Math.min(He.x+Pt,je-1),wi=Math.min(He.y+Pt,je-1);for(let F=Gt;F<=wi;++F)for(let Me=jt;Me<=bi;++Me)xb[F*je+Me]=255;let qr=0,Xn=0;for(let F=0;F<Oe.cellsY;++F)for(let Le=0;Le<Oe.cellsX;++Le){if(!Oe.cells[F*Oe.cellsX+Le])continue;const Fe=Me.tileCoordToPixel(Oe.min.x+Le/Oe.xScale,Oe.min.y+F/Oe.yScale),qe=Me.tileCoordToPixel(Oe.min.x+(Le+1)/Oe.xScale,Oe.min.y+(F+1)/Oe.yScale);for(let F=Fe.y;F<=Math.min(qe.y+1,je-1);++F)for(let Le=Fe.x;Le<=Math.min(qe.x+1,je-1);++Le)255===xb[F*je+Le]&&(xb[F*je+Le]=0,qr+=Me.getElevationAtPixel(Le,F),Xn++)}const Yn=qr/Xn;jt=Math.max(1,Fe.x-Pt),Gt=Math.max(1,Fe.y-Pt),bi=Math.min(He.x+Pt,je-2),wi=Math.min(He.y+Pt,je-2),qe=!0;for(let F=Gt;F<=wi;++F)for(let Le=jt;Le<=bi;++Le)0===xb[F*je+Le]&&(yb[F*je+Le]=Me._dem.set(Le,F,Yn));for(let F=1;F<Pt;++F){jt=Math.max(1,Fe.x-F),Gt=Math.max(1,Fe.y-F),bi=Math.min(He.x+F,je-2),wi=Math.min(He.y+F,je-2);for(let Le=Gt;Le<=wi;++Le)for(let Oe=jt;Oe<=bi;++Oe){const Fe=Le*je+Oe;if(255===xb[Fe]){let qe=0,He=0,xt=-1,jt=-1;for(let Me=-1;Me<=1;++Me)for(let Fe=-1;Fe<=1;++Fe){const Pt=(Le+Me)*je+Oe+Fe;if(xb[Pt]>=F)continue;const Gt=yb[Pt],bi=Math.abs(Gt);bi>He&&(qe=Gt,He=bi,xt=Fe,jt=Me)}if(He>.1){const je=1-(F+.5*Math.abs(xt*jt))/Pt;let He=Me._dem.get(Oe,Le)+qe*je;const Gt=Me._dem.get(Oe+xt,Le+jt),bi=Me._dem.get(Oe-xt,Le-jt,!0);(He-Gt)*(He-bi)>0&&(He=(Gt+bi)/2),yb[Fe]=Me._dem.set(Oe,Le,He),xb[Fe]=F}}}}}qe&&(Me._demTile.needsDEMTextureUpload=!0,Me._dem._timestamp=eh.now())}setFilter(F){this.filter=F?Qs(F):null}getNodesInfo(){return this.filter?this.nodesInfo.filter((F=>this.filter.filter(new Rs(this.id.overscaledZ),F.feature,this.id.canonical))):this.nodesInfo}destroy(){const F=this.getNodesInfo();for(const Me of F)Ry(Me.node),Ly(Me.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(F,Me){if(Me.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=Me.updateTime;const Le=Me.getReplacementRegionsForTile(F.toUnwrapped()),Oe=this.getNodesInfo();for(let F=0;F<this.nodesInfo.length;F++){const Me=Oe[F].node;Oe[F].hiddenByReplacement=!!Me.footprint&&!Le.find((F=>F.footprint===Me.footprint))}}getHeightAtTileCoord(F,Me){const Le=this.getNodesInfo(),Oe=[],Fe=[0,0,0],je=bl.mat4.identity([]);for(let qe=0;qe<this.nodesInfo.length;qe++){const He=Le[qe],xt=He.node.meshes[0],Pt=xt.transformedAabb;if(F<Pt.min[0]||Me<Pt.min[1]||F>Pt.max[0]||Me>Pt.max[1])continue;if(!0===He.node.hidden)return{height:1/0,maxHeight:He.feature.properties.height,hidden:!1,verticalScale:He.evaluatedScale[2]};bl.mat4.invert(je,He.node.matrix),Fe[0]=F,Fe[1]=Me,bl.vec3.transformMat4(Fe,Fe,je);const jt=(Fe[0]-xt.aabb.min[0])/(xt.aabb.max[0]-xt.aabb.min[0])*_b|0,Gt=Math.min(63,(Fe[1]-xt.aabb.min[1])/(xt.aabb.max[1]-xt.aabb.min[1])*_b|0)*_b+Math.min(63,jt),bi=xt.heightmap[Gt];if(!(bi<0&&He.node.footprint)){if(He.hiddenByReplacement)return;return{height:bi,maxHeight:He.feature.properties.height,hidden:!1,verticalScale:He.evaluatedScale[2]}}if(He.node.footprint.grid.query(new ec(F,Me),new ec(F,Me),Oe),Oe.length>0)return{height:void 0,maxHeight:He.feature.properties.height,hidden:He.hiddenByReplacement,verticalScale:He.evaluatedScale[2]}}}}function Yy(F,Me){return!F.isLightConstant&&Me}function Hy(F,Me,Le,Oe,Fe,je,qe,He){let xt=(61440&Me|(61440&Me)>>4)>>8,Pt=(3840&Me|(3840&Me)>>4)>>4,jt=240&Me|(240&Me)>>4;Le[3]>0&&(xt=Ee(xt,255*Le[0],Le[3]),Pt=Ee(Pt,255*Le[1],Le[3]),jt=Ee(jt,255*Le[2],Le[3]));const Gt=xt<<8|Pt,bi=jt<<8|Math.floor(255*Oe[3]),wi=function(F){const Me=Q(F,0,2);return Math.min(Math.round(.5*Me*255),255)}(Oe[2])<<8|15*Oe[0]<<4|15*Oe[1],qr=Q(Fe[0],0,1),Xn=Q(Fe[1],0,1),Yn=Q(Fe[2],0,1),yo=Q(Fe[3],0,1);let bo,Ro,Do,zs;if(qr!==Xn&&qe!==je&&Xn!==qr){const F=qe-je;Ro=1/(F*(Xn-qr)),Do=-(je+F*qr)/(F*(Xn-qr));const Me=Q(Fe[4],-1,1);zs=Math.pow(10,Me),bo=255*Yn<<8|255*yo}else bo=65535,Ro=0,Do=1,zs=1;if(F.emplaceBack(Gt,bi,wi,bo,Ro,Do,zs),He){const F=He.length;He.clear();for(let Me=0;Me<F;Me++)He.emplaceBack(Gt,bi,wi,bo,Ro,Do,zs)}}function Xy(F,Me,Le){const Oe=F.node;let Fe=0;const je=Le&gb.HasMeshoptCompression;for(const Le of Oe.meshes){if(Oe.lights&&Oe.lightMeshIndex===Fe)continue;if(!Le.featureData)continue;Le.featureArray=new Qa,Le.featureArray.reserve(Le.featureData.length);let qe=Me;for(const Me of Le.featureData){const Fe=je?65535&Me:Me>>16&65535,He=je?Me>>16&65535:65535&Me,xt=(15&He)<8?15&He:0,Pt=F.evaluatedRMEA[xt],jt=F.evaluatedColor[xt],Gt=F.emissionHeightBasedParams[xt];let bi;if(qe&&2===xt&&Oe.lights&&(bi=new Qa,bi.resize(10*Oe.lights.length)),Hy(Le.featureArray,Fe,jt,Pt,Gt,Le.aabb.min[2],Le.aabb.max[2],bi),bi&&qe){qe=!1;const F=Oe.meshes[Oe.lightMeshIndex];F.featureArray=bi,F.featureArray._trim()}}Le.featureArray._trim(),Fe++}}function Zy(F,Me,Le,Oe){const Fe=1<<F.z;Me.lat=xl((Oe/np+F.y)/Fe),Me.lng=gl((Le/np+F.x)/Fe)}us(Gy,"Tiled3dModelBucket",{omit:["layers"]}),us($y,"Tiled3dModelFeature");const bb={circle:class extends ma{constructor(F,Me,Le,Oe){super(F,{layout:t_||(t_=new Xs({"circle-sort-key":new Ys(Cf.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Gs(Cf.layout_circle["circle-elevation-reference"]),visibility:new Gs(Cf.layout_circle.visibility)})),paint:i_||(i_=new Xs({"circle-radius":new Ys(Cf.paint_circle["circle-radius"]),"circle-color":new Ys(Cf.paint_circle["circle-color"]),"circle-blur":new Ys(Cf.paint_circle["circle-blur"]),"circle-opacity":new Ys(Cf.paint_circle["circle-opacity"]),"circle-translate":new Gs(Cf.paint_circle["circle-translate"]),"circle-translate-anchor":new Gs(Cf.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Gs(Cf.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Gs(Cf.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ys(Cf.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ys(Cf.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ys(Cf.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Gs(Cf.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe)}createBucket(F){return new Ll(F)}queryRadius(F){const Me=F;return Jl("circle-radius",this,Me)+Jl("circle-stroke-width",this,Me)+Ql(this.paint.get("circle-translate"))}queryIntersectsFeature(F,Me,Le,Oe,Fe,je,qe,He){const xt=eu(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),je.angle,F.pixelToTileUnitsFactor),Pt=this.paint.get("circle-radius").evaluate(Me,Le)+this.paint.get("circle-stroke-width").evaluate(Me,Le);return Ju(F,Oe,je,qe,He,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),xt,Pt)}getProgramIds(){return["circle"]}getDefaultProgramParams(F,Me,Le){const Oe=Ku(this);return{config:new $o(this,{zoom:Me,lut:Le}),defines:Oe,overrideFog:!1}}},heatmap:class extends ma{createBucket(F){return new nc(F)}constructor(F,Me,Le,Oe){super(F,{layout:x_||(x_=new Xs({visibility:new Gs(Cf.layout_heatmap.visibility)})),paint:v_||(v_=new Xs({"heatmap-radius":new Ys(Cf.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ys(Cf.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Gs(Cf.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Hs(Cf.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Gs(Cf.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(F){"heatmap-color"===F&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=dc({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(F){return Jl("heatmap-radius",this,F)}queryIntersectsFeature(F,Me,Le,Oe,Fe,je,qe,He){const xt=this.paint.get("heatmap-radius").evaluate(Me,Le);return Ju(F,Oe,je,qe,He,!0,!0,new ec(0,0),xt)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(F,Me,Le){return"heatmap"===F?{config:new $o(this,{zoom:Me,lut:Le}),overrideFog:!1}:{}}},hillshade:class extends ma{constructor(F,Me,Le,Oe){super(F,{layout:b_||(b_=new Xs({visibility:new Gs(Cf.layout_hillshade.visibility)})),paint:w_||(w_=new Xs({"hillshade-illumination-direction":new Gs(Cf.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Gs(Cf.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Gs(Cf.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Gs(Cf.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Gs(Cf.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Gs(Cf.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Gs(Cf.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(F,Me,Le){return{overrideFog:!1}}},fill:class extends ma{constructor(F,Me,Le,Oe){super(F,{layout:V_||(V_=new Xs({"fill-sort-key":new Ys(Cf.layout_fill["fill-sort-key"]),visibility:new Gs(Cf.layout_fill.visibility),"fill-elevation-reference":new Gs(Cf.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Ys(Cf.layout_fill["fill-construct-bridge-guard-rail"])})),paint:U_||(U_=new Xs({"fill-antialias":new Gs(Cf.paint_fill["fill-antialias"]),"fill-opacity":new Ys(Cf.paint_fill["fill-opacity"]),"fill-color":new Ys(Cf.paint_fill["fill-color"]),"fill-outline-color":new Ys(Cf.paint_fill["fill-outline-color"]),"fill-translate":new Gs(Cf.paint_fill["fill-translate"]),"fill-translate-anchor":new Gs(Cf.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ys(Cf.paint_fill["fill-pattern"]),"fill-emissive-strength":new Gs(Cf.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Ys(Cf.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Ys(Cf.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Ys(Cf.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe)}getProgramIds(){const F=this.paint.get("fill-pattern"),Me=F&&F.constantOr(1),Le=[Me?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&Le.push(Me&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),Le}getDefaultProgramParams(F,Me,Le){return{config:new $o(this,{zoom:Me,lut:Le}),overrideFog:!1}}recalculate(F,Me){super.recalculate(F,Me);const Le=this.paint._values["fill-outline-color"];"constant"===Le.value.kind&&void 0===Le.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(F){return new _h(F)}queryRadius(){return Ql(this.paint.get("fill-translate"))}queryIntersectsFeature(F,Me,Le,Oe,Fe,je){return!F.queryGeometry.isAboveHorizon&&Nl(tu(F.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),je.angle,F.pixelToTileUnitsFactor),Oe)}isTileClipped(){return 0===this.paint.get("fill-z-offset").constantOr(1)}is3D(F){if(0!==this.paint.get("fill-z-offset").constantOr(1))return!0;const Me=this.layout&&"none"!==this.layout.get("fill-elevation-reference");return null!=F?Me&&!F:Me}},"fill-extrusion":class extends ma{constructor(F,Me,Le,Oe){super(F,{layout:hg||(hg=new Xs({visibility:new Gs(Cf["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Gs(Cf["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:ug||(ug=new Xs({"fill-extrusion-opacity":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ys(Cf["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ys(Cf["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ys(Cf["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ys(Cf["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Ys(Cf["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Ys(Cf["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Ys(Cf["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Ys(Cf["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Gs(Cf["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(F){return new vp(F)}queryRadius(){return Ql(this.paint.get("fill-extrusion-translate"))}is3D(F){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt=eu(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),je.angle,F.pixelToTileUnitsFactor),jt=this.paint.get("fill-extrusion-height").evaluate(Me,Le),Gt=this.paint.get("fill-extrusion-base").evaluate(Me,Le),bi=[0,0],wi=He&&je.elevation,qr=je.elevation?je.elevation.exaggeration():1,Xn=F.tile.getBucket(this);if(wi&&Xn instanceof vp){const F=Xn.centroidVertexArray,Me=xt+1;Me<F.length&&(bi[0]=F.geta_centroid_pos0(Me),bi[1]=F.geta_centroid_pos1(Me))}if(0===bi[0]&&1===bi[1])return!1;"globe"===je.projection.name&&(Oe=Ep([Oe],[new ec(0,0),new ec(np,np)],F.tileID.canonical).map((F=>F.polygon)).flat());const Yn=wi?He:null,[yo,bo]=function(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt){return"globe"===F.projection.name?function(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt){const Gt=[],bi=[],wi=F.projection.upVectorScale(jt,F.center.lat,F.worldSize).metersToTile,qr=[0,0,0,1],Xn=[0,0,0,1],y=(F,Me,Le,Oe)=>{F[0]=Me,F[1]=Le,F[2]=Oe,F[3]=1},Yn=Pp();Le>0&&(Le+=Yn),Oe+=Yn;for(const Yn of Me){const Me=[],yo=[];for(const Gt of Yn){const bi=Gt.x+Fe.x,Yn=Gt.y+Fe.y,bo=F.projection.projectTilePoint(bi,Yn,jt),Ro=F.projection.upVector(jt,Gt.x,Gt.y);let Do=Le,zs=Oe;if(qe){const F=Cp(bi,Yn,Le,Oe,qe,He,xt,Pt);Do+=F.base,zs+=F.top}0!==Le?y(qr,bo.x+Ro[0]*wi*Do,bo.y+Ro[1]*wi*Do,bo.z+Ro[2]*wi*Do):y(qr,bo.x,bo.y,bo.z),y(Xn,bo.x+Ro[0]*wi*zs,bo.y+Ro[1]*wi*zs,bo.z+Ro[2]*wi*zs),bl.vec3.transformMat4(qr,qr,je),bl.vec3.transformMat4(Xn,Xn,je),Me.push(new Rh(qr[0],qr[1],qr[2])),yo.push(new Rh(Xn[0],Xn[1],Xn[2]))}Gt.push(Me),bi.push(yo)}return[Gt,bi]}(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt):qe?function(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt=[],jt=[],Gt=[0,0,0,1];for(const bi of F){const F=[],wi=[];for(const Pt of bi){const jt=Pt.x+Oe.x,bi=Pt.y+Oe.y,qr=Cp(jt,bi,Me,Le,je,qe,He,xt);Gt[0]=jt,Gt[1]=bi,Gt[2]=qr.base,Gt[3]=1,bl.vec4.transformMat4(Gt,Gt,Fe),Gt[3]=Math.max(Gt[3],1e-5);const Xn=new Rh(Gt[0]/Gt[3],Gt[1]/Gt[3],Gt[2]/Gt[3]);Gt[0]=jt,Gt[1]=bi,Gt[2]=qr.top,Gt[3]=1,bl.vec4.transformMat4(Gt,Gt,Fe),Gt[3]=Math.max(Gt[3],1e-5);const Yn=new Rh(Gt[0]/Gt[3],Gt[1]/Gt[3],Gt[2]/Gt[3]);F.push(Xn),wi.push(Yn)}Pt.push(F),jt.push(wi)}return[Pt,jt]}(Me,Le,Oe,Fe,je,qe,He,xt,Pt):function(F,Me,Le,Oe,Fe){const je=[],qe=[],He=Fe[8]*Me,xt=Fe[9]*Me,Pt=Fe[10]*Me,jt=Fe[11]*Me,Gt=Fe[8]*Le,bi=Fe[9]*Le,wi=Fe[10]*Le,qr=Fe[11]*Le;for(const Me of F){const F=[],Le=[];for(const je of Me){const Me=je.x+Oe.x,qe=je.y+Oe.y,Xn=Fe[0]*Me+Fe[4]*qe+Fe[12],Yn=Fe[1]*Me+Fe[5]*qe+Fe[13],yo=Fe[2]*Me+Fe[6]*qe+Fe[14],bo=Fe[3]*Me+Fe[7]*qe+Fe[15],Ro=Xn+He,Do=Yn+xt,zs=yo+Pt,Zs=Math.max(bo+jt,1e-5),na=Xn+Gt,el=Yn+bi,nl=yo+wi,hl=Math.max(bo+qr,1e-5);F.push(new Rh(Ro/Zs,Do/Zs,zs/Zs)),Le.push(new Rh(na/hl,el/hl,nl/hl))}je.push(F),qe.push(Le)}return[je,qe]}(Me,Le,Oe,Fe,je)}(je,Oe,Gt,jt,Pt,qe,Yn,bi,qr,je.center.lat,F.tileID.canonical),Ro=F.queryGeometry;return function(F,Me,Le){let Oe=1/0;Nl(Le,Me)&&(Oe=Vp(Le,Me[0]));for(let Fe=0;Fe<Me.length;Fe++){const je=Me[Fe],qe=F[Fe];for(let F=0;F<je.length-1;F++){const Me=je[F],Fe=[Me,je[F+1],qe[F+1],qe[F],Me];Fl(Le,Fe)&&(Oe=Math.min(Oe,Vp(Le,Fe)))}}return Oe!==1/0&&Oe}(yo,bo,Ro.isPointQuery()?Ro.screenBounds:Ro.screenGeometry)}},line:class extends ma{constructor(F,Me,Le,Oe){const Fe=nf();super(F,Fe,Me,Le,Oe),Fe.layout&&(this.layout=new $s(Fe.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(F){if("line-gradient"===F){const F=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=F._styleExpression&&F._styleExpression.expression instanceof Un,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(F,Me){super.recalculate(F,Me),this.paint._values["line-floorwidth"]=(()=>{if(Ty)return Ty;const F=nf();return Ty=new sf(F.paint.properties["line-width"].specification),Ty.useIntegerZoom=!0,Ty})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,F)}createBucket(F){return new Yp(F)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(F,Me,Le){const Oe=tf(this);return{config:new $o(this,{zoom:Me,lut:Le}),defines:Oe,overrideFog:!1}}queryRadius(F){const Me=F,Le=of(Jl("line-width",this,Me),Jl("line-gap-width",this,Me)),Oe=Jl("line-offset",this,Me);return Le/2+Math.abs(Oe)+Ql(this.paint.get("line-translate"))}queryIntersectsFeature(F,Me,Le,Oe,Fe,je){if(F.queryGeometry.isAboveHorizon)return!1;const qe=tu(F.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),je.angle,F.pixelToTileUnitsFactor),He=F.pixelToTileUnitsFactor/2*of(this.paint.get("line-width").evaluate(Me,Le),this.paint.get("line-gap-width").evaluate(Me,Le)),xt=this.paint.get("line-offset").evaluate(Me,Le);return xt&&(Oe=function(F,Me){const Le=[],Oe=new ec(0,0);for(let Fe=0;Fe<F.length;Fe++){const je=F[Fe],qe=[];for(let F=0;F<je.length;F++){const Le=je[F],Fe=je[F+1],He=0===F?Oe:Le.sub(je[F-1])._unit()._perp(),xt=F===je.length-1?Oe:Fe.sub(Le)._unit()._perp(),Pt=He._add(xt)._unit();Pt._mult(1/(Pt.x*xt.x+Pt.y*xt.y)),qe.push(Pt._mult(Me)._add(Le))}Le.push(qe)}return Le}(Oe,xt*F.pixelToTileUnitsFactor)),function(F,Me,Le){for(let Oe=0;Oe<Me.length;Oe++){const Fe=Me[Oe];if(F.length>=3)for(let Me=0;Me<Fe.length;Me++)if(Hl(F,Fe[Me]))return!0;if(Ul(F,Fe,Le))return!0}return!1}(qe,Oe,He)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(F){return!this.hasElevatedBuckets}},symbol:Dm,background:class extends ma{constructor(F,Me,Le,Oe){super(F,{layout:Fv||(Fv=new Xs({visibility:new Gs(Cf.layout_background.visibility)})),paint:qv||(qv=new Xs({"background-pitch-alignment":new Gs(Cf.paint_background["background-pitch-alignment"]),"background-color":new Gs(Cf.paint_background["background-color"]),"background-pattern":new Gs(Cf.paint_background["background-pattern"]),"background-opacity":new Gs(Cf.paint_background["background-opacity"]),"background-emissive-strength":new Gs(Cf.paint_background["background-emissive-strength"]),"background-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(F,Me,Le){return{overrideFog:!1}}is3D(F){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:Wm,"raster-particle":ry,sky:class extends ma{constructor(F,Me,Le,Oe){super(F,{layout:ib||(ib=new Xs({visibility:new Gs(Cf.layout_sky.visibility)})),paint:rb||(rb=new Xs({"sky-type":new Gs(Cf.paint_sky["sky-type"]),"sky-atmosphere-sun":new Gs(Cf.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Gs(Cf.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Gs(Cf.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Gs(Cf.paint_sky["sky-gradient-radius"]),"sky-gradient":new Hs(Cf.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Gs(Cf.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Gs(Cf.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Gs(Cf.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(F){"sky-gradient"===F?this._updateColorRamp():"sky-atmosphere-sun"!==F&&"sky-atmosphere-halo-color"!==F&&"sky-atmosphere-color"!==F&&"sky-atmosphere-sun-intensity"!==F||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=dc({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(F){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const Me=F.style.light.properties.get("position");return this._lightPosition.azimuthal!==Me.azimuthal||this._lightPosition.polar!==Me.polar}return!1}getCenter(F,Me){if("atmosphere"===this.paint.get("sky-type")){const Le=this.paint.get("sky-atmosphere-sun"),Oe=!Le,Fe=F.style.light,je=Fe.properties.get("position");return Oe&&"viewport"===Fe.properties.get("anchor")&&pt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),Oe?iy(je.azimuthal,90-je.polar,Me):iy(Le[0],90-Le[1],Me)}const Le=this.paint.get("sky-gradient-center");return iy(Le[0],90-Le[1],Me)}isSky(){return!0}markSkyboxValid(F){this._skyboxInvalidated=!1,this._lightPosition=F.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const F=this.paint.get("sky-type");return"atmosphere"===F?["skyboxCapture","skybox"]:"gradient"===F?["skyboxGradient"]:null}},slot:class extends ma{constructor(F,Me,Le,Oe){super(F,{paint:nb||(nb=new Xs({}))},Me,null)}},model:class extends ma{constructor(F,Me,Le,Oe){super(F,{layout:fb||(fb=new Xs({visibility:new Gs(Cf.layout_model.visibility),"model-id":new Ys(Cf.layout_model["model-id"])})),paint:mb||(mb=new Xs({"model-opacity":new Ys(Cf.paint_model["model-opacity"]),"model-rotation":new Ys(Cf.paint_model["model-rotation"]),"model-scale":new Ys(Cf.paint_model["model-scale"]),"model-translation":new Ys(Cf.paint_model["model-translation"]),"model-color":new Ys(Cf.paint_model["model-color"]),"model-color-mix-intensity":new Ys(Cf.paint_model["model-color-mix-intensity"]),"model-type":new Gs(Cf.paint_model["model-type"]),"model-cast-shadows":new Gs(Cf.paint_model["model-cast-shadows"]),"model-receive-shadows":new Gs(Cf.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Gs(Cf.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Ys(Cf.paint_model["model-emissive-strength"]),"model-roughness":new Ys(Cf.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Ys(Cf.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Gs(Cf.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Gs(Cf.paint_model["model-front-cutoff"]),"model-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Me,Le,Oe),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(F){return new Py(F)}getProgramIds(){return["model"]}is3D(F){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(F){return F instanceof Gy?np-1:0}queryIntersectsFeature(F,Me,Le,Oe,Fe,je){if(!this.modelManager)return!1;const qe=this.modelManager,He=F.tile.getBucket(this);if(!(He&&He instanceof Py))return!1;for(const Le in He.instancesPerModel){const Oe=He.instancesPerModel[Le],Fe=void 0!==Me.id?Me.id:Me.properties&&Me.properties.hasOwnProperty("id")?Me.properties.id:void 0;if(Oe.idToFeaturesIndex.hasOwnProperty(Fe)){const Me=Oe.features[Oe.idToFeaturesIndex[Fe]],xt=qe.getModel(Le,this.scope);if(!xt)return!1;let Pt=bl.mat4.create();const jt=new ul(0,0),Gt=He.canonical;let bi=Number.MAX_VALUE;for(let Le=0;Le<Me.instancedDataCount;++Le){const Fe=16*(Me.instancedDataOffset+Le),qe=Oe.instancedDataArray.float32,He=[qe[Fe+4],qe[Fe+5],qe[Fe+6]];Zy(Gt,jt,qe[Fe],0|qe[Fe+1]),By(Pt,xt,je,jt,Me.rotation,Me.scale,He,!1,!1,!1),"globe"===je.projection.name&&(Pt=fy(Pt,je));const wi=bl.mat4.multiply([],je.projMatrix,Pt),qr=F.queryGeometry,Xn=dy(qr.isPointQuery()?qr.screenBounds:qr.screenGeometry,je,wi,xt.aabb);null!=Xn&&(bi=Math.min(Xn,bi))}return bi!==Number.MAX_VALUE&&bi}}return!1}_handleOverridablePaintPropertyUpdate(F,Me,Le){return!(!this.layout||Me.isDataDriven()||Le.isDataDriven()||"model-color"!==F&&"model-color-mix-intensity"!==F&&"model-rotation"!==F&&"model-scale"!==F&&"model-translation"!==F&&"model-emissive-strength"!==F)}_isPropertyZoomDependent(F){const Me=this._transitionablePaint._values[F];return null!=Me&&null!=Me.value&&null!=Me.value.expression&&Me.value.expression instanceof ts}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends ma{constructor(F,Me,Le,Oe){super(F,{layout:j_||(j_=new Xs({"clip-layer-types":new Gs(Cf.layout_clip["clip-layer-types"]),"clip-layer-scope":new Gs(Cf.layout_clip["clip-layer-scope"])})),paint:G_||(G_=new Xs({}))},Me,Le,Oe)}recalculate(F,Me){super.recalculate(F,Me)}createBucket(F){return new Eh(F)}is3D(F){return!0}}};class Ky{constructor(F){this._callback=F,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class Jy{constructor(){this.tasks={},this.taskQueue=[],ot(["process"],this),this.invoker=new Ky(this.process),this.nextId=0}add(F,Me){const Le=this.nextId++,Oe=function({type:F,isSymbolTile:Me,zoom:Le}){return Le=Le||0,"message"===F?0:"maybePrepare"!==F||Me?"parseTile"!==F||Me?"parseTile"===F&&Me?300-Le:"maybePrepare"===F&&Me?400-Le:500:200-Le:100-Le}(Me);if(0===Oe){try{F()}finally{}return null}return this.tasks[Le]={fn:F,metadata:Me,priority:Oe,id:Le},this.taskQueue.push(Le),this.invoker.trigger(),{cancel:()=>{delete this.tasks[Le]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((F=>!!this.tasks[F])),!this.taskQueue.length)return;const F=this.pick();if(null===F)return;const Me=this.tasks[F];if(delete this.tasks[F],this.taskQueue.length&&this.invoker.trigger(),!Me)return;Me.fn()}finally{}}pick(){let F=null,Me=1/0;for(let Le=0;Le<this.taskQueue.length;Le++){const Oe=this.tasks[this.taskQueue[Le]];Oe.priority<Me&&(Me=Oe.priority,F=Le)}if(null===F)return null;const Le=this.taskQueue[F];return this.taskQueue.splice(F,1),Le}remove(){this.invoker.remove()}}class Qy{constructor(F,Me,Le){this.target=F,this.parent=Me,this.mapId=Le,this.callbacks={},this.cancelCallbacks={},ot(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new Jy}send(F,Me,Le,Oe,Fe=!1,je){const qe=Math.round(1e18*Math.random()).toString(36).substring(0,10);Le&&(Le.metadata=je,this.callbacks[qe]=Le);const He=new Set;return this.target.postMessage({id:qe,type:F,hasCallback:!!Le,targetMapId:Oe,mustQueue:Fe,sourceMapId:this.mapId,data:ps(Me,He)},He),{cancel:()=>{Le&&delete this.callbacks[qe],this.target.postMessage({id:qe,type:"<cancel>",targetMapId:Oe,sourceMapId:this.mapId})}}}receive(F){const Me=F.data;if(!Me)return;const Le=Me.id;if(Le&&(!Me.targetMapId||this.mapId===Me.targetMapId))if("<cancel>"===Me.type){const F=this.cancelCallbacks[Le];delete this.cancelCallbacks[Le],F&&F.cancel()}else if(Me.mustQueue||yt()){const F=this.callbacks[Le],Oe=this.scheduler.add((()=>this.processTask(Le,Me)),F&&F.metadata||{type:"message"});Oe&&(this.cancelCallbacks[Le]=Oe)}else this.processTask(Le,Me)}processTask(F,Me){if(delete this.cancelCallbacks[F],"<response>"===Me.type){const Le=this.callbacks[F];delete this.callbacks[F],Le&&(Me.error?Le(fs(Me.error)):Le(null,fs(Me.data)))}else{const Le=new Set,Oe=Me.hasCallback?(Me,Oe)=>{this.target.postMessage({id:F,type:"<response>",sourceMapId:this.mapId,error:Me?ps(Me):null,data:ps(Oe,Le)},Le)}:()=>{},Fe=fs(Me.data);if(this.parent[Me.type])this.parent[Me.type](Me.sourceMapId,Fe,Oe);else if(this.parent.getWorkerSource){const F=Me.type.split(".");this.parent.getWorkerSource(Me.sourceMapId,F[0],Fe.source,Fe.scope)[F[1]](Fe,Oe)}else Oe(new Error(`Could not find function ${Me.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var wb={workerUrl:"",workerClass:null,workerParams:void 0};const Tb="mapboxgl_preloaded_worker_pool";class rg{constructor(){this.active={}}acquire(F,Me=rg.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<Me;)this.workers.push(null!=wb.workerClass?new wb.workerClass:new self.Worker(wb.workerUrl,wb.workerParams));return this.active[F]=!0,this.workers.slice()}release(F){delete this.active[F],this.workers&&0===this.numActive()&&(this.workers.forEach((F=>{F.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Tb]}numActive(){return Object.keys(this.active).length}}rg.workerCount=2;class ng{constructor(F,Me,Le="Worker",Oe=rg.workerCount){this.workerPool=F,this.actors=[],this.currentActor=0,this.id=st();const Fe=this.workerPool.acquire(this.id,Oe);for(let F=0;F<Fe.length;F++){const Oe=new ng.Actor(Fe[F],Me,this.id);Oe.name=`${Le} ${F}`,this.actors.push(Oe)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(F,Me,Le){rt(this.actors,((Le,Oe)=>{Le.send(F,Me,Oe)}),Le=Le||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((F=>{F.remove()})),this.actors=[],this.workerPool.release(this.id)}}let Sb,Eb;function ag(){return Sb||(Sb=new rg),Sb}ng.Actor=Qy;const Mb=new Se(0,0,0);var Ab=(F=>(F[F.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",F[F.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",F[F.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",F))(Ab||{}),Ib=(F=>(F[F.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",F[F.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",F[F.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",F[F.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",F))(Ib||{}),Cb=(F=>(F[F.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",F[F.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",F[F.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",F[F.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",F[F.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",F))(Cb||{}),Pb=(F=>(F[F.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",F[F.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",F[F.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",F))(Pb||{}),zb=(F=>(F[F.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",F[F.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",F[F.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",F[F.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",F[F.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",F[F.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",F))(zb||{}),Rb=(F=>(F[F.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",F[F.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",F[F.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",F))(Rb||{});function dg(F,Me,Le){1===F&&Me.icons.push(function(F,Me){return function(F){if(F.usvg_tree.height||(F.usvg_tree.height=F.usvg_tree.width),!F.metadata)return F;const{metadata:Me}=F;if(Me.content_area){const{content_area:Le}=Me;null==Le.top&&(Le.top=Le.left),null==Le.width&&(Le.width=F.usvg_tree.width),null==Le.height&&(Le.height=Le.width)}return Me.stretch_x&&Me.stretch_x.length&&mg(Me,"x"),Me.stretch_y&&Me.stretch_y.length&&mg(Me,"y"),F}(F.readFields(yg,{name:void 0},Me))}(Le,Le.readVarint()+Le.pos))}function mg(F,Me){const Le=[],Oe=F[`stretch_${Me}`];let Fe=null;for(let F=0;F<Oe.length;F++)null===Fe?Fe=0===Le.length?Oe[0]:Le[Le.length-1][1]+Oe[F]:(Le.push([Fe,Fe+Oe[F]]),Fe=null);F[`stretch_${Me}_areas`]=Le}function yg(F,Me,Le){1===F?Me.name=Le.readString():2===F?Me.metadata=function(F,Me){return F.readFields(gg,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},Me)}(Le,Le.readVarint()+Le.pos):3===F&&(Me.usvg_tree=function(F,Me){return F.readFields(bg,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},Me)}(Le,Le.readVarint()+Le.pos),Me.data="usvg_tree")}function gg(F,Me,Le){1===F?Me.stretch_x=Le.readPackedVarint():2===F?Me.stretch_y=Le.readPackedVarint():3===F?Me.content_area=function(F,Me){return F.readFields(xg,{left:0},Me)}(Le,Le.readVarint()+Le.pos):4===F&&Me.variables.push(function(F,Me){return F.readFields(vg,{name:void 0},Me)}(Le,Le.readVarint()+Le.pos))}function xg(F,Me,Le){1===F?Me.left=Le.readVarint():2===F?Me.width=Le.readVarint():3===F?Me.top=Le.readVarint():4===F&&(Me.height=Le.readVarint())}function vg(F,Me,Le){1===F?Me.name=Le.readString():2===F&&(Me.rgb_color=Eg(Le.readVarint()),Me.value="rgb_color")}function bg(F,Me,Le){1===F?Me.width=Me.height=Le.readVarint():2===F?Me.height=Le.readVarint():3===F?Me.children.push(_g(Le,Le.readVarint()+Le.pos)):4===F?Me.linear_gradients.push(function(F,Me){return F.readFields(kg,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},Me)}(Le,Le.readVarint()+Le.pos)):5===F?Me.radial_gradients.push(function(F,Me){return F.readFields(Vg,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},Me)}(Le,Le.readVarint()+Le.pos)):7===F?Me.clip_paths.push(function(F,Me){return F.readFields(Cg,{children:[]},Me)}(Le,Le.readVarint()+Le.pos)):8===F&&Me.masks.push(function(F,Me){const Le=F.readFields(Dg,{left:0,width:20,mask_type:1,children:[]},Me);return null==Le.height&&(Le.height=Le.width),null==Le.top&&(Le.top=Le.left),Le}(Le,Le.readVarint()+Le.pos))}function _g(F,Me){return F.readFields(wg,{},Me)}function wg(F,Me,Le){1===F?(Me.group=function(F,Me){return F.readFields(Mg,{opacity:255,children:[]},Me)}(Le,Le.readVarint()+Le.pos),Me.node="group"):2===F&&(Me.path=function(F,Me){return F.readFields(Sg,{paint_order:1,commands:[],step:1,diffs:[],rule:1},Me)}(Le,Le.readVarint()+Le.pos),Me.node="path")}function Mg(F,Me,Le){1===F?Me.transform=Ag(Le,Le.readVarint()+Le.pos):2===F?Me.opacity=Le.readVarint():5===F?Me.clip_path_idx=Le.readVarint():6===F?Me.mask_idx=Le.readVarint():7===F&&Me.children.push(_g(Le,Le.readVarint()+Le.pos))}function Ag(F,Me){return F.readFields(Ig,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},Me)}function Ig(F,Me,Le){1===F?Me.sx=Le.readFloat():2===F?Me.ky=Le.readFloat():3===F?Me.kx=Le.readFloat():4===F?Me.sy=Le.readFloat():5===F?Me.tx=Le.readFloat():6===F&&(Me.ty=Le.readFloat())}function Sg(F,Me,Le){1===F?Me.fill=function(F,Me){return F.readFields(Pg,{rgb_color:Mb,paint:"rgb_color",opacity:255},Me)}(Le,Le.readVarint()+Le.pos):2===F?Me.stroke=function(F,Me){return F.readFields(zg,{rgb_color:Mb,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},Me)}(Le,Le.readVarint()+Le.pos):3===F?Me.paint_order=Le.readVarint():5===F?Le.readPackedVarint(Me.commands):6===F?Me.step=Le.readFloat():7===F?Le.readPackedSVarint(Me.diffs):8===F&&(Me.rule=Le.readVarint())}function Pg(F,Me,Le){1===F?(Me.rgb_color=Eg(Le.readVarint()),Me.paint="rgb_color"):2===F?(Me.linear_gradient_idx=Le.readVarint(),Me.paint="linear_gradient_idx"):3===F?(Me.radial_gradient_idx=Le.readVarint(),Me.paint="radial_gradient_idx"):5===F&&(Me.opacity=Le.readVarint())}function Eg(F){return new Se((F>>16&255)/255,(F>>8&255)/255,(255&F)/255,1)}function zg(F,Me,Le){1===F?(Me.rgb_color=Eg(Le.readVarint()),Me.paint="rgb_color"):2===F?(Me.linear_gradient_idx=Le.readVarint(),Me.paint="linear_gradient_idx"):3===F?(Me.radial_gradient_idx=Le.readVarint(),Me.paint="radial_gradient_idx"):5===F?Le.readPackedFloat(Me.dasharray):6===F?Me.dashoffset=Le.readFloat():7===F?Me.miterlimit=Le.readFloat():8===F?Me.opacity=Le.readVarint():9===F?Me.width=Le.readFloat():10===F?Me.linecap=Le.readVarint():11===F&&(Me.linejoin=Le.readVarint())}function kg(F,Me,Le){1===F?Me.transform=Ag(Le,Le.readVarint()+Le.pos):2===F?Me.spread_method=Le.readVarint():3===F?Me.stops.push(Tg(Le,Le.readVarint()+Le.pos)):4===F?Me.x1=Le.readFloat():5===F?Me.y1=Le.readFloat():6===F?Me.x2=Le.readFloat():7===F&&(Me.y2=Le.readFloat())}function Tg(F,Me){return F.readFields(Bg,{offset:0,opacity:255,rgb_color:Mb},Me)}function Bg(F,Me,Le){1===F?Me.offset=Le.readFloat():2===F?Me.opacity=Le.readVarint():3===F&&(Me.rgb_color=Eg(Le.readVarint()))}function Vg(F,Me,Le){1===F?Me.transform=Ag(Le,Le.readVarint()+Le.pos):2===F?Me.spread_method=Le.readVarint():3===F?Me.stops.push(Tg(Le,Le.readVarint()+Le.pos)):4===F?Me.cx=Le.readFloat():5===F?Me.cy=Le.readFloat():6===F?Me.r=Le.readFloat():7===F?Me.fx=Le.readFloat():8===F?Me.fy=Le.readFloat():9===F&&(Me.fr=Le.readFloat())}function Cg(F,Me,Le){1===F?Me.transform=Ag(Le,Le.readVarint()+Le.pos):2===F?Me.clip_path_idx=Le.readVarint():3===F&&Me.children.push(_g(Le,Le.readVarint()+Le.pos))}function Dg(F,Me,Le){1===F?Me.left=Me.top=Le.readFloat():2===F?Me.width=Me.height=Le.readFloat():3===F?Me.top=Le.readFloat():4===F?Me.height=Le.readFloat():5===F?Me.mask_type=Le.readVarint():6===F?Me.mask_idx=Le.readVarint():7===F&&Me.children.push(_g(Le,Le.readVarint()+Le.pos))}class Rg{static calculate(F={},Me=[]){const Le=new Map,Oe=new Map;if(0===Object.keys(F).length)return Le;Me.forEach((F=>{Oe.set(F.name,F.rgb_color||new Se(0,0,0))}));for(const[Me,Fe]of Object.entries(F))Oe.has(Me)?Le.set(Oe.get(Me).toStringPremultipliedAlpha(),Fe):console.warn(`Ignoring unknown image variable "${Me}"`);return Le}}function Lg(F,Me=255,Le){const Oe=Me/255,Fe=F.toStringPremultipliedAlpha(),je=Le.has(Fe)?Le.get(Fe).clone():F.clone();return je.a*=Oe,je.toString()}function Fg(F,Me){if(!Vt()){const Le=document.createElement("canvas");return Le.width=F,Le.height=Me,Le}return new OffscreenCanvas(F,Me)}function Og(F,Me){const Le=Rg.calculate(Me.params,F.metadata?F.metadata.variables:[]),Oe=F.usvg_tree,Fe=Oe.width,je=Oe.height,qe=Me.transform?Me.transform:new DOMMatrix,He=Math.max(1,Math.round(Fe*qe.a)),xt=Math.max(1,Math.round(je*qe.d)),Pt=new DOMMatrix([He/Fe,0,0,xt/je,0,0]),jt=Fg(He,xt).getContext("2d");return Ng(jt,Pt,Oe,Oe,Le),jt.getImageData(0,0,He,xt)}function Ng(F,Me,Le,Oe,Fe){for(const je of Oe.children)Ug(F,Me,Le,je,Fe)}function Ug(F,Me,Le,Oe,Fe){Oe.group?(F.save(),function(F,Me,Le,Oe,Fe){const je=null!=Oe.mask_idx?Le.masks[Oe.mask_idx]:null,qe=null!=Oe.clip_path_idx?Le.clip_paths[Oe.clip_path_idx]:null;if(Oe.transform&&(Me=Wg(Oe.transform).preMultiplySelf(Me)),!function(F,Me,Le){return 255!==F.opacity||Me||Le}(Oe,null!=qe,null!=je))return void Ng(F,Me,Le,Oe,Fe);const He=Fg(F.canvas.width,F.canvas.height),xt=He.getContext("2d");Ng(xt,Me,Le,Oe,Fe),qe&&Xg(xt,Me,Le,qe),je&&Zg(xt,Me,Le,je,Fe),F.globalAlpha=Oe.opacity/255,F.drawImage(He,0,0)}(F,Me,Le,Oe.group,Fe),F.restore()):Oe.path&&(F.save(),function(F,Me,Le,Oe,Fe){const je=Kg(Oe);F.setTransform(Me),Oe.paint_order===Pb.PAINT_ORDER_FILL_AND_STROKE?(jg(F,Le,Oe,je,Fe),$g(F,Le,Oe,je,Fe)):($g(F,Le,Oe,je,Fe),jg(F,Le,Oe,je,Fe))}(F,Me,Le,Oe.path,Fe),F.restore())}function jg(F,Me,Le,Oe,Fe){const je=Le.fill;if(!je)return;const qe=je.opacity/255;switch(je.paint){case"rgb_color":F.fillStyle=Lg(je.rgb_color,je.opacity,Fe);break;case"linear_gradient_idx":F.fillStyle=Gg(F,Me.linear_gradients[je.linear_gradient_idx],qe,Fe);break;case"radial_gradient_idx":F.fillStyle=Yg(F,Me.radial_gradients[je.radial_gradient_idx],qe,Fe)}F.fill(Oe,qg(Le))}function qg(F){return F.rule===Ab.PATH_RULE_NON_ZERO?"nonzero":F.rule===Ab.PATH_RULE_EVEN_ODD?"evenodd":void 0}function $g(F,Me,Le,Oe,Fe){const je=Le.stroke;if(!je)return;F.lineWidth=je.width,F.miterLimit=je.miterlimit,F.setLineDash(je.dasharray),F.lineDashOffset=je.dashoffset;const qe=je.opacity/255;switch(je.paint){case"rgb_color":F.strokeStyle=Lg(je.rgb_color,je.opacity,Fe);break;case"linear_gradient_idx":F.strokeStyle=Gg(F,Me.linear_gradients[je.linear_gradient_idx],qe,Fe);break;case"radial_gradient_idx":F.strokeStyle=Yg(F,Me.radial_gradients[je.radial_gradient_idx],qe,Fe)}switch(je.linejoin){case Cb.LINE_JOIN_MITER_CLIP:case Cb.LINE_JOIN_MITER:F.lineJoin="miter";break;case Cb.LINE_JOIN_ROUND:F.lineJoin="round";break;case Cb.LINE_JOIN_BEVEL:F.lineJoin="bevel"}switch(je.linecap){case Ib.LINE_CAP_BUTT:F.lineCap="butt";break;case Ib.LINE_CAP_ROUND:F.lineCap="round";break;case Ib.LINE_CAP_SQUARE:F.lineCap="square"}F.stroke(Oe)}function Gg(F,Me,Le,Oe){if(1===Me.stops.length){const F=Me.stops[0];return Lg(F.rgb_color,F.opacity*Le,Oe)}const Fe=Wg(Me.transform),{x1:je,y1:qe,x2:He,y2:xt}=Me,Pt=Fe.transformPoint(new DOMPoint(je,qe)),jt=Fe.transformPoint(new DOMPoint(He,xt)),Gt=F.createLinearGradient(Pt.x,Pt.y,jt.x,jt.y);for(const F of Me.stops)Gt.addColorStop(F.offset,Lg(F.rgb_color,F.opacity*Le,Oe));return Gt}function Yg(F,Me,Le,Oe){if(1===Me.stops.length){const F=Me.stops[0];return Lg(F.rgb_color,F.opacity*Le,Oe)}const Fe=Wg(Me.transform),{fx:je,fy:qe,cx:He,cy:xt}=Me,Pt=Fe.transformPoint(new DOMPoint(je,qe)),jt=Fe.transformPoint(new DOMPoint(He,xt)),Gt=F.createRadialGradient(Pt.x,Pt.y,0,jt.x,jt.y,Me.r*((Fe.a+Fe.d)/2));for(const F of Me.stops)Gt.addColorStop(F.offset,Lg(F.rgb_color,F.opacity*Le,Oe));return Gt}function Hg(F,Me,Le,Oe){const Fe=Oe.transform?Wg(Oe.transform).preMultiplySelf(Me):Me,je=Fg(F.canvas.width,F.canvas.height),qe=je.getContext("2d");for(const F of Oe.children)if(F.group)Hg(qe,Fe,Le,F.group);else if(F.path){const Me=F.path,Le=new Path2D;Le.addPath(Kg(Me),Fe),qe.fill(Le,qg(Me))}const He=null!=Oe.clip_path_idx?Le.clip_paths[Oe.clip_path_idx]:null;He&&Xg(qe,Fe,Le,He),F.globalCompositeOperation="source-over",F.drawImage(je,0,0)}function Xg(F,Me,Le,Oe){const Fe=Fg(F.canvas.width,F.canvas.height);Hg(Fe.getContext("2d"),Me,Le,Oe),F.globalCompositeOperation="destination-in",F.drawImage(Fe,0,0)}function Zg(F,Me,Le,Oe,Fe){if(0===Oe.children.length)return;const je=null!=Oe.mask_idx?Le.masks[Oe.mask_idx]:null;je&&Zg(F,Me,Le,je,Fe);const qe=F.canvas.width,He=F.canvas.height,xt=Fg(qe,He),Pt=xt.getContext("2d"),jt=Oe.width,Gt=Oe.height,bi=Oe.left,wi=Oe.top,qr=new Path2D,Xn=new Path2D;Xn.rect(bi,wi,jt,Gt),qr.addPath(Xn,Me),Pt.clip(qr);for(const F of Oe.children)Ug(Pt,Me,Le,F,Fe);const Yn=Pt.getImageData(0,0,qe,He),yo=Yn.data;if(Oe.mask_type===Rb.MASK_TYPE_LUMINANCE)for(let F=0;F<yo.length;F+=4)yo[F+3]=yo[F+3]/255*(.2126*yo[F]+.7152*yo[F+1]+.0722*yo[F+2]);Pt.putImageData(Yn,0,0),F.globalCompositeOperation="destination-in",F.drawImage(xt,0,0)}function Wg(F){return F?new DOMMatrix([F.sx,F.ky,F.kx,F.sy,F.tx,F.ty]):new DOMMatrix}function Kg(F){const Me=new Path2D,Le=F.step;let Oe=F.diffs[0]*Le,Fe=F.diffs[1]*Le;Me.moveTo(Oe,Fe);for(let je=0,qe=2;je<F.commands.length;je++)switch(F.commands[je]){case zb.PATH_COMMAND_MOVE:Oe+=F.diffs[qe++]*Le,Fe+=F.diffs[qe++]*Le,Me.moveTo(Oe,Fe);break;case zb.PATH_COMMAND_LINE:Oe+=F.diffs[qe++]*Le,Fe+=F.diffs[qe++]*Le,Me.lineTo(Oe,Fe);break;case zb.PATH_COMMAND_QUAD:{const je=Oe+F.diffs[qe++]*Le,He=Fe+F.diffs[qe++]*Le;Oe=je+F.diffs[qe++]*Le,Fe=He+F.diffs[qe++]*Le,Me.quadraticCurveTo(je,He,Oe,Fe);break}case zb.PATH_COMMAND_CUBIC:{const je=Oe+F.diffs[qe++]*Le,He=Fe+F.diffs[qe++]*Le,xt=je+F.diffs[qe++]*Le,Pt=He+F.diffs[qe++]*Le;Oe=xt+F.diffs[qe++]*Le,Fe=Pt+F.diffs[qe++]*Le,Me.bezierCurveTo(je,He,xt,Pt,Oe,Fe);break}case zb.PATH_COMMAND_CLOSE:Me.closePath()}return Me}class Jg{constructor(F){this.capacity=F,this.cache=new Map}get(F){if(!this.cache.has(F))return;const Me=this.cache.get(F);return this.cache.delete(F),this.cache.set(F,Me),Me}put(F,Me){this.cache.has(F)?this.cache.delete(F):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(F,Me)}delete(F){this.cache.delete(F)}}us(Jg,"LRUCache");class Qg{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(F){return new pc(F,F.data)}getFromCache(F,Me,Le){return this.cacheMap.has(Le)||this.cacheMap.set(Le,new Jg(150)),this.cacheMap.get(Le).get(pa(F.toString(),Me))}setInCache(F,Me,Le,Oe){this.cacheDependenciesMap.has(Oe)||this.cacheDependenciesMap.set(Oe,new Map),this.cacheMap.has(Oe)||this.cacheMap.set(Oe,new Jg(150));const Fe=this.cacheDependenciesMap.get(Oe),je=pa(F.id.toString(),Le);Fe.get(je)||Fe.set(je,new Set);const qe=this.cacheMap.get(Oe),He=F.toString();Fe.get(je).add(He),qe.put(pa(F.toString(),Le),Me)}removeImagesFromCacheByIds(F,Me,Le=0){if(!this.cacheMap.has(Le)||!this.cacheDependenciesMap.has(Le))return;const Oe=this.cacheMap.get(Le),Fe=this.cacheDependenciesMap.get(Le);for(const Le of F){const F=pa(Le.toString(),Me);if(Fe.has(F)){for(const Me of Fe.get(F))Oe.delete(Me);Fe.delete(F)}}}rasterize(F,Me,Le,Oe,Fe=Og){const je=this.getFromCache(F,Le,Oe);if(je)return je.clone();const qe=Fe(Me.icon,F.options),He=Qg._getImage(qe);return this.setInCache(F,He,Le,Oe),He.clone()}}class tx{constructor(F){this.size=F,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(F,Me){const Le=this.toIdx(F,Me);return{min:this.minimums[Le],max:this.maximums[Le]}}isLeaf(F,Me){return this.leaves[this.toIdx(F,Me)]}toIdx(F,Me){return Me*this.size+F}}function ex(F,Me,Le,Oe){let Fe=0,je=Number.MAX_VALUE;for(let qe=0;qe<3;qe++)if(Math.abs(Oe[qe])<1e-15){if(Le[qe]<F[qe]||Le[qe]>Me[qe])return null}else{const He=1/Oe[qe];let xt=(F[qe]-Le[qe])*He,Pt=(Me[qe]-Le[qe])*He;if(xt>Pt){const F=xt;xt=Pt,Pt=F}if(xt>Fe&&(Fe=xt),Pt<je&&(je=Pt),Fe>je)return null}return Fe}function rx(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt){const Gt=Oe-F,bi=Fe-Me,wi=je-Le,qr=qe-F,Xn=He-Me,Yn=xt-Le,yo=jt[1]*Yn-jt[2]*Xn,bo=jt[2]*qr-jt[0]*Yn,Ro=jt[0]*Xn-jt[1]*qr,Do=Gt*yo+bi*bo+wi*Ro;if(Math.abs(Do)<1e-15)return null;const zs=1/Do,Zs=Pt[0]-F,na=Pt[1]-Me,el=Pt[2]-Le,nl=(Zs*yo+na*bo+el*Ro)*zs;if(nl<0||nl>1)return null;const hl=na*wi-el*bi,pl=el*Gt-Zs*wi,bl=Zs*bi-na*Gt,Tl=(jt[0]*hl+jt[1]*pl+jt[2]*bl)*zs;return Tl<0||nl+Tl>1?null:(qr*hl+Xn*pl+Yn*bl)*zs}function nx(F,Me,Le){return(F-Me)/(Le-Me)}function ix(F,Me,Le,Oe,Fe,je,qe,He,xt){const Pt=1<<Le,jt=je-Oe,Gt=qe-Fe,bi=(F+1)/Pt*jt+Oe,wi=(Me+0)/Pt*Gt+Fe,qr=(Me+1)/Pt*Gt+Fe;He[0]=(F+0)/Pt*jt+Oe,He[1]=wi,xt[0]=bi,xt[1]=qr}class sx{constructor(F){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=F,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const Me=function(F){const Me=Math.ceil(Math.log2(F.dim/8)),Le=[];let Oe=Math.ceil(Math.pow(2,Me));const Fe=1/Oe,s=(F,Me,Le,Oe,Fe)=>{const je=Oe?1:0,qe=(F+1)*Le-je,He=Me*Le,xt=(Me+1)*Le-je;Fe[0]=F*Le,Fe[1]=He,Fe[2]=qe,Fe[3]=xt};let je=new tx(Oe);const qe=[];for(let Me=0;Me<Oe*Oe;Me++){s(Me%Oe,Math.floor(Me/Oe),Fe,!1,qe);const Le=ox(qe[0],qe[1],F),He=ox(qe[2],qe[1],F),xt=ox(qe[2],qe[3],F),Pt=ox(qe[0],qe[3],F);je.minimums.push(Math.min(Le,He,xt,Pt)),je.maximums.push(Math.max(Le,He,xt,Pt)),je.leaves.push(1)}for(Le.push(je),Oe/=2;Oe>=1;Oe/=2){const F=Le[Le.length-1];je=new tx(Oe);for(let Me=0;Me<Oe*Oe;Me++){s(Me%Oe,Math.floor(Me/Oe),2,!0,qe);const Le=F.getElevation(qe[0],qe[1]),Fe=F.getElevation(qe[2],qe[1]),He=F.getElevation(qe[2],qe[3]),xt=F.getElevation(qe[0],qe[3]),Pt=F.isLeaf(qe[0],qe[1]),jt=F.isLeaf(qe[2],qe[1]),Gt=F.isLeaf(qe[2],qe[3]),bi=F.isLeaf(qe[0],qe[3]),wi=Math.min(Le.min,Fe.min,He.min,xt.min),qr=Math.max(Le.max,Fe.max,He.max,xt.max),Xn=Pt&&jt&&Gt&&bi;je.maximums.push(qr),je.minimums.push(wi),je.leaves.push(qr-wi<=5&&Xn?1:0)}Le.push(je)}return Le}(this.dem),Le=Me.length-1,Oe=Me[Le];this._addNode(Oe.minimums[0],Oe.maximums[0],Oe.leaves[0]),this._construct(Me,0,0,Le,0)}raycastRoot(F,Me,Le,Oe,Fe,je,qe=1){return ex([F,Me,-100],[Le,Oe,this.maximums[0]*qe],Fe,je)}raycast(F,Me,Le,Oe,Fe,je,qe=1){if(!this.nodeCount)return null;const He=this.raycastRoot(F,Me,Le,Oe,Fe,je,qe);if(null==He)return null;const xt=[],Pt=[],jt=[],Gt=[],bi=[{idx:0,t:He,nodex:0,nodey:0,depth:0}];for(;bi.length>0;){const{idx:He,t:wi,nodex:qr,nodey:Xn,depth:Yn}=bi.pop();if(this.leaves[He]){ix(qr,Xn,Yn,F,Me,Le,Oe,jt,Gt);const He=1<<Yn,xt=(qr+0)/He,Pt=(qr+1)/He,bi=(Xn+0)/He,yo=(Xn+1)/He,bo=ox(xt,bi,this.dem)*qe,Ro=ox(Pt,bi,this.dem)*qe,Do=ox(Pt,yo,this.dem)*qe,zs=ox(xt,yo,this.dem)*qe,Zs=rx(jt[0],jt[1],bo,Gt[0],jt[1],Ro,Gt[0],Gt[1],Do,Fe,je),na=rx(Gt[0],Gt[1],Do,jt[0],Gt[1],zs,jt[0],jt[1],bo,Fe,je),el=Math.min(null!==Zs?Zs:Number.MAX_VALUE,null!==na?na:Number.MAX_VALUE);if(el!==Number.MAX_VALUE)return el;{const F=bl.vec3.scaleAndAdd([],Fe,je,wi);if(ax(bo,Ro,zs,Do,nx(F[0],jt[0],Gt[0]),nx(F[1],jt[1],Gt[1]))>=F[2])return wi}continue}let yo=0;for(let bi=0;bi<this._siblingOffset.length;bi++){ix((qr<<1)+this._siblingOffset[bi][0],(Xn<<1)+this._siblingOffset[bi][1],Yn+1,F,Me,Le,Oe,jt,Gt),jt[2]=-100,Gt[2]=this.maximums[this.childOffsets[He]+bi]*qe;const wi=ex(jt,Gt,Fe,je);if(null!=wi){const F=wi;xt[bi]=F;let Me=!1;for(let Le=0;Le<yo&&!Me;Le++)F>=xt[Pt[Le]]&&(Pt.splice(Le,0,bi),Me=!0);Me||(Pt[yo]=bi),yo++}}for(let F=0;F<yo;F++){const Me=Pt[F];bi.push({idx:this.childOffsets[He]+Me,t:xt[Me],nodex:(qr<<1)+this._siblingOffset[Me][0],nodey:(Xn<<1)+this._siblingOffset[Me][1],depth:Yn+1})}}return null}_addNode(F,Me,Le){return this.minimums.push(F),this.maximums.push(Me),this.leaves.push(Le),this.childOffsets.push(0),this.nodeCount++}_construct(F,Me,Le,Oe,Fe){if(1===F[Oe].isLeaf(Me,Le))return;this.childOffsets[Fe]||(this.childOffsets[Fe]=this.nodeCount);const je=Oe-1,qe=F[je];let He=0,xt=0;for(let F=0;F<this._siblingOffset.length;F++){const Oe=2*Me+this._siblingOffset[F][0],Fe=2*Le+this._siblingOffset[F][1],je=qe.getElevation(Oe,Fe),Pt=qe.isLeaf(Oe,Fe),jt=this._addNode(je.min,je.max,Pt);Pt&&(He|=1<<F),xt||(xt=jt)}for(let Oe=0;Oe<this._siblingOffset.length;Oe++)He&1<<Oe||this._construct(F,2*Me+this._siblingOffset[Oe][0],2*Le+this._siblingOffset[Oe][1],je,xt+Oe)}}function ax(F,Me,Le,Oe,Fe,je){return Ee(Ee(F,Le,je),Ee(Me,Oe,je),Fe)}function ox(F,Me,Le){const Oe=Le.dim,Fe=Q(F*Oe-.5,0,Oe-1),je=Q(Me*Oe-.5,0,Oe-1),qe=Math.floor(Fe),He=Math.floor(je),xt=Math.min(qe+1,Oe-1),Pt=Math.min(He+1,Oe-1);return ax(Le.get(qe,He),Le.get(xt,He),Le.get(qe,Pt),Le.get(xt,Pt),Fe-qe,je-He)}const Db={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function ux(F,Me,Le){return(256*F*256+256*Me+Le)/10-1e4}function cx(F,Me,Le){return 256*F+Me+Le/256-32768}class hx{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(F,Me,Le,Oe=!1){if(this.uid=F,Me.height!==Me.width)throw new RangeError("DEM tiles must be square");if(Le&&"mapbox"!==Le&&"terrarium"!==Le)return void pt(`"${Le}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=Me.height;const Fe=this.dim=Me.height-2,je=new Uint32Array(Me.data.buffer);if(this.pixels=new Uint8Array(Me.data.buffer),this.floatView=new Float32Array(Me.data.buffer),this.borderReady=Oe,this._modifiedForSources={},!Oe){for(let F=0;F<Fe;F++)je[this._idx(-1,F)]=je[this._idx(0,F)],je[this._idx(Fe,F)]=je[this._idx(Fe-1,F)],je[this._idx(F,-1)]=je[this._idx(F,0)],je[this._idx(F,Fe)]=je[this._idx(F,Fe-1)];je[this._idx(-1,-1)]=je[this._idx(0,0)],je[this._idx(Fe,-1)]=je[this._idx(Fe-1,0)],je[this._idx(-1,Fe)]=je[this._idx(0,Fe-1)],je[this._idx(Fe,Fe)]=je[this._idx(Fe-1,Fe-1)]}const qe="terrarium"===Le?cx:ux;for(let F=0;F<je.length;++F){const Me=4*F;this.floatView[F]=qe(this.pixels[Me],this.pixels[Me+1],this.pixels[Me+2])}this._timestamp=eh.now()}_buildQuadTree(){this._tree=new sx(this)}get(F,Me,Le=!1){Le&&(F=Q(F,-1,this.dim),Me=Q(Me,-1,this.dim));const Oe=this._idx(F,Me);return this.floatView[Oe]}set(F,Me,Le){const Oe=this._idx(F,Me),Fe=this.floatView[Oe];return this.floatView[Oe]=Le,Le-Fe}static getUnpackVector(F){return Db[F]}_idx(F,Me){if(F<-1||F>=this.dim+1||Me<-1||Me>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(Me+1)*this.stride+(F+1)}static pack(F,Me){const Le=[0,0,0,0],Oe=hx.getUnpackVector(Me);let Fe=Math.floor((F+Oe[3])/Oe[2]);return Le[2]=Fe%256,Fe=Math.floor(Fe/256),Le[1]=Fe%256,Fe=Math.floor(Fe/256),Le[0]=Fe,Le}getPixels(){return new fc({width:this.stride,height:this.stride},this.pixels)}backfillBorder(F,Me,Le){if(this.dim!==F.dim)throw new Error("dem dimension mismatch");let Oe=Me*this.dim,Fe=Me*this.dim+this.dim,je=Le*this.dim,qe=Le*this.dim+this.dim;switch(Me){case-1:Oe=Fe-1;break;case 1:Fe=Oe+1}switch(Le){case-1:je=qe-1;break;case 1:qe=je+1}const He=-Me*this.dim,xt=-Le*this.dim;for(let Me=je;Me<qe;Me++)for(let Le=Oe;Le<Fe;Le++){const Oe=4*this._idx(Le,Me),Fe=4*this._idx(Le+He,Me+xt);this.pixels[Oe+0]=F.pixels[Fe+0],this.pixels[Oe+1]=F.pixels[Fe+1],this.pixels[Oe+2]=F.pixels[Fe+2],this.pixels[Oe+3]=F.pixels[Fe+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function px(F,Me,Le){1===F?Me.headerLength=Le.readFixed32():2===F?Me.x=Le.readVarint():3===F?Me.y=Le.readVarint():4===F?Me.z=Le.readVarint():5===F&&Me.layers.push(function(F,Me){return F.readFields(gx,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},Me)}(Le,Le.readVarint()+Le.pos))}function fx(F,Me,Le){1===F?(Me.delta_filter=function(F,Me){return F.readFields(dx,{blockSize:0},Me)}(Le,Le.readVarint()+Le.pos),Me.filter="delta_filter"):2===F?(Le.readVarint(),Me.filter="zigzag_filter"):3===F?(Le.readVarint(),Me.filter="bitshuffle_filter"):4===F&&(Le.readVarint(),Me.filter="byteshuffle_filter")}function dx(F,Me,Le){1===F&&(Me.blockSize=Le.readVarint())}function mx(F,Me,Le){1===F?(Le.readVarint(),Me.codec="gzip_data"):2===F?(Le.readVarint(),Me.codec="jpeg_image"):3===F?(Le.readVarint(),Me.codec="webp_image"):4===F&&(Le.readVarint(),Me.codec="png_image")}function yx(F,Me,Le){let Oe=0,Fe=0;1===F?Me.firstByte=Le.readFixed64():2===F?Me.lastByte=Le.readFixed64():3===F?Me.filters.push(function(F,Me){return F.readFields(fx,{},Me)}(Le,Le.readVarint()+Le.pos)):4===F?Me.codec=function(F,Me){return F.readFields(mx,{},Me)}(Le,Le.readVarint()+Le.pos):5===F?Fe=Le.readFloat():6===F?Oe=Le.readFloat():7===F?Me.bands.push(Le.readString()):8===F?Me.offset=Le.readDouble():9===F&&(Me.scale=Le.readDouble()),0===Me.offset&&(Me.offset=Fe),0===Me.scale&&(Me.scale=Oe)}function gx(F,Me,Le){1===F?Me.version=Le.readVarint():2===F?Me.name=Le.readString():3===F?Me.units=Le.readString():4===F?Me.tileSize=Le.readVarint():5===F?Me.buffer=Le.readVarint():6===F?Me.pixelFormat=Le.readVarint():7===F&&Me.dataIndex.push(function(F,Me){return F.readFields(yx,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},Me)}(Le,Le.readVarint()+Le.pos))}function xx(F,Me,Le){if(2===F)!function(F,Me,Le){F.readFields(vx,Le,Me)}(Le,Le.readVarint()+Le.pos,Me);else if(3===F)throw new Error("Not implemented")}function vx(F,Me,Le){if(1===F){let F=0;const Oe=Le.readVarint()+Le.pos;for(;Le.pos<Oe;)Me[F++]=Le.readVarint()}}function bx(F,Me){if(4!==Me.length)throw new Error(`Expected data of dimension 4 but got ${Me.length}.`);let Le=Me[3];for(let Oe=2;Oe>=1;Oe--){const Fe=1===Oe?1:0,je=2===Oe?1:0;for(let Oe=0;Oe<Me[0];Oe++){const qe=Me[1]*Oe;for(let Oe=Fe;Oe<Me[1];Oe++){const Fe=Me[2]*(Oe+qe);for(let Oe=je;Oe<Me[2];Oe++){const je=Me[3]*(Oe+Fe);for(let Oe=0;Oe<Me[3];Oe++){const Me=je+Oe;F[Me]+=F[Me-Le]}}}}Le*=Me[Oe]}return F}function _x(F){for(let Me=0,Le=F.length;Me<Le;Me++)F[Me]=F[Me]>>>1^-(1&F[Me]);return F}function wx(F,Me){switch(Me){case"uint32":return F;case"uint16":for(let Me=0;Me<F.length;Me+=2){const Le=F[Me],Oe=F[Me+1];F[Me]=(240&Le)>>4|(61440&Le)>>8|(240&Oe)<<4|61440&Oe,F[Me+1]=15&Le|(3840&Le)>>4|(15&Oe)<<8|(3840&Oe)<<4}return F;case"uint8":for(let Me=0;Me<F.length;Me+=4){const Le=F[Me],Oe=F[Me+1],Fe=F[Me+2],je=F[Me+3];F[Me+0]=(192&Le)>>6|(192&Oe)>>4|(192&Fe)>>2|192&je,F[Me+1]=(48&Le)>>4|(48&Oe)>>2|48&Fe|(48&je)<<2,F[Me+2]=(12&Le)>>2|12&Oe|(12&Fe)<<2|(12&je)<<4,F[Me+3]=3&Le|(3&Oe)<<2|(3&Fe)<<4|(3&je)<<6}return F;default:throw new Error(`Invalid pixel format, "${Me}"`)}}us(hx,"DEMData"),us(sx,"DemMinMaxQuadTree",{omit:["dem"]});var Lb=Uint8Array,Ob=Uint16Array,kb=Int32Array,Fb=new Lb([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Bb=new Lb([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Nb=new Lb([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),zx=function(F,Me){for(var Le=new Ob(31),Oe=0;Oe<31;++Oe)Le[Oe]=Me+=1<<F[Oe-1];var Fe=new kb(Le[30]);for(Oe=1;Oe<30;++Oe)for(var je=Le[Oe];je<Le[Oe+1];++je)Fe[je]=je-Le[Oe]<<5|Oe;return{b:Le,r:Fe}},Vb=zx(Fb,2),Ub=Vb.b,jb=Vb.r;Ub[28]=258,jb[258]=28;for(var Gb=zx(Bb,0).b,qb=new Ob(32768),Hb=0;Hb<32768;++Hb){var $b=(43690&Hb)>>1|(21845&Hb)<<1;qb[Hb]=((65280&($b=(61680&($b=(52428&$b)>>2|(13107&$b)<<2))>>4|(3855&$b)<<4))>>8|(255&$b)<<8)>>1}var Lx=function(F,Me,Le){for(var Oe=F.length,Fe=0,je=new Ob(Me);Fe<Oe;++Fe)F[Fe]&&++je[F[Fe]-1];var qe,He=new Ob(Me);for(Fe=1;Fe<Me;++Fe)He[Fe]=He[Fe-1]+je[Fe-1]<<1;qe=new Ob(1<<Me);var xt=15-Me;for(Fe=0;Fe<Oe;++Fe)if(F[Fe])for(var Pt=Fe<<4|F[Fe],jt=Me-F[Fe],Gt=He[F[Fe]-1]++<<jt,bi=Gt|(1<<jt)-1;Gt<=bi;++Gt)qe[qb[Gt]>>xt]=Pt;return qe},Zb=new Lb(288);for(Hb=0;Hb<144;++Hb)Zb[Hb]=8;for(Hb=144;Hb<256;++Hb)Zb[Hb]=9;for(Hb=256;Hb<280;++Hb)Zb[Hb]=7;for(Hb=280;Hb<288;++Hb)Zb[Hb]=8;var Wb=new Lb(32);for(Hb=0;Hb<32;++Hb)Wb[Hb]=5;var Xb=Lx(Zb,9),Yb=Lx(Wb,5),jx=function(F){for(var Me=F[0],Le=1;Le<F.length;++Le)F[Le]>Me&&(Me=F[Le]);return Me},qx=function(F,Me,Le){var Oe=Me/8|0;return(F[Oe]|F[Oe+1]<<8)>>(7&Me)&Le},$x=function(F,Me){var Le=Me/8|0;return(F[Le]|F[Le+1]<<8|F[Le+2]<<16)>>(7&Me)},Kb=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Yx=function(F,Me,Le){var Oe=new Error(Me||Kb[F]);if(Oe.code=F,Error.captureStackTrace&&Error.captureStackTrace(Oe,Yx),!Le)throw Oe;return Oe},Jb=new Lb(0),Qb="undefined"!=typeof TextDecoder&&new TextDecoder;try{Qb.decode(Jb,{stream:!0})}catch(Me){}const ew={gzip_data:"gzip"};class Wx extends Error{constructor(F){super(F),this.name="MRTError"}}const tw={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},iw={uint32:1,uint16:2,uint8:4},rw={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let nw;class ev{constructor(F=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=F}getLayer(F){const Me=this.layers[F];if(!Me)throw new Wx(`Layer '${F}' not found`);return Me}getHeaderLength(F){const Me=new Uint8Array(F),Le=new DataView(F);if(13!==Me[0])throw new Wx("File is not a valid MRT.");return Le.getUint32(1,!0)}parseHeader(F){const Me=new Uint8Array(F),Le=this.getHeaderLength(F);if(Me.length<Le)throw new Wx(`Expected header with length >= ${Le} but got buffer of length ${Me.length}`);const Oe=function(F){return F.readFields(px,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new nw(Me.subarray(0,Le)));if(!isNaN(this.x)&&(this.x!==Oe.x||this.y!==Oe.y||this.z!==Oe.z))throw new Wx(`Invalid attempt to parse header ${Oe.z}/${Oe.x}/${Oe.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=Oe.x,this.y=Oe.y,this.z=Oe.z;for(const F of Oe.layers)this.layers[F.name]=new rv(F,{cacheSize:this._cacheSize});return this}createDecodingTask(F){const Me=[],Le=this.getLayer(F.layerName);for(let Oe of F.blockIndices){const Fe=Le.dataIndex[Oe],je=Fe.firstByte-F.firstByte,qe=Fe.lastByte-F.firstByte;if(Le._blocksInProgress.has(Oe))continue;const He={layerName:Le.name,firstByte:je,lastByte:qe,pixelFormat:Le.pixelFormat,blockIndex:Oe,blockShape:[Fe.bands.length].concat(Le.bandShape),buffer:Le.buffer,codec:Fe.codec.codec,filters:Fe.filters.map((F=>F.filter))};Le._blocksInProgress.add(Oe),Me.push(He)}return new nv(Me,(()=>{Me.forEach((F=>Le._blocksInProgress.delete(F.blockIndex)))}),((F,Oe)=>{if(Me.forEach((F=>Le._blocksInProgress.delete(F.blockIndex))),F)throw F;Oe.forEach((F=>{this.getLayer(F.layerName).processDecodedData(F)}))}))}}class rv{constructor({version:F,name:Me,units:Le,tileSize:Oe,pixelFormat:Fe,buffer:je,dataIndex:qe},He){if(this.version=F,1!==this.version)throw new Wx(`Cannot parse raster layer encoded with MRT version ${F}`);this.name=Me,this.units=Le,this.tileSize=Oe,this.buffer=je,this.pixelFormat=tw[Fe],this.dataIndex=qe,this.bandShape=[Oe+2*je,Oe+2*je,iw[this.pixelFormat]],this._decodedBlocks=new Jg(He?He.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return iw[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:F})=>F)).flat()}processDecodedData(F){const Me=F.blockIndex.toString();this._decodedBlocks.get(Me)||this._decodedBlocks.put(Me,F.data)}getBlockForBand(F){let Me=0;switch(typeof F){case"string":for(const[Le,Oe]of this.dataIndex.entries()){for(const[Fe,je]of Oe.bands.entries())if(je===F)return{bandIndex:Me+Fe,blockIndex:Le,blockBandIndex:Fe};Me+=Oe.bands.length}break;case"number":for(const[Le,Oe]of this.dataIndex.entries()){if(F>=Me&&F<Me+Oe.bands.length)return{bandIndex:F,blockIndex:Le,blockBandIndex:F-Me};Me+=Oe.bands.length}break;default:throw new Wx(`Invalid band \`${JSON.stringify(F)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(F){let Me=1/0,Le=-1/0;const Oe=[],Fe=new Set;for(const je of F){const{blockIndex:F}=this.getBlockForBand(je);if(F<0)throw new Wx(`Invalid band: ${JSON.stringify(je)}`);const qe=this.dataIndex[F];Oe.includes(F)||Oe.push(F),Fe.add(F),Me=Math.min(Me,qe.firstByte),Le=Math.max(Le,qe.lastByte)}if(Fe.size>this.cacheSize)throw new Wx(`Number of blocks to decode (${Fe.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:Me,lastByte:Le,blockIndices:Oe}}hasBand(F){const{blockIndex:Me}=this.getBlockForBand(F);return Me>=0}hasDataForBand(F){const{blockIndex:Me}=this.getBlockForBand(F);return Me>=0&&!!this._decodedBlocks.get(Me.toString())}getBandView(F){const{blockIndex:Me,blockBandIndex:Le}=this.getBlockForBand(F);if(Me<0)throw new Wx(`Band not found: ${JSON.stringify(F)}`);const Oe=this._decodedBlocks.get(Me.toString());if(!Oe)throw new Wx(`Data for band ${JSON.stringify(F)} of layer "${this.name}" not decoded.`);const Fe=this.dataIndex[Me],je=this.bandShape.reduce(((F,Me)=>F*Me),1),qe=Le*je,He=Oe.subarray(qe,qe+je);return{data:He,bytes:new Uint8Array(He.buffer).subarray(He.byteOffset,He.byteOffset+He.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:Fe.offset,scale:Fe.scale}}}ev.setPbf=function(F){nw=F};class nv{constructor(F,Me,Le){this.tasks=F,this._onCancel=Me,this._onComplete=Le,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(F,Me){this._finalized||(this._onComplete(F,Me),this._finalized=!0)}}ev.performDecoding=function(F,Me){const Le=new Uint8Array(F);return Promise.all(Me.tasks.map((F=>{const{layerName:Me,firstByte:Oe,lastByte:Fe,pixelFormat:je,blockShape:qe,blockIndex:He,filters:xt,codec:Pt}=F,jt=Le.subarray(Oe,Fe+1),Gt=new Uint32Array(qe[0]*qe[1]*qe[2]);let bi;if("gzip_data"!==Pt)throw new Wx(`Unhandled codec: ${Pt}`);return bi=function(F,Me){if(!globalThis.DecompressionStream&&"gzip_data"===Me)return Promise.resolve(((je=function(F){31==F[0]&&139==F[1]&&8==F[2]||Yx(6,"invalid gzip data");var Me=F[3],Le=10;4&Me&&(Le+=2+(F[10]|F[11]<<8));for(var Oe=(Me>>3&1)+(Me>>4&1);Oe>0;Oe-=!F[Le++]);return Le+(2&Me)}(Fe=F))+8>Fe.length&&Yx(6,"invalid gzip data"),function(F,Me,Le){var Oe=F.length;if(!Oe||Me.f&&!Me.l)return Le||new Lb(0);var Fe=!Le,je=Fe||2!=Me.i,qe=Me.i;Fe&&(Le=new Lb(3*Oe));var He,xt,c=function(F){var Me=Le.length;if(F>Me){var Oe=new Lb(Math.max(2*Me,F));Oe.set(Le),Le=Oe}},Pt=Me.f||0,jt=Me.p||0,Gt=Me.b||0,bi=Me.l,wi=Me.d,qr=Me.m,Xn=Me.n,Yn=8*Oe;do{if(!bi){Pt=qx(F,jt,1);var yo=qx(F,jt+1,3);if(jt+=3,!yo){var bo=F[(Tl=4+((jt+7)/8|0))-4]|F[Tl-3]<<8,Ro=Tl+bo;if(Ro>Oe){qe&&Yx(0);break}je&&c(Gt+bo),Le.set(F.subarray(Tl,Ro),Gt),Me.b=Gt+=bo,Me.p=jt=8*Ro,Me.f=Pt;continue}if(1==yo)bi=Xb,wi=Yb,qr=9,Xn=5;else if(2==yo){var Do=qx(F,jt,31)+257,zs=qx(F,jt+10,15)+4,Zs=Do+qx(F,jt+5,31)+1;jt+=14;for(var na=new Lb(Zs),el=new Lb(19),nl=0;nl<zs;++nl)el[Nb[nl]]=qx(F,jt+3*nl,7);jt+=3*zs;var hl=jx(el),pl=(1<<hl)-1,bl=Lx(el,hl);for(nl=0;nl<Zs;){var Tl,kl=bl[qx(F,jt,pl)];if(jt+=15&kl,(Tl=kl>>4)<16)na[nl++]=Tl;else{var ec=0,tc=0;for(16==Tl?(tc=3+qx(F,jt,3),jt+=2,ec=na[nl-1]):17==Tl?(tc=3+qx(F,jt,7),jt+=3):18==Tl&&(tc=11+qx(F,jt,127),jt+=7);tc--;)na[nl++]=ec}}var ic=na.subarray(0,Do),oc=na.subarray(Do);qr=jx(ic),Xn=jx(oc),bi=Lx(ic,qr),wi=Lx(oc,Xn)}else Yx(1);if(jt>Yn){qe&&Yx(0);break}}je&&c(Gt+131072);for(var sc=(1<<qr)-1,ac=(1<<Xn)-1,mc=jt;;mc=jt){var gc=(ec=bi[$x(F,jt)&sc])>>4;if((jt+=15&ec)>Yn){qe&&Yx(0);break}if(ec||Yx(2),gc<256)Le[Gt++]=gc;else{if(256==gc){mc=jt,bi=null;break}var yc=gc-254;gc>264&&(yc=qx(F,jt,(1<<(Wc=Fb[nl=gc-257]))-1)+Ub[nl],jt+=Wc);var xc=wi[$x(F,jt)&ac],Zc=xc>>4;if(xc||Yx(3),jt+=15&xc,oc=Gb[Zc],Zc>3){var Wc=Bb[Zc];oc+=$x(F,jt)&(1<<Wc)-1,jt+=Wc}if(jt>Yn){qe&&Yx(0);break}je&&c(Gt+131072);var Kc=Gt+yc;if(Gt<oc){var Jc=0-oc,Qc=Math.min(oc,Kc);for(Jc+Gt<0&&Yx(3);Gt<Qc;++Gt)Le[Gt]=(void 0)[Jc+Gt]}for(;Gt<Kc;++Gt)Le[Gt]=Le[Gt-oc]}}Me.l=bi,Me.p=mc,Me.b=Gt,Me.f=Pt,bi&&(Pt=1,Me.m=qr,Me.d=wi,Me.n=Xn)}while(!Pt);return Gt!=Le.length&&Fe?(He=Le,(null==(xt=Gt)||xt>He.length)&&(xt=He.length),new Lb(He.subarray(0,xt))):Le.subarray(0,Gt)}(Fe.subarray(je,-8),{i:2},new Lb(((Le=Fe)[(Oe=Le.length)-4]|Le[Oe-3]<<8|Le[Oe-2]<<16|Le[Oe-1]<<24)>>>0))));var Le,Oe,Fe,je;const qe=ew[Me];if(!qe)throw new Error(`Unhandled codec: ${Me}`);const He=new globalThis.DecompressionStream(qe);return new Response(new Blob([F]).stream().pipeThrough(He)).arrayBuffer().then((F=>new Uint8Array(F)))}(jt,Pt).then((F=>(function(F,Me){F.readFields(xx,Me)}(new nw(F),Gt),new(0,rw[je])(Gt.buffer)))),bi.then((F=>{for(let Me=xt.length-1;Me>=0;Me--)switch(xt[Me]){case"delta_filter":bx(F,qe);break;case"zigzag_filter":_x(F);break;case"bitshuffle_filter":wx(F,je);break;default:throw new Wx(`Unhandled filter "${xt[Me]}"`)}return{layerName:Me,blockIndex:He,data:F}})).catch((F=>{throw F}))})))},us(nv,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),us(ev,"MapboxRasterTile"),us(rv,"MapboxRasterLayer",{omit:["_blocksInProgress"]});let ow,sw,aw,lw,cw,hw=null;function cv(){return yt()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:sw||yc.DRACO_URL}function hv(){if(yt()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(lw)return lw;const F=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return lw=WebAssembly.validate(F)?yc.MESHOPT_SIMD_URL:yc.MESHOPT_URL,lw}const uw={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},dw={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},pw={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function mv(F,Me,Le){const Oe=Le.json.bufferViews.length,Fe=Le.buffers.length;Me.bufferView=Oe,Le.json.bufferViews[Oe]={buffer:Fe,byteLength:F.byteLength},Le.buffers[Fe]=F}const fw="KHR_draco_mesh_compression";function gv(F,Me){const Le=F.extensions&&F.extensions[fw];if(!Le)return;const Oe=new aw.Decoder,Fe=Av(Me,Le.bufferView),je=new aw.Mesh;if(!Oe.DecodeArrayToMesh(Fe,Fe.byteLength,je))throw new Error("Failed to decode Draco mesh");const qe=Me.json.accessors[F.indices],He=uw[qe.componentType],xt=qe.count*He.BYTES_PER_ELEMENT,Pt=aw._malloc(xt);He===Uint16Array?Oe.GetTrianglesUInt16Array(je,xt,Pt):Oe.GetTrianglesUInt32Array(je,xt,Pt),mv(aw.memory.buffer.slice(Pt,Pt+xt),qe,Me),aw._free(Pt);for(const Fe of Object.keys(Le.attributes)){const qe=Oe.GetAttributeByUniqueId(je,Le.attributes[Fe]),He=Me.json.accessors[F.attributes[Fe]],xt=dw[He.componentType],Pt=He.count*pw[He.type]*uw[He.componentType].BYTES_PER_ELEMENT,jt=aw._malloc(Pt);Oe.GetAttributeDataArrayForAllPoints(je,qe,aw[xt],Pt,jt),mv(aw.memory.buffer.slice(jt,jt+Pt),He,Me),aw._free(jt)}Oe.destroy(),je.destroy(),delete F.extensions[fw]}const mw="EXT_meshopt_compression";function vv(F,Me){if(!F.extensions||!F.extensions[mw])return;const Le=F.extensions[mw],Oe=new Uint8Array(Me.buffers[Le.buffer],Le.byteOffset||0,Le.byteLength||0),Fe=new Uint8Array(Le.count*Le.byteStride);cw.decodeGltfBuffer(Fe,Le.count,Le.byteStride,Oe,Le.mode,Le.filter),F.buffer=Me.buffers.length,F.byteOffset=0,Me.buffers[F.buffer]=Fe.buffer,delete F.extensions[mw]}const _w=1179937895,gw=new TextDecoder("utf8");function wv(F,Me){return new URL(F,Me).href}function Mv(F,Me,Le,Oe){return fetch(wv(F.uri,Oe)).then((F=>F.arrayBuffer())).then((F=>{Me.buffers[Le]=F}))}function Av(F,Me){const Le=F.json.bufferViews[Me];return new Uint8Array(F.buffers[Le.buffer],Le.byteOffset||0,Le.byteLength)}function Iv(F,Me,Le,Oe){if(F.uri){const Fe=wv(F.uri,Oe);return fetch(Fe).then((F=>F.blob())).then((F=>createImageBitmap(F))).then((F=>{Me.images[Le]=F}))}if(void 0!==F.bufferView){const Oe=Av(Me,F.bufferView),Fe=new Blob([Oe],{type:F.mimeType});return createImageBitmap(Fe).then((F=>{Me.images[Le]=F}))}}function Sv(F,Me=0,Le){const Oe={json:null,images:[],buffers:[]};if(new Uint32Array(F,Me,1)[0]===_w){const Le=new Uint32Array(F,Me);let Fe=2;const je=(Le[Fe++]>>2)-3,qe=Le[Fe++]>>2;if(Fe++,Oe.json=JSON.parse(gw.decode(Le.subarray(Fe,Fe+qe))),Fe+=qe,Fe<je){const je=Le[Fe++];Fe++;const qe=Me+(Fe<<2);Oe.buffers[0]=F.slice(qe,qe+je)}}else Oe.json=JSON.parse(gw.decode(new Uint8Array(F,Me)));const{buffers:Fe,images:je,meshes:qe,extensionsUsed:He,bufferViews:xt}=Oe.json;let Pt=Promise.resolve();if(Fe){const F=[];for(let Me=0;Me<Fe.length;Me++){const je=Fe[Me];je.uri?F.push(Mv(je,Oe,Me,Le)):Oe.buffers[Me]||(Oe.buffers[Me]=null)}Pt=Promise.all(F)}return Pt.then((()=>{const F=[],Me=He&&He.includes(fw),Fe=He&&He.includes(mw);if(Me&&F.push(function(){if(!aw)return null!=ow?ow:(ow=function(F){let Me,Le=null;function n(){Me=new Uint8Array(Le.buffer)}function i(){throw new Error("Unexpected Draco error.")}const Oe={a:{a:i,d:function(F,Le,Oe){return Me.copyWithin(F,Le,Le+Oe)},c:function(F){const Oe=Me.length,Fe=Math.max(F>>>0,Math.ceil(1.2*Oe)),je=Math.ceil((Fe-Oe)/65536);try{return Le.grow(je),n(),!0}catch(F){return!1}},b:i}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(F,Oe):F.then((F=>F.arrayBuffer())).then((F=>WebAssembly.instantiate(F,Oe)))).then((F=>{const{Rb:Oe,Qb:Fe,P:je,T:qe,X:He,Ja:xt,La:Pt,Qa:jt,Va:Gt,Wa:bi,eb:wi,jb:qr,f:Xn,e:Yn,yb:yo,zb:bo,Ab:Ro,Bb:Do,Db:zs,Gb:Zs}=F.instance.exports;Le=Yn;const na=(()=>{let F=0,Le=0,je=0,qe=0;return He=>{je&&(Oe(qe),Oe(F),Le+=je,je=F=0),F||(Le+=128,F=Fe(Le));const xt=He.length+7&-8;let Pt=F;xt>=Le&&(je=xt,Pt=qe=Fe(xt));for(let F=0;F<He.length;F++)Me[Pt+F]=He[F];return Pt}})();return n(),Xn(),{memory:Yn,_free:Oe,_malloc:Fe,Mesh:class{constructor(){this.ptr=je()}destroy(){qe(this.ptr)}},Decoder:class{constructor(){this.ptr=xt()}destroy(){qr(this.ptr)}DecodeArrayToMesh(F,Me,Le){const Oe=na(F),Fe=Pt(this.ptr,Oe,Me,Le.ptr);return!!He(Fe)}GetAttributeByUniqueId(F,Me){return{ptr:jt(this.ptr,F.ptr,Me)}}GetTrianglesUInt16Array(F,Me,Le){Gt(this.ptr,F.ptr,Me,Le)}GetTrianglesUInt32Array(F,Me,Le){bi(this.ptr,F.ptr,Me,Le)}GetAttributeDataArrayForAllPoints(F,Me,Le,Oe,Fe){wi(this.ptr,F.ptr,Me.ptr,Le,Oe,Fe)}},DT_INT8:yo(),DT_UINT8:bo(),DT_INT16:Ro(),DT_UINT16:Do(),DT_UINT32:zs(),DT_FLOAT32:Zs()}}))}(fetch(cv())),ow.then((F=>{aw=F,ow=void 0})))}()),Fe&&F.push(function(){if(cw)return;const F=function(F){let Me;const Le=WebAssembly.instantiateStreaming(F,{}).then((F=>{Me=F.instance,Me.exports.__wasm_call_ctors()})),Oe={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Fe={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:Le,supported:!0,decodeGltfBuffer(F,Le,je,qe,He,xt){!function(F,Me,Le,Oe,Fe,je,qe){const He=F.exports.sbrk,xt=Oe+3&-4,Pt=He(xt*Fe),jt=He(je.length),Gt=new Uint8Array(F.exports.memory.buffer);Gt.set(je,jt);const bi=Me(Pt,Oe,Fe,jt,je.length);if(0===bi&&qe&&qe(Pt,xt,Fe),Le.set(Gt.subarray(Pt,Pt+Oe*Fe)),He(Pt-He(0)),0!==bi)throw new Error(`Malformed buffer data: ${bi}`)}(Me,Me.exports[Fe[He]],F,Le,je,qe,Me.exports[Oe[xt]])}}}(fetch(hv()));return F.ready.then((()=>{cw=F}))}()),je)for(let Me=0;Me<je.length;Me++)F.push(Iv(je[Me],Oe,Me,Le));return(F.length?Promise.all(F):Promise.resolve()).then((()=>{if(Me&&qe)for(const{primitives:F}of qe)for(const Me of F)gv(Me,Oe);if(Fe&&qe&&xt)for(const F of xt)vv(F,Oe);return Oe}))}))}function Pv(F,Me){const Le=F.json.bufferViews[Me.bufferView],Oe=uw[Me.componentType];return new Oe(F.buffers[Le.buffer],(Me.byteOffset||0)+(Le.byteOffset||0),Me.count*(Le.byteStride&&Le.byteStride!==pw[Me.type]*Oe.BYTES_PER_ELEMENT?Le.byteStride/Oe.BYTES_PER_ELEMENT:pw[Me.type]))}function Ev(F,Me,Le,Oe){const Fe=uw[Me.componentType],je=function(F){switch(F){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(Fe),qe=F.json.bufferViews[Me.bufferView],He=qe.byteStride?qe.byteStride/Fe.BYTES_PER_ELEMENT:pw[Me.type],xt=Le.float32,Pt=xt.length/Le.capacity;for(let F=0,Le=0;F<Me.count*He;F+=He,Le+=Pt)for(let Me=0;Me<Pt;Me++)xt[Le+Me]=Oe[F+Me]*je;Le._trim()}function zv(F,Me,Le){const Oe=F.indices,Fe=F.attributes,je={};je.indexArray=new ja;const qe=Me.json.accessors[Oe],He=qe.count/3;je.indexArray.reserve(He);const xt=Pv(Me,qe);for(let F=0;F<He;F++)je.indexArray.emplaceBack(xt[3*F],xt[3*F+1],xt[3*F+2]);je.indexArray._trim(),je.vertexArray=new za;const Pt=Me.json.accessors[Fe.POSITION];je.vertexArray.reserve(Pt.count);const jt=Pv(Me,Pt);for(let F=0;F<Pt.count;F++)je.vertexArray.emplaceBack(jt[3*F],jt[3*F+1],jt[3*F+2]);if(je.vertexArray._trim(),je.aabb=new Au(Pt.min,Pt.max),je.centroid=function(F,Me){const Le=[0,0,0],Oe=F.length;if(Oe>0){for(let Fe=0;Fe<Oe;Fe++){const Oe=3*F[Fe];Le[0]+=Me[Oe],Le[1]+=Me[Oe+1],Le[2]+=Me[Oe+2]}Le[0]/=Oe,Le[1]/=Oe,Le[2]/=Oe}return Le}(xt,jt),void 0!==Fe.COLOR_0){const F=Me.json.accessors[Fe.COLOR_0],Le=pw[F.type],Oe=Pv(Me,F);je.colorArray=3===Le?new za:new Da,je.colorArray.resize(F.count),Ev(Me,F,je.colorArray,Oe)}if(void 0!==Fe.NORMAL){je.normalArray=new za;const F=Me.json.accessors[Fe.NORMAL];je.normalArray.resize(F.count);const Le=Pv(Me,F);Ev(Me,F,je.normalArray,Le)}if(void 0!==Fe.TEXCOORD_0&&Le.length>0){je.texcoordArray=new Za;const F=Me.json.accessors[Fe.TEXCOORD_0];je.texcoordArray.resize(F.count);const Le=Pv(Me,F);Ev(Me,F,je.texcoordArray,Le)}if(void 0!==Fe._FEATURE_ID_RGBA4444){const F=Me.json.accessors[Fe._FEATURE_ID_RGBA4444];Me.json.extensionsUsed&&Me.json.extensionsUsed.includes("EXT_meshopt_compression")&&(je.featureData=Pv(Me,F))}void 0!==Fe._FEATURE_RGBA4444&&(je.featureData=new Uint32Array(Pv(Me,Me.json.accessors[Fe._FEATURE_RGBA4444]).buffer));const Gt=F.material;return je.material=function(F,Me){const{emissiveFactor:Le=[0,0,0],alphaMode:Oe="OPAQUE",alphaCutoff:Fe=.5,normalTexture:je,occlusionTexture:qe,emissiveTexture:He,doubleSided:xt}=F,{baseColorFactor:Pt=[1,1,1,1],metallicFactor:jt=1,roughnessFactor:Gt=1,baseColorTexture:bi,metallicRoughnessTexture:wi}=F.pbrMetallicRoughness||{},qr=qe?Me[qe.index]:void 0;if(qe&&qe.extensions&&qe.extensions.KHR_texture_transform&&qr){const F=qe.extensions.KHR_texture_transform;qr.offsetScale=[F.offset[0],F.offset[1],F.scale[0],F.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Se(...Pt),metallicFactor:jt,roughnessFactor:Gt,baseColorTexture:bi?Me[bi.index]:void 0,metallicRoughnessTexture:wi?Me[wi.index]:void 0},doubleSided:xt,emissiveFactor:Le,alphaMode:Oe,alphaCutoff:Fe,normalTexture:je?Me[je.index]:void 0,occlusionTexture:qr,emissionTexture:He?Me[He.index]:void 0,defined:void 0===F.defined}}(void 0!==Gt?Me.json.materials[Gt]:{defined:!1},Le),je}function kv(F,Me,Le){const{matrix:Oe,rotation:Fe,translation:je,scale:qe,mesh:He,extras:xt,children:Pt}=F,jt={};if(jt.matrix=Oe||bl.mat4.fromRotationTranslationScale([],Fe||[0,0,0,1],je||[0,0,0],qe||[1,1,1]),void 0!==He){jt.meshes=Le[He];const F=jt.anchor=[0,0];for(const Me of jt.meshes){const{min:Le,max:Oe}=Me.aabb;F[0]+=Le[0]+Oe[0],F[1]+=Le[1]+Oe[1]}F[0]=Math.floor(F[0]/jt.meshes.length/2),F[1]=Math.floor(F[1]/jt.meshes.length/2)}if(xt&&(xt.id&&(jt.id=xt.id),xt.lights&&(jt.lights=function(F){if(!F.length)return[];const Me=function(F){const Me=atob(F),Le=new Uint8Array(Me.length);for(let F=0;F<Me.length;F++)Le[F]=Me.codePointAt(F);return Le}(F),Le=[],Oe=Me.length/24,Fe=new Uint16Array(Me.buffer),je=new Float32Array(Me.buffer);for(let F=0;F<Oe;F++){const Me=Fe[2*F*6]/30,Oe=Fe[2*F*6+1]/30,qe=Fe[2*F*6+10]/100,He=je[6*F+1],xt=je[6*F+2],Pt=je[6*F+3],jt=je[6*F+4],Gt=Pt-He,bi=jt-xt,wi=Math.hypot(Gt,bi);Le.push({pos:[He+.5*Gt,xt+.5*bi,Oe],normal:[bi/wi,-Gt/wi,0],width:wi,height:Me,depth:qe,points:[He,xt,Pt,jt]})}return Le}(xt.lights))),Pt){const F=[];for(const Oe of Pt)F.push(kv(Me.json.nodes[Oe],Me,Le));jt.children=F}return jt}function Tv(F){if(0===F.vertices.length||0===F.indices.length)return null;const Me=new Sh(F.vertices,F.indices,8,256),[Le,Oe]=[Me.min.clone(),Me.max.clone()];return{vertices:F.vertices,indices:F.indices,grid:Me,min:Le,max:Oe}}function Bv(F){if(!F.extras||!F.extras.ground)return null;const Me=F.extras.ground;if(!Me||!Array.isArray(Me)||0===Me.length)return null;const Le=Me[0];if(!Le||!Array.isArray(Le)||0===Le.length)return null;const Oe=[];for(const F of Le){if(!Array.isArray(F)||2!==F.length)continue;const Me=F[0],Le=F[1];"number"==typeof Me&&"number"==typeof Le&&Oe.push(new ec(Me,Le))}if(Oe.length<3)return null;Oe.length>1&&Oe[Oe.length-1].equals(Oe[0])&&Oe.pop();let Fe=0;for(let F=0;F<Oe.length;F++){const Me=Oe[F],Le=Oe[(F+1)%Oe.length],je=Oe[(F+2)%Oe.length];Fe+=(Me.x-Le.x)*(je.y-Le.y)-(je.x-Le.x)*(Me.y-Le.y)}Fe>0&&Oe.reverse();const je=vc(Oe.flatMap((F=>[F.x,F.y])),[]);return 0===je.length?null:{vertices:Oe,indices:je}}function Vv(F,Me){const Le=[],Oe=[];let Fe=0;const je=[];for(const qe of F){Fe=Le.length;const F=qe.vertexArray.float32,He=qe.indexArray.uint16;for(let Oe=0;Oe<qe.vertexArray.length;Oe++)je[0]=F[3*Oe+0],je[1]=F[3*Oe+1],je[2]=F[3*Oe+2],bl.vec3.transformMat4(je,je,Me),Le.push(new ec(je[0],je[1]));for(let F=0;F<3*qe.indexArray.length;F++)Oe.push(He[F]+Fe)}if(Oe.length%3!=0)return null;for(let F=0;F<Oe.length;F+=3){const Me=Le[Oe[F+0]],Fe=Le[Oe[F+1]],je=Le[Oe[F+2]];(Me.x-Fe.x)*(je.y-Fe.y)-(je.x-Fe.x)*(Me.y-Fe.y)>0&&([Oe[F+1],Oe[F+2]]=[Oe[F+2],Oe[F+1]])}return{vertices:Le,indices:Oe}}function Cv(F){const Me=function(F,Me){const Le=[],Oe=WebGL2RenderingContext;if(F.json.textures)for(const Fe of F.json.textures){const je={magFilter:Oe.LINEAR,minFilter:Oe.NEAREST,wrapS:Oe.REPEAT,wrapT:Oe.REPEAT};void 0!==Fe.sampler&&Object.assign(je,F.json.samplers[Fe.sampler]),Le.push({image:Me[Fe.source],sampler:je,uploaded:!1})}return Le}(F,F.images),Le=function(F,Me){const Le=[];for(const Oe of F.json.meshes){const Fe=[];for(const Le of Oe.primitives)Fe.push(zv(Le,F,Me));Le.push(Fe)}return Le}(F,Me),{scenes:Oe,scene:Fe,nodes:je}=F.json,qe=Oe?Oe[Fe||0].nodes:je,He=[];for(const Me of qe)He.push(kv(je[Me],F,Le));return function(F,Me,Le){const Oe={},Fe=new Set;for(let je=0;je<F.length;je++){const F=Le[Me[je]];if(!F.extras)continue;const qe=F.extras["mapbox:footprint:version"],He=F.extras["mapbox:footprint:id"];(qe||He)&&Fe.add(je),"1.0.0"===qe&&He&&(Oe[He]=je)}for(let je=0;je<F.length;je++){if(Fe.has(je))continue;const qe=F[je],He=Le[Me[je]];if(!He.extras)continue;let xt=null;qe.id in Oe&&(xt=Vv(F[Oe[qe.id]].meshes,qe.matrix)),xt||(xt=Bv(He)),xt&&(qe.footprint=Tv(xt))}if(Fe.size>0){const Me=Array.from(Fe.values()).sort(((F,Me)=>F-Me));for(let Le=Me.length-1;Le>=0;Le--)F.splice(Me[Le],1)}}(He,qe,F.json.nodes),He}function Dv(F){F.heightmap=new Float32Array(4096),F.heightmap.fill(-1);const Me=F.vertexArray.float32,Le=F.aabb.min[0]-1,Oe=F.aabb.min[1]-1,Fe=_b/(F.aabb.max[0]-Le+2),je=_b/(F.aabb.max[1]-Oe+2);for(let qe=0;qe<Me.length;qe+=3){const He=Me[qe+2],xt=(Me[qe+0]-Le)*Fe|0,Pt=(Me[qe+1]-Oe)*je|0;He>F.heightmap[Pt*_b+xt]&&(F.heightmap[Pt*_b+xt]=He)}}function Rv(F,Me){const Le={};Le.indexArray=new ja,Le.indexArray.reserve(4*F.length),Le.vertexArray=new za,Le.vertexArray.reserve(10*F.length),Le.colorArray=new Da,Le.vertexArray.reserve(10*F.length);let Oe=0;for(const Fe of F){const F=Math.min(10,Math.max(4,1.3*Fe.height))*Me,je=[-Fe.normal[1],Fe.normal[0],0],qe=Math.min(.29,.1*Fe.width/Fe.depth),He=Fe.width-2*Fe.depth*Me*(qe+.01),xt=bl.vec3.scaleAndAdd([],Fe.pos,je,He/2),Pt=bl.vec3.scaleAndAdd([],Fe.pos,je,-He/2),jt=[xt[0],xt[1],xt[2]+Fe.height],Gt=[Pt[0],Pt[1],Pt[2]+Fe.height],bi=bl.vec3.scaleAndAdd([],Fe.normal,je,qe);bl.vec3.scale(bi,bi,F);const wi=bl.vec3.scaleAndAdd([],Fe.normal,je,-qe);bl.vec3.scale(wi,wi,F),bl.vec3.add(bi,xt,bi),bl.vec3.add(wi,Pt,wi),xt[2]+=.1,Pt[2]+=.1,Le.vertexArray.emplaceBack(bi[0],bi[1],bi[2]),Le.vertexArray.emplaceBack(wi[0],wi[1],wi[2]),Le.vertexArray.emplaceBack(xt[0],xt[1],xt[2]),Le.vertexArray.emplaceBack(Pt[0],Pt[1],Pt[2]),Le.vertexArray.emplaceBack(jt[0],jt[1],jt[2]),Le.vertexArray.emplaceBack(Gt[0],Gt[1],Gt[2]),Le.vertexArray.emplaceBack(xt[0],xt[1],xt[2]),Le.vertexArray.emplaceBack(Pt[0],Pt[1],Pt[2]),Le.vertexArray.emplaceBack(bi[0],bi[1],bi[2]),Le.vertexArray.emplaceBack(wi[0],wi[1],wi[2]);const qr=He/F/2;Le.colorArray.emplaceBack(-qr-qe,-1,qr,.8),Le.colorArray.emplaceBack(qr+qe,-1,qr,.8),Le.colorArray.emplaceBack(-qr,0,qr,1.3),Le.colorArray.emplaceBack(qr,0,qr,1.3),Le.colorArray.emplaceBack(qr+qe,-.8,qr,.7),Le.colorArray.emplaceBack(qr+qe,-.8,qr,.7),Le.colorArray.emplaceBack(0,0,qr,1.3),Le.colorArray.emplaceBack(0,0,qr,1.3),Le.colorArray.emplaceBack(qr+qe,-1.2,qr,.8),Le.colorArray.emplaceBack(qr+qe,-1.2,qr,.8),Le.indexArray.emplaceBack(6+Oe,4+Oe,8+Oe),Le.indexArray.emplaceBack(7+Oe,9+Oe,5+Oe),Le.indexArray.emplaceBack(0+Oe,1+Oe,2+Oe),Le.indexArray.emplaceBack(1+Oe,3+Oe,2+Oe),Oe+=10}const Fe={defined:!0,emissiveFactor:[0,0,0]},je={};return je.baseColorFactor=Se.white,Fe.pbrMetallicRoughness=je,Le.material=Fe,Le.aabb=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Le}class Lv{constructor(F){this._stringToNumber={},this._numberToString=[];for(let Me=0;Me<F.length;Me++){const Le=F[Me];this._stringToNumber[Le]=Me,this._numberToString[Me]=Le}}encode(F){return this._stringToNumber[F]}decode(F){return this._numberToString[F]}}const yw=["id","tile","layer","source","sourceLayer","state"];class Ov{constructor(F,Me,Le,Oe,Fe){this.type="Feature",this._vectorTileFeature=F,this._z=Me,this._x=Le,this._y=Oe,this.properties=F.properties,this.id=Fe}clone(){const F=new Ov(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(F.state=Object.assign({},this.state)),this.layer&&(F.layer=Object.assign({},this.layer)),this.source&&(F.source=this.source),this.sourceLayer&&(F.sourceLayer=this.sourceLayer),F}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(F){this._geometry=F}toJSON(){const F={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const Me of yw)void 0!==this[Me]&&(F[Me]=this[Me]);return F}}class Nv{constructor(F,Me){this.tileID=F,this.x=F.canonical.x,this.y=F.canonical.y,this.z=F.canonical.z,this.grid=new df(np,16,0),this.featureIndexArray=new ho,this.promoteId=Me,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(F,Me,Le,Oe,Fe,je=0,qe=0){const He=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(Le,Oe,Fe,je);const xt=this.grid;for(let F=0;F<Me.length;F++){const Le=Me[F],Oe=[1/0,1/0,-1/0,-1/0];for(let F=0;F<Le.length;F++){const Me=Le[F];Oe[0]=Math.min(Oe[0],Me.x),Oe[1]=Math.min(Oe[1],Me.y),Oe[2]=Math.max(Oe[2],Me.x),Oe[3]=Math.max(Oe[3],Me.y)}0!==qe&&(Oe[0]-=qe,Oe[1]-=qe,Oe[2]+=qe,Oe[3]+=qe),Oe[0]<np&&Oe[1]<np&&Oe[2]>=0&&Oe[3]>=0&&xt.insert(He,Oe[0],Oe[1],Oe[2],Oe[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new O_.VectorTile(new Dx(this.rawTileData)).layers,this.sourceLayerCoder=new Lv(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const F in this.vtLayers)this.vtFeatures[F]=[]}return this.vtLayers}query(F,Me){const{tilespaceGeometry:Le,transform:Oe,tileTransform:Fe,pixelPosMatrix:je,availableImages:qe}=Me;this.loadVTLayers(),this.serializedLayersCache.clear();const He=Le.bufferedTilespaceBounds,xt=this.grid.query(He.min.x,He.min.y,He.max.x,He.max.y,((F,Me,Oe,Fe)=>Xl(Le.bufferedTilespaceGeometry,F,Me,Oe,Fe)));xt.sort(jv);let Pt=null;Oe.elevation&&xt.length>0&&(Pt=Fy.create(Oe.elevation,this.tileID));const jt={};let Gt;for(let Me=0;Me<xt.length;Me++){const He=xt[Me];if(He===Gt)continue;Gt=He;const bi=this.featureIndexArray.get(He);let wi=null;this.is3DTile?this.loadMatchingModelFeature(jt,bi,F,Le,Oe):this.loadMatchingFeature(jt,bi,F,qe,((F,Me,qe,He=0)=>(wi||(wi=Vl(F,this.tileID.canonical,Fe)),Me.queryIntersectsFeature(Le,F,qe,wi,this.z,Oe,je,Pt,He))))}return jt}loadMatchingFeature(F,Me,Le,Oe,Fe){const{featureIndex:je,bucketIndex:qe,sourceLayerIndex:He,layoutVertexArrayOffset:xt}=Me,Pt=this.bucketLayerIDs[qe],jt=Le.layers,Gt=Object.keys(jt);if(Gt.length&&!function(F,Me){for(let Le=0;Le<F.length;Le++)if(Me.indexOf(F[Le])>=0)return!0;return!1}(Gt,Pt))return;const bi=Le.sourceCache,wi=this.sourceLayerCoder.decode(He),qr=this.vtLayers[wi].feature(je),Xn=this.getId(qr,wi);for(let Me=0;Me<Pt.length;Me++){const Le=Pt[Me];if(!jt[Le])continue;const{styleLayer:qe,targets:He}=jt[Le];let Gt={};void 0!==Xn&&(Gt=bi.getFeatureState(qe.sourceLayer,Xn));const wi=!Fe||Fe(qr,qe,Gt,xt);if(!wi)continue;const Yn=new Ov(qr,this.z,this.x,this.y,Xn);Yn.tile=this.tileID.canonical,Yn.state=Gt;let yo=this.serializedLayersCache.get(Le);yo||(yo=qe.serialize(),yo.id=Le,this.serializedLayersCache.set(Le,yo)),Yn.source=yo.source,Yn.sourceLayer=yo["source-layer"],Yn.layer=nt({},yo),Yn.layer.paint=Uv(yo.paint,qe.paint,qr,Gt,Oe),Yn.layer.layout=Uv(yo.layout,qe.layout,qr,Gt,Oe);let bo=!1;for(const F of He){this.updateFeatureProperties(Yn,F);const{filter:Me}=F;if(Me)if(qr.properties=Yn.properties,Me.needGeometry){const F=Cl(qr,!0);if(!Me.filter(new Rs(this.tileID.overscaledZ),F,this.tileID.canonical))continue}else if(!Me.filter(new Rs(this.tileID.overscaledZ),qr))continue;bo=!0,F.targetId&&this.addFeatureVariant(Yn,F)}bo&&this.appendToResult(F,Le,je,Yn,wi)}}loadMatchingModelFeature(F,Me,Le,Oe,Fe){const je=this.bucketLayerIDs[0][0],qe=Le.layers;if(!qe[je])return;const{styleLayer:He,targets:xt}=qe[je];if("model"!==He.type)return;const Pt=Oe.tile,jt=Me.featureIndex,Gt=Pt.getBucket(He);if(!(Gt&&Gt instanceof Gy))return;const bi=function(F,Me,Le,Oe){const Fe=F.getNodesInfo()[Me];if(Fe.hiddenByReplacement||!Fe.node.meshes)return;let je=Number.MAX_VALUE;const qe=Fe.node,He=Le.tile,xt=Oe.calculatePosMatrix(He.tileID.toUnwrapped(),Oe.worldSize),Pt=Fe.evaluatedScale;let jt=0;Oe.elevation&&qe.elevation&&(jt=qe.elevation*Oe.elevation.exaggeration()),bl.mat4.translate(xt,xt,[(qe.anchor?qe.anchor[0]:0)*(Pt[0]-1),(qe.anchor?qe.anchor[1]:0)*(Pt[1]-1),jt]),bl.mat4.scale(xt,xt,Pt);const Gt=Le.queryGeometry,bi=Gt.isPointQuery()?Gt.screenBounds:Gt.screenGeometry,f=function(F){const Me=bl.mat4.multiply([],xt,F.matrix);bl.mat4.multiply(Me,Oe.expandedFarZProjMatrix,Me);for(let Le=0;Le<F.meshes.length;++Le){const Fe=F.meshes[Le];if(Le===F.lightMeshIndex)continue;const qe=dy(bi,Oe,Me,Fe.aabb);null!=qe&&(je=Math.min(qe,je))}if(F.children)for(const Me of F.children)f(Me)};if(f(qe),je===Number.MAX_VALUE)return;const wi=new ul(0,0);return Zy(He.tileID.canonical,wi,Fe.node.anchor[0],Fe.node.anchor[1]),{intersectionZ:je,position:wi,feature:Fe.feature}}(Gt,jt,Oe,Fe);if(!bi)return;const{z:wi,x:qr,y:Xn}=Pt.tileID.canonical,{feature:Yn,intersectionZ:yo,position:bo}=bi;let Ro={};void 0!==Yn.id&&(Ro=Le.sourceCache.getFeatureState(He.sourceLayer,Yn.id));const Do=new Ov({},wi,qr,Xn,Yn.id);Do.tile=this.tileID.canonical,Do.state=Ro,Do.properties=Yn.properties,Do.geometry={type:"Point",coordinates:[bo.lng,bo.lat]};let zs=this.serializedLayersCache.get(je);zs||(zs=He.serialize(),zs.id=je,this.serializedLayersCache.set(je,zs)),Do.source=zs.source,Do.sourceLayer=zs["source-layer"],Do.layer=nt({},zs);let Zs=!1;for(const F of xt){this.updateFeatureProperties(Do,F);const{filter:Me}=F;if(Me)if(Yn.properties=Do.properties,Me.needGeometry){if(!Me.filter(new Rs(this.tileID.overscaledZ),Yn,this.tileID.canonical))continue}else if(!Me.filter(new Rs(this.tileID.overscaledZ),Yn))continue;Zs=!0,F.targetId&&this.addFeatureVariant(Do,F)}Zs&&this.appendToResult(F,je,jt,Do,yo)}updateFeatureProperties(F,Me,Le){if(Me.properties){const Oe={};for(const Fe in Me.properties){const je=Me.properties[Fe].evaluate({zoom:this.z},F._vectorTileFeature,F.state,F.tile,Le);null!=je&&(Oe[Fe]=je)}F.properties=Oe}}addFeatureVariant(F,Me,Le){const Oe={target:Me.target,namespace:Me.namespace,uniqueFeatureID:Me.uniqueFeatureID};Me.properties&&(Oe.properties=F.properties),F.variants=F.variants||{},F.variants[Me.targetId]=F.variants[Me.targetId]||[],F.variants[Me.targetId].push(Oe)}appendToResult(F,Me,Le,Oe,Fe){let je=F[Me];void 0===je&&(je=F[Me]=[]),je.push({featureIndex:Le,feature:Oe,intersectionZ:Fe})}lookupSymbolFeatures(F,Me,Le,Oe,Fe){const je={};this.loadVTLayers();for(const qe of F)this.loadMatchingFeature(je,{bucketIndex:Me,sourceLayerIndex:Le,featureIndex:qe,layoutVertexArrayOffset:0},Oe,Fe);return je}loadFeature(F){const{featureIndex:Me,sourceLayerIndex:Le}=F;this.loadVTLayers();const Oe=this.sourceLayerCoder.decode(Le),Fe=this.vtFeatures[Oe];if(Fe[Me])return Fe[Me];const je=this.vtLayers[Oe].feature(Me);return Fe[Me]=je,je}hasLayer(F){for(const Me of this.bucketLayerIDs)for(const Le of Me)if(F===Le)return!0;return!1}getId(F,Me){let Le=F.id;if(this.promoteId){const Oe=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[Me];if(null!=Oe)if(Array.isArray(Oe)){if(!this.promoteIdExpression){const F=Ji(Oe);if("success"!==F.result){const Me=F.value.map((F=>`${F.key}: ${F.message}`)).join(", ");return void pt(`Failed to create expression for promoteId: ${Me}`)}this.promoteIdExpression=F.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new yr),Le=this.promoteIdExpression.evaluate({zoom:0},F)}else Le=F.properties[Oe];"boolean"==typeof Le&&(Le=Number(Le))}return Le}}function Uv(F,Me,Le,Oe,Fe){return lt(F,((F,je)=>{const qe=Me instanceof $s?Me.get(je):null;return qe&&qe.evaluate?qe.evaluate(Le,Oe,Fe):qe}))}function jv(F,Me){return Me-F}us(Nv,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const xw=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class $v{static from(F){if(!(F instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[Me,Le]=new Uint8Array(F,0,2);if(219!==Me)throw new Error("Data does not appear to be in a KDBush format.");const Oe=Le>>4;if(1!==Oe)throw new Error(`Got v${Oe} data when expected v1.`);const Fe=xw[15&Le];if(!Fe)throw new Error("Unrecognized array type.");const[je]=new Uint16Array(F,2,1),[qe]=new Uint32Array(F,4,1);return new $v(qe,je,Fe,F)}constructor(F,Me=64,Le=Float64Array,Oe){if(isNaN(F)||F<0)throw new Error(`Unpexpected numItems value: ${F}.`);this.numItems=+F,this.nodeSize=Math.min(Math.max(+Me,2),65535),this.ArrayType=Le,this.IndexArrayType=F<65536?Uint16Array:Uint32Array;const Fe=xw.indexOf(this.ArrayType),je=2*F*this.ArrayType.BYTES_PER_ELEMENT,qe=F*this.IndexArrayType.BYTES_PER_ELEMENT,He=(8-qe%8)%8;if(Fe<0)throw new Error(`Unexpected typed array class: ${Le}.`);Oe&&Oe instanceof ArrayBuffer?(this.data=Oe,this.ids=new this.IndexArrayType(this.data,8,F),this.coords=new this.ArrayType(this.data,8+qe+He,2*F),this._pos=2*F,this._finished=!0):(this.data=new ArrayBuffer(8+je+qe+He),this.ids=new this.IndexArrayType(this.data,8,F),this.coords=new this.ArrayType(this.data,8+qe+He,2*F),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+Fe]),new Uint16Array(this.data,2,1)[0]=Me,new Uint32Array(this.data,4,1)[0]=F)}add(F,Me){const Le=this._pos>>1;return this.ids[Le]=Le,this.coords[this._pos++]=F,this.coords[this._pos++]=Me,Le}finish(){const F=this._pos>>1;if(F!==this.numItems)throw new Error(`Added ${F} items when expected ${this.numItems}.`);return Gv(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(F,Me,Le,Oe){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Fe,coords:je,nodeSize:qe}=this,He=[0,Fe.length-1,0],xt=[];for(;He.length;){const Pt=He.pop()||0,jt=He.pop()||0,Gt=He.pop()||0;if(jt-Gt<=qe){for(let qe=Gt;qe<=jt;qe++){const He=je[2*qe],Pt=je[2*qe+1];He>=F&&He<=Le&&Pt>=Me&&Pt<=Oe&&xt.push(Fe[qe])}continue}const bi=Gt+jt>>1,wi=je[2*bi],qr=je[2*bi+1];wi>=F&&wi<=Le&&qr>=Me&&qr<=Oe&&xt.push(Fe[bi]),(0===Pt?F<=wi:Me<=qr)&&(He.push(Gt),He.push(bi-1),He.push(1-Pt)),(0===Pt?Le>=wi:Oe>=qr)&&(He.push(bi+1),He.push(jt),He.push(1-Pt))}return xt}within(F,Me,Le){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Oe,coords:Fe,nodeSize:je}=this,qe=[0,Oe.length-1,0],He=[],xt=Le*Le;for(;qe.length;){const Pt=qe.pop()||0,jt=qe.pop()||0,Gt=qe.pop()||0;if(jt-Gt<=je){for(let Le=Gt;Le<=jt;Le++)Zv(Fe[2*Le],Fe[2*Le+1],F,Me)<=xt&&He.push(Oe[Le]);continue}const bi=Gt+jt>>1,wi=Fe[2*bi],qr=Fe[2*bi+1];Zv(wi,qr,F,Me)<=xt&&He.push(Oe[bi]),(0===Pt?F-Le<=wi:Me-Le<=qr)&&(qe.push(Gt),qe.push(bi-1),qe.push(1-Pt)),(0===Pt?F+Le>=wi:Me+Le>=qr)&&(qe.push(bi+1),qe.push(jt),qe.push(1-Pt))}return He}}function Gv(F,Me,Le,Oe,Fe,je){if(Fe-Oe<=Le)return;const qe=Oe+Fe>>1;Yv(F,Me,qe,Oe,Fe,je),Gv(F,Me,Le,Oe,qe-1,1-je),Gv(F,Me,Le,qe+1,Fe,1-je)}function Yv(F,Me,Le,Oe,Fe,je){for(;Fe>Oe;){if(Fe-Oe>600){const qe=Fe-Oe+1,He=Le-Oe+1,xt=Math.log(qe),Pt=.5*Math.exp(2*xt/3),jt=.5*Math.sqrt(xt*Pt*(qe-Pt)/qe)*(He-qe/2<0?-1:1);Yv(F,Me,Le,Math.max(Oe,Math.floor(Le-He*Pt/qe+jt)),Math.min(Fe,Math.floor(Le+(qe-He)*Pt/qe+jt)),je)}const qe=Me[2*Le+je];let He=Oe,xt=Fe;for(Hv(F,Me,Oe,Le),Me[2*Fe+je]>qe&&Hv(F,Me,Oe,Fe);He<xt;){for(Hv(F,Me,He,xt),He++,xt--;Me[2*He+je]<qe;)He++;for(;Me[2*xt+je]>qe;)xt--}Me[2*Oe+je]===qe?Hv(F,Me,Oe,xt):(xt++,Hv(F,Me,xt,Fe)),xt<=Le&&(Oe=xt+1),Le<=xt&&(Fe=xt-1)}}function Hv(F,Me,Le,Oe){Xv(F,Le,Oe),Xv(Me,2*Le,2*Oe),Xv(Me,2*Le+1,2*Oe+1)}function Xv(F,Me,Le){const Oe=F[Me];F[Me]=F[Le],F[Le]=Oe}function Zv(F,Me,Le,Oe){const Fe=F-Le,je=Me-Oe;return Fe*Fe+je*je}Me.$=gr,Me.A=ge,Me.B=tr,Me.C=pa,Me.D=ng,Me.E=_e,Me.F=2,Me.G=pd,Me.H=cd,Me.I=we,Me.J=class extends My{},Me.K=pr,Me.L=Be,Me.M=Ws,Me.N=Ui,Me.O=Fi,Me.P=ec,Me.Q=Ni,Me.R=zh,Me.S=Ki,Me.T=qm,Me.U=Ks,Me.V=My,Me.W=es,Me.X=Ji,Me.Y=Vn,Me.Z=Dn,Me._=Bn,Me.a=function(F){return yc.API_CDN_URL_REGEX.test(F)},Me.a$=Cl,Me.a0=fu,Me.a1=Js,Me.a2=ji,Me.a3=Oi,Me.a4=function(F){const Me=F.value;let Le=[];if(!Me)return Le;const Oe=pr(Me);return"string"!==Oe?(Le=Le.concat([new My(F.key,Me,`string expected, "${Oe}" found`)]),Le):(Ay(Me,!0)||(Le=Le.concat([new My(F.key,Me,`invalid url "${Me}"`)])),Le)},Me.a5=Cf,Me.a6=Os,Me.a7=Xs,Me.a8=Gs,Me.a9=class{constructor(F){this.specification=F}possiblyEvaluate(F,Me){return mt(F.expression.evaluate(Me))}interpolate(F,Me,Le){return{x:Ee(F.x,Me.x,Le),y:Ee(F.y,Me.y,Le),z:Ee(F.z,Me.z,Le),azimuthal:Ee(F.azimuthal,Me.azimuthal,Le),polar:Ee(F.polar,Me.polar,Le)}}},Me.aA=function(F,Me){const Le={};for(let Oe=0;Oe<Me.length;Oe++){const Fe=Me[Oe];Fe in F&&(Le[Fe]=F[Fe])}return Le},Me.aB=cl,Me.aC=ml,Me.aD=class{constructor(F){this.entries={},this.scheduler=F}request(F,Me,Le,Oe){const Fe=this.entries[F]=this.entries[F]||{callbacks:[]};if(Fe.result){const[F,Le]=Fe.result;return this.scheduler?this.scheduler.add((()=>{Oe(F,Le)}),Me):Oe(F,Le),()=>{}}return Fe.callbacks.push(Oe),Fe.cancel||(Fe.cancel=Le(((Le,Oe)=>{Fe.result=[Le,Oe];for(const F of Fe.callbacks)this.scheduler?this.scheduler.add((()=>{F(Le,Oe)}),Me):F(Le,Oe);setTimeout((()=>delete this.entries[F]),3e3)}))),()=>{Fe.result||(Fe.callbacks=Fe.callbacks.filter((F=>F!==Oe)),Fe.callbacks.length||(Fe.cancel(),delete this.entries[F]))}}},Me.aE=function(Me,Le,Oe){const Fe=JSON.stringify(Me.request);return Me.data&&((this||F).deduped.entries[Fe]={result:[null,Me.data]}),(this||F).deduped.request(Fe,{type:"parseTile",isSymbolTile:Me.isSymbolTile,zoom:Me.tileZoom},(F=>{const Le=ne(Me.request,((Me,Le,Fe,je)=>{Me?F(Me):Le&&F(null,{vectorTile:Oe?void 0:new O_.VectorTile(new Dx(Le)),rawData:Le,cacheControl:Fe,expires:je})}));return()=>{Le.cancel(),F()}}),Le)},Me.aF=function(F){ph++,ph>oh&&(F.getActor().send("enforceCacheSizeLimit",rh),ph=0)},Me.aG=function(F){return F<=1?1:Math.pow(2,Math.floor(Math.log(F)/Math.LN2))},Me.aH=uu,Me.aI=Wm,Me.aJ=ry,Me.aK=Xm,Me.aL=function(F,Me){const Le=document.createElement("video");Le.muted=!0,Le.onloadstart=function(){Me(null,Le)};for(let Me=0;Me<F.length;Me++){const Oe=document.createElement("source");ie(F[Me])||(Le.crossOrigin="Anonymous"),Oe.src=F[Me],Le.appendChild(Oe)}return{cancel:()=>{}}},Me.aM=$m,Me.aN=function(F){return fetch(F).then((F=>F.arrayBuffer())).then((Me=>Sv(Me,0,F)))},Me.aO=Cv,Me.aP=class{constructor(F,Me,Le,Oe){this.id=F,this.position=null!=Me?new ul(Me[0],Me[1]):new ul(0,0),this.orientation=null!=Le?Le:[0,0,0],this.nodes=Oe,this.uploaded=!1,this.aabb=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(F,Me){if(bl.mat4.multiply(F.matrix,Me,F.matrix),F.meshes)for(const Me of F.meshes){const Le=Au.applyTransformFast(Me.aabb,F.matrix);this.aabb.encapsulate(Le)}if(F.children)for(const Me of F.children)this._applyTransformations(Me,F.matrix)}computeBoundsAndApplyParent(){const F=bl.mat4.identity([]);for(const Me of this.nodes)this._applyTransformations(Me,F)}computeModelMatrix(F,Me,Le,Oe,Fe,je,qe=!1){By(this.matrix,this,F.transform,this.position,Me,Le,Oe,Fe,je,qe)}upload(F){if(!this.uploaded){for(const Me of this.nodes)Dy(Me,F);for(const F of this.nodes)Ry(F);this.uploaded=!0}}destroy(){for(const F of this.nodes)Ly(F)}},Me.aQ=ot,Me.aR=Kd,Me.aS=gl,Me.aT=xl,Me.aU=Ma,Me.aV=ja,Me.aW=st,Me.aX=no,Me.aY=zm,Me.aZ=function(){If.isLoading()||If.isLoaded()||"deferred"!==Vs()||Cs()},Me.a_=Qs,Me.aa=Rs,Me.ab=ts,Me.ac=Il,Me.ad=bl,Me.ae=tt,Me.af=$s,Me.ag=$u,Me.ah=Ee,Me.ai=np,Me.aj=ze,Me.ak=H,Me.al=Se,Me.am=class{constructor(F){this.specification=F}possiblyEvaluate(F,Me){return function([F,Me]){const Le=mt([1,F,Me]);return{x:Le.x,y:Le.y,z:Le.z}}(F.expression.evaluate(Me))}interpolate(F,Me,Le){return{x:Ee(F.x,Me.x,Le),y:Ee(F.y,Me.y,Le),z:Ee(F.z,Me.z,Le)}}},Me.an=function(F,Me,Le=0,Oe=!0){const Fe=new ec(Le,Le),je=F.sub(Fe),qe=Me.add(Fe),He=[je,new ec(qe.x,je.y),qe,new ec(je.x,qe.y)];return Oe&&He.push(je.clone()),He},Me.ao=function(F,Me){const Le=[];for(let Oe=0;Oe<F.length;Oe++){const Fe=et(Oe-1,-1,F.length-1),je=et(Oe+1,-1,F.length-1),qe=F[Oe],He=F[je],xt=F[Fe].sub(qe).unit(),Pt=He.sub(qe).unit(),jt=Pt.angleWithSep(xt.x,xt.y),Gt=xt.add(Pt).unit().mult(-1*Me/Math.sin(jt/2));Le.push(qe.add(Gt))}return Le},Me.ap=Jd,Me.aq=Xl,Me.ar=function(F,Me,Le=0){return bl.vec3.fromValues(((Me.x-Le)*F.scale-F.x)*np,(Me.y*F.scale-F.y)*np,vl(Me.z,Me.y))},Me.as=gu,Me.at=Wp,Me.au=function(F){let Me=1/0,Le=1/0,Oe=-1/0,Fe=-1/0;for(const je of F)Me=Math.min(Me,je.x),Le=Math.min(Le,je.y),Oe=Math.max(Oe,je.x),Fe=Math.max(Fe,je.y);return{min:new ec(Me,Le),max:new ec(Oe,Fe)}},Me.av=dl,Me.aw=Hl,Me.ax=Pl,Me.ay=Q,Me.az=_m,Me.b=function(F){return yc.API_FONTS_REGEX.test(F)},Me.b$=oy,Me.b0=Ov,Me.b1=gt,Me.b2=Yp,Me.b3=_h,Me.b4=Vl,Me.b5=_a,Me.b6=Ka,Me.b7=h_,Me.b8=xo,Me.b9=vc,Me.bA=Jh,Me.bB=Nd,Me.bC=Cd,Me.bD=Kf,Me.bE=$v,Me.bF=et,Me.bG=vt,Me.bH=yl,Me.bI=function(F,Me,Le){F[4*Me+0]=Le[0],F[4*Me+1]=Le[1],F[4*Me+2]=Le[2],F[4*Me+3]=Le[3]},Me.bJ=Co,Me.bK=zo,Me.bL=ko,Me.bM=Eo,Me.bN=Po,Me.bO=ul,Me.bP=vm,Me.bQ=lu,Me.bR=Mu,Me.bS=ay,Me.bT=ou,Me.bU=Vu,Me.bV=function(F,Me,Le,Oe,Fe,je,qe,He,xt){if("globe"===xt.name)return Vu(F,Me,new ou(Le,Oe,Fe),!1);const Pt=Kd({z:Le,x:Oe,y:Fe},xt);return new Au([(je+Pt.x/Pt.scale)*Me,Me*(Pt.y/Pt.scale),qe],[(je+Pt.x2/Pt.scale)*Me,Me*(Pt.y2/Pt.scale),He])},Me.bW=function(F,Me,Le){let Oe=0;for(let Le=0;Le<2;++Le){const Fe=0;F[Le]>Fe&&(Oe+=(F[Le]-Fe)*(F[Le]-Fe)),Me[Le]<Fe&&(Oe+=(Fe-Me[Le])*(Fe-Me[Le]))}return Oe},Me.bX=Jm,Me.bY=Tm,Me.bZ=function(F){const Me=bl.mat4.identity(new Float64Array(16));bl.mat4.multiply(Me,F.pixelMatrix,F.globeMatrix);const Le=[0,km,0],Oe=[0,Fm,0];return bl.vec3.transformMat4(Le,Le,Me),bl.vec3.transformMat4(Oe,Oe,Me),[Le[0]>0&&Le[0]<=F.width&&Le[1]>0&&Le[1]<=F.height&&!Yu(F,new ul(F.center.lat,90)),Oe[0]>0&&Oe[0]<=F.width&&Oe[1]>0&&Oe[1]<=F.height&&!Yu(F,new ul(F.center.lat,-90))]},Me.b_=function(F,Me){const{scale:Le}=F.tileTransform,Oe=Le*np/(F.tileSize*Math.pow(2,Me.zoom-F.tileID.overscaledZ+F.tileID.canonical.z));return bl.mat2.scale(new Float32Array(4),Me.inverseAdjustmentMatrix,[Oe,Oe])},Me.ba=Jv,Me.bb=function(F,Me){const Le=$u(Me.zoom);if(0===Le)return ku(F);const Oe=Cu(F),Fe=Du(Oe),je=dl(Oe.getWest())*Me.worldSize,qe=dl(Oe.getEast())*Me.worldSize,He=ml(Oe.getNorth())*Me.worldSize,xt=ml(Oe.getSouth())*Me.worldSize,Pt=[je,He,0],jt=[qe,He,0],Gt=[je,xt,0],bi=[qe,xt,0],wi=bl.mat4.invert([],Me.globeMatrix);return bl.vec3.transformMat4(Pt,Pt,wi),bl.vec3.transformMat4(jt,jt,wi),bl.vec3.transformMat4(Gt,Gt,wi),bl.vec3.transformMat4(bi,bi,wi),Fe[0]=Tu(Fe[0],Gt,Le),Fe[1]=Tu(Fe[1],bi,Le),Fe[2]=Tu(Fe[2],jt,Le),Fe[3]=Tu(Fe[3],Pt,Le),Au.fromPoints(Fe)},Me.bc=Ou,Me.bd=Ru,Me.be=Tu,Me.bf=wa,Me.bg=c_,Me.bh=ev,Me.bi=Dx,Me.bj=ne,Me.bk=function(F,Me){const Le=[];for(const Oe in F)Oe in Me||Le.push(Oe);return Le},Me.bl=rt,Me.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],Me.bn=$,Me.bo=function(F,Me){const{x:Le,y:Oe}=F.point,Fe=qu(Le,Oe,F.worldSize/F._pixelsPerMercatorPixel,0,0);return bl.mat4.multiply(Fe,Fe,Nu(ku(Me)))},Me.bp=wf,Me.bq=Fx,Me.br=_f,Me.bs=function(F,Me,Le,Oe,Fe){const je=5*Me+2;F.float32[je+0]=Le,F.float32[je+1]=Oe,F.float32[je+2]=Fe},Me.bt=Im,Me.bu=ud,Me.bv=Fl,Me.bw=Sx,Me.bx=jh,Me.by=pb,Me.bz=Kh,Me.c=St,Me.c$=tf,Me.c0=sy,Me.c1=function(F){const Me=sy(F,!0);return bl.mat2.invert([],[Me[0],Me[1],Me[4],Me[5]])},Me.c2=xu,Me.c3=function(F){const{x:Me,y:Le}=F.point,{lng:Oe,lat:Fe}=F._center;return qu(Me,Le,F.worldSize,Oe,Fe)},Me.c4=X,Me.c5=cu,Me.c6=bm,Me.c7=function(F){const Me=Math.round((F+45+360)%360/90)%4;return oc[Me]},Me.c8=45,Me.c9=ke,Me.cA=Bo,Me.cB=class extends So{constructor(F){super(F),this.current=sm}set(F,Me,Le){if(this.fetchUniformLocation(F,Me))for(let F=0;F<9;F++)if(Le[F]!==this.current[F]){this.current=Le,this.gl.uniformMatrix3fv(this.location,!1,Le);break}}},Me.cC=W,Me.cD=function(F,Me,Le){const Oe=$u(Le.zoom),Fe=F.style.map._antialias,je=F.terrain&&F.terrain.exaggeration()>0;return 0===Oe&&!Fe&&!je},Me.cE=function(F){const Me=F.pixelsPerMeter,Le=Me/yl(1,F.center.lat),Oe=bl.mat4.identity(new Float64Array(16));return bl.mat4.translate(Oe,Oe,[F.point.x,F.point.y,0]),bl.mat4.scale(Oe,Oe,[Le,Le,Me]),Float32Array.from(Oe)},Me.cF=Cu,Me.cG=function(F){const Me=Jm-5;F=Q(F,-Me,Me)/Me*90;const Le=Math.pow(Math.abs(Math.sin(H(F))),3);return Math.round(Le*(Om.length-1))},Me.cH=function(F,Me,Le,Oe){const Fe=Me.getNorth(),je=Me.getSouth(),qe=Me.getWest(),He=Me.getEast(),xt=1<<F.z,Pt=He-qe,jt=Fe-je,Gt=Pt/Lm,bi=-jt/Om[Le],wi=[0,Gt,0,bi,0,0,Fe,qe,0];if(F.z>0){const F=180/Oe;bl.mat3.multiply(wi,wi,[F/Pt+1,0,0,0,F/jt+1,0,-.5*F/Gt,.5*F/bi,1])}return wi[2]=xt,wi[5]=F.x,wi[8]=F.y,wi},Me.cI=ku,Me.cJ=function(F,Me,Le){const Oe=bl.mat4.identity(new Float64Array(16)),Fe=(Me/(1<<F)-.5)*Math.PI*2;return bl.mat4.rotateY(Oe,Le.globeMatrix,Fe),Float32Array.from(Oe)},Me.cK=class{isDataAvailableAtPoint(F){const Me=this._source();if(this.isUsingMockSource()||!Me||F.y<0||F.y>1)return!1;const Le=Me.getSource().maxzoom,Oe=1<<Le,Fe=Math.floor(F.x),je=Math.floor((F.x-Fe)*Oe),qe=Math.floor(F.y*Oe),He=this.findDEMTileFor(new uu(Le,Fe,Le,je,qe));return!(!He||!He.dem)}getAtPointOrZero(F,Me=0){return this.getAtPoint(F,Me)||0}getAtPoint(F,Me,Le=!0){if(this.isUsingMockSource())return null;null==Me&&(Me=null);const Oe=this._source();if(!Oe)return Me;if(F.y<0||F.y>1)return Me;const Fe=Oe.getSource().maxzoom,je=1<<Fe,qe=Math.floor(F.x),He=F.x-qe,xt=new uu(Fe,qe,Fe,Math.floor(He*je),Math.floor(F.y*je)),Pt=this.findDEMTileFor(xt);if(!Pt||!Pt.dem)return Me;const jt=Pt.dem,Gt=1<<Pt.tileID.canonical.z,bi=(He*Gt-Pt.tileID.canonical.x)*jt.dim,wi=(F.y*Gt-Pt.tileID.canonical.y)*jt.dim,qr=Math.floor(bi),Xn=Math.floor(wi);return(Le?this.exaggeration():1)*Ee(Ee(jt.get(qr,Xn),jt.get(qr,Xn+1),wi-Xn),Ee(jt.get(qr+1,Xn),jt.get(qr+1,Xn+1),wi-Xn),bi-qr)}getAtTileOffset(F,Me,Le){const Oe=1<<F.canonical.z;return this.getAtPointOrZero(new Il(F.wrap+(F.canonical.x+Me/np)/Oe,(F.canonical.y+Le/np)/Oe))}getAtTileOffsetFunc(F,Me,Le,Oe){return Fe=>{const je=this.getAtTileOffset(F,Fe.x,Fe.y),qe=Oe.upVector(F.canonical,Fe.x,Fe.y),He=Oe.upVectorScale(F.canonical,Me,Le).metersToTile;return bl.vec3.scale(qe,qe,je*He),qe}}getForTilePoints(F,Me,Le,Oe){if(this.isUsingMockSource())return!1;const Fe=Fy.create(this,F,Oe);return!!Fe&&(Me.forEach((F=>{F[2]=this.exaggeration()*Fe.getElevationAt(F[0],F[1],Le)})),!0)}getMinMaxForTile(F){if(this.isUsingMockSource())return null;const Me=this.findDEMTileFor(F);if(!Me||!Me.dem)return null;const Le=Me.dem.tree,Oe=Me.tileID,Fe=1<<F.canonical.z-Oe.canonical.z;let je=F.canonical.x/Fe-Oe.canonical.x,qe=F.canonical.y/Fe-Oe.canonical.y,He=0;for(let Me=0;Me<F.canonical.z-Oe.canonical.z&&!Le.leaves[He];Me++){je*=2,qe*=2;const F=2*Math.floor(qe)+Math.floor(je);He=Le.childOffsets[He]+F,je%=1,qe%=1}return{min:this.exaggeration()*Le.minimums[He],max:this.exaggeration()*Le.maximums[He]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(F,Me,Le){throw new Error("Pure virtual method called.")}pointCoordinate(F){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(F){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const F=this.visibleDemTiles;if(0===F.length)return null;let Me=!1,Le=Number.MAX_VALUE,Oe=Number.MIN_VALUE;for(const Fe of F){const F=this.getMinMaxForTile(Fe.tileID);F&&(Le=Math.min(Le,F.min),Oe=Math.max(Oe,F.max),Me=!0)}return Me?{min:Le,max:Oe}:null}},Me.cL=fc,Me.cM=Iu,Me.cN=function(F,Me){return[Math.pow(F[0],2.2)*Me,Math.pow(F[1],2.2)*Me,Math.pow(F[2],2.2)*Me]},Me.cO=ju,Me.cP=Mt,Me.cQ=wt,Me.cR=256,Me.cS=function(F,Me){const Le=[0,0,0],Oe=Ou(ku(Me.canonical));return bl.vec3.transformMat4(Le,Le,Oe),bl.vec3.transformMat4(Le,Le,F),Le},Me.cT=F=>({u_camera_to_center_distance:new Eo(F),u_extrude_scale:new Lo(F),u_device_pixel_ratio:new Eo(F),u_matrix:new Co(F),u_inv_rot_matrix:new Co(F),u_merc_center:new zo(F),u_tile_id:new ko(F),u_zoom_transition:new Eo(F),u_up_dir:new ko(F),u_emissive_strength:new Eo(F)}),Me.cU=F=>({u_matrix:new Co(F),u_pixels_to_tile_units:new Lo(F),u_device_pixel_ratio:new Eo(F),u_width_scale:new Eo(F),u_floor_width_scale:new Eo(F),u_units_to_pixels:new zo(F),u_dash_image:new Po(F),u_gradient_image:new Po(F),u_image_height:new Eo(F),u_texsize:new zo(F),u_tile_units_to_pixels:new Eo(F),u_alpha_discard_threshold:new Eo(F),u_trim_offset:new zo(F),u_trim_fade_range:new zo(F),u_trim_color:new To(F),u_emissive_strength:new Eo(F),u_zbias_factor:new Eo(F),u_tile_to_meter:new Eo(F)}),Me.cV=F=>({u_matrix:new Co(F),u_texsize:new zo(F),u_pixels_to_tile_units:new Lo(F),u_device_pixel_ratio:new Eo(F),u_width_scale:new Eo(F),u_floor_width_scale:new Eo(F),u_image:new Po(F),u_units_to_pixels:new zo(F),u_tile_units_to_pixels:new Eo(F),u_alpha_discard_threshold:new Eo(F),u_trim_offset:new zo(F),u_trim_fade_range:new zo(F),u_trim_color:new To(F),u_emissive_strength:new Eo(F),u_zbias_factor:new Eo(F),u_tile_to_meter:new Eo(F)}),Me.cW=Na,Me.cX=Tx,Me.cY=Mx,Me.cZ=Ku,Me.c_=(F,Me,Le,Oe,Fe,je)=>{const qe=F.transform,He="globe"===qe.projection.name;let xt;if("map"===je.paint.get("circle-pitch-alignment"))if(He){const F=ju(qe.zoom,Me.canonical)*qe._pixelsPerMercatorPixel;xt=Float32Array.from([F,0,0,F])}else xt=qe.calculatePixelsToTileUnitsMatrix(Le);else xt=new Float32Array([qe.pixelsToGLUnits[0],0,0,qe.pixelsToGLUnits[1]]);const Pt={u_camera_to_center_distance:F.transform.getCameraToCenterDistance(qe.projection),u_matrix:F.translatePosMatrix(Me.projMatrix,Le,je.paint.get("circle-translate"),je.paint.get("circle-translate-anchor")),u_device_pixel_ratio:eh.devicePixelRatio,u_extrude_scale:xt,u_inv_rot_matrix:__,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:je.paint.get("circle-emissive-strength")};if(He){Pt.u_inv_rot_matrix=Oe,Pt.u_merc_center=Fe,Pt.u_tile_id=[Me.canonical.x,Me.canonical.y,1<<Me.canonical.z],Pt.u_zoom_transition=$u(qe.zoom);const F=Fe[0]*np,Le=Fe[1]*np;Pt.u_up_dir=qe.projection.upVector(new ou(0,0,0),F,Le)}return Pt},Me.ca=fl,Me.cb=To,Me.cc=function(F,Me,Le){const Oe=Math.sqrt(F*F+Me*Me+Le*Le),Fe=Oe>0?Math.acos(Le/Oe)*ic:0;let je=0!==F||0!==Me?Math.atan2(-Me,-F)*ic+90:0;return je<0&&(je+=360),[Oe,je,Fe]},Me.cd=Al,Me.ce=Au,Me.cf=mt,Me.cg=function(F){return[Math.pow(F[0],1/2.2),Math.pow(F[1],1/2.2),Math.pow(F[2],1/2.2)]},Me.ch=function(F,Me){return F.readFields(dg,{icons:[]},Me)},Me.ci=function(F){return F({pluginStatus:Tf,pluginURL:Ef}),Mf.on("pluginStateChange",F),F},Me.cj=ag,Me.ck=bd,Me.cl=Hx,Me.cm=Dh,Me.cn=ks,Me.co=Rt,Me.cp=hu,Me.cq=ct,Me.cr=function(F){const Me=F.indexOf(Df);return Me>=0?F.slice(0,Me):F},Me.cs=function(F){return F.indexOf(Df)>=0},Me.ct=function(F){const Me=F.indexOf(Df);return Me>=0?F.slice(Me+1):""},Me.cu=function(F){const Me=[],Le=F.id;return void 0===Le&&Me.push({message:`layers.${Le}: missing required property "id"`}),void 0===F.render&&Me.push({message:`layers.${Le}: missing required method "render"`}),F.renderingMode&&"2d"!==F.renderingMode&&"3d"!==F.renderingMode&&Me.push({message:`layers.${Le}: property "renderingMode" must be either "2d" or "3d"`}),Me},Me.cv=function(F,Me,Le,Oe){return"custom"===F.type?new ny(F,Me):new bb[F.type](F,Me,Le,Oe)},Me.cw=ut,Me.cx=class extends Ov{constructor(F,Me){super(F._vectorTileFeature,F._z,F._x,F._y,F.id),F.state&&(this.state=Object.assign({},F.state)),this.target=Me.target,this.namespace=Me.namespace,Me.properties&&(this.properties=Me.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=F.source,this.sourceLayer=F.sourceLayer,this.layer=F.layer)}toJSON(){const F=super.toJSON();return F.target=this.target,F.namespace=this.namespace,F}},Me.cy=Mf,Me.cz=re,Me.d=function(F){return yc.API_TILEJSON_REGEX.test(F)},Me.d$=Lv,Me.d0=er,Me.d1=(F,Me,Le,Oe,Fe,je,qe,He)=>{const xt=F.transform,Pt=xt.pitch<15?Kp(.07,.7,Q((14-xt.zoom)/5,0,1)):.07,jt="none"===Le.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:Qp(F,Me,Le,Oe),u_texsize:Me.imageAtlasTexture?Me.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:xt.calculatePixelsToTileUnitsMatrix(Me),u_device_pixel_ratio:Fe,u_width_scale:je,u_floor_width_scale:qe,u_image:0,u_tile_units_to_pixels:Jp(Me,xt),u_units_to_pixels:[1/xt.pixelsToGLUnits[0],1/xt.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:He,u_trim_fade_range:Le.paint.get("line-trim-fade-range"),u_trim_color:Le.paint.get("line-trim-color").toRenderColor(jt?null:Le.lut).toArray01(),u_emissive_strength:Le.paint.get("line-emissive-strength"),u_zbias_factor:Pt,u_tile_to_meter:Al(Me.tileID.canonical,0)}},Me.d2=(F,Me,Le,Oe,Fe,je,qe,He,xt)=>{const Pt=F.transform,jt=Pt.calculatePixelsToTileUnitsMatrix(Me),Gt="none"===Le.paint.get("line-trim-color-use-theme").constantOr("default"),bi=Pt.pitch<15?Kp(.07,.7,Q((14-Pt.zoom)/5,0,1)):.07;return{u_matrix:Qp(F,Me,Le,Oe),u_pixels_to_tile_units:jt,u_device_pixel_ratio:je,u_width_scale:qe,u_floor_width_scale:He,u_units_to_pixels:[1/Pt.pixelsToGLUnits[0],1/Pt.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:Fe,u_texsize:ef(Le)&&Me.lineAtlasTexture?Me.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Jp(Me,F.transform),u_alpha_discard_threshold:0,u_trim_offset:xt,u_trim_fade_range:Le.paint.get("line-trim-fade-range"),u_trim_color:Le.paint.get("line-trim-color").toRenderColor(Gt?null:Le.lut).toArray01(),u_emissive_strength:Le.paint.get("line-emissive-strength"),u_zbias_factor:bi,u_tile_to_meter:Al(Me.tileID.canonical,0)}},Me.d3=at,Me.d4=dc,Me.d5=vl,Me.d6=Pp,Me.d7=s_,Me.d8=vp,Me.d9=lg,Me.dA=K_,Me.dB=K,Me.dC=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},Me.dD=sc,Me.dE=Ml,Me.dF=al,Me.dG=function([F,Me,Le]){const Oe=Math.hypot(F,Me,Le),Fe=Math.atan2(F,Le),je=.5*Math.PI-Math.acos(-Me/Oe);return new ul(X(Fe),X(je))},Me.dH=uy,Me.dI=function(F){const Me=F.navigator?F.navigator.userAgent:null;return!!function(F){if(null==gc){const Me=F.navigator?F.navigator.userAgent:null;gc=!!F.safari||!(!Me||!(/\b(iPad|iPhone|iPod)\b/.test(Me)||Me.match("Safari")&&!Me.match("Chrome")))}return gc}(F)&&Me&&(Me.match("Version/15.4")||Me.match("Version/15.5")||Me.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},Me.dJ=function(F,Me){rh=F,oh=Me},Me.dK=Yu,Me.dL=Gu,Me.dM=function(F){const Me=[0,0,0],Le=bl.mat4.identity(new Float64Array(16));return bl.mat4.multiply(Le,F.pixelMatrix,F.globeMatrix),bl.vec3.transformMat4(Me,Me,Le),new ec(Me[0],Me[1])},Me.dN=function(F,Me,Le=!1){if(Tf===mf||Tf===gf||Tf===yf)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ef=eh.resolveURL(F),Tf=mf,xf=Me,Ts(),Le||Cs()},Me.dO=Vs,Me.dP=function(){ag().acquire(Tb)},Me.dQ=function(){const F=Sb;F&&(F.isPreloaded()&&1===F.numActive()?(F.release(Tb),Sb=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},Me.dR=rg,Me.dS=function(F){const Me=qt();if(!Me)return;const Le=Me.delete(th);F&&Le.catch(F).then((()=>F()))},Me.dT=wb,Me.dU=cv,Me.dV=function(F){sw=eh.resolveURL(F),hw||(hw=new ng(ag(),new _e)),hw.broadcast("setDracoUrl",sw)},Me.dW=hv,Me.dX=function(F){lw=eh.resolveURL(F),hw||(hw=new ng(ag(),new _e)),hw.broadcast("setMeshoptUrl",lw)},Me.dY=us,Me.dZ=hc,Me.d_=Gx,Me.da=450,Me.db=7,Me.dc=Qv,Me.dd=va,Me.de=to,Me.df=256,Me.dg=Nu,Me.dh=za,Me.di=Ga,Me.dj=Ya,Me.dk=function(F,Me,Le,Oe,Fe){return Q((F-Me)/(Le-Me)*(Fe-Oe)+Oe,Oe,Fe)},Me.dl=Ei,Me.dm=wl,Me.dn=class{constructor(F,Me,Le,Oe){this.context=F,this.format=Oe,this.size=Le,this.texture=F.gl.createTexture();const[Fe,je,qe]=this.size,{gl:He}=F;He.bindTexture(He.TEXTURE_3D,this.texture),F.pixelStoreUnpackFlipY.set(!1),F.pixelStoreUnpack.set(1),F.pixelStoreUnpackPremultiplyAlpha.set(!1),He.texImage3D(He.TEXTURE_3D,0,this.format,Fe,je,qe,0,Um(this.format),jm(this.format),Me.data)}bind(F,Me){const{context:Le}=this,{gl:Oe}=Le;Oe.bindTexture(Oe.TEXTURE_3D,this.texture),F!==this.minFilter&&(Oe.texParameteri(Oe.TEXTURE_3D,Oe.TEXTURE_MAG_FILTER,F),Oe.texParameteri(Oe.TEXTURE_3D,Oe.TEXTURE_MIN_FILTER,F),this.minFilter=F),Me!==this.wrapS&&(Oe.texParameteri(Oe.TEXTURE_3D,Oe.TEXTURE_WRAP_S,Me),Oe.texParameteri(Oe.TEXTURE_3D,Oe.TEXTURE_WRAP_T,Me),this.wrapS=Me)}destroy(){const{gl:F}=this.context;F.deleteTexture(this.texture),this.texture=null}},Me.dp=fy,Me.dq=[1,1,1],Me.dr=Fy,Me.ds=gb,Me.dt=La,Me.du=Za,Me.dv=Bm,Me.dw=Xa,Me.dx=Ha,Me.dy=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new ec(1/0,1/0),max:new ec(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(F,Me=!1){const Le=Hh(new ec(0,0),new ec(np,np),F),Oe=[];if(Me&&!Gh(Le,this._globalClipBounds))return Oe;for(const Me of this._activeRegions){if(Me.hiddenByOverlap)continue;if(!Gh(Le,Me))continue;const Fe=Xh(Me.min,Me.max,F);Oe.push({min:Fe.min,max:Fe.max,sourceId:this._sourceIds[Me.priority],footprint:Me.footprint,footprintTileId:Me.tileId,order:Me.order,clipMask:Me.clipMask,clipScope:Me.clipScope})}return Oe}setSources(F){this._setSources(F.map((F=>({getSourceId:()=>F.cache.id,getFootprints:()=>{const Me=[];for(const Le of F.cache.getVisibleCoordinates()){const Oe=F.cache.getTile(Le).buckets[F.layer];Oe&&Oe.updateFootprints(Le.toUnwrapped(),Me)}return Me},getOrder:()=>F.order,getClipMask:()=>F.clipMask,getClipScope:()=>F.clipScope}))))}_addSource(F){const Me=F.getFootprints();if(0===Me.length)return;const Le=F.getOrder(),Oe=F.getClipMask(),Fe=F.getClipScope();for(const F of Me){if(!F.footprint)continue;const Me=Hh(F.footprint.min,F.footprint.max,F.id);this._activeRegions.push({min:Me.min,max:Me.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:F.id,footprint:F.footprint,order:Le,clipMask:Oe,clipScope:Fe})}this._sourceIds.push(F.getSourceId())}_computeReplacement(){this._activeRegions.sort(((F,Me)=>F.priority-Me.priority||qh(F.min,Me.min)||qh(F.max,Me.max)||F.order-Me.order||F.clipMask-Me.clipMask||function(F,Me){const r=(F,Me)=>F+Me;return F.length-Me.length||F.reduce(r,"").localeCompare(Me.reduce(r,""))}(F.clipScope,Me.clipScope)));let F=this._activeRegions.length!==this._prevRegions.length;if(!F){let Me=0;for(;!F&&Me!==this._activeRegions.length;){const Le=this._activeRegions[Me],Oe=this._prevRegions[Me];F=Le.priority!==Oe.priority||!$h(Le,Oe)||Le.order!==Oe.order||Le.clipMask!==Oe.clipMask||!$(Le.clipScope,Oe.clipScope),++Me}}if(F){++this._updateTime;for(const F of this._activeRegions)F.order!==K_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,F.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,F.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,F.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,F.max.y));const t=F=>{const Me=this._activeRegions;if(F>=Me.length)return F;const Le=Me[F].priority;for(;F<Me.length&&Me[F].priority===Le;)++F;return F};if(this._sourceIds.length>1){let F=0,Me=t(F);for(;F!==Me;){let Le=F;const Oe=F;for(;Le!==Me;){const F=this._activeRegions[Le];F.hiddenByOverlap=!1;for(let Me=0;Me<Oe;Me++){const Le=this._activeRegions[Me];if(!Le.hiddenByOverlap&&F.order===K_&&Gh(F,Le)&&(F.hiddenByOverlap=Wh(F.footprint,F.tileId,Le.footprint,Le.tileId),F.hiddenByOverlap))break}++Le}F=Me,Me=t(F)}}}}_setSources(F){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let Me=F.length-1;Me>=0;Me--)this._addSource(F[Me]);this._computeReplacement()}},Me.dz=class{constructor(F){this._createGrid(F),this._createPoles(F)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const F of this._poleSegments)F.destroy();for(const F of this._gridSegments)F.withSkirts.destroy(),F.withoutSkirts.destroy()}_fillGridMeshWithLods(F,Me){const Le=new _a,Oe=new ja,Fe=[],je=F+1+2,qe=Me[0]+1,He=Me[0]+1+(1+Me.length),l=(F,Me,Le)=>{let Oe=F===je-1?F-2:0===F?F:F-1;return Oe+=Le?24575:0,[Oe,Me]};for(let F=0;F<je;++F)Le.emplaceBack(...l(F,0,!0));for(let F=0;F<qe;++F)for(let Me=0;Me<je;++Me)Le.emplaceBack(...l(Me,F,(0===Me||Me===je-1)&&!0));for(let F=0;F<Me.length;++F){const Oe=Me[F];for(let F=0;F<je;++F)Le.emplaceBack(...l(F,Oe,!0))}for(let F=0;F<Me.length;++F){const qe=Oe.length,xt=Me[F]+1+2,Pt=new ja;for(let Le=0;Le<xt-1;Le++){const Fe=Le===xt-2,qe=Fe?je*(He-Me.length+F-Le):je;for(let F=0;F<je-1;F++){const Me=Le*je+F;0===Le||Fe||0===F||F===je-2?(Pt.emplaceBack(Me+1,Me,Me+qe),Pt.emplaceBack(Me+qe,Me+qe+1,Me+1)):(Oe.emplaceBack(Me+1,Me,Me+qe),Oe.emplaceBack(Me+qe,Me+qe+1,Me+1))}}const jt=xo.simpleSegment(0,qe,Le.length,Oe.length-qe);for(let F=0;F<Pt.uint16.length;F+=3)Oe.emplaceBack(Pt.uint16[F],Pt.uint16[F+1],Pt.uint16[F+2]);const Gt=xo.simpleSegment(0,qe,Le.length,Oe.length-qe);Fe.push({withoutSkirts:jt,withSkirts:Gt})}return{vertices:Le,indices:Oe,segments:Fe}}_createGrid(F){const Me=this._fillGridMeshWithLods(Lm,Om);this._gridSegments=Me.segments,this._gridBuffer=F.createVertexBuffer(Me.vertices,h_.members),this._gridIndexBuffer=F.createIndexBuffer(Me.indices,!0)}_createPoles(F){const Me=new ja;for(let F=0;F<=Lm;F++)Me.emplaceBack(0,F+1,F+2);this._poleIndexBuffer=F.createIndexBuffer(Me,!0);const Le=new Ga,Oe=new Ga,Fe=new Ga,je=new Ga;this._poleSegments=[];for(let F=0,Me=0;F<bm;F++){const qe=360/(1<<F);Le.emplaceBack(0,-_m,0,.5,0),Oe.emplaceBack(0,-_m,0,.5,1),Fe.emplaceBack(0,-_m,0,.5,.5),je.emplaceBack(0,-_m,0,.5,.5);for(let F=0;F<=Lm;F++){let Me=F/Lm,He=0;const xt=Ee(0,qe,Me),[Pt,jt,Gt]=sl(f_,m_,xt,_m);Le.emplaceBack(Pt,jt,Gt,Me,He),Oe.emplaceBack(Pt,jt,Gt,Me,1-He);const bi=H(xt);Me=.5+.5*Math.sin(bi),He=.5+.5*Math.cos(bi),Fe.emplaceBack(Pt,jt,Gt,Me,He),je.emplaceBack(Pt,jt,Gt,Me,1-He)}this._poleSegments.push(xo.simpleSegment(Me,0,66,64)),Me+=66}this._poleNorthVertexBuffer=F.createVertexBuffer(Le,l_,!1),this._poleSouthVertexBuffer=F.createVertexBuffer(Oe,l_,!1),this._texturedPoleNorthVertexBuffer=F.createVertexBuffer(Fe,l_,!1),this._texturedPoleSouthVertexBuffer=F.createVertexBuffer(je,l_,!1)}getGridBuffers(F,Me){return[this._gridBuffer,this._gridIndexBuffer,Me?this._gridSegments[F].withSkirts:this._gridSegments[F].withoutSkirts]}getPoleBuffers(F,Me){return[Me?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,Me?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[F]]}},Me.e=yc,Me.e0=Nv,Me.e1=jp,Me.e2=k_,Me.e3="hd_road_elevation",Me.e4=class{static parseFrom(F,Me){const Le=fh.parse(F);if(!Le)return[];let{vertices:Oe,features:Fe}=Le;const je=1/Al(Me);Fe.sort(((F,Me)=>F.id-Me.id)),Oe.sort(((F,Me)=>F.id-Me.id||F.idx-Me.idx)),Oe=Oe.filter(((F,Me,Le)=>Me===Le.findIndex((Me=>Me.id===F.id&&Me.idx===F.idx))));const qe=new Array;let He=0;const xt=Oe.length;for(const F of Fe){if(F.constantHeight){qe.push(new dh(F.id,F.bounds,F.constantHeight));continue}for(;He!==xt&&Oe[He].id<F.id;)He++;if(He===xt||Oe[He].id!==F.id)continue;const Me=new Array,Le=new Array,Fe=He;for(;He!==xt&&Oe[He].id===F.id;){const F=Oe[He];if(Me.push({position:F.position,height:F.height,extent:F.extent}),He!==Fe&&Oe[He-1].idx===F.idx-1){const F=He-Fe;Le.push({a:F-1,b:F})}He++}qe.push(new dh(F.id,F.bounds,void 0,Me,Le,je))}return qe}},Me.e5=lt,Me.e6=gh,Me.e7=fd,Me.e8=Vx,Me.e9=function(F,Me,Le,Oe,Fe,je,qe,He=1,xt){F.createArrays(),F.tilePixelRatio=np/(512*F.overscaling),F.compareText={},F.iconsNeedLinear=!1;const Pt=F.layers[0].layout,jt=F.layers[0]._unevaluatedLayout._values,Gt={};Gt.scaleFactor=He,Gt.textSizeScaleRange=Pt.get("text-size-scale-range"),Gt.iconSizeScaleRange=Pt.get("icon-size-scale-range");const[bi,wi]=Gt.textSizeScaleRange,[qr,Xn]=Gt.iconSizeScaleRange;Gt.textScaleFactor=Q(Gt.scaleFactor,bi,wi),Gt.iconScaleFactor=Q(Gt.scaleFactor,qr,Xn);const Yn=jt["text-size"],yo=jt["icon-size"];if("composite"===F.textSizeData.kind){const{minZoom:Me,maxZoom:Le}=F.textSizeData;Gt.compositeTextSizes=[Yn.possiblyEvaluate(new Rs(Me),je),Yn.possiblyEvaluate(new Rs(Le),je)]}if("composite"===F.iconSizeData.kind){const{minZoom:Me,maxZoom:Le}=F.iconSizeData;Gt.compositeIconSizes=[yo.possiblyEvaluate(new Rs(Me),je),yo.possiblyEvaluate(new Rs(Le),je)]}Gt.layoutTextSize=Yn.possiblyEvaluate(new Rs(qe+1),je),Gt.layoutIconSize=yo.possiblyEvaluate(new Rs(qe+1),je),Gt.textMaxSize=Yn.possiblyEvaluate(new Rs(18),je);const bo=Pt.get("symbol-placement"),Ro="map"===Pt.get("text-rotation-alignment")&&"point"!==bo,Do=Pt.get("text-size");let zs=!1;const Zs=[];for(const qe of F.features){const He=Pt.get("text-font").evaluate(qe,{},je).join(","),bi=Do.evaluate(qe,{},je)*Gt.textScaleFactor,wi=Gt.layoutTextSize.evaluate(qe,{},je)*Gt.textScaleFactor,qr=Gt.layoutIconSize.evaluate(qe,{},je)*Gt.iconScaleFactor,Xn={horizontal:{},vertical:void 0},Yn=qe.text;let yo,na=[0,0];if(Yn){const Oe=Yn.toString(),jt=Pt.get("text-letter-spacing").evaluate(qe,{},je)*Sx,Gt=Pt.get("text-line-height").evaluate(qe,{},je)*Sx,qr=ys(Oe)?jt:0,yo=Pt.get("text-anchor").evaluate(qe,{},je),Do=Pt.get("text-variable-anchor");if(!Do){const F=Pt.get("text-radial-offset").evaluate(qe,{},je);na=F?Cd(yo,[F*Sx,Xx]):Pt.get("text-offset").evaluate(qe,{},je).map((F=>F*Sx))}let zs=Ro?"center":Pt.get("text-justify").evaluate(qe,{},je);const Zs="point"===bo,el=Zs?Pt.get("text-max-width").evaluate(qe,{},je)*Sx:1/0,I=je=>{F.allowVerticalPlacement&&ms(Oe)&&(Xn.vertical=qf(Yn,Me,Le,Fe,He,el,Gt,yo,je,qr,na,Fx.vertical,!0,wi,bi,xt))};if(!Ro&&Do){const F="auto"===zs?Do.map((F=>Nd(F))):[zs];let Oe=!1;for(let je=0;je<F.length;je++){const qe=F[je];if(!Xn.horizontal[qe])if(Oe)Xn.horizontal[qe]=Xn.horizontal[0];else{const F=qf(Yn,Me,Le,Fe,He,el,Gt,"center",qe,qr,na,Fx.horizontal,!1,wi,bi,xt);F&&(Xn.horizontal[qe]=F,Oe=1===F.positionedLines.length)}}I("left")}else{if("auto"===zs&&(zs=Nd(yo)),Zs||Pt.get("text-writing-mode").indexOf("horizontal")>=0||!ms(Oe)){const F=qf(Yn,Me,Le,Fe,He,el,Gt,yo,zs,qr,na,Fx.horizontal,!1,wi,bi,xt);F&&(Xn.horizontal[zs]=F)}I(Zs?"left":zs)}}let el,nl,hl,pl,bl,Tl=!1;if(qe.icon&&qe.icon.hasPrimary()){const Me=Rd(qe.icon,F.iconSizeData,jt["icon-size"],je,F.zoom,qe,xt,Gt.iconScaleFactor);el=Me.iconPrimary,nl=Me.iconSecondary;const Le=el.toString(),He=Oe.get(Le);He&&(hl=Pt.get("icon-offset").evaluate(qe,{},je),pl=Pt.get("icon-anchor").evaluate(qe,{},je),bl=Pt.get("icon-text-fit").evaluate(qe,{},je),yo=Qf(Fe.get(Le),nl?Fe.get(nl.toString()):void 0,hl,pl),Tl=He.sdf,void 0===F.sdfIcons?F.sdfIcons=He.sdf:F.sdfIcons!==He.sdf&&pt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(He.pixelRatio!==F.pixelRatio||0!==Pt.get("icon-rotate").constantOr(1))&&(F.iconsNeedLinear=!0))}zs=zs||!(!qe.icon||!qe.icon.hasSecondary());const kl=Yd(Xn.horizontal)||Xn.vertical;F.iconsInText||(F.iconsInText=!!kl&&kl.iconsInText);const ec=wi*Gt.textScaleFactor/Sx,{defaultShapedIcon:tc,verticallyShapedIcon:ic}=Ud(F,yo,Pt,qe,je,Xn,ec,hl,bl);yo=tc,Zs.push({feature:qe,shapedTextOrientations:Xn,shapedText:kl,shapedIcon:yo,iconPrimary:el,iconSecondary:nl,iconOffset:hl,iconAnchor:pl,verticallyShapedIcon:ic,layoutTextSize:wi,layoutIconSize:qr,textOffset:na,isSDFIcon:Tl,iconTextFit:bl})}return{featureData:Zs,sizes:Gt,hasAnySecondaryIcon:zs,textAlongLine:Ro,symbolPlacement:bo}},Me.ea=dd,Me.eb=function(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt){const{featureData:jt,hasAnySecondaryIcon:Gt,sizes:bi,textAlongLine:wi,symbolPlacement:qr}=Me;for(const Me of jt){const{shapedIcon:Le,verticallyShapedIcon:je,feature:jt,shapedTextOrientations:Xn,shapedText:Yn,layoutTextSize:yo,textOffset:bo,isSDFIcon:Ro,iconPrimary:Do,iconSecondary:zs,iconTextFit:Zs,iconOffset:na}=Me;Ld(Le,Pt.iconPositions,Do,zs),Ld(je,Pt.iconPositions,Do,zs),Fd(Xn,Pt.iconPositions),(Yn||Le)&&jd(F,jt,Xn,Le,je,xt,bi,yo,0,bo,Ro,Oe,Fe,qe,He,Gt,Zs,na,wi,qr)}Le&&F.generateCollisionDebugBuffers(je,F.collisionBoxArray,bi.textScaleFactor)},Me.ec=O_,Me.ed=hx,Me.ee=j,Me.ef=sh,Me.eg=Vf,Me.eh=e,Me.ei=function(F){let Me=0;if(new Uint32Array(F,0,1)[0]!==_w){const Le=new Uint32Array(F,0,7),[,,Oe,Fe,je,qe]=Le;Me=Le.byteLength+Fe+je+qe+je,(Oe!==F.byteLength||Me>=F.byteLength)&&pt("Invalid b3dm header information.")}return Sv(F,Me)},Me.ej=function(F,Me){const Le=Cv(F);for(const F of Le){for(const Me of F.meshes)Dv(Me);F.lights&&(F.lightMeshIndex=F.meshes.length,F.meshes.push(Rv(F.lights,Me)))}return Le},Me.ek=Gy,Me.el=Qy,Me.em=If,Me.en=function(F){$t(),null!=lh&&lh.then((Me=>{Me.keys().then((Le=>{for(let Oe=0;Oe<Le.length-F;Oe++)Me.delete(Le[Oe])}))}))},Me.f=function(F){return 0===F.indexOf("mapbox:")},Me.g=function(F,Me){return re(nt(F,{method:"GET"}),Me)},Me.h=It,Me.i=function(F){return yc.API_STYLE_REGEX.test(F)&&!St(F)},Me.j=function(F){return decodeURIComponent(atob(F).split("").map((F=>"%"+("00"+F.charCodeAt(0).toString(16)).slice(-2))).join(""))},Me.k=function(F){return btoa(encodeURIComponent(F).replace(/%([0-9A-F]{2})/g,((F,Me)=>String.fromCharCode(Number("0x"+Me)))))},Me.l=nt,Me.m=wh,Me.n=function(F,Me){return re(nt(F,{type:"json"}),Me)},Me.o=le,Me.p=function(F,Me){return re(nt(F,{method:"POST"}),Me)},Me.q=eh,Me.r=pc,Me.s=function(F){try{const Me=self[F];return Me.setItem("_mapbox_test_",1),Me.removeItem("_mapbox_test_"),!0}catch(F){return!1}},Me.t=Vt,Me.u=function(){return function t(F){return F?(F^Math.random()*(16>>F/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()},Me.v=function(F){return!!F&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(F)},Me.w=pt,Me.x=function(){return Eb||(Eb=new rg),Eb},Me.y=Qg,Me.z=xe}));define(["./shared"],(function(Me){function t(F){const Me=F?F.url.toString():void 0;return Me?performance.getEntriesByName(Me):[]}function s(F){if("number"==typeof F||"boolean"==typeof F||"string"==typeof F||null==F)return JSON.stringify(F);if(Array.isArray(F)){let Me="[";for(const Le of F)Me+=`${s(Le)},`;return`${Me}]`}let Me="{";for(const Le of Object.keys(F).sort())Me+=`${Le}:${s(F[Le])},`;return`${Me}}`}function i(F){let Le="";for(const Oe of Me.bm)("model"!==F.type||"minzoom"!==Oe&&"maxzoom"!==Oe)&&(Le+=`/${s(F[Oe])}`);return Le}class o{constructor(F){this.keyCache={},this._layers={},this._layerConfigs={},F&&this.replace(F)}replace(F,Me){this._layerConfigs={},this._layers={},this.update(F,[],Me)}update(F,Le,Oe){this._options=Oe;for(const Le of F)this._layerConfigs[Le.id]=Le,(this._layers[Le.id]=Me.cv(Le,this.scope,null,this._options)).compileFilter(Oe),this.keyCache[Le.id]&&delete this.keyCache[Le.id];for(const F of Le)delete this.keyCache[F],delete this._layerConfigs[F],delete this._layers[F];this.familiesBySource={};const Fe=function(F,Me){const Le={};for(let Oe=0;Oe<F.length;Oe++){const Fe=F[Oe];let je=Me&&Me[Fe.id];!je&&(je=i(Fe),"line"===Fe.type&&Fe.paint)&&function e(F){return"string"==typeof F&&"line-progress"===F||(Array.isArray(F)?F.some(e):!(!F||"object"!=typeof F)&&Object.values(F).some(e))}(Fe.paint["line-width"])&&(je+=`/${s(Fe.paint["line-width"])}`),Me&&(Me[Fe.id]=je);let qe=Le[je];qe||(qe=Le[je]=[]),qe.push(Fe)}const Oe=[];for(const F in Le)Oe.push(Le[F]);return Oe}(Object.values(this._layerConfigs),this.keyCache);for(const F of Fe){const Me=F.map((F=>this._layers[F.id])),Le=Me[0];if("none"===Le.visibility)continue;const Oe=Le.source||"";let Fe=this.familiesBySource[Oe];Fe||(Fe=this.familiesBySource[Oe]={});const je=Le.sourceLayer||"_geojsonTileLayer";let qe=Fe[je];qe||(qe=Fe[je]=[]),qe.push(Me)}}}const Le=1*Me.d_;class r{constructor(F){const Oe={},Fe=[];for(const Me in F){const je=F[Me],qe=Oe[Me]={};for(const F in je.glyphs){const Me=je.glyphs[+F];if(!Me||0===Me.bitmap.width||0===Me.bitmap.height)continue;const Oe=Me.metrics.localGlyph?Le:1,He={x:0,y:0,w:Me.bitmap.width+2*Oe,h:Me.bitmap.height+2*Oe};Fe.push(He),qe[F]=He}}const{w:je,h:qe}=Me.H(Fe),He=new Me.dZ({width:je||1,height:qe||1});for(const Fe in F){const je=F[Fe];for(const F in je.glyphs){const qe=je.glyphs[+F];if(!qe||0===qe.bitmap.width||0===qe.bitmap.height)continue;const xt=Oe[Fe][F],Pt=qe.metrics.localGlyph?Le:1;Me.dZ.copy(qe.bitmap,He,{x:0,y:0},{x:xt.x+Pt,y:xt.y+Pt},qe.bitmap)}}this.image=He,this.positions=Oe}}Me.dY(r,"GlyphAtlas");class a{constructor(F){this.tileID=new Me.aH(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.lut=F.lut,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.scope=F.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=F.showCollisionBoxes,this.collectResourceTiming=!!F.request&&F.request.collectResourceTiming,this.promoteId=F.promoteId,this.isSymbolTile=F.isSymbolTile,this.tileTransform=Me.aR(F.tileID.canonical,F.projection),this.projection=F.projection,this.worldview=F.worldview,this.localizableLayerIds=F.localizableLayerIds,this.brightness=F.brightness,this.extraShadowCaster=!!F.extraShadowCaster,this.tessellationStep=F.tessellationStep,this.scaleFactor=F.scaleFactor}parse(F,Le,Oe,Fe,je){this.status="parsing",this.data=F,this.collisionBoxArray=new Me.aX;const qe=new Me.d$(Object.keys(F.layers).sort()),He=new Me.e0(this.tileID,this.promoteId);He.bucketLayerIDs=[];const xt={},Pt=new Me.e1(256,256),jt={featureIndex:He,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:Pt,availableImages:Oe,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Gt=Le.familiesBySource[this.source];for(const Le in Gt){const Fe=F.layers[Le];if(!Fe)continue;let je=!1,Pt=!1,bi=!1;for(const F of Gt[Le])"symbol"===F[0].type?je=!0:Pt=!0,F[0].is3D()&&"model"!==F[0].type&&(bi=!0);if(this.extraShadowCaster&&!bi)continue;if(!0===this.isSymbolTile&&!je)continue;if(!1===this.isSymbolTile&&!Pt)continue;1===Fe.version&&Me.w(`Vector tile source "${this.source}" layer "${Le}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const wi=qe.encode(Le),qr=[];let Xn=!1;for(let F=0,Oe=0;F<Fe.length;F++){const je=Fe.feature(F),qe=He.getId(je,Le);if(this.localizableLayerIds&&this.localizableLayerIds.has(Le)){const F=je.properties?je.properties.worldview:null;if(this.worldview&&"string"==typeof F)if("all"===F)je.properties.$localized=!0;else{if(!F.split(",").includes(this.worldview))continue;je.properties.$localized=!0,je.properties.worldview=this.worldview}}!Xn&&je.properties&&je.properties.hasOwnProperty(Me.e2)&&(Xn=!0),qr.push({feature:je,id:qe,index:Oe,sourceLayerIndex:wi}),Oe++}Xn&&!jt.elevationFeatures&&F.layers.hasOwnProperty(Me.e3)&&(jt.elevationFeatures=Me.e4.parseFrom(F.layers[Me.e3],this.canonical));for(const F of Gt[Le]){const Le=F[0];(!this.extraShadowCaster||Le.is3D()&&"model"!==Le.type)&&(void 0!==this.isSymbolTile&&"symbol"===Le.type!==this.isSymbolTile||Le.minzoom&&this.zoom<Math.floor(Le.minzoom)||Le.maxzoom&&this.zoom>=Le.maxzoom||"none"!==Le.visibility&&(l(F,this.zoom,jt.brightness,Oe),(xt[Le.id]=Le.createBucket({index:He.bucketLayerIDs.length,layers:F,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:wi,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(qr,jt,this.tileID.canonical,this.tileTransform),He.bucketLayerIDs.push(F.map((F=>Me.C(F.id,F.scope))))))}}let bi,wi,qr,Xn,Yn,yo;Pt.trim();const bo={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},v=()=>{if(bi)return this.status="done",je(bi);if(this.extraShadowCaster)this.status="done",je(null,{buckets:Object.values(xt).filter((F=>!F.isEmpty())),featureIndex:He,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:jt.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(wi&&qr&&Xn){const F=new r(wi),Le=new Map;for(const[F,Oe]of qr.entries()){const{imagePosition:Fe}=Me.e7(F,Oe,Me.e8);Le.set(F,Fe)}const je={};for(const Fe in xt){const qe=xt[Fe];qe instanceof Me.aY&&(l(qe.layers,this.zoom,jt.brightness,Oe),je[Fe]=Me.e9(qe,wi,F.positions,qr,Le,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio))}const qe={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(Fe,qr,Yn,(()=>{qe.iconsPending=!1,I(je,F,qe)})),this.rasterizeIfNeeded(Fe,Xn,yo,(()=>{qe.patternsPending=!1,I(je,F,qe)}))}},I=(F,Le,Fe,qe)=>{if(Fe.iconsPending||Fe.patternsPending)return;const Gt=new Me.ea(qr,Xn,this.lut);for(const Le in xt){const Fe=xt[Le];if(Le in F)Me.eb(Fe,F[Le],this.showCollisionBoxes,Oe,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,qr,Gt);else if(Fe.hasPattern&&(Fe instanceof Me.b2||Fe instanceof Me.b3||Fe instanceof Me.d8)){l(Fe.layers,this.zoom,jt.brightness,Oe);const F=Object.fromEntries(Gt.patternPositions);Fe.addFeatures(jt,this.tileID.canonical,F,Oe,this.tileTransform,this.brightness)}}this.status="done",je(null,{buckets:Object.values(xt).filter((F=>!F.isEmpty())),featureIndex:He,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Le.image,lineAtlas:Pt,imageAtlas:Gt,brightness:jt.brightness})};if(!this.extraShadowCaster){const F=Me.e5(jt.glyphDependencies,(F=>Object.keys(F).map(Number)));Object.keys(F).length?Fe.send("getGlyphs",{uid:this.uid,stacks:F,scope:this.scope},((F,Me)=>{bi||(bi=F,wi=Me,v())}),void 0,!1,bo):wi={};const Le=Array.from(jt.iconDependencies.keys()).map((F=>Me.I.parse(F)));Le.length?Fe.send("getImages",{images:Le,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((F,Me)=>{bi||(bi=F,qr=new Map,Yn=this.updateImageMapAndGetImageTaskQueue(qr,Me,jt.iconDependencies),v())}),void 0,!1,bo):(qr=new Map,Yn=new Map);const Oe=Array.from(jt.patternDependencies.keys()).map((F=>Me.I.parse(F)));Oe.length?Fe.send("getImages",{images:Oe,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((F,Me)=>{bi||(bi=F,Xn=new Map,yo=this.updateImageMapAndGetImageTaskQueue(Xn,Me,jt.patternDependencies),v())}),void 0,!1,bo):(Xn=new Map,yo=new Map)}if(jt.elevationFeatures&&jt.elevationFeatures.length>0){const F=[];for(const Le of Object.values(xt))if(Le instanceof Me.b3){const Me=Le.getUnevaluatedPortalGraph();Me&&F.push(Me)}const Le=Me.e6.evaluate(F);for(const F of Object.values(xt))F instanceof Me.b3&&F.setEvaluatedPortalGraph(Le)}v()}rasterizeIfNeeded(F,Me,Le,Oe){Array.from(Me.values()).some((F=>F.usvg))?this.rasterize(F,Me,Le,Oe):Oe()}updateImageMapAndGetImageTaskQueue(F,Me,Le){const Oe=new Map;for(const Fe of Me.keys()){const je=Le.get(Fe)||[];for(const Le of je){const Fe=Le.toString(),je=Me.get(Le.id.toString());je.usvg?Oe.has(Fe)||(Oe.set(Fe,Le),F.set(Fe,Object.assign({},je))):F.set(Fe,je)}}return Oe}rasterize(F,Me,Le,Oe){this.rasterizeTask=F.send("rasterizeImages",{scope:this.scope,tasks:Le},((F,Le)=>{if(!F)for(const[F,Oe]of Le.entries()){const Le=Object.assign(Me.get(F),{data:Oe});Me.set(F,Le)}Oe()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function l(F,Le,Oe,Fe){const je=new Me.aa(Le,{brightness:Oe});for(const Me of F)Me.recalculate(je,Fe)}class c extends Me.E{constructor(F,Le,Oe,Fe,je,qe){super(),this.actor=F,this.layerIndex=Le,this.availableImages=Oe,this.loadVectorData=je||Me.aE,this.loading={},this.loaded={},this.deduped=new Me.aD(F.scheduler),this.isSpriteLoaded=Fe,this.scheduler=F.scheduler,this.brightness=qe}loadTile(F,Le){const Oe=F.uid,Fe=F&&F.request,je=Fe&&Fe.collectResourceTiming,qe=this.loading[Oe]=new a(F);qe.abort=this.loadVectorData(F,((He,xt)=>{const Pt=!this.loading[Oe];if(delete this.loading[Oe],qe.cancelRasterize(),Pt||He||!xt)return qe.status="done",Pt||(this.loaded[Oe]=qe),Le(He);const jt=xt.rawData,Gt={};xt.expires&&(Gt.expires=xt.expires),xt.cacheControl&&(Gt.cacheControl=xt.cacheControl),qe.vectorTile=xt.vectorTile||new Me.ec.VectorTile(new Me.bi(jt));const p=()=>{qe.parse(qe.vectorTile,this.layerIndex,this.availableImages,this.actor,((F,Oe)=>{if(F||!Oe)return Le(F);const qe={};if(je){const F=t(Fe);F.length>0&&(qe.resourceTiming=JSON.parse(JSON.stringify(F)))}Le(null,Me.l({rawTileData:jt.slice(0)},Oe,Gt,qe))}))};this.isSpriteLoaded?p():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(p,{type:"parseTile",isSymbolTile:F.isSymbolTile,zoom:F.tileZoom}):p()})),this.loaded=this.loaded||{},this.loaded[Oe]=qe}))}reloadTile(F,Le){const Oe=this.loaded,Fe=F.uid;if(Oe&&Oe[Fe]){const je=Oe[Fe];je.scaleFactor=F.scaleFactor,je.showCollisionBoxes=F.showCollisionBoxes,je.projection=F.projection,je.brightness=F.brightness,je.tileTransform=Me.aR(F.tileID.canonical,F.projection),je.extraShadowCaster=F.extraShadowCaster,je.lut=F.lut;const r=(F,Me)=>{const Oe=je.reloadCallback;Oe&&(delete je.reloadCallback,je.parse(je.vectorTile,this.layerIndex,this.availableImages,this.actor,Oe)),Le(F,Me)};"parsing"===je.status?je.reloadCallback=r:"done"===je.status&&(je.vectorTile?je.parse(je.vectorTile,this.layerIndex,this.availableImages,this.actor,r):r())}else Le(null,void 0)}abortTile(F,Me){const Le=F.uid,Oe=this.loading[Le];Oe&&(Oe.abort&&Oe.abort(),delete this.loading[Le]),Me()}removeTile(F,Me){const Le=this.loaded,Oe=F.uid;Le&&Le[Oe]&&delete Le[Oe],Me()}}class h{loadTile(F,Le){const{uid:Oe,encoding:Fe,rawImageData:je,padding:qe}=F,He=ImageBitmap&&je instanceof ImageBitmap?this.getImageData(je,qe):je;Le(null,new Me.ed(Oe,He,Fe,qe<1))}reloadTile(F,Me){Me(null,null)}abortTile(F,Me){Me()}removeTile(F,Me){Me()}getImageData(F,Me){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(F.width,F.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=F.width,this.offscreenCanvas.height=F.height,this.offscreenCanvasContext.drawImage(F,0,0,F.width,F.height);const Le=this.offscreenCanvasContext.getImageData(-Me,-Me,F.width+2*Me,F.height+2*Me);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Le}}Me.bh.setPbf(Me.bi);class u{constructor(F){this._mrt=new Me.bh(F.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=F.uid,this.tileID=F.tileID,this.source=F.source}parse(F,Le){const Oe=this._mrt;this.status="parsing",this._entireBuffer=F;try{Oe.parseHeader(F),this._isHeaderLoaded=!0;const Fe=[];for(const Le in Oe.layers){const je=Oe.getLayer(Le),qe=je.getDataRange(je.getBandList()),He=Oe.createDecodingTask(qe),xt=F.slice(qe.firstByte,qe.lastByte+1),Pt=Me.bh.performDecoding(xt,He).then((F=>He.complete(null,F))).catch((F=>He.complete(F,null)));Fe.push(Pt)}Promise.allSettled(Fe).then((()=>Le(null,Oe)))}catch(F){Le(F)}}}class d{constructor(F){this.actor=F,this.loading={},this.loaded={}}loadTile(F,Le){const Oe=F.uid,Fe=F.request,je=this.loading[Oe]=new u(F),{cancel:qe}=Me.bj(Fe,((F,Me,Fe,qe)=>{const He=!this.loading[Oe];if(delete this.loading[Oe],He||F||!Me)return je.status="done",He||(this.loaded[Oe]=je),Le(F);je.parse(Me,((F,Me)=>{if(F||!Me)return Le(F);Le(null,Me,Fe,qe)})),this.loaded[Oe]=je}));je.abort=qe}reloadTile(F,Me){Me(null,void 0)}abortTile(F,Me){const Le=F.uid,Oe=this.loading[Le];Oe&&(Oe.abort&&Oe.abort(),delete this.loading[Le]),Me()}removeTile(F,Me){const Le=F.uid;this.loaded[Le]&&delete this.loaded[Le],Me()}decodeRasterArray({task:F,buffer:Le},Oe){Me.bh.performDecoding(Le,F).then((F=>Oe(null,F))).catch((F=>Oe(F)))}}const Oe=Me.ec.VectorTileFeature.prototype.toGeoJSON;class f{constructor(F){this._feature=F,this.extent=Me.ai,this.type=F.type,this.properties=F.tags,"id"in F&&!isNaN(F.id)&&(this.id=parseInt(F.id,10))}loadGeometry(){if(1===this._feature.type){const F=[];for(const Le of this._feature.geometry)F.push([new Me.P(Le[0],Le[1])]);return F}{const F=[];for(const Le of this._feature.geometry){const Oe=[];for(const F of Le)Oe.push(new Me.P(F[0],F[1]));F.push(Oe)}return F}}toGeoJSON(F,Me,Le){return Oe.call(this,F,Me,Le)}}class g{constructor(F){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=Me.ai,this.length=F.length,this._features=F}feature(F){return new f(this._features[F])}}const Fe=64/4096,je=128;class x{constructor(){this.features=new Map}clear(){this.features.clear()}load(F=[],Me){for(const Le of F){const F=Le.id;if(null==F)continue;let Oe=this.features.get(F);Oe&&this.updateCache(Oe,Me),Le.geometry?(Oe=b(Le),this.updateCache(Oe,Me),this.features.set(F,Oe)):this.features.delete(F),this.updateCache(Oe,Me)}}updateCache(F,Me){for(const{canonical:Le,uid:Oe}of Object.values(Me)){const{z:Fe,x:je,y:qe}=Le;w(F,Math.pow(2,Fe),je,qe)&&delete Me[Oe]}}getTile(F,Me,Le){const Oe=Math.pow(2,F),Fe=[];for(const F of this.features.values())w(F,Oe,Me,Le)&&Fe.push(M(F,Oe,Me,Le));return{features:Fe}}getFeatures(){return[...this.features.values()]}}function w({minX:F,minY:Me,maxX:Le,maxY:Oe},je,qe,He){return F<(qe+1+Fe)/je&&Me<(He+1+Fe)/je&&Le>(qe-Fe)/je&&Oe>(He-Fe)/je}function b(F){const{id:Me,geometry:Le,properties:Oe}=F;if(!Le)return;if("GeometryCollection"===Le.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Fe,coordinates:je}=Le,qe={id:Me,type:1,geometry:[],tags:Oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},He=qe.geometry;if("Point"===Fe)v(je,He,qe);else if("MultiPoint"===Fe)for(const F of je)v(F,He,qe);else if("LineString"===Fe)qe.type=2,I(je,He,qe);else if("MultiLineString"===Fe)qe.type=2,S(je,He,qe);else if("Polygon"===Fe)qe.type=3,S(je,He,qe,!0);else{if("MultiPolygon"!==Fe)throw new Error("Input data is not a valid GeoJSON object.");qe.type=3;for(const F of je)S(F,He,qe,!0)}return qe}function v([F,Le],Oe,Fe){const je=Me.av(F);let qe=Me.aC(Le);qe=qe<0?0:qe>1?1:qe,Oe.push(je,qe),Fe.minX=Math.min(Fe.minX,je),Fe.minY=Math.min(Fe.minY,qe),Fe.maxX=Math.max(Fe.maxX,je),Fe.maxY=Math.max(Fe.maxY,qe)}function I(F,Me,Le,Oe=!1,Fe=!1){const je=[];for(const Me of F)v(Me,je,Le);Me.push(je),Oe&&function(F,Me){let Le=0;for(let Me=0,Oe=F.length,Fe=Oe-2;Me<Oe;Fe=Me,Me+=2)Le+=(F[Me]-F[Fe])*(F[Me+1]+F[Fe+1]);if(Le>0===Me)for(let Me=0,Le=F.length;Me<Le/2;Me+=2){const Oe=F[Me],Fe=F[Me+1];F[Me]=F[Le-2-Me],F[Me+1]=F[Le-1-Me],F[Le-2-Me]=Oe,F[Le-1-Me]=Fe}}(je,Fe)}function S(F,Me,Le,Oe=!1){for(let Fe=0;Fe<F.length;Fe++)I(F[Fe],Me,Le,Oe,0===Fe)}function M(F,Le,Oe,Fe){const{id:je,type:qe,geometry:He,tags:xt}=F,Pt=[];if(1===qe)!function(F,Le,Oe,Fe,je){for(let qe=0;qe<F.length;qe+=2){const He=Math.round(Me.ai*(F[qe+0]*Le-Oe)),xt=Math.round(Me.ai*(F[qe+1]*Le-Fe));je.push([He,xt])}}(He,Le,Oe,Fe,Pt);else for(const F of He)T(F,Le,Oe,Fe,Pt);return{id:je,type:qe,geometry:Pt,tags:xt}}function T(F,Le,Oe,Fe,qe){const He=-je,xt=Me.ai+je;let Pt;for(let je=0;je<F.length-2;je+=2){let jt=Math.round(Me.ai*(F[je+0]*Le-Oe)),Gt=Math.round(Me.ai*(F[je+1]*Le-Fe)),bi=Math.round(Me.ai*(F[je+2]*Le-Oe)),wi=Math.round(Me.ai*(F[je+3]*Le-Fe));const qr=bi-jt,Xn=wi-Gt;jt<He&&bi<He||(jt<He?(Gt+=Math.round(Xn*((He-jt)/qr)),jt=He):bi<He&&(wi=Gt+Math.round(Xn*((He-jt)/qr)),bi=He),Gt<He&&wi<He||(Gt<He?(jt+=Math.round(qr*((He-Gt)/Xn)),Gt=He):wi<He&&(bi=jt+Math.round(qr*((He-Gt)/Xn)),wi=He),jt>=xt&&bi>=xt||(jt>=xt?(Gt+=Math.round(Xn*((xt-jt)/qr)),jt=xt):bi>=xt&&(wi=Gt+Math.round(Xn*((xt-jt)/qr)),bi=xt),Gt>=xt&&wi>=xt||(Gt>=xt?(jt+=Math.round(qr*((xt-Gt)/Xn)),Gt=xt):wi>=xt&&(bi=jt+Math.round(qr*((xt-Gt)/Xn)),wi=xt),Pt&&jt===Pt[Pt.length-1][0]&&Gt===Pt[Pt.length-1][1]||(Pt=[[jt,Gt]],qe.push(Pt)),Pt.push([bi,wi])))))}}var qe,He,xt,Pt={exports:{}},jt=function(){if(xt)return Pt.exports;xt=1;var Le=Me.eg(),Oe=function(){if(He)return qe;He=1;var Le=Me.ee(),Oe=Me.ef().VectorTileFeature;function i(Me,Le){(this||F).options=Le||{},(this||F).features=Me,(this||F).length=Me.length}function o(Me,Le){(this||F).id="number"==typeof Me.id?Me.id:void 0,(this||F).type=Me.type,(this||F).rawGeometry=1===Me.type?[Me.geometry]:Me.geometry,(this||F).properties=Me.tags,(this||F).extent=Le||4096}return qe=i,i.prototype.feature=function(Me){return new o((this||F).features[Me],(this||F).options.extent)},o.prototype.loadGeometry=function(){var Me=(this||F).rawGeometry;(this||F).geometry=[];for(var Oe=0;Oe<Me.length;Oe++){for(var Fe=Me[Oe],je=[],qe=0;qe<Fe.length;qe++)je.push(new Le(Fe[qe][0],Fe[qe][1]));(this||F).geometry.push(je)}return(this||F).geometry},o.prototype.bbox=function(){(this||F).geometry||this.loadGeometry();for(var Me=(this||F).geometry,Le=1/0,Oe=-1/0,Fe=1/0,je=-1/0,qe=0;qe<Me.length;qe++)for(var He=Me[qe],xt=0;xt<He.length;xt++){var Pt=He[xt];Le=Math.min(Le,Pt.x),Oe=Math.max(Oe,Pt.x),Fe=Math.min(Fe,Pt.y),je=Math.max(je,Pt.y)}return[Le,Fe,Oe,je]},o.prototype.toGeoJSON=Oe.prototype.toGeoJSON,qe}();function i(F){var Me=new Le;return function(F,Me){for(var Le in F.layers)Me.writeMessage(3,o,F.layers[Le])}(F,Me),Me.finish()}function o(F,Me){var Le;Me.writeVarintField(15,F.version||1),Me.writeStringField(1,F.name||""),Me.writeVarintField(5,F.extent||4096);var Oe={keys:[],values:[],keycache:{},valuecache:{}};for(Le=0;Le<F.length;Le++)Oe.feature=F.feature(Le),Me.writeMessage(2,n,Oe);var Fe=Oe.keys;for(Le=0;Le<Fe.length;Le++)Me.writeStringField(3,Fe[Le]);var je=Oe.values;for(Le=0;Le<je.length;Le++)Me.writeMessage(4,h,je[Le])}function n(F,Me){var Le=F.feature;void 0!==Le.id&&Me.writeVarintField(1,Le.id),Me.writeMessage(2,r,F),Me.writeVarintField(3,Le.type),Me.writeMessage(4,c,Le)}function r(F,Me){var Le=F.feature,Oe=F.keys,Fe=F.values,je=F.keycache,qe=F.valuecache;for(var He in Le.properties){var xt=Le.properties[He],Pt=je[He];if(null!==xt){void 0===Pt&&(Oe.push(He),je[He]=Pt=Oe.length-1),Me.writeVarint(Pt);var jt=typeof xt;"string"!==jt&&"boolean"!==jt&&"number"!==jt&&(xt=JSON.stringify(xt));var Gt=jt+":"+xt,bi=qe[Gt];void 0===bi&&(Fe.push(xt),qe[Gt]=bi=Fe.length-1),Me.writeVarint(bi)}}}function a(F,Me){return(Me<<3)+(7&F)}function l(F){return F<<1^F>>31}function c(F,Me){for(var Le=F.loadGeometry(),Oe=F.type,Fe=0,je=0,qe=Le.length,He=0;He<qe;He++){var xt=Le[He],Pt=1;1===Oe&&(Pt=xt.length),Me.writeVarint(a(1,Pt));for(var jt=3===Oe?xt.length-1:xt.length,Gt=0;Gt<jt;Gt++){1===Gt&&1!==Oe&&Me.writeVarint(a(2,jt-1));var bi=xt[Gt].x-Fe,wi=xt[Gt].y-je;Me.writeVarint(l(bi)),Me.writeVarint(l(wi)),Fe+=bi,je+=wi}3===Oe&&Me.writeVarint(a(7,1))}}function h(F,Me){var Le=typeof F;"string"===Le?Me.writeStringField(1,F):"boolean"===Le?Me.writeBooleanField(7,F):"number"===Le&&(F%1!=0?Me.writeDoubleField(3,F):F<0?Me.writeSVarintField(6,F):Me.writeVarintField(5,F))}return Pt.exports=i,Pt.exports.fromVectorTileJs=i,Pt.exports.fromGeojsonVt=function(F,Me){Me=Me||{};var Le={};for(var Fe in F)Le[Fe]=new Oe(F[Fe].features,Me),Le[Fe].name=Fe,Le[Fe].version=Me.version,Le[Fe].extent=Me.extent;return i({layers:Le})},Pt.exports.GeoJSONWrapper=Oe,Pt.exports}(),Gt=Me.eh(jt);const bi={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:F=>F},wi=Math.fround||(qr=new Float32Array(1),F=>(qr[0]=+F,qr[0]));var qr;const Xn=3,Yn=5,yo=6;class E{constructor(F){this.options=Object.assign(Object.create(bi),F),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(F){const{log:Me,minZoom:Le,maxZoom:Oe}=this.options;Me&&console.time("total time");const Fe=`prepare ${F.length} points`;Me&&console.time(Fe),this.points=F;const je=[];for(let Me=0;Me<F.length;Me++){const Le=F[Me];if(!Le.geometry)continue;const[Oe,Fe]=Le.geometry.coordinates,qe=wi(B(Oe)),He=wi(G(Fe));je.push(qe,He,1/0,Me,-1,1),this.options.reduce&&je.push(0)}let qe=this.trees[Oe+1]=this._createTree(je);Me&&console.timeEnd(Fe);for(let F=Oe;F>=Le;F--){const Le=+Date.now();qe=this.trees[F]=this._createTree(this._cluster(qe,F)),Me&&console.log("z%d: %d clusters in %dms",F,qe.numItems,+Date.now()-Le)}return Me&&console.timeEnd("total time"),this}getClusters(F,Me){let Le=((F[0]+180)%360+360)%360-180;const Oe=Math.max(-90,Math.min(90,F[1]));let Fe=180===F[2]?180:((F[2]+180)%360+360)%360-180;const je=Math.max(-90,Math.min(90,F[3]));if(F[2]-F[0]>=360)Le=-180,Fe=180;else if(Le>Fe){const F=this.getClusters([Le,Oe,180,je],Me),qe=this.getClusters([-180,Oe,Fe,je],Me);return F.concat(qe)}const qe=this.trees[this._limitZoom(Me)],He=qe.range(B(Le),G(je),B(Fe),G(Oe)),xt=qe.data,Pt=[];for(const F of He){const Me=this.stride*F;Pt.push(xt[Me+Yn]>1?N(xt,Me,this.clusterProps):this.points[xt[Me+Xn]])}return Pt}getChildren(F){const Me=this._getOriginId(F),Le=this._getOriginZoom(F),Oe="No cluster with the specified id.",Fe=this.trees[Le];if(!Fe)throw new Error(Oe);const je=Fe.data;if(Me*this.stride>=je.length)throw new Error(Oe);const qe=this.options.radius/(this.options.extent*Math.pow(2,Le-1)),He=Fe.within(je[Me*this.stride],je[Me*this.stride+1],qe),xt=[];for(const Me of He){const Le=Me*this.stride;je[Le+4]===F&&xt.push(je[Le+Yn]>1?N(je,Le,this.clusterProps):this.points[je[Le+Xn]])}if(0===xt.length)throw new Error(Oe);return xt}getLeaves(F,Me,Le){const Oe=[];return this._appendLeaves(Oe,F,Me=Me||10,Le=Le||0,0),Oe}getTile(F,Me,Le){const Oe=this.trees[this._limitZoom(F)],Fe=Math.pow(2,F),{extent:je,radius:qe}=this.options,He=qe/je,xt=(Le-He)/Fe,Pt=(Le+1+He)/Fe,jt={features:[]};return this._addTileFeatures(Oe.range((Me-He)/Fe,xt,(Me+1+He)/Fe,Pt),Oe.data,Me,Le,Fe,jt),0===Me&&this._addTileFeatures(Oe.range(1-He/Fe,xt,1,Pt),Oe.data,Fe,Le,Fe,jt),Me===Fe-1&&this._addTileFeatures(Oe.range(0,xt,He/Fe,Pt),Oe.data,-1,Le,Fe,jt),jt.features.length?jt:null}getClusterExpansionZoom(F){let Me=this._getOriginZoom(F)-1;for(;Me<=this.options.maxZoom;){const Le=this.getChildren(F);if(Me++,1!==Le.length)break;F=Le[0].properties.cluster_id}return Me}_appendLeaves(F,Me,Le,Oe,Fe){const je=this.getChildren(Me);for(const Me of je){const je=Me.properties;if(je&&je.cluster?Fe+je.point_count<=Oe?Fe+=je.point_count:Fe=this._appendLeaves(F,je.cluster_id,Le,Oe,Fe):Fe<Oe?Fe++:F.push(Me),F.length===Le)break}return Fe}_createTree(F){const Le=new Me.bE(F.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Me=0;Me<F.length;Me+=this.stride)Le.add(F[Me],F[Me+1]);return Le.finish(),Le.data=F,Le}_addTileFeatures(F,Me,Le,Oe,Fe,je){for(const qe of F){const F=qe*this.stride,He=Me[F+Yn]>1;let xt,Pt,jt;if(He)xt=X(Me,F,this.clusterProps),Pt=Me[F],jt=Me[F+1];else{const Le=this.points[Me[F+Xn]];xt=Le.properties;const[Oe,Fe]=Le.geometry.coordinates;Pt=B(Oe),jt=G(Fe)}const Gt={type:1,geometry:[[Math.round(this.options.extent*(Pt*Fe-Le)),Math.round(this.options.extent*(jt*Fe-Oe))]],tags:xt};let bi;bi=He||this.options.generateId?Me[F+Xn]:this.points[Me[F+Xn]].id,void 0!==bi&&(Gt.id=bi),je.features.push(Gt)}}_limitZoom(F){return Math.max(this.options.minZoom,Math.min(Math.floor(+F),this.options.maxZoom+1))}_cluster(F,Me){const{radius:Le,extent:Oe,reduce:Fe,minPoints:je}=this.options,qe=Le/(Oe*Math.pow(2,Me)),He=F.data,xt=[],Pt=this.stride;for(let Le=0;Le<He.length;Le+=Pt){if(He[Le+2]<=Me)continue;He[Le+2]=Me;const Oe=He[Le],jt=He[Le+1],Gt=F.within(He[Le],He[Le+1],qe),bi=He[Le+Yn];let wi=bi;for(const F of Gt){const Le=F*Pt;He[Le+2]>Me&&(wi+=He[Le+Yn])}if(wi>bi&&wi>=je){let F,je=Oe*bi,qe=jt*bi,qr=-1;const Xn=(Le/Pt<<5)+(Me+1)+this.points.length;for(const Oe of Gt){const xt=Oe*Pt;if(He[xt+2]<=Me)continue;He[xt+2]=Me;const jt=He[xt+Yn];je+=He[xt]*jt,qe+=He[xt+1]*jt,He[xt+4]=Xn,Fe&&(F||(F=this._map(He,Le,!0),qr=this.clusterProps.length,this.clusterProps.push(F)),Fe(F,this._map(He,xt)))}He[Le+4]=Xn,xt.push(je/wi,qe/wi,1/0,Xn,-1,wi),Fe&&xt.push(qr)}else{for(let F=0;F<Pt;F++)xt.push(He[Le+F]);if(wi>1)for(const F of Gt){const Le=F*Pt;if(!(He[Le+2]<=Me)){He[Le+2]=Me;for(let F=0;F<Pt;F++)xt.push(He[Le+F])}}}}return xt}_getOriginId(F){return F-this.points.length>>5}_getOriginZoom(F){return(F-this.points.length)%32}_map(F,Me,Le){if(F[Me+Yn]>1){const Oe=this.clusterProps[F[Me+yo]];return Le?Object.assign({},Oe):Oe}const Oe=this.points[F[Me+Xn]].properties,Fe=this.options.map(Oe);return Le&&Fe===Oe?Object.assign({},Fe):Fe}}function N(F,Me,Le){return{type:"Feature",id:F[Me+Xn],properties:X(F,Me,Le),geometry:{type:"Point",coordinates:[(Oe=F[Me],360*(Oe-.5)),Y(F[Me+1])]}};var Oe}function X(F,Me,Le){const Oe=F[Me+Yn],Fe=Oe>=1e4?`${Math.round(Oe/1e3)}k`:Oe>=1e3?Math.round(Oe/100)/10+"k":Oe,je=F[Me+yo],qe=-1===je?{}:Object.assign({},Le[je]);return Object.assign(qe,{cluster:!0,cluster_id:F[Me+Xn],point_count:Oe,point_count_abbreviated:Fe})}function B(F){return F/360+.5}function G(F){const Me=Math.sin(F*Math.PI/180),Le=.5-.25*Math.log((1+Me)/(1-Me))/Math.PI;return Le<0?0:Le>1?1:Le}function Y(F){const Me=(180-360*F)*Math.PI/180;return 360*Math.atan(Math.exp(Me))/Math.PI-90}function R(F,Me,Le,Oe){let Fe=Oe;const je=Me+(Le-Me>>1);let qe,He=Le-Me;const xt=F[Me],Pt=F[Me+1],jt=F[Le],Gt=F[Le+1];for(let Oe=Me+3;Oe<Le;Oe+=3){const Me=J(F[Oe],F[Oe+1],xt,Pt,jt,Gt);if(Me>Fe)qe=Oe,Fe=Me;else if(Me===Fe){const F=Math.abs(Oe-je);F<He&&(qe=Oe,He=F)}}Fe>Oe&&(qe-Me>3&&R(F,Me,qe,Oe),F[qe+2]=Fe,Le-qe>3&&R(F,qe,Le,Oe))}function J(F,Me,Le,Oe,Fe,je){let qe=Fe-Le,He=je-Oe;if(0!==qe||0!==He){const xt=((F-Le)*qe+(Me-Oe)*He)/(qe*qe+He*He);xt>1?(Le=Fe,Oe=je):xt>0&&(Le+=qe*xt,Oe+=He*xt)}return qe=F-Le,He=Me-Oe,qe*qe+He*He}function V(F,Me,Le,Oe){const Fe={id:F??null,type:Me,geometry:Le,tags:Oe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===Me||"MultiPoint"===Me||"LineString"===Me)$(Fe,Le);else if("Polygon"===Me)$(Fe,Le[0]);else if("MultiLineString"===Me)for(const F of Le)$(Fe,F);else if("MultiPolygon"===Me)for(const F of Le)$(Fe,F[0]);return Fe}function $(F,Me){for(let Le=0;Le<Me.length;Le+=3)F.minX=Math.min(F.minX,Me[Le]),F.minY=Math.min(F.minY,Me[Le+1]),F.maxX=Math.max(F.maxX,Me[Le]),F.maxY=Math.max(F.maxY,Me[Le+1])}function W(F,Me,Le,Oe){if(!Me.geometry)return;const Fe=Me.geometry.coordinates;if(Fe&&0===Fe.length)return;const je=Me.geometry.type,qe=Math.pow(Le.tolerance/((1<<Le.maxZoom)*Le.extent),2);let He=[],xt=Me.id;if(Le.promoteId?xt=Me.properties[Le.promoteId]:Le.generateId&&(xt=Oe||0),"Point"===je)q(Fe,He);else if("MultiPoint"===je)for(const F of Fe)q(F,He);else if("LineString"===je)U(Fe,He,qe,!1);else if("MultiLineString"===je){if(Le.lineMetrics){for(const Le of Fe)He=[],U(Le,He,qe,!1),F.push(V(xt,"LineString",He,Me.properties));return}H(Fe,He,qe,!1)}else if("Polygon"===je)H(Fe,He,qe,!0);else{if("MultiPolygon"!==je){if("GeometryCollection"===je){for(const Fe of Me.geometry.geometries)W(F,{id:xt,geometry:Fe,properties:Me.properties},Le,Oe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const F of Fe){const Me=[];H(F,Me,qe,!0),He.push(Me)}}F.push(V(xt,je,He,Me.properties))}function q(F,Me){Me.push(Q(F[0]),K(F[1]),0)}function U(F,Me,Le,Oe){let Fe,je,qe=0;for(let Le=0;Le<F.length;Le++){const He=Q(F[Le][0]),xt=K(F[Le][1]);Me.push(He,xt,0),Le>0&&(qe+=Oe?(Fe*xt-He*je)/2:Math.sqrt(Math.pow(He-Fe,2)+Math.pow(xt-je,2))),Fe=He,je=xt}const He=Me.length-3;Me[2]=1,R(Me,0,He,Le),Me[He+2]=1,Me.size=Math.abs(qe),Me.start=0,Me.end=Me.size}function H(F,Me,Le,Oe){for(let Fe=0;Fe<F.length;Fe++){const je=[];U(F[Fe],je,Le,Oe),Me.push(je)}}function Q(F){return F/360+.5}function K(F){const Me=Math.sin(F*Math.PI/180),Le=.5-.25*Math.log((1+Me)/(1-Me))/Math.PI;return Le<0?0:Le>1?1:Le}function ee(F,Me,Le,Oe,Fe,je,qe,He){if(Oe/=Me,je>=(Le/=Me)&&qe<Oe)return F;if(qe<Le||je>=Oe)return null;const xt=[];for(const Me of F){const F=Me.geometry;let je=Me.type;const qe=0===Fe?Me.minX:Me.minY,Pt=0===Fe?Me.maxX:Me.maxY;if(qe>=Le&&Pt<Oe){xt.push(Me);continue}if(Pt<Le||qe>=Oe)continue;let jt=[];if("Point"===je||"MultiPoint"===je)te(F,jt,Le,Oe,Fe);else if("LineString"===je)se(F,jt,Le,Oe,Fe,!1,He.lineMetrics);else if("MultiLineString"===je)oe(F,jt,Le,Oe,Fe,!1);else if("Polygon"===je)oe(F,jt,Le,Oe,Fe,!0);else if("MultiPolygon"===je)for(const Me of F){const F=[];oe(Me,F,Le,Oe,Fe,!0),F.length&&jt.push(F)}if(jt.length){if(He.lineMetrics&&"LineString"===je){for(const F of jt)xt.push(V(Me.id,je,F,Me.tags));continue}"LineString"!==je&&"MultiLineString"!==je||(1===jt.length?(je="LineString",jt=jt[0]):je="MultiLineString"),"Point"!==je&&"MultiPoint"!==je||(je=3===jt.length?"Point":"MultiPoint"),xt.push(V(Me.id,je,jt,Me.tags))}}return xt.length?xt:null}function te(F,Me,Le,Oe,Fe){for(let je=0;je<F.length;je+=3){const qe=F[je+Fe];qe>=Le&&qe<=Oe&&ne(Me,F[je],F[je+1],F[je+2])}}function se(F,Me,Le,Oe,Fe,je,qe){let He=ie(F);const xt=0===Fe?re:ae;let Pt,jt,Gt=F.start;for(let bi=0;bi<F.length-3;bi+=3){const wi=F[bi],qr=F[bi+1],Xn=F[bi+2],Yn=F[bi+3],yo=F[bi+4],bo=0===Fe?wi:qr,Ro=0===Fe?Yn:yo;let Do=!1;qe&&(Pt=Math.sqrt(Math.pow(wi-Yn,2)+Math.pow(qr-yo,2))),bo<Le?Ro>Le&&(jt=xt(He,wi,qr,Yn,yo,Le),qe&&(He.start=Gt+Pt*jt)):bo>Oe?Ro<Oe&&(jt=xt(He,wi,qr,Yn,yo,Oe),qe&&(He.start=Gt+Pt*jt)):ne(He,wi,qr,Xn),Ro<Le&&bo>=Le&&(jt=xt(He,wi,qr,Yn,yo,Le),Do=!0),Ro>Oe&&bo<=Oe&&(jt=xt(He,wi,qr,Yn,yo,Oe),Do=!0),!je&&Do&&(qe&&(He.end=Gt+Pt*jt),Me.push(He),He=ie(F)),qe&&(Gt+=Pt)}let bi=F.length-3;const wi=F[bi],qr=F[bi+1],Xn=0===Fe?wi:qr;Xn>=Le&&Xn<=Oe&&ne(He,wi,qr,F[bi+2]),bi=He.length-3,je&&bi>=3&&(He[bi]!==He[0]||He[bi+1]!==He[1])&&ne(He,He[0],He[1],He[2]),He.length&&Me.push(He)}function ie(F){const Me=[];return Me.size=F.size,Me.start=F.start,Me.end=F.end,Me}function oe(F,Me,Le,Oe,Fe,je){for(const qe of F)se(qe,Me,Le,Oe,Fe,je,!1)}function ne(F,Me,Le,Oe){F.push(Me,Le,Oe)}function re(F,Me,Le,Oe,Fe,je){const qe=(je-Me)/(Oe-Me);return ne(F,je,Le+(Fe-Le)*qe,1),qe}function ae(F,Me,Le,Oe,Fe,je){const qe=(je-Le)/(Fe-Le);return ne(F,Me+(Oe-Me)*qe,je,1),qe}function le(F,Me){const Le=[];for(let Oe=0;Oe<F.length;Oe++){const Fe=F[Oe],je=Fe.type;let qe;if("Point"===je||"MultiPoint"===je||"LineString"===je)qe=ce(Fe.geometry,Me);else if("MultiLineString"===je||"Polygon"===je){qe=[];for(const F of Fe.geometry)qe.push(ce(F,Me))}else if("MultiPolygon"===je){qe=[];for(const F of Fe.geometry){const Le=[];for(const Oe of F)Le.push(ce(Oe,Me));qe.push(Le)}}Le.push(V(Fe.id,je,qe,Fe.tags))}return Le}function ce(F,Me){const Le=[];Le.size=F.size,void 0!==F.start&&(Le.start=F.start,Le.end=F.end);for(let Oe=0;Oe<F.length;Oe+=3)Le.push(F[Oe]+Me,F[Oe+1],F[Oe+2]);return Le}function he(F,Me){if(F.transformed)return F;const Le=1<<F.z,Oe=F.x,Fe=F.y;for(const je of F.features){const F=je.geometry,qe=je.type;if(je.geometry=[],1===qe)for(let qe=0;qe<F.length;qe+=2)je.geometry.push(ue(F[qe],F[qe+1],Me,Le,Oe,Fe));else for(let qe=0;qe<F.length;qe++){const He=[];for(let je=0;je<F[qe].length;je+=2)He.push(ue(F[qe][je],F[qe][je+1],Me,Le,Oe,Fe));je.geometry.push(He)}}return F.transformed=!0,F}function ue(F,Me,Le,Oe,Fe,je){return[Math.round(Le*(F*Oe-Fe)),Math.round(Le*(Me*Oe-je))]}function de(F,Me,Le,Oe,Fe){const je=Me===Fe.maxZoom?0:Fe.tolerance/((1<<Me)*Fe.extent),qe={features:[],numPoints:0,numSimplified:0,numFeatures:F.length,source:null,x:Le,y:Oe,z:Me,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Me of F)pe(qe,Me,je,Fe);return qe}function pe(F,Me,Le,Oe){const Fe=Me.geometry,je=Me.type,qe=[];if(F.minX=Math.min(F.minX,Me.minX),F.minY=Math.min(F.minY,Me.minY),F.maxX=Math.max(F.maxX,Me.maxX),F.maxY=Math.max(F.maxY,Me.maxY),"Point"===je||"MultiPoint"===je)for(let Me=0;Me<Fe.length;Me+=3)qe.push(Fe[Me],Fe[Me+1]),F.numPoints++,F.numSimplified++;else if("LineString"===je)fe(qe,Fe,F,Le,!1,!1);else if("MultiLineString"===je||"Polygon"===je)for(let Me=0;Me<Fe.length;Me++)fe(qe,Fe[Me],F,Le,"Polygon"===je,0===Me);else if("MultiPolygon"===je)for(let Me=0;Me<Fe.length;Me++){const Oe=Fe[Me];for(let Me=0;Me<Oe.length;Me++)fe(qe,Oe[Me],F,Le,!0,0===Me)}if(qe.length){let Le=Me.tags||null;if("LineString"===je&&Oe.lineMetrics){Le={};for(const F in Me.tags)Le[F]=Me.tags[F];Le.mapbox_clip_start=Fe.start/Fe.size,Le.mapbox_clip_end=Fe.end/Fe.size}const He={geometry:qe,type:"Polygon"===je||"MultiPolygon"===je?3:"LineString"===je||"MultiLineString"===je?2:1,tags:Le};null!==Me.id&&(He.id=Me.id),F.features.push(He)}}function fe(F,Me,Le,Oe,Fe,je){const qe=Oe*Oe;if(Oe>0&&Me.size<(Fe?qe:Oe))return void(Le.numPoints+=Me.length/3);const He=[];for(let F=0;F<Me.length;F+=3)(0===Oe||Me[F+2]>qe)&&(Le.numSimplified++,He.push(Me[F],Me[F+1])),Le.numPoints++;Fe&&function(F,Me){let Le=0;for(let Me=0,Oe=F.length,Fe=Oe-2;Me<Oe;Fe=Me,Me+=2)Le+=(F[Me]-F[Fe])*(F[Me+1]+F[Fe+1]);if(Le>0===Me)for(let Me=0,Le=F.length;Me<Le/2;Me+=2){const Oe=F[Me],Fe=F[Me+1];F[Me]=F[Le-2-Me],F[Me+1]=F[Le-1-Me],F[Le-2-Me]=Oe,F[Le-1-Me]=Fe}}(He,je),F.push(He)}const bo={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class me{constructor(F,Me){const Le=(Me=this.options=function(F,Me){for(const Le in Me)F[Le]=Me[Le];return F}(Object.create(bo),Me)).debug;if(Le&&console.time("preprocess data"),Me.maxZoom<0||Me.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Me.promoteId&&Me.generateId)throw new Error("promoteId and generateId cannot be used together.");let Oe=function(F,Me){const Le=[];if("FeatureCollection"===F.type)for(let Oe=0;Oe<F.features.length;Oe++)W(Le,F.features[Oe],Me,Oe);else W(Le,"Feature"===F.type?F:{geometry:F},Me);return Le}(F,Me);this.tiles={},this.tileCoords=[],Le&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Me.indexMaxZoom,Me.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Oe=function(F,Me){const Le=Me.buffer/Me.extent;let Oe=F;const Fe=ee(F,1,-1-Le,Le,0,-1,2,Me),je=ee(F,1,1-Le,2+Le,0,-1,2,Me);return(Fe||je)&&(Oe=ee(F,1,-Le,1+Le,0,-1,2,Me)||[],Fe&&(Oe=le(Fe,1).concat(Oe)),je&&(Oe=Oe.concat(le(je,-1)))),Oe}(Oe,Me),Oe.length&&this.splitTile(Oe,0,0,0),Le&&(Oe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(F,Me,Le,Oe,Fe,je,qe){const He=[F,Me,Le,Oe],xt=this.options,Pt=xt.debug;for(;He.length;){Oe=He.pop(),Le=He.pop(),Me=He.pop(),F=He.pop();const jt=1<<Me,Gt=ye(Me,Le,Oe);let bi=this.tiles[Gt];if(!bi&&(Pt>1&&console.time("creation"),bi=this.tiles[Gt]=de(F,Me,Le,Oe,xt),this.tileCoords.push({z:Me,x:Le,y:Oe}),Pt)){Pt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Me,Le,Oe,bi.numFeatures,bi.numPoints,bi.numSimplified),console.timeEnd("creation"));const F=`z${Me}`;this.stats[F]=(this.stats[F]||0)+1,this.total++}if(bi.source=F,null==Fe){if(Me===xt.indexMaxZoom||bi.numPoints<=xt.indexMaxPoints)continue}else{if(Me===xt.maxZoom||Me===Fe)continue;if(null!=Fe){const F=Fe-Me;if(Le!==je>>F||Oe!==qe>>F)continue}}if(bi.source=null,0===F.length)continue;Pt>1&&console.time("clipping");const wi=.5*xt.buffer/xt.extent,qr=.5-wi,Xn=.5+wi,Yn=1+wi;let yo=null,bo=null,Ro=null,Do=null,zs=ee(F,jt,Le-wi,Le+Xn,0,bi.minX,bi.maxX,xt),Zs=ee(F,jt,Le+qr,Le+Yn,0,bi.minX,bi.maxX,xt);F=null,zs&&(yo=ee(zs,jt,Oe-wi,Oe+Xn,1,bi.minY,bi.maxY,xt),bo=ee(zs,jt,Oe+qr,Oe+Yn,1,bi.minY,bi.maxY,xt),zs=null),Zs&&(Ro=ee(Zs,jt,Oe-wi,Oe+Xn,1,bi.minY,bi.maxY,xt),Do=ee(Zs,jt,Oe+qr,Oe+Yn,1,bi.minY,bi.maxY,xt),Zs=null),Pt>1&&console.timeEnd("clipping"),He.push(yo||[],Me+1,2*Le,2*Oe),He.push(bo||[],Me+1,2*Le,2*Oe+1),He.push(Ro||[],Me+1,2*Le+1,2*Oe),He.push(Do||[],Me+1,2*Le+1,2*Oe+1)}}getTile(F,Me,Le){F=+F,Me=+Me,Le=+Le;const Oe=this.options,{extent:Fe,debug:je}=Oe;if(F<0||F>24)return null;const qe=1<<F,He=ye(F,Me=Me+qe&qe-1,Le);if(this.tiles[He])return he(this.tiles[He],Fe);je>1&&console.log("drilling down to z%d-%d-%d",F,Me,Le);let xt,Pt=F,jt=Me,Gt=Le;for(;!xt&&Pt>0;)Pt--,jt>>=1,Gt>>=1,xt=this.tiles[ye(Pt,jt,Gt)];return xt&&xt.source?(je>1&&(console.log("found parent tile z%d-%d-%d",Pt,jt,Gt),console.time("drilling down")),this.splitTile(xt.source,Pt,jt,Gt,F,Me,Le),je>1&&console.timeEnd("drilling down"),this.tiles[He]?he(this.tiles[He],Fe):null):null}}function ye(F,Me,Le){return 32*((1<<F)*Le+Me)+F}function xe(Me,Le){const Oe=Me.tileID.canonical;if(!(this||F)._geoJSONIndex)return void Le(null,null);const Fe=(this||F)._geoJSONIndex.getTile(Oe.z,Oe.x,Oe.y);if(!Fe)return void Le(null,null);const je=new g(Fe.features);let qe=Gt(je);0===qe.byteOffset&&qe.byteLength===qe.buffer.byteLength||(qe=new Uint8Array(qe)),Le(null,{vectorTile:je,rawData:qe.buffer})}class we extends c{constructor(F,Me,Le,Oe,Fe,je){super(F,Me,Le,Oe,xe,je),Fe&&(this.loadGeoJSON=Fe),this._dynamicIndex=new x}loadData(F,Le){const Oe=F&&F.request,Fe=Oe&&Oe.collectResourceTiming;this.loadGeoJSON(F,((je,qe)=>{if(je||!qe)return Le(je);if("object"!=typeof qe)return Le(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));{try{if(F.filter){const Le=Me.X(F.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Le.result)throw new Error(Le.value.map((F=>`${F.key}: ${F.message}`)).join(", "));qe.features=qe.features.filter((F=>Le.value.evaluate({zoom:0},F)))}F.dynamic?("Feature"===qe.type&&(qe={type:"FeatureCollection",features:[qe]}),F.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(qe.features,this.loaded),F.cluster&&(qe.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=F.cluster?new E(function({superclusterOptions:F,clusterProperties:Le}){if(!Le||!F)return F;const Oe={},Fe={},je={accumulated:null,zoom:0},qe={properties:null},He=Object.keys(Le);for(const F of He){const[je,qe]=Le[F],He=Me.X(qe),xt=Me.X("string"==typeof je?[je,["accumulated"],["get",F]]:je);Oe[F]=He.value,Fe[F]=xt.value}return F.map=F=>{qe.properties=F;const Me={};for(const F of He)Me[F]=Oe[F].evaluate(je,qe);return Me},F.reduce=(F,Me)=>{qe.properties=Me;for(const Me of He)je.accumulated=F[Me],F[Me]=Fe[Me].evaluate(je,qe)},F}(F)).load(qe.features):F.dynamic?this._dynamicIndex:function(F,Me){return new me(F,Me)}(qe,F.geojsonVtOptions)}catch(F){return Le(F)}const je={};if(Fe){const Me=t(Oe);Me&&(je.resourceTiming={},je.resourceTiming[F.source]=JSON.parse(JSON.stringify(Me)))}Le(null,je)}}))}reloadTile(F,Me){const Le=this.loaded;return Le&&Le[F.uid]?F.partial?Me(null,void 0):super.reloadTile(F,Me):this.loadTile(F,Me)}loadGeoJSON(F,Le){if(F.request)Me.n(F.request,Le);else{if("string"!=typeof F.data)return Le(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));try{return Le(null,JSON.parse(F.data))}catch(Me){return Le(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(F,Me){try{Me(null,this._geoJSONIndex.getClusterExpansionZoom(F.clusterId))}catch(F){Me(F)}}getClusterChildren(F,Me){try{Me(null,this._geoJSONIndex.getChildren(F.clusterId))}catch(F){Me(F)}}getClusterLeaves(F,Me){try{Me(null,this._geoJSONIndex.getLeaves(F.clusterId,F.limit,F.offset))}catch(F){Me(F)}}}class be{constructor(F,Le){this.tileID=new Me.aH(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=F.projection,this.brightness=Le}parse(F,Le,Oe,Fe){this.status="parsing";const je=new Me.aH(Oe.tileID.overscaledZ,Oe.tileID.wrap,Oe.tileID.canonical.z,Oe.tileID.canonical.x,Oe.tileID.canonical.y),qe=[],He=Le.familiesBySource[Oe.source],xt=new Me.e0(je,Oe.promoteId);return xt.bucketLayerIDs=[],xt.is3DTile=!0,Me.ei(F).then((F=>{if(!F)return Fe(new Error("Could not parse tile"));const Le=Me.ej(F,1/Me.cd(Oe.tileID.canonical)),Pt=F.json.extensionsUsed&&F.json.extensionsUsed.includes("MAPBOX_mesh_features")||F.json.asset.extras&&F.json.asset.extras.MAPBOX_mesh_features,jt=F.json.extensionsUsed&&F.json.extensionsUsed.includes("EXT_meshopt_compression"),Gt=new Me.aa(this.zoom,{brightness:this.brightness});for(const F in He)for(const Oe of He[F]){const F=Oe[0];xt.bucketLayerIDs.push(Oe.map((F=>Me.C(F.id,F.scope)))),F.recalculate(Gt,[]);const Fe=new Me.ek(Oe,Le,je,Pt,jt,this.brightness,xt);Pt||(Fe.needsUpload=!0),qe.push(Fe),Fe.evaluate(F)}this.status="done",Fe(null,{buckets:qe,featureIndex:xt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((F=>Fe(new Error(F.message))))}}class ve{constructor(F,Me,Le,Oe,Fe,je){this.actor=F,this.layerIndex=Me,this.availableImages=Le,this.brightness=je,this.loading={},this.loaded={}}loadTile(F,Le){const Oe=F.uid,Fe=this.loading[Oe]=new be(F,this.brightness);Me.bj(F.request,((Me,je)=>{const qe=!this.loading[Oe];return delete this.loading[Oe],qe||Me?(Fe.status="done",qe||(this.loaded[Oe]=Fe),Le(Me)):je&&0!==je.byteLength?void Fe.parse(je,this.layerIndex,F,((F,Me)=>{Fe.status="done",this.loaded=this.loaded||{},this.loaded[Oe]=Fe,F||!Me?Le(F):Le(null,Me)})):(Fe.status="done",this.loaded[Oe]=Fe,Le())}))}reloadTile(F,Me){const Le=this.loaded,Oe=F.uid;if(Le&&Le[Oe]){const Fe=Le[Oe];Fe.projection=F.projection,Fe.brightness=F.brightness;const n=(Le,Oe)=>{Fe.reloadCallback&&(delete Fe.reloadCallback,this.loadTile(F,Me)),Me(Le,Oe)};"parsing"===Fe.status?Fe.reloadCallback=n:"done"===Fe.status&&this.loadTile(F,Me)}}abortTile(F,Me){const Le=F.uid;this.loading[Le]&&delete this.loading[Le],Me()}removeTile(F,Me){const Le=this.loaded,Oe=F.uid;Le&&Le[Oe]&&delete Le[Oe],Me()}}class Ie{constructor(F){this.self=F,this.actor=new Me.el(F,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new Me.y,this.projections={},this.defaultProjection=Me.bP({name:"mercator"}),this.workerSourceTypes={vector:c,geojson:we,"raster-dem":h,"raster-array":d,"batched-model":ve},this.workerSources={},this.self.registerWorkerSource=(F,Me)=>{if(this.workerSourceTypes[F])throw new Error(`Worker source with name "${F}" already registered.`);this.workerSourceTypes[F]=Me},this.self.registerRTLTextPlugin=F=>{if(Me.em.isParsed())throw new Error("RTL text plugin already registered.");Me.em.applyArabicShaping=F.applyArabicShaping,Me.em.processBidirectionalText=F.processBidirectionalText,Me.em.processStyledBidirectionalText=F.processStyledBidirectionalText}}clearCaches(F,Me,Le){delete this.layerIndexes[F],delete this.availableImages[F],delete this.workerSources[F],Le()}checkIfReady(F,Me,Le){Le()}setReferrer(F,Me){this.referrer=Me}spriteLoaded(F,{scope:Le,isLoaded:Oe}){if(this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),this.isSpriteLoaded[F][Le]=Oe,this.workerSources[F]&&this.workerSources[F][Le])for(const Fe in this.workerSources[F][Le]){const je=this.workerSources[F][Le][Fe];for(const F in je){const Le=je[F];Le instanceof c&&(Le.isSpriteLoaded=Oe,Le.fire(new Me.A("isSpriteLoaded")))}}}setImages(F,{scope:Me,images:Le},Oe){if(this.availableImages[F]||(this.availableImages[F]={}),this.availableImages[F][Me]=Le,this.workerSources[F]&&this.workerSources[F][Me]){for(const Oe in this.workerSources[F][Me]){const Fe=this.workerSources[F][Me][Oe];for(const F in Fe)Fe[F].availableImages=Le}Oe()}else Oe()}setProjection(F,Le){this.projections[F]=Me.bP(Le)}setBrightness(F,Me,Le){this.brightness=Me,Le()}setLayers(F,Me,Le){this.getLayerIndex(F,Me.scope).replace(Me.layers,Me.options),Le()}updateLayers(F,Me,Le){this.getLayerIndex(F,Me.scope).update(Me.layers,Me.removedIds,Me.options),Le()}loadTile(F,Me,Le){Me.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,Me.type,Me.source,Me.scope).loadTile(Me,Le)}decodeRasterArray(F,Me,Le){this.getWorkerSource(F,Me.type,Me.source,Me.scope).decodeRasterArray(Me,Le)}reloadTile(F,Me,Le){Me.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,Me.type,Me.source,Me.scope).reloadTile(Me,Le)}abortTile(F,Me,Le){this.getWorkerSource(F,Me.type,Me.source,Me.scope).abortTile(Me,Le)}removeTile(F,Me,Le){this.getWorkerSource(F,Me.type,Me.source,Me.scope).removeTile(Me,Le)}removeSource(F,Me,Le){if(!(this.workerSources[F]&&this.workerSources[F][Me.scope]&&this.workerSources[F][Me.scope][Me.type]&&this.workerSources[F][Me.scope][Me.type][Me.source]))return;const Oe=this.workerSources[F][Me.scope][Me.type][Me.source];delete this.workerSources[F][Me.scope][Me.type][Me.source],void 0!==Oe.removeSource?Oe.removeSource(Me,Le):Le()}loadWorkerSource(F,Me,Le){try{this.self.importScripts(Me.url),Le()}catch(F){Le(F.toString())}}syncRTLPluginState(F,Le,Oe){try{Me.em.setState(Le);const F=Me.em.getPluginURL();if(Me.em.isLoaded()&&!Me.em.isParsed()&&null!=F){this.self.importScripts(F);const Le=Me.em.isParsed();Oe(Le?void 0:new Error(`RTL Text Plugin failed to import scripts from ${F}`),Le)}}catch(F){Oe(F.toString())}}setDracoUrl(F,Me){this.dracoUrl=Me}getAvailableImages(F,Me){this.availableImages[F]||(this.availableImages[F]={});let Le=this.availableImages[F][Me];return Le||(Le=[]),Le}getLayerIndex(F,Me){this.layerIndexes[F]||(this.layerIndexes[F]={});let Le=this.layerIndexes[F][Me];return Le||(Le=this.layerIndexes[F][Me]=new o,Le.scope=Me),Le}getWorkerSource(F,Me,Le,Oe){const Fe=this.workerSources;return Fe[F]||(Fe[F]={}),Fe[F][Oe]||(Fe[F][Oe]={}),Fe[F][Oe][Me]||(Fe[F][Oe][Me]={}),this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),Fe[F][Oe][Me][Le]||(Fe[F][Oe][Me][Le]=new this.workerSourceTypes[Me]({send:(Me,Le,Oe,Fe,je,qe)=>{this.actor.send(Me,Le,Oe,F,je,qe)},scheduler:this.actor.scheduler},this.getLayerIndex(F,Oe),this.getAvailableImages(F,Oe),this.isSpriteLoaded[F][Oe],void 0,this.brightness)),Fe[F][Oe][Me][Le]}rasterizeImages(F,Me,Le){const Oe=new Map;for(const[Le,{image:Fe,imageVariant:je}]of Me.tasks.entries()){const qe=this.imageRasterizer.rasterize(je,Fe,Me.scope,F);Oe.set(Le,qe)}Le(void 0,Oe)}removeRasterizedImages(F,Me,Le){this.imageRasterizer.removeImagesFromCacheByIds(Me.imageIds,Me.scope,F),Le()}enforceCacheSizeLimit(F,Le){Me.en(Le)}getWorkerPerformanceMetrics(F,Me,Le){Le(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new Ie(self)),Ie}));define(["./shared"],(function(F){var Me="3.11.1";const Le={create:"create",load:"load",fullLoad:"fullLoad"},Oe={mark(F){performance.mark(F)},measure(F,Me,Le){performance.measure(F,Me,Le)}};function s(Me){const Le=Me.name.split("?")[0];return F.a(Le)&&Le.includes("mapbox-gl.js")?"javascript":F.a(Le)&&Le.includes("mapbox-gl.css")?"css":F.b(Le)?"fontRange":F.c(Le)?"sprite":F.i(Le)?"style":F.d(Le)?"tilejson":"other"}var Fe,je={},qe=function(){if(Fe)return je;function e(F){return!t(F)}function t(Me){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var F,Me,Le=new Blob([""],{type:"text/javascript"}),Oe=URL.createObjectURL(Le);try{Me=new Worker(Oe),F=!0}catch(Me){F=!1}return Me&&Me.terminate(),URL.revokeObjectURL(Oe),F}()?function(){var F=document.createElement("canvas");F.width=F.height=1;var Me=F.getContext("2d");if(!Me)return!1;var Le=Me.getImageData(0,0,1,1);return Le&&Le.width===F.width}()?(void 0===F[Le=Me&&Me.failIfMajorPerformanceCaveat]&&(F[Le]=function(F){var Me,Le=function(F){var Me=document.createElement("canvas"),Le=Object.create(e.webGLContextAttributes);return Le.failIfMajorPerformanceCaveat=F,Me.getContext("webgl2",Le)}(F);if(!Le)return!1;try{Me=Le.createShader(Le.VERTEX_SHADER)}catch(F){return!1}return!(!Me||Le.isContextLost())&&(Le.shaderSource(Me,"void main() {}"),Le.compileShader(Me),!0===Le.getShaderParameter(Me,Le.COMPILE_STATUS))}(Le)),F[Le]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var Le}Fe=1,je.supported=e,je.notSupportedReason=t;var F={};return e.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},je}();function l(F,Me,Le){const Oe=document.createElement(F);return null!=Me&&(Oe.className=Me),Le&&Le.appendChild(Oe),Oe}function c(F,Me,Le){const Oe=document.createElementNS("http://www.w3.org/2000/svg",F);for(const F of Object.keys(Me))Oe.setAttributeNS(null,F,String(Me[F]));return Le&&Le.appendChild(Oe),Oe}const He="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,xt=He&&void 0!==He.userSelect?"userSelect":"WebkitUserSelect";let Pt;function _(){He&&xt&&(Pt=He[xt],He[xt]="none")}function p(){He&&xt&&(He[xt]=Pt)}function f(F){F.preventDefault(),F.stopPropagation(),window.removeEventListener("click",f,!0)}function m(){window.addEventListener("click",f,!0),window.setTimeout((()=>{window.removeEventListener("click",f,!0)}),0)}function g(F,Me){const Le=F.getBoundingClientRect();return x(F,Le,Me)}function v(F,Me){const Le=F.getBoundingClientRect(),Oe=[];for(let Fe=0;Fe<Me.length;Fe++)Oe.push(x(F,Le,Me[Fe]));return Oe}function y(F){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===F.button&&F.ctrlKey?0:F.button}function x(Me,Le,Oe){const Fe=Me.offsetWidth===Le.width?1:Me.offsetWidth/Le.width;return new F.P((Oe.clientX-Le.left)*Fe,(Oe.clientY-Le.top)*Fe)}const jt="01",Gt="NO_ACCESS_TOKEN";class T{constructor(F,Me,Le){this._transformRequestFn=F,this._customAccessToken=Me,this._silenceAuthErrors=!!Le,this._createSkuToken()}_createSkuToken(){const F=function(){let F="";for(let Me=0;Me<10;Me++)F+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",jt,F].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=F.token,this._skuTokenExpiresAt=F.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(F,Me){return this._transformRequestFn&&this._transformRequestFn(F,Me)||{url:F}}normalizeStyleURL(Le,Oe){if(!F.f(Le))return Le;const Fe=S(Le);return Fe.params.push(`sdk=js-${Me}`),Fe.path=`/styles/v1${Fe.path}`,this._makeAPIURL(Fe,this._customAccessToken||Oe)}normalizeGlyphsURL(Me,Le){if(!F.f(Me))return Me;const Oe=S(Me);return Oe.path=`/fonts/v1${Oe.path}`,this._makeAPIURL(Oe,this._customAccessToken||Le)}normalizeModelURL(Me,Le){if(!F.f(Me))return Me;const Oe=S(Me);return Oe.path=`/models/v1${Oe.path}`,this._makeAPIURL(Oe,this._customAccessToken||Le)}normalizeSourceURL(Me,Le,Oe,Fe){if(!F.f(Me))return Me;const je=S(Me);return je.path=`/v4/${je.authority}.json`,je.params.push("secure"),Oe&&je.params.push(`language=${Oe}`),Fe&&je.params.push(`worldview=${Fe}`),this._makeAPIURL(je,this._customAccessToken||Le)}normalizeIconsetURL(Me,Le){const Oe=S(Me);return F.f(Me)?(Oe.path=`/styles/v1${Oe.path}/iconset.pbf`,this._makeAPIURL(Oe,this._customAccessToken||Le)):C(Oe)}normalizeSpriteURL(Me,Le,Oe,Fe){const je=S(Me);return F.f(Me)?(je.path=`/styles/v1${je.path}/sprite${Le}${Oe}`,this._makeAPIURL(je,this._customAccessToken||Fe)):(je.path+=`${Le}${Oe}`,C(je))}normalizeTileURL(Me,Le,Oe){if(this._isSkuTokenExpired()&&this._createSkuToken(),Me&&!F.f(Me))return Me;const Fe=S(Me);Fe.path=Fe.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${Le||Oe&&"raster"!==Fe.authority&&512===Oe?"@2x":""}${F.m.supported?".webp":"$1"}`),"raster"===Fe.authority?Fe.path=`/${F.e.RASTER_URL_PREFIX}${Fe.path}`:"rasterarrays"===Fe.authority?Fe.path=`/${F.e.RASTERARRAYS_URL_PREFIX}${Fe.path}`:"3dtiles"===Fe.authority?Fe.path=`/${F.e.TILES3D_URL_PREFIX}${Fe.path}`:(Fe.path=Fe.path.replace(/^.+\/v4\//,"/"),Fe.path=`/${F.e.TILE_URL_VERSION}${Fe.path}`);const je=this._customAccessToken||function(F){for(const Me of F){const F=Me.match(/^access_token=(.*)$/);if(F)return F[1]}return null}(Fe.params)||F.e.ACCESS_TOKEN;return F.e.REQUIRE_ACCESS_TOKEN&&je&&this._skuToken&&Fe.params.push(`sku=${this._skuToken}`),this._makeAPIURL(Fe,je)}canonicalizeTileURL(Me,Le){const Oe=S(Me);if(!Oe.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!Oe.path.match(/\.[\w]+$/))return Me;let Fe="mapbox://";Oe.path.match(/^\/raster\/v1\//)?Fe+=`raster/${Oe.path.replace(`/${F.e.RASTER_URL_PREFIX}/`,"")}`:Oe.path.match(/^\/rasterarrays\/v1\//)?Fe+=`rasterarrays/${Oe.path.replace(`/${F.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:Fe+=`tiles/${Oe.path.replace(`/${F.e.TILE_URL_VERSION}/`,"")}`;let je=Oe.params;return Le&&(je=je.filter((F=>!F.match(/^access_token=/)))),je.length&&(Fe+=`?${je.join("&")}`),Fe}canonicalizeTileset(Me,Le){const Oe=!!Le&&F.f(Le),Fe=[];for(const Le of Me.tiles||[])F.h(Le)?Fe.push(this.canonicalizeTileURL(Le,Oe)):Fe.push(Le);return Fe}_makeAPIURL(Me,Le){const Oe="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",Fe=S(F.e.API_URL);if(Me.protocol=Fe.protocol,Me.authority=Fe.authority,"http"===Me.protocol){const F=Me.params.indexOf("secure");F>=0&&Me.params.splice(F,1)}if("/"!==Fe.path&&(Me.path=`${Fe.path}${Me.path}`),!F.e.REQUIRE_ACCESS_TOKEN)return C(Me);if(Le=Le||F.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!Le)throw new Error(`An API access token is required to use Mapbox GL. ${Oe}`);if("s"===Le[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${Oe}`)}return Me.params=Me.params.filter((F=>-1===F.indexOf("access_token"))),Me.params.push(`access_token=${Le||""}`),C(Me)}}const bi=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function S(F){const Me=F.match(bi);if(!Me)throw new Error("Unable to parse URL object");return{protocol:Me[1],authority:Me[2],path:Me[3]||"/",params:Me[4]?Me[4].split("&"):[]}}function C(F){const Me=F.params.length?`?${F.params.join("&")}`:"";return`${F.protocol}://${F.authority}${F.path}${Me}`}const wi="mapbox.eventData";function R(Me){if(!Me)return null;const Le=Me.split(".");if(!Le||3!==Le.length)return null;try{return JSON.parse(F.j(Le[1]))}catch(F){return null}}class D{constructor(F){this.type=F,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(Me){const Le=R(F.e.ACCESS_TOKEN);let Oe="";return Oe=Le&&Le.u?F.k(Le.u):F.e.ACCESS_TOKEN||"",Me?`${wi}.${Me}:${Oe}`:`${wi}:${Oe}`}fetchEventData(){const Me=F.s("localStorage"),Le=this.getStorageKey(),Oe=this.getStorageKey("uuid");if(Me)try{const F=localStorage.getItem(Le);F&&(this.eventData=JSON.parse(F));const Me=localStorage.getItem(Oe);Me&&(this.anonId=Me)}catch(Me){F.w("Unable to read from LocalStorage")}}saveEventData(){const Me=F.s("localStorage"),Le=this.getStorageKey(),Oe=this.getStorageKey("uuid"),Fe=this.anonId;if(Me&&Fe)try{localStorage.setItem(Oe,Fe),Object.keys(this.eventData).length>=1&&localStorage.setItem(Le,JSON.stringify(this.eventData))}catch(Me){F.w("Unable to write to LocalStorage")}}processRequests(F){}postEvent(Me,Le,Oe,Fe){if(!F.e.EVENTS_URL)return;const je=S(F.e.EVENTS_URL);je.params.push(`access_token=${Fe||F.e.ACCESS_TOKEN||""}`);const qe={event:this.type,created:new Date(Me).toISOString()},He=Le?F.l(qe,Le):qe,xt={url:C(je),headers:{"Content-Type":"text/plain"},body:JSON.stringify([He])};this.pendingRequest=F.p(xt,(F=>{this.pendingRequest=null,Oe(F),this.saveEventData(),this.processRequests(Fe)}))}queueRequest(F,Me){this.queue.push(F),this.processRequests(Me)}}const qr=new class extends D{constructor(F){super("appUserTurnstile"),this._customAccessToken=F}postTurnstileEvent(Me,Le){F.e.EVENTS_URL&&F.e.ACCESS_TOKEN&&Array.isArray(Me)&&Me.some((Me=>F.f(Me)||F.h(Me)))&&this.queueRequest(Date.now(),Le)}processRequests(Le){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const Oe=R(F.e.ACCESS_TOKEN),Fe=Oe?Oe.u:F.e.ACCESS_TOKEN;let je=Fe!==this.eventData.tokenU;F.v(this.anonId)||(this.anonId=F.u(),je=!0);const qe=this.queue.shift();if(this.eventData.lastSuccess){const F=new Date(this.eventData.lastSuccess),Me=new Date(qe),Le=(qe-this.eventData.lastSuccess)/864e5;je=je||Le>=1||Le<-1||F.getDate()!==Me.getDate()}else je=!0;je?this.postEvent(qe,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Me,skuId:jt,"enabled.telemetry":!1,userId:this.anonId},(F=>{F||(this.eventData.lastSuccess=qe,this.eventData.tokenU=Fe)}),Le):this.processRequests()}},Xn=qr.postTurnstileEvent.bind(qr),Yn=new class extends D{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(Me,Le,Oe,Fe){this.skuToken=Le,this.errorCb=Fe,F.e.EVENTS_URL&&(Oe||F.e.ACCESS_TOKEN?this.queueRequest({id:Me,timestamp:Date.now()},Oe):this.errorCb(new Error(Gt)))}processRequests(Le){if(this.pendingRequest||0===this.queue.length)return;const{id:Oe,timestamp:Fe}=this.queue.shift();Oe&&this.success[Oe]||(this.anonId||this.fetchEventData(),F.v(this.anonId)||(this.anonId=F.u()),this.postEvent(Fe,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Me,skuId:jt,skuToken:this.skuToken,userId:this.anonId},(F=>{F?this.errorCb(F):Oe&&(this.success[Oe]=!0)}),Le))}remove(){this.errorCb=null}},yo=Yn.postMapLoadEvent.bind(Yn),bo=new class extends D{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(Me){let Le=this.mapInstanceIdMap.get(Me);return Le||(Le=F.u(),this.mapInstanceIdMap.set(Me,Le)),Le}getEventId(F){const Me=this.eventIdPerMapInstanceMap.get(F)||0;return this.eventIdPerMapInstanceMap.set(F,Me+1),Me}postStyleLoadEvent(Me,Le){const{map:Oe,style:Fe,importedStyles:je}=Le;if(!F.e.EVENTS_URL||!Me&&!F.e.ACCESS_TOKEN)return;const qe=this.getMapInstanceId(Oe),He={mapInstanceId:qe,eventId:this.getEventId(qe),style:Fe};je.length&&(He.importedStyles=je),this.queueRequest({timestamp:Date.now(),payload:He},Me)}processRequests(F){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:Me,payload:Le}=this.queue.shift();this.postEvent(Me,Le,(()=>{}),F)}},Ro=bo.postStyleLoadEvent.bind(bo),Do=new class extends D{constructor(){super("gljs.performance")}postPerformanceEvent(Me,Le){F.e.EVENTS_URL&&(Me||F.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:Le},Me)}processRequests(Oe){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:Fe,performanceData:je}=this.queue.shift(),qe=function(Oe){const Fe=performance.getEntriesByType("resource"),je=performance.getEntriesByType("mark"),qe=function(F){const Me={};if(F)for(const Le in F)if("other"!==Le)for(const Oe of F[Le]){const F=`${Le}ResolveRangeMin`,Fe=`${Le}ResolveRangeMax`,je=`${Le}RequestCount`,qe=`${Le}RequestCachedCount`;Me[F]=Math.min(Me[F]||1/0,Oe.startTime),Me[Fe]=Math.max(Me[Fe]||-1/0,Oe.responseEnd);const a=F=>{void 0===Me[F]&&(Me[F]=0),++Me[F]};void 0!==Oe.transferSize&&0===Oe.transferSize&&a(qe),a(je)}return Me}(function(F,Me){const Le={};if(F)for(const Oe of F){const F=Me(Oe);void 0===Le[F]&&(Le[F]=[]),Le[F].push(Oe)}return Le}(Fe,s)),He=window.devicePixelRatio,xt=navigator.connection||navigator.mozConnection||navigator.webkitConnection,Pt=xt?xt.effectiveType:void 0,jt={counters:[],metadata:[],attributes:[]},u=(F,Me,Le)=>{null!=Le&&F.push({name:Me,value:Le.toString()})};for(const F in qe)u(jt.counters,F,qe[F]);if(Oe.interactionRange[0]!==1/0&&Oe.interactionRange[1]!==-1/0&&(u(jt.counters,"interactionRangeMin",Oe.interactionRange[0]),u(jt.counters,"interactionRangeMax",Oe.interactionRange[1])),je)for(const F of Object.keys(Le)){const Me=Le[F],Oe=je.find((F=>F.name===Me));Oe&&u(jt.counters,Me,Oe.startTime)}return u(jt.counters,"visibilityHidden",Oe.visibilityHidden),u(jt.attributes,"style",function(Me){if(Me)for(const Le of Me){const Me=Le.name.split("?")[0];if(F.i(Me)){const F=Me.split("/").slice(-2);if(2===F.length)return`mapbox://styles/${F[0]}/${F[1]}`}}}(Fe)),u(jt.attributes,"terrainEnabled",Oe.terrainEnabled?"true":"false"),u(jt.attributes,"fogEnabled",Oe.fogEnabled?"true":"false"),u(jt.attributes,"projection",Oe.projection),u(jt.attributes,"zoom",Oe.zoom),u(jt.metadata,"devicePixelRatio",He),u(jt.metadata,"connectionEffectiveType",Pt),u(jt.metadata,"navigatorUserAgent",navigator.userAgent),u(jt.metadata,"screenWidth",window.screen.width),u(jt.metadata,"screenHeight",window.screen.height),u(jt.metadata,"windowWidth",window.innerWidth),u(jt.metadata,"windowHeight",window.innerHeight),u(jt.metadata,"mapWidth",Oe.width/He),u(jt.metadata,"mapHeight",Oe.height/He),u(jt.metadata,"webglRenderer",Oe.renderer),u(jt.metadata,"webglVendor",Oe.vendor),u(jt.metadata,"sdkVersion",Me),u(jt.metadata,"sdkIdentifier","mapbox-gl-js"),jt}(je);for(const F of qe.metadata);for(const F of qe.counters);for(const F of qe.attributes);this.postEvent(Fe,qe,(()=>{}),Oe)}},zs=Do.postPerformanceEvent.bind(Do),Zs=new class extends D{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(Me,Le,Oe,Fe){if(!F.e.API_URL||!F.e.SESSION_PATH)return;const je=S(F.e.API_URL+F.e.SESSION_PATH);je.params.push(`sku=${Le||""}`),je.params.push(`access_token=${Fe||F.e.ACCESS_TOKEN||""}`);const qe={url:C(je),headers:{"Content-Type":"text/plain"}};this.pendingRequest=F.g(qe,(F=>{this.pendingRequest=null,Oe(F),this.saveEventData(),this.processRequests(Fe)}))}getSessionAPI(Me,Le,Oe,Fe){this.skuToken=Le,this.errorCb=Fe,F.e.SESSION_PATH&&F.e.API_URL&&(Oe||F.e.ACCESS_TOKEN?this.queueRequest({id:Me,timestamp:Date.now()},Oe):this.errorCb(new Error(Gt)))}processRequests(F){if(this.pendingRequest||0===this.queue.length)return;const{id:Me,timestamp:Le}=this.queue.shift();Me&&this.success[Me]||this.getSession(Le,this.skuToken,(F=>{F?this.errorCb(F):Me&&(this.success[Me]=!0)}),F)}remove(){this.errorCb=null}},na=Zs.getSessionAPI.bind(Zs),el=new Set;function V(F,Me){Me?el.add(F):el.delete(F)}class G{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(F,Me){this._updatedSourceCaches[F]=Me,this.setDirty()}discardSourceCacheUpdate(F){delete this._updatedSourceCaches[F]}updateLayer(F){const Me=F.scope;this._updatedLayers[Me]=this._updatedLayers[Me]||new Set,this._updatedLayers[Me].add(F.id),this.setDirty()}removeLayer(F){const Me=F.scope;this._removedLayers[Me]=this._removedLayers[Me]||{},this._updatedLayers[Me]=this._updatedLayers[Me]||new Set,this._removedLayers[Me][F.id]=F,this._updatedLayers[Me].delete(F.id),this._updatedPaintProps.delete(F.fqid),this.setDirty()}getRemovedLayer(F){return this._removedLayers[F.scope]?this._removedLayers[F.scope][F.id]:null}discardLayerRemoval(F){this._removedLayers[F.scope]&&delete this._removedLayers[F.scope][F.id]}getLayerUpdatesByScope(){const F={};for(const Me in this._updatedLayers)F[Me]=F[Me]||{},F[Me].updatedIds=Array.from(this._updatedLayers[Me].values());for(const Me in this._removedLayers)F[Me]=F[Me]||{},F[Me].removedIds=Object.keys(this._removedLayers[Me]);return F}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(F){this._updatedPaintProps.add(F.fqid),this.setDirty()}getUpdatedImages(F){return this._updatedImages[F]?Array.from(this._updatedImages[F].values()):[]}updateImage(Me,Le){this._updatedImages[Le]=this._updatedImages[Le]||new Set,this._updatedImages[Le].add(F.I.toString(Me)),this.setDirty()}resetUpdatedImages(F){this._updatedImages[F]&&this._updatedImages[F].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function j(F){const{userImage:Me}=F;return!!(Me&&Me.render&&Me.render())&&(F.data.replace(new Uint8Array(Me.data.buffer)),!0)}class q extends F.E{constructor(Me){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=Me,"raster"!==Me&&F.t()&&(this.imageRasterizerDispatcher=new F.D(F.x(),this,"Image Rasterizer Worker",1))}addScope(Me){this.loaded.set(Me,!1),this.imageProviders.set(Me,new Map),this.images.set(Me,new Map),this.updatedImages.set(Me,new Set),this.callbackDispatchedThisFrame.set(Me,new Set),this.patterns.set(Me,new Map),this.atlasImage.set(Me,new F.r({width:1,height:1}))}removeScope(F){this.loaded.delete(F),this.imageProviders.delete(F),this.images.delete(F),this.updatedImages.delete(F),this.callbackDispatchedThisFrame.delete(F),this.patterns.delete(F),this.atlasImage.delete(F);const Me=this.atlasTexture.get(F);Me&&(Me.destroy(),this.atlasTexture.delete(F))}addImageProvider(F,Me){this.imageProviders.has(Me)||this.imageProviders.set(Me,new Map),this.imageProviders.get(Me).set(F.id,F)}removeImageProvider(F,Me){this.imageProviders.has(Me)&&this.imageProviders.get(Me).delete(F)}getPendingImageProviders(){const F=[];for(const Me of this.imageProviders.values())for(const Le of Me.values())Le.hasPendingRequests()&&F.push(Le);return F}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new F.y),this._imageRasterizer}isLoaded(){for(const F of this.loaded.keys())if(!this.loaded.get(F))return!1;return!0}setLoaded(F,Me){if(this.loaded.get(Me)!==F&&(this.loaded.set(Me,F),F)){for(const{ids:F,callback:Le}of this.requestors)this._notify(F,Me,Le);this.requestors=[]}}hasImage(F,Me){return!!this.getImage(F,Me)}getImage(F,Me){return this.images.get(Me).get(F.toString())}addImage(F,Me,Le){this._validate(F,Le)&&this.images.get(Me).set(F.toString(),Le)}_validate(Me,Le){let Oe=!0;return this._validateStretch(Le.stretchX,Le.data&&Le.data.width)||(this.fire(new F.z(new Error(`Image "${Me.name}" has invalid "stretchX" value`))),Oe=!1),this._validateStretch(Le.stretchY,Le.data&&Le.data.height)||(this.fire(new F.z(new Error(`Image "${Me.name}" has invalid "stretchY" value`))),Oe=!1),this._validateContent(Le.content,Le)||(this.fire(new F.z(new Error(`Image "${Me.name}" has invalid "content" value`))),Oe=!1),Oe}_validateStretch(F,Me){if(!F)return!0;let Le=0;for(const Oe of F){if(Oe[0]<Le||Oe[1]<Oe[0]||Me<Oe[1])return!1;Le=Oe[1]}return!0}_validateContent(F,Me){if(!F)return!0;if(4!==F.length)return!1;if(!Me.usvg){if(F[0]<0||Me.data.width<F[0])return!1;if(F[1]<0||Me.data.height<F[1])return!1;if(F[2]<0||Me.data.width<F[2])return!1;if(F[3]<0||Me.data.height<F[3])return!1}return!(F[2]<F[0]||F[3]<F[1])}updateImage(F,Me,Le){const Oe=this.images.get(Me).get(F.toString());Le.version=Oe.version+1,this.images.get(Me).set(F.toString(),Le),this.updatedImages.get(Me).add(F),this.removeFromImageRasterizerCache(F,Me)}clearUpdatedImages(F){this.updatedImages.get(F).clear()}removeFromImageRasterizerCache(Me,Le){if("raster"!==this.spriteFormat)if(F.t()){const F={imageIds:[Me],scope:Le};this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",F)}else this.imageRasterizer.removeImagesFromCacheByIds([Me],Le)}removeImage(F,Me){const Le=this.images.get(Me),Oe=Le.get(F.toString());Le.delete(F.toString()),this.patterns.get(Me).delete(F.toString()),this.removeFromImageRasterizerCache(F,Me),Oe.userImage&&Oe.userImage.onRemove&&Oe.userImage.onRemove()}listImages(Me){return Array.from(this.images.get(Me).keys()).map((Me=>F.I.from(Me)))}getImages(F,Me,Le){const Oe=[],Fe=[],je=this.imageProviders.get(Me);for(const Le of F){if(!Le.iconsetId){Oe.push(Le);continue}const F=je.get(Le.iconsetId);F&&(this.getImage(Le,Me)?Fe.push(Le):F.addPendingRequest(Le))}if(0===Oe.length)return void this._notify(Fe,Me,Le);let qe=!0;const He=!!this.loaded.get(Me),xt=this.images.get(Me);if(!He)for(const F of Oe)xt.has(F.toString())||(qe=!1);He||qe?this._notify(Oe,Me,Le):this.requestors.push({ids:Oe,scope:Me,callback:Le})}rasterizeImages({scope:F,tasks:Me},Le){const Oe=new Map;for(const[Le,Fe]of Me.entries()){const Me=this.getImage(Fe.id,F);Me&&Oe.set(Le,{image:Me,imageVariant:Fe})}this._rasterizeImages(F,Oe,Le)}_rasterizeImages(Me,Le,Oe){if(F.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{tasks:Le,scope:Me},Oe);else{const F=new Map;for(const[Oe,{image:Fe,imageVariant:je}]of Le.entries())F.set(Oe,this.imageRasterizer.rasterize(je,Fe,Me,0));Oe(void 0,F)}}getUpdatedImages(F){return this.updatedImages.get(F)||new Set}_notify(Me,Le,Oe){const Fe=this.images.get(Le),je=new Map;for(const Le of Me){const Me=Fe.get(Le.toString());if(!Me){if(Le.iconsetId)continue;F.w(`Image "${Le.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`),this.fire(new F.A("styleimagemissing",{id:Le.name}));continue}const Oe={data:Me.usvg?null:Me.data.clone(),pixelRatio:Me.pixelRatio,sdf:Me.sdf,usvg:Me.usvg,version:Me.version,stretchX:Me.stretchX,stretchY:Me.stretchY,content:Me.content,hasRenderCallback:Boolean(Me.userImage&&Me.userImage.render)};Me.usvg&&Object.assign(Oe,{width:Me.icon.usvg_tree.width,height:Me.icon.usvg_tree.height}),je.set(F.I.toString(Le),Oe)}Oe(null,je)}getPixelSize(F){const{width:Me,height:Le}=this.atlasImage.get(F);return{width:Me,height:Le}}getPattern(Me,Le,Oe){const Fe=Me.toString(),je=this.patterns.get(Le),qe=je.get(Fe),He=this.getImage(Me,Le);if(!He)return null;if(qe){if(qe.position.version===He.version)return qe.position;qe.position.version=He.version}else{if(He.usvg&&!He.data){const je=this.getPatternInFlightId(Fe,Le);if(this.patternsInFlight.has(je))return null;this.patternsInFlight.add(je);const qe=new F.B(Me).scaleSelf(F.q.devicePixelRatio),xt=new Map([[qe.toString(),{image:He,imageVariant:qe}]]);return this._rasterizeImages(Le,xt,((F,Me)=>this.storePatternImage(qe,Le,He,Oe,Me))),null}this.storePattern(Me,Le,He)}return this._updatePatternAtlas(Le,Oe),je.get(Fe).position}getPatternInFlightId(Me,Le){return F.C(Me,Le)}hasPatternsInFlight(){return 0!==this.patternsInFlight.size}storePatternImage(F,Me,Le,Oe,Fe){const je=F.toString(),qe=Fe?Fe.get(je):void 0;qe&&(Le.data=qe,this.storePattern(F.id,Me,Le),this._updatePatternAtlas(Me,Oe),this.patternsInFlight.delete(this.getPatternInFlightId(F.id.toString(),Me)))}storePattern(Me,Le,Oe){const Fe={w:Oe.data.width+2*F.F,h:Oe.data.height+2*F.F,x:0,y:0},je=new F.G(Fe,Oe,F.F);this.patterns.get(Le).set(Me.toString(),{bin:Fe,position:je})}bind(Me,Le){const Oe=Me.gl;let Fe=this.atlasTexture.get(Le);Fe?this.dirty&&(Fe.update(this.atlasImage.get(Le)),this.dirty=!1):(Fe=new F.T(Me,this.atlasImage.get(Le),Oe.RGBA8),this.atlasTexture.set(Le,Fe)),Fe.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE)}_updatePatternAtlas(Me,Le){const Oe=this.patterns.get(Me),Fe=Array.from(Oe.values()).map((({bin:F})=>F)),{w:je,h:qe}=F.H(Fe),He=this.atlasImage.get(Me);He.resize({width:je||1,height:qe||1});const xt=this.images.get(Me);for(const[Me,{bin:Fe,position:je}]of Oe.entries()){let Oe=je.padding;const qe=Fe.x+Oe,Pt=Fe.y+Oe,jt=xt.get(Me).data,Gt=jt.width,bi=jt.height;Oe=Oe>1?Oe-1:Oe,F.r.copy(jt,He,{x:0,y:0},{x:qe,y:Pt},{width:Gt,height:bi},Le),F.r.copy(jt,He,{x:0,y:bi-Oe},{x:qe,y:Pt-Oe},{width:Gt,height:Oe},Le),F.r.copy(jt,He,{x:0,y:0},{x:qe,y:Pt+bi},{width:Gt,height:Oe},Le),F.r.copy(jt,He,{x:Gt-Oe,y:0},{x:qe-Oe,y:Pt},{width:Oe,height:bi},Le),F.r.copy(jt,He,{x:0,y:0},{x:qe+Gt,y:Pt},{width:Oe,height:bi},Le),F.r.copy(jt,He,{x:Gt-Oe,y:bi-Oe},{x:qe-Oe,y:Pt-Oe},{width:Oe,height:Oe},Le),F.r.copy(jt,He,{x:0,y:bi-Oe},{x:qe+Gt,y:Pt-Oe},{width:Oe,height:Oe},Le),F.r.copy(jt,He,{x:0,y:0},{x:qe+Gt,y:Pt+bi},{width:Oe,height:Oe},Le),F.r.copy(jt,He,{x:Gt-Oe,y:0},{x:qe-Oe,y:Pt+bi},{width:Oe,height:Oe},Le)}this.dirty=!0}beginFrame(){for(const F of this.images.keys())this.callbackDispatchedThisFrame.set(F,new Set)}dispatchRenderCallbacks(F,Me){const Le=this.images.get(Me);for(const Oe of F){if(this.callbackDispatchedThisFrame.get(Me).has(Oe.toString()))continue;this.callbackDispatchedThisFrame.get(Me).add(Oe.toString());const F=Le.get(Oe.toString());j(F)&&this.updateImage(Oe,Me,F)}}}function H(Me){const Le=Me.key,Oe=Me.value,Fe=Me.valueSpec||{},je=Me.objectElementValidators||{},qe=Me.style,He=Me.styleSpec;let xt=[];const Pt=F.K(Oe);if("object"!==Pt)return[new F.V(Le,Oe,`object expected, ${Pt} found`)];for(const Me in Oe){const Pt=Me.split(".")[0];let jt;je[Pt]?jt=je[Pt]:Fe[Pt]?jt=_e:je["*"]?jt=je["*"]:Fe["*"]&&(jt=_e),jt?xt=xt.concat(jt({key:(Le?`${Le}.`:Le)+Me,value:Oe[Me],valueSpec:Fe[Pt]||Fe["*"],style:qe,styleSpec:He,object:Oe,objectKey:Me},Oe)):xt.push(new F.J(Le,Oe[Me],`unknown property "${Me}"`))}for(const Me in Fe)je[Me]||Fe[Me].required&&void 0===Fe[Me].default&&void 0===Oe[Me]&&xt.push(new F.V(Le,Oe,`missing required property "${Me}"`));return xt}function Z(Me){const Le=Me.value,Oe=Me.valueSpec,Fe=Me.style,je=Me.styleSpec,qe=Me.key,He=Me.arrayElementValidator||_e;if("array"!==F.K(Le))return[new F.V(qe,Le,`array expected, ${F.K(Le)} found`)];if(Oe.length&&Le.length!==Oe.length)return[new F.V(qe,Le,`array length ${Oe.length} expected, length ${Le.length} found`)];if(Oe["min-length"]&&Le.length<Oe["min-length"])return[new F.V(qe,Le,`array length at least ${Oe["min-length"]} expected, length ${Le.length} found`)];let xt={type:Oe.value,values:Oe.values,minimum:Oe.minimum,maximum:Oe.maximum,function:void 0};je.$version<7&&(xt.function=Oe.function),"object"===F.K(Oe.value)&&(xt=Oe.value);let Pt=[];for(let F=0;F<Le.length;F++)Pt=Pt.concat(He({array:Le,arrayIndex:F,value:Le[F],valueSpec:xt,style:Fe,styleSpec:je,key:`${qe}[${F}]`},!0));return Pt}function W(Me){const Le=Me.key,Oe=Me.value,Fe=Me.valueSpec;let je=F.K(Oe);if("number"===je&&Oe!=Oe&&(je="NaN"),"number"!==je)return[new F.V(Le,Oe,`number expected, ${je} found`)];if("minimum"in Fe){let je=Fe.minimum;if("array"===F.K(Fe.minimum)&&(je=Fe.minimum[Me.arrayIndex]),Oe<je)return[new F.V(Le,Oe,`${Oe} is less than the minimum value ${je}`)]}if("maximum"in Fe){let je=Fe.maximum;if("array"===F.K(Fe.maximum)&&(je=Fe.maximum[Me.arrayIndex]),Oe>je)return[new F.V(Le,Oe,`${Oe} is greater than the maximum value ${je}`)]}return[]}function $(Me){const Le=Me.valueSpec,Oe=F.M(Me.value.type);let Fe,je,qe,He={};const xt="categorical"!==Oe&&void 0===Me.value.property,Pt=!xt,jt="array"===F.K(Me.value.stops)&&"array"===F.K(Me.value.stops[0])&&"object"===F.K(Me.value.stops[0][0]),Gt=H({key:Me.key,value:Me.value,valueSpec:Me.styleSpec.function,style:Me.style,styleSpec:Me.styleSpec,objectElementValidators:{stops:function(Me){if("identity"===Oe)return[new F.V(Me.key,Me.value,'identity function may not have a "stops" property')];let Le=[];const Fe=Me.value;return Le=Le.concat(Z({key:Me.key,value:Fe,valueSpec:Me.valueSpec,style:Me.style,styleSpec:Me.styleSpec,arrayElementValidator:u})),"array"===F.K(Fe)&&0===Fe.length&&Le.push(new F.V(Me.key,Fe,"array must have at least one stop")),Le},default:function(F){return _e({key:F.key,value:F.value,valueSpec:Le,style:F.style,styleSpec:F.styleSpec})}}});return"identity"===Oe&&xt&&Gt.push(new F.V(Me.key,Me.value,'missing required property "property"')),"identity"===Oe||Me.value.stops||Gt.push(new F.V(Me.key,Me.value,'missing required property "stops"')),"exponential"===Oe&&Me.valueSpec.expression&&!F.N(Me.valueSpec)&&Gt.push(new F.V(Me.key,Me.value,"exponential functions not supported")),Me.styleSpec.$version>=8&&(Pt&&!F.O(Me.valueSpec)?Gt.push(new F.V(Me.key,Me.value,"property functions not supported")):xt&&!F.Q(Me.valueSpec)&&Gt.push(new F.V(Me.key,Me.value,"zoom functions not supported"))),"categorical"!==Oe&&!jt||void 0!==Me.value.property||Gt.push(new F.V(Me.key,Me.value,'"property" property is required')),Gt;function u(Me){let Oe=[];const Fe=Me.value,xt=Me.key;if("array"!==F.K(Fe))return[new F.V(xt,Fe,`array expected, ${F.K(Fe)} found`)];if(2!==Fe.length)return[new F.V(xt,Fe,`array length 2 expected, length ${Fe.length} found`)];if(jt){if("object"!==F.K(Fe[0]))return[new F.V(xt,Fe,`object expected, ${F.K(Fe[0])} found`)];if(void 0===Fe[0].zoom)return[new F.V(xt,Fe,"object stop key must have zoom")];if(void 0===Fe[0].value)return[new F.V(xt,Fe,"object stop key must have value")];const Le=F.M(Fe[0].zoom);if("number"!=typeof Le)return[new F.V(xt,Fe[0].zoom,"stop zoom values must be numbers")];if(qe&&qe>Le)return[new F.V(xt,Fe[0].zoom,"stop zoom values must appear in ascending order")];Le!==qe&&(qe=Le,je=void 0,He={}),Oe=Oe.concat(H({key:`${xt}[0]`,value:Fe[0],valueSpec:{zoom:{}},style:Me.style,styleSpec:Me.styleSpec,objectElementValidators:{zoom:W,value:_}}))}else Oe=Oe.concat(_({key:`${xt}[0]`,value:Fe[0],valueSpec:{},style:Me.style,styleSpec:Me.styleSpec},Fe));return F.S(F.U(Fe[1]))?Oe.concat([new F.V(`${xt}[1]`,Fe[1],"expressions are not allowed in function stops.")]):Oe.concat(_e({key:`${xt}[1]`,value:Fe[1],valueSpec:Le,style:Me.style,styleSpec:Me.styleSpec}))}function _(Me,qe){const xt=F.K(Me.value),Pt=F.M(Me.value),jt=null!==Me.value?Me.value:qe;if(Fe){if(xt!==Fe)return[new F.V(Me.key,jt,`${xt} stop domain type must match previous stop domain type ${Fe}`)]}else Fe=xt;if("number"!==xt&&"string"!==xt&&"boolean"!==xt&&"number"!=typeof Pt&&"string"!=typeof Pt&&"boolean"!=typeof Pt)return[new F.V(Me.key,jt,"stop domain value must be a number, string, or boolean")];if("number"!==xt&&"categorical"!==Oe){let Fe=`number expected, ${xt} found`;return F.O(Le)&&void 0===Oe&&(Fe+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new F.V(Me.key,jt,Fe)]}return"categorical"!==Oe||"number"!==xt||"number"==typeof Pt&&isFinite(Pt)&&Math.floor(Pt)===Pt?"categorical"!==Oe&&"number"===xt&&"number"==typeof Pt&&"number"==typeof je&&void 0!==je&&Pt<je?[new F.V(Me.key,jt,"stop domain values must appear in ascending order")]:(je=Pt,"categorical"===Oe&&Pt in He?[new F.V(Me.key,jt,"stop domain values must be unique")]:(He[Pt]=!0,[])):[new F.V(Me.key,jt,`integer expected, found ${String(Pt)}`)]}}function X(Me){const Le=("property"===Me.expressionContext?F.W:F.X)(F.U(Me.value),Me.valueSpec);if("error"===Le.result)return Le.value.map((Le=>new F.V(`${Me.key}${Le.key}`,Me.value,Le.message)));const Oe=Le.value.expression||Le.value._styleExpression.expression;if("property"===Me.expressionContext&&"text-font"===Me.propertyKey&&!Oe.outputDefined())return[new F.V(Me.key,Me.value,`Invalid data expression for "${Me.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===Me.expressionContext&&"layout"===Me.propertyType&&!F.Y(Oe))return[new F.V(Me.key,Me.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===Me.expressionContext)return K(Oe,Me);if(Me.expressionContext&&0===Me.expressionContext.indexOf("cluster")){if(!F.Z(Oe,["zoom","feature-state"]))return[new F.V(Me.key,Me.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===Me.expressionContext&&!F._(Oe))return[new F.V(Me.key,Me.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function K(Me,Le){const Oe=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(Le.valueSpec&&Le.valueSpec.expression)for(const F of Le.valueSpec.expression.parameters)Oe.delete(F);if(0===Oe.size)return[];const Fe=[];return Me instanceof F.$&&Oe.has(Me.name)?[new F.V(Le.key,Le.value,`["${Me.name}"] expression is not supported in a filter for a ${Le.object.type} layer with id: ${Le.object.id}`)]:(Me.eachChild((F=>{Fe.push(...K(F,Le))})),Fe)}function Y(Me){const Le=Me.key,Oe=Me.value,Fe=Me.valueSpec,je=[];return Array.isArray(Fe.values)?-1===Fe.values.indexOf(F.M(Oe))&&je.push(new F.V(Le,Oe,`expected one of [${Fe.values.join(", ")}], ${JSON.stringify(Oe)} found`)):-1===Object.keys(Fe.values).indexOf(F.M(Oe))&&je.push(new F.V(Le,Oe,`expected one of [${Object.keys(Fe.values).join(", ")}], ${JSON.stringify(Oe)} found`)),je}function J(Me){return F.a1(F.U(Me.value))?X(F.L({},Me,{expressionContext:"filter",valueSpec:Me.styleSpec[`filter_${Me.layerType||"fill"}`]})):Q(Me)}function Q(Me){const Le=Me.value,Oe=Me.key;if("array"!==F.K(Le))return[new F.V(Oe,Le,`array expected, ${F.K(Le)} found`)];const Fe=Me.styleSpec;let je,qe=[];if(Le.length<1)return[new F.V(Oe,Le,"filter array must have at least 1 element")];switch(qe=qe.concat(Y({key:`${Oe}[0]`,value:Le[0],valueSpec:Fe.filter_operator,style:Me.style,styleSpec:Me.styleSpec})),F.M(Le[0])){case"<":case"<=":case">":case">=":Le.length>=2&&"$type"===F.M(Le[1])&&qe.push(new F.V(Oe,Le,`"$type" cannot be use with operator "${Le[0]}"`));case"==":case"!=":3!==Le.length&&qe.push(new F.V(Oe,Le,`filter array for operator "${Le[0]}" must have 3 elements`));case"in":case"!in":Le.length>=2&&(je=F.K(Le[1]),"string"!==je&&qe.push(new F.V(`${Oe}[1]`,Le[1],`string expected, ${je} found`)));for(let He=2;He<Le.length;He++)je=F.K(Le[He]),"$type"===F.M(Le[1])?qe=qe.concat(Y({key:`${Oe}[${He}]`,value:Le[He],valueSpec:Fe.geometry_type,style:Me.style,styleSpec:Me.styleSpec})):"string"!==je&&"number"!==je&&"boolean"!==je&&qe.push(new F.V(`${Oe}[${He}]`,Le[He],`string, number, or boolean expected, ${je} found`));break;case"any":case"all":case"none":for(let F=1;F<Le.length;F++)qe=qe.concat(Q({key:`${Oe}[${F}]`,value:Le[F],style:Me.style,styleSpec:Me.styleSpec}));break;case"has":case"!has":je=F.K(Le[1]),2!==Le.length?qe.push(new F.V(Oe,Le,`filter array for "${Le[0]}" operator must have 2 elements`)):"string"!==je&&qe.push(new F.V(`${Oe}[1]`,Le[1],`string expected, ${je} found`))}return qe}function ee(Me,Le){const Oe=Me.key,Fe=Me.style,je=Me.layer,qe=Me.styleSpec,He=Me.value,xt=Me.objectKey,Pt=qe[`${Le}_${Me.layerType}`];if(!Pt)return[];const jt=xt.match(/^(.*)-use-theme$/);if("paint"===Le&&jt&&Pt[jt[1]])return F.S(He)?[].concat(_e({key:Me.key,value:He,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:Fe,styleSpec:qe,expressionContext:"property",propertyType:Le,propertyKey:xt})):_e({key:Oe,value:He,valueSpec:{type:"string"},style:Fe,styleSpec:qe});const Gt=xt.match(/^(.*)-transition$/);if("paint"===Le&&Gt&&Pt[Gt[1]]&&Pt[Gt[1]].transition)return _e({key:Oe,value:He,valueSpec:qe.transition,style:Fe,styleSpec:qe});const bi=Me.valueSpec||Pt[xt];if(!bi)return[new F.J(Oe,He,`unknown property "${xt}"`)];let wi;if("string"===F.K(He)&&F.O(bi)&&!bi.tokens&&(wi=/^{([^}]+)}$/.exec(He))){const Me=`\`{ "type": "identity", "property": ${wi?JSON.stringify(wi[1]):'"_"'} }\``;return[new F.V(Oe,He,`"${xt}" does not support interpolation syntax\nUse an identity property function instead: ${Me}.`)]}const qr=[];if("symbol"===Me.layerType)"text-field"!==xt||!Fe||Fe.glyphs||Fe.imports||qr.push(new F.V(Oe,He,'use of "text-field" requires a style "glyphs" property')),"text-font"===xt&&F.a2(F.U(He))&&"identity"===F.M(He.type)&&qr.push(new F.V(Oe,He,'"text-font" does not support identity functions'));else if("model"===Me.layerType&&"paint"===Le&&je&&je.layout&&je.layout.hasOwnProperty("model-id")&&F.O(bi)&&(F.a3(bi)||F.Q(bi))){const Me=F.W(F.U(He),bi),Le=Me.value.expression||Me.value._styleExpression.expression;Le&&!F.Z(Le,["measure-light"])&&("model-emissive-strength"===xt&&F._(Le)&&F.Y(Le)||qr.push(new F.V(Oe,He,`${xt} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return qr.concat(_e({key:Me.key,value:He,valueSpec:bi,style:Fe,styleSpec:qe,expressionContext:"property",propertyType:Le,propertyKey:xt}))}function te(F){return ee(F,"paint")}function ie(F){return ee(F,"layout")}function oe(Me){let Le=[];const Oe=Me.value,Fe=Me.key,je=Me.style,qe=Me.styleSpec;Oe.type||Oe.ref||Le.push(new F.V(Fe,Oe,'either "type" or "ref" is required'));let He=F.M(Oe.type);const xt=F.M(Oe.ref);if(Oe.id){const qe=F.M(Oe.id);for(let He=0;He<Me.arrayIndex;He++){const Me=je.layers[He];F.M(Me.id)===qe&&Le.push(new F.V(Fe,Oe.id,`duplicate layer id "${Oe.id}", previously used at line ${Me.id.__line__}`))}}if("ref"in Oe){let Me;["type","source","source-layer","filter","layout"].forEach((Me=>{Me in Oe&&Le.push(new F.V(Fe,Oe[Me],`"${Me}" is prohibited for ref layers`))})),je.layers.forEach((Le=>{F.M(Le.id)===xt&&(Me=Le)})),Me?Me.ref?Le.push(new F.V(Fe,Oe.ref,"ref cannot reference another ref layer")):He=F.M(Me.type):"string"==typeof xt&&Le.push(new F.V(Fe,Oe.ref,`ref layer "${xt}" not found`))}else if("background"!==He&&"sky"!==He&&"slot"!==He)if(Oe.source){const Me=je.sources&&je.sources[Oe.source],qe=Me&&F.M(Me.type);Me?"vector"===qe&&"raster"===He?Le.push(new F.V(Fe,Oe.source,`layer "${Oe.id}" requires a raster source`)):"raster"===qe&&"raster"!==He?Le.push(new F.V(Fe,Oe.source,`layer "${Oe.id}" requires a vector source`)):"vector"!==qe||Oe["source-layer"]?"raster-dem"===qe&&"hillshade"!==He?Le.push(new F.V(Fe,Oe.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==qe||["raster","raster-particle"].includes(He)?"line"!==He||!Oe.paint||!Oe.paint["line-gradient"]&&!Oe.paint["line-trim-offset"]||"geojson"===qe&&Me.lineMetrics?"raster-particle"===He&&"raster-array"!==qe&&Le.push(new F.V(Fe,Oe.source,`layer "${Oe.id}" requires a 'raster-array' source.`)):Le.push(new F.V(Fe,Oe,`layer "${Oe.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):Le.push(new F.V(Fe,Oe.source,"raster-array source can only be used with layer type 'raster'.")):Le.push(new F.V(Fe,Oe,`layer "${Oe.id}" must specify a "source-layer"`)):Le.push(new F.V(Fe,Oe.source,`source "${Oe.source}" not found`))}else Le.push(new F.V(Fe,Oe,'missing required property "source"'));return Le=Le.concat(H({key:Fe,value:Oe,valueSpec:qe.layer,style:Me.style,styleSpec:Me.styleSpec,objectElementValidators:{"*":()=>[],type:()=>_e({key:`${Fe}.type`,value:Oe.type,valueSpec:qe.layer.type,style:Me.style,styleSpec:Me.styleSpec,object:Oe,objectKey:"type"}),filter:Me=>J(F.L({layerType:He},Me)),layout:Me=>H({layer:Oe,key:Me.key,value:Me.value,valueSpec:{},style:Me.style,styleSpec:Me.styleSpec,objectElementValidators:{"*":Me=>ie(F.L({layerType:He},Me))}}),paint:Me=>H({layer:Oe,key:Me.key,value:Me.value,valueSpec:{},style:Me.style,styleSpec:Me.styleSpec,objectElementValidators:{"*":Me=>te(F.L({layerType:He,layer:Oe},Me))}})}})),Le}function se(Me){const Le=Me.value,Oe=Me.key,Fe=F.K(Le);return"string"!==Fe?[new F.V(Oe,Le,`string expected, ${Fe} found`)]:[]}const nl={promoteId:function t({key:Me,value:Le}){if("string"===F.K(Le))return se({key:Me,value:Le});if(Array.isArray(Le)){const Oe=[],Fe=F.U(Le),je=F.X(Fe);return"error"===je.result&&je.value.forEach((Le=>{Oe.push(new F.V(`${Me}${Le.key}`,null,`${Le.message}`))})),F.Z(je.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||Oe.push(new F.V(`${Me}`,null,"promoteId expression should be only feature dependent")),Oe}{const F=[];for(const Oe in Le)F.push(...t({key:`${Me}.${Oe}`,value:Le[Oe]}));return F}}};function ne(Me){const Le=Me.value,Oe=Me.key,Fe=Me.styleSpec,je=Me.style;if(!Le.type)return[new F.V(Oe,Le,'"type" is required')];const qe=F.M(Le.type);let He=[];switch(["vector","raster","raster-dem","raster-array"].includes(qe)&&(Le.url||Le.tiles||He.push(new F.J(Oe,Le,'Either "url" or "tiles" is required.'))),qe){case"vector":case"raster":case"raster-dem":case"raster-array":return He=He.concat(H({key:Oe,value:Le,valueSpec:Fe[`source_${qe.replace("-","_")}`],style:Me.style,styleSpec:Fe,objectElementValidators:nl})),He;case"geojson":if(He=H({key:Oe,value:Le,valueSpec:Fe.source_geojson,style:je,styleSpec:Fe,objectElementValidators:nl}),Le.cluster)for(const F in Le.clusterProperties){const[Me,Fe]=Le.clusterProperties[F],je="string"==typeof Me?[Me,["accumulated"],["get",F]]:Me;He.push(...X({key:`${Oe}.${F}.map`,value:Fe,expressionContext:"cluster-map"})),He.push(...X({key:`${Oe}.${F}.reduce`,value:je,expressionContext:"cluster-reduce"}))}return He;case"video":return H({key:Oe,value:Le,valueSpec:Fe.source_video,style:je,styleSpec:Fe});case"image":return H({key:Oe,value:Le,valueSpec:Fe.source_image,style:je,styleSpec:Fe});case"canvas":return[new F.V(Oe,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Y({key:`${Oe}.type`,value:Le.type,valueSpec:{values:ae(Fe)},style:je,styleSpec:Fe})}}function ae(F){return F.source.reduce(((Me,Le)=>{const Oe=F[Le];return"enum"===Oe.type.type&&(Me=Me.concat(Object.keys(Oe.type.values))),Me}),[])}function le(Me){const Le=Me.value,Oe=Me.styleSpec,Fe=Oe.light,je=Me.style;let qe=[];const He=F.K(Le);if(void 0===Le)return qe;if("object"!==He)return qe=qe.concat([new F.V("light",Le,`object expected, ${He} found`)]),qe;for(const Me in Le){const He=Me.match(/^(.*)-transition$/),xt=Me.match(/^(.*)-use-theme$/);qe=qe.concat(xt&&Fe[xt[1]]?_e({key:Me,value:Le[Me],valueSpec:{type:"string"},style:je,styleSpec:Oe}):He&&Fe[He[1]]&&Fe[He[1]].transition?_e({key:Me,value:Le[Me],valueSpec:Oe.transition,style:je,styleSpec:Oe}):Fe[Me]?_e({key:Me,value:Le[Me],valueSpec:Fe[Me],style:je,styleSpec:Oe}):[new F.V(Me,Le[Me],`unknown property "${Me}"`)])}return qe}function ce(Me){const Le=Me.value;let Oe=[];if(!Le)return Oe;const Fe=F.K(Le);if("object"!==Fe)return Oe=Oe.concat([new F.V("light-3d",Le,`object expected, ${Fe} found`)]),Oe;const je=Me.styleSpec,qe=je["light-3d"],He=Me.key,xt=Me.style,Pt=Me.style.lights;for(const Me of["type","id"])if(!(Me in Le))return Oe=Oe.concat([new F.V("light-3d",Le,`missing property ${Me} on light`)]),Oe;if(Le.type&&Pt)for(let Fe=0;Fe<Me.arrayIndex;Fe++){const Me=F.M(Le.type),je=Pt[Fe];F.M(je.type)===Me&&Oe.push(new F.V(He,Le.id,`duplicate light type "${Le.type}", previously defined at line ${je.id.__line__}`))}const jt=`properties_light_${Le.type}`;if(!(jt in je))return Oe=Oe.concat([new F.V("light-3d",Le,`Invalid light type ${Le.type}`)]),Oe;const Gt=je[jt];for(const Fe in Le)if("properties"===Fe){const qe=Le[Fe],He=F.K(qe);if("object"!==He)return Oe=Oe.concat([new F.V("properties",qe,`object expected, ${He} found`)]),Oe;for(const Le in qe)Oe=Oe.concat(Gt[Le]?_e({key:Le,value:qe[Le],valueSpec:Gt[Le],style:xt,styleSpec:je}):[new F.J(Me.key,qe[Le],`unknown property "${Le}"`)])}else{const Me=Fe.match(/^(.*)-transition$/),He=Fe.match(/^(.*)-use-theme$/);Oe=Oe.concat(He&&qe[He[1]]?_e({key:Fe,value:Le[Fe],valueSpec:{type:"string"},style:xt,styleSpec:je}):Me&&qe[Me[1]]&&qe[Me[1]].transition?_e({key:Fe,value:Le[Fe],valueSpec:je.transition,style:xt,styleSpec:je}):qe[Fe]?_e({key:Fe,value:Le[Fe],valueSpec:qe[Fe],style:xt,styleSpec:je}):[new F.J(Fe,Le[Fe],`unknown property "${Fe}"`)])}return Oe}function he(Me){const Le=Me.value,Oe=Me.key,Fe=Me.style,je=Me.styleSpec,qe=je.terrain;let He=[];const xt=F.K(Le);if(void 0===Le)return He;if("null"===xt)return He;if("object"!==xt)return He=He.concat([new F.V("terrain",Le,`object expected, ${xt} found`)]),He;for(const Me in Le){const Oe=Me.match(/^(.*)-transition$/),xt=Me.match(/^(.*)-use-theme$/);He=He.concat(xt&&qe[xt[1]]?_e({key:Me,value:Le[Me],valueSpec:{type:"string"},style:Fe,styleSpec:je}):Oe&&qe[Oe[1]]&&qe[Oe[1]].transition?_e({key:Me,value:Le[Me],valueSpec:je.transition,style:Fe,styleSpec:je}):qe[Me]?_e({key:Me,value:Le[Me],valueSpec:qe[Me],style:Fe,styleSpec:je}):[new F.J(Me,Le[Me],`unknown property "${Me}"`)])}if(Le.source){const Me=Fe.sources&&Fe.sources[Le.source],je=Me&&F.M(Me.type);Me?"raster-dem"!==je&&He.push(new F.V(Oe,Le.source,`terrain cannot be used with a source of type ${String(je)}, it only be used with a "raster-dem" source type`)):He.push(new F.V(Oe,Le.source,`source "${Le.source}" not found`))}else He.push(new F.V(Oe,Le,'terrain is missing required property "source"'));return He}function de(Me){const Le=Me.value,Oe=Me.style,Fe=Me.styleSpec,je=Fe.fog;let qe=[];const He=F.K(Le);if(void 0===Le)return qe;if("object"!==He)return qe=qe.concat([new F.V("fog",Le,`object expected, ${He} found`)]),qe;for(const Me in Le){const He=Me.match(/^(.*)-transition$/),xt=Me.match(/^(.*)-use-theme$/);qe=qe.concat(xt&&je[xt[1]]?_e({key:Me,value:Le[Me],valueSpec:{type:"string"},style:Oe,styleSpec:Fe}):He&&je[He[1]]&&je[He[1]].transition?_e({key:Me,value:Le[Me],valueSpec:Fe.transition,style:Oe,styleSpec:Fe}):je[Me]?_e({key:Me,value:Le[Me],valueSpec:je[Me],style:Oe,styleSpec:Fe}):[new F.J(Me,Le[Me],`unknown property "${Me}"`)])}return qe}const hl={"*":()=>[],array:Z,boolean:function(Me){const Le=Me.value,Oe=Me.key,Fe=F.K(Le);return"boolean"!==Fe?[new F.V(Oe,Le,`boolean expected, ${Fe} found`)]:[]},number:W,color:function(Me){const Le=Me.key,Oe=Me.value,Fe=F.K(Oe);return"string"!==Fe?[new F.V(Le,Oe,`color expected, ${Fe} found`)]:null===F.a0.parseCSSColor(Oe)?[new F.V(Le,Oe,`color expected, "${Oe}" found`)]:[]},enum:Y,filter:J,function:$,layer:oe,object:H,source:ne,model:F.a4,light:le,"light-3d":ce,terrain:he,fog:de,string:se,formatted:function(F){return 0===se(F).length?[]:X(F)},resolvedImage:function(F){return 0===se(F).length?[]:X(F)},projection:function(Me){const Le=Me.value,Oe=Me.styleSpec,Fe=Oe.projection,je=Me.style;let qe=[];const He=F.K(Le);if("object"===He)for(const F in Le)qe=qe.concat(_e({key:F,value:Le[F],valueSpec:Fe[F],style:je,styleSpec:Oe}));else"string"!==He&&(qe=qe.concat([new F.V("projection",Le,`object or string expected, ${He} found`)]));return qe},import:function(Me){const{value:Le,styleSpec:Oe}=Me,{data:Fe,...je}=Le;Object.defineProperty(je,"__line__",{value:Le.__line__,enumerable:!1});let qe=H(F.L({},Me,{value:je,valueSpec:Oe.import}));return""===F.M(je.id)&&qe.push(new F.V(`${Me.key}.id`,je,"import id can't be an empty string")),Fe&&(qe=qe.concat(fe(Fe,Oe,{key:`${Me.key}.data`}))),qe},iconset:function(Me){const Le=Me.value,Oe=Me.key,Fe=Me.styleSpec,je=Me.style;if(!Le.type)return[new F.V(Oe,Le,'"type" is required')];const qe=F.M(Le.type);let He=[];if(He=He.concat(H({key:Oe,value:Le,valueSpec:Fe[`iconset_${qe}`],style:je,styleSpec:Fe})),"source"===qe&&Le.source){const Me=je.sources&&je.sources[Le.source],Fe=Me&&F.M(Me.type);Me?"raster-array"!==Fe&&He.push(new F.V(Oe,Le.source,`iconset cannot be used with a source of type ${String(Fe)}, it only be used with a "raster-array" source type`)):He.push(new F.V(Oe,Le.source,`source "${Le.source}" not found`))}return He}};function _e(Me,Le=!1){const Oe=Me.value,Fe=Me.valueSpec,je=Me.styleSpec;if(Fe.expression&&F.a2(F.M(Oe)))return $(Me);if(Fe.expression&&F.S(F.U(Oe)))return X(Me);if(Fe.type&&hl[Fe.type]){const Oe=hl[Fe.type](Me);return!0===Le&&Oe.length>0&&"array"===F.K(Me.value)?X(Me):Oe}return H(F.L({},Me,{valueSpec:Fe.type?je[Fe.type]:Fe}))}function pe(Me){const Le=Me.value,Oe=Me.key,Fe=se(Me);return Fe.length||(-1===Le.indexOf("{fontstack}")&&Fe.push(new F.V(Oe,Le,'"glyphs" url must include a "{fontstack}" token')),-1===Le.indexOf("{range}")&&Fe.push(new F.V(Oe,Le,'"glyphs" url must include a "{range}" token'))),Fe}function fe(Me,Le=F.a5,Oe={}){return _e({key:Oe.key||"",value:Me,valueSpec:Le.$root,styleSpec:Le,style:Me,objectElementValidators:{glyphs:pe,"*":()=>[]}})}function me(Me,Le=F.a5){return De(fe(Me,Le))}const ge=F=>De(ne(F)),ve=F=>De(le(F)),ye=F=>De(ce(F)),xe=F=>De(he(F)),be=F=>De(de(F)),we=Me=>De(function(Me){const Le=Me.value,Oe=Me.style,Fe=Me.styleSpec,je=Fe.snow;let qe=[];const He=F.K(Le);if(void 0===Le)return qe;if("object"!==He)return qe=qe.concat([new F.V("snow",Le,`object expected, ${He} found`)]),qe;for(const Me in Le){const He=Me.match(/^(.*)-transition$/);qe=qe.concat(He&&je[He[1]]&&je[He[1]].transition?_e({key:Me,value:Le[Me],valueSpec:Fe.transition,style:Oe,styleSpec:Fe}):je[Me]?_e({key:Me,value:Le[Me],valueSpec:je[Me],style:Oe,styleSpec:Fe}):[new F.J(Me,Le[Me],`unknown property "${Me}"`)])}return qe}(Me)),Te=Me=>De(function(Me){const Le=Me.value,Oe=Me.style,Fe=Me.styleSpec,je=Fe.rain;let qe=[];const He=F.K(Le);if(void 0===Le)return qe;if("object"!==He)return qe=qe.concat([new F.V("rain",Le,`object expected, ${He} found`)]),qe;for(const Me in Le){const He=Me.match(/^(.*)-transition$/);qe=qe.concat(He&&je[He[1]]&&je[He[1]].transition?_e({key:Me,value:Le[Me],valueSpec:Fe.transition,style:Oe,styleSpec:Fe}):je[Me]?_e({key:Me,value:Le[Me],valueSpec:je[Me],style:Oe,styleSpec:Fe}):[new F.J(Me,Le[Me],`unknown property "${Me}"`)])}return qe}(Me)),Ee=F=>De(oe(F)),Se=F=>De(J(F)),Ce=F=>De(te(F)),Ie=F=>De(ie(F)),Re=Me=>De(F.a4(Me));function De(F){return F.slice().sort(((F,Me)=>F.line&&Me.line?F.line-Me.line:0))}function Ae(Me,Le){let Oe=!1;if(Le&&Le.length)for(const Fe of Le)Fe instanceof F.J?F.w(Fe.message):(Me.fire(new F.z(new Error(Fe.message))),Oe=!0);return Oe}let pl;class Pe extends F.E{constructor(Me,Le="flat"){super(),this._transitionable=new F.a6(pl||(pl=new F.a7({anchor:new F.a8(F.a5.light.anchor),position:new F.a9(F.a5.light.position),color:new F.a8(F.a5.light.color),intensity:new F.a8(F.a5.light.intensity)}))),this.setLight(Me,Le),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(F,Me,Le={}){this._validate(ve,F,Le)||(this._transitionable.setTransitionOrValue(F),this.id=Me)}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Me,Le,Oe){return(!Oe||!1!==Oe.validate)&&Ae(this,Me.call(me,F.l({value:Le,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}}let bl=class extends F.E{constructor(Me,Le,Oe,Fe){super(),this.scope=Oe,this._transitionable=new F.a6(new F.a7({source:new F.a8(F.a5.terrain.source),exaggeration:new F.a8(F.a5.terrain.exaggeration)}),Oe,Fe),this._transitionable.setTransitionOrValue(Me,Fe),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=Le}get(){return this._transitionable.serialize()}set(F,Me){this._transitionable.setTransitionOrValue(F,Me)}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}getExaggeration(Me){return this._transitioning.possiblyEvaluate(new F.aa(Me)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const Me=this._transitionable._values.exaggeration;if(!Me)return null;const Le=Me.value.expression;if(!Le)return null;let Oe=-1,Fe=-1,je=1;for(const Me of Le.zoomStops)je=Le.evaluate(new F.aa(Me)),je>.01?(Oe=Me,Fe=-1):Fe=Me;return je<.01&&Oe>0&&Fe>Oe?[Oe,Fe]:null}isZoomDependent(){const Me=this._transitionable._values.exaggeration;return null!=Me&&null!=Me.value&&null!=Me.value.expression&&Me.value.expression instanceof F.ab}};const Tl=45,kl=65,ec=.05;function ke(Me,Le,Oe,Fe){const je=F.ae(Tl,kl,Oe),[qe,He]=Be(Me,Fe);let xt=1-Math.min(1,Math.exp((Le-qe)/(He-qe)*-6));return xt*=xt*xt,xt=Math.min(1,1.00747*xt),xt*je*Me.alpha}function Be(F,Me){const Le=.5/Math.tan(.5*Me);return[F.range[0]+Le,F.range[1]+Le]}function Ne(Me,Le,Oe,Fe,je){const qe=F.ad.vec3.transformMat4([],[Le,Oe,Fe],je.mercatorFogMatrix);return ke(Me,F.ad.vec3.length(qe),je.pitch,je._fov)}function Ue(Me,Le,Oe,Fe,je,qe,He){const xt=[[Oe,Fe,0],[je,Fe,0],[je,qe,0],[Oe,qe,0]];let Pt=Number.MAX_VALUE,jt=-Number.MAX_VALUE;for(const Me of xt){const Oe=F.ad.vec3.transformMat4([],Me,Le),Fe=F.ad.vec3.length(Oe);Pt=Math.min(Pt,Fe),jt=Math.max(jt,Fe)}return[ke(Me,Pt,He.pitch,He._fov),ke(Me,jt,He.pitch,He._fov)]}class Ve extends F.E{constructor(Me,Le,Oe,Fe){super();const je=new F.a7({range:new F.a8(F.a5.fog.range),color:new F.a8(F.a5.fog.color),"color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new F.a8(F.a5.fog["high-color"]),"high-color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new F.a8(F.a5.fog["space-color"]),"space-color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new F.a8(F.a5.fog["horizon-blend"]),"star-intensity":new F.a8(F.a5.fog["star-intensity"]),"vertical-range":new F.a8(F.a5.fog["vertical-range"])});this._transitionable=new F.a6(je,Oe,new Map(Fe)),this.set(Me,Fe),this._transitioning=this._transitionable.untransitioned(),this._transform=Le,this.properties=new F.af(je),this.scope=Oe}get state(){const Me=this._transform,Le="globe"===Me.projection.name,Oe=F.ag(Me.zoom),Fe=this.properties.get("range"),je=[.5,3];return{range:Le?[F.ah(je[0],Fe[0],Oe),F.ah(je[1],Fe[1],Oe)]:Fe,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(Me,Le,Oe={}){if(this._validate(be,Me,Oe))return;const Fe=F.l({},Me);for(const Me of Object.keys(F.a5.fog))void 0===Fe[Me]&&(Fe[Me]=F.a5.fog[Me].default);this._options=Fe,this._transitionable.setTransitionOrValue(this._options,Le)}getOpacity(Me){if(!this._transform.projection.supportsFog)return 0;const Le=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:F.ae(Tl,kl,Me))*Le.a}getOpacityAtLatLng(Me,Le){return this._transform.projection.supportsFog?function(Me,Le,Oe){const Fe=F.ac.fromLngLat(Le),je=Oe.elevation?Oe.elevation.getAtPointOrZero(Fe):0;return Ne(Me,Fe.x,Fe.y,je,Oe)}(this.state,Me,Le):0}getOpacityForTile(Me){if(!this._transform.projection.supportsFog)return[1,1];const Le=this._transform.calculateFogTileMatrix(Me.toUnwrapped());return Ue(this.state,Le,0,0,F.ai,F.ai,this._transform)}getOpacityForBounds(F,Me,Le,Oe,Fe){return this._transform.projection.supportsFog?Ue(this.state,F,Me,Le,Oe,Fe,this._transform):[1,1]}getFovAdjustedRange(F){return this._transform.projection.supportsFog?Be(this.state,F):[0,1]}isVisibleOnFrustum(Me){if(!this._transform.projection.supportsFog)return!1;const Le=[4,5,6,7];for(const Oe of Le){const Le=Me.points[Oe];let Fe;if(Le[2]>=0)Fe=Le;else{const je=Me.points[Oe-4];Fe=F.aj(je,Le,je[2]/(je[2]-Le[2]))}if(Ne(this.state,Fe[0],Fe[1],0,this._transform)>=ec)return!0}return!1}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Me,Le,Oe){return(!Oe||!1!==Oe.validate)&&Ae(this,Me.call(me,F.l({value:Le,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}}let tc,ic,oc,sc,ac=class extends F.E{constructor(Me,Le,Oe,Fe){super();const je=tc||(tc=new F.a7({density:new F.a8(F.a5.snow.density),intensity:new F.a8(F.a5.snow.intensity),color:new F.a8(F.a5.snow.color),opacity:new F.a8(F.a5.snow.opacity),vignette:new F.a8(F.a5.snow.vignette),"vignette-color":new F.a8(F.a5.snow["vignette-color"]),"center-thinning":new F.a8(F.a5.snow["center-thinning"]),direction:new F.a8(F.a5.snow.direction),"flake-size":new F.a8(F.a5.snow["flake-size"])}));this._transitionable=new F.a6(je,Oe,new Map(Fe)),this.set(Me,Fe),this._transitioning=this._transitionable.untransitioned(),this.properties=new F.af(je),this.scope=Oe}get state(){const Me=this.properties.get("opacity"),Le=this.properties.get("color"),Oe=this.properties.get("direction"),Fe=F.ak(Oe[0]),je=-Math.max(F.ak(Oe[1]),.01),qe=[Math.cos(Fe)*Math.cos(je),Math.sin(Fe)*Math.cos(je),Math.sin(je)],He=this.properties.get("vignette"),xt=this.properties.get("vignette-color");return xt.a=He,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new F.al(Le.r,Le.g,Le.b,Le.a*Me),direction:qe,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:xt}}get(){return this._transitionable.serialize()}set(Me,Le,Oe={}){if(this._validate(we,Me,Oe))return;const Fe=F.l({},Me);for(const Me of Object.keys(F.a5.snow))void 0===Fe[Me]&&(Fe[Me]=F.a5.snow[Me].default);this._options=Fe,this._transitionable.setTransitionOrValue(this._options,Le)}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Me,Le,Oe){return(!Oe||!1!==Oe.validate)&&Ae(this,Me.call(me,F.l({value:Le,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}},mc=class extends F.E{constructor(Me,Le,Oe,Fe){super();const je=ic||(ic=new F.a7({density:new F.a8(F.a5.rain.density),intensity:new F.a8(F.a5.rain.intensity),color:new F.a8(F.a5.rain.color),opacity:new F.a8(F.a5.rain.opacity),vignette:new F.a8(F.a5.rain.vignette),"vignette-color":new F.a8(F.a5.rain["vignette-color"]),"center-thinning":new F.a8(F.a5.rain["center-thinning"]),direction:new F.a8(F.a5.rain.direction),"droplet-size":new F.a8(F.a5.rain["droplet-size"]),"distortion-strength":new F.a8(F.a5.rain["distortion-strength"])}));this._transitionable=new F.a6(je,Oe,new Map(Fe)),this.set(Me,Fe),this._transitioning=this._transitionable.untransitioned(),this.properties=new F.af(je),this.scope=Oe}get state(){const Me=this.properties.get("opacity"),Le=this.properties.get("color"),Oe=this.properties.get("direction"),Fe=F.ak(Oe[0]),je=-Math.max(F.ak(Oe[1]),.01),qe=[Math.cos(Fe)*Math.cos(je),Math.sin(Fe)*Math.cos(je),Math.sin(je)],He=this.properties.get("vignette-color");return He.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new F.al(Le.r,Le.g,Le.b,Le.a*Me),direction:qe,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:He}}get(){return this._transitionable.serialize()}set(Me,Le,Oe={}){if(this._validate(Te,Me,Oe))return;const Fe=F.l({},Me);for(const Me of Object.keys(F.a5.rain))void 0===Fe[Me]&&(Fe[Me]=F.a5.rain[Me].default);this._options=Fe,this._transitionable.setTransitionOrValue(this._options,Le)}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Me,Le,Oe){return(!Oe||!1!==Oe.validate)&&Ae(this,Me.call(me,F.l({value:Le,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}};class $e extends F.E{constructor(Me,Le,Oe,Fe){super(),this.scope=Oe,this._options=Me,this.properties=new F.af(Le),this._transitionable=new F.a6(Le,Oe,new Map(Fe)),this._transitionable.setTransitionOrValue(Me.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(F){this._transitionable.setTransitionOrValue(this._options.properties,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(F,Me){this._options=F,this._transitionable.setTransitionOrValue(F.properties,Me)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}class Xe{constructor(F,Me,Le,Oe){this.screenBounds=F,this.cameraPoint=Me,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=Le,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,Oe)}static createFromScreenPoints(Me,Le){let Oe,Fe;if(Me instanceof F.P||"number"==typeof Me[0]){const je=F.P.convert(Me);Oe=[je],Fe=Le.isPointAboveHorizon(je)}else{const je=F.P.convert(Me[0]),qe=F.P.convert(Me[1]);Oe=[je,qe],Fe=F.an(je,qe).every((F=>Le.isPointAboveHorizon(F)))}return new Xe(Oe,Le.getCameraPoint(),Fe,Le)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(Me){return F.an(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],Me)}bufferedCameraGeometry(Me){const Le=this.screenBounds[0],Oe=1===this.screenBounds.length?this.screenBounds[0].add(new F.P(1,1)):this.screenBounds[1],Fe=F.an(Le,Oe,0,!1);return this.cameraPoint.y>Oe.y&&(this.cameraPoint.x>Le.x&&this.cameraPoint.x<Oe.x?Fe.splice(3,0,this.cameraPoint):this.cameraPoint.x>=Oe.x?Fe[2]=this.cameraPoint:this.cameraPoint.x<=Le.x&&(Fe[3]=this.cameraPoint)),F.ao(Fe,Me)}bufferedCameraGeometryGlobe(Me){const Le=this.screenBounds[0],Oe=1===this.screenBounds.length?this.screenBounds[0].add(new F.P(1,1)):this.screenBounds[1],Fe=F.an(Le,Oe,Me),je=this.cameraPoint.clone();switch(3*((je.y>Le.y)+(je.y>Oe.y))+((je.x>Le.x)+(je.x>Oe.x))){case 0:Fe[0]=je,Fe[4]=je.clone();break;case 1:Fe.splice(1,0,je);break;case 2:Fe[1]=je;break;case 3:Fe.splice(4,0,je);break;case 5:Fe.splice(2,0,je);break;case 6:Fe[3]=je;break;case 7:Fe.splice(3,0,je);break;case 8:Fe[2]=je}return Fe}containsTile(Me,Le,Oe,Fe=0){const je=Me.queryPadding/Le._pixelsPerMercatorPixel+1,qe=Oe?this._bufferedCameraMercator(je,Le):this._bufferedScreenMercator(je,Le);let He=Me.tileID.wrap+(qe.unwrapped?Fe:0);const xt=qe.polygon.map((Le=>F.ap(Me.tileTransform,Le,He)));if(!F.aq(xt,0,0,F.ai,F.ai))return;He=Me.tileID.wrap+(this.screenGeometryMercator.unwrapped?Fe:0);const Pt=this.screenGeometryMercator.polygon.map((Le=>F.ar(Me.tileTransform,Le,He))),jt=Pt.map((Me=>new F.P(Me[0],Me[1]))),Gt=Le.getFreeCameraOptions().position||new F.ac(0,0,0),bi=F.ar(Me.tileTransform,Gt,He),wi=Pt.map((Me=>{const Le=F.ad.vec3.sub(Me,Me,bi);return F.ad.vec3.normalize(Le,Le),new F.as(bi,Le)})),qr=F.at(Me,1,Le.zoom)*Le._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:jt,tilespaceRays:wi,bufferedTilespaceGeometry:xt,bufferedTilespaceBounds:(Xn=F.au(xt),Xn.min.x=F.ay(Xn.min.x,0,F.ai),Xn.min.y=F.ay(Xn.min.y,0,F.ai),Xn.max.x=F.ay(Xn.max.x,0,F.ai),Xn.max.y=F.ay(Xn.max.y,0,F.ai),Xn),tile:Me,tileID:Me.tileID,pixelToTileUnitsFactor:qr};var Xn}_bufferedScreenMercator(F,Me){const Le=Je(F);if(this._screenRaycastCache[Le])return this._screenRaycastCache[Le];{let Oe;return Oe="globe"===Me.projection.name?this._projectAndResample(this.bufferedScreenGeometry(F),Me):{polygon:this.bufferedScreenGeometry(F).map((F=>Me.pointCoordinate3D(F))),unwrapped:!0},this._screenRaycastCache[Le]=Oe,Oe}}_bufferedCameraMercator(F,Me){const Le=Je(F);if(this._cameraRaycastCache[Le])return this._cameraRaycastCache[Le];{let Oe;return Oe="globe"===Me.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(F),Me):{polygon:this.bufferedCameraGeometry(F).map((F=>Me.pointCoordinate3D(F))),unwrapped:!0},this._cameraRaycastCache[Le]=Oe,Oe}}_projectAndResample(Me,Le){const Oe=function(Me,Le){const Oe=F.ad.mat4.multiply([],Le.pixelMatrix,Le.globeMatrix),Fe=[0,-F.az,0,1],je=[0,F.az,0,1],qe=[0,0,0,1];F.ad.vec4.transformMat4(Fe,Fe,Oe),F.ad.vec4.transformMat4(je,je,Oe),F.ad.vec4.transformMat4(qe,qe,Oe);const He=new F.P(Fe[0]/Fe[3],Fe[1]/Fe[3]),xt=new F.P(je[0]/je[3],je[1]/je[3]),Pt=F.aw(Me,He)&&Fe[3]<qe[3],jt=F.aw(Me,xt)&&je[3]<qe[3];if(!Pt&&!jt)return null;const Gt=function(F,Me,Le){for(let Oe=1;Oe<F.length;Oe++){const Fe=Ye(Me.pointCoordinate3D(F[Oe-1]).x),je=Ye(Me.pointCoordinate3D(F[Oe]).x);if(Le<0){if(Fe<je)return{idx:Oe,t:-Fe/(je-1-Fe)}}else if(je<Fe)return{idx:Oe,t:(1-Fe)/(je+1-Fe)}}return null}(Me,Le,Pt?-1:1);if(!Gt)return null;const{idx:bi,t:wi}=Gt;let qr=bi>1?Ke(Me.slice(0,bi),Le):[],Xn=bi<Me.length?Ke(Me.slice(bi),Le):[];qr=qr.map((Me=>new F.P(Ye(Me.x),Me.y))),Xn=Xn.map((Me=>new F.P(Ye(Me.x),Me.y)));const Yn=[...qr];0===Yn.length&&Yn.push(Xn[Xn.length-1]);const yo=F.ah(Yn[Yn.length-1].y,(0===Xn.length?qr[0]:Xn[0]).y,wi);let bo;return bo=Pt?[new F.P(0,yo),new F.P(0,0),new F.P(1,0),new F.P(1,yo)]:[new F.P(1,yo),new F.P(1,1),new F.P(0,1),new F.P(0,yo)],Yn.push(...bo),0===Xn.length?Yn.push(qr[0]):Yn.push(...Xn),{polygon:Yn.map((Me=>new F.ac(Me.x,Me.y))),unwrapped:!1}}(Me,Le);if(Oe)return Oe;const Fe=function(Me,Le){let Oe=!1,Fe=-1/0,je=0;for(let F=0;F<Me.length-1;F++)Me[F].x>Fe&&(Fe=Me[F].x,je=F);for(let F=0;F<Me.length-1;F++){const Le=(je+F)%(Me.length-1),Fe=Me[Le],qe=Me[Le+1];Math.abs(Fe.x-qe.x)>.5&&(Fe.x<qe.x?(Fe.x+=1,0===Le&&(Me[Me.length-1].x+=1)):(qe.x+=1,Le+1===Me.length-1&&(Me[0].x+=1)),Oe=!0)}const qe=F.av(Le.center.lng);return Oe&&qe<Math.abs(qe-1)&&Me.forEach((F=>{F.x-=1})),{polygon:Me,unwrapped:Oe}}(Ke(Me,Le).map((Me=>new F.P(Ye(Me.x),Me.y))),Le);return{polygon:Fe.polygon.map((Me=>new F.ac(Me.x,Me.y))),unwrapped:Fe.unwrapped}}}function Ke(Me,Le){return F.ax(Me,(F=>{const Me=Le.pointCoordinate3D(F);F.x=Me.x,F.y=Me.y}),1/256)}function Ye(F){return F<0?1+F%1:F%1}function Je(F){return 100*F|0}function Qe(Me,Le,Oe,Fe,je){const n=function(Oe,Fe){if(Oe)return je(Oe);if(Fe){if(Me.url&&Fe.tiles&&Me.tiles&&delete Me.tiles,Fe.variants){if(!Array.isArray(Fe.variants))return je(new Error("variants must be an array"));for(const Me of Fe.variants){if(null==Me||"object"!=typeof Me||Me.constructor!==Object)return je(new Error("variant must be an object"));if(!Array.isArray(Me.capabilities))return je(new Error("capabilities must be an array"));if(1===Me.capabilities.length&&"meshopt"===Me.capabilities[0]){Fe=F.l(Fe,Me);break}}}const Oe=F.aA(F.l({},Fe,Me),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);Oe.tiles=Le.canonicalizeTileset(Oe,Me.url),je(null,Oe)}},qe=function(F,Me,Le){if(!F)return null;if(!Me&&!Le)return F;Le=Le||F.worldview_default;const Oe=Object.values(F.language||{});if(0===Oe.length)return null;const Fe=Object.values(F.worldview||{});if(0===Fe.length)return null;const je=Oe.every((F=>F===Me)),qe=Fe.every((F=>F===Le));return je&&qe?F:Me in(F.language_options||{})||Le in(F.worldview_options||{})?null:F.language_options&&F.worldview_options?F:null}(Me.data,Oe,Fe);return qe?F.q.frame((()=>n(null,qe))):Me.url?F.n(Le.transformRequest(Le.normalizeSourceURL(Me.url,null,Oe,Fe),F.R.Source),n):F.q.frame((()=>{const{data:F,...Le}=Me;n(null,Le)}))}class et{constructor(Me,Le,Oe){this.bounds=F.aB.convert(this.validateBounds(Me)),this.minzoom=Le||0,this.maxzoom=Oe||24}validateBounds(F){return Array.isArray(F)&&4===F.length?[Math.max(-180,F[0]),Math.max(-90,F[1]),Math.min(180,F[2]),Math.min(90,F[3])]:[-180,-90,180,90]}contains(Me){const Le=Math.pow(2,Me.z),Oe=Math.floor(F.av(this.bounds.getWest())*Le),Fe=Math.floor(F.aC(this.bounds.getNorth())*Le),je=Math.ceil(F.av(this.bounds.getEast())*Le),qe=Math.ceil(F.aC(this.bounds.getSouth())*Le);return Me.x>=Oe&&Me.x<je&&Me.y>=Fe&&Me.y<qe}}class tt extends F.E{constructor(Me,Le,Oe,Fe){if(super(),this.id=Me,this.dispatcher=Oe,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,F.l(this,F.aA(Le,["url","scheme","tileSize","promoteId"])),this._options=F.l({type:"vector"},Le),this._collectResourceTiming=!!Le.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(Fe),this._tileWorkers={},this._deduped=new F.aD}load(Me){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"}));const Le=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Oe=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,Le,Oe,((Fe,je)=>{if(this._tileJSONRequest=null,this._loaded=!0,Fe)Le&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${Le}`),Oe&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Oe}`),this.fire(new F.z(Fe));else if(je){if(F.l(this,je),this.hasWorldviews=!!je.worldview_options,je.worldview_default&&(this.worldviewDefault=je.worldview_default),je.vector_layers){this.vectorLayers=je.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const F of je.vector_layers)this.vectorLayerIds.push(F.id),je.worldview&&je.worldview[F.source]&&this.localizableLayerIds.add(F.id)}je.bounds&&(this.tileBounds=new et(je.bounds,this.minzoom,this.maxzoom)),Xn(je.tiles,this.map._requestManager._customAccessToken),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}Me&&Me(Fe)}))}loaded(){return this._loaded}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Me=F.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(Me)))}setTiles(F){return this._options.tiles=F,this.reload(),this}setUrl(F){return this.url=F,this._options.url=F,this.reload(),this}onRemove(F){this.cancelTileJSONRequest()}serialize(){return F.l({},this._options)}loadTile(Me,Le){const Oe=Me.tileID.canonical.url(this.tiles,this.scheme),Fe=this.map._requestManager.normalizeTileURL(Oe),je=this.map._requestManager.transformRequest(Fe,F.R.Tile),qe=this.map.style?this.map.style.getLut(this.scope):null,He=qe?{image:qe.image.clone()}:null,xt={request:je,data:void 0,uid:Me.uid,tileID:Me.tileID,tileZoom:Me.tileZoom,zoom:Me.tileID.overscaledZ,maxZoom:this.maxzoom,lut:He,tileSize:this.tileSize*Me.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:F.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:Me.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:Me.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&F.f(Oe)&&(xt.worldview=this.map.getWorldview()||this.worldviewDefault,xt.localizableLayerIds=this.localizableLayerIds),xt.request.collectResourceTiming=this._collectResourceTiming,Me.actor&&"expired"!==Me.state)"loading"===Me.state?Me.reloadCallback=Le:Me.request=Me.actor.send("reloadTile",xt,c.bind(this));else if(Me.actor=this._tileWorkers[Fe]=this._tileWorkers[Fe]||this.dispatcher.getActor(),this.dispatcher.ready)Me.request=Me.actor.send("loadTile",xt,c.bind(this),void 0,!0);else{const Le=F.aE.call({deduped:this._deduped},xt,((F,Le)=>{F||!Le?c.call(this,F):(xt.data={cacheControl:Le.cacheControl,expires:Le.expires,rawData:Le.rawData.slice(0)},Me.actor&&Me.actor.send("loadTile",xt,c.bind(this),void 0,!0))}),!0);Me.request={cancel:Le}}function c(Oe,Fe){return delete Me.request,Me.aborted?Le(null):Oe&&404!==Oe.status?Le(Oe):(Fe&&Fe.resourceTiming&&(Me.resourceTiming=Fe.resourceTiming),this.map._refreshExpiredTiles&&Fe&&Me.setExpiryData(Fe),Me.loadVectorData(Fe,this.map.painter),F.aF(this.dispatcher),Le(null),void(Me.reloadCallback&&(this.loadTile(Me,Me.reloadCallback),Me.reloadCallback=null)))}}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.actor&&F.actor.send("abortTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(F,Me){F.actor&&F.actor.send("removeTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope}),F.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class it extends F.E{constructor(Me,Le,Oe,Fe){super(),this.id=Me,this.dispatcher=Oe,this.setEventedParent(Fe),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=F.l({type:"raster"},Le),F.l(this,F.aA(Le,["url","scheme","tileSize"]))}load(Me){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"})),this._tileJSONRequest=Qe(this._options,this.map._requestManager,null,null,((Le,Oe)=>{this._tileJSONRequest=null,this._loaded=!0,Le?this.fire(new F.z(Le)):Oe&&(F.l(this,Oe),Oe.raster_layers&&(this.rasterLayers=Oe.raster_layers,this.rasterLayerIds=this.rasterLayers.map((F=>F.id))),Oe.bounds&&(this.tileBounds=new et(Oe.bounds,this.minzoom,this.maxzoom)),Xn(Oe.tiles),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))),Me&&Me(Le)}))}loaded(){return this._loaded}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Me=F.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(Me)))}setTiles(F){return this._options.tiles=F,this.reload(),this}setUrl(F){return this.url=F,this._options.url=F,this.reload(),this}onRemove(F){this.cancelTileJSONRequest()}serialize(){return F.l({},this._options)}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}loadTile(Me,Le){const Oe=F.q.devicePixelRatio>=2,Fe=this.map._requestManager.normalizeTileURL(Me.tileID.canonical.url(this.tiles,this.scheme),Oe,this.tileSize);Me.request=F.o(this.map._requestManager.transformRequest(Fe,F.R.Tile),((Oe,Fe,je,qe)=>(delete Me.request,Me.aborted?(Me.state="unloaded",Le(null)):Oe?(Me.state="errored",Le(Oe)):Fe?(this.map._refreshExpiredTiles&&Me.setExpiryData({cacheControl:je,expires:qe}),Me.setTexture(Fe,this.map.painter),Me.state="loaded",F.aF(this.dispatcher),void Le(null)):Le(null))))}abortTile(F,Me){F.request&&(F.request.cancel(),delete F.request),Me&&Me()}unloadTile(Me,Le){Me.texture&&Me.texture instanceof F.T?(Me.destroy(!0),Me.texture&&Me.texture instanceof F.T&&this.map.painter.saveTileTexture(Me.texture)):Me.destroy(),Le&&Le()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ot extends it{constructor(Me,Le,Oe,Fe){super(Me,Le,Oe,Fe),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=F.l({type:"raster-array"},Le)}triggerRepaint(F){const Me=this.map.painter._terrain,Le=this.map.style.getSourceCache(this.id);Me&&Me.enabled&&Le&&Me._clearRenderCacheForTile(Le.id,F.tileID),this.map.triggerRepaint()}loadTile(Me,Le){const Oe=this.map._requestManager.normalizeTileURL(Me.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),Fe=this.map._requestManager.transformRequest(Oe,F.R.Tile),je={request:Fe,uid:Me.uid,tileID:Me.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};Me.source=this.id,Me.scope=this.scope,Me.requestParams=Fe,Me.actor||(Me.actor=this.dispatcher.getActor());const n=(F,Oe,Fe,je)=>{if(delete Me.request,Me.aborted)return Me.state="unloaded",Le(null);if(F){if("AbortError"===F.name)return;return Me.state="errored",Le(F)}if(this.map._refreshExpiredTiles&&Oe&&Me.setExpiryData({cacheControl:Fe,expires:je}),this.partial)Me.state="empty";else{if(!Oe)return Le(null);Me.state="loaded",Me._isHeaderLoaded=!0,Me._mrt=Oe}Le(null)};Me.request=this.partial?Me.fetchHeader(void 0,n.bind(this)):Me.actor.send("loadTile",je,n.bind(this),void 0,!0)}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.actor&&F.actor.send("abortTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(Me,Le){const Oe=Me.texture;Oe&&Oe instanceof F.T?(Me.destroy(!0),this.map.painter.saveTileTexture(Oe)):(Me.destroy(),Me.flushQueues(),Me._isHeaderLoaded=!1,delete Me._mrt,delete Me.textureDescriptor),Me.fbo&&(Me.fbo.destroy(),delete Me.fbo),delete Me.request,delete Me.requestParams,delete Me.neighboringTiles,Me.state="unloaded"}prepareTile(Me,Le,Oe){Me._isHeaderLoaded&&("empty"!==Me.state&&(Me.state="reloading"),Me.fetchBand(Le,Oe,((Le,Oe)=>{if(Le)return Me.state="errored",this.fire(new F.z(Le)),void this.triggerRepaint(Me);Oe&&(Me._isHeaderLoaded=!0,Me.setTexture(Oe,this.map.painter),Me.state="loaded",this.triggerRepaint(Me))})))}getInitialBand(F){if(!this.rasterLayers)return 0;const Me=this.rasterLayers.find((({id:Me})=>Me===F)),Le=Me&&Me.fields,Oe=Le&&Le.bands&&Le.bands;return Oe?Oe[0]:0}getTextureDescriptor(Me,Le,Oe){if(!Me)return;const Fe=Le.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!Fe)return;let je=null;Le instanceof F.aI?je=Le.paint.get("raster-array-band"):Le instanceof F.aJ&&(je=Le.paint.get("raster-particle-array-band"));const qe=je||this.getInitialBand(Fe);if(null!=qe)if(Me.textureDescriptor){if(!Me.updateNeeded(Fe,qe)||Oe)return Object.assign({},Me.textureDescriptor,{texture:Me.texture})}else this.prepareTile(Me,Fe,qe)}getImages(Me,Le){const Oe=new Map;for(const Fe of Me)for(const Me of Le){const[Le,je]=Me.split("/"),qe=Fe.getLayer(Le);if(!qe)continue;if(!qe.hasBand(je)||!qe.hasDataForBand(je))continue;const{bytes:He,tileSize:xt,buffer:Pt}=qe.getBandView(je),jt=xt+2*Pt,Gt={data:new F.r({width:jt,height:jt},He),pixelRatio:2,sdf:!1,usvg:!1,version:0};Oe.set(Me,Gt)}return Oe}}const gc={vector:tt,raster:it,"raster-dem":class extends it{constructor(Me,Le,Oe,Fe){super(Me,Le,Oe,Fe),this.type="raster-dem",this.maxzoom=22,this._options=F.l({type:"raster-dem"},Le),this.encoding=Le.encoding||"mapbox"}loadTile(Me,Le){const Oe=this.map._requestManager.normalizeTileURL(Me.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function s(F,Oe){F&&(Me.state="errored",Le(F)),Oe&&(Me.dem=Oe,Me.dem.onDeserialize(),Me.needsHillshadePrepare=!0,Me.needsDEMTextureUpload=!0,Me.state="loaded",Le(null))}Me.request=F.o(this.map._requestManager.transformRequest(Oe,F.R.Tile),function(Oe,Fe,je,qe){if(delete Me.request,Me.aborted)Me.state="unloaded",Le(null);else if(Oe)Me.state="errored",Le(Oe);else if(Fe){this.map._refreshExpiredTiles&&Me.setExpiryData({cacheControl:je,expires:qe});const Le=ImageBitmap&&Fe instanceof ImageBitmap&&F.t(),Oe=1-(Fe.width-F.aG(Fe.width))/2;Oe<1||Me.neighboringTiles||(Me.neighboringTiles=this._getNeighboringTiles(Me.tileID));const He=Le?Fe:F.q.getImageData(Fe,Oe),xt={uid:Me.uid,tileID:Me.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:He,encoding:this.encoding,padding:Oe};Me.actor&&"expired"!==Me.state||(Me.actor=this.dispatcher.getActor(),Me.actor.send("loadTile",xt,s.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(Me){const Le=Me.canonical,Oe=Math.pow(2,Le.z),Fe=(Le.x-1+Oe)%Oe,je=0===Le.x?Me.wrap-1:Me.wrap,qe=(Le.x+1+Oe)%Oe,He=Le.x+1===Oe?Me.wrap+1:Me.wrap,xt={};return xt[new F.aH(Me.overscaledZ,je,Le.z,Fe,Le.y).key]={backfilled:!1},xt[new F.aH(Me.overscaledZ,He,Le.z,qe,Le.y).key]={backfilled:!1},Le.y>0&&(xt[new F.aH(Me.overscaledZ,je,Le.z,Fe,Le.y-1).key]={backfilled:!1},xt[new F.aH(Me.overscaledZ,Me.wrap,Le.z,Le.x,Le.y-1).key]={backfilled:!1},xt[new F.aH(Me.overscaledZ,He,Le.z,qe,Le.y-1).key]={backfilled:!1}),Le.y+1<Oe&&(xt[new F.aH(Me.overscaledZ,je,Le.z,Fe,Le.y+1).key]={backfilled:!1},xt[new F.aH(Me.overscaledZ,Me.wrap,Le.z,Le.x,Le.y+1).key]={backfilled:!1},xt[new F.aH(Me.overscaledZ,He,Le.z,qe,Le.y+1).key]={backfilled:!1}),xt}},"raster-array":ot,geojson:class extends F.E{constructor(Me,Le,Oe,Fe){super(),this.id=Me,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=Oe.getActor(),this.setEventedParent(Fe),this._data=Le.data,this._options=F.l({},Le),this._collectResourceTiming=Le.collectResourceTiming,void 0!==Le.maxzoom&&(this.maxzoom=Le.maxzoom),void 0!==Le.minzoom&&(this.minzoom=Le.minzoom),Le.type&&(this.type=Le.type),Le.attribution&&(this.attribution=Le.attribution),this.promoteId=Le.promoteId;const je=F.ai/this.tileSize;this.workerOptions=F.l({source:this.id,scope:this.scope,cluster:Le.cluster||!1,geojsonVtOptions:{buffer:(void 0!==Le.buffer?Le.buffer:128)*je,tolerance:(void 0!==Le.tolerance?Le.tolerance:.375)*je,extent:F.ai,maxZoom:this.maxzoom,lineMetrics:Le.lineMetrics||!1,generateId:Le.generateId||!1},superclusterOptions:{maxZoom:void 0!==Le.clusterMaxZoom?Le.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,Le.clusterMinPoints||2),extent:F.ai,radius:(void 0!==Le.clusterRadius?Le.clusterRadius:50)*je,log:!1,generateId:Le.generateId||!1},clusterProperties:Le.clusterProperties,filter:Le.filter,dynamic:Le.dynamic},Le.workerOptions)}onAdd(F){this.map=F,this.setData(this._data)}setData(F){return this._data=F,this._updateWorkerData(),this}updateData(Me){if(!this._options.dynamic)return this.fire(new F.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof Me&&("Feature"===Me.type&&(Me={type:"FeatureCollection",features:[Me]}),"FeatureCollection"!==Me.type))return this.fire(new F.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof Me&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const F=new Map;for(const Me of this._data.features)F.set(Me.id,Me);for(const Le of Me.features)F.set(Le.id,Le);this._data.features=[...F.values()]}else this._data=Me;return this._updateWorkerData(!0),this}getClusterExpansionZoom(F,Me){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:F,source:this.id,scope:this.scope},Me),this}getClusterChildren(F,Me){return this.actor.send("geojson.getClusterChildren",{clusterId:F,source:this.id,scope:this.scope},Me),this}getClusterLeaves(F,Me,Le,Oe){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:F,limit:Me,offset:Le},Oe),this}_updateWorkerData(Me=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new F.A("dataloading",{dataType:"source"})),this._loaded=!1;const Le=F.l({append:Me},this.workerOptions);Le.scope=this.scope;const Oe=this._data;"string"==typeof Oe?(Le.request=this.map._requestManager.transformRequest(F.q.resolveURL(Oe),F.R.Source),Le.request.collectResourceTiming=this._collectResourceTiming):Le.data=JSON.stringify(Oe),this._pendingLoad=this.actor.send(`${this.type}.loadData`,Le,((Le,Oe)=>{if(this._loaded=!0,this._pendingLoad=null,Le)this.fire(new F.z(Le));else{const Le={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&Oe&&Oe.resourceTiming&&Oe.resourceTiming[this.id]&&(Le.resourceTiming=Oe.resourceTiming[this.id]),Me&&(this._partialReload=!0),this.fire(new F.A("data",Le)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(Me),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const Me=F.C(this.id,this.scope);this.map.style.clearSource(Me),this._updateWorkerData()}loadTile(Me,Le){const Oe=Me.actor?"reloadTile":"loadTile";Me.actor=this.actor;const Fe=this.map.style?this.map.style.getLut(this.scope):null,je=Fe?{image:Fe.image.clone()}:null,qe=this._partialReload,He={type:this.type,uid:Me.uid,tileID:Me.tileID,tileZoom:Me.tileZoom,zoom:Me.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:je,scope:this.scope,pixelRatio:F.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:qe};Me.request=this.actor.send(Oe,He,((F,Fe)=>qe&&!Fe?(Me.state="loaded",Le(null)):(delete Me.request,Me.destroy(),Me.aborted?Le(null):F?Le(F):(Me.loadVectorData(Fe,this.map.painter,"reloadTile"===Oe),Le(null)))),void 0,"loadTile"===Oe)}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.aborted=!0}unloadTile(F,Me){this.actor.send("removeTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope}),F.destroy()}onRemove(F){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return F.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends F.aK{constructor(F,Me,Le,Oe){super(F,Me,Le,Oe),this.roundZoom=!0,this.type="video",this.options=Me}load(){this._loaded=!1;const Me=this.options;this.urls=[];for(const Le of Me.urls)this.urls.push(this.map._requestManager.transformRequest(Le,F.R.Source).url);F.aL(this.urls,((Me,Le)=>{this._loaded=!0,Me?this.fire(new F.z(Me)):Le&&(this.video=Le,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(Me){if(this.video){const Le=this.video.seekable;Me<Le.start(0)||Me>Le.end(0)?this.fire(new F.z(new F.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${Le.start(0)} and ${Le.end(0)}-second mark.`))):this.video.currentTime=Me}}getVideo(){return this.video}onAdd(F){this.map||(this.map=F,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const Me=this.map.painter.context,Le=Me.gl;this.texture?this.video.paused||(this.texture.bind(Le.LINEAR,Le.CLAMP_TO_EDGE),Le.texSubImage2D(Le.TEXTURE_2D,0,0,0,Le.RGBA,Le.UNSIGNED_BYTE,this.video)):(this.texture=new F.T(Me,this.video,Le.RGBA8),this.texture.bind(Le.LINEAR,Le.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(Me)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:F.aK,model:class extends F.E{constructor(F,Me,Le,Oe){super(),this.id=F,this.type="model",this.models=[],this._loaded=!1,this._options=Me}load(){const Me=[];for(const Le in this._options.models){const Oe=this._options.models[Le],Fe=F.aN(this.map._requestManager.transformRequest(Oe.uri,F.R.Model).url).then((Me=>{if(!Me)return;const Fe=F.aO(Me),je=new F.aP(Le,Oe.position,Oe.orientation,Fe);je.computeBoundsAndApplyParent(),this.models.push(je)})).catch((Me=>{this.fire(new F.z(new Error(`Could not load model ${Le} from ${Oe.uri}: ${Me.message}`)))}));Me.push(Fe)}return Promise.allSettled(Me).then((()=>{this._loaded=!0,this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((Me=>{this.fire(new F.z(new Error(`Could not load models: ${Me.message}`)))}))}onAdd(F){this.map=F,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(F,Me){}serialize(){return{type:"model"}}},"batched-model":class extends F.E{constructor(F,Me,Le,Oe){super(),this.type="batched-model",this.id=F,this.tileSize=512,this._options=Me,this.tiles=this._options.tiles,this.maxzoom=Me.maxzoom||19,this.minzoom=Me.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=Le,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(Oe)}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Me=F.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(Me)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(Me){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"}));const Le=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Oe=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,Le,Oe,((Fe,je)=>{this._tileJSONRequest=null,this._loaded=!0,Fe?(Le&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${Le}`),Oe&&2!==Oe.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Oe}`),this.fire(new F.z(Fe))):je&&(F.l(this,je),je.bounds&&(this.tileBounds=new et(je.bounds,this.minzoom,this.maxzoom)),Xn(je.tiles,this.map._requestManager._customAccessToken),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))),Me&&Me(Fe)}))}hasTransition(){return!1}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}loaded(){return this._loaded}loadTile(Me,Le){const Oe=this.map._requestManager.normalizeTileURL(Me.tileID.canonical.url(this.tiles,this.scheme)),Fe={request:this.map._requestManager.transformRequest(Oe,F.R.Tile),data:void 0,uid:Me.uid,tileID:Me.tileID,tileZoom:Me.tileZoom,zoom:Me.tileID.overscaledZ,tileSize:this.tileSize*Me.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:Me.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:F.q.devicePixelRatio,promoteId:this.promoteId};if(Me.actor&&"expired"!==Me.state)if("loading"===Me.state)Me.reloadCallback=Le;else{if(Me.buckets){const F=Object.values(Me.buckets);for(const Me of F)Me.dirty=!0;return void(Me.state="loaded")}Me.request=Me.actor.send("reloadTile",Fe,r.bind(this))}else Me.actor=this.dispatcher.getActor(),Me.request=Me.actor.send("loadTile",Fe,r.bind(this),void 0,!0);function r(F,Oe){return Me.aborted?Le(null):F&&404!==F.status?Le(F):(this.map._refreshExpiredTiles&&Oe&&Me.setExpiryData(Oe),Me.loadModelData(Oe,this.map.painter),Me.state="loaded",void Le(null))}}serialize(){return F.l({},this._options)}},canvas:class extends F.aK{constructor(Me,Le,Oe,Fe){super(Me,Le,Oe,Fe),Le.coordinates?Array.isArray(Le.coordinates)&&4===Le.coordinates.length&&!Le.coordinates.some((F=>!Array.isArray(F)||2!==F.length||F.some((F=>"number"!=typeof F))))||this.fire(new F.z(new F.V(`sources.${Me}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new F.z(new F.V(`sources.${Me}`,null,'missing required property "coordinates"'))),Le.animate&&"boolean"!=typeof Le.animate&&this.fire(new F.z(new F.V(`sources.${Me}`,null,'optional "animate" property must be a boolean value'))),Le.canvas?"string"==typeof Le.canvas||Le.canvas instanceof HTMLCanvasElement||this.fire(new F.z(new F.V(`sources.${Me}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new F.z(new F.V(`sources.${Me}`,null,'missing required property "canvas"'))),this.options=Le,this.animate=void 0===Le.animate||Le.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new F.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(F){this.map=F,this.load(),this.canvas&&this.animate&&this.play()}onRemove(F){this.pause()}prepare(){let Me=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,Me=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,Me=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const Le=this.map.painter.context;this.texture?!Me&&!this._playing||this.texture instanceof F.aM||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new F.T(Le,this.canvas,Le.gl.RGBA8,{premultiply:!0}),this._prepareData(Le)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const F of[this.canvas.width,this.canvas.height])if(isNaN(F)||F<=0)return!0;return!1}},custom:class extends F.E{constructor(Me,Le,Oe,Fe){super(),this.id=Me,this.type="custom",this._dataType="raster",this._dispatcher=Oe,this._implementation=Le,this.setEventedParent(Fe),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new F.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new F.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new et(this._implementation.bounds,this.minzoom,this.maxzoom)),Le.update=this._update.bind(this),Le.clearTiles=this._clearTiles.bind(this),Le.coveringTiles=this._coveringTiles.bind(this),F.l(this,F.aA(Le,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return F.aA(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(Me){this.map=Me,this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(Me),this.load()}onRemove(F){this._implementation.onRemove&&this._implementation.onRemove(F)}hasTile(F){if(this._implementation.hasTile){const{x:Me,y:Le,z:Oe}=F.canonical;return this._implementation.hasTile({x:Me,y:Le,z:Oe})}return!this.tileBounds||this.tileBounds.contains(F.canonical)}loadTile(F,Me){const{x:Le,y:Oe,z:Fe}=F.tileID.canonical,je=new AbortController;F.request=Promise.resolve(this._implementation.loadTile({x:Le,y:Oe,z:Fe},{signal:je.signal})).then(function(Le){return delete F.request,F.aborted?(F.state="unloaded",Me(null)):void 0===Le?(F.state="errored",Me(null)):null===Le?(this.loadTileData(F,{width:this.tileSize,height:this.tileSize,data:null}),F.state="loaded",Me(null)):function(F){return F instanceof ImageData||F instanceof HTMLCanvasElement||F instanceof ImageBitmap||F instanceof HTMLImageElement}(Le)?(this.loadTileData(F,Le),F.state="loaded",void Me(null)):(F.state="errored",Me(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((Le=>{"AbortError"!==Le.name&&(F.state="errored",Me(Le))})),F.request.cancel=()=>je.abort()}loadTileData(F,Me){F.setTexture(Me,this.map.painter)}unloadTile(Me,Le){if(Me.texture&&Me.texture instanceof F.T?(Me.destroy(!0),Me.texture&&Me.texture instanceof F.T&&this.map.painter.saveTileTexture(Me.texture)):Me.destroy(),this._implementation.unloadTile){const{x:F,y:Le,z:Oe}=Me.tileID.canonical;this._implementation.unloadTile({x:F,y:Le,z:Oe})}Le&&Le()}abortTile(F,Me){F.request&&F.request.cancel&&(F.request.cancel(),delete F.request),Me&&Me()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((F=>({x:F.canonical.x,y:F.canonical.y,z:F.canonical.z})))}_clearTiles(){const Me=F.C(this.id,this.scope);this.map.style.clearSource(Me)}_update(){this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}}},rt=function(Me,Le,Oe,Fe){const je=new gc[Le.type](Me,Le,Oe,Fe);if(je.id!==Me)throw new Error(`Expected Source id to be ${Me} instead of ${je.id}`);return F.aQ(["load","abort","unload","serialize","prepare"],je),je};function nt(F,Me,Le=""){return`${Le}:${Me.id||""}:${Me.layer.id}:${function(F){if("layerId"in F)return`layer:${F.layerId}`;{const{featuresetId:Me,importId:Le}=F;return`featureset:${Me}${Le?`:import:${Le}`:""}`}}(F.target)}`}function at(F,Me,Le,Oe=""){if(F.uniqueFeatureID){const Fe=nt(F,Me,Oe);if(Le.has(Fe))return!0;Le.add(Fe)}return!1}function lt(F,Me,Le,Oe,Fe=!1){const je=Me.sourceCache.transform,qe=Me.sourceCache.tilesIn(F,Me.has3DLayers,Fe);qe.sort(dt);const He=[];for(const F of qe){const qe=F.tile.queryRenderedFeatures(Me,F,Le,Oe,je,Fe);Object.keys(qe).length&&He.push({wrappedTileID:F.tile.tileID.wrapped().key,queryResults:qe})}return 0===He.length?{}:function(F){const Me={},Le={};for(const Oe of F){const F=Oe.queryResults,Fe=Oe.wrappedTileID,je=Le[Fe]=Le[Fe]||{};for(const Le in F){const Oe=F[Le],Fe=je[Le]=je[Le]||{},qe=Me[Le]=Me[Le]||[];for(const F of Oe)Fe[F.featureIndex]||(Fe[F.featureIndex]=!0,qe.push(F))}}return Me}(He)}function ct(F,Me,Le,Oe,Fe){const je={},qe=Oe.queryRenderedSymbols(F),He=[];for(const F of Object.keys(qe).map(Number))He.push(Fe[F]);He.sort(dt);for(const F of He){const Oe=F.featureIndex.lookupSymbolFeatures(qe[F.bucketInstanceId],F.bucketIndex,F.sourceLayerIndex,Me,Le);for(const Me in Oe){const Le=je[Me]=je[Me]||[],Fe=Oe[Me];Fe.sort(((Me,Le)=>{const Oe=F.featureSortOrder;if(Oe){const F=Oe.indexOf(Me.featureIndex);return Oe.indexOf(Le.featureIndex)-F}return Le.featureIndex-Me.featureIndex}));for(const F of Fe)Le.push(F)}}return je}function ht(F,Me){const Le=F.getRenderableIds().map((Me=>F.getTileByID(Me))),Oe=[],Fe={};for(let F=0;F<Le.length;F++){const je=Le[F],qe=je.tileID.canonical.key;Fe[qe]||(Fe[qe]=!0,je.querySourceFeatures(Oe,Me))}return Oe}function dt(F,Me){const Le=F.tileID,Oe=Me.tileID;return Le.overscaledZ-Oe.overscaledZ||Le.canonical.y-Oe.canonical.y||Le.wrap-Oe.wrap||Le.canonical.x-Oe.canonical.x}function ut(F,Me){const Le={};if(!Me)return Le;for(const Oe of F){const F=Oe.layerIds.map((F=>Me.getLayer(F))).filter(Boolean);if(0!==F.length){Oe.layers=F,Oe.stateDependentLayerIds&&(Oe.stateDependentLayers=Oe.stateDependentLayerIds.map((Me=>F.filter((F=>F.id===Me))[0])));for(const Me of F)Le[Me.fqid]=Oe}}return Le}const yc=32,xc=33,Zc=new Uint16Array(8184);for(let F=0;F<2046;F++){let Me=F+2,Le=0,Oe=0,Fe=0,je=0,qe=0,He=0;for(1&Me?Fe=je=qe=yc:Le=Oe=He=yc;(Me>>=1)>1;){const F=Le+Fe>>1,xt=Oe+je>>1;1&Me?(Fe=Le,je=Oe,Le=qe,Oe=He):(Le=Fe,Oe=je,Fe=qe,je=He),qe=F,He=xt}const xt=4*F;Zc[xt+0]=Le,Zc[xt+1]=Oe,Zc[xt+2]=Fe,Zc[xt+3]=je}const Wc=new Uint16Array(2178),Kc=new Uint8Array(1089),Jc=new Uint16Array(1089);function yt(F){return 0===F?-.03125:32===F?.03125:0}const Qc=(()=>({type:2,extent:F.ai,loadGeometry:()=>[[new F.P(0,0),new F.P(F.ai+1,0),new F.P(F.ai+1,F.ai+1),new F.P(0,F.ai+1),new F.P(0,0)]]}))();class bt{constructor(Me,Le,Oe,Fe,je){this.tileID=Me,this.uid=F.aW(),this.uses=0,this.tileSize=Le,this.tileZoom=Oe,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=je,Fe&&Fe.style&&(this._lastUpdatedBrightness=Fe.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",Fe&&Fe.transform&&(this.projection=Fe.transform.projection)}registerFadeDuration(Me){const Le=Me+this.timeAdded;Le<F.q.now()||this.fadeEndTime&&Le<this.fadeEndTime||(this.fadeEndTime=Le)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=F.aR(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(Me,Le,Oe){if(this.unloadVectorData(),this.state="loaded",Me){Me.featureIndex&&(this.latestFeatureIndex=Me.featureIndex,Me.rawTileData?(this.latestRawTileData=Me.rawTileData,this.latestFeatureIndex.rawTileData=Me.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=Me.collisionBoxArray,this.buckets=ut(Me.buckets,Le.style),this.hasSymbolBuckets=!1;for(const Me in this.buckets){const Le=this.buckets[Me];if(Le instanceof F.aY){if(this.hasSymbolBuckets=!0,!Oe)break;Le.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const Me in this.buckets){const Le=this.buckets[Me];if(Le instanceof F.aY&&Le.hasRTLText){this.hasRTLText=!0,F.aZ();break}}this.queryPadding=0;for(const F in this.buckets){const Me=this.buckets[F],Oe=Le.style.getOwnLayer(F);if(!Oe)continue;const Fe=Oe.queryRadius(Me);this.queryPadding=Math.max(this.queryPadding,Fe)}Me.imageAtlas&&(this.imageAtlas=Me.imageAtlas),Me.glyphAtlasImage&&(this.glyphAtlasImage=Me.glyphAtlasImage),Me.lineAtlas&&(this.lineAtlas=Me.lineAtlas),this._lastUpdatedBrightness=Me.brightness}else this.collisionBoxArray=new F.aX}unloadVectorData(){if(this.hasData()){for(const F in this.buckets)this.buckets[F].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(F,Me,Le){F&&(F.resourceTiming&&(this.resourceTiming=F.resourceTiming),this.buckets=Object.assign({},this.buckets,ut(F.buckets,Me.style)),F.featureIndex&&(this.latestFeatureIndex=F.featureIndex))}getBucket(F){return this.buckets[F.fqid]}upload(Me){for(const F in this.buckets){const Le=this.buckets[F];Le.uploadPending()&&Le.upload(Me)}const Le=Me.gl,Oe=this.imageAtlas;Oe&&!Oe.uploaded&&(this.imageAtlasTexture=new F.T(Me,Oe.image,Le.RGBA8,{useMipmap:!!Oe.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new F.T(Me,this.glyphAtlasImage,Le.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new F.T(Me,this.lineAtlas.image,Le.R8),this.lineAtlas.uploaded=!0)}prepare(F,Me,Le){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(F,this.imageAtlasTexture,Le),!Me||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const Oe=Me.style.getBrightness();(this._lastUpdatedBrightness||Oe)&&(this._lastUpdatedBrightness&&Oe&&Math.abs(this._lastUpdatedBrightness-Oe)<.001||(this.updateBuckets(Me,this._lastUpdatedBrightness!==Oe),this._lastUpdatedBrightness=Oe))}queryRenderedFeatures(Me,Le,Oe,Fe,je,qe){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const He=function(Me,Le){const Oe=F.ad.mat4.fromScaling([],[.5*Me.width,.5*-Me.height,1]);return F.ad.mat4.translate(Oe,Oe,[1,-1,0]),F.ad.mat4.multiply(Oe,Oe,Me.calculateProjMatrix(Le.toUnwrapped())),Float32Array.from(Oe)}(je,this.tileID);return this.latestFeatureIndex.query(Me,{tilespaceGeometry:Le,pixelPosMatrix:He,transform:Fe,availableImages:Oe,tileTransform:this.tileTransform})}querySourceFeatures(Me,Le){const Oe=this.latestFeatureIndex;if(!Oe||!Oe.rawTileData)return;const Fe=Oe.loadVTLayers(),je=Le?Le.sourceLayer:"",qe=Fe._geojsonTileLayer||Fe[je];if(!qe)return;const He=F.a_(Le&&Le.filter),{z:xt,x:Pt,y:jt}=this.tileID.canonical,Gt={z:xt,x:Pt,y:jt};for(let Le=0;Le<qe.length;Le++){const Fe=qe.feature(Le);if(He.needGeometry){const Me=F.a$(Fe,!0);if(!He.filter(new F.aa(this.tileID.overscaledZ),Me,this.tileID.canonical))continue}else if(!He.filter(new F.aa(this.tileID.overscaledZ),Fe))continue;const bi=Oe.getId(Fe,je),wi=new F.b0(Fe,xt,Pt,jt,bi);wi.tile=Gt,Me.push(wi)}}loaded(){return"loaded"===this.state||"errored"===this.state}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(Me){const Le=this.expirationTime;if(Me.cacheControl){const Le=F.b1(Me.cacheControl);Le["max-age"]&&(this.expirationTime=Date.now()+1e3*Le["max-age"])}else Me.expires&&(this.expirationTime=new Date(Me.expires).getTime());if(this.expirationTime){const F=Date.now();let Me=!1;if(this.expirationTime>F)Me=!1;else if(Le)if(this.expirationTime<Le)Me=!0;else{const Oe=this.expirationTime-Le;Oe?this.expirationTime=F+Math.max(Oe,3e4):Me=!0}else Me=!0;Me?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(F){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&F&&this.updateBuckets(F)}updateBuckets(Me,Le){if(!this.latestFeatureIndex)return;if(!Me.style)return;const Oe=this.latestFeatureIndex.loadVTLayers(),Fe=Me.style.listImages(),je=Me.style.getBrightness();for(const qe in this.buckets){if(!Me.style.hasLayer(qe))continue;const He=this.buckets[qe],xt=He.layers[0],Pt=xt.sourceLayer||"_geojsonTileLayer",jt=Oe[Pt],Gt=Me.style.getLayerSourceCache(xt);let bi={};Gt&&(bi=Gt._state.getState(Pt,void 0));const wi=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},qr=Object.keys(bi).length>0&&!Le;qr&&!He.stateDependentLayers.length&&!Le||He.update(bi,jt,Fe,wi,qr?He.stateDependentLayers:He.layers,Le,je),(He instanceof F.b2||He instanceof F.b3)&&Me._terrain&&Me._terrain.enabled&&Gt&&He.uploadPending()&&Me._terrain._clearRenderCacheForTile(Gt.id,this.tileID);const Xn=Me&&Me.style&&Me.style.getOwnLayer(qe);Xn&&(this.queryPadding=Math.max(this.queryPadding,Xn.queryRadius(He)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<F.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(Me){this.symbolFadeHoldUntil=F.q.now()+Me}setTexture(Me,Le){const Oe=Le.context,Fe=Oe.gl;this.texture=this.texture||Le.getTileTexture(Me.width),this.texture&&this.texture instanceof F.T?this.texture.update(Me):(this.texture=new F.T(Oe,Me,Fe.RGBA8,{useMipmap:!0}),this.texture.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE))}setDependencies(F,Me){const Le={};for(const F of Me)Le[F]=!0;this.dependencies[F]=Le}hasDependency(F,Me){for(const Le of F){const F=this.dependencies[Le];if(F)for(const Le of Me)if(F[Le])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(Me,Le){if(!Le||"mercator"===Le.name||this._tileDebugBuffer)return;const Oe=F.b4(Qc,this.tileID.canonical,this.tileTransform)[0],Fe=new F.b5,je=new F.b6;for(let F=0;F<Oe.length;F++){const{x:Me,y:Le}=Oe[F];Fe.emplaceBack(Me,Le),je.emplaceBack(F)}je.emplaceBack(0),this._tileDebugIndexBuffer=Me.createIndexBuffer(je),this._tileDebugBuffer=Me.createVertexBuffer(Fe,F.b7.members),this._tileDebugSegments=F.b8.simpleSegment(0,0,Fe.length,je.length)}_makeTileBoundsBuffers(Me,Le){if(this._tileBoundsBuffer||!Le||"mercator"===Le.name)return;const Oe=F.b4(Qc,this.tileID.canonical,this.tileTransform)[0];let Fe,je;if(this.isRaster){const Me=function(Me,Le){const Oe=F.aR(Me,Le),Fe=Math.pow(2,Me.z);for(let je=0;je<xc;je++)for(let qe=0;qe<xc;qe++){const He=F.aS((Me.x+(qe+yt(qe))/yc)/Fe),xt=F.aT((Me.y+(je+yt(je))/yc)/Fe),Pt=Le.project(He,xt),jt=je*xc+qe;Wc[2*jt+0]=Math.round((Pt.x*Oe.scale-Oe.x)*F.ai),Wc[2*jt+1]=Math.round((Pt.y*Oe.scale-Oe.y)*F.ai)}Kc.fill(0),Jc.fill(0);for(let F=2045;F>=0;F--){const Me=4*F,Le=Zc[Me+0],Oe=Zc[Me+1],Fe=Zc[Me+2],je=Zc[Me+3],qe=Le+Fe>>1,He=Oe+je>>1,xt=qe+He-Oe,Pt=He+Le-qe,jt=Oe*xc+Le,Gt=je*xc+Fe,bi=He*xc+qe,wi=Math.hypot((Wc[2*jt+0]+Wc[2*Gt+0])/2-Wc[2*bi+0],(Wc[2*jt+1]+Wc[2*Gt+1])/2-Wc[2*bi+1])>=16;Kc[bi]=Kc[bi]||(wi?1:0),F<1022&&(Kc[bi]=Kc[bi]||Kc[(Oe+Pt>>1)*xc+(Le+xt>>1)]||Kc[(je+Pt>>1)*xc+(Fe+xt>>1)])}const je=new F.aU,qe=new F.aV;let He=0;function l(Me,Le){const Oe=Le*xc+Me;return 0===Jc[Oe]&&(je.emplaceBack(Wc[2*Oe+0],Wc[2*Oe+1],Me*F.ai/yc,Le*F.ai/yc),Jc[Oe]=++He),Jc[Oe]-1}function c(F,Me,Le,Oe,Fe,je){const He=F+Le>>1,xt=Me+Oe>>1;if(Math.abs(F-Fe)+Math.abs(Me-je)>1&&Kc[xt*xc+He])c(Fe,je,F,Me,He,xt),c(Le,Oe,Fe,je,He,xt);else{const He=l(F,Me),xt=l(Le,Oe),Pt=l(Fe,je);qe.emplaceBack(He,xt,Pt)}}return c(0,0,yc,yc,yc,0),c(yc,yc,0,0,0,yc),{vertices:je,indices:qe}}(this.tileID.canonical,Le);Fe=Me.vertices,je=Me.indices}else{Fe=new F.aU,je=new F.aV;for(const{x:F,y:Me}of Oe)Fe.emplaceBack(F,Me,0,0);const Me=F.b9(Fe.int16,void 0,4);for(let F=0;F<Me.length;F+=3)je.emplaceBack(Me[F],Me[F+1],Me[F+2])}this._tileBoundsBuffer=Me.createVertexBuffer(Fe,F.ba.members),this._tileBoundsIndexBuffer=Me.createIndexBuffer(je),this._tileBoundsSegments=F.b8.simpleSegment(0,0,Fe.length,je.length)}_makeGlobeTileDebugBuffers(Me,Le){const Oe=Le.projection;if(!Oe||"globe"!==Oe.name||Le.freezeTileCoverage)return;const Fe=this.tileID.canonical,je=F.bb(Fe,Le),qe=F.bc(je),He=F.ag(Le.zoom);let xt;He>0&&(xt=F.ad.mat4.invert(new Float64Array(16),Le.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(Me,Fe,Le,qe,xt,He),this._makeGlobeTileDebugTextBuffer(Me,Fe,Le,qe,xt,He)}_globePoint(Me,Le,Oe,Fe,je,qe,He){let xt=F.bd(Me,Le,Oe);if(qe){const je=1<<Oe.z,Pt=F.av(Fe.center.lng),jt=F.aC(Fe.center.lat),Gt=(Oe.x+.5)/je-Pt;let bi=0;Gt>.5?bi=-1:Gt<-.5&&(bi=1);let wi=(Me/F.ai+Oe.x)/je+bi,qr=(Le/F.ai+Oe.y)/je;wi=(wi-Pt)*Fe._pixelsPerMercatorPixel+Pt,qr=(qr-jt)*Fe._pixelsPerMercatorPixel+jt;const Xn=[wi*Fe.worldSize,qr*Fe.worldSize,0];F.ad.vec3.transformMat4(Xn,Xn,qe),xt=F.be(xt,Xn,He)}return F.ad.vec3.transformMat4(xt,xt,je)}_makeGlobeTileDebugBorderBuffer(Me,Le,Oe,Fe,je,qe){const He=new F.b5,xt=new F.b6,Pt=new F.bf,h=(F,Me,jt,Gt,bi)=>{const wi=(jt-F)/(bi-1),qr=(Gt-Me)/(bi-1),Xn=He.length;for(let jt=0;jt<bi;jt++){const Gt=F+jt*wi,bi=Me+jt*qr;He.emplaceBack(Gt,bi);const Yn=this._globePoint(Gt,bi,Le,Oe,Fe,je,qe);Pt.emplaceBack(Yn[0],Yn[1],Yn[2]),xt.emplaceBack(Xn+jt)}},jt=F.ai;h(0,0,jt,0,16),h(jt,0,jt,jt,16),h(jt,jt,0,jt,16),h(0,jt,0,0,16),this._tileDebugIndexBuffer=Me.createIndexBuffer(xt),this._tileDebugBuffer=Me.createVertexBuffer(He,F.b7.members),this._globeTileDebugBorderBuffer=Me.createVertexBuffer(Pt,F.bg.members),this._tileDebugSegments=F.b8.simpleSegment(0,0,He.length,xt.length)}_makeGlobeTileDebugTextBuffer(Me,Le,Oe,Fe,je,qe){const He=F.ai/4,xt=new F.b5,Pt=new F.aV,jt=new F.bf,Gt=25;Pt.reserve(32),xt.reserve(Gt),jt.reserve(Gt);const u=(F,Me)=>Gt*F+Me;for(let F=0;F<Gt;F++){const Me=F*He;for(let F=0;F<Gt;F++){const Pt=F*He;xt.emplaceBack(Pt,Me);const Gt=this._globePoint(Pt,Me,Le,Oe,Fe,je,qe);jt.emplaceBack(Gt[0],Gt[1],Gt[2])}}for(let F=0;F<4;F++)for(let Me=0;Me<4;Me++){const Le=u(F,Me),Oe=u(F,Me+1),Fe=u(F+1,Me),je=u(F+1,Me+1);Pt.emplaceBack(Le,Oe,Fe),Pt.emplaceBack(Fe,Oe,je)}this._tileDebugTextIndexBuffer=Me.createIndexBuffer(Pt),this._tileDebugTextBuffer=Me.createVertexBuffer(xt,F.b7.members),this._globeTileDebugTextBuffer=Me.createVertexBuffer(jt,F.bg.members),this._tileDebugTextSegments=F.b8.simpleSegment(0,0,Gt,32)}destroy(Me=!1){for(const F in this.buckets)this.buckets[F].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!Me&&this.texture&&this.texture instanceof F.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}F.bh.setPbf(F.bi);class wt extends bt{constructor(F,Me,Le,Oe,Fe){super(F,Me,Le,Oe,Fe),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(F){return this._mrt&&this._mrt.getLayer(F)}setTexture(Me,Le){const Oe=Le.context,Fe=Oe.gl;this.texture=this.texture||Le.getTileTexture(Me.width),this.texture&&this.texture instanceof F.T?this.texture.update(Me,{premultiply:!1}):this.texture=new F.T(Oe,Me,Fe.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(Me=16384,Le){const Oe=this._mrt=new F.bh(30),Fe=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(Me-1)}});return this.entireBuffer=null,this.request=F.bj(Fe,((F,Fe,je,qe)=>{if(F)Le(F);else try{const F=Oe.getHeaderLength(Fe);if(F>Me)return void(this.request=this.fetchHeader(F,Le));Oe.parseHeader(Fe),this._isHeaderLoaded=!0;let He=0;for(const F of Object.values(Oe.layers))He=Math.max(He,F.dataIndex[F.dataIndex.length-1].lastByte);Fe.byteLength>=He&&(this.entireBuffer=Fe),Le(null,this.entireBuffer||Fe,je,qe)}catch(F){Le(F)}})),this.request}fetchBand(Me,Le,Oe){const Fe=this._mrt;if(!this._isHeaderLoaded||!Fe)return void Oe(new Error("Tile header is not ready"));const je=this.actor;if(!je)return void Oe(new Error("Can't fetch tile band without an actor"));let qe;const a=(F,Fe)=>{qe.complete(F,Fe),F?Oe(F):(this.updateTextureDescriptor(Me,Le),Oe(null,this.textureDescriptor&&this.textureDescriptor.img))},l=(F,Me)=>{if(F)return Oe(F);const Le=je.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:Me,task:qe},a,void 0,!0);this._workQueue.push((()=>{Le&&Le.cancel(),qe.cancel()}))},He=Fe.getLayer(Me);if(!He)return void Oe(new Error(`Unknown sourceLayer "${Me}"`));if(He.hasDataForBand(Le))return this.updateTextureDescriptor(Me,Le),void Oe(null,this.textureDescriptor?this.textureDescriptor.img:null);const xt=He.getDataRange([Le]);if(qe=Fe.createDecodingTask(xt),!qe||qe.tasks.length)if(this.flushQueues(),this.entireBuffer)l(null,this.entireBuffer.slice(xt.firstByte,xt.lastByte+1));else{const Me=Object.assign({},this.requestParams,{headers:{Range:`bytes=${xt.firstByte}-${xt.lastByte}`}}),Le=F.bj(Me,l);this._fetchQueue.push((()=>{Le.cancel(),qe.cancel()}))}else Oe(null)}updateNeeded(F,Me){return(!this.textureDescriptor||this.textureDescriptor.band!==Me||this.textureDescriptor.layer!==F)&&"errored"!==this.state}updateTextureDescriptor(Me,Le){if(!this._mrt)return;const Oe=this._mrt.getLayer(Me);if(!Oe||!Oe.hasBand(Le)||!Oe.hasDataForBand(Le))return;const{bytes:Fe,tileSize:je,buffer:qe,offset:He,scale:xt}=Oe.getBandView(Le),Pt=je+2*qe,jt=new F.r({width:Pt,height:Pt},Fe),Gt=this.texture;Gt&&Gt instanceof F.T&&Gt.update(jt,{premultiply:!1}),this.textureDescriptor={layer:Me,band:Le,img:jt,buffer:qe,offset:He,tileSize:je,format:Oe.pixelFormat,mix:[xt,256*xt,65536*xt,16777216*xt]}}}class Tt{constructor(F,Me){this.max=F,this.onRemove=Me,this.reset()}reset(){for(const F in this.data)for(const Me of this.data[F])Me.timeout&&clearTimeout(Me.timeout),this.onRemove(Me.value);return this.data={},this.order=[],this}add(F,Me,Le){const Oe=F.wrapped().key;void 0===this.data[Oe]&&(this.data[Oe]=[]);const Fe={value:Me,timeout:void 0};if(void 0!==Le&&(Fe.timeout=setTimeout((()=>{this.remove(F,Fe)}),Le)),this.data[Oe].push(Fe),this.order.push(Oe),this.order.length>this.max){const F=this._getAndRemoveByKey(this.order[0]);F&&this.onRemove(F)}return this}has(F){return F.wrapped().key in this.data}getAndRemove(F){return this.has(F)?this._getAndRemoveByKey(F.wrapped().key):null}_getAndRemoveByKey(F){const Me=this.data[F].shift();return Me.timeout&&clearTimeout(Me.timeout),0===this.data[F].length&&delete this.data[F],this.order.splice(this.order.indexOf(F),1),Me.value}getByKey(F){const Me=this.data[F];return Me?Me[0].value:null}get(F){return this.has(F)?this.data[F.wrapped().key][0].value:null}remove(F,Me){if(!this.has(F))return this;const Le=F.wrapped().key,Oe=void 0===Me?0:this.data[Le].indexOf(Me),Fe=this.data[Le][Oe];return this.data[Le].splice(Oe,1),Fe.timeout&&clearTimeout(Fe.timeout),0===this.data[Le].length&&delete this.data[Le],this.onRemove(Fe.value),this.order.splice(this.order.indexOf(Le),1),this}setMaxSize(F){for(this.max=F;this.order.length>this.max;){const F=this._getAndRemoveByKey(this.order[0]);F&&this.onRemove(F)}return this}filter(F){const Me=[];for(const Le in this.data)for(const Oe of this.data[Le])F(Oe.value)||Me.push(Oe);for(const F of Me)this.remove(F.value.tileID,F)}}class Et{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(Me,Le,Oe){const Fe=String(Le);if(this.stateChanges[Me]=this.stateChanges[Me]||{},this.stateChanges[Me][Fe]=this.stateChanges[Me][Fe]||{},F.l(this.stateChanges[Me][Fe],Oe),null===this.deletedStates[Me]){this.deletedStates[Me]={};for(const F in this.state[Me])F!==Fe&&(this.deletedStates[Me][F]=null)}else if(this.deletedStates[Me]&&null===this.deletedStates[Me][Fe]){this.deletedStates[Me][Fe]={};for(const F in this.state[Me][Fe])Oe[F]||(this.deletedStates[Me][Fe][F]=null)}else for(const F in Oe)this.deletedStates[Me]&&this.deletedStates[Me][Fe]&&null===this.deletedStates[Me][Fe][F]&&delete this.deletedStates[Me][Fe][F]}removeFeatureState(F,Me,Le){if(null===this.deletedStates[F])return;const Oe=String(Me);if(this.deletedStates[F]=this.deletedStates[F]||{},Le&&void 0!==Me)null!==this.deletedStates[F][Oe]&&(this.deletedStates[F][Oe]=this.deletedStates[F][Oe]||{},this.deletedStates[F][Oe][Le]=null);else if(void 0!==Me)if(this.stateChanges[F]&&this.stateChanges[F][Oe])for(Le in this.deletedStates[F][Oe]={},this.stateChanges[F][Oe])this.deletedStates[F][Oe][Le]=null;else this.deletedStates[F][Oe]=null;else this.deletedStates[F]=null}getState(Me,Le){const Oe=this.state[Me]||{},Fe=this.stateChanges[Me]||{},je=this.deletedStates[Me];if(null===je)return{};if(void 0!==Le){const Me=String(Le),qe=F.l({},Oe[Me],Fe[Me]);if(je){const F=je[Le];if(null===F)return{};for(const Me in F)delete qe[Me]}return qe}const qe=F.l({},Oe,Fe);if(je)for(const F in je)delete qe[F];return qe}initializeTileState(F,Me){F.refreshFeatureState(Me)}coalesceChanges(Me,Le){const Oe={};for(const Me in this.stateChanges){this.state[Me]=this.state[Me]||{};const Le={};for(const Oe in this.stateChanges[Me])this.state[Me][Oe]||(this.state[Me][Oe]={}),F.l(this.state[Me][Oe],this.stateChanges[Me][Oe]),Le[Oe]=this.state[Me][Oe];Oe[Me]=Le}for(const Me in this.deletedStates){this.state[Me]=this.state[Me]||{};const Le={};if(null===this.deletedStates[Me])for(const F in this.state[Me])Le[F]={},this.state[Me][F]={};else for(const F in this.deletedStates[Me]){if(null===this.deletedStates[Me][F])this.state[Me][F]={};else if(this.state[Me][F])for(const Le of Object.keys(this.deletedStates[Me][F]))delete this.state[Me][F][Le];Le[F]=this.state[Me][F]}Oe[Me]=Oe[Me]||{},F.l(Oe[Me],Le)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(Oe).length)for(const F in Me)Me[F].refreshFeatureState(Le)}}class St extends F.E{constructor(F,Me,Le){super(),this.id=F,this._onlySymbols=Le,Me.on("data",(F=>{"source"===F.dataType&&"metadata"===F.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===F.dataType&&"content"===F.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),Me.on("error",(()=>{this._sourceErrored=!0})),this._source=Me,this._tiles={},this._cache=new Tt(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=Me.minTileCacheSize,this._maxTileCacheSize=Me.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Et,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(F){this.map=F,this._minTileCacheSize=void 0===this._minTileCacheSize&&F?F._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&F?F._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const F in this._tiles)if(!this._tiles[F].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const F=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,F&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(F,Me){return F.isSymbolTile=this._onlySymbols,F.isExtraShadowCaster=this._shadowCasterTiles[F.tileID.key],this._source.loadTile(F,Me)}_unloadTile(F){if(this._source.unloadTile)return this._source.unloadTile(F)}_abortTile(F){if(this._source.abortTile)return this._source.abortTile(F)}serialize(){return this._source.serialize()}prepare(F){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const Me in this._tiles){const Le=this._tiles[Me];Le.upload(F),Le.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map((F=>F.tileID)).sort(Ct).map((F=>F.key))}getRenderableIds(Me,Le){const Oe=[];for(const F in this._tiles)this._isIdRenderable(+F,Me,Le)&&Oe.push(this._tiles[F]);return Me?Oe.sort(((Me,Le)=>{const Oe=Me.tileID,Fe=Le.tileID,je=new F.P(Oe.canonical.x,Oe.canonical.y)._rotate(this.transform.angle),qe=new F.P(Fe.canonical.x,Fe.canonical.y)._rotate(this.transform.angle);return Oe.overscaledZ-Fe.overscaledZ||qe.y-je.y||qe.x-je.x})).map((F=>F.tileID.key)):Oe.map((F=>F.tileID)).sort(Ct).map((F=>F.key))}hasRenderableParent(F){const Me=this.findLoadedParent(F,0);return!!Me&&this._isIdRenderable(Me.tileID.key)}_isIdRenderable(F,Me,Le){return this._tiles[F]&&this._tiles[F].hasData()&&!this._coveredTiles[F]&&(Me||!this._tiles[F].holdingForFade())&&(Le||!this._shadowCasterTiles[F])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const F in this._tiles)"errored"!==this._tiles[F].state&&this._reloadTile(+F,"reloading")}}_reloadTile(F,Me){const Le=this._tiles[F];Le&&("loading"!==Le.state&&(Le.state=Me),this._loadTile(Le,this._tileLoaded.bind(this,Le,F,Me)))}_tileLoaded(Me,Le,Oe,Fe){if(Fe)if(Me.state="errored",404!==Fe.status)this._source.fire(new F.z(Fe,{tile:Me}));else{if(this._source.fire(new F.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:Me})),!(Me.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const F=this.map.painter.terrain;this.update(this.transform,F.getScaledDemTileSize(),!0),F.resetTileLookupCache(this.id)}else this.update(this.transform)}else Me.timeAdded=F.q.now(),"expired"===Oe&&(Me.refreshedUponExpiration=!0),this._setTileReloadTimer(Le,Me),"raster-dem"===this._source.type&&Me.dem&&this._backfillDEM(Me),this._state.initializeTileState(Me,this.map?this.map.painter:null),this._source.fire(new F.A("data",{dataType:"source",tile:Me,coord:Me.tileID,sourceCacheId:this.id}))}_backfillDEM(F){const Me=this.getRenderableIds();for(let Le=0;Le<Me.length;Le++){const Oe=Me[Le];if(F.neighboringTiles&&F.neighboringTiles[Oe]){const Me=this.getTileByID(Oe);i(F,Me),i(Me,F)}}function i(F,Me){if(!F.dem||F.dem.borderReady)return;F.needsHillshadePrepare=!0,F.needsDEMTextureUpload=!0;let Le=Me.tileID.canonical.x-F.tileID.canonical.x;const Oe=Me.tileID.canonical.y-F.tileID.canonical.y,Fe=Math.pow(2,F.tileID.canonical.z),je=Me.tileID.key;0===Le&&0===Oe||Math.abs(Oe)>1||(Math.abs(Le)>1&&(1===Math.abs(Le+Fe)?Le+=Fe:1===Math.abs(Le-Fe)&&(Le-=Fe)),Me.dem&&F.dem&&(F.dem.backfillBorder(Me.dem,Le,Oe),F.neighboringTiles&&F.neighboringTiles[je]&&(F.neighboringTiles[je].backfilled=!0)))}}getTile(F){return this.getTileByID(F.key)}getTileByID(F){return this._tiles[F]}_retainLoadedChildren(F,Me,Le,Oe){for(const Fe in this._tiles){let je=this._tiles[Fe];if(Oe[Fe]||!je.hasData()||je.tileID.overscaledZ<=Me||je.tileID.overscaledZ>Le)continue;let qe=je.tileID;for(;je&&je.tileID.overscaledZ>Me+1;){const F=je.tileID.scaledTo(je.tileID.overscaledZ-1);je=this._tiles[F.key],je&&je.hasData()&&(qe=F)}let He=qe;for(;He.overscaledZ>Me;)if(He=He.scaledTo(He.overscaledZ-1),F[He.key]){Oe[qe.key]=qe;break}}}findLoadedParent(F,Me){if(F.key in this._loadedParentTiles){const Le=this._loadedParentTiles[F.key];return Le&&Le.tileID.overscaledZ>=Me?Le:null}for(let Le=F.overscaledZ-1;Le>=Me;Le--){const Me=F.scaledTo(Le),Oe=this._getLoadedTile(Me);if(Oe)return Oe}}_getLoadedTile(F){const Me=this._tiles[F.key];return Me&&Me.hasData()?Me:this._cache.getByKey(this._source.reparseOverscaled?F.wrapped().key:F.canonical.key)}updateCacheSize(F,Me){Me=Me||this._source.tileSize;const Le=Math.ceil(F.width/Me)+1,Oe=Math.ceil(F.height/Me)+1,Fe=Math.floor(Le*Oe*5),je="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,Fe):Fe,qe="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,je):je;this._cache.setMaxSize(qe)}handleWrapJump(F){const Me=Math.round((F-(void 0===this._prevLng?F:this._prevLng))/360);if(this._prevLng=F,Me){const F={};for(const Le in this._tiles){const Oe=this._tiles[Le];Oe.tileID=Oe.tileID.unwrapTo(Oe.tileID.wrap+Me),F[Oe.tileID.key]=Oe}this._tiles=F;for(const F in this._timers)clearTimeout(this._timers[F]),delete this._timers[F];for(const F in this._tiles)this._setTileReloadTimer(+F,this._tiles[F])}}update(Me,Le,Oe,Fe){if(this.transform=Me,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!Oe)return;this.updateCacheSize(Me,Le),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const je="batched-model"===this._source.type;let qe,He=this._source.maxzoom;const xt=this.map&&this.map.painter?this.map.painter._terrain:null;if(xt&&xt.sourceCache===this&&xt.attenuationRange()){const F=xt.attenuationRange()[0],Me=Math.floor(F)-Math.log2(xt.getDemUpscale());He>Me&&(He=Me)}if(this.used||this.usedForTerrain){if(this._source.tileID)qe=Me.getVisibleUnwrappedCoordinates(this._source.tileID).map((Me=>new F.aH(Me.canonical.z,Me.wrap,Me.canonical.z,Me.canonical.x,Me.canonical.y)));else if(0!==this.tileCoverLift){const Fe=Me.clone();Fe.tileCoverLift=this.tileCoverLift,qe=Fe.coveringTiles({tileSize:Le||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:He,roundZoom:this._source.roundZoom&&!Oe,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:je}),this._source.minzoom<=1&&"globe"===Me.projection.name&&(qe.push(new F.aH(1,0,1,0,0)),qe.push(new F.aH(1,0,1,1,0)),qe.push(new F.aH(1,0,1,0,1)),qe.push(new F.aH(1,0,1,1,1)))}else if(qe=Me.coveringTiles({tileSize:Le||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:He,roundZoom:this._source.roundZoom&&!Oe,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:je}),this._source.hasTile){const F=this._source.hasTile.bind(this._source);qe=qe.filter((Me=>F(Me)))}}else qe=[];if(qe.length>0&&this.castsShadows&&Fe&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!It(this._source.type)){const F=Me.coveringZoomLevel({tileSize:Le||this._source.tileSize,roundZoom:this._source.roundZoom&&!Oe}),He=Math.min(F,this._source.maxzoom);if(je){const F=Me.extendTileCover(qe,He);for(const Me of F)qe.push(Me)}else{const F=Me.extendTileCover(qe,He,Fe);for(const Me of F)this._shadowCasterTiles[Me.key]=!0,qe.push(Me)}}const Pt=this._updateRetainedTiles(qe);if(It(this._source.type)&&0!==qe.length){const Me={},Le={},Oe=Object.keys(Pt);for(const Fe of Oe){const Oe=Pt[Fe],je=this._tiles[Fe];if(!je||je.fadeEndTime&&je.fadeEndTime<=F.q.now())continue;const qe=this.findLoadedParent(Oe,Math.max(Oe.overscaledZ-St.maxOverzooming,this._source.minzoom));qe&&(this._addTile(qe.tileID),Me[qe.tileID.key]=qe.tileID),Le[Fe]=Oe}const Fe=qe[qe.length-1].overscaledZ;for(const F in this._tiles){const Me=this._tiles[F];if(Pt[F]||!Me.hasData())continue;let Oe=Me.tileID;for(;Oe.overscaledZ>Fe;){Oe=Oe.scaledTo(Oe.overscaledZ-1);const Fe=this._tiles[Oe.key];if(Fe&&Fe.hasData()&&Le[Oe.key]){Pt[F]=Me.tileID;break}}}for(const F in Me)Pt[F]||(this._coveredTiles[F]=!0,Pt[F]=Me[F])}for(const F in Pt)this._tiles[F].clearFadeHold();const jt=F.bk(this._tiles,Pt);for(const F of jt){const Me=this._tiles[F];Me.hasSymbolBuckets&&!Me.holdingForFade()?Me.setHoldDuration(this.map._fadeDuration):Me.hasSymbolBuckets&&!Me.symbolFadeFinished()||this._removeTile(+F)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const F in this._tiles)this._tiles[F].holdingForFade()&&this._removeTile(+F)}_updateRetainedTiles(F){const Me={};if(0===F.length)return Me;const Le={},Oe=F.reduce(((F,Me)=>Math.min(F,Me.overscaledZ)),1/0),Fe=F[0].overscaledZ,je=Math.max(Fe-St.maxOverzooming,this._source.minzoom),qe=Math.max(Fe+St.maxUnderzooming,this._source.minzoom),He={};for(const Le of F){const F=this._addTile(Le);Me[Le.key]=Le,F.hasData()||Oe<this._source.maxzoom&&(He[Le.key]=Le)}this._retainLoadedChildren(He,Oe,qe,Me);for(const Oe of F){let F=this._tiles[Oe.key];if(F.hasData())continue;if(Oe.canonical.z>=this._source.maxzoom){const F=Oe.children(this._source.maxzoom)[0],Le=this.getTile(F);if(Le&&Le.hasData()){Me[F.key]=F;continue}}else{const F=Oe.children(this._source.maxzoom);if(Me[F[0].key]&&Me[F[1].key]&&Me[F[2].key]&&Me[F[3].key])continue}let Fe=F.wasRequested();for(let qe=Oe.overscaledZ-1;qe>=je;--qe){const je=Oe.scaledTo(qe);if(Le[je.key])break;if(Le[je.key]=!0,F=this.getTile(je),!F&&Fe&&(F=this._addTile(je)),F&&(Me[je.key]=je,Fe=F.wasRequested(),F.hasData()))break}}return Me}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const F in this._tiles){const Me=[];let Le,Oe=this._tiles[F].tileID;for(;Oe.overscaledZ>0;){if(Oe.key in this._loadedParentTiles){Le=this._loadedParentTiles[Oe.key];break}Me.push(Oe.key);const F=Oe.scaledTo(Oe.overscaledZ-1);if(Le=this._getLoadedTile(F),Le)break;Oe=F}for(const F of Me)this._loadedParentTiles[F]=Le}}_addTile(Me){let Le=this._tiles[Me.key];if(Le)return!0!==Le.isExtraShadowCaster||!!this._shadowCasterTiles[Me.key]||this._reloadTile(Me.key,"reloading"),Le;Le=this._cache.getAndRemove(Me),Le&&(this._setTileReloadTimer(Me.key,Le),Le.tileID=Me,this._state.initializeTileState(Le,this.map?this.map.painter:null),this._cacheTimers[Me.key]&&(clearTimeout(this._cacheTimers[Me.key]),delete this._cacheTimers[Me.key],this._setTileReloadTimer(Me.key,Le)));const Oe=Boolean(Le);if(!Oe){const F=this.map?this.map.painter:null,Oe=this._source.tileSize*Me.overscaleFactor();Le="raster-array"===this._source.type?new wt(Me,Oe,this.transform.tileZoom,F,this._isRaster):new bt(Me,Oe,this.transform.tileZoom,F,this._isRaster),this._loadTile(Le,this._tileLoaded.bind(this,Le,Me.key,Le.state))}return Le?(Le.uses++,this._tiles[Me.key]=Le,Oe||this._source.fire(new F.A("dataloading",{tile:Le,coord:Le.tileID,dataType:"source"})),Le):null}_setTileReloadTimer(F,Me){F in this._timers&&(clearTimeout(this._timers[F]),delete this._timers[F]);const Le=Me.getExpiryTimeout();Le&&(this._timers[F]=setTimeout((()=>{this._reloadTile(F,"expired"),delete this._timers[F]}),Le))}_removeTile(F){const Me=this._tiles[F];Me&&(Me.uses--,delete this._tiles[F],this._timers[F]&&(clearTimeout(this._timers[F]),delete this._timers[F]),Me.uses>0||(Me.hasData()&&"reloading"!==Me.state||"empty"===Me.state?this._cache.add(Me.tileID,Me,Me.getExpiryTimeout()):(Me.aborted=!0,this._abortTile(Me),this._unloadTile(Me))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const F in this._tiles)this._removeTile(+F);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(Me,Le,Oe){const Fe=[],je=this.transform;if(!je)return Fe;const qe="globe"===je.projection.name,He=F.av(je.center.lng);for(const xt in this._tiles){const Pt=this._tiles[xt];if(Oe&&Pt.clearQueryDebugViz(),Pt.holdingForFade())continue;let jt;if(qe){const Me=Pt.tileID.canonical;if(0===Me.z){const Le=[Math.abs(F.ay(He,...Rt(Me,-1))-He),Math.abs(F.ay(He,...Rt(Me,1))-He)];jt=[0,2*Le.indexOf(Math.min(...Le))-1]}else{const Le=[Math.abs(F.ay(He,...Rt(Me,-1))-He),Math.abs(F.ay(He,...Rt(Me,0))-He),Math.abs(F.ay(He,...Rt(Me,1))-He)];jt=[Le.indexOf(Math.min(...Le))-1]}}else jt=[0];for(const F of jt){const Oe=Me.containsTile(Pt,je,Le,F);Oe&&Fe.push(Oe)}}return Fe}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(F){return this._getRenderableCoordinates(F)}_getRenderableCoordinates(F,Me){const Le=this.getRenderableIds(F,Me).map((F=>this._tiles[F].tileID)),Oe="globe"===this.transform.projection.name;for(const F of Le)F.projMatrix=this.transform.calculateProjMatrix(F.toUnwrapped()),F.expandedProjMatrix=Oe?this.transform.calculateProjMatrix(F.toUnwrapped(),!1,!0):F.projMatrix;return Le}sortCoordinatesByDistance(F){const Me=F.slice(),Le=this.transform._camera.position,Oe=this.transform._camera.forward(),Fe={};for(const F of Me){const Me=1/(1<<F.canonical.z);Fe[F.key]=((F.canonical.x+.5)*Me+F.wrap-Le[0])*Oe[0]+((F.canonical.y+.5)*Me-Le[1])*Oe[1]-Le[2]*Oe[2]}return Me.sort(((F,Me)=>Fe[F.key]-Fe[Me.key])),Me}hasTransition(){if(this._source.hasTransition())return!0;if(It(this._source.type))for(const Me in this._tiles){const Le=this._tiles[Me];if(void 0!==Le.fadeEndTime&&Le.fadeEndTime>=F.q.now())return!0}return!1}setFeatureState(F,Me,Le){this._state.updateState(F=F||"_geojsonTileLayer",Me,Le)}removeFeatureState(F,Me,Le){this._state.removeFeatureState(F=F||"_geojsonTileLayer",Me,Le)}getFeatureState(F,Me){return this._state.getState(F=F||"_geojsonTileLayer",Me)}setDependencies(F,Me,Le){const Oe=this._tiles[F];Oe&&Oe.setDependencies(Me,Le)}reloadTilesForDependencies(F,Me){for(const Le in this._tiles)this._tiles[Le].hasDependency(F,Me)&&this._reloadTile(+Le,"reloading");this._cache.filter((Le=>!Le.hasDependency(F,Me)))}_preloadTiles(Me,Le){if(!this._sourceLoaded){const e=()=>{this._sourceLoaded&&(this._source.off("data",e),this._preloadTiles(Me,Le))};return void this._source.on("data",e)}const Oe=new Map,Fe=Array.isArray(Me)?Me:[Me],je=this.map.painter.terrain,qe=this.usedForTerrain&&je?je.getScaledDemTileSize():this._source.tileSize;for(const F of Fe){const Me=F.coveringTiles({tileSize:qe,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const F of Me)Oe.set(F.key,F);this.usedForTerrain&&F.updateElevation(!1)}const He=Array.from(Oe.values());F.bl(He,((F,Me)=>{const Le=new bt(F,this._source.tileSize*F.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(Le,(F=>{"raster-dem"===this._source.type&&Le.dem&&this._backfillDEM(Le),Me(F,Le)}))}),Le)}}function Ct(F,Me){const Le=Math.abs(2*F.wrap)-+(F.wrap<0),Oe=Math.abs(2*Me.wrap)-+(Me.wrap<0);return F.overscaledZ-Me.overscaledZ||Oe-Le||Me.canonical.y-F.canonical.y||Me.canonical.x-F.canonical.x}function It(F){return"raster"===F||"image"===F||"video"===F||"custom"===F}function Rt(F,Me){const Le=1<<F.z;return[F.x/Le+Me,(F.x+1)/Le+Me]}St.maxOverzooming=10,St.maxUnderzooming=3;class Dt{constructor(F){this.style=F,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const F=!1,Me=!1;for(const Le in this.style._mergedLayers){const Oe=this.style._mergedLayers[Le];if("fill-extrusion"===Oe.type)this.layers.push({layer:Oe,visible:F,visibilityChanged:Me});else if("model"===Oe.type){const Le=this.style.getLayerSource(Oe);Le&&"batched-model"===Le.type&&this.layers.push({layer:Oe,visible:F,visibilityChanged:Me})}}}onNewFrame(F){this.layersGotHidden=!1;for(const Me of this.layers){const Le=Me.layer;let Oe=!1;"fill-extrusion"===Le.type?Oe=!Le.isHidden(F)&&Le.paint.get("fill-extrusion-opacity")>0:"model"===Le.type&&(Oe=!Le.isHidden(F)&&Le.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!Oe&&Me.visible,Me.visible=Oe}}updateZOffset(F,Me){this.currentBuildingBuckets=[];for(const F of this.layers){const Le=F.layer,Oe=this.style.getLayerSourceCache(Le);let Fe=1;"fill-extrusion"===Le.type&&(Fe=F.visible?Le.paint.get("fill-extrusion-vertical-scale"):0);let je=Oe?Oe.getTile(Me):null;if(!je&&Oe&&Me.canonical.z>Oe.getSource().minzoom){let F=Me.scaledTo(Math.min(Oe.getSource().maxzoom,Me.overscaledZ-1));for(;F.overscaledZ>=Oe.getSource().minzoom&&(je=Oe.getTile(F),!je&&0!==F.overscaledZ);)F=F.scaledTo(F.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:je?je.getBucket(Le):null,tileID:je?je.tileID:Me,verticalScale:Fe})}F.hasAnyZOffset=!1;let Le=!1;for(let Oe=0;Oe<F.symbolInstances.length;Oe++){const Fe=F.symbolInstances.get(Oe),je=Fe.zOffset,qe=this._getHeightAtTileOffset(Me,Fe.tileAnchorX,Fe.tileAnchorY);Fe.zOffset=qe!==Number.NEGATIVE_INFINITY?qe:je,Le||je===Fe.zOffset||(Le=!0),F.hasAnyZOffset||0===Fe.zOffset||(F.hasAnyZOffset=!0)}Le&&(F.zOffsetBuffersNeedUpload=!0,F.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(Me,Le,Oe,Fe){let je=Le,qe=Oe;if(Me.canonical.z!==Fe.canonical.z){const He=Fe.canonical,xt=1/(1<<Me.canonical.z-He.z);je=(Le+Me.canonical.x*F.ai)*xt-He.x*F.ai|0,qe=(Oe+Me.canonical.y*F.ai)*xt-He.y*F.ai|0}return{tileX:je,tileY:qe}}_getHeightAtTileOffset(F,Me,Le){let Oe,Fe;for(let je=0;je<this.layers.length;++je){if("fill-extrusion"!==this.layers[je].layer.type)continue;const{bucket:qe,tileID:He,verticalScale:xt}=this.currentBuildingBuckets[je];if(!qe)continue;const{tileX:Pt,tileY:jt}=this._mapCoordToOverlappingTile(F,Me,Le,He),Gt=qe.getHeightAtTileCoord(Pt,jt);Gt&&void 0!==Gt.height&&(Gt.hidden?Oe=Gt.height:Fe=Math.max(Gt.height*xt,Fe||0))}if(void 0!==Fe)return Fe;for(let Fe=0;Fe<this.layers.length;++Fe){const je=this.layers[Fe];if("model"!==je.layer.type||!je.visible)continue;const{bucket:qe,tileID:He}=this.currentBuildingBuckets[Fe];if(!qe)continue;const{tileX:xt,tileY:Pt}=this._mapCoordToOverlappingTile(F,Me,Le,He),jt=qe.getHeightAtTileCoord(xt,Pt);if(jt&&!jt.hidden)return void 0===jt.height&&void 0!==Oe?Math.min(jt.maxHeight,Oe)*jt.verticalScale:jt.height?jt.height*jt.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function At(Me,Le){const Oe={};for(const F in Me)"ref"!==F&&(Oe[F]=Me[F]);return F.bm.forEach((F=>{F in Le&&(Oe[F]=Le[F])})),Oe}function Lt(F){F=F.slice();const Me=Object.create(null);for(let Le=0;Le<F.length;Le++)Me[F[Le].id]=F[Le];for(let Le=0;Le<F.length;Le++)"ref"in F[Le]&&(F[Le]=At(F[Le],Me[F[Le].ref]));return F}const eh={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Mt(F,Me,Le){Le.push({command:eh.addSource,args:[F,Me[F]]})}function zt(F,Me,Le){Me.push({command:eh.removeSource,args:[F]}),Le[F]=!0}function Ot(F,Me,Le,Oe){zt(F,Le,Oe),Mt(F,Me,Le)}function Ft(Me,Le,Oe){let Fe;for(Fe in Me[Oe])if(Me[Oe].hasOwnProperty(Fe)&&"data"!==Fe&&!F.bn(Me[Oe][Fe],Le[Oe][Fe]))return!1;for(Fe in Le[Oe])if(Le[Oe].hasOwnProperty(Fe)&&"data"!==Fe&&!F.bn(Me[Oe][Fe],Le[Oe][Fe]))return!1;return!0}function kt(Me,Le,Oe,Fe,je,qe){let He;for(He in Le=Le||{},Me=Me||{})Me.hasOwnProperty(He)&&(F.bn(Me[He],Le[He])||Oe.push({command:qe,args:[Fe,He,Le[He],je]}));for(He in Le)Le.hasOwnProperty(He)&&!Me.hasOwnProperty(He)&&(F.bn(Me[He],Le[He])||Oe.push({command:qe,args:[Fe,He,Le[He],je]}))}function Bt(F){return F.id}function Nt(F,Me){return F[Me.id]=Me,F}class Ut{constructor(F,Me){this.reset(F,Me)}reset(F,Me){this.points=F||[],this._distances=[0];for(let F=1;F<this.points.length;F++)this._distances[F]=this._distances[F-1]+this.points[F].dist(this.points[F-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(Me||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(Me){if(1===this.points.length)return this.points[0];Me=F.ay(Me,0,1);let Le=1,Oe=this._distances[Le];const Fe=Me*this.paddedLength+this.padding;for(;Oe<Fe&&Le<this._distances.length;)Oe=this._distances[++Le];const je=Le-1,qe=this._distances[je],He=Oe-qe,xt=He>0?(Fe-qe)/He:0;return this.points[je].mult(1-xt).add(this.points[Le].mult(xt))}}class Vt{constructor(F,Me,Le){const Oe=this.boxCells=[],Fe=this.circleCells=[];this.xCellCount=Math.ceil(F/Le),this.yCellCount=Math.ceil(Me/Le);for(let F=0;F<this.xCellCount*this.yCellCount;F++)Oe.push([]),Fe.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=F,this.height=Me,this.xScale=this.xCellCount/F,this.yScale=this.yCellCount/Me,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(F,Me,Le,Oe,Fe){this._forEachCell(Me,Le,Oe,Fe,this._insertBoxCell,this.boxUid++),this.boxKeys.push(F),this.bboxes.push(Me),this.bboxes.push(Le),this.bboxes.push(Oe),this.bboxes.push(Fe)}insertCircle(F,Me,Le,Oe){this._forEachCell(Me-Oe,Le-Oe,Me+Oe,Le+Oe,this._insertCircleCell,this.circleUid++),this.circleKeys.push(F),this.circles.push(Me),this.circles.push(Le),this.circles.push(Oe)}_insertBoxCell(F,Me,Le,Oe,Fe,je){this.boxCells[Fe].push(je)}_insertCircleCell(F,Me,Le,Oe,Fe,je){this.circleCells[Fe].push(je)}_query(F,Me,Le,Oe,Fe,je){if(Le<0||F>this.width||Oe<0||Me>this.height)return!Fe&&[];const qe=[];if(F<=0&&Me<=0&&this.width<=Le&&this.height<=Oe){if(Fe)return!0;for(let F=0;F<this.boxKeys.length;F++)qe.push({key:this.boxKeys[F],x1:this.bboxes[4*F],y1:this.bboxes[4*F+1],x2:this.bboxes[4*F+2],y2:this.bboxes[4*F+3]});for(let F=0;F<this.circleKeys.length;F++){const Me=this.circles[3*F],Le=this.circles[3*F+1],Oe=this.circles[3*F+2];qe.push({key:this.circleKeys[F],x1:Me-Oe,y1:Le-Oe,x2:Me+Oe,y2:Le+Oe})}return je?qe.filter(je):qe}return this._forEachCell(F,Me,Le,Oe,this._queryCell,qe,{hitTest:Fe,seenUids:{box:{},circle:{}}},je),Fe?qe.length>0:qe}_queryCircle(F,Me,Le,Oe,Fe){const je=F-Le,qe=F+Le,He=Me-Le,xt=Me+Le;if(qe<0||je>this.width||xt<0||He>this.height)return!Oe&&[];const Pt=[];return this._forEachCell(je,He,qe,xt,this._queryCellCircle,Pt,{hitTest:Oe,circle:{x:F,y:Me,radius:Le},seenUids:{box:{},circle:{}}},Fe),Oe?Pt.length>0:Pt}query(F,Me,Le,Oe,Fe){return this._query(F,Me,Le,Oe,!1,Fe)}hitTest(F,Me,Le,Oe,Fe){return this._query(F,Me,Le,Oe,!0,Fe)}hitTestCircle(F,Me,Le,Oe){return this._queryCircle(F,Me,Le,!0,Oe)}_queryCell(F,Me,Le,Oe,Fe,je,qe,He){const xt=qe.seenUids,Pt=this.boxCells[Fe];if(null!==Pt){const Fe=this.bboxes;for(const jt of Pt)if(!xt.box[jt]){xt.box[jt]=!0;const Pt=4*jt;if(F<=Fe[Pt+2]&&Me<=Fe[Pt+3]&&Le>=Fe[Pt+0]&&Oe>=Fe[Pt+1]&&(!He||He(this.boxKeys[jt]))){if(qe.hitTest)return je.push(!0),!0;je.push({key:this.boxKeys[jt],x1:Fe[Pt],y1:Fe[Pt+1],x2:Fe[Pt+2],y2:Fe[Pt+3]})}}}const jt=this.circleCells[Fe];if(null!==jt){const Fe=this.circles;for(const Pt of jt)if(!xt.circle[Pt]){xt.circle[Pt]=!0;const jt=3*Pt;if(this._circleAndRectCollide(Fe[jt],Fe[jt+1],Fe[jt+2],F,Me,Le,Oe)&&(!He||He(this.circleKeys[Pt]))){if(qe.hitTest)return je.push(!0),!0;{const F=Fe[jt],Me=Fe[jt+1],Le=Fe[jt+2];je.push({key:this.circleKeys[Pt],x1:F-Le,y1:Me-Le,x2:F+Le,y2:Me+Le})}}}}}_queryCellCircle(F,Me,Le,Oe,Fe,je,qe,He){const xt=qe.circle,Pt=qe.seenUids,jt=this.boxCells[Fe];if(null!==jt){const F=this.bboxes;for(const Me of jt)if(!Pt.box[Me]){Pt.box[Me]=!0;const Le=4*Me;if(this._circleAndRectCollide(xt.x,xt.y,xt.radius,F[Le+0],F[Le+1],F[Le+2],F[Le+3])&&(!He||He(this.boxKeys[Me])))return je.push(!0),!0}}const Gt=this.circleCells[Fe];if(null!==Gt){const F=this.circles;for(const Me of Gt)if(!Pt.circle[Me]){Pt.circle[Me]=!0;const Le=3*Me;if(this._circlesCollide(F[Le],F[Le+1],F[Le+2],xt.x,xt.y,xt.radius)&&(!He||He(this.circleKeys[Me])))return je.push(!0),!0}}}_forEachCell(F,Me,Le,Oe,Fe,je,qe,He){const xt=this._convertToXCellCoord(F),Pt=this._convertToYCellCoord(Me),jt=this._convertToXCellCoord(Le),Gt=this._convertToYCellCoord(Oe);for(let bi=xt;bi<=jt;bi++)for(let xt=Pt;xt<=Gt;xt++)if(Fe.call(this,F,Me,Le,Oe,this.xCellCount*xt+bi,je,qe,He))return}_convertToXCellCoord(F){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(F*this.xScale)))}_convertToYCellCoord(F){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(F*this.yScale)))}_circlesCollide(F,Me,Le,Oe,Fe,je){const qe=Oe-F,He=Fe-Me,xt=Le+je;return xt*xt>qe*qe+He*He}_circleAndRectCollide(F,Me,Le,Oe,Fe,je,qe){const He=(je-Oe)/2,xt=Math.abs(F-(Oe+He));if(xt>He+Le)return!1;const Pt=(qe-Fe)/2,jt=Math.abs(Me-(Fe+Pt));if(jt>Pt+Le)return!1;if(xt<=He||jt<=Pt)return!0;const Gt=xt-He,bi=jt-Pt;return Gt*Gt+bi*bi<=Le*Le}}const th={unknown:0,flipRequired:1,flipNotRequired:2},rh=Math.tan(85*Math.PI/180);function qt(Me,Le,Oe,Fe,je,qe,He){const xt=F.ad.mat4.create();if(Oe)if("globe"===qe.name){const Me=F.bo(je,Le);F.ad.mat4.multiply(xt,xt,Me)}else{const Me=F.ad.mat2.invert([],He);xt[0]=Me[0],xt[1]=Me[1],xt[4]=Me[2],xt[5]=Me[3],Fe||F.ad.mat4.rotateZ(xt,xt,je.angle)}else F.ad.mat4.multiply(xt,je.labelPlaneMatrix,Me);return xt}function Ht(F,Me,Le,Oe,Fe,je,qe){const He=qt(F,Me,Le,Oe,Fe,je,qe);return"globe"===je.name&&Le||(He[2]=He[6]=He[10]=He[14]=0),He}function Zt(Me,Le,Oe,Fe,je,qe,He){if(Oe){if("globe"===qe.name){const xt=qt(Me,Le,Oe,Fe,je,qe,He);return F.ad.mat4.invert(xt,xt),F.ad.mat4.multiply(xt,Me,xt),xt}{const Le=F.ad.mat4.clone(Me),Oe=F.ad.mat4.identity([]);return Oe[0]=He[0],Oe[1]=He[1],Oe[4]=He[2],Oe[5]=He[3],F.ad.mat4.multiply(Le,Le,Oe),Fe||F.ad.mat4.rotateZ(Le,Le,-je.angle),Le}}return je.glCoordMatrix}function Wt(Me,Le,Oe,Fe){const je=[Me,Le,Oe,1];Oe?F.ad.vec4.transformMat4(je,je,Fe):si(je,je,Fe);const qe=je[3];return je[0]/=qe,je[1]/=qe,je[2]/=qe,je}function $t(F,Me){return Math.min(.5+F/Me*.5,1.5)}function Xt(F,Me){const Le=F[0]/F[3],Oe=F[1]/F[3];return Le>=-Me[0]&&Le<=Me[0]&&Oe>=-Me[1]&&Oe<=Me[1]}function Kt(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt){const Gt=Oe.transform,bi=Fe?Me.textSizeData:Me.iconSizeData,wi=F.bp(bi,Oe.transform.zoom),qr="globe"===Gt.projection.name,Xn=[256/Oe.width*2+1,256/Oe.height*2+1],Yn=Fe?Me.text.dynamicLayoutVertexArray:Me.icon.dynamicLayoutVertexArray;Yn.clear();let yo=null;qr&&(yo=Fe?Me.text.globeExtVertexArray:Me.icon.globeExtVertexArray);const bo=Me.lineVertexArray,Ro=Fe?Me.text.placedSymbolArray:Me.icon.placedSymbolArray,Do=Oe.transform.width/Oe.transform.height;let zs,Zs=!1;for(let Fe=0;Fe<Ro.length;Fe++){const qr=Ro.get(Fe),{numGlyphs:na,writingMode:el}=qr;if(el!==F.bq.vertical||Zs||zs===F.bq.horizontal||(Zs=!0),zs=el,(qr.hidden||el===F.bq.vertical)&&!Zs){oi(na,Yn);continue}Zs=!1;const nl=new F.P(qr.tileAnchorX,qr.tileAnchorY);let{x:hl,y:pl,z:bl}=Gt.projection.projectTilePoint(nl.x,nl.y,jt.canonical);if(Pt){const[F,Me,Le]=Pt(nl);hl+=F,pl+=Me,bl+=Le}const Tl=[hl,pl,bl,1];if(F.ad.vec4.transformMat4(Tl,Tl,Le),!Xt(Tl,Xn)){oi(na,Yn);continue}const kl=Tl[3],ec=$t(Oe.transform.getCameraToCenterDistance(Gt.projection),kl),tc=F.br(bi,wi,qr),ic=He?tc/ec:tc*ec,oc=Wt(hl,pl,bl,je);if(oc[3]<=0){oi(na,Yn);continue}let sc={};const ac=F.ak(Me.layers[0].layout.get("text-max-angle")),mc=Math.cos(ac),gc=He?null:Pt,yc=Qt(qr,ic,!1,xt,Le,je,qe,Me.glyphOffsetArray,bo,Yn,yo,oc,nl,sc,Do,gc,Gt.projection,jt,He,mc);Zs=yc.useVertical,gc&&yc.needsFlipping&&(sc={}),(yc.notEnoughRoom||Zs||yc.needsFlipping&&Qt(qr,ic,!0,xt,Le,je,qe,Me.glyphOffsetArray,bo,Yn,yo,oc,nl,sc,Do,gc,Gt.projection,jt,He,mc).notEnoughRoom)&&oi(na,Yn)}Fe?(Me.text.dynamicLayoutVertexBuffer.updateData(Yn),yo&&Me.text.globeExtVertexBuffer&&Me.text.globeExtVertexBuffer.updateData(yo)):(Me.icon.dynamicLayoutVertexBuffer.updateData(Yn),yo&&Me.icon.globeExtVertexBuffer&&Me.icon.globeExtVertexBuffer.updateData(yo))}function Yt(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn){const{lineStartIndex:yo,glyphStartIndex:bo,segment:Ro}=He,Do=bo+He.numGlyphs,zs=yo+He.lineLength,Zs=Me.getoffsetX(bo),na=Me.getoffsetX(Do-1),el=ii(F*Zs,Le,Oe,Fe,je,qe,Ro,yo,zs,xt,Pt,jt,Gt,bi,!0,wi,qr,Xn,Yn);if(!el)return null;const nl=ii(F*na,Le,Oe,Fe,je,qe,Ro,yo,zs,xt,Pt,jt,Gt,bi,!0,wi,qr,Xn,Yn);return nl?{first:el,last:nl}:null}function Jt(Me,Le,Oe,Fe){return Me===F.bq.horizontal&&Math.abs(Fe)>Math.abs(Oe)?{useVertical:!0}:Me===F.bq.vertical?Fe>0?{needsFlipping:!0}:null:Le!==th.unknown&&function(F,Me){return 0===F||Math.abs(Me/F)>rh}(Oe,Fe)?Le===th.flipRequired?{needsFlipping:!0}:null:Oe<0?{needsFlipping:!0}:null}function Qt(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do){const zs=Le/24,Zs=Me.lineOffsetX*zs,na=Me.lineOffsetY*zs,{lineStartIndex:el,glyphStartIndex:nl,numGlyphs:hl,segment:pl,writingMode:bl,flipState:Tl}=Me,kl=el+Me.lineLength,L=Me=>{if(Gt){const[Le,Oe,Fe]=Me.up,je=jt.length;F.bs(Gt,je+0,Le,Oe,Fe),F.bs(Gt,je+1,Le,Oe,Fe),F.bs(Gt,je+2,Le,Oe,Fe),F.bs(Gt,je+3,Le,Oe,Fe)}const[Le,Oe,Fe]=Me.point;F.bt(jt,Le,Oe,Fe,Me.angle)};if(hl>1){const F=Yt(zs,xt,Zs,na,Oe,bi,wi,Me,Pt,qe,qr,Yn,!1,yo,bo,Ro,Do);if(!F)return{notEnoughRoom:!0};if(Fe&&!Oe){let[Le,Oe,Fe]=F.first.point,[je,qe,xt]=F.last.point;[Le,Oe]=Wt(Le,Oe,Fe,He),[je,qe]=Wt(je,qe,xt,He);const Pt=Jt(bl,Tl,(je-Le)*Xn,qe-Oe);if(Me.flipState=Pt&&Pt.needsFlipping?th.flipRequired:th.flipNotRequired,Pt)return Pt}L(F.first);for(let F=nl+1;F<nl+hl-1;F++){const Me=ii(zs*xt.getoffsetX(F),Zs,na,Oe,bi,wi,pl,el,kl,Pt,qe,qr,Yn,!1,!1,yo,bo,Ro,Do);if(!Me)return jt.length-=4*(F-nl),{notEnoughRoom:!0};L(Me)}L(F.last)}else{if(Fe&&!Oe){const Le=Wt(wi.x,wi.y,0,je),Oe=el+pl+1,Fe=new F.P(Pt.getx(Oe),Pt.gety(Oe)),qe=Wt(Fe.x,Fe.y,0,je),He=qe[3]>0?qe:ti(wi,Fe,Le,1,je,void 0,yo,bo.canonical),xt=Jt(bl,Tl,(He[0]-Le[0])*Xn,He[1]-Le[1]);if(Me.flipState=xt&&xt.needsFlipping?th.flipRequired:th.flipNotRequired,xt)return xt}const Le=ii(zs*xt.getoffsetX(nl),Zs,na,Oe,bi,wi,pl,el,kl,Pt,qe,qr,Yn,!1,!1,yo,bo,Ro,Do);if(!Le)return{notEnoughRoom:!0};L(Le)}return{}}function ei(F,Me,Le,Oe,Fe){const{x:je,y:qe,z:He}=Oe.projectTilePoint(F.x,F.y,Me);if(!Fe)return Wt(je,qe,He,Le);const[xt,Pt,jt]=Fe(F);return Wt(je+xt,qe+Pt,He+jt,Le)}function ti(Me,Le,Oe,Fe,je,qe,He,xt){const Pt=ei(Me.sub(Le)._unit()._add(Me),xt,je,He,qe);return F.ad.vec3.sub(Pt,Oe,Pt),F.ad.vec3.normalize(Pt,Pt),F.ad.vec3.scaleAndAdd(Pt,Oe,Pt,Fe)}function ii(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro){const Do=Fe?Me-Le:Me+Le;let zs=Do>0?1:-1,Zs=0;Fe&&(zs*=-1,Zs=Math.PI),zs<0&&(Zs+=Math.PI);let na=xt+He+(zs>0?0:1)|0,el=je,nl=je,hl=0,pl=0;const bl=Math.abs(Do),Tl=[],kl=[];let ec=qe,tc=ec,ic=F.ad.vec3.zero([]);const z=()=>ti(tc,ec,nl,bl-hl+1,Gt,wi,Yn,yo.canonical);for(;hl+pl<=bl;){if(na+=zs,na<xt||na>=Pt)return null;if(nl=el,tc=ec,Tl.push(nl),qr&&kl.push(tc),ec=new F.P(jt.getx(na),jt.gety(na)),el=bi[na],!el){const F=ei(ec,yo.canonical,Gt,Yn,wi);el=F[3]>0?bi[na]=F:z()}hl+=pl;const Me=F.ad.vec3.sub([],el,nl),Le=F.ad.vec3.distance(nl,el);if(Oe&&Le>0&&pl>0&&F.ad.vec3.dot(ic,Me)/(pl*Le)<Ro)return null;pl=Le,ic=Me}Xn&&wi&&(bi[na]&&(el=z(),pl=F.ad.vec3.distance(nl,el),ic=F.ad.vec3.sub([],el,nl)),bi[na]=el);const oc=(bl-hl)/pl,sc=ec.sub(tc)._mult(oc)._add(tc),ac=F.ad.vec3.scaleAndAdd([],nl,ic,oc);let mc=[0,0,1],gc=ic[0],yc=ic[1];if(bo&&(mc=Yn.upVector(yo.canonical,sc.x,sc.y),0!==mc[0]||0!==mc[1]||1!==mc[2])){const Me=[mc[2],0,-mc[0]],Le=F.ad.vec3.cross([],mc,Me);F.ad.vec3.normalize(Me,Me),F.ad.vec3.normalize(Le,Le),gc=F.ad.vec3.dot(ic,Me),yc=F.ad.vec3.dot(ic,Le)}if(Oe){const Me=F.ad.vec3.cross([],mc,ic);F.ad.vec3.normalize(Me,Me),F.ad.vec3.scaleAndAdd(ac,ac,Me,Oe*zs)}const xc=Zs+Math.atan2(yc,gc);return Tl.push(ac),qr&&kl.push(sc),{point:ac,angle:xc,path:Tl,tilePath:kl,up:mc}}function oi(F,Me){const Le=Me.length,Oe=Le+4*F;Me.resize(Oe),Me.float32.fill(-1/0,4*Le,4*Oe)}function si(F,Me,Le){const Oe=Me[0],Fe=Me[1];return F[0]=Le[0]*Oe+Le[4]*Fe+Le[12],F[1]=Le[1]*Oe+Le[5]*Fe+Le[13],F[3]=Le[3]*Oe+Le[7]*Fe+Le[15],F}const oh=100;class ni{constructor(F,Me,Le=new Vt(F.width+200,F.height+200,25),Oe=new Vt(F.width+200,F.height+200,25)){this.transform=F,this.grid=Le,this.ignoredGrid=Oe,this.pitchfactor=Math.cos(F._pitch)*F.cameraToCenterDistance,this.screenRightBoundary=F.width+oh,this.screenBottomBoundary=F.height+oh,this.gridRightBoundary=F.width+200,this.gridBottomBoundary=F.height+200,this.fogState=Me}placeCollisionBox(F,Me,Le,Oe,Fe,je,qe,He){let xt=Le.projectedAnchorX,Pt=Le.projectedAnchorY,jt=Le.projectedAnchorZ;const Gt=Le.elevation,bi=Le.tileID,wi=F.getProjection();if(Gt&&bi){const[F,Me,Oe]=wi.upVector(bi.canonical,Le.tileAnchorX,Le.tileAnchorY),Fe=wi.upVectorScale(bi.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;xt+=F*Gt*Fe,Pt+=Me*Gt*Fe,jt+=Oe*Gt*Fe}const qr=this.projectAndGetPerspectiveRatio(qe,xt,Pt,jt,Le.tileID,"globe"===wi.name||!!Gt||this.transform.pitch>0,wi),Xn=je*qr.perspectiveRatio,Yn=(Le.x1*Me+Oe.x-Le.padding)*Xn+qr.point.x,yo=(Le.y1*Me+Oe.y-Le.padding)*Xn+qr.point.y,bo=(Le.x2*Me+Oe.x+Le.padding)*Xn+qr.point.x,Ro=(Le.y2*Me+Oe.y+Le.padding)*Xn+qr.point.y,Do=qr.perspectiveRatio<=.55||qr.occluded;return!this.isInsideGrid(Yn,yo,bo,Ro)||!Fe&&this.grid.hitTest(Yn,yo,bo,Ro,He)||Do?{box:[],offscreen:!1,occluded:qr.occluded}:{box:[Yn,yo,bo,Ro],offscreen:this.isOffscreen(Yn,yo,bo,Ro),occluded:!1}}placeCollisionCircles(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn){const Yn=[],yo=this.transform.elevation,bo=Me.getProjection(),Ro=yo?yo.getAtTileOffsetFunc(Xn,this.transform.center.lat,this.transform.worldSize,bo):null,Do=new F.P(Oe.tileAnchorX,Oe.tileAnchorY);let{x:zs,y:Zs,z:na}=bo.projectTilePoint(Do.x,Do.y,Xn.canonical);if(Ro){const[F,Me,Le]=Ro(Do);zs+=F,Zs+=Me,na+=Le}const el="globe"===bo.name,nl=this.projectAndGetPerspectiveRatio(He,zs,Zs,na,Xn,el||!!yo||this.transform.pitch>0,bo),{perspectiveRatio:hl}=nl,pl=(Gt?qe/hl:qe*hl)/F.bw,bl=Wt(zs,Zs,na,xt),Tl=Oe.lineOffsetX*pl,kl=Oe.lineOffsetY*pl,ec=F.ak(Me.layers[0].layout.get("text-max-angle")),tc=Math.cos(ec),ic=nl.signedDistanceFromCamera>0?Yt(pl,je,Tl,kl,!1,bl,Do,Oe,Fe,xt,{},yo&&!Gt?Ro:null,Gt&&!!yo,bo,Xn,Gt,tc):null;let oc=!1,sc=!1,ac=!0;if(ic&&!nl.occluded){const Me=.5*wi*hl+qr,Oe=new F.P(-100,-100),Fe=new F.P(this.screenRightBoundary,this.screenBottomBoundary),je=new Ut,{first:qe,last:He}=ic,xt=qe.path.length;let Gt=[];for(let F=xt-1;F>=1;F--)Gt.push(qe.path[F]);for(let F=1;F<He.path.length;F++)Gt.push(He.path[F]);const Xn=2.5*Me;Pt&&(Gt=Gt.map((([F,Me,Le],Oe)=>(Ro&&!el&&(Le=Ro(Oe<xt-1?qe.tilePath[xt-1-Oe]:He.tilePath[Oe-xt+2])[2]),Wt(F,Me,Le,Pt)))),Gt.some((F=>F[3]<=0))&&(Gt=[]));let yo=[];if(Gt.length>0){let Me=1/0,Le=-1/0,je=1/0,qe=-1/0;for(const F of Gt)Me=Math.min(Me,F[0]),je=Math.min(je,F[1]),Le=Math.max(Le,F[0]),qe=Math.max(qe,F[1]);Le>=Oe.x&&Me<=Fe.x&&qe>=Oe.y&&je<=Fe.y&&(yo=[Gt.map((Me=>new F.P(Me[0],Me[1])))],(Me<Oe.x||Le>Fe.x||je<Oe.y||qe>Fe.y)&&(yo=F.bu(yo,Oe.x,Oe.y,Fe.x,Fe.y)))}for(const F of yo){je.reset(F,.25*Me);let Oe=0;Oe=je.length<=.5*Me?1:Math.ceil(je.paddedLength/Xn)+1;for(let F=0;F<Oe;F++){const Fe=F/Math.max(Oe-1,1),qe=je.lerp(Fe),He=qe.x+oh,xt=qe.y+oh;Yn.push(He,xt,Me,0);const Pt=He-Me,Gt=xt-Me,wi=He+Me,qr=xt+Me;if(ac=ac&&this.isOffscreen(Pt,Gt,wi,qr),sc=sc||this.isInsideGrid(Pt,Gt,wi,qr),!Le&&this.grid.hitTestCircle(He,xt,Me,bi)&&(oc=!0,!jt))return{circles:[],offscreen:!1,collisionDetected:oc,occluded:!1}}}}return{circles:!jt&&oc||!sc?[]:Yn,offscreen:ac,collisionDetected:oc,occluded:nl.occluded}}queryRenderedSymbols(Me){if(0===Me.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const Le=[];let Oe=1/0,Fe=1/0,je=-1/0,qe=-1/0;for(const He of Me){const Me=new F.P(He.x+oh,He.y+oh);Oe=Math.min(Oe,Me.x),Fe=Math.min(Fe,Me.y),je=Math.max(je,Me.x),qe=Math.max(qe,Me.y),Le.push(Me)}const He=this.grid.query(Oe,Fe,je,qe).concat(this.ignoredGrid.query(Oe,Fe,je,qe)),xt={},Pt={};for(const Me of He){const Oe=Me.key;if(void 0===xt[Oe.bucketInstanceId]&&(xt[Oe.bucketInstanceId]={}),xt[Oe.bucketInstanceId][Oe.featureIndex])continue;const Fe=[new F.P(Me.x1,Me.y1),new F.P(Me.x2,Me.y1),new F.P(Me.x2,Me.y2),new F.P(Me.x1,Me.y2)];F.bv(Le,Fe)&&(xt[Oe.bucketInstanceId][Oe.featureIndex]=!0,void 0===Pt[Oe.bucketInstanceId]&&(Pt[Oe.bucketInstanceId]=[]),Pt[Oe.bucketInstanceId].push(Oe.featureIndex))}return Pt}insertCollisionBox(F,Me,Le,Oe,Fe){(Me?this.ignoredGrid:this.grid).insert({bucketInstanceId:Le,featureIndex:Oe,collisionGroupID:Fe},F[0],F[1],F[2],F[3])}insertCollisionCircles(F,Me,Le,Oe,Fe){const je=Me?this.ignoredGrid:this.grid,qe={bucketInstanceId:Le,featureIndex:Oe,collisionGroupID:Fe};for(let Me=0;Me<F.length;Me+=4)je.insertCircle(qe,F[Me],F[Me+1],F[Me+2])}projectAndGetPerspectiveRatio(Me,Le,Oe,Fe,je,qe,He){const xt=[Le,Oe,Fe,1];let Pt=!1;if(Fe||this.transform.pitch>0){if(F.ad.vec4.transformMat4(xt,xt,Me),this.fogState&&je&&"globe"!==He.name){const Me=function(Me,Le,Oe,Fe,je,qe){const He=qe.calculateFogTileMatrix(je),xt=[Le,Oe,Fe];return F.ad.vec3.transformMat4(xt,xt,He),ke(Me,F.ad.vec3.length(xt),qe.pitch,qe._fov)}(this.fogState,Le,Oe,Fe,je.toUnwrapped(),this.transform);Pt=Me>.9}}else si(xt,xt,Me);const jt=xt[3];return{point:new F.P((xt[0]/jt+1)/2*this.transform.width+oh,(-xt[1]/jt+1)/2*this.transform.height+oh),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(He)/jt*.5,1.5),signedDistanceFromCamera:jt,occluded:qe&&xt[2]>jt||Pt}}isOffscreen(F,Me,Le,Oe){return Le<oh||F>=this.screenRightBoundary||Oe<oh||Me>this.screenBottomBoundary}isInsideGrid(F,Me,Le,Oe){return Le>=0&&F<this.gridRightBoundary&&Oe>=0&&Me<this.gridBottomBoundary}getViewportMatrix(){const Me=F.ad.mat4.identity([]);return F.ad.mat4.translate(Me,Me,[-100,-100,0]),Me}}function ai(Me,Le,Oe){const Fe=Le.createTileMatrix(Me,Me.worldSize,Oe.toUnwrapped());return F.ad.mat4.multiply(new Float32Array(16),Me.projMatrix,Fe)}function li(F,Me,Le){if(Me.projection.name===Le.projection.name)return F.projMatrix;const Oe=Le.clone();return Oe.setProjection(Me.projection),ai(Oe,Me.getProjection(),F)}function ci(F,Me,Le){return Me.name===Le.projection.name?F.projMatrix:ai(Le,Me,F)}class hi{constructor(F,Me,Le,Oe){this.opacity=F?Math.max(0,Math.min(1,F.opacity+(F.placed?Me:-Me))):Oe&&Le?1:0,this.placed=Le}isHidden(){return 0===this.opacity&&!this.placed}}class di{constructor(F,Me,Le,Oe,Fe,je=!1){this.text=new hi(F?F.text:null,Me,Le,Fe),this.icon=new hi(F?F.icon:null,Me,Oe,Fe),this.clipped=je}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ui{constructor(F,Me,Le,Oe=!1){this.text=F,this.icon=Me,this.skipFade=Le,this.clipped=Oe}}class _i{constructor(){this.invProjMatrix=F.ad.mat4.create(),this.viewportMatrix=F.ad.mat4.create(),this.circles=[]}}class pi{constructor(F,Me,Le,Oe,Fe){this.bucketInstanceId=F,this.featureIndex=Me,this.sourceLayerIndex=Le,this.bucketIndex=Oe,this.tileID=Fe}}class fi{constructor(F){this.crossSourceCollisions=F,this.maxGroupID=0,this.collisionGroups={}}get(F){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[F]){const Me=++this.maxGroupID;this.collisionGroups[F]={ID:Me,predicate:F=>F.collisionGroupID===Me}}return this.collisionGroups[F]}}function mi(Me,Le,Oe,Fe,je){const{horizontalAlign:qe,verticalAlign:He}=F.bD(Me),xt=-(qe-.5)*Le,Pt=-(He-.5)*Oe,jt=F.bC(Me,Fe);return new F.P(xt+jt[0]*je,Pt+jt[1]*je)}function gi(Me,Le,Oe,Fe,je){const qe=new F.P(Me,Le);return Oe&&qe._rotate(Fe?je:-je),qe}class vi{constructor(F,Me,Le,Oe,Fe,je){this.transform=F.clone(),this.projection=F.projection.name,this.collisionIndex=new ni(this.transform,Fe),this.buildingIndex=je,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=Me,this.retainedQueryData={},this.collisionGroups=new fi(Le),this.collisionCircleArrays={},this.prevPlacement=Oe,Oe&&(Oe.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(Me,Le,Oe,Fe,je=1){const qe=Oe.getBucket(Le),He=Oe.latestFeatureIndex;if(!qe||!He||Le.fqid!==qe.layerIds[0])return;const xt=qe.layers[0].layout,Pt=qe.layers[0].paint,jt=Oe.collisionBoxArray,Gt=Math.pow(2,this.transform.zoom-Oe.tileID.overscaledZ),bi=Oe.tileSize/F.ai,wi=Oe.tileID.toUnwrapped();this.transform.setProjection(qe.projection);const qr=(Xn=Oe.tileID,Yn=qe.getProjection(),yo=this.transform,Yn.name===this.projection?yo.calculateProjMatrix(Xn.toUnwrapped()):ai(yo,Yn,Xn));var Xn,Yn,yo;const bo="map"===xt.get("text-pitch-alignment"),Ro="map"===xt.get("text-rotation-alignment");Le.compileFilter(Le.options);const Do=Le.dynamicFilter(),zs=Le.dynamicFilterNeedsFeature(),Zs=this.transform.calculatePixelsToTileUnitsMatrix(Oe),na=Ht(qr,Oe.tileID.canonical,bo,Ro,this.transform,qe.getProjection(),Zs);let el=null;if(bo){const Me=Zt(qr,Oe.tileID.canonical,bo,Ro,this.transform,qe.getProjection(),Zs);el=F.ad.mat4.multiply([],this.transform.labelPlaneMatrix,Me)}let nl=null;Do&&Oe.latestFeatureIndex&&(nl={unwrappedTileID:wi,dynamicFilter:Do,dynamicFilterNeedsFeature:zs}),this.retainedQueryData[qe.bucketInstanceId]=new pi(qe.bucketInstanceId,He,qe.sourceLayerIndex,qe.index,Oe.tileID);const[hl,pl]=qe.layers[0].layout.get("text-size-scale-range"),bl=F.ay(je,hl,pl),[Tl,kl]=xt.get("icon-size-scale-range"),ec=F.ay(je,Tl,kl),tc={bucket:qe,layout:xt,paint:Pt,posMatrix:qr,textLabelPlaneMatrix:na,labelToScreenMatrix:el,clippingData:nl,scale:Gt,textPixelRatio:bi,holdingForFade:Oe.holdingForFade(),collisionBoxArray:jt,partiallyEvaluatedTextSize:F.bp(qe.textSizeData,this.transform.zoom,bl),partiallyEvaluatedIconSize:F.bp(qe.iconSizeData,this.transform.zoom,ec),collisionGroup:this.collisionGroups.get(qe.sourceID),latestFeatureIndex:Oe.latestFeatureIndex};if(Fe)for(const F of qe.sortKeyRanges){const{sortKey:Le,symbolInstanceStart:Oe,symbolInstanceEnd:Fe}=F;Me.push({sortKey:Le,symbolInstanceStart:Oe,symbolInstanceEnd:Fe,parameters:tc})}else Me.push({symbolInstanceStart:0,symbolInstanceEnd:qe.symbolInstances.length,parameters:tc})}attemptAnchorPlacement(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo){const{textOffset0:bo,textOffset1:Ro,crossTileID:Do}=Gt,zs=[bo,Ro],Zs=mi(F,Le,Oe,zs,Fe),na=this.collisionIndex.placeCollisionBox(wi,Fe,Me,gi(Zs.x,Zs.y,je,qe,this.transform.angle),jt,He,xt,Pt.predicate);if(Xn){const F=wi.getSymbolInstanceIconSize(yo,this.transform.zoom,Gt.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(wi,F,Xn,gi(Zs.x,Zs.y,je,qe,this.transform.angle),jt,He,xt,Pt.predicate).box.length)return}if(na.box.length>0){let Me;return this.prevPlacement&&this.prevPlacement.variableOffsets[Do]&&this.prevPlacement.placements[Do]&&this.prevPlacement.placements[Do].text&&(Me=this.prevPlacement.variableOffsets[Do].anchor),this.variableOffsets[Do]={textOffset:zs,width:Le,height:Oe,anchor:F,textScale:Fe,prevAnchor:Me},this.markUsedJustification(wi,F,Gt,qr),wi.allowVerticalPlacement&&(this.markUsedOrientation(wi,qr,Gt),this.placedOrientations[Do]=qr),{shift:Zs,placedGlyphBoxes:na}}}placeLayerBucketPart(Me,Le,Oe,Fe,je=1){const{bucket:qe,layout:He,paint:xt,posMatrix:Pt,textLabelPlaneMatrix:jt,labelToScreenMatrix:Gt,clippingData:bi,textPixelRatio:wi,holdingForFade:qr,collisionBoxArray:Xn,partiallyEvaluatedTextSize:Yn,partiallyEvaluatedIconSize:yo,collisionGroup:bo,latestFeatureIndex:Ro}=Me.parameters,Do=He.get("text-optional"),zs=He.get("icon-optional"),Zs=He.get("text-allow-overlap"),na=He.get("icon-allow-overlap"),el="map"===He.get("text-rotation-alignment"),nl="map"===He.get("text-pitch-alignment"),hl=xt.get("symbol-z-offset"),pl="sea"===He.get("symbol-elevation-reference"),[bl,Tl]=He.get("text-size-scale-range"),[kl,ec]=He.get("icon-size-scale-range"),tc=F.ay(je,bl,Tl),ic=F.ay(je,kl,ec);this.transform.setProjection(qe.projection);let oc=Zs&&(na||!qe.hasIconData()||zs),sc=na&&(Zs||!qe.hasTextData()||Do);const ac=!hl.isConstant();!qe.collisionArrays&&Xn&&qe.deserializeCollisionBoxes(Xn),Oe&&Fe&&qe.updateCollisionDebugBuffers(this.transform.zoom,Xn,tc,ic);const k=(Me,Fe,xt)=>{const{crossTileID:Xn,numVerticalGlyphVertices:bl}=Me;let Tl=null;if(bi&&bi.dynamicFilterNeedsFeature||ac){const F=this.retainedQueryData[qe.bucketInstanceId];Tl=Ro.loadFeature({featureIndex:Me.featureIndex,bucketIndex:F.bucketIndex,sourceLayerIndex:F.sourceLayerIndex,layoutVertexArrayOffset:0})}if(bi&&!(0,bi.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Tl,this.retainedQueryData[qe.bucketInstanceId].tileID.canonical,new F.P(Me.tileAnchorX,Me.tileAnchorY),this.transform.calculateDistanceTileData(bi.unwrappedTileID)))return this.placements[Xn]=new ui(!1,!1,!1,!0),void Le.add(Xn);const kl=hl.evaluate(Tl,{});if(Le.has(Xn))return;if(qr)return void(this.placements[Xn]=new ui(!1,!1,!1));let ec=!1,tc=!1,ic=!0,mc=!1,gc=!1,yc=null,xc={box:null,offscreen:null,occluded:null},Zc={box:null,offscreen:null,occluded:null},Wc=null,Kc=null,Jc=null,Qc=0,eh=0,th=0;xt.textFeatureIndex?Qc=xt.textFeatureIndex:Me.useRuntimeCollisionCircles&&(Qc=Me.featureIndex),xt.verticalTextFeatureIndex&&(eh=xt.verticalTextFeatureIndex);const $=F=>{F.tileID=this.retainedQueryData[qe.bucketInstanceId].tileID;const Le=this.transform.elevation;F.elevation=pl?kl:kl+(Le?Le.getAtTileOffset(F.tileID,F.tileAnchorX,F.tileAnchorY):0),F.elevation+=Me.zOffset},rh=xt.textBox;if(rh){$(rh);const i=Le=>{let Oe=F.bq.horizontal;if(qe.allowVerticalPlacement&&!Le&&this.prevPlacement){const F=this.prevPlacement.placedOrientations[Xn];F&&(this.placedOrientations[Xn]=F,Oe=F,this.markUsedOrientation(qe,Oe,Me))}return Oe},o=(Me,Le)=>{if(qe.allowVerticalPlacement&&bl>0&&xt.verticalTextBox){for(const Oe of qe.writingModes)if(Oe===F.bq.vertical?(xc=Le(),Zc=xc):xc=Me(),xc&&xc.box&&xc.box.length)break}else xc=Me()};if(He.get("text-variable-anchor")){let Le=He.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Xn]){const F=this.prevPlacement.variableOffsets[Xn];Le.indexOf(F.anchor)>0&&(Le=Le.filter((Me=>Me!==F.anchor)),Le.unshift(F.anchor))}const h=(F,Oe,je)=>{const He=qe.getSymbolInstanceTextSize(Yn,Me,this.transform.zoom,Fe),xt=(F.x2-F.x1)*He+2*F.padding,jt=(F.y2-F.y1)*He+2*F.padding,Gt=Me.hasIconTextFit&&!na?Oe:null;Gt&&$(Gt);let bi={box:[],offscreen:!1,occluded:!1};const qr=Zs?2*Le.length:Le.length;for(let Oe=0;Oe<qr;++Oe){const qr=this.attemptAnchorPlacement(Le[Oe%Le.length],F,xt,jt,He,el,nl,wi,Pt,bo,Oe>=Le.length,Me,Fe,qe,je,Gt,Yn,yo);if(qr&&(bi=qr.placedGlyphBoxes,bi&&bi.box&&bi.box.length)){ec=!0,yc=qr.shift;break}}return bi};o((()=>h(rh,xt.iconBox,F.bq.horizontal)),(()=>{const Me=xt.verticalTextBox;return Me&&$(Me),qe.allowVerticalPlacement&&!(xc&&xc.box&&xc.box.length)&&bl>0&&Me?h(Me,xt.verticalIconBox,F.bq.vertical):{box:null,offscreen:null,occluded:null}})),xc&&(ec=xc.box,ic=xc.offscreen,mc=xc.occluded);const Oe=i(!(!xc||!xc.box));if(!ec&&this.prevPlacement){const F=this.prevPlacement.variableOffsets[Xn];F&&(this.variableOffsets[Xn]=F,this.markUsedJustification(qe,F.anchor,Me,Oe))}}else{const a=(Le,Oe)=>{const He=qe.getSymbolInstanceTextSize(Yn,Me,this.transform.zoom,Fe,je),xt=this.collisionIndex.placeCollisionBox(qe,He,Le,new F.P(0,0),Zs,wi,Pt,bo.predicate);return xt&&xt.box&&xt.box.length&&(this.markUsedOrientation(qe,Oe,Me),this.placedOrientations[Xn]=Oe),xt};o((()=>a(rh,F.bq.horizontal)),(()=>{const Me=xt.verticalTextBox;return qe.allowVerticalPlacement&&bl>0&&Me?($(Me),a(Me,F.bq.vertical)):{box:null,offscreen:null,occluded:null}})),i(!!(xc&&xc.box&&xc.box.length))}}if(Wc=xc,ec=Wc&&Wc.box&&Wc.box.length>0,ic=Wc&&Wc.offscreen,mc=Wc&&Wc.occluded,Me.useRuntimeCollisionCircles){const Le=qe.text.placedSymbolArray.get(Me.centerJustifiedTextSymbolIndex>=0?Me.centerJustifiedTextSymbolIndex:Me.verticalPlacedTextSymbolIndex),Fe=F.br(qe.textSizeData,Yn,Le),je=He.get("text-padding");Kc=this.collisionIndex.placeCollisionCircles(qe,Zs,Le,qe.lineVertexArray,qe.glyphOffsetArray,Fe,Pt,jt,Gt,Oe,nl,bo.predicate,Me.collisionCircleDiameter*Fe/F.bw,je,this.retainedQueryData[qe.bucketInstanceId].tileID),ec=Zs||Kc.circles.length>0&&!Kc.collisionDetected,ic=ic&&Kc.offscreen,mc=Kc.occluded}if(xt.iconFeatureIndex&&(th=xt.iconFeatureIndex),xt.iconBox){const i=Le=>{$(Le);const Oe=Me.hasIconTextFit&&yc?gi(yc.x,yc.y,el,nl,this.transform.angle):new F.P(0,0),Fe=qe.getSymbolInstanceIconSize(yo,this.transform.zoom,Me.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(qe,Fe,Le,Oe,na,wi,Pt,bo.predicate)};Zc&&Zc.box&&Zc.box.length&&xt.verticalIconBox?(Jc=i(xt.verticalIconBox),tc=Jc.box.length>0):(Jc=i(xt.iconBox),tc=Jc.box.length>0),ic=ic&&Jc.offscreen,gc=Jc.occluded}const oh=Do||0===Me.numHorizontalGlyphVertices&&0===bl,ah=zs||0===Me.numIconVertices;if(oh||ah?ah?oh||(tc=tc&&ec):ec=tc&&ec:tc=ec=tc&&ec,ec&&Wc&&Wc.box&&this.collisionIndex.insertCollisionBox(Wc.box,He.get("text-ignore-placement"),qe.bucketInstanceId,Zc&&Zc.box&&eh?eh:Qc,bo.ID),tc&&Jc&&this.collisionIndex.insertCollisionBox(Jc.box,He.get("icon-ignore-placement"),qe.bucketInstanceId,th,bo.ID),Kc&&(ec&&this.collisionIndex.insertCollisionCircles(Kc.circles,He.get("text-ignore-placement"),qe.bucketInstanceId,Qc,bo.ID),Oe)){const F=qe.bucketInstanceId;let Me=this.collisionCircleArrays[F];void 0===Me&&(Me=this.collisionCircleArrays[F]=new _i);for(let F=0;F<Kc.circles.length;F+=4)Me.circles.push(Kc.circles[F+0]),Me.circles.push(Kc.circles[F+1]),Me.circles.push(Kc.circles[F+2]),Me.circles.push(Kc.collisionDetected?1:0)}const lh="globe"!==qe.projection.name;oc=oc&&(lh||!mc),sc=sc&&(lh||!gc),this.placements[Xn]=new ui(ec||oc,tc||sc,ic||qe.justReloaded),Le.add(Xn)};if("offset"===qe.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(qe,this.retainedQueryData[qe.bucketInstanceId].tileID),"road"===qe.elevationType&&qe.updateRoadElevation(),qe.updateZOffset(),qe.sortFeaturesByY){const Me=qe.getSortedSymbolIndexes(this.transform.angle);for(let F=Me.length-1;F>=0;--F){const Le=Me[F];k(qe.symbolInstances.get(Le),Le,qe.collisionArrays[Le])}qe.hasAnyZOffset&&F.w(`${qe.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(qe.hasAnyZOffset){const F=qe.getSortedIndexesByZOffset();for(let Me=0;Me<F.length;++Me){const Le=F[Me];k(qe.symbolInstances.get(Le),Le,qe.collisionArrays[Le])}}else for(let F=Me.symbolInstanceStart;F<Me.symbolInstanceEnd;F++)k(qe.symbolInstances.get(F),F,qe.collisionArrays[F]);if(Oe&&qe.bucketInstanceId in this.collisionCircleArrays){const Me=this.collisionCircleArrays[qe.bucketInstanceId];F.ad.mat4.invert(Me.invProjMatrix,Pt),Me.viewportMatrix=this.collisionIndex.getViewportMatrix()}qe.justReloaded=!1}markUsedJustification(Me,Le,Oe,Fe){const{leftJustifiedTextSymbolIndex:je,centerJustifiedTextSymbolIndex:qe,rightJustifiedTextSymbolIndex:He,verticalPlacedTextSymbolIndex:xt,crossTileID:Pt}=Oe,jt=F.bB(Le),Gt=Fe===F.bq.vertical?xt:"left"===jt?je:"center"===jt?qe:"right"===jt?He:-1;je>=0&&(Me.text.placedSymbolArray.get(je).crossTileID=Gt>=0&&je!==Gt?0:Pt),qe>=0&&(Me.text.placedSymbolArray.get(qe).crossTileID=Gt>=0&&qe!==Gt?0:Pt),He>=0&&(Me.text.placedSymbolArray.get(He).crossTileID=Gt>=0&&He!==Gt?0:Pt),xt>=0&&(Me.text.placedSymbolArray.get(xt).crossTileID=Gt>=0&&xt!==Gt?0:Pt)}markUsedOrientation(Me,Le,Oe){const Fe=Le===F.bq.horizontal||Le===F.bq.horizontalOnly?Le:0,je=Le===F.bq.vertical?Le:0,{leftJustifiedTextSymbolIndex:qe,centerJustifiedTextSymbolIndex:He,rightJustifiedTextSymbolIndex:xt,verticalPlacedTextSymbolIndex:Pt}=Oe,jt=Me.text.placedSymbolArray;qe>=0&&(jt.get(qe).placedOrientation=Fe),He>=0&&(jt.get(He).placedOrientation=Fe),xt>=0&&(jt.get(xt).placedOrientation=Fe),Pt>=0&&(jt.get(Pt).placedOrientation=je)}commit(F){this.commitTime=F,this.zoomAtLastRecencyCheck=this.transform.zoom;const Me=this.prevPlacement;let Le=!1;this.prevZoomAdjustment=Me?Me.zoomAdjustment(this.transform.zoom):0;const Oe=Me?Me.symbolFadeChange(F):1,Fe=Me?Me.opacities:{},je=Me?Me.variableOffsets:{},qe=Me?Me.placedOrientations:{};for(const F in this.placements){const Me=this.placements[F],je=Fe[F];je?(this.opacities[F]=new di(je,Oe,Me.text,Me.icon,null,Me.clipped),Le=Le||Me.text!==je.text.placed||Me.icon!==je.icon.placed):(this.opacities[F]=new di(null,Oe,Me.text,Me.icon,Me.skipFade,Me.clipped),Le=Le||Me.text||Me.icon)}for(const F in Fe){const Me=Fe[F];if(!this.opacities[F]){const Fe=new di(Me,Oe,!1,!1);Fe.isHidden()||(this.opacities[F]=Fe,Le=Le||Me.text.placed||Me.icon.placed)}}for(const F in je)this.variableOffsets[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.variableOffsets[F]=je[F]);for(const F in qe)this.placedOrientations[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.placedOrientations[F]=qe[F]);Le?this.lastPlacementChangeTime=F:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=Me?Me.lastPlacementChangeTime:F)}updateLayerOpacities(F,Me,Le,Oe){const Fe=new Set;for(const je of Me){const Me=je.getBucket(F);Me&&je.latestFeatureIndex&&F.fqid===Me.layerIds[0]&&(this.updateBucketOpacities(Me,Fe,je,je.collisionBoxArray,Le,Oe,je.tileID,F.scope),"offset"===Me.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(Me,je.tileID),"road"===Me.elevationType&&Me.updateRoadElevation(),Me.updateZOffset())}}updateBucketOpacities(Me,Le,Oe,Fe,je,qe,He,xt){Me.hasTextData()&&Me.text.opacityVertexArray.clear(),Me.hasIconData()&&Me.icon.opacityVertexArray.clear(),Me.hasIconCollisionBoxData()&&Me.iconCollisionBox.collisionVertexArray.clear(),Me.hasTextCollisionBoxData()&&Me.textCollisionBox.collisionVertexArray.clear();const Pt=Me.layers[0].layout,jt=Me.layers[0].paint,Gt=!!Me.layers[0].dynamicFilter(),bi=new di(null,0,!1,!1,!0),wi=Pt.get("text-allow-overlap"),qr=Pt.get("icon-allow-overlap"),Xn=Pt.get("text-variable-anchor"),Yn="map"===Pt.get("text-rotation-alignment"),yo="map"===Pt.get("text-pitch-alignment"),bo=jt.get("symbol-z-offset"),Ro="sea"===Pt.get("symbol-elevation-reference"),Do=!bo.isConstant(),zs=new di(null,0,wi&&(qr||!Me.hasIconData()||Pt.get("icon-optional")),qr&&(wi||!Me.hasTextData()||Pt.get("text-optional")),!0);!Me.collisionArrays&&Fe&&(Me.hasIconCollisionBoxData()||Me.hasTextCollisionBoxData())&&Me.deserializeCollisionBoxes(Fe);const w=(F,Me,Le)=>{for(let Oe=0;Oe<Me/4;Oe++)F.opacityVertexArray.emplaceBack(Le)};let Zs=0;qe&&Me.updateReplacement(He,qe);for(let Fe=0;Fe<Me.symbolInstances.length;Fe++){const Pt=Me.symbolInstances.get(Fe),{numHorizontalGlyphVertices:jt,numVerticalGlyphVertices:wi,crossTileID:qr,numIconVertices:na,tileAnchorX:el,tileAnchorY:nl}=Pt;let hl=null;const pl=this.retainedQueryData[Me.bucketInstanceId];Do&&Pt&&pl&&(hl=Oe.latestFeatureIndex.loadFeature({featureIndex:Pt.featureIndex,bucketIndex:pl.bucketIndex,sourceLayerIndex:pl.sourceLayerIndex,layoutVertexArrayOffset:0}));const bl=bo.evaluate(hl,{}),Tl=Le.has(qr);let kl=this.opacities[qr];Tl?kl=bi:kl||(kl=zs,this.opacities[qr]=kl),Le.add(qr);const ec=jt>0||wi>0,tc=na>0,ic=this.placedOrientations[qr],oc=ic===F.bq.vertical,sc=ic===F.bq.horizontal||ic===F.bq.horizontalOnly;!ec&&!tc||kl.isHidden()||Zs++;let ac=!1;if((ec||tc)&&qe)for(const Le of Me.activeReplacements){if(F.bx(Le,je,F.by.Symbol,xt))continue;if(Le.min.x>el||el>Le.max.x||Le.min.y>nl||nl>Le.max.y)continue;const Me=F.bz(el,nl,He.canonical,Le.footprintTileId.canonical);if(ac=F.bA(Me,Le.footprint),ac)break}if(ec){const F=ac?Ah:Ii(kl.text);w(Me.text,jt,oc?Ah:F),w(Me.text,wi,sc?Ah:F);const Le=kl.text.isHidden(),{leftJustifiedTextSymbolIndex:Oe,centerJustifiedTextSymbolIndex:Fe,rightJustifiedTextSymbolIndex:je,verticalPlacedTextSymbolIndex:qe}=Pt,He=Me.text.placedSymbolArray,xt=Le||oc?1:0;Oe>=0&&(He.get(Oe).hidden=xt),Fe>=0&&(He.get(Fe).hidden=xt),je>=0&&(He.get(je).hidden=xt),qe>=0&&(He.get(qe).hidden=Le||sc?1:0);const Gt=this.variableOffsets[qr];Gt&&this.markUsedJustification(Me,Gt.anchor,Pt,ic);const bi=this.placedOrientations[qr];bi&&(this.markUsedJustification(Me,"left",Pt,bi),this.markUsedOrientation(Me,bi,Pt))}if(tc){const F=ac?Ah:Ii(kl.icon),{placedIconSymbolIndex:Le,verticalPlacedIconSymbolIndex:Oe}=Pt,Fe=Me.icon.placedSymbolArray,je=kl.icon.isHidden()?1:0;Le>=0&&(w(Me.icon,na,oc?Ah:F),Fe.get(Le).hidden=je),Oe>=0&&(w(Me.icon,Pt.numVerticalIconVertices,sc?Ah:F),Fe.get(Oe).hidden=je)}if(Me.hasIconCollisionBoxData()||Me.hasTextCollisionBoxData()){const Le=Me.collisionArrays[Fe];if(Le){let Oe=new F.P(0,0),Fe=!0;if(Le.textBox||Le.verticalTextBox){if(Xn){const F=this.variableOffsets[qr];F?(Oe=mi(F.anchor,F.width,F.height,F.textOffset,F.textScale),Yn&&Oe._rotate(yo?this.transform.angle:-this.transform.angle)):Fe=!1}Gt&&(Fe=!kl.clipped),Le.textBox&&yi(Me.textCollisionBox.collisionVertexArray,kl.text.placed,!Fe||oc,bl,Ro,Oe.x,Oe.y),Le.verticalTextBox&&yi(Me.textCollisionBox.collisionVertexArray,kl.text.placed,!Fe||sc,bl,Ro,Oe.x,Oe.y)}const je=Fe&&Boolean(!sc&&Le.verticalIconBox);Le.iconBox&&yi(Me.iconCollisionBox.collisionVertexArray,kl.icon.placed,je,bl,Ro,Pt.hasIconTextFit?Oe.x:0,Pt.hasIconTextFit?Oe.y:0),Le.verticalIconBox&&yi(Me.iconCollisionBox.collisionVertexArray,kl.icon.placed,!je,bl,Ro,Pt.hasIconTextFit?Oe.x:0,Pt.hasIconTextFit?Oe.y:0)}}}if(Me.fullyClipped=0===Zs,Me.sortFeatures(this.transform.angle),this.retainedQueryData[Me.bucketInstanceId]&&(this.retainedQueryData[Me.bucketInstanceId].featureSortOrder=Me.featureSortOrder),Me.hasTextData()&&Me.text.opacityVertexBuffer&&Me.text.opacityVertexBuffer.updateData(Me.text.opacityVertexArray),Me.hasIconData()&&Me.icon.opacityVertexBuffer&&Me.icon.opacityVertexBuffer.updateData(Me.icon.opacityVertexArray),Me.hasIconCollisionBoxData()&&Me.iconCollisionBox.collisionVertexBuffer&&Me.iconCollisionBox.collisionVertexBuffer.updateData(Me.iconCollisionBox.collisionVertexArray),Me.hasTextCollisionBoxData()&&Me.textCollisionBox.collisionVertexBuffer&&Me.textCollisionBox.collisionVertexBuffer.updateData(Me.textCollisionBox.collisionVertexArray),Me.bucketInstanceId in this.collisionCircleArrays){const F=this.collisionCircleArrays[Me.bucketInstanceId];Me.placementInvProjMatrix=F.invProjMatrix,Me.placementViewportMatrix=F.viewportMatrix,Me.collisionCircleArray=F.circles,delete this.collisionCircleArrays[Me.bucketInstanceId]}}symbolFadeChange(F){return 0===this.fadeDuration?1:(F-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(F){return Math.max(0,(this.transform.zoom-F)/1.5)}hasTransitions(F){return this.stale||F-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(F,Me){const Le=this.zoomAtLastRecencyCheck===Me?1-this.zoomAdjustment(Me):1;return this.zoomAtLastRecencyCheck=Me,this.commitTime+this.fadeDuration*Le>F}setStale(){this.stale=!0}}function yi(F,Me,Le,Oe,Fe,je,qe){F.emplaceBack(Me?1:0,Le?1:0,je||0,qe||0,Oe,Fe?1:0),F.emplaceBack(Me?1:0,Le?1:0,je||0,qe||0,Oe,Fe?1:0),F.emplaceBack(Me?1:0,Le?1:0,je||0,qe||0,Oe,Fe?1:0),F.emplaceBack(Me?1:0,Le?1:0,je||0,qe||0,Oe,Fe?1:0)}const ah=Math.pow(2,25),lh=Math.pow(2,24),hh=Math.pow(2,17),ph=Math.pow(2,16),wh=Math.pow(2,9),Th=Math.pow(2,8),Mh=Math.pow(2,1);function Ii(F){if(0===F.opacity&&!F.placed)return 0;if(1===F.opacity&&F.placed)return 4294967295;const Me=F.placed?1:0,Le=Math.floor(127*F.opacity);return Le*ah+Me*lh+Le*hh+Me*ph+Le*wh+Me*Th+Le*Mh+Me}const Ah=0;class Di{constructor(F){this._sortAcrossTiles="viewport-y"!==F.layout.get("symbol-z-order")&&void 0!==F.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(F,Me,Le,Oe,Fe,je){const qe=this._bucketParts;for(;this._currentTileIndex<F.length;)if(Me.getBucketParts(qe,Oe,F[this._currentTileIndex],this._sortAcrossTiles,je),this._currentTileIndex++,Fe())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,qe.sort(((F,Me)=>F.sortKey-Me.sortKey)));this._currentPartIndex<qe.length;){const F=qe[this._currentPartIndex];if(Me.placeLayerBucketPart(F,this._seenCrossTileIDs,Le,0===F.symbolInstanceStart,je),this._currentPartIndex++,Fe())return!0}return!1}}class Ai{constructor(F,Me,Le,Oe,Fe,je,qe,He,xt){this.placement=new vi(F,Fe,je,qe,He,xt),this._currentPlacementIndex=Me.length-1,this._forceFullPlacement=Le,this._showCollisionBoxes=Oe,this._done=!1}isDone(){return this._done}continuePlacement(Me,Le,Oe,Fe,je){const qe=F.q.now(),a=()=>{const Me=F.q.now()-qe;return!this._forceFullPlacement&&Me>2};for(;this._currentPlacementIndex>=0;){const qe=Le[Me[this._currentPlacementIndex]],He=this.placement.collisionIndex.transform.zoom;if("symbol"===qe.type&&(!qe.minzoom||qe.minzoom<=He)&&(!qe.maxzoom||qe.maxzoom>He)){const Me=qe,Le=Me.layout.get("symbol-z-elevate"),He=void 0!==Me.layout.get("symbol-sort-key").constantOr(1),xt=Me.layout.get("symbol-z-order"),Pt="viewport-y"===xt||"auto"===xt&&!("viewport-y"!==xt&&He),jt=Me.layout.get("text-allow-overlap")||Me.layout.get("icon-allow-overlap")||Me.layout.get("text-ignore-placement")||Me.layout.get("icon-ignore-placement"),Gt=Pt&&jt,bi=this._inProgressLayer=this._inProgressLayer||new Di(Me),wi=F.C(qe.source,qe.scope);if(bi.continuePlacement(Le||Gt?Fe[wi]:Oe[wi],this.placement,this._showCollisionBoxes,qe,a,je))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(F){return this.placement.commit(F),this.placement}}const Ih=512/F.ai/2;class Pi{constructor(Me,Le,Oe){this.tileID=Me,this.bucketInstanceId=Oe,this.index=new F.bE(Le.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const Fe=Me.canonical.x*F.ai,je=Me.canonical.y*F.ai;for(let F=0;F<Le.length;F++){const{key:Me,crossTileID:Oe,tileAnchorX:qe,tileAnchorY:He}=Le.get(F),xt=Math.floor((Fe+qe)*Ih),Pt=Math.floor((je+He)*Ih);this.index.add(xt,Pt),this.keys.push(Me),this.crossTileIDs.push(Oe)}this.index.finish()}findMatches(Me,Le,Oe){const Fe=this.tileID.canonical.z<Le.canonical.z?1:Math.pow(2,this.tileID.canonical.z-Le.canonical.z),je=Ih/Math.pow(2,Le.canonical.z-this.tileID.canonical.z),qe=Le.canonical.x*F.ai,He=Le.canonical.y*F.ai;for(let F=0;F<Me.length;F++){const Le=Me.get(F);if(Le.crossTileID)continue;const{key:xt,tileAnchorX:Pt,tileAnchorY:jt}=Le,Gt=Math.floor((qe+Pt)*je),bi=Math.floor((He+jt)*je),wi=this.index.range(Gt-Fe,bi-Fe,Gt+Fe,bi+Fe);for(const F of wi){const Me=this.crossTileIDs[F];if(this.keys[F]===xt&&!Oe.has(Me)){Oe.add(Me),Le.crossTileID=Me;break}}}}}class Mi{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class zi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(F){const Me=Math.round((F-this.lng)/360);if(0!==Me)for(const F in this.indexes){const Le=this.indexes[F],Oe={};for(const F in Le){const Fe=Le[F];Fe.tileID=Fe.tileID.unwrapTo(Fe.tileID.wrap+Me),Oe[Fe.tileID.key]=Fe}this.indexes[F]=Oe}this.lng=F}addBucket(F,Me,Le){if(this.indexes[F.overscaledZ]&&this.indexes[F.overscaledZ][F.key]){if(this.indexes[F.overscaledZ][F.key].bucketInstanceId===Me.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(F.overscaledZ,this.indexes[F.overscaledZ][F.key])}for(let F=0;F<Me.symbolInstances.length;F++)Me.symbolInstances.get(F).crossTileID=0;this.usedCrossTileIDs[F.overscaledZ]||(this.usedCrossTileIDs[F.overscaledZ]=new Set);const Oe=this.usedCrossTileIDs[F.overscaledZ];for(const Le in this.indexes){const Fe=this.indexes[Le];if(Number(Le)>F.overscaledZ)for(const Le in Fe){const je=Fe[Le];je.tileID.isChildOf(F)&&je.findMatches(Me.symbolInstances,F,Oe)}else{const je=Fe[F.scaledTo(Number(Le)).key];je&&je.findMatches(Me.symbolInstances,F,Oe)}}for(let F=0;F<Me.symbolInstances.length;F++){const Fe=Me.symbolInstances.get(F);Fe.crossTileID||(Fe.crossTileID=Le.generate(),Oe.add(Fe.crossTileID))}return void 0===this.indexes[F.overscaledZ]&&(this.indexes[F.overscaledZ]={}),this.indexes[F.overscaledZ][F.key]=new Pi(F,Me.symbolInstances,Me.bucketInstanceId),!0}removeBucketCrossTileIDs(F,Me){for(const Le of Me.crossTileIDs)this.usedCrossTileIDs[F].delete(Le)}removeStaleBuckets(F){let Me=!1;for(const Le in this.indexes){const Oe=this.indexes[Le];for(const Fe in Oe)F[Oe[Fe].bucketInstanceId]||(this.removeBucketCrossTileIDs(Le,Oe[Fe]),delete Oe[Fe],Me=!0)}return Me}}class Oi{constructor(){this.layerIndexes={},this.crossTileIDs=new Mi,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(F,Me,Le,Oe){let Fe=this.layerIndexes[F.fqid];void 0===Fe&&(Fe=this.layerIndexes[F.fqid]=new zi);let je=!1;const qe={};"globe"!==Oe.name&&Fe.handleWrapJump(Le);for(const Le of Me){const Me=Le.getBucket(F);Me&&F.fqid===Me.layerIds[0]&&(Me.bucketInstanceId||(Me.bucketInstanceId=++this.maxBucketInstanceId),Fe.addBucket(Le.tileID,Me,this.crossTileIDs)&&(je=!0),qe[Me.bucketInstanceId]=!0)}return Fe.removeStaleBuckets(qe)&&(je=!0),je}pruneUnusedLayers(F){const Me={};F.forEach((F=>{Me[F]=!0}));for(const F in this.layerIndexes)Me[F]||delete this.layerIndexes[F]}}const Ch=771;class ki{constructor(F,Me,Le,Oe){this.blendFunction=F,this.blendColor=Me,this.mask=Le,this.blendEquation=Oe}}ki.Replace=[1,0,1,0],ki.disabled=new ki(ki.Replace,F.al.transparent,[!1,!1,!1,!1]),ki.unblended=new ki(ki.Replace,F.al.transparent,[!0,!0,!0,!0]),ki.alphaBlended=new ki([1,Ch,1,Ch],F.al.transparent,[!0,!0,!0,!0]),ki.alphaBlendedNonPremultiplied=new ki([770,Ch,770,Ch],F.al.transparent,[!0,!0,!0,!0]),ki.multiply=new ki([774,0,774,0],F.al.transparent,[!0,!0,!0,!0]);class Bi{constructor(F,Me,Le){this.func=F,this.mask=Me,this.range=Le}}Bi.ReadOnly=!1,Bi.ReadWrite=!0,Bi.disabled=new Bi(519,Bi.ReadOnly,[0,1]);const zh=7680;class Ui{constructor(F,Me,Le,Oe,Fe,je){this.test=F,this.ref=Me,this.mask=Le,this.fail=Oe,this.depthFail=Fe,this.pass=je}}Ui.disabled=new Ui({func:519,mask:0},0,0,zh,zh,zh);const Dh=1029,kh=2305;class ji{constructor(F,Me,Le){this.enable=F,this.mode=Me,this.frontFace=Le}}function qi(Me,Le){const Oe=F.bG(Me,3);F.ad.mat4.fromQuat(Me,Le),F.bI(Me,3,Oe)}function Hi(Me,Le){const Oe=F.ad.quat.identity([]);return F.ad.quat.rotateZ(Oe,Oe,-Le),F.ad.quat.rotateX(Oe,Oe,-Me),Oe}function Zi(Me,Le){const Oe=[Me[0],Me[1],0],Fe=[Le[0],Le[1],0];if(F.ad.vec3.length(Oe)>=1e-15){const Me=F.ad.vec3.normalize([],Oe);F.ad.vec3.scale(Fe,Me,F.ad.vec3.dot(Fe,Me)),Le[0]=Fe[0],Le[1]=Fe[1]}const je=F.ad.vec3.cross([],Le,Me);if(F.ad.vec3.len(je)<1e-15)return null;const qe=Math.atan2(-je[1],je[0]);return Hi(Math.atan2(Math.sqrt(Me[0]*Me[0]+Me[1]*Me[1]),-Me[2]),qe)}ji.disabled=new ji(!1,Dh,kh),ji.backCCW=new ji(!0,Dh,kh),ji.backCW=new ji(!0,Dh,2304),ji.frontCW=new ji(!0,1028,2304),ji.frontCCW=new ji(!0,1028,kh);class Wi{constructor(F,Me){this.position=F,this.orientation=Me}get position(){return this._position}set position(Me){if(Me){const Le=Me instanceof F.ac?Me:new F.ac(Me[0],Me[1],Me[2]);this._renderWorldCopies&&(Le.x=F.bF(Le.x,0,1)),this._position=Le}else this._position=null}lookAtPoint(Me,Le){if(this.orientation=null,!this.position)return;const Oe=this.position,Fe=this._elevation?this._elevation.getAtPointOrZero(F.ac.fromLngLat(Me)):0,je=F.ac.fromLngLat(Me,Fe),qe=[je.x-Oe.x,je.y-Oe.y,je.z-Oe.z];Le||(Le=[0,0,1]),Le[2]=Math.abs(Le[2]),this.orientation=Zi(qe,Le)}setPitchBearing(Me,Le){this.orientation=Hi(F.ak(Me),F.ak(-Le))}}class $i{constructor(Me,Le){this._transform=F.ad.mat4.identity([]),this.orientation=Le,this.position=Me}get mercatorPosition(){const Me=this.position;return new F.ac(Me[0],Me[1],Me[2])}get position(){const Me=F.bG(this._transform,3);return[Me[0],Me[1],Me[2]]}set position(Me){var Le;Me&&F.bI(this._transform,3,[(Le=Me)[0],Le[1],Le[2],1])}get orientation(){return this._orientation}set orientation(Me){this._orientation=Me||F.ad.quat.identity([]),Me&&qi(this._transform,this._orientation)}getPitchBearing(){const F=this.forward(),Me=this.right();return{bearing:Math.atan2(-Me[1],Me[0]),pitch:Math.atan2(Math.sqrt(F[0]*F[0]+F[1]*F[1]),-F[2])}}setPitchBearing(F,Me){this._orientation=Hi(F,Me),qi(this._transform,this._orientation)}forward(){const Me=F.bG(this._transform,2);return[-Me[0],-Me[1],-Me[2]]}up(){const Me=F.bG(this._transform,1);return[-Me[0],-Me[1],-Me[2]]}right(){const Me=F.bG(this._transform,0);return[Me[0],Me[1],Me[2]]}getCameraToWorld(Me,Le){const Oe=new Float64Array(16);return F.ad.mat4.invert(Oe,this.getWorldToCamera(Me,Le)),Oe}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(Me,Le,Oe){const Fe=this.position;F.ad.vec3.scale(Fe,Fe,-Me);const je=new Float64Array(16);return F.ad.mat4.fromScaling(je,[Oe,Oe,Oe]),F.ad.mat4.translate(je,je,Fe),je[10]*=Le,je}getWorldToCamera(Me,Le){const Oe=new Float64Array(16),Fe=new Float64Array(4),je=this.position;return F.ad.quat.conjugate(Fe,this._orientation),F.ad.vec3.scale(je,je,-Me),F.ad.mat4.fromQuat(Oe,Fe),F.ad.mat4.translate(Oe,Oe,je),Oe[1]*=-1,Oe[5]*=-1,Oe[9]*=-1,Oe[13]*=-1,Oe[8]*=Le,Oe[9]*=Le,Oe[10]*=Le,Oe[11]*=Le,Oe}getCameraToClipPerspective(Me,Le,Oe,Fe){const je=new Float64Array(16);return F.ad.mat4.perspective(je,Me,Le,Oe,Fe),je}getCameraToClipOrthographic(Me,Le,Oe,Fe,je,qe){const He=new Float64Array(16);return F.ad.mat4.ortho(He,Me,Le,Oe,Fe,je,qe),He}getDistanceToElevation(Me,Le=!1){const Oe=0===Me?0:F.bH(Me,Le?F.aT(this.position[1]):this.position[1]),Fe=this.forward();return(Oe-this.position[2])/Fe[2]}clone(){return new $i([...this.position],[...this.orientation])}}const Bh={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Ki{constructor(F=0,Me=0,Le=0,Oe=0){if(isNaN(F)||F<0||isNaN(Me)||Me<0||isNaN(Le)||Le<0||isNaN(Oe)||Oe<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=F,this.bottom=Me,this.left=Le,this.right=Oe}interpolate(Me,Le,Oe){return null!=Le.top&&null!=Me.top&&(this.top=F.ah(Me.top,Le.top,Oe)),null!=Le.bottom&&null!=Me.bottom&&(this.bottom=F.ah(Me.bottom,Le.bottom,Oe)),null!=Le.left&&null!=Me.left&&(this.left=F.ah(Me.left,Le.left,Oe)),null!=Le.right&&null!=Me.right&&(this.right=F.ah(Me.right,Le.right,Oe)),this}getCenter(Me,Le){const Oe=F.ay((this.left+Me-this.right)/2,0,Me),Fe=F.ay((this.top+Le-this.bottom)/2,0,Le);return new F.P(Oe,Fe)}equals(F){return this.top===F.top&&this.bottom===F.bottom&&this.left===F.left&&this.right===F.right}clone(){return new Ki(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Vh=15;class Ji{constructor(Me,Le,Oe,Fe,je,qe,He){this.tileSize=512,this._renderWorldCopies=void 0===je||je,this._minZoom=Me||0,this._maxZoom=Le||22,this._minPitch=Oe??0,this._maxPitch=Fe??60,this.setProjection(qe),this.setMaxBounds(He),this.width=0,this.height=0,this._center=new F.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Ki,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new $i,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const F=new Ji(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return F._elevation=this._elevation,F._centerAltitude=this._centerAltitude,F._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,F.tileSize=this.tileSize,F.mercatorFromTransition=this.mercatorFromTransition,F.width=this.width,F.height=this.height,F.cameraElevationReference=this.cameraElevationReference,F._center=this._center,F._setZoom(this.zoom),F._seaLevelZoom=this._seaLevelZoom,F.angle=this.angle,F._fov=this._fov,F._pitch=this._pitch,F._nearZ=this._nearZ,F._farZ=this._farZ,F._averageElevation=this._averageElevation,F._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,F._unmodified=this._unmodified,F._edgeInsets=this._edgeInsets.clone(),F._camera=this._camera.clone(),F._calcMatrices(),F.freezeTileCoverage=this.freezeTileCoverage,F.frustumCorners=this.frustumCorners,F._allowWorldUnderZoom=this._allowWorldUnderZoom,F}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<Vh}get elevation(){return this._elevation}set elevation(F){this._elevation!==F&&(this._elevation=F,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(F,Me=!1){const Le=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||Le)&&this._updateCameraOnTerrain(),(F||Le)&&this._constrainCamera(Me),this._calcMatrices()}getProjection(){return F.aA(this.projection,["name","center","parallels"])}setProjection(Me){this.projectionOptions=Me||{name:"mercator"};const Le=this.projection?this.getProjection():void 0;this.projection=F.bP(this.projectionOptions);const Oe=this.getProjection(),Fe=!F.bn(Le,Oe);return Fe&&this._calcMatrices(),this.mercatorFromTransition=!1,Fe}setOrthographicProjectionAtLowPitch(F){return this._orthographicProjectionAtLowPitch!==F&&(this._orthographicProjectionAtLowPitch=F,this._calcMatrices(),!0)}setMercatorFromTransition(){const Me=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=F.bP({name:"mercator"});const Le=Me!==this.projection.name;return Le&&this._calcMatrices(),Le}get minZoom(){return this._minZoom}set minZoom(F){this._minZoom!==F&&(this._minZoom=F,this.zoom=Math.max(this.zoom,F))}get maxZoom(){return this._maxZoom}set maxZoom(F){this._maxZoom!==F&&(this._maxZoom=F,this.zoom=Math.min(this.zoom,F))}get minPitch(){return this._minPitch}set minPitch(F){this._minPitch!==F&&(this._minPitch=F,this.pitch=Math.max(this.pitch,F))}get maxPitch(){return this._maxPitch}set maxPitch(F){this._maxPitch!==F&&(this._maxPitch=F,this.pitch=Math.min(this.pitch,F))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(F){void 0===F?F=!0:null===F&&(F=!1),this._renderWorldCopies=F}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const F=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(F))}get cameraWorldSize(){const F=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(F))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return F.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new F.P(this.width,this.height)}get bearing(){return F.bF(this.rotation,-180,180)}set bearing(F){this.rotation=F}get rotation(){return-this.angle/Math.PI*180}set rotation(Me){const Le=-Me*Math.PI/180;this.angle!==Le&&(this._unmodified=!1,this.angle=Le,this._calcMatrices(),this.rotationMatrix=F.ad.mat2.create(),F.ad.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(Me){const Le=F.ay(Me,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==Le&&(this._unmodified=!1,this._pitch=Le,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(Me){Me=Math.max(.01,Math.min(60,Me)),this._fov!==Me&&(this._unmodified=!1,this._fov=F.ak(Me),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const F=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/F)}get averageElevation(){return this._averageElevation}set averageElevation(F){this._averageElevation=F,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(F){const Me=Math.min(Math.max(F,this.minZoom),this.maxZoom);this._zoom!==Me&&(this._unmodified=!1,this._setZoom(Me),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(F){this._zoom=F,this.scale=this.zoomScale(F),this.tileZoom=Math.floor(F),this.zoomFraction=F-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(F){this._tileCoverLift!==F&&(this._tileCoverLift=F)}_updateCameraOnTerrain(){const F=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,Me=this.elevation&&F===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||F===Number.NEGATIVE_INFINITY&&(!Me||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const Le=this._elevation;Me||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&Le.exaggeration()&&this._centerAltitudeValidForExaggeration!==Le.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*Le.exaggeration(),this._centerAltitudeValidForExaggeration=Le.exaggeration()):(this._centerAltitude=F||0,this._centerAltitudeValidForExaggeration=Le.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const Me=this._elevation,Le=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],Oe=this.horizonLineFromTop();let Fe=0,je=0;for(let qe=0;qe<Le.length;qe++){const He=new F.P(Le[qe][0]*this.width,Oe+Le[qe][1]*(this.height-Oe)),xt=Me.pointCoordinate(He);if(!xt)continue;const Pt=1/Math.hypot(xt[0]-this._camera.position[0],xt[1]-this._camera.position[1]);Fe+=xt[3]*Pt,je+=Pt}return 0===je?NaN:Fe/je}get center(){return this._center}set center(F){F.lat===this._center.lat&&F.lng===this._center.lng||(this._unmodified=!1,this._center=F,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const F=this._seaLevelZoom,Me=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),Le=this.pixelsPerMeter/this.worldSize*Me,Oe=this._mercatorZfromZoom(F),Fe=this._mercatorZfromZoom(this._maxZoom),je=Math.max(Oe-Le,Fe);this._setZoom(this._zoomFromMercatorZ(je))}get padding(){return this._edgeInsets.toJSON()}set padding(F){this._edgeInsets.equals(F)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,F,1),this._calcMatrices())}computeZoomRelativeTo(Me){const Le=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,Me.toAltitude()));let Oe;Oe=Me.z<this._camera.position[2]?[Le.x,Le.y,Le.z]:[Me.x,Me.y,Me.z];const Fe=F.ad.vec3.length(F.ad.vec3.sub([],this._camera.position,Oe));return F.ay(this._zoomFromMercatorZ(Fe),this._minZoom,this._maxZoom)}setFreeCameraOptions(Me){if(!this.height)return;if(!Me.position&&!Me.orientation)return;this._updateCameraState();let Le=!1;if(Me.orientation&&!F.ad.quat.exactEquals(Me.orientation,this._camera.orientation)&&(Le=this._setCameraOrientation(Me.orientation)),Me.position){const Oe=[Me.position.x,Me.position.y,Me.position.z];F.ad.vec3.exactEquals(Oe,this._camera.position)||(this._setCameraPosition(Oe),Le=!0)}Le&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const Me=this._camera.position,Le=new Wi;return Le.position=new F.ac(Me[0],Me[1],Me[2]),Le.orientation=this._camera.orientation,Le._elevation=this.elevation,Le._renderWorldCopies=this.renderWorldCopies,Le}_setCameraOrientation(Me){if(!F.ad.quat.length(Me))return!1;F.ad.quat.normalize(Me,Me);const Le=F.ad.vec3.transformQuat([],[0,0,-1],Me),Oe=F.ad.vec3.transformQuat([],[0,-1,0],Me);if(Oe[2]<0)return!1;const Fe=Zi(Le,Oe);return!!Fe&&(this._camera.orientation=Fe,!0)}_setCameraPosition(Me){const Le=this.zoomScale(this.minZoom)*this.tileSize,Oe=this.zoomScale(this.maxZoom)*this.tileSize,Fe=this.cameraToCenterDistance;Me[2]=F.ay(Me[2],Fe/Oe,Fe/Le),this._camera.position=Me}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(F){return this._edgeInsets.equals(F)}interpolatePadding(F,Me,Le){this._unmodified=!1,this._edgeInsets.interpolate(F,Me,Le),this._constrain(),this._calcMatrices()}coveringZoomLevel(F){const Me=(F.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/F.tileSize));return Math.max(0,Me)}getVisibleUnwrappedCoordinates(Me){const Le=[new F.bQ(0,Me)];if(this.renderWorldCopies){const Oe=this.pointCoordinate(new F.P(0,0)),Fe=this.pointCoordinate(new F.P(this.width,0)),je=this.pointCoordinate(new F.P(this.width,this.height)),qe=this.pointCoordinate(new F.P(0,this.height)),He=Math.floor(Math.min(Oe.x,Fe.x,je.x,qe.x)),xt=Math.floor(Math.max(Oe.x,Fe.x,je.x,qe.x)),Pt=1;for(let Oe=He-Pt;Oe<=xt+Pt;Oe++)0!==Oe&&Le.push(new F.bQ(Oe,Me))}return Le}isLODDisabled(F){return(!F||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(Me,Le,Oe){let Fe=[];const je=void 0!==Oe,qe=!je;if(qe&&this.zoom<Le)return Fe;if(je&&0===Oe[0]&&0===Oe[1])return Fe;const He=new Set,l=(Me,Le,Oe,je,qe)=>{const xt=F.c5(Le,Me,Oe,je,qe);He.has(xt)||(Fe.push(new F.aH(Me,Le,Oe,je,qe)),He.add(xt))};for(let F=0;F<Me.length;F++){const Fe=Me[F];if(qe&&Fe.canonical.z!==Le)continue;const He=Fe.canonical,xt=Fe.overscaledZ,Pt=Fe.wrap,jt=1<<He.z,Gt=He.x+1<jt,bi=He.x>0,wi=He.y+1<jt,qr=He.y>0,Xn=Fe.wrap-(bi?0:1),Yn=Fe.wrap+(Gt?0:1),yo=bi?He.x-1:jt-1,bo=Gt?He.x+1:0;if(je)Oe[0]<0?(l(xt,Yn,He.z,bo,He.y),Oe[1]<0&&wi&&(l(xt,Pt,He.z,He.x,He.y+1),l(xt,Yn,He.z,bo,He.y+1)),Oe[1]>0&&qr&&(l(xt,Pt,He.z,He.x,He.y-1),l(xt,Yn,He.z,bo,He.y-1))):Oe[0]>0?(l(xt,Xn,He.z,yo,He.y),Oe[1]<0&&wi&&(l(xt,Pt,He.z,He.x,He.y+1),l(xt,Xn,He.z,yo,He.y+1)),Oe[1]>0&&qr&&(l(xt,Pt,He.z,He.x,He.y-1),l(xt,Xn,He.z,yo,He.y-1))):Oe[1]<0&&wi?l(xt,Pt,He.z,He.x,He.y+1):qr&&l(xt,Pt,He.z,He.x,He.y-1);else{const F=Fe.visibleQuadrants;1&F&&(l(xt,Xn,He.z,yo,He.y),qr&&(l(xt,Pt,He.z,He.x,He.y-1),l(xt,Xn,He.z,yo,He.y-1))),2&F&&(l(xt,Yn,He.z,bo,He.y),qr&&(l(xt,Pt,He.z,He.x,He.y-1),l(xt,Yn,He.z,bo,He.y-1))),4&F&&(l(xt,Xn,He.z,yo,He.y),wi&&(l(xt,Pt,He.z,He.x,He.y+1),l(xt,Xn,He.z,yo,He.y+1))),8&F&&(l(xt,Yn,He.z,bo,He.y),wi&&(l(xt,Pt,He.z,He.x,He.y+1),l(xt,Yn,He.z,bo,He.y+1)))}}const xt=[];for(const F of Fe)Fe.some((Me=>F.isChildOf(Me)))||xt.push(F);if(Fe=xt.filter((F=>!Me.some((Me=>!!(F.overscaledZ<Le&&Me.isChildOf(F))||F.equals(Me)||F.isChildOf(Me))))),qe){const F=1<<Le,Me="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Oe=[F*Me.x,F*Me.y],je=4,qe=je*je;Fe=Fe.filter((F=>{const Me=F.canonical.x+.5-Oe[0],Le=F.canonical.y+.5-Oe[1];return Me*Me+Le*Le<qe}))}return Fe}coveringTiles(Me){let Le=this.coveringZoomLevel(Me);const Oe=Le,Fe=this.elevation&&this.elevation.exaggeration(),je=Fe&&!Me.isTerrainDEM,qe="mercator"===this.projection.name;if(void 0!==Me.minzoom&&Le<Me.minzoom)return[];void 0!==Me.maxzoom&&Le>Me.maxzoom&&(Le=Me.maxzoom);const He=this.locationCoordinate(this.center),xt=this.center.lat,Pt=1<<Le,jt=[Pt*He.x,Pt*He.y,0],Gt="globe"===this.projection.name,bi=!Gt,wi=F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,Le,bi),qr=Gt?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Xn=Pt*F.bH(1,this.center.lat),Yn=this._camera.position[2]/F.bH(1,this.center.lat),yo=[Pt*qr.x,Pt*qr.y,Yn*(bi?1:Xn)],bo=Gt||Fe,Ro=this.cameraToCenterDistance/Me.tileSize*(Me.roundZoom?1:.502),Do=this.isLODDisabled(!0)?Le:0;let zs;if(this._elevation&&Me.isTerrainDEM)zs=1e4*this._elevation.exaggeration();else if(this._elevation){const F=this._elevation.getMinMaxForVisibleTiles();zs=F?F.max:this._centerAltitude}else zs=this._centerAltitude;const Zs=Me.isTerrainDEM?-zs:this._elevation?this._elevation.getMinElevationBelowMSL():0,na=this.projection.isReprojectedInTileSpace?F.bS(this):1,E=Me=>{const Le=1/4e4,Oe=new F.ac(Me.x+Le,Me.y,Me.z),Fe=new F.ac(Me.x,Me.y+Le,Me.z),je=Me.toLngLat(),qe=Oe.toLngLat(),He=Fe.toLngLat(),xt=this.locationCoordinate(je),Pt=this.locationCoordinate(qe),jt=this.locationCoordinate(He),Gt=Math.hypot(Pt.x-xt.x,Pt.y-xt.y),bi=Math.hypot(jt.x-xt.x,jt.y-xt.y);return Math.sqrt(Gt*bi)*na/Le},S=Me=>{const Le=zs,Oe=Zs;return{aabb:F.bV(this,Pt,0,0,0,Me,Oe,Le,this.projection),zoom:0,x:0,y:0,minZ:Oe,maxZ:Le,wrap:Me,fullyVisible:!1}},el=[];let nl=[];const hl=Le,pl=Me.reparseOverscaled?Oe:Le,bl=(Yn-this._centerAltitude)*Xn,L=F=>{if(!this._elevation||!F.tileID||!qe)return;const Me=this._elevation.getMinMaxForTile(F.tileID),Le=F.aabb;Me?(Le.min[2]=Me.min,Le.max[2]=Me.max,Le.center[2]=(Le.min[2]+Le.max[2])/2):(F.shouldSplit=M(F),F.shouldSplit||(Le.min[2]=Le.max[2]=Le.center[2]=this._centerAltitude))},P=(F,Me)=>{if(.707*Me<F)return 1;const Le=Me/F;return Le/(1.4144271570014144+(Math.pow(1.1,Le-1.4144271570014144+1)-1)/(1.1-1)-1)},M=Me=>{if(Me.zoom<Do)return!0;if(Me.zoom===hl)return!1;if(null!=Me.shouldSplit)return Me.shouldSplit;const Le=Me.aabb.distanceX(yo),Fe=Me.aabb.distanceY(yo);let He=bl,Pt=1;if(Gt){He=Me.aabb.distanceZ(yo);const Le=Math.pow(2,Me.zoom),Oe=F.aT((Me.y+1)/Le),Fe=F.aT(Me.y/Le),je=Math.min(Math.max(xt,Oe),Fe),qe=F.ca(je)/F.ca(xt);if(Pt=je===xt?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,qe/this._mercatorScaleRatio),this.zoom<=F.c6&&Me.zoom===hl-1&&qe>=.9)return!0}else if(je&&(He=Me.aabb.distanceZ(yo)*Xn),this.projection.isReprojectedInTileSpace&&Oe<=5){const Le=Math.pow(2,Me.zoom),Oe=E(new F.ac((Me.x+.5)/Le,(Me.y+.5)/Le));Pt=Oe>.85?1:Oe}if(!qe){const F=Math.sqrt(Le*Le+Fe*Fe+He*He);let Oe=(1<<hl-Me.zoom)*Ro*Pt;return Oe*=P(Math.max(He,bl),F),F<Oe}let bi=Number.MAX_VALUE,wi=0;const qr=Me.aabb.getCorners(),Yn=[];for(const Me of qr){F.ad.vec3.sub(Yn,Me,yo),Gt||(je?Yn[2]*=Xn:Yn[2]=bl);const Le=F.ad.vec3.dot(Yn,this._camera.forward());Le<bi&&(bi=Le,wi=Math.abs(Yn[2]))}let bo=(1<<hl-Me.zoom)*Ro*Pt;if(bo*=P(Math.max(wi,bl),bi),bi<bo)return!0;const zs=Me.aabb.closestPoint(jt);return zs[0]===jt[0]&&zs[1]===jt[1]};if(this.renderWorldCopies)for(let F=1;F<=3;F++)el.push(S(-F)),el.push(S(F));for(el.push(S(0));el.length>0;){const Oe=el.pop(),Fe=Oe.x,He=Oe.y;let xt=Oe.fullyVisible;const u=()=>"globe"===this.projection.name&&(0===Oe.y||Oe.y===(1<<Oe.zoom)-1);if(!xt){let Me=bo?Oe.aabb.intersects(wi):Oe.aabb.intersectsFlat(wi);if(0===Me&&u()){const Le=new F.bT(Oe.zoom,Fe,He);Me=F.bU(this,Pt,Le,!0).intersects(wi)}if(0===Me)continue;xt=2===Me}if(Oe.zoom!==hl&&M(Oe))for(let Me=0;Me<4;Me++){const Le=(Fe<<1)+Me%2,jt=(He<<1)+(Me>>1),bi={aabb:qe?Oe.aabb.quadrant(Me):F.bV(this,Pt,Oe.zoom+1,Le,jt,Oe.wrap,Oe.minZ,Oe.maxZ,this.projection),zoom:Oe.zoom+1,x:Le,y:jt,wrap:Oe.wrap,fullyVisible:xt,tileID:void 0,shouldSplit:void 0,minZ:Oe.minZ,maxZ:Oe.maxZ};je&&!Gt&&(bi.tileID=new F.aH(Oe.zoom+1===hl?pl:Oe.zoom+1,Oe.wrap,Oe.zoom+1,Le,jt),L(bi)),el.push(bi)}else{const je=Oe.zoom===hl?pl:Oe.zoom;if(Me.minzoom&&Me.minzoom>je)continue;let qe=0;if(!xt){let Le=bo?Oe.aabb.intersectsPrecise(wi):Oe.aabb.intersectsPreciseFlat(wi);if(0===Le&&u()){const Me=new F.bT(Oe.zoom,Fe,He);Le=F.bU(this,Pt,Me,!0).intersectsPrecise(wi)}if(0===Le)continue;if(Me.calculateQuadrantVisibility)if(wi.containsPoint(Oe.aabb.center))qe=15;else for(let F=0;F<4;F++)0!==Oe.aabb.quadrant(F).intersects(wi)&&(qe|=1<<F)}const Gt=jt[0]-(.5+Fe+(Oe.wrap<<Oe.zoom))*(1<<Le-Oe.zoom),bi=jt[1]-.5-He,qr=Oe.tileID?Oe.tileID:new F.aH(je,Oe.wrap,Oe.zoom,Fe,He);Me.calculateQuadrantVisibility&&(qr.visibleQuadrants=qe),nl.push({tileID:qr,distanceSq:Gt*Gt+bi*bi})}}if(this.fogCullDistSq){const Le=this.fogCullDistSq,Oe=this.horizonLineFromTop();nl=nl.filter((Fe=>{const je=[0,0,0,1],qe=[F.ai,F.ai,0,1],He=this.calculateFogTileMatrix(Fe.tileID.toUnwrapped());F.ad.vec4.transformMat4(je,je,He),F.ad.vec4.transformMat4(qe,qe,He);const xt=F.ad.vec4.min([],je,qe),Pt=F.ad.vec4.max([],je,qe),jt=F.bW(xt,Pt);if(0===jt)return!0;let Gt=!1;const bi=this._elevation;if(bi&&jt>Le&&0!==Oe){const Le=this.calculateProjMatrix(Fe.tileID.toUnwrapped());let je;Me.isTerrainDEM||(je=bi.getMinMaxForTile(Fe.tileID)),je||(je={min:Zs,max:zs});const qe=F.c7(this.rotation),He=[qe[0]*F.ai,qe[1]*F.ai,je.max];F.ad.vec3.transformMat4(He,He,Le),Gt=(1-He[1])*this.height*.5<Oe}return jt<Le||Gt}))}return nl.sort(((F,Me)=>F.distanceSq-Me.distanceSq)).map((F=>F.tileID))}resize(F,Me){this.width=F,this.height=Me,this.pixelsToGLUnits=[2/F,-2/Me],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(F){return Math.pow(2,F)}scaleZoom(F){return Math.log(F)/Math.LN2}project(Me){const Le=F.ay(Me.lat,-F.bX,F.bX),Oe=this.projection.project(Me.lng,Le);return new F.P(Oe.x*this.worldSize,Oe.y*this.worldSize)}unproject(F){return this.projection.unproject(F.x/this.worldSize,F.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/F.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(Me,Le){let Oe,Fe;const je=this.centerPoint;if("globe"===this.projection.name){const F=this.worldSize;Oe=(Le.x-je.x)/F,Fe=(Le.y-je.y)/F}else{const F=this.pointCoordinate(Le),Me=this.pointCoordinate(je);Oe=F.x-Me.x,Fe=F.y-Me.y}const qe=this.locationCoordinate(Me);this.setLocation(new F.ac(qe.x-Oe,qe.y-Fe))}setLocation(F){this.center=this.coordinateLocation(F),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(F,Me){return this.projection.locationPoint(this,F,Me)}locationPoint3D(F,Me){return this.projection.locationPoint(this,F,Me,!0)}pointLocation(F){return this.coordinateLocation(this.pointCoordinate(F))}pointLocation3D(F,Me){return this.coordinateLocation(this.pointCoordinate3D(F,Me))}locationCoordinate(Me,Le){const Oe=Le?F.bH(Le,Me.lat):void 0,Fe=this.projection.project(Me.lng,Me.lat);return new F.ac(Fe.x,Fe.y,Oe)}coordinateLocation(F){return this.projection.unproject(F.x,F.y)}pointRayIntersection(Me,Le){const Oe=null!=Le?Le:this._centerAltitude,Fe=[Me.x,Me.y,0,1],je=[Me.x,Me.y,1,1];F.ad.vec4.transformMat4(Fe,Fe,this.pixelMatrixInverse),F.ad.vec4.transformMat4(je,je,this.pixelMatrixInverse);const qe=je[3];F.ad.vec4.scale(Fe,Fe,1/Fe[3]),F.ad.vec4.scale(je,je,1/qe);const He=Fe[2],xt=je[2];return{p0:Fe,p1:je,t:He===xt?0:(Oe-He)/(xt-He)}}screenPointToMercatorRay(Me){const Le=[Me.x,Me.y,0,1],Oe=[Me.x,Me.y,1,1];return F.ad.vec4.transformMat4(Le,Le,this.pixelMatrixInverse),F.ad.vec4.transformMat4(Oe,Oe,this.pixelMatrixInverse),F.ad.vec4.scale(Le,Le,1/Le[3]),F.ad.vec4.scale(Oe,Oe,1/Oe[3]),Le[2]=F.bH(Le[2],this._center.lat)*this.worldSize,Oe[2]=F.bH(Oe[2],this._center.lat)*this.worldSize,F.ad.vec4.scale(Le,Le,1/this.worldSize),F.ad.vec4.scale(Oe,Oe,1/this.worldSize),new F.as([Le[0],Le[1],Le[2]],F.ad.vec3.normalize([],F.ad.vec3.sub([],Oe,Le)))}rayIntersectionCoordinate(Me){const{p0:Le,p1:Oe,t:Fe}=Me,je=F.bH(Le[2],this._center.lat),qe=F.bH(Oe[2],this._center.lat);return new F.ac(F.ah(Le[0],Oe[0],Fe)/this.worldSize,F.ah(Le[1],Oe[1],Fe)/this.worldSize,F.ah(je,qe,Fe))}pointCoordinate(F,Me=this._centerAltitude){return this.projection.pointCoordinate(this,F.x,F.y,Me)}pointCoordinate3D(Me,Le){if(!this.elevation)return this.pointCoordinate(Me,Le);let Oe=this.projection.pointCoordinate3D(this,Me.x,Me.y);if(Oe)return new F.ac(Oe[0],Oe[1],Oe[2]);let Fe=0,je=this.horizonLineFromTop();if(Me.y>je)return this.pointCoordinate(Me,Le);const qe=.02*je,He=Me.clone();for(let Me=0;Me<10&&je-Fe>qe;Me++){He.y=F.ah(Fe,je,.66);const Me=this.projection.pointCoordinate3D(this,He.x,He.y);Me?(je=He.y,Oe=Me):Fe=He.y}return Oe?new F.ac(Oe[0],Oe[1],Oe[2]):this.pointCoordinate(Me)}isPointAboveHorizon(F){return this.projection.isPointAboveHorizon(this,F)}isPointOnSurface(Me){if(Me.y<0||Me.y>this.height||Me.x<0||Me.x>this.width)return!1;if(this.elevation||this.zoom>=F.bY)return!this.isPointAboveHorizon(Me);const Le=this.pointCoordinate(Me);return Le.y>=0&&Le.y<=1}_coordinatePoint(Me,Le){const Oe=Le&&this.elevation?this.elevation.getAtPointOrZero(Me,this._centerAltitude):this._centerAltitude,Fe=[Me.x*this.worldSize,Me.y*this.worldSize,Oe+Me.toAltitude(),1];return F.ad.vec4.transformMat4(Fe,Fe,this.pixelMatrix),Fe[3]>0?new F.P(Fe[0]/Fe[3],Fe[1]/Fe[3]):new F.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:Me,left:Le}=this._edgeInsets,Oe=this.height-this._edgeInsets.bottom,Fe=this.width-this._edgeInsets.right,je=this.pointLocation3D(new F.P(Le,Me)),qe=this.pointLocation3D(new F.P(Fe,Me)),He=this.pointLocation3D(new F.P(Fe,Oe)),xt=this.pointLocation3D(new F.P(Le,Oe));let Pt=Math.min(je.lng,qe.lng,He.lng,xt.lng),jt=Math.max(je.lng,qe.lng,He.lng,xt.lng),Gt=Math.min(je.lat,qe.lat,He.lat,xt.lat),bi=Math.max(je.lat,qe.lat,He.lat,xt.lat);const wi=Math.pow(2,-this.zoom)/16*270,qr="globe"===this.projection.name?1:4,f=(Me,Le,Oe,Fe,je)=>{const qe=(Me+Oe)/2,He=(Le+Fe)/2,xt=new F.P(qe,He),{lng:Xn,lat:Yn}=this.pointLocation3D(xt),yo=Math.max(0,Pt-Xn,Gt-Yn,Xn-jt,Yn-bi);Pt=Math.min(Pt,Xn),jt=Math.max(jt,Xn),Gt=Math.min(Gt,Yn),bi=Math.max(bi,Yn),(je<qr||yo>wi)&&(f(Me,Le,qe,He,je+1),f(qe,He,Oe,Fe,je+1))};if(f(Le,Me,Fe,Me,1),f(Fe,Me,Fe,Oe,1),f(Fe,Oe,Le,Oe,1),f(Le,Oe,Le,Me,1),"globe"===this.projection.name){const[Me,Le]=F.bZ(this);Me?(bi=90,jt=180,Pt=-180):Le&&(Gt=-90,jt=180,Pt=-180)}return new F.aB(new F.bO(Pt,Gt),new F.bO(jt,bi))}_getBoundsRectangular(Me,Le){const{top:Oe,left:Fe}=this._edgeInsets,je=this.height-this._edgeInsets.bottom,qe=this.width-this._edgeInsets.right,He=new F.P(Fe,Oe),xt=new F.P(qe,Oe),Pt=new F.P(qe,je),jt=new F.P(Fe,je);let Gt=this.pointCoordinate(He,Me),bi=this.pointCoordinate(xt,Me);const wi=this.pointCoordinate(Pt,Le),qr=this.pointCoordinate(jt,Le),f=(F,Me)=>(Me.y-F.y)/(Me.x-F.x);return Gt.y>1&&bi.y>=0?Gt=new F.ac((1-qr.y)/f(qr,Gt)+qr.x,1):Gt.y<0&&bi.y<=1&&(Gt=new F.ac(-qr.y/f(qr,Gt)+qr.x,0)),bi.y>1&&Gt.y>=0?bi=new F.ac((1-wi.y)/f(wi,bi)+wi.x,1):bi.y<0&&Gt.y<=1&&(bi=new F.ac(-wi.y/f(wi,bi)+wi.x,0)),(new F.aB).extend(this.coordinateLocation(Gt)).extend(this.coordinateLocation(bi)).extend(this.coordinateLocation(qr)).extend(this.coordinateLocation(wi))}_getBoundsRectangularTerrain(){const F=this.elevation;if(!F.visibleDemTiles.length||F.isUsingMockSource())return this._getBoundsRectangular(0,0);const Me=F.visibleDemTiles.reduce(((F,Me)=>{if(Me.dem){const Le=Me.dem.tree;F.min=Math.min(F.min,Le.minimums[0]),F.max=Math.max(F.max,Le.maximums[0])}return F}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(Me.min*F.exaggeration(),Me.max*F.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(F=!0){const Me=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,Le=this.height/2-Me*(1-this._horizonShift);return F?Math.max(0,Le):Le}getMaxBounds(){return this.maxBounds}setMaxBounds(Me){this.maxBounds=Me,this.minLat=-F.bX,this.maxLat=F.bX,this.minLng=-180,this.maxLng=180,Me&&(this.minLat=Me.getSouth(),this.maxLat=Me.getNorth(),this.minLng=Me.getWest(),this.maxLng=Me.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=F.av(this.minLng)*this.tileSize,this.worldMaxX=F.av(this.maxLng)*this.tileSize,this.worldMinY=F.aC(this.maxLat)*this.tileSize,this.worldMaxY=F.aC(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(F,Me){return this.projection.createTileMatrix(this,Me,F)}calculateDistanceTileData(Me){const Le=Me.key,Oe=this._distanceTileDataCache;if(Oe[Le])return Oe[Le];const Fe=Me.canonical,je=1/this.height,qe=this.cameraWorldSize,He=qe/this.zoomScale(Fe.z),xt=(Fe.x+Math.pow(2,Fe.z)*Me.wrap)*He,Pt=Fe.y*He,jt=this.point;jt.x*=qe/this.worldSize,jt.y*=qe/this.worldSize;const Gt=this.angle,bi=Math.sin(-Gt),wi=-Math.cos(-Gt);return Oe[Le]={bearing:[bi,wi],center:[(jt.x-xt)*je,(jt.y-Pt)*je],scale:He/F.ai*je},Oe[Le]}calculateFogTileMatrix(Me){const Le=Me.key,Oe=this._fogTileMatrixCache;if(Oe[Le])return Oe[Le];const Fe=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,Me);return F.ad.mat4.multiply(Fe,this.worldToFogMatrix,Fe),Oe[Le]=new Float32Array(Fe),Oe[Le]}calculateProjMatrix(Me,Le=!1,Oe=!1){const Fe=Me.key;let je;if(je=Oe?this._expandedProjMatrixCache:Le?this._alignedProjMatrixCache:this._projMatrixCache,je[Fe])return je[Fe];const qe=this.calculatePosMatrix(Me,this.worldSize);let He;return He=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:Oe?this.expandedFarZProjMatrix:Le?this.alignedProjMatrix:this.projMatrix,F.ad.mat4.multiply(qe,He,qe),je[Fe]=new Float32Array(qe),je[Fe]}calculatePixelsToTileUnitsMatrix(Me){const Le=Me.tileID.key,Oe=this._pixelsToTileUnitsCache;if(Oe[Le])return Oe[Le];const Fe=F.b_(Me,this);return Oe[Le]=Fe,Oe[Le]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const Me=1/this.worldSize,Le=F.ad.mat4.fromScaling([],[Me,Me,Me]);return F.ad.mat4.multiply(Le,Le,this.globeMatrix),Le}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const Me=this._elevation;this._updateCameraState();const Le=F.bH(1,this._center.lat)*this.worldSize,Oe=this._computeCameraPosition(Le),Fe=this._camera.forward(),je=F.bH(1,this._center.lat);Oe[2]/=je,Fe[2]/=je,F.ad.vec3.normalize(Fe,Fe);const qe=Me.raycast(Oe,Fe,Me.exaggeration());if(qe){const Me=F.ad.vec3.scaleAndAdd([],Oe,Fe,qe),Le=new F.ac(Me[0],Me[1],F.bH(Me[2],F.aT(Me[1]))),He=(Le.z+F.ad.vec3.length([Le.x-Oe[0],Le.y-Oe[1],Le.z-Oe[2]*je]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(He),this._centerAltitude=Le.toAltitude(),this._center=this.coordinateLocation(Le),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(Me=!1){if(!this._elevation)return;const Le=this._elevation,Oe=F.bH(1,this._center.lat)*this.worldSize,Fe=this._computeCameraPosition(Oe),je=Le.getAtPointOrZero(new F.ac(...Fe)),qe=this.pixelsPerMeter/this.worldSize*je,He=this._minimumHeightOverTerrain(),xt=Fe[2]-qe;if(xt<=He)if(xt<0||Me){const Me=this.locationCoordinate(this._center,this._centerAltitude),Le=[Fe[0],Fe[1],Me.z-Fe[2]],Oe=F.ad.vec3.length(Le);Le[2]-=(He-xt)/this._pixelsPerMercatorPixel;const je=F.ad.vec3.length(Le);if(0===je)return;F.ad.vec3.scale(Le,Le,Oe/je*this._pixelsPerMercatorPixel),this._camera.position=[Fe[0],Fe[1],Me.z*this._pixelsPerMercatorPixel-Le[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const Me="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||Me){const Le=this.center;return Le.lat=F.ay(Le.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!Me)&&(Le.lng=F.ay(Le.lng,this.minLng,this.maxLng)),this.center=Le,void(this._constraining=!1)}const Le=this._unmodified,{x:Oe,y:Fe}=this.point;let je=0,qe=Oe,He=Fe;const xt=this.width/2,Pt=this.height/2,jt=this.worldMinY*this.scale,Gt=this.worldMaxY*this.scale;if(Fe-Pt<jt&&(He=jt+Pt),Fe+Pt>Gt&&(He=Gt-Pt),Gt-jt<this.height&&(je=Math.max(je,this.height/(Gt-jt)),He=(Gt+jt)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const F=this.worldMinX*this.scale,Me=this.worldMaxX*this.scale,Le=this.worldSize/2-(F+Me)/2;qe=(Oe+Le+this.worldSize)%this.worldSize-Le,qe-xt<F&&(qe=F+xt),qe+xt>Me&&(qe=Me-xt),Me-F<this.width&&(je=Math.max(je,this.width/(Me-F)),qe=(Me+F)/2)}qe===Oe&&He===Fe||this._allowWorldUnderZoom||(this.center=this.unproject(new F.P(qe,He))),je&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(je)),this._constrainCamera(),this._unmodified=Le,this._constraining=!1}_minZoomForBounds(){let F=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(F=Math.max(F,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),F}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const Me=this.centerOffset,Le="globe"===this.projection.name,Oe=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=F.bH(1,this.center.lat)/F.bH(1,F.c8));const Fe=F.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,Fe),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const je="meters"===this.projection.zAxisUnit?Oe:1,qe=this._camera.getWorldToCamera(this.worldSize,je);let He;const xt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(xt[8]=2*-Me.x/this.width,xt[9]=2*Me.y/this.height,this.isOrthographic){let Le=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Oe=Le*this.aspect,Fe=-Oe,je=-Le;Oe-=Me.x,Fe-=Me.x,Le+=Me.y,je+=Me.y,He=this._camera.getCameraToClipOrthographic(Fe,Oe,je,Le,this._nearZ,this._farZ),((Me,Le,Oe,Fe)=>{for(let je=0;je<16;je++)Me[je]=F.ah(Le[je],Oe[je],Fe)})(He,He,xt,F.c9(this.pitch>=Vh?1:this.pitch/Vh))}else He=xt;const Pt=F.ad.mat4.mul([],xt,qe);let jt=F.ad.mat4.mul([],He,qe);if(this.projection.isReprojectedInTileSpace){const Me=this.locationCoordinate(this.center),Le=F.ad.mat4.identity([]);F.ad.mat4.translate(Le,Le,[Me.x*this.worldSize,Me.y*this.worldSize,0]),F.ad.mat4.multiply(Le,Le,F.c0(this)),F.ad.mat4.translate(Le,Le,[-Me.x*this.worldSize,-Me.y*this.worldSize,0]),F.ad.mat4.multiply(jt,jt,Le),F.ad.mat4.multiply(Pt,Pt,Le),this.inverseAdjustmentMatrix=F.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=F.ad.mat4.scale([],jt,[this.worldSize,this.worldSize,this.worldSize/je,1]),this.projMatrix=jt,this.invProjMatrix=F.ad.mat4.invert(new Float64Array(16),this.projMatrix),Le){const Le=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Le[8]=2*-Me.x/this.width,Le[9]=2*Me.y/this.height,this.expandedFarZProjMatrix=F.ad.mat4.mul([],Le,qe)}else this.expandedFarZProjMatrix=this.projMatrix;const Gt=F.ad.mat4.invert([],He);this.frustumCorners=F.c2.fromInvProjectionMatrix(Gt,this.horizonLineFromTop(),this.height),this.cameraFrustum=F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!Le);const bi=new Float32Array(16);F.ad.mat4.identity(bi),F.ad.mat4.scale(bi,bi,[1,-1,1]),F.ad.mat4.rotateX(bi,bi,this._pitch),F.ad.mat4.rotateZ(bi,bi,this.angle);const wi=F.ad.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=F.ad.mat4.clone(wi);const qr=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;wi[8]=2*-Me.x/this.width,wi[9]=2*(Me.y+qr)/this.height,this.skyboxMatrix=F.ad.mat4.multiply(bi,wi,bi);const Xn=this.point,Yn=Xn.x,yo=Xn.y,bo=this.width%2/2,Ro=this.height%2/2,Do=Math.cos(this.angle),zs=Math.sin(this.angle),Zs=Yn-Math.round(Yn)+Do*bo+zs*Ro,na=yo-Math.round(yo)+Do*Ro+zs*bo,el=new Float64Array(jt);if(F.ad.mat4.translate(el,el,[Zs>.5?Zs-1:Zs,na>.5?na-1:na,0]),this.alignedProjMatrix=el,jt=F.ad.mat4.create(),F.ad.mat4.scale(jt,jt,[this.width/2,-this.height/2,1]),F.ad.mat4.translate(jt,jt,[1,-1,0]),this.labelPlaneMatrix=jt,jt=F.ad.mat4.create(),F.ad.mat4.scale(jt,jt,[1,-1,1]),F.ad.mat4.translate(jt,jt,[-1,-1,0]),F.ad.mat4.scale(jt,jt,[2/this.width,2/this.height,1]),this.glCoordMatrix=jt,this.pixelMatrix=F.ad.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,Pt),this._calcFogMatrices(),this._distanceTileDataCache={},jt=F.ad.mat4.invert(new Float64Array(16),this.pixelMatrix),!jt)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=jt,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=F.c3(this);const Me=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=F.ad.vec3.transformMat4(Me,Me,qe),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=jt;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const Me=this.cameraWorldSizeForFog,Le=this.cameraPixelsPerMeter,Oe=this._camera.position,Fe=1/this.height/this._pixelsPerMercatorPixel,je=[Me,Me,Le];F.ad.vec3.scale(je,je,Fe),F.ad.vec3.scale(Oe,Oe,-1),F.ad.vec3.multiply(Oe,Oe,je);const qe=F.ad.mat4.create();F.ad.mat4.translate(qe,qe,Oe),F.ad.mat4.scale(qe,qe,je),this.mercatorFogMatrix=qe,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(Me,Le,Fe)}_computeCameraPosition(F){const Me=(F=F||this.pixelsPerMeter)/this.pixelsPerMeter,Le=this._camera.forward(),Oe=this.point,Fe=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*Me-F/this.worldSize*this._centerAltitude;return[Oe.x/this.worldSize-Le[0]*Fe,Oe.y/this.worldSize-Le[1]*Fe,F/this.worldSize*this._centerAltitude-Le[2]*Fe]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(Me){const Le=this._maxCameraBoundsDistance()*Math.cos(this._pitch),Oe=this._camera.position[2],Fe=Me[2];let je=1;this.projection.wrap&&(this.center=this.center.wrap()),Fe>0&&(je=Math.min((Le-Oe)/Fe,1)),this._camera.position=F.ad.vec3.scaleAndAdd([],this._camera.position,Me,je),this._updateStateFromCamera()}_updateStateFromCamera(){const Me=this._camera.position,Le=this._camera.forward(),{pitch:Oe,bearing:Fe}=this._camera.getPitchBearing(),je=F.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,qe=this._mercatorZfromZoom(this._maxZoom)*Math.cos(F.ak(this._maxPitch)),He=Math.max((Me[2]-je)/Math.cos(Oe),qe),xt=this._zoomFromMercatorZ(He);F.ad.vec3.scaleAndAdd(Me,Me,Le,He),this._pitch=F.ay(Oe,F.ak(this.minPitch),F.ak(this.maxPitch)),this.angle=F.bF(Fe,-Math.PI,Math.PI),this._setZoom(F.ay(xt,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new F.ac(Me[0],Me[1],Me[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(F){return Math.pow(2,F)*this.tileSize}_mercatorZfromZoom(F){return this.cameraToCenterDistance/this._worldSizeFromZoom(F)}_minimumHeightOverTerrain(){const F=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(F)}_zoomFromMercatorZ(F){return this.scaleZoom(this.cameraToCenterDistance/(F*this.tileSize))}zoomFromMercatorZAdjusted(Me){let Le=0,Oe=F.bY,Fe=0,je=1/0;for(;Oe-Le>1e-6&&Oe>Le;){const F=Le+.5*(Oe-Le),qe=this.tileSize*Math.pow(2,F),He=this.getCameraToCenterDistance(this.projection,F,qe),xt=this.scaleZoom(He/(Me*this.tileSize)),Pt=Math.abs(F-xt);Pt<je&&(je=Pt,Fe=F),F<xt?Le=F:Oe=F}return Fe}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(F.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(Me,Le){const Oe=Math.min(Me.x,Le.x),Fe=Math.max(Me.x,Le.x),je=Math.min(Me.y,Le.y),qe=Math.max(Me.y,Le.y);if(je<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const He=[new F.P(Oe,je),new F.P(Fe,qe),new F.P(Oe,qe),new F.P(Fe,je)],xt=this.renderWorldCopies?-3:0,Pt=this.renderWorldCopies?4:1;for(const F of He){const Me=this.pointRayIntersection(F);if(Me.t<0)return!0;const Le=this.rayIntersectionCoordinate(Me);if(Le.x<xt||Le.y<0||Le.x>Pt||Le.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+F.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new F.P(0,0),new F.P(this.width,this.height))}zoomDeltaToMovement(Me,Le){const Oe=F.ad.vec3.length(F.ad.vec3.sub([],this._camera.position,Me)),Fe=this._zoomFromMercatorZ(Oe)+Le;return Oe-this._mercatorZfromZoom(Fe)}getCameraPoint(){if("globe"===this.projection.name){const Me=function([Me,Le,Oe],Fe){const je=[Me,Le,Oe,1];F.ad.vec4.transformMat4(je,je,Fe);const qe=je[3]=Math.max(je[3],1e-6);return je[0]/=qe,je[1]/=qe,je[2]/=qe,je}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new F.P(Me[0],Me[1])}{const Me=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new F.P(0,Me))}}getCameraToCenterDistance(Me,Le=this.zoom,Oe=this.worldSize){const Fe=F.b$(Me,Le,this.width,this.height,1024),je=Me.pixelSpaceConversion(this.center.lat,Oe,Fe);let qe=.5/Math.tan(.5*this._fov)*this.height*je;return this.isOrthographic&&(qe=F.ah(1,qe,F.c9(this.pitch>=Vh?1:this.pitch/Vh))),qe}getWorldToCameraMatrix(){const Me=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&F.ad.mat4.multiply(Me,Me,this.globeMatrix),Me}getFrustum(Me){return F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,Me,"meters"===this.projection.zAxisUnit)}}const Qi=(Me,Le)=>{if(Le>0&&Me.terrain&&F.w("Cutoff is currently disabled on terrain"),Le<=0||Me.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const Oe=Me.transform,Fe=Math.max(Math.abs(Oe._zoom-(Me.minCutoffZoom-1)),1),je=Oe.isLODDisabled(!1)?F.ae(60,45,Oe.pitch):F.ae(30,15,Oe.pitch),qe=Oe._farZ-Oe._nearZ,He=Le*Oe.height,xt=((1-(Pt=je))*Oe.cameraToCenterDistance+Pt*(Oe._farZ+He))*Fe;var Pt;return{shouldRenderCutoff:je<1,uniformValues:{u_cutoff_params:[Oe._nearZ,Oe._farZ,(xt-Oe._nearZ)/qe,(xt-He-Oe._nearZ)/qe]}}},Uh={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class to{constructor(F,Me){this.aabb=F,this.lastCascade=Me}}class io{add(F,Me){const Le=this.receivers[F.key];void 0!==Le?(Le.aabb.min[0]=Math.min(Le.aabb.min[0],Me.min[0]),Le.aabb.min[1]=Math.min(Le.aabb.min[1],Me.min[1]),Le.aabb.min[2]=Math.min(Le.aabb.min[2],Me.min[2]),Le.aabb.max[0]=Math.max(Le.aabb.max[0],Me.max[0]),Le.aabb.max[1]=Math.max(Le.aabb.max[1],Me.max[1]),Le.aabb.max[2]=Math.max(Le.aabb.max[2],Me.max[2])):this.receivers[F.key]=new to(Me,null)}clear(){this.receivers={}}get(F){return this.receivers[F.key]}computeRequiredCascades(Me,Le,Oe){const Fe=F.ce.fromPoints(Me.points);let je=0;for(const Me in this.receivers){const qe=this.receivers[Me];if(!qe)continue;if(!Fe.intersectsAabb(qe.aabb))continue;qe.aabb.min=Fe.closestPoint(qe.aabb.min),qe.aabb.max=Fe.closestPoint(qe.aabb.max);const He=qe.aabb.getCorners();for(let Me=0;Me<Oe.length;Me++){let Fe=!0;for(const je of He){const qe=[je[0]*Le,je[1]*Le,je[2]];if(F.ad.vec3.transformMat4(qe,qe,Oe[Me].matrix),qe[0]<-1||qe[0]>1||qe[1]<-1||qe[1]>1){Fe=!1;break}}if(qe.lastCascade=Me,je=Math.max(je,Me),Fe)break}}return je+1}}class oo{constructor(F){this.painter=F,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new io,this._depthMode=new Bi(F.context.gl.LEQUAL,Bi.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,F.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),F.tp.registerParameter(Uh,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),F.tp.registerParameter(Uh,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),F.tp.registerParameter(Uh,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),F.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const F of this._cascades)F.texture.destroy(),F.framebuffer.destroy();this._cascades=[]}updateShadowParameters(Me,Le){const Oe=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!Le||!Le.properties)return;const Fe=Le.properties.get("shadow-intensity");if(!Le.shadowsEnabled()||Fe<=0)return;if(this._shadowLayerCount=Oe.style.order.reduce(((F,Le)=>{const Fe=Oe.style._mergedLayers[Le];return F+(Fe.hasShadowPass()&&!Fe.isHidden(Me.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled)return;const je=Oe.context,qe=Uh.shadowMapResolution,He=Uh.shadowMapResolution;if(0===this._cascades.length||Uh.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let Me=0;Me<Uh.cascadeCount;++Me){const Me=Oe._shadowMapDebug,Le=je.gl,Fe=je.createFramebuffer(qe,He,Me,"texture"),xt=new F.T(je,{width:qe,height:He,data:null},Le.DEPTH_COMPONENT16);if(Fe.depthAttachment.set(xt.texture),Me){const Me=new F.T(je,{width:qe,height:He,data:null},Le.RGBA8);Fe.colorAttachment.set(Me.texture)}this._cascades.push({framebuffer:Fe,texture:xt,matrix:[],far:0,boundingSphereRadius:0,frustum:new F.bR,scale:0})}}this.shadowDirection=ro(Le);let xt=0;if(Me.elevation){const F=Me.elevation,Le=[1e4,-1e4];F.visibleDemTiles.filter((F=>F.dem)).forEach((F=>{const Me=F.dem.tree;Le[0]=Math.min(Le[0],Me.minimums[0]),Le[1]=Math.max(Le[1],Me.maximums[0])})),1e4!==Le[0]&&(xt=(Le[1]-Le[0])*F.exaggeration())}const Pt=1.5*Me.cameraToCenterDistance,jt=3*Pt,Gt=new Float64Array(16);for(let Le=0;Le<this._cascades.length;++Le){const Oe=this._cascades[Le];let Fe=Me.height/50,je=1;1===Uh.cascadeCount?je=jt:0===Le?je=Pt:(Fe=Pt,je=jt);const[qe,He]=ao(Me,this.shadowDirection,Fe,je,Uh.shadowMapResolution,xt);Oe.scale=Me.scale,Oe.matrix=qe,Oe.boundingSphereRadius=He,F.ad.mat4.invert(Gt,Oe.matrix),Oe.frustum=F.bR.fromInvProjectionMatrix(Gt,1,0,!0),Oe.far=je}const bi=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[bi].far,this._cascades[bi].far],this._uniformValues.u_shadow_intensity=Fe,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Uh.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Uh.shadowMapResolution,this._uniformValues.u_shadowmap_0=Bh.ShadowMap0,this._uniformValues.u_shadowmap_1=Bh.ShadowMap0+1,this._groundShadowTiles=Oe.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const wi=Oe.transform.elevation;for(const F of this._groundShadowTiles){let Me={min:0,max:0};if(wi){const Le=wi.getMinMaxForTile(F);Le&&(Me=Le)}this.addShadowReceiver(F.toUnwrapped(),Me.min,Me.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(F){this._enabled=F}drawShadowPass(Me,Le){if(!this.enabled)return;const Oe=this.painter,Fe=Oe.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(Oe.transform.getFrustum(0),Oe.transform.worldSize,this._cascades),Fe.viewport.set([0,0,Uh.shadowMapResolution,Uh.shadowMapResolution]);for(let je=0;je<this._numCascadesToRender;++je){Oe.currentShadowCascade=je,Fe.bindFramebuffer.set(this._cascades[je].framebuffer.framebuffer),Fe.clear({color:F.al.white,depth:1});for(const F of Me.order){const Fe=Me._mergedLayers[F];if(!Fe.hasShadowPass()||Fe.isHidden(Oe.transform.zoom))continue;const je=Me.getLayerSourceCache(Fe),qe=je?Le[je.id]:void 0;("model"===Fe.type||qe&&qe.length)&&Oe.renderLayer(Oe,je,Fe,qe)}}Oe.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const F=this.painter,Me=F.style,Le=F.context,Oe=Me.directionalLight,Fe=Me.ambientLight;if(!Oe||!Fe)return;const je=[],qe=Qi(F,F.longestCutoffRange);qe.shouldRenderCutoff&&je.push("RENDER_CUTOFF"),je.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&je.push("NORMAL_OFFSET");const He=no(Me,Oe,Fe),xt=new Bi(Le.gl.LEQUAL,Bi.ReadOnly,F.depthRangeFor3D);for(const Me of this._groundShadowTiles){const Oe=Me.toUnwrapped(),Fe=F.isTileAffectedByFog(Me),Pt=F.getOrCreateProgram("groundShadow",{defines:je,overrideFog:Fe});this.setupShadows(Oe,Pt),F.uploadCommonUniforms(Le,Pt,Oe,null,qe);const jt={u_matrix:F.transform.calculateProjMatrix(Oe),u_ground_shadow_factor:He};Pt.draw(F,Le.gl.TRIANGLES,xt,Ui.disabled,ki.multiply,ji.disabled,jt,"ground_shadow",F.tileExtentBuffer,F.quadTriangleIndexBuffer,F.tileExtentSegments,null,F.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ki.unblended:ki.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(Me){const Le=this.painter.transform,Oe=Le.calculatePosMatrix(Me,Le.worldSize);return F.ad.mat4.multiply(Oe,this._cascades[this.painter.currentShadowCascade].matrix,Oe),Float32Array.from(Oe)}calculateShadowPassMatrixFromMatrix(Me){return F.ad.mat4.multiply(Me,this._cascades[this.painter.currentShadowCascade].matrix,Me),Float32Array.from(Me)}setupShadows(Me,Le,Oe,Fe=0){if(!this.enabled)return;const je=this.painter.transform,qe=this.painter.context,He=qe.gl,xt=this._uniformValues,Pt=new Float64Array(16),jt=je.calculatePosMatrix(Me,je.worldSize);for(let Me=0;Me<this._cascades.length;Me++)F.ad.mat4.multiply(Pt,this._cascades[Me].matrix,jt),xt[0===Me?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(Pt),qe.activeTexture.set(He.TEXTURE0+Bh.ShadowMap0+Me),this._cascades[Me].texture.bind(He.NEAREST,He.CLAMP_TO_EDGE);if(this.useNormalOffset=!!Oe,this.useNormalOffset){const Le=F.cd(Me.canonical),qe=2/je.tileSize*F.ai/Uh.shadowMapResolution,He=qe*this._cascades[0].boundingSphereRadius,Pt=qe*this._cascades[this._cascades.length-1].boundingSphereRadius,jt=("vector-tile"===Oe?1:3)/Math.pow(2,Fe-Me.canonical.z-(1-je.zoom+Math.floor(je.zoom)));xt.u_shadow_normal_offset=[Le,He*jt,Pt*jt],xt.u_shadow_bias=[6e-5,.0012,.012]}else xt.u_shadow_bias=[36e-5,.0012,.012];Le.setShadowUniformValues(qe,xt)}setupShadowsFromMatrix(Me,Le,Oe=!1){if(!this.enabled)return;const Fe=this.painter.context,je=Fe.gl,qe=this._uniformValues,He=new Float64Array(16);for(let Le=0;Le<Uh.cascadeCount;Le++)F.ad.mat4.multiply(He,this._cascades[Le].matrix,Me),qe[0===Le?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(He),Fe.activeTexture.set(je.TEXTURE0+Bh.ShadowMap0+Le),this._cascades[Le].texture.bind(je.NEAREST,je.CLAMP_TO_EDGE);if(this.useNormalOffset=Oe,Oe){const F=Uh.normalOffset;qe.u_shadow_normal_offset=[1,F,F],qe.u_shadow_bias=[6e-5,.0012,.012]}else qe.u_shadow_bias=[36e-5,.0012,.012];Le.setShadowUniformValues(Fe,qe)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(Me,Le,Oe,Fe){if(Fe[2]>=0)return{};const je=function(Me,Le,Oe){const Fe=Oe/(1<<Me.canonical.z);return new F.ce([Me.canonical.x*Fe+Me.wrap*Oe,Me.canonical.y*Fe+Me.wrap*Oe,0],[(Me.canonical.x+1)*Fe+Me.wrap*Oe,(Me.canonical.y+1)*Fe+Me.wrap*Oe,Le])}(Me,Le,Oe).getCorners(),qe=Le/-Fe[2];Fe[0]<0?(F.ad.vec3.add(je[0],je[0],[Fe[0]*qe,0,0]),F.ad.vec3.add(je[3],je[3],[Fe[0]*qe,0,0])):Fe[0]>0&&(F.ad.vec3.add(je[1],je[1],[Fe[0]*qe,0,0]),F.ad.vec3.add(je[2],je[2],[Fe[0]*qe,0,0])),Fe[1]<0?(F.ad.vec3.add(je[0],je[0],[0,Fe[1]*qe,0]),F.ad.vec3.add(je[1],je[1],[0,Fe[1]*qe,0])):Fe[1]>0&&(F.ad.vec3.add(je[2],je[2],[0,Fe[1]*qe,0]),F.ad.vec3.add(je[3],je[3],[0,Fe[1]*qe,0]));const He={};return He.vertices=je,He.planes=[so(je[1],je[0],je[4]),so(je[2],je[1],je[5]),so(je[3],je[2],je[6]),so(je[0],je[3],je[7])],He}addShadowReceiver(Me,Le,Oe){this._receivers.add(Me,F.ce.fromTileIdAndHeight(Me,Le,Oe))}getMaxCascadeForTile(F){const Me=this._receivers.get(F);return Me&&Me.lastCascade?Me.lastCascade:0}}function so(Me,Le,Oe){const Fe=F.ad.vec3.sub([],Oe,Le),je=F.ad.vec3.sub([],Me,Le),qe=F.ad.vec3.cross([],Fe,je),He=F.ad.vec3.length(qe);return 0===He?[0,0,1,0]:(F.ad.vec3.scale(qe,qe,1/He),[qe[0],qe[1],qe[2],-F.ad.vec3.dot(qe,Le)])}function ro(Me){const Le=Me.properties.get("direction"),Oe=F.cc(Le.x,Le.y,Le.z);Oe[2]=F.ay(Oe[2],0,75);const Fe=F.cf([Oe[0],Oe[1],Oe[2]]);return F.ad.vec3.fromValues(Fe.x,Fe.y,Fe.z)}function no(Me,Le,Oe){const Fe="none"===Le.properties.get("color-use-theme"),je=Le.properties.get("color"),qe=Le.properties.get("intensity"),He=Le.properties.get("direction"),xt=[He.x,He.y,He.z],Pt="none"===Oe.properties.get("color-use-theme"),jt=Oe.properties.get("color"),Gt=Oe.properties.get("intensity"),bi=Math.max(F.ad.vec3.dot([0,0,1],xt),0),wi=[0,0,0];F.ad.vec3.scale(wi,jt.toRenderColor(Pt?null:Me.getLut(Le.scope)).toArray01Linear().slice(0,3),Gt);const qr=[0,0,0];return F.ad.vec3.scale(qr,je.toRenderColor(Fe?null:Me.getLut(Oe.scope)).toArray01Linear().slice(0,3),bi*qe),F.cg([wi[0]>0?wi[0]/(wi[0]+qr[0]):0,wi[1]>0?wi[1]/(wi[1]+qr[1]):0,wi[2]>0?wi[2]/(wi[2]+qr[2]):0])}function ao(Me,Le,Oe,Fe,je,qe){const He=Me.zoom,xt=Me.scale,Pt=Me.worldSize,jt=1/Pt,Gt=Me.aspect,bi=Math.sqrt(1+Gt*Gt)*Math.tan(.5*Me.fovX),wi=bi*bi,qr=Fe-Oe,Xn=Fe+Oe;let Yn,yo;wi>qr/Xn?(Yn=Fe,yo=Fe*bi):(Yn=.5*Xn*(1+wi),yo=.5*Math.sqrt(qr*qr+2*(Fe*Fe+Oe*Oe)*wi+Xn*Xn*wi*wi));const bo=Me.projection.pixelsPerMeter(Me.center.lat,Pt),Ro=Me._camera.getCameraToWorldMercator(),Do=[0,0,-Yn*jt];F.ad.vec3.transformMat4(Do,Do,Ro);let zs=yo*jt;const Zs=Me._edgeInsets;if(!(0===Zs.left&&0===Zs.top&&0===Zs.right&&0===Zs.bottom||Zs.left===Zs.right&&Zs.top===Zs.bottom)){const Le=Me._camera.getWorldToCamera(Me.worldSize,"meters"===Me.projection.zAxisUnit?bo:1),je=Me._camera.getCameraToClipPerspective(Me._fov,Me.width/Me.height,Oe,Fe);je[8]=2*-Me.centerOffset.x/Me.width,je[9]=2*Me.centerOffset.y/Me.height;const qe=new Float64Array(16);F.ad.mat4.mul(qe,je,Le);const jt=new Float64Array(16);F.ad.mat4.invert(jt,qe);const Gt=F.bR.fromInvProjectionMatrix(jt,Pt,He,!0);for(const Le of Gt.points){const Oe=((na=Le)[0]/=xt,na[1]/=xt,na[2]=F.bH(na[2],Me._center.lat),na);zs=Math.max(zs,F.ad.vec3.len(F.ad.vec3.subtract([],Do,Oe)))}}var na;zs*=je/(je-1);const el=Math.acos(Le[2]),nl=Math.atan2(-Le[0],-Le[1]),hl=new $i;hl.position=Do,hl.setPitchBearing(el,nl);const pl=hl.getWorldToCamera(Pt,bo),bl=zs*Pt,Tl=Math.min(Me._mercatorZfromZoom(17)*Pt*-2,-2*bl),kl=hl.getCameraToClipOrthographic(-bl,bl,-bl,bl,Tl,(bl+qe*bo)/Le[2]),ec=new Float64Array(16);F.ad.mat4.multiply(ec,kl,pl);const tc=F.ad.vec3.fromValues(Math.floor(1e6*Do[0])/1e6*Pt,Math.floor(1e6*Do[1])/1e6*Pt,0),ic=.5*je,oc=[0,0,0];F.ad.vec3.transformMat4(oc,tc,ec),F.ad.vec3.scale(oc,oc,ic);const sc=[Math.floor(oc[0]),Math.floor(oc[1]),Math.floor(oc[2])],ac=[0,0,0];F.ad.vec3.sub(ac,oc,sc),F.ad.vec3.scale(ac,ac,-1/ic);const mc=new Float64Array(16);return F.ad.mat4.identity(mc),F.ad.mat4.translate(mc,mc,ac),F.ad.mat4.multiply(ec,mc,ec),[ec,bl]}class lo extends F.E{constructor(F){super(),this.requestManager=F,this.models={"":{}},this.modelUris={"":{}},this.numModelsLoading={}}loadModel(Me,Le){return F.aN(this.requestManager.transformRequest(Le,F.R.Model).url).then((Le=>{if(!Le)return;const Oe=F.aO(Le),Fe=new F.aP(Me,void 0,void 0,Oe);return Fe.computeBoundsAndApplyParent(),Fe})).catch((Oe=>{if(Oe&&404===Oe.status)return null;this.fire(new F.z(new Error(`Could not load model ${Me} from ${Le}: ${Oe.message}`)))}))}load(Me,Le,Oe={keepNumReferences:!1}){this.models[Le]||(this.models[Le]={});const Fe=Object.keys(Me);this.numModelsLoading[Le]=(this.numModelsLoading[Le]||0)+Fe.length;const je=[];for(const F of Fe)je.push(this.loadModel(F,Me[F]));Promise.allSettled(je).then((Me=>{for(let F=0;F<Me.length;F++){const{status:je,value:qe}=Me[F];if("fulfilled"===je&&qe){const Me=this.models[Le][Fe[F]];this.models[Le][Fe[F]]={model:qe,numReferences:Oe.keepNumReferences&&Me?Me.numReferences:1}}}this.numModelsLoading[Le]-=Fe.length,this.fire(new F.A("data",{dataType:"style"}))})).catch((Me=>{this.fire(new F.z(new Error(`Could not load models: ${Me.message}`)))}))}isLoaded(){for(const F in this.numModelsLoading)if(this.numModelsLoading[F]>0)return!1;return!0}hasModel(F,Me){return!!this.getModel(F,Me)}getModel(F,Me){return this.models[Me]||(this.models[Me]={}),this.models[Me][F]?this.models[Me][F].model:void 0}addModel(F,Me,Le){this.models[Le]||(this.models[Le]={}),this.modelUris[Le]||(this.modelUris[Le]={}),this.hasModel(F,Le)&&this.models[Le][F].numReferences++,this.modelUris[Le][F]=this.requestManager.normalizeModelURL(Me),this.load({[F]:this.modelUris[Le][F]},Le)}addModels(F,Me){this.models[Me]||(this.models[Me]={}),this.modelUris[Me]||(this.modelUris[Me]={});const Le=this.modelUris[Me];for(const Oe in F)this.models[Me][Oe]={},Le[Oe]=this.requestManager.normalizeModelURL(F[Oe]);this.load(Le,Me,{keepNumReferences:!0})}reloadModels(F){this.load(this.modelUris[F],F)}addModelsFromBucket(F,Me){this.models[Me]||(this.models[Me]={}),this.modelUris[Me]||(this.modelUris[Me]={});const Le={};for(const Oe of F)this.hasModel(Oe,Me)?this.models[Me][Oe].numReferences++:(this.modelUris[Me][Oe]=this.requestManager.normalizeModelURL(Oe),Le[Oe]=this.modelUris[Me][Oe]);this.load(Le,Me)}removeModel(F,Me){if(this.models[Me]&&this.models[Me][F]&&(this.models[Me][F].numReferences--,0===this.models[Me][F].numReferences)){const Le=this.models[Me][F].model;delete this.models[Me][F],delete this.modelUris[Me][F],Le.destroy()}}listModels(F){return this.models[F]||(this.models[F]={}),Object.keys(this.models[F])}upload(F,Me){this.models[Me]||(this.models[Me]={});for(const Le in this.models[Me])this.models[Me][Le].model&&this.models[Me][Le].model.upload(F.context)}}const Qh=new F.a7({data:new F.a8(F.a5.colorTheme.data)}),iu={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function uo(F){return F=F||{},Object.assign(F,iu)}class _o extends F.E{constructor(Me){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},F.aQ(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=Me,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle((Me=>{Me.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new F.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=Me.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=Me.stylesheet.indoor.buildingFeaturesetId,this._scope=Me.scope))})),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:F=>(F.feature&&F.feature.properties.floorplan&&this.selectFloorplan(F.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(Me){if(!this._queryFeatureSetId)return;if(!this._map.isStyleLoaded())return;if(this._map.transform.zoom<13)return;this._indoorData&&!function(F,Me){const[Le,Oe]=F,{center:Fe,radius:je}=Me,[qe,He]=Fe,xt=Math.abs(Le-qe);return Math.sqrt((xt>180?360-xt:xt)**2+(Oe-He)**2)<=je}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new F.A("floorplangone")));const Le={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},Oe=new F.P(this._map.transform.width/2,this._map.transform.height/2),Fe=[new F.P(0,0),new F.P(this._map.transform.width,this._map.transform.height)],je=this._map.queryRenderedFeatures(Me?Fe:Oe,Le);je.length>0&&(this._selectedFloorplan&&je[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=je[0],this._floorplanSelected(!1)))}_floorplanSelected(Me){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(F){const[[Me,Le],[Oe,Fe]]=F,je=(Oe-Me+360)%360,qe=je>180?360-je:je;return{center:[(Me+qe/2+360)%360,(Le+Fe)/2],radius:Math.sqrt(qe**2+(Fe-Le)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const Le=this._floorplanStates[this._indoorData.id].selectedBuilding,Oe=this._floorplanStates[this._indoorData.id].selectedLevel;let Fe;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const F of this._indoorData.levels)F.id===this._selectedLevel.id&&(Fe=F.id);if(this.fire(new F.A("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:Fe})),Le){const F=this._indoorData.buildings.find((F=>F.id===Le));this._buildingSelected(F,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(Oe){const F=this._indoorData.levels.find((F=>F.id===Oe));this._updateLevels(F,Me)}else Me&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(Me,Le){Le&&Me&&Me.extent&&this._map.fitBounds(Me.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=Me?Me.id:void 0;const Oe=this._indoorData.levels.filter((F=>Me.levels.includes(F.id)));this.fire(new F.A("buildingselected",{buildingId:Me.id,levels:Oe}))}_levelSelected(Me){if("overview"===Me)this._updateLevels(void 0,!0);else{const F=this._indoorData.levels.find((F=>F.id===Me));this._updateLevels(F,!0)}this.fire(new F.A("levelselected",{levelId:"overview"===Me?void 0:Me}))}_updateLevels(F,Me){if(!F)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(Me&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function i(F){const Me=F.indexOf("/floor/");if(-1===Me)return F;const Le=Me+7,Oe=F.indexOf("/",Le);return-1===Oe?F.slice(Le):F.slice(Le,Oe)}this._selectedLevel=F,this._floorplanStates[this._indoorData.id].selectedLevel=F?F.id:void 0;const Le=[],Oe={},Fe={},je={},qe={};for(const Me of this._indoorData.levels)if(Le.push(Me.id),Oe[Me.id]=Me.height,Fe[Me.id]=Me.base,F){if(this.mergeFloors){const Le=i(F.id),Oe=i(Me.id);je[Me.id]=Oe===Le?"true":"false"}else je[Me.id]=Me.id===F.id?"true":"false";qe[Me.id]=Me.base<F.base?"true":"false"}else qe[Me.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",Le]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",Oe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",Fe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",je]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",qe]),F&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!F.isUnderground),Me&&F.extent)){const Me=this._map.cameraForBounds(F.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),Le=this._map.getZoom(),Oe=Me.zoom?Math.abs(Le-Me.zoom):0;this._map.fitBounds(F.extent,Oe>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:Le})}}selectFloorplan(Me){const Le={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},Oe=[new F.P(0,0),new F.P(this._map.transform.width,this._map.transform.height)],Fe=this._map.queryRenderedFeatures(Oe,Le);if(Fe.length>0)for(const F of Fe)if(JSON.parse(F.properties["indoor-data"]).floorplanIDs.includes(Me)){this._selectedFloorplan=F,this._floorplanSelected(!0);break}}selectBuilding(F){const Me=this._indoorData.buildings.find((Me=>Me.id===F));this._buildingSelected(Me,!0)}selectLevel(F){this._levelSelected(F)}}function po(Me){if(!Me.metadata||!Me.metadata.content_area)return;const Le=F.q.devicePixelRatio,{left:Oe,top:Fe,width:je,height:qe}=Me.metadata.content_area,He=Oe*Le,xt=Fe*Le;return[He,xt,He+je*Le,xt+qe*Le]}function fo(Me){if(Me)return Me.map((([Me,Le])=>[Me*F.q.devicePixelRatio,Le*F.q.devicePixelRatio]))}class mo{constructor(F,Me,Le){this.id=F,this.scope=Me,this.sourceCache=Le,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(F){this.missingRequests.has(F.name)||this.pendingRequests.has(F.name)||this.pendingRequests.add(F.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const Me=new Map;if(!this.sourceCache.loaded())return Me;const Le=this.sourceCache.getVisibleCoordinates();if(0===Le.length)return Me;const Oe=this.sourceCache.getSource();if(!(Oe instanceof ot))return Me;const Fe=Le.map((F=>this.sourceCache.getTile(F))),je=Oe.getImages(Fe,Array.from(this.pendingRequests));for(const[Le,Oe]of je)Me.set(F.I.from({name:Le,iconsetId:this.id}),Oe),this.pendingRequests.delete(Le);for(const F of this.pendingRequests)this.missingRequests.add(F);return this.pendingRequests.clear(),Me}}const go=(F,Me)=>Ae(F,Me&&Me.filter((F=>"source.canvas"!==F.identifier))),ru=F.aA(eh,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),nu=F.aA(eh,["setCenter","setZoom","setBearing","setPitch"]),su=new Set(["background","sky","slot","custom"]),au={version:8,layers:[],sources:{}},hu={duration:300,delay:0};class To extends F.E{constructor(Me,Le={}){super(),this.map=Me,this.scope=Le.scope||"",this.globalId=null,this.fragments=[],this.importDepth=Le.importDepth||0,this.importsCache=Le.importsCache||new Map,this.resolvedImports=Le.resolvedImports||new Set,this.transition=F.l({},hu),this._buildingIndex=new Dt(this),this.crossTileSymbolIndex=new Oi,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=Le.styleChanges||new G,this.dispatcher=Le.dispatcher?Le.dispatcher:new F.D(F.cj(),this),Le.imageManager?this.imageManager=Le.imageManager:(this.imageManager=new q(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=Le.glyphManager?Le.glyphManager:new F.ck(Me._requestManager,Le.localFontFamily?F.cl.all:Le.localIdeographFontFamily?F.cl.ideographs:F.cl.none,Le.localFontFamily||Le.localIdeographFontFamily),Le.modelManager?this.modelManager=Le.modelManager:(this.modelManager=new lo(Me._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=Le.configOptions?Le.configOptions:new Map,this._configDependentLayers=Le.configDependentLayers?Le.configDependentLayers:new Set,this._config=Le.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:Le.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=Le.initialConfig,this.dispatcher.broadcast("setReferrer",F.cm());const Oe=this;this._rtlTextPluginCallback=To.registerForPluginStateChange((Me=>{Oe.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:Me.pluginStatus,pluginURL:Me.pluginURL},((Me,Le)=>{if(F.cn(Me),Le&&Le.every((F=>F)))for(const F in Oe._sourceCaches){const Me=Oe._sourceCaches[F],Le=Me.getSource().type;"vector"!==Le&&"geojson"!==Le||Me.reload()}}))})),this.on("data",(F=>{if("source"!==F.dataType||"metadata"!==F.sourceDataType)return;const Me=this.getOwnSource(F.sourceId);if(Me&&Me.vectorLayerIds)for(const F in this._layers){const Le=this._layers[F];Le.source===Me.id&&this._validateLayer(Le)}}))}load(F){return F?("string"==typeof F?this.loadURL(F):this.loadJSON(F),this):this}_getGlobalId(Me){if(!Me)return null;if("string"==typeof Me){if(F.f(Me))return Me;const Le=F.co(Me);if(!Le.startsWith("http"))try{return new URL(Le,location.href).toString()}catch(F){return Le}return Le}return`json://${F.cp(JSON.stringify(Me))}`}_diffStyle(Me,Le,Oe){this.globalId=this._getGlobalId(Me);const s=(F,Me)=>{try{Me(null,this.setState(F,Oe))}catch(F){Me(F,!1)}};if("string"==typeof Me){const Oe=this.map._requestManager.normalizeStyleURL(Me),Fe=this.map._requestManager.transformRequest(Oe,F.R.Style);F.n(Fe,((Me,Oe)=>{Me?this.fire(new F.z(Me)):Oe&&s(Oe,Le)}))}else"object"==typeof Me&&s(Me,Le)}loadURL(Me,Le={}){this.fire(new F.A("dataloading",{dataType:"style"}));const Oe="boolean"==typeof Le.validate?Le.validate:!F.f(Me);this.globalId=this._getGlobalId(Me),Me=this.map._requestManager.normalizeStyleURL(Me,Le.accessToken),this.resolvedImports.add(Me);const Fe=this.importsCache.get(Me);if(Fe)return this._load(Fe,Oe);const je=this.map._requestManager.transformRequest(Me,F.R.Style);this._request=F.n(je,((Le,Fe)=>{if(this._request=null,Le)this.fire(new F.z(Le));else if(Fe)return this.importsCache.set(Me,Fe),this._load(Fe,Oe)}))}loadJSON(Me,Le={}){this.fire(new F.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(Me),this._request=F.q.frame((()=>{this._request=null,this._load(Me,!1!==Le.validate)}))}loadEmpty(){this.fire(new F.A("dataloading",{dataType:"style"})),this._load(au,!1)}_loadImports(Me,Le,Oe){if(this.importDepth>=4)return F.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const Fe=[];for(const F of Me){const Me=this._createFragmentStyle(F),je=new Promise((F=>{Me.once("style.import.load",F),Me.once("error",F)})).then((()=>this.mergeAll()));if(Fe.push(je),this.resolvedImports.has(F.url)){Me.loadEmpty();continue}const qe=F.data||this.importsCache.get(F.url);qe?(Me.loadJSON(qe,{validate:Le}),this._isInternalStyle(qe)&&(Me.globalId=null)):F.url?Me.loadURL(F.url,{validate:Le}):Me.loadEmpty();const He={style:Me,id:F.id,config:F.config};if(Oe){const F=this.fragments.findIndex((({id:F})=>F===Oe));this.fragments=this.fragments.slice(0,F).concat(He).concat(this.fragments.slice(F))}else this.fragments.push(He)}return Promise.allSettled(Fe)}getImportGlobalIds(F=this,Me=new Set){for(const Le of F.fragments)Le.style.globalId&&Me.add(Le.style.globalId),this.getImportGlobalIds(Le.style,Me);return[...Me.values()]}_createFragmentStyle(Me){const Le=this.scope?F.C(Me.id,this.scope):Me.id;let Oe;const Fe=this._initialConfig&&this._initialConfig[Le];(Me.config||Fe)&&(Oe=F.l({},Me.config,Fe));const je=new To(this.map,{scope:Le,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:Oe,configOptions:this.options,colorThemeOverride:Me["color-theme"],configDependentLayers:this._configDependentLayers});return je.setEventedParent(this.map,{style:je}),je}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(F){return this.isRootStyle()&&(F.fragment||!!F.schema&&!1!==F.fragment)}_load(Me,Le){const Oe=Me.indoor?uo(Me.schema):Me.schema;if(this._isInternalStyle(Me)){const Oe=F.l({},au,{imports:[{id:"basemap",data:Me,url:""}]});return void this._load(Oe,Le)}if(this.updateConfig(this._config,Oe),Le&&go(this,me(Me)))return;this._loaded=!0,this.stylesheet=F.cq(Me);const s=()=>{for(const F in Me.sources)this.addSource(F,Me.sources[F],{validate:!1,isInitialLoad:!0});if(Me.iconsets)for(const F in Me.iconsets)this.addIconset(F,Me.iconsets[F]);Me.sprite?this._loadIconset(Me.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.setGlyphsUrl(Me.glyphs);const Oe=Lt(this.stylesheet.layers);if(this._order=Oe.map((F=>F.id)),this.stylesheet.light&&F.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const F=this.stylesheet.lights[0];this.light=new Pe(F.properties,F.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Pe(this.stylesheet.light)),this._layers={};for(const Me of Oe){const Le=F.cv(Me,this.scope,this._styleColorTheme.lut,this.options);0!==Le.configDependencies.size&&this._configDependentLayers.add(Le.fqid),Le.setEventedParent(this,{layer:{id:Le.id}}),this._layers[Le.id]=Le;const Oe=this.getOwnLayerSourceCache(Le),Fe=!!this.directionalLight&&this.directionalLight.shadowsEnabled();Oe&&Le.canCastShadows()&&Fe&&(Oe.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const Fe=this.stylesheet.terrain;Fe&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(Fe,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new F.A("data",{dataType:"style"}));const je=this.isRootStyle();Me.imports?this._loadImports(Me.imports,Le).then((()=>{this._reloadImports(),this.fire(new F.A(je?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new F.A(je?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const Fe=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(Fe){const Me=this._evaluateColorThemeData(Fe);this._loadColorTheme(Me).then((()=>{s()})).catch((Me=>{F.w(`Couldn't load color theme from the stylesheet: ${Me}`),s()}))}else this._styleColorTheme.lut=null,s()}isRootStyle(){return 0===this.importDepth}mergeAll(){let Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt;const Gt={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((F=>{if(F.stylesheet){if(null!=F.light&&(Me=F.light),F.stylesheet.lights)for(const Me of F.stylesheet.lights)"ambient"===Me.type&&null!=F.ambientLight&&(Le=F.ambientLight),"directional"===Me.type&&null!=F.directionalLight&&(Oe=F.directionalLight);Fe=this._prioritizeTerrain(Fe,F.terrain,F.stylesheet.terrain),F.stylesheet.fog&&null!=F.fog&&(je=F.fog),F.stylesheet.snow&&null!=F.snow&&(qe=F.snow),F.stylesheet.rain&&null!=F.rain&&(He=F.rain),null!=F.stylesheet.camera&&(jt=F.stylesheet.camera),null!=F.stylesheet.projection&&(xt=F.stylesheet.projection),null!=F.stylesheet.transition&&(Pt=F.stylesheet.transition),Gt[F.scope]=F._styleColorTheme}})),this.light=Me,this.ambientLight=Le,this.directionalLight=Oe,this.fog=je,this.snow=qe,this.rain=He,this._styleColorThemeForScope=Gt,null===Fe?delete this.terrain:this.terrain=Fe,this.camera=jt||{"camera-projection":"perspective"},this.projection=xt||{name:"mercator"},this.transition=F.l({},hu,Pt),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(F){const t=Me=>{for(const F of Me.fragments)t(F.style);F(Me)};t(this)}_prioritizeTerrain(F,Me,Le){const Oe=F&&0===F.drapeRenderMode;return null===Le?Me&&0===Me.drapeRenderMode?Me:Oe?F:null:null!=Me&&(!F||Oe||Me&&1===Me.drapeRenderMode)?Me:F}mergeTerrain(){let F;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((Me=>{F=this._prioritizeTerrain(F,Me.terrain,Me.stylesheet.terrain)})),null===F?delete this.terrain:this.terrain=F}mergeProjection(){let F;this.forEachFragmentStyle((Me=>{null!=Me.stylesheet.projection&&(F=Me.stylesheet.projection)})),this.projection=F||{name:"mercator"}}mergeSources(){const Me={},Le={},Oe={};this.forEachFragmentStyle((Fe=>{for(const Le in Fe._sourceCaches){const Oe=F.C(Le,Fe.scope);Me[Oe]=Fe._sourceCaches[Le]}for(const Me in Fe._otherSourceCaches){const Oe=F.C(Me,Fe.scope);Le[Oe]=Fe._otherSourceCaches[Me]}for(const Me in Fe._symbolSourceCaches){const Le=F.C(Me,Fe.scope);Oe[Le]=Fe._symbolSourceCaches[Me]}})),this._mergedSourceCaches=Me,this._mergedOtherSourceCaches=Le,this._mergedSymbolSourceCaches=Oe}mergeLayers(){const Me={},Le=[],Oe={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((Oe=>{for(const Fe of Oe._order){const je=Oe._layers[Fe];if("slot"===je.type){const Le=F.cr(Fe);if(Me[Le])continue;Me[Le]=[]}je.slot&&Me[je.slot]?Me[je.slot].push(je):Le.push(je)}})),this._mergedOrder=[];const s=(Le=[])=>{for(const Fe of Le)if("slot"===Fe.type){const Le=F.cr(Fe.id);Me[Le]&&s(Me[Le]),this._mergedSlots.push(Le)}else{const Me=F.C(Fe.id,Fe.scope);this._mergedOrder.push(Me),Oe[Me]=Fe,Fe.is3D(!!this.terrain)&&(this._has3DLayers=!0),"circle"===Fe.type&&(this._hasCircleLayers=!0),"symbol"===Fe.type&&(this._hasSymbolLayers=!0),"clip"===Fe.type&&(this._clipLayerPresent=!0)}};s(Le),this._mergedOrder.sort(((F,Me)=>{const Le=Oe[F],Fe=Oe[Me];return Le.hasInitialOcclusionOpacityProperties?Fe.is3D(!!this.terrain)?1:0:Le.is3D(!!this.terrain)&&Fe.hasInitialOcclusionOpacityProperties?-1:0})),this._mergedLayers=Oe,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(Me){return this.stylesheet.camera=F.l({},this.stylesheet.camera,Me),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(Me){return Me.data?function(Me,Le,Oe){const Fe=F.l({},Le);for(const Me of Object.keys(F.a5.colorTheme))void 0===Fe[Me]&&(Fe[Me]=F.a5.colorTheme[Me].default);const je=new F.a6(Qh,Me,new Map(Oe));return je.setTransitionOrValue(Fe,Oe),je.untransitioned().possiblyEvaluate(new F.aa(0))}(this.scope,Me,this.options).get("data"):null}_loadColorTheme(Me){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const Le=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((Oe,Fe)=>{const je="data:image/png;base64,";if(!Me||0===Me.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void Oe();let qe=Me;qe.startsWith(je)||(qe=je+qe);const He=F.I.from("mapbox-reserved-lut"),xt=new Image;xt.src=qe,xt.onerror=()=>{this._styleColorTheme.lutLoading=!1,Fe(new Error("Failed to load image data"))},xt.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==Le)return void Oe();this._styleColorTheme.lutLoading=!1;const{width:je,height:qe,data:Pt}=F.q.getImageData(xt);if(qe>32)return void Fe(new Error("The height of the image must be less than or equal to 32 pixels."));if(je!==qe*qe)return void Fe(new Error("The width of the image must be equal to the height squared."));this.getImage(He,this.scope)&&this.removeImage(He,this.scope),this.addImage(He,this.scope,{data:new F.r({width:je,height:qe},Pt),pixelRatio:1,sdf:!1,usvg:!1,version:0});const jt=this.imageManager.getImage(He,this.scope);jt?(this._styleColorTheme.lut={image:jt.data,data:Me},Oe()):Fe(new Error("Missing LUT image."))}}))}getLut(F){const Me=this._styleColorThemeForScope[F];return Me?Me.lut:null}setProjection(F){F?this.stylesheet.projection=F:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(Me){this._spriteRequest=function(Me,Le,Oe){let Fe,je,qe;const He=F.q.devicePixelRatio>1?"@2x":"";let xt=F.n(Le.transformRequest(Le.normalizeSpriteURL(Me,He,".json"),F.R.SpriteJSON),((F,Me)=>{xt=null,qe||(qe=F,Fe=Me,h())})),Pt=F.o(Le.transformRequest(Le.normalizeSpriteURL(Me,He,".png"),F.R.SpriteImage),((F,Me)=>{Pt=null,qe||(qe=F,je=Me,h())}));function h(){if(qe)Oe(qe);else if(Fe&&je){const Me=F.q.getImageData(je),Le={};for(const Oe in Fe){const{width:je,height:qe,x:He,y:xt,sdf:Pt,pixelRatio:jt,stretchX:Gt,stretchY:bi,content:wi}=Fe[Oe],qr=new F.r({width:je,height:qe});F.r.copy(Me,qr,{x:He,y:xt},{x:0,y:0},{width:je,height:qe},null),Le[Oe]={data:qr,pixelRatio:jt,sdf:Pt,stretchX:Gt,stretchY:bi,content:wi,usvg:!1}}Oe(null,Le)}}return{cancel(){xt&&(xt.cancel(),xt=null),Pt&&(Pt.cancel(),Pt=null)}}}(Me,this.map._requestManager,((Me,Le)=>{if(this._spriteRequest=null,Me)this.fire(new F.z(Me));else if(Le){const Me=new Map;for(const Oe in Le)Me.set(F.I.from(Oe),Le[Oe]);this.addImages(Me,this.scope)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new F.A("data",{dataType:"style"}))}))}addIconset(Me,Le){if("sprite"===Le.type)return void this._loadSprite(Le.url);const Oe=this.getOwnSourceCache(Le.source);if(!Oe)return void this.fire(new F.z(new Error(`Source "${Le.source}" as specified by iconset "${Me}" does not exist and cannot be used as an iconset source`)));const Fe=Oe.getSource();if("raster-array"!==Fe.type)return void this.fire(new F.z(new Error(`Source "${Le.source}" as specified by iconset "${Me}" is not a "raster-array" source and cannot be used as an iconset source`)));Fe.partial=!1;const je=new mo(Me,this.scope,Oe);this.imageManager.addImageProvider(je,this.scope)}removeIconset(F){this.imageManager.removeImageProvider(F,this.scope)}_loadIconset(Me){if(!F.f(Me)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(Me);const Le="auto"===this.map._spriteFormat;var Oe,Fe;this._spriteRequest=(Fe=(Oe,Fe)=>{if(this._spriteRequest=null,Oe)Le?this._loadSprite(Me):this.fire(new F.z(Oe));else if(Fe){const Me=new Map;for(const Le in Fe)Me.set(F.I.from(Le),Fe[Le]);this.addImages(Me,this.scope)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new F.A("data",{dataType:"style"}))},F.bj((Oe=this.map._requestManager).transformRequest(Oe.normalizeIconsetURL(Me),F.R.Iconset),((Me,Le)=>{if(Me)return void Fe(Me);const Oe={},je=F.ch(new F.bi(Le));for(const Me of je.icons){const Le={version:1,pixelRatio:F.q.devicePixelRatio,content:po(Me),stretchX:Me.metadata?fo(Me.metadata.stretch_x_areas):void 0,stretchY:Me.metadata?fo(Me.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:Me};Oe[Me.name]=Le}Fe(null,Oe)})))}_validateLayer(Me){const Le=this.getOwnSource(Me.source);if(!Le)return;const Oe=Me.sourceLayer;Oe&&("geojson"===Le.type||Le.vectorLayerIds&&-1===Le.vectorLayerIds.indexOf(Oe))&&this.fire(new F.z(new Error(`Source layer "${Oe}" does not exist on source "${Le.id}" as specified by style layer "${Me.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const F in this._sourceCaches)if(!this._sourceCaches[F].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(this.imageManager.hasPatternsInFlight())return!1;if(!this.modelManager.isLoaded())return!1;if(this._styleColorTheme.lutLoading)return!1;for(const{style:F}of this.fragments)if(!F.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((F,Me)=>{const Le=this.fragments[Me];return Le&&Le.style&&(F.data=Le.style.serialize()),F}))}_serializeSources(){const F={};for(const Me in this._sourceCaches){const Le=this._sourceCaches[Me].getSource();F[Le.id]||(F[Le.id]=Le.serialize())}return F}_serializeLayers(F){const Me=[];for(const Le of F){const F=this._layers[Le];F&&"custom"!==F.type&&Me.push(F.serialize())}return Me}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;if(this.hasSnowTransition())return!0;if(this.hasRainTransition())return!0;for(const F in this._sourceCaches)if(this._sourceCaches[F].hasTransition())return!0;for(const F in this._layers)if(this._layers[F].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(F){return F?this.order:this._mergedOrder}isLayerDraped(F){return!!this.terrain&&F.isDraped(this.getLayerSourceCache(F))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(Me){const Le=this.getOwnLayer(Me);if(Le)return Le;this.fire(new F.z(new Error(`The layer '${Me}' does not exist in the map's style.`)))}_checkSource(Me){const Le=this.getOwnSource(Me);if(Le)return Le;this.fire(new F.z(new Error(`The source '${Me}' does not exist in the map's style.`)))}precompilePrograms(F,Me){const Le=this.map.painter;if(Le)for(let Oe=F.minzoom||0;Oe<(F.maxzoom||25.5);Oe++){const Oe=F.getProgramIds();if(Oe)for(const Fe of Oe){const Oe=F.getDefaultProgramParams(Fe,Me.zoom,this._styleColorTheme.lut);Oe&&(Le.style=this,this.fog&&(Le._fogVisible=!0,Oe.overrideFog=!0,Le.getOrCreateProgram(Fe,Oe)),Le._fogVisible=!1,Oe.overrideFog=!1,Le.getOrCreateProgram(Fe,Oe),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(Oe.overrideRtt=!0,Le.getOrCreateProgram(Fe,Oe)))}}}update(Me){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(Me),this.directionalLight&&this.directionalLight.recalculate(Me);const Le=this.calculateLightsBrightness();Me.brightness=Le||0,Le!==this._brightness&&(this._brightness=Le,this.dispatcher.broadcast("setBrightness",Le));const Oe=this._changes.isDirty();let Fe=!1;if(this._changes.isDirty()){const F=this._changes.getLayerUpdatesByScope();for(const Me in F){const{updatedIds:Le,removedIds:Oe}=F[Me];(Le||Oe)&&(this._updateWorkerLayers(Me,Le,Oe),Fe=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(Me),this.light&&this.light.updateTransitions(Me),this.ambientLight&&this.ambientLight.updateTransitions(Me),this.directionalLight&&this.directionalLight.updateTransitions(Me),this.fog&&this.fog.updateTransitions(Me),this.snow&&this.snow.updateTransitions(Me),this.rain&&this.rain.updateTransitions(Me),this._changes.reset()}const je={};for(const F in this._mergedSourceCaches){const Me=this._mergedSourceCaches[F];je[F]=Me.used,Me.used=!1,Me.tileCoverLift=0}for(const F of this._mergedOrder){const Le=this._mergedLayers[F];if(Le.recalculate(Me,this._availableImages),!Le.isHidden(Me.zoom)){const F=this.getLayerSourceCache(Le);F&&(F.used=!0,F.tileCoverLift=Math.max(F.tileCoverLift,Le.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(Le,Me)})):this.precompilePrograms(Le,Me))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&Fe&&this.mergeLayers();const qe=this.imageManager.getPendingImageProviders();for(const F of qe)F.sourceCache.used=!0;for(const Me in je){const Le=this._mergedSourceCaches[Me];je[Me]!==Le.used&&Le.getSource().fire(new F.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:Le.getSource().id}))}this.light&&this.light.recalculate(Me),this.terrain&&this.terrain.recalculate(Me),this.fog&&this.fog.recalculate(Me),this.snow&&this.snow.recalculate(Me),this.rain&&this.rain.recalculate(Me),this.z=Me.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),Oe&&this.fire(new F.A("data",{dataType:"style"}))}updateImageProviders(){const F=this.imageManager.getPendingImageProviders();for(const Me of F){const F=Me.resolvePendingRequests();this.addImages(F,Me.scope)}}_updateTilesForChangedImages(){const F={};for(const Me in this._mergedSourceCaches){const Le=this._mergedSourceCaches[Me].getSource().scope;F[Le]=F[Le]||this._changes.getUpdatedImages(Le),0!==F[Le].length&&this._mergedSourceCaches[Me].reloadTilesForDependencies(["icons","patterns"],F[Le])}for(const Me in F)this._changes.resetUpdatedImages(Me)}_updateWorkerLayers(F,Me,Le){const Oe=this.getFragmentStyle(F);Oe&&this.dispatcher.broadcast("updateLayers",{layers:Me?Oe._serializeLayers(Me):[],scope:F,removedIds:Le||[],options:Oe.options})}setState(Me,Le){if(this._checkLoaded(),go(this,me(Me)))return!1;(Me=F.cq(Me)).layers=Lt(Me.layers);const Oe=function(Me,Le){if(!Me)return[{command:eh.setStyle,args:[Le]}];let Oe=[];try{if(!F.bn(Me.version,Le.version))return[{command:eh.setStyle,args:[Le]}];if(F.bn(Me.center,Le.center)||Oe.push({command:eh.setCenter,args:[Le.center]}),F.bn(Me.zoom,Le.zoom)||Oe.push({command:eh.setZoom,args:[Le.zoom]}),F.bn(Me.bearing,Le.bearing)||Oe.push({command:eh.setBearing,args:[Le.bearing]}),F.bn(Me.pitch,Le.pitch)||Oe.push({command:eh.setPitch,args:[Le.pitch]}),F.bn(Me.sprite,Le.sprite)||Oe.push({command:eh.setSprite,args:[Le.sprite]}),F.bn(Me.glyphs,Le.glyphs)||Oe.push({command:eh.setGlyphs,args:[Le.glyphs]}),F.bn(Me.imports,Le.imports)||function(Me=[],Le=[],Oe){Le=Le||[];const Fe=(Me=Me||[]).map(Bt),je=Le.map(Bt),qe=Me.reduce(Nt,{}),He=Le.reduce(Nt,{}),xt=Fe.slice();let Pt,jt,Gt,bi;for(Pt=0,jt=0;Pt<Fe.length;Pt++)Gt=Fe[Pt],He.hasOwnProperty(Gt)?jt++:(Oe.push({command:eh.removeImport,args:[Gt]}),xt.splice(xt.indexOf(Gt,jt),1));for(Pt=0,jt=0;Pt<je.length;Pt++)Gt=je[je.length-1-Pt],xt[xt.length-1-Pt]!==Gt&&(qe.hasOwnProperty(Gt)?(Oe.push({command:eh.removeImport,args:[Gt]}),xt.splice(xt.lastIndexOf(Gt,xt.length-jt),1)):jt++,bi=xt[xt.length-Pt],Oe.push({command:eh.addImport,args:[He[Gt],bi]}),xt.splice(xt.length-Pt,0,Gt));for(const Me of Le){const Le=qe[Me.id];Le&&!F.bn(Le,Me)&&Oe.push({command:eh.updateImport,args:[Me.id,Me]})}}(Me.imports,Le.imports,Oe),F.bn(Me.transition,Le.transition)||Oe.push({command:eh.setTransition,args:[Le.transition]}),F.bn(Me.light,Le.light)||Oe.push({command:eh.setLight,args:[Le.light]}),F.bn(Me.fog,Le.fog)||Oe.push({command:eh.setFog,args:[Le.fog]}),F.bn(Me.snow,Le.snow)||Oe.push({command:eh.setSnow,args:[Le.snow]}),F.bn(Me.rain,Le.rain)||Oe.push({command:eh.setRain,args:[Le.rain]}),F.bn(Me.projection,Le.projection)||Oe.push({command:eh.setProjection,args:[Le.projection]}),F.bn(Me.lights,Le.lights)||Oe.push({command:eh.setLights,args:[Le.lights]}),F.bn(Me.camera,Le.camera)||Oe.push({command:eh.setCamera,args:[Le.camera]}),F.bn(Me.iconsets,Le.iconsets)||function(Me,Le,Oe){let Fe;for(Fe in Le=Le||{},Me=Me||{})Me.hasOwnProperty(Fe)&&(Le.hasOwnProperty(Fe)||Oe.push({command:eh.removeIconset,args:[Fe]}));for(Fe in Le){if(!Le.hasOwnProperty(Fe))continue;const je=Le[Fe];Me.hasOwnProperty(Fe)?F.bn(Me[Fe],je)||(Oe.push({command:eh.removeIconset,args:[Fe]}),Oe.push({command:eh.addIconset,args:[Fe,je]})):Oe.push({command:eh.addIconset,args:[Fe,je]})}}(Me.iconsets,Le.iconsets,Oe),!F.bn(Me["color-theme"],Le["color-theme"]))return[{command:eh.setStyle,args:[Le]}];const Fe={},je=[];!function(Me,Le,Oe,Fe){let je;for(je in Le=Le||{},Me=Me||{})Me.hasOwnProperty(je)&&(Le.hasOwnProperty(je)||zt(je,Oe,Fe));for(je in Le){if(!Le.hasOwnProperty(je))continue;const qe=Le[je];Me.hasOwnProperty(je)?F.bn(Me[je],qe)||("geojson"===Me[je].type&&"geojson"===qe.type&&Ft(Me,Le,je)?Oe.push({command:eh.setGeoJSONSourceData,args:[je,qe.data]}):Ot(je,Le,Oe,Fe)):Mt(je,Le,Oe)}}(Me.sources,Le.sources,je,Fe);const qe=[];Me.layers&&Me.layers.forEach((F=>{F.source&&Fe[F.source]?Oe.push({command:eh.removeLayer,args:[F.id]}):qe.push(F)}));let He=Me.terrain;He&&Fe[He.source]&&(Oe.push({command:eh.setTerrain,args:[void 0]}),He=void 0),Oe=Oe.concat(je),F.bn(He,Le.terrain)||Oe.push({command:eh.setTerrain,args:[Le.terrain]}),function(Me,Le,Oe){Le=Le||[];const Fe=(Me=Me||[]).map(Bt),je=Le.map(Bt),qe=Me.reduce(Nt,{}),He=Le.reduce(Nt,{}),xt=Fe.slice(),Pt=Object.create(null);let jt,Gt,bi,wi,qr,Xn,Yn;for(jt=0,Gt=0;jt<Fe.length;jt++)bi=Fe[jt],He.hasOwnProperty(bi)?Gt++:(Oe.push({command:eh.removeLayer,args:[bi]}),xt.splice(xt.indexOf(bi,Gt),1));for(jt=0,Gt=0;jt<je.length;jt++)bi=je[je.length-1-jt],xt[xt.length-1-jt]!==bi&&(qe.hasOwnProperty(bi)?(Oe.push({command:eh.removeLayer,args:[bi]}),xt.splice(xt.lastIndexOf(bi,xt.length-Gt),1)):Gt++,Xn=xt[xt.length-jt],Oe.push({command:eh.addLayer,args:[He[bi],Xn]}),xt.splice(xt.length-jt,0,bi),Pt[bi]=!0);for(jt=0;jt<je.length;jt++)if(bi=je[jt],wi=qe[bi],qr=He[bi],!Pt[bi]&&!F.bn(wi,qr))if(F.bn(wi.source,qr.source)&&F.bn(wi["source-layer"],qr["source-layer"])&&F.bn(wi.type,qr.type)){for(Yn in kt(wi.layout,qr.layout,Oe,bi,null,eh.setLayoutProperty),kt(wi.paint,qr.paint,Oe,bi,null,eh.setPaintProperty),F.bn(wi.slot,qr.slot)||Oe.push({command:eh.setSlot,args:[bi,qr.slot]}),F.bn(wi.filter,qr.filter)||Oe.push({command:eh.setFilter,args:[bi,qr.filter]}),F.bn(wi.minzoom,qr.minzoom)&&F.bn(wi.maxzoom,qr.maxzoom)||Oe.push({command:eh.setLayerZoomRange,args:[bi,qr.minzoom,qr.maxzoom]}),wi)wi.hasOwnProperty(Yn)&&"layout"!==Yn&&"paint"!==Yn&&"filter"!==Yn&&"metadata"!==Yn&&"minzoom"!==Yn&&"maxzoom"!==Yn&&"slot"!==Yn&&(0===Yn.indexOf("paint.")?kt(wi[Yn],qr[Yn],Oe,bi,Yn.slice(6),eh.setPaintProperty):F.bn(wi[Yn],qr[Yn])||Oe.push({command:eh.setLayerProperty,args:[bi,Yn,qr[Yn]]}));for(Yn in qr)qr.hasOwnProperty(Yn)&&!wi.hasOwnProperty(Yn)&&"layout"!==Yn&&"paint"!==Yn&&"filter"!==Yn&&"metadata"!==Yn&&"minzoom"!==Yn&&"maxzoom"!==Yn&&"slot"!==Yn&&(0===Yn.indexOf("paint.")?kt(wi[Yn],qr[Yn],Oe,bi,Yn.slice(6),eh.setPaintProperty):F.bn(wi[Yn],qr[Yn])||Oe.push({command:eh.setLayerProperty,args:[bi,Yn,qr[Yn]]}))}else Oe.push({command:eh.removeLayer,args:[bi]}),Xn=xt[xt.lastIndexOf(bi)+1],Oe.push({command:eh.addLayer,args:[qr,Xn]})}(qe,Le.layers,Oe)}catch(F){console.warn("Unable to compute style diff:",F),Oe=[{command:eh.setStyle,args:[Le]}]}return Oe}(this.serialize(),Me).filter((F=>!(F.command in nu)));if(0===Oe.length)return!1;const Fe=Oe.filter((F=>!(F.command in ru)));if(Fe.length>0)throw new Error(`Unimplemented: ${Fe.map((F=>F.command)).join(", ")}.`);const je=[];return Oe.forEach((F=>{je.push(this[F.command].apply(this,F.args))})),Le&&Promise.all(je).then(Le),this.stylesheet=Me,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(F){const Me=this.getFragmentStyle(F);Me&&(Me._availableImages=Me.imageManager.listImages(F),Me.dispatcher.broadcast("setImages",{scope:F,images:Me._availableImages}))}addImages(Me,Le){for(const[Oe,Fe]of Me.entries()){if(this.getImage(Oe,Le))return this.fire(new F.z(new Error(`An image with the name "${Oe.name}" already exists.`)));this.imageManager.addImage(Oe,Le,Fe),this._changes.updateImage(Oe,Le)}return this._updateWorkerImages(Le),this.fire(new F.A("data",{dataType:"style"})),this}addImage(Me,Le,Oe){return this.getImage(Me,Le)?this.fire(new F.z(new Error(`An image with the name "${Me.name}" already exists.`))):(this.imageManager.addImage(Me,Le,Oe),this._changes.updateImage(Me,Le),this._updateWorkerImages(Le),this.fire(new F.A("data",{dataType:"style"})),this)}updateImage(Me,Le,Oe,Fe=!1){this.imageManager.updateImage(Me,Le,Oe),Fe&&(this._changes.updateImage(Me,Le),this._updateWorkerImages(Le),this.fire(new F.A("data",{dataType:"style"})))}getImage(F,Me){return this.imageManager.getImage(F,Me)}removeImage(Me,Le){return this.getImage(Me,Le)?(this.imageManager.removeImage(Me,Le),this._changes.updateImage(Me,Le),this._updateWorkerImages(Le),this.fire(new F.A("data",{dataType:"style"})),this):this.fire(new F.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(F,Me,Le={}){return this._checkLoaded(),this._validate(Re,`models.${F}`,Me,null,Le)||(this.modelManager.addModel(F,Me,this.scope),this._changes.setDirty()),this}hasModel(F){return this.modelManager.hasModel(F,this.scope)}removeModel(Me){return this.hasModel(Me)?(this.modelManager.removeModel(Me,this.scope),this):this.fire(new F.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(Me,Le,Oe={}){if(this._checkLoaded(),void 0!==this.getOwnSource(Me))throw new Error(`There is already a source with ID "${Me}".`);if(!Le.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(Le).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(Le.type)>=0&&this._validate(ge,`sources.${Me}`,Le,null,Oe))return;this.map&&this.map._collectResourceTiming&&(Le.collectResourceTiming=!0);const Fe=rt(Me,Le,this.dispatcher,this);Fe.scope=this.scope,Fe.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(Fe.id),source:Fe.serialize(),sourceId:Fe.id})));const r=Me=>{const Le=(Me?"symbol:":"other:")+Fe.id,Oe=F.C(Le,this.scope),je=this._sourceCaches[Le]=new St(Oe,Fe,Me);(Me?this._symbolSourceCaches:this._otherSourceCaches)[Fe.id]=je,je.onAdd(this.map)};r(!1),"vector"!==Le.type&&"geojson"!==Le.type||r(!0),Fe.onAdd&&Fe.onAdd(this.map),Oe.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(Me){this._checkLoaded();const Le=this.getOwnSource(Me);if(!Le)throw new Error("There is no source with this ID");for(const Le in this._layers)if(this._layers[Le].source===Me)return this.fire(new F.z(new Error(`Source "${Me}" cannot be removed while layer "${Le}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===Me)return this.fire(new F.z(new Error(`Source "${Me}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const Le=Object.entries(this.stylesheet.iconsets).find((([F,Le])=>"source"===Le.type&&Le.source===Me));if(Le)return this.fire(new F.z(new Error(`Source "${Me}" cannot be removed while iconset "${Le[0]}" is using it.`)))}const Oe=this.getOwnSourceCaches(Me);for(const Me of Oe){const Le=F.cr(Me.id);delete this._sourceCaches[Le],this._changes.discardSourceCacheUpdate(Me.id),Me.fire(new F.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:Me.getSource().id})),Me.setEventedParent(null),Me.clearTiles()}return delete this._otherSourceCaches[Me],delete this._symbolSourceCaches[Me],this.mergeSources(),Le.setEventedParent(null),Le.onRemove&&Le.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(F,Me){this._checkLoaded(),this.getOwnSource(F).setData(Me),this._changes.setDirty()}getOwnSource(F){const Me=this.getOwnSourceCache(F);return Me&&Me.getSource()}getOwnSources(){const F=[];for(const Me in this._otherSourceCaches){const Le=this.getOwnSourceCache(Me);Le&&F.push(Le.getSource())}return F}areTilesLoaded(){const F=this._mergedSourceCaches;for(const Me in F){const Le=F[Me]._tiles;for(const F in Le){const Me=Le[F];if("loaded"!==Me.state&&"errored"!==Me.state)return!1}}return!0}setLights(Me){if(this._checkLoaded(),!Me)return delete this.ambientLight,void delete this.directionalLight;const Le=this._getTransitionParameters();for(const Oe of Me){if(this._validate(ye,"lights",Oe))return;switch(Oe.type){case"ambient":if(this.ambientLight){const F=this.ambientLight;F.set(Oe),F.updateTransitions(Le)}else this.ambientLight=new $e(Oe,oc||(oc=new F.a7({color:new F.a8(F.a5.properties_light_ambient.color),"color-use-theme":new F.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new F.a8(F.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const F=this.directionalLight;F.set(Oe),F.updateTransitions(Le)}else this.directionalLight=new $e(Oe,sc||(sc=new F.a7({direction:new F.am(F.a5.properties_light_directional.direction),color:new F.a8(F.a5.properties_light_directional.color),"color-use-theme":new F.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new F.a8(F.a5.properties_light_directional.intensity),"cast-shadows":new F.a8(F.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new F.a8(F.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new F.a8(F.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const Oe=new F.aa(this.z||0,Le);this.ambientLight&&this.ambientLight.recalculate(Oe),this.directionalLight&&this.directionalLight.recalculate(Oe),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const Me=this.directionalLight,Le=this.ambientLight;if(!Me||!Le)return;const o=F=>.2126*(F[0]<=.03928?F[0]/12.92:Math.pow((F[0]+.055)/1.055,2.4))+.7152*(F[1]<=.03928?F[1]/12.92:Math.pow((F[1]+.055)/1.055,2.4))+.0722*(F[2]<=.03928?F[2]/12.92:Math.pow((F[2]+.055)/1.055,2.4)),Oe=Me.properties.get("color").toRenderColor(null).toArray01(),Fe=Me.properties.get("intensity"),je=Me.properties.get("direction"),qe=1-F.cc(je.x,je.y,je.z)[2]/90,He=o(Oe)*Fe*qe,xt=Le.properties.get("color").toRenderColor(null).toArray01(),Pt=Le.properties.get("intensity"),jt=o(xt)*Pt;return Number(((He+jt)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const F=[];return this.directionalLight&&F.push(this.directionalLight.get()),this.ambientLight&&F.push(this.ambientLight.get()),F}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(Me){if(!Me)return this;if(F.cs(Me)){const Le=F.ct(Me),Oe=this.fragments.find((({id:F})=>F===Le));if(!Oe)throw new Error(`Style import '${Me}' not found`);const Fe=F.cr(Me);return Oe.style.getFragmentStyle(Fe)}{const F=this.fragments.find((({id:F})=>F===Me));return F?F.style:void 0}}setFeaturesetSelectors(Me){if(!Me)return;const Le={},o=(F,Me="")=>`${F}::${Me}`;this._featuresetSelectors={};for(const Oe in Me){const Fe=this._featuresetSelectors[Oe]=[];for(const je of Me[Oe].selectors){if(je.featureNamespace){const Me=this.getOwnLayer(je.layer);if(!Me){F.w(`Layer is undefined for selector: ${je.layer}`);continue}const Fe=o(Me.source,Me.sourceLayer);if(Fe in Le&&Le[Fe]!==je.featureNamespace){F.w(`"featureNamespace ${je.featureNamespace} of featureset ${Oe}'s selector is not associated to the same source, skip this selector`);continue}Le[Fe]=je.featureNamespace}let Me;if(je.properties)for(const Le in je.properties){const Oe=F.X(je.properties[Le]);"success"===Oe.result&&(Me=Me||{},Me[Le]=Oe.value)}Fe.push({layerId:je.layer,namespace:je.featureNamespace,properties:Me,uniqueFeatureID:je._uniqueFeatureID})}}}getFeaturesetDescriptors(F){const Me=this.getFragmentStyle(F);if(!Me||!Me.stylesheet.featuresets)return[];const Le=[];for(const F in Me.stylesheet.featuresets)Le.push({featuresetId:F,importId:Me.scope?Me.scope:void 0});return Le}getFeaturesetLayers(Me,Le){const Oe=this.getFragmentStyle(Le),Fe=Oe.stylesheet.featuresets;if(!Fe||!Fe[Me])return this.fire(new F.z(new Error(`The featureset '${Me}' does not exist in the map's style and cannot be queried.`))),[];const je=[];for(const F of Fe[Me].selectors){const Me=Oe.getOwnLayer(F.layer);Me&&je.push(Me)}return je}getConfigProperty(Me,Le){const Oe=this.getFragmentStyle(Me);if(!Oe)return null;const Fe=F.C(Le,Oe.scope),je=Oe.options.get(Fe),qe=je?je.value||je.default:null;return qe?qe.serialize():null}setConfigProperty(Me,Le,Oe){const Fe=this.getFragmentStyle(Me);if(!Fe)return;const je=Fe.stylesheet.indoor?uo(Fe.stylesheet.schema):Fe.stylesheet.schema;if(!je||!je[Le])return;const qe=F.X(Oe);if("success"!==qe.result)return void go(this,qe.value);const He=qe.value.expression,xt=F.C(Le,Fe.scope),Pt=Fe.options.get(xt);if(!Pt)return;let jt;const{minValue:Gt,maxValue:bi,stepValue:wi,type:qr,values:Xn}=je[Le],Yn=F.X(je[Le].default);"success"===Yn.result&&(jt=Yn.value.expression),jt?(this.options.set(xt,Object.assign({},Pt,{value:He,default:jt,minValue:Gt,maxValue:bi,stepValue:wi,type:qr,values:Xn})),this.updateConfigDependencies(Le)):this.fire(new F.z(new Error(`No schema defined for the config option "${Le}" in the "${Me}" fragment.`)))}getConfig(Me){const Le=this.getFragmentStyle(Me);if(!Le)return null;const Oe=Le.stylesheet.schema;if(!Oe)return null;const Fe={};for(const Me in Oe){const Oe=F.C(Me,Le.scope),je=Le.options.get(Oe),qe=je?je.value||je.default:null;Fe[Me]=qe?qe.serialize():null}return Fe}setConfig(F,Me){const Le=this.getFragmentStyle(F);Le&&(Le.updateConfig(Me,Le.stylesheet.schema),this.updateConfigDependencies())}getSchema(F){const Me=this.getFragmentStyle(F);return Me?Me.stylesheet.schema:null}setSchema(F,Me){const Le=this.getFragmentStyle(F);Le&&(Le.stylesheet.schema=Me,Le.updateConfig(Le._config,Me),this.updateConfigDependencies())}updateConfig(Me,Le){if(this._config=Me,Me||Le)if(Le)for(const Oe in Le){let Fe,je;const qe=F.X(Le[Oe].default);if("success"===qe.result&&(Fe=qe.value.expression),Me&&void 0!==Me[Oe]){const Le=F.X(Me[Oe]);"success"===Le.result&&(je=Le.value.expression)}const{minValue:He,maxValue:xt,stepValue:Pt,type:jt,values:Gt}=Le[Oe];if(Fe){const Me=F.C(Oe,this.scope);this.options.set(Me,{default:Fe,value:je,minValue:He,maxValue:xt,stepValue:Pt,type:jt,values:Gt})}else this.fire(new F.z(new Error(`No schema defined for config option "${Oe}".`)))}else this.fire(new F.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(F){for(const Me of this._configDependentLayers){const Le=this.getLayer(Me);if(Le){if(F&&!Le.configDependencies.has(F))continue;Le.possiblyEvaluateVisibility(),this._updateLayer(Le)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((F=>{const Me=F._styleColorTheme.colorThemeOverride?F._styleColorTheme.colorThemeOverride:F._styleColorTheme.colorTheme;if(Me){const Le=F._evaluateColorThemeData(Me);(!F._styleColorTheme.lut&&""!==Le||F._styleColorTheme.lut&&Le!==F._styleColorTheme.lut.data)&&F.setColorTheme(Me)}})),this._changes.setDirty()}addLayer(Me,Le,Oe={}){this._checkLoaded();const Fe=Me.id;if(this._layers[Fe])return void this.fire(new F.z(new Error(`Layer with id "${Fe}" already exists on this map`)));let je;if("custom"===Me.type){if(go(this,F.cu(Me)))return;je=F.cv(Me,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof Me.source&&(this.addSource(Fe,Me.source),Me=F.cq(Me),Me=F.l(Me,{source:Fe})),this._validate(Ee,`layers.${Fe}`,Me,{arrayIndex:-1},Oe))return;je=F.cv(Me,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(je),je.setEventedParent(this,{layer:{id:Fe}})}0!==je.configDependencies.size&&this._configDependentLayers.add(je.fqid);let qe=this._order.length;if(Le){const Me=this._order.indexOf(Le);if(-1===Me)return void this.fire(new F.z(new Error(`Layer with id "${Le}" does not exist on this map.`)));je.slot===this._layers[Le].slot?qe=Me:F.w(`Layer with id "${Le}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(qe,0,Fe),this._layerOrderChanged=!0,this._layers[Fe]=je;const He=this.getOwnLayerSourceCache(je),xt=!!this.directionalLight&&this.directionalLight.shadowsEnabled();He&&je.canCastShadows()&&xt&&(He.castsShadows=!0);const Pt=this._changes.getRemovedLayer(je);if(Pt&&je.source&&He&&"custom"!==je.type){this._changes.discardLayerRemoval(je);const Me=F.C(je.source,je.scope);Pt.type!==je.type?this._changes.updateSourceCache(Me,"clear"):(this._changes.updateSourceCache(Me,"reload"),He.pause())}this._updateLayer(je),je.onAdd&&je.onAdd(this.map),je.scope=this.scope,this.mergeLayers()}moveLayer(Me,Le){this._checkLoaded();const Oe=this._checkLayer(Me);if(!Oe)return;if(Me===Le)return;const Fe=this._order.indexOf(Me);this._order.splice(Fe,1);let je=this._order.length;if(Le){const Me=this._order.indexOf(Le);if(-1===Me)return void this.fire(new F.z(new Error(`Layer with id "${Le}" does not exist on this map.`)));Oe.slot===this._layers[Le].slot?je=Me:F.w(`Layer with id "${Le}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(je,0,Me),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(F){this._checkLoaded();const Me=this._checkLayer(F);if(!Me)return;Me.setEventedParent(null);const Le=this._order.indexOf(F);this._order.splice(Le,1),delete this._layers[F],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(Me.fqid),this._changes.removeLayer(Me);const Oe=this.getOwnLayerSourceCache(Me);if(Oe&&Oe.castsShadows){let F=!1;for(const Le in this._layers)if(this._layers[Le].source===Me.source&&this._layers[Le].canCastShadows()){F=!0;break}Oe.castsShadows=F}Me.onRemove&&Me.onRemove(this.map),this.mergeLayers()}getOwnLayer(F){return this._layers[F]}hasLayer(F){return F in this._mergedLayers}hasLayerType(F){for(const Me in this._layers)if(this._layers[Me].type===F)return!0;return!1}setLayerZoomRange(F,Me,Le){this._checkLoaded();const Oe=this._checkLayer(F);Oe&&(Oe.minzoom===Me&&Oe.maxzoom===Le||(null!=Me&&(Oe.minzoom=Me),null!=Le&&(Oe.maxzoom=Le),this._updateLayer(Oe)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(F,Me){this._checkLoaded();const Le=this._checkLayer(F);Le&&Le.slot!==Me&&(Le.slot=Me,this._updateLayer(Le))}setFilter(Me,Le,Oe={}){this._checkLoaded();const Fe=this._checkLayer(Me);if(Fe&&!F.bn(Fe.filter,Le))return null==Le?(Fe.filter=void 0,void this._updateLayer(Fe)):void(this._validate(Se,`layers.${Fe.id}.filter`,Le,{layerType:Fe.type},Oe)||(Fe.filter=F.cq(Le),this._updateLayer(Fe)))}getFilter(Me){const Le=this._checkLayer(Me);if(Le)return F.cq(Le.filter)}setLayoutProperty(Me,Le,Oe,Fe={}){this._checkLoaded();const je=this._checkLayer(Me);if(je&&!F.bn(je.getLayoutProperty(Le),Oe)){if(null!=Oe&&(!Fe||!1!==Fe.validate)&&go(je,Ie.call(me,{key:`layers.${Me}.layout.${Le}`,layerType:je.type,objectKey:Le,value:Oe,styleSpec:F.a5,style:{glyphs:!0,sprite:!0}})))return;je.setLayoutProperty(Le,Oe),0!==je.configDependencies.size&&this._configDependentLayers.add(je.fqid),this._updateLayer(je)}}getLayoutProperty(F,Me){const Le=this._checkLayer(F);if(Le)return Le.getLayoutProperty(Me)}setPaintProperty(Me,Le,Oe,Fe={}){this._checkLoaded();const je=this._checkLayer(Me);if(!je)return;if(F.bn(je.getPaintProperty(Le),Oe))return;if(null!=Oe&&(!Fe||!1!==Fe.validate)&&go(je,Ce.call(me,{key:`layers.${Me}.paint.${Le}`,layerType:je.type,objectKey:Le,value:Oe,styleSpec:F.a5})))return;const qe=je.setPaintProperty(Le,Oe);0!==je.configDependencies.size&&this._configDependentLayers.add(je.fqid),qe&&this._updateLayer(je),this._changes.updatePaintProperties(je)}getPaintProperty(F,Me){const Le=this._checkLayer(F);if(Le)return Le.getPaintProperty(Me)}setFeatureState(Me,Le){if(this._checkLoaded(),"target"in Me){if("featuresetId"in Me.target){const{featuresetId:F,importId:Oe}=Me.target,Fe=this.getFragmentStyle(Oe),je=Fe.getFeaturesetLayers(F);for(const{source:F,sourceLayer:Oe}of je)Fe.setFeatureState({id:Me.id,source:F,sourceLayer:Oe},Le)}else if("layerId"in Me.target){const{layerId:F}=Me.target,Oe=this.getLayer(F);this.setFeatureState({id:Me.id,source:Oe.source,sourceLayer:Oe.sourceLayer},Le)}return}const Oe=Me.source,Fe=Me.sourceLayer,je=this._checkSource(Oe);if(!je)return;const qe=je.type;if("geojson"===qe&&Fe)return void this.fire(new F.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===qe&&!Fe)return void this.fire(new F.z(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===Me.id&&this.fire(new F.z(new Error("The feature id parameter must be provided.")));const He=this.getOwnSourceCaches(Oe);for(const F of He)F.setFeatureState(Fe,Me.id,Le)}removeFeatureState(Me,Le){if(this._checkLoaded(),"target"in Me){if("featuresetId"in Me.target){const{featuresetId:F,importId:Oe}=Me.target,Fe=this.getFragmentStyle(Oe),je=Fe.getFeaturesetLayers(F);for(const{source:F,sourceLayer:Oe}of je)Fe.removeFeatureState({id:Me.id,source:F,sourceLayer:Oe},Le)}else if("layerId"in Me.target){const{layerId:F}=Me.target,Oe=this.getLayer(F);this.removeFeatureState({id:Me.id,source:Oe.source,sourceLayer:Oe.sourceLayer},Le)}return}const Oe=Me.source,Fe=this._checkSource(Oe);if(!Fe)return;const je=Fe.type,qe="vector"===je?Me.sourceLayer:void 0;if("vector"===je&&!qe)return void this.fire(new F.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(Le&&"string"!=typeof Me.id&&"number"!=typeof Me.id)return void this.fire(new F.z(new Error("A feature id is required to remove its specific state property.")));const He=this.getOwnSourceCaches(Oe);for(const F of He)F.removeFeatureState(qe,Me.id,Le)}getFeatureState(Me){if(this._checkLoaded(),"target"in Me){let Le;if("featuresetId"in Me.target){const{featuresetId:Oe,importId:Fe}=Me.target,je=this.getFragmentStyle(Fe),qe=je.getFeaturesetLayers(Oe);for(const{source:Oe,sourceLayer:Fe}of qe){const qe=je.getFeatureState({id:Me.id,source:Oe,sourceLayer:Fe});if(qe&&!Le)Le=qe;else if(!F.bn(Le,qe))return void this.fire(new F.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in Me.target){const{layerId:F}=Me.target,Oe=this.getLayer(F);Le=this.getFeatureState({id:Me.id,source:Oe.source,sourceLayer:Oe.sourceLayer})}return Le}const Le=Me.source,Oe=Me.sourceLayer,Fe=this._checkSource(Le);if(Fe){if("vector"!==Fe.type||Oe)return void 0===Me.id&&this.fire(new F.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(Le)[0].getFeatureState(Oe,Me.id);this.fire(new F.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(Me){return this.stylesheet.transition=F.l({},this.stylesheet.transition,Me),this.transition=this.stylesheet.transition,this}getTransition(){return F.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const Me=this.getTerrain(),Le=Me&&this.terrain&&this.terrain.scope===this.scope?Me:this.stylesheet.terrain;return F.cw({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:Le,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(F=>void 0!==F))}_updateFilteredLayers(F){for(const Me of Object.values(this._mergedLayers))F(Me)&&this._updateLayer(Me)}_updateLayer(Me){this._changes.updateLayer(Me);const Le=this.getLayerSourceCache(Me),Oe=F.C(Me.source,Me.scope),Fe=this._changes.getUpdatedSourceCaches();Me.source&&!Fe[Oe]&&Le&&"raster"!==Le.getSource().type&&(this._changes.updateSourceCache(Oe,"reload"),Le.pause()),Me.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(F){const t=F=>this._mergedLayers[F].is3D(!!this.terrain),Me=this.order,Le={},Oe=[];for(let Fe=Me.length-1;Fe>=0;Fe--){const je=Me[Fe];if(t(je)){Le[je]=Fe;for(const Me of F){const F=Me[je];if(F)for(const Me of F)Oe.push(Me)}}}Oe.sort(((F,Me)=>Me.intersectionZ-F.intersectionZ));const Fe=[];for(let je=Me.length-1;je>=0;je--){const qe=Me[je];if(t(qe))for(let F=Oe.length-1;F>=0;F--){const Me=Oe[F].feature;if(Me.layer&&Le[Me.layer.id]<je)break;Fe.push(Me),Oe.pop()}else for(const Me of F){const F=Me[qe];if(F)for(const Me of F)Fe.push(Me.feature)}}return Fe}queryRenderedFeatures(Me,Le,Oe){let Fe;Le&&!Array.isArray(Le)&&Le.filter&&(this._validate(Se,"queryRenderedFeatures.filter",Le.filter,null,Le),Fe=F.a_(Le.filter));const je={},n=F=>{if(su.has(F.type))return;const Me=this.getOwnLayerSourceCache(F),Le=je[Me.id]=je[Me.id]||{sourceCache:Me,layers:{},has3DLayers:!1};F.is3D(!!this.terrain)&&(Le.has3DLayers=!0),Le.layers[F.fqid]=Le.layers[F.fqid]||{styleLayer:F,targets:[]},Le.layers[F.fqid].targets.push({filter:Fe})};if(Le&&Le.layers){if(!Array.isArray(Le.layers))return this.fire(new F.z(new Error("parameters.layers must be an Array."))),[];for(const Me of Le.layers){const Le=this._layers[Me];if(!Le)return this.fire(new F.z(new Error(`The layer '${Me}' does not exist in the map's style and cannot be queried for features.`))),[];n(Le)}}else for(const F in this._layers)n(this._layers[F]);const qe=this._queryRenderedFeatures(Me,je,Oe),He=this._flattenAndSortRenderedFeatures(qe),xt=[];for(const Me of He)F.ct(Me.layer.id)===this.scope&&xt.push(Me);return xt}queryRenderedFeatureset(Me,Le,Oe){let Fe;Le&&!Array.isArray(Le)&&Le.filter&&(this._validate(Se,"queryRenderedFeatures.filter",Le.filter,null,Le),Fe=F.a_(Le.filter));const je="mock",qe=[];if(Le&&Le.target)qe.push(Object.assign({},Le,{targetId:je,filter:Fe}));else{const F=this.getFeaturesetDescriptors();for(const Me of F)qe.push({targetId:je,filter:Fe,target:Me});for(const{style:F}of this.fragments){const Me=F.getFeaturesetDescriptors();for(const F of Me)qe.push({targetId:je,filter:Fe,target:F})}}const He=this.queryRenderedTargets(Me,qe,Oe),xt=[],Pt=new Set;for(const Me of He)for(const Le of Me.variants[je])at(Le,Me,Pt)||xt.push(new F.cx(Me,Le));return xt}queryRenderedTargets(Me,Le,Oe){const Fe={},r=(F,Me,Le,Oe)=>{const je=Fe[Me.id]=Fe[Me.id]||{sourceCache:Me,layers:{},has3DLayers:!1};if(je.layers[F.fqid]=je.layers[F.fqid]||{styleLayer:F,targets:[]},F.is3D(!!this.terrain)&&(je.has3DLayers=!0),!Oe)return Le.uniqueFeatureID=!1,void je.layers[F.fqid].targets.push(Le);je.layers[F.fqid].targets.push(Object.assign({},Le,{namespace:Oe.namespace,properties:Oe.properties,uniqueFeatureID:Oe.uniqueFeatureID}))};for(const Me of Le)if("featuresetId"in Me.target){const{featuresetId:Le,importId:Oe}=Me.target,Fe=this.getFragmentStyle(Oe);if(!Fe||!Fe._featuresetSelectors)continue;const je=Fe._featuresetSelectors[Le];if(!je){this.fire(new F.z(new Error(`The featureset '${Le}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const F of je){const Le=Fe.getOwnLayer(F.layerId);Le&&!su.has(Le.type)&&r(Le,Fe.getOwnLayerSourceCache(Le),Me,F)}}else if("layerId"in Me.target){const{layerId:F}=Me.target,Le=this.getLayer(F);if(!Le||su.has(Le.type))continue;r(Le,this.getLayerSourceCache(Le),Me)}const je=this._queryRenderedFeatures(Me,Fe,Oe);return this._flattenAndSortRenderedFeatures(je)}_queryRenderedFeatures(F,Me,Le){const Oe=[],Fe=!!this.map._showQueryGeometry,je=Xe.createFromScreenPoints(F,Le);for(const F in Me){const qe=lt(je,Me[F],this._availableImages,Le,Fe);Object.keys(qe).length&&Oe.push(qe)}if(this.placement)for(const F in Me){if(!Me[F].sourceCache._onlySymbols)continue;const Le=ct(je.screenGeometry,Me[F],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(Le).length&&Oe.push(Le)}return Oe}querySourceFeatures(F,Me){const Le=Me&&Me.filter;Le&&this._validate(Se,"querySourceFeatures.filter",Le,null,Me);let Oe=[];const Fe=this.getOwnSourceCaches(F);for(const F of Fe)Oe=Oe.concat(ht(F,Me));return Oe}addSourceType(F,Me,Le){return To.getSourceType(F)?Le(new Error(`A source type called "${F}" already exists.`)):(To.setSourceType(F,Me),Me.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:F,url:Me.workerSourceURL},Le):Le(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(Me,Le,Oe={}){this._checkLoaded();const Fe=this.light.getLight();let je=!1;for(const Le in Me)if(!F.bn(Me[Le],Fe[Le])){je=!0;break}if(!je)return;const qe=this._getTransitionParameters();this.light.setLight(Me,Le,Oe),this.light.updateTransitions(qe)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=F.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&F.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(Me,Le=1){if(this._checkLoaded(),!Me)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===Le&&delete this.terrain,null===Me?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let Oe=Me;const Fe=null==Me.source;if(1===Le){if(this.disableElevatedTerrain)return;if("object"==typeof Oe.source){const Me="terrain-dem-src";this.addSource(Me,Oe.source),Oe=F.cq(Oe),Oe=F.l(Oe,{source:Me})}const Me=F.l({},Oe),Le={};if(this.terrain&&Fe){Me.source=this.terrain.get().source;const F=this.terrain?this.getFragmentStyle(this.terrain.scope):null;F&&(Le.style=F.serialize())}if(this._validate(xe,"terrain",Me,Le))return}if(!this.terrain||this.terrain.scope!==this.scope&&!Fe||this.terrain&&Le!==this.terrain.drapeRenderMode){if(!Oe)return;this._createTerrain(Oe,Le),this.fire(new F.A("data",{dataType:"style"}))}else{const Le=this.terrain,Fe=Le.get();for(const Me of Object.keys(F.a5.terrain))!Oe.hasOwnProperty(Me)&&F.a5.terrain[Me].default&&(Oe[Me]=F.a5.terrain[Me].default);for(const Oe in Me)if(!F.bn(Me[Oe],Fe[Oe])){Le.set(Me,this.options),this.stylesheet.terrain=Me;const Oe=this._getTransitionParameters({duration:0});Le.updateTransitions(Oe),this.fire(new F.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(F){const Me=this.fog=new Ve(F,this.map.transform,this.scope,this.options);this.stylesheet.fog=Me.get();const Le=this._getTransitionParameters({duration:0});Me.updateTransitions(Le)}_createSnow(F){const Me=this.snow=new ac(F,this.map.transform,this.scope,this.options);this.stylesheet.snow=Me.get();const Le=this._getTransitionParameters({duration:0});Me.updateTransitions(Le)}_createRain(F){const Me=this.rain=new mc(F,this.map.transform,this.scope,this.options);this.stylesheet.rain=Me.get();const Le=this._getTransitionParameters({duration:0});Me.updateTransitions(Le)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const F of this.map._markers)F._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(Me){if(this._checkLoaded(),!Me)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const Le=this.fog;if(!F.bn(Le.get(),Me)){Le.set(Me,this.options),this.stylesheet.fog=Le.get();const F=this._getTransitionParameters({duration:0});Le.updateTransitions(F)}}else this._createFog(Me);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(Me){if(this._checkLoaded(),!Me)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const Le=this.snow;if(!F.bn(Le.get(),Me)){Le.set(Me,this.options),this.stylesheet.snow=Le.get();const F=this._getTransitionParameters({duration:0});Le.updateTransitions(F)}}else this._createSnow(Me);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(Me){if(this._checkLoaded(),!Me)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const Le=this.rain;if(!F.bn(Le.get(),Me)){Le.set(Me,this.options),this.stylesheet.rain=Le.get();const F=this._getTransitionParameters({duration:0});Le.updateTransitions(F)}}else this._createRain(Me);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const F in this._layers)this._layers[F].lut=this._styleColorTheme.lut;for(const F in this._sourceCaches)this._sourceCaches[F].clearTiles()},Me=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!Me)return this._styleColorTheme.lut=null,void t();const Le=this._evaluateColorThemeData(Me);this._loadColorTheme(Le).then((()=>{this.fire(new F.A("colorthemeset")),t()})).catch((Me=>{F.w(`Couldn't set color theme: ${Me}`)}))}setColorTheme(Me){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&F.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=Me,this._reloadColorTheme()}setImportColorTheme(F,Me){const Le=this.getFragmentStyle(F);Le&&(Le._styleColorTheme.colorThemeOverride=Me,Le._reloadColorTheme())}_getTransitionParameters(Me){return{now:F.q.now(),transition:F.l(this.transition,Me)}}updateDrapeFirstLayers(){if(!this.terrain)return;const F=[],Me=[];for(const Le of this._mergedOrder)this.isLayerDraped(this._mergedLayers[Le])?F.push(Le):Me.push(Le);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...F),this._drapedFirstOrder.push(...Me)}_createTerrain(F,Me){const Le=this.terrain=new bl(F,Me,this.scope,this.options);1===Me&&(this.stylesheet.terrain=F),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const Oe=this._getTransitionParameters({duration:0});Le.updateTransitions(Oe)}_force3DLayerUpdate(){for(const F in this._layers){const Me=this._layers[F];"fill-extrusion"===Me.type&&this._updateLayer(Me)}}_forceSymbolLayerUpdate(){for(const F in this._layers){const Me=this._layers[F];"symbol"===Me.type&&this._updateLayer(Me)}}_validate(Me,Le,Oe,Fe,je={}){if(je&&!1===je.validate)return!1;const qe=F.l({},this.serialize());return go(this,Me.call(me,F.l({key:Le,style:qe,value:Oe,styleSpec:F.a5},Fe)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),F.cy.off("pluginStateChange",this._rtlTextPluginCallback);for(const F in this._mergedLayers)this._mergedLayers[F].setEventedParent(null);for(const F in this._mergedSourceCaches)this._mergedSourceCaches[F].clearTiles(),this._mergedSourceCaches[F].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(F){const Me=this.getSourceCaches(F);for(const F of Me)F.clearTiles()}clearSources(){for(const F in this._mergedSourceCaches)this._mergedSourceCaches[F].clearTiles()}reloadSource(F){const Me=this.getSourceCaches(F);for(const F of Me)F.resume(),F.reload()}reloadSources(){for(const F of this.getSources())F.reload&&F.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((F=>{F.modelManager.reloadModels(F.scope)}))}updateSources(F){let Me;this.directionalLight&&(Me=ro(this.directionalLight));for(const Le in this._mergedSourceCaches)this._mergedSourceCaches[Le].update(F,void 0,void 0,Me)}_generateCollisionBoxes(){for(const F in this._sourceCaches){const Me=this._sourceCaches[F];Me.resume(),Me.reload()}}_updatePlacement(Me,Le,Oe,Fe,je,qe,He=!1){let xt=!1,Pt=!1;const jt={},Gt={};for(const Me of this._mergedOrder){const Oe=this._mergedLayers[Me];if("symbol"!==Oe.type)continue;const Fe=F.C(Oe.source,Oe.scope);let je=jt[Fe];if(!je){const F=this.getLayerSourceCache(Oe);if(!F)continue;const Me=F.getRenderableIds(!0).map((Me=>F.getTileByID(Me)));Gt[Fe]=Me.slice(),je=jt[Fe]=Me.sort(((F,Me)=>Me.tileID.overscaledZ-F.tileID.overscaledZ||(F.tileID.isLessThan(Me.tileID)?-1:1)))}const qe=this.crossTileSymbolIndex.addLayer(Oe,je,Le.center.lng,Le.projection);xt=xt||qe}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),He=He||this._layerOrderChanged||0===Fe,this._layerOrderChanged&&this.fire(new F.A("neworder")),(He||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(F.q.now(),Le.zoom))&&(this.pauseablePlacement=new Ai(Le,this._mergedOrder,He,Oe,Fe,je,this.placement,this.fog&&Le.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,jt,Gt,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(F.q.now()),Pt=!0),xt&&this.pauseablePlacement.placement.setStale()),Pt||xt){this._buildingIndex.onNewFrame(Le.zoom);for(let Me=0;Me<this._mergedOrder.length;Me++){const Le=this._mergedLayers[this._mergedOrder[Me]];if("symbol"!==Le.type)continue;const Oe=this.isLayerClipped(Le);this.placement.updateLayerOpacities(Le,jt[F.C(Le.source,Le.scope)],Me,Oe?qe:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(F.q.now())}}_releaseSymbolFadeTiles(){for(const F in this._sourceCaches)this._sourceCaches[F].releaseSymbolFadeTiles()}addImport(Me,Le){this._checkLoaded();const Oe=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==Oe.findIndex((({id:F})=>F===Me.id)))return void this.fire(new F.z(new Error(`Import with id '${Me.id}' already exists in the map's style.`)));if(!Le)return Oe.push(Me),this._loadImports([Me],!0);const Fe=Oe.findIndex((({id:F})=>F===Le));return-1===Fe&&this.fire(new F.z(new Error(`Import with id "${Le}" does not exist on this map.`))),this.stylesheet.imports=Oe.slice(0,Fe).concat(Me).concat(Oe.slice(Fe)),this._loadImports([Me],!0,Le)}updateImport(Me,Le){this._checkLoaded();const Oe=this.stylesheet.imports||[],Fe=this.getImportIndex(Me);return-1===Fe?this:"string"==typeof Le?(this.setImportUrl(Me,Le),this):(Le.url&&Le.url!==Oe[Fe].url&&this.setImportUrl(Me,Le.url),F.bn(Le.config,Oe[Fe].config)||this.setImportConfig(Me,Le.config,Le.data.schema),F.bn(Le.data,Oe[Fe].data)||this.setImportData(Me,Le.data),this)}moveImport(F,Me){this._checkLoaded();let Le=this.stylesheet.imports||[];const Oe=this.getImportIndex(F);if(-1===Oe)return this;const Fe=this.getImportIndex(Me);if(-1===Fe)return this;const je=Le[Oe],qe=this.fragments[Oe];return Le=Le.filter((({id:Me})=>Me!==F)),this.fragments=this.fragments.filter((({id:Me})=>Me!==F)),this.stylesheet.imports=Le.slice(0,Fe).concat(je).concat(Le.slice(Fe)),this.fragments=this.fragments.slice(0,Fe).concat(qe).concat(this.fragments.slice(Fe)),this.mergeLayers(),this}setImportUrl(F,Me){this._checkLoaded();const Le=this.stylesheet.imports||[],Oe=this.getImportIndex(F);if(-1===Oe)return this;Le[Oe].url=Me;const Fe=this.fragments[Oe];return Fe.style=this._createFragmentStyle(Le[Oe]),Fe.style.on("style.import.load",(()=>this.mergeAll())),Fe.style.loadURL(Me),this}setImportData(F,Me){this._checkLoaded();const Le=this.getImportIndex(F),Oe=this.stylesheet.imports||[];return-1===Le?this:Me?(this.fragments[Le].style.setState(Me),this._reloadImports(),this):(delete Oe[Le].data,this.setImportUrl(F,Oe[Le].url))}setImportConfig(F,Me,Le){this._checkLoaded();const Oe=this.getImportIndex(F),Fe=this.stylesheet.imports||[];if(-1===Oe)return this;Me?Fe[Oe].config=Me:delete Fe[Oe].config;const je=this.fragments[Oe];Le&&je.style.stylesheet&&(je.style.stylesheet.schema=Le);const qe=je.style.stylesheet&&je.style.stylesheet.schema;return je.config=Me,je.style.updateConfig(Me,qe),this.updateConfigDependencies(),this}removeImport(F){this._checkLoaded();const Me=this.stylesheet.imports||[],Le=this.getImportIndex(F);-1!==Le&&(Me.splice(Le,1),this.fragments[Le].style._remove(),this.fragments.splice(Le,1),this._reloadImports())}getImportIndex(Me){const Le=(this.stylesheet.imports||[]).findIndex((F=>F.id===Me));return-1===Le&&this.fire(new F.z(new Error(`Import '${Me}' does not exist in the map's style and cannot be updated.`))),Le}getLayer(F){return this._mergedLayers[F]}getSources(){const F=[];for(const Me in this._mergedOtherSourceCaches){const Le=this._mergedOtherSourceCaches[Me];Le&&F.push(Le.getSource())}return F}getSource(F,Me){const Le=this.getSourceCache(F,Me);return Le&&Le.getSource()}getLayerSource(F){const Me=this.getLayerSourceCache(F);return Me&&Me.getSource()}getSourceCache(Me,Le){const Oe=F.C(Me,Le);return this._mergedOtherSourceCaches[Oe]}getLayerSourceCache(Me){const Le=F.C(Me.source,Me.scope);return"symbol"===Me.type?this._mergedSymbolSourceCaches[Le]:this._mergedOtherSourceCaches[Le]}getSourceCaches(F){if(null==F)return Object.values(this._mergedSourceCaches);const Me=[];return this._mergedOtherSourceCaches[F]&&Me.push(this._mergedOtherSourceCaches[F]),this._mergedSymbolSourceCaches[F]&&Me.push(this._mergedSymbolSourceCaches[F]),Me}updateSourceCaches(){const F=this._changes.getUpdatedSourceCaches();for(const Me in F){const Le=F[Me];"reload"===Le?this.reloadSource(Me):"clear"===Le&&this.clearSource(Me)}}updateLayers(F){const Me=this._changes.getUpdatedPaintProperties();for(const Le of Me){const Me=this.getLayer(Le);Me&&Me.updateTransitions(F)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(F){this.stylesheet.glyphs=F,this.glyphManager.setURL(F,this.scope)}getImages(Me,Le,Oe){this.imageManager.getImages(Le.images,Le.scope,Oe),this._updateTilesForChangedImages();const s=Me=>{if(Me){const Oe=Le.images.map((Me=>F.I.toString(Me)));Me.setDependencies(Le.tileID.key,Le.type,Oe)}},Fe=F.C(Le.source,Le.scope);s(this._mergedOtherSourceCaches[Fe]),s(this._mergedSymbolSourceCaches[Fe])}rasterizeImages(F,Me,Le){this.imageManager.rasterizeImages(Me,Le)}getGlyphs(F,Me,Le){this.glyphManager.getGlyphs(Me.stacks,Me.scope,Le)}getResource(Me,Le,Oe){return F.cz(Le,Oe)}getOwnSourceCache(F){return this._otherSourceCaches[F]}getOwnLayerSourceCache(F){return"symbol"===F.type?this._symbolSourceCaches[F.source]:this._otherSourceCaches[F.source]}getOwnSourceCaches(F){const Me=[];return this._otherSourceCaches[F]&&Me.push(this._otherSourceCaches[F]),this._symbolSourceCaches[F]&&Me.push(this._symbolSourceCaches[F]),Me}_isSourceCacheLoaded(Me){const Le=this.getOwnSourceCaches(Me);return 0===Le.length?(this.fire(new F.z(new Error(`There is no source with ID '${Me}'`))),!1):Le.every((F=>F.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(F,Me){if(!this._clipLayerPresent&&"fill-extrusion"!==F.type)return!1;const Le="fill-extrusion"===F.type&&"building"===F.sourceLayer;if(F.is3D(!!this.terrain)){if(Le||Me&&"batched-model"===Me.type)return!0;if("model"===F.type)return!0}else if("symbol"===F.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((F=>{F.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}To.getSourceType=function(F){return gc[F]},To.setSourceType=function(F,Me){gc[F]=Me},To.registerForPluginStateChange=F.ci;var du="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",pu="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",fu="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",mu="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Su="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",Fu="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",Hu="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",Zu="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",Wu="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",Xu="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",hd="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef TEXTURE_GATHER\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return clamp(mix(lerpx.x,lerpx.y,f.y),0.0,1.0);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const md=[];Vo(du,md),Vo(fu,md),Vo(pu,md);const _d={"_prelude_fog.vertex.glsl":Fu,"_prelude_terrain.vertex.glsl":Su,"_prelude_shadow.vertex.glsl":Xu,"_prelude_fog.fragment.glsl":Hu,"_prelude_shadow.fragment.glsl":hd,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":Zu,"_prelude_raster_particle.glsl":Wu},xd={};Go("",Su),Go(Hu,Fu),Go(hd,Xu),Go(Zu,""),Go(Wu,"");const vd=Go(pu,fu),Bd=du;var Vd={background:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:Go("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Go('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:Go("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Go("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:Go("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Go("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:Go("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Go("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvoid main() {vec3 color=vec3(241.0/255.0,236.0/255.0,225.0/255.0);\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,normal);\n#endif\nif (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(v_normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:Go("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:Go('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:Go("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:Go("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),0.001);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:Go("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:Go("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Go('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Go('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#else\nz+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#endif\n}'),terrainRaster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:Go("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:Go('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',mu),skyboxGradient:Go('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',mu),skyboxCapture:Go("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:Go('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:Go("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:Go("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:Go("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:Go("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:Go("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Go("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Vo(F,Me){const Le=F.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let F of Le)if(F=F.trim(),"#"===F[0]&&F.includes("if")&&!F.includes("endif")){F=F.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const Le=F.split(" ");for(const F of Le)Me.includes(F)||Me.push(F)}}function Go(F,Me){const Le=/#include\s+"([^"]+)"/g,Oe=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let Fe=Me.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);Fe&&(Fe=Fe.map((F=>{const Me=F.split(" ");return Me[Me.length-1]})),Fe=[...new Set(Fe)]);const je={},qe=[],He=[];if(F=F.replace(Le,((F,Me)=>(He.push(Me),""))),(Me=Me.replace(Le,((F,Me)=>(qe.push(Me),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let xt=[...md];Vo(F,xt),Vo(Me,xt);for(const F of[...qe,...He])_d[F]||console.error(`Undefined include: ${F}`),xd[F]||(xd[F]=[],Vo(_d[F],xd[F])),xt=[...xt,...xd[F]];return{fragmentSource:F=F.replace(Oe,((F,Me,Le,Oe,Fe)=>(je[Fe]=!0,"define"===Me?`\n#ifndef HAS_UNIFORM_u_${Fe}\nin ${Le} ${Oe} ${Fe};\n#else\nuniform ${Le} ${Oe} u_${Fe};\n#endif\n`:"initialize"===Me?`\n#ifdef HAS_UNIFORM_u_${Fe}\n    ${Le} ${Oe} ${Fe} = u_${Fe};\n#endif\n`:"define-attribute"===Me?`\n#ifdef HAS_ATTRIBUTE_a_${Fe}\n    in ${Le} ${Oe} ${Fe};\n#endif\n`:"initialize-attribute"===Me?"":void 0))),vertexSource:Me=Me.replace(Oe,((F,Me,Le,Oe,Fe)=>{const qe="float"===Oe?"vec2":Oe,He=Fe.match(/color/)?"color":qe;return"define-attribute-vertex-shader-only"===Me?`\n#ifdef HAS_ATTRIBUTE_a_${Fe}\nin ${Le} ${Oe} a_${Fe};\n#endif\n`:je[Fe]?"define"===Me?`\n#ifndef HAS_UNIFORM_u_${Fe}\nuniform lowp float u_${Fe}_t;\nin ${Le} ${qe} a_${Fe};\nout ${Le} ${Oe} ${Fe};\n#else\nuniform ${Le} ${Oe} u_${Fe};\n#endif\n`:"initialize"===Me?"vec4"===He?`\n#ifndef HAS_UNIFORM_u_${Fe}\n    ${Fe} = a_${Fe};\n#else\n    ${Le} ${Oe} ${Fe} = u_${Fe};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${Fe}\n    ${Fe} = unpack_mix_${He}(a_${Fe}, u_${Fe}_t);\n#else\n    ${Le} ${Oe} ${Fe} = u_${Fe};\n#endif\n`:"define-attribute"===Me?`\n#ifdef HAS_ATTRIBUTE_a_${Fe}\n    in ${Le} ${Oe} a_${Fe};\n    out ${Le} ${Oe} ${Fe};\n#endif\n`:"initialize-attribute"===Me?`\n#ifdef HAS_ATTRIBUTE_a_${Fe}\n    ${Fe} = a_${Fe};\n#endif\n`:void 0:"define"===Me?`\n#ifndef HAS_UNIFORM_u_${Fe}\nuniform lowp float u_${Fe}_t;\nin ${Le} ${qe} a_${Fe};\n#else\nuniform ${Le} ${Oe} u_${Fe};\n#endif\n`:"define-instanced"===Me?"mat4"===He?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${Fe}0;\nin vec4 a_${Fe}1;\nin vec4 a_${Fe}2;\nin vec4 a_${Fe}3;\n#else\nuniform ${Le} ${Oe} u_${Fe};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${Le} ${qe} a_${Fe};\n#else\nuniform ${Le} ${Oe} u_${Fe};\n#endif\n`:"initialize-attribute-custom"===Me?`\n#ifdef HAS_ATTRIBUTE_a_${Fe}\n    ${Le} ${Oe} ${Fe} = a_${Fe};\n#endif\n`:"vec4"===He?`\n#ifndef HAS_UNIFORM_u_${Fe}\n    ${Le} ${Oe} ${Fe} = a_${Fe};\n#else\n    ${Le} ${Oe} ${Fe} = u_${Fe};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${Fe}\n    ${Le} ${Oe} ${Fe} = unpack_mix_${He}(a_${Fe}, u_${Fe}_t);\n#else\n    ${Le} ${Oe} ${Fe} = u_${Fe};\n#endif\n`})),staticAttributes:Fe,usedDefines:xt,vertexIncludes:qe,fragmentIncludes:He}}class jo{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(F,Me,Le,Oe,Fe,je,qe,He){this.context=F;let xt=this.boundPaintVertexBuffers.length!==Oe.length;for(let F=0;!xt&&F<Oe.length;F++)this.boundPaintVertexBuffers[F]!==Oe[F]&&(xt=!0);let Pt=this.boundDynamicVertexBuffers.length!==qe.length;for(let F=0;!Pt&&F<qe.length;F++)this.boundDynamicVertexBuffers[F]!==qe[F]&&(Pt=!0);if(!this.vao||this.boundProgram!==Me||this.boundLayoutVertexBuffer!==Le||xt||Pt||this.boundIndexBuffer!==Fe||this.boundVertexOffset!==je)this.freshBind(Me,Le,Oe,Fe,je,qe,He);else{F.bindVertexArrayOES.set(this.vao);for(const Le of qe)Le&&(Le.bind(),He&&Le.instanceCount&&Le.setVertexAttribDivisor(F.gl,Me,He));Fe&&Fe.dynamicDraw&&Fe.bind()}}freshBind(F,Me,Le,Oe,Fe,je,qe){const He=F.numAttributes,xt=this.context,Pt=xt.gl;this.vao&&this.destroy(),this.vao=xt.gl.createVertexArray(),xt.bindVertexArrayOES.set(this.vao),this.boundProgram=F,this.boundLayoutVertexBuffer=Me,this.boundPaintVertexBuffers=Le,this.boundIndexBuffer=Oe,this.boundVertexOffset=Fe,this.boundDynamicVertexBuffers=je,Me.enableAttributes(Pt,F),Me.bind(),Me.setVertexAttribPointers(Pt,F,Fe);for(const Me of Le)Me.enableAttributes(Pt,F),Me.bind(),Me.setVertexAttribPointers(Pt,F,Fe);for(const Me of je)Me&&(Me.enableAttributes(Pt,F),Me.bind(),Me.setVertexAttribPointers(Pt,F,Fe),qe&&Me.instanceCount&&Me.setVertexAttribDivisor(Pt,F,qe));Oe&&Oe.bind(),xt.currentNumAttributes=He}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function qo(Me,Le){const Oe=Math.pow(2,Le.canonical.z),Fe=Le.canonical.y;return[new F.ac(0,Fe/Oe).toLngLat().lat,new F.ac(0,(Fe+1)/Oe).toLngLat().lat]}function Ho(Me,Le,Oe,Fe,je,qe,He){const xt=Me.context,Pt=xt.gl,jt=Oe.hillshadeFBO;if(!jt)return;Me.prepareDrawTile();const Gt=Me.isTileAffectedByFog(Le),bi=Me.getOrCreateProgram("hillshade",{overrideFog:Gt});xt.activeTexture.set(Pt.TEXTURE0),Pt.bindTexture(Pt.TEXTURE_2D,jt.colorAttachment.get());const wi=((Me,Le,Oe,Fe)=>{const je=Oe.paint.get("hillshade-shadow-color"),qe="none"===Oe.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),He=Oe.paint.get("hillshade-highlight-color"),xt="none"===Oe.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),Pt=Oe.paint.get("hillshade-accent-color"),jt="none"===Oe.paint.get("hillshade-accent-color-use-theme").constantOr("default"),Gt=Oe.paint.get("hillshade-emissive-strength");let bi=F.ak(Oe.paint.get("hillshade-illumination-direction"));if("viewport"===Oe.paint.get("hillshade-illumination-anchor"))bi-=Me.transform.angle;else if(Me.style&&Me.style.enable3dLights()&&Me.style.directionalLight){const Le=Me.style.directionalLight.properties.get("direction"),Oe=F.cc(Le.x,Le.y,Le.z);bi=F.ak(Oe[1])}const wi=!Me.options.moving;return{u_matrix:Fe||Me.transform.calculateProjMatrix(Le.tileID.toUnwrapped(),wi),u_image:0,u_latrange:qo(0,Le.tileID),u_light:[Oe.paint.get("hillshade-exaggeration"),bi],u_shadow:je.toRenderColor(qe?null:Oe.lut),u_highlight:He.toRenderColor(xt?null:Oe.lut),u_emissive_strength:Gt,u_accent:Pt.toRenderColor(jt?null:Oe.lut)}})(Me,Oe,Fe,Me.terrain?Le.projMatrix:null);Me.uploadCommonUniforms(xt,bi,Le.toUnwrapped());const{tileBoundsBuffer:qr,tileBoundsIndexBuffer:Xn,tileBoundsSegments:Yn}=Me.getTileBoundsBuffers(Oe);bi.draw(Me,Pt.TRIANGLES,je,qe,He,ji.disabled,wi,Fe.id,qr,Xn,Yn)}function Zo(Me,Le,Oe){if(!Le.needsDEMTextureUpload)return;const Fe=Me.context,je=Fe.gl;Fe.pixelStoreUnpackPremultiplyAlpha.set(!1),Le.demTexture=Le.demTexture||Me.getTileTexture(Oe.stride);const qe=Oe.getPixels();Le.demTexture?Le.demTexture.update(qe,{premultiply:!1}):Le.demTexture=new F.T(Fe,qe,je.R32F,{premultiply:!1}),Le.needsDEMTextureUpload=!1}function Wo(Me,Le,Oe){const Fe=Me.context,je=Fe.gl;if(!Le.dem)return;const qe=Le.dem;if(Fe.activeTexture.set(je.TEXTURE1),Zo(Me,Le,qe),!Le.demTexture)return;Le.demTexture.bind(je.NEAREST,je.CLAMP_TO_EDGE);const He=qe.dim;Fe.activeTexture.set(je.TEXTURE0);let xt=Le.hillshadeFBO;if(!xt){const Me=new F.T(Fe,{width:He,height:He,data:null},je.RGBA8);Me.bind(je.LINEAR,je.CLAMP_TO_EDGE),xt=Le.hillshadeFBO=Fe.createFramebuffer(He,He,!0,"renderbuffer"),xt.colorAttachment.set(Me.texture)}Fe.bindFramebuffer.set(xt.framebuffer),Fe.viewport.set([0,0,He,He]);const{tileBoundsBuffer:Pt,tileBoundsIndexBuffer:jt,tileBoundsSegments:Gt}=Me.getMercatorTileBoundsBuffers(),bi=[];Me.linearFloatFilteringSupported()&&bi.push("TERRAIN_DEM_FLOAT_FORMAT"),Me.getOrCreateProgram("hillshadePrepare",{defines:bi}).draw(Me,je.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.disabled,((Me,Le)=>{const Oe=Le.stride,Fe=F.ad.mat4.create();return F.ad.mat4.ortho(Fe,0,F.ai,-F.ai,0,0,1),F.ad.mat4.translate(Fe,Fe,[0,-F.ai,0]),{u_matrix:Fe,u_image:1,u_dimension:[Oe,Oe],u_zoom:Me.overscaledZ}})(Le.tileID,qe),Oe.id,Pt,jt,Gt),Le.needsHillshadePrepare=!1}class $o{constructor(F){this.gl=F.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(F){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Xo extends $o{getDefault(){return F.al.transparent}set(F){const Me=this.current;(F.r!==Me.r||F.g!==Me.g||F.b!==Me.b||F.a!==Me.a||this.dirty)&&(this.gl.clearColor(F.r,F.g,F.b,F.a),this.current=F,this.dirty=!1)}}class Ko extends $o{getDefault(){return 1}set(F){(F!==this.current||this.dirty)&&(this.gl.clearDepth(F),this.current=F,this.dirty=!1)}}class Yo extends $o{getDefault(){return 0}set(F){(F!==this.current||this.dirty)&&(this.gl.clearStencil(F),this.current=F,this.dirty=!1)}}class Jo extends $o{getDefault(){return[!0,!0,!0,!0]}set(F){const Me=this.current;(F[0]!==Me[0]||F[1]!==Me[1]||F[2]!==Me[2]||F[3]!==Me[3]||this.dirty)&&(this.gl.colorMask(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class Qo extends $o{getDefault(){return!0}set(F){(F!==this.current||this.dirty)&&(this.gl.depthMask(F),this.current=F,this.dirty=!1)}}class es extends $o{getDefault(){return 255}set(F){(F!==this.current||this.dirty)&&(this.gl.stencilMask(F),this.current=F,this.dirty=!1)}}class ts extends $o{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(F){const Me=this.current;(F.func!==Me.func||F.ref!==Me.ref||F.mask!==Me.mask||this.dirty)&&(this.gl.stencilFunc(F.func,F.ref,F.mask),this.current=F,this.dirty=!1)}}class is extends $o{getDefault(){const F=this.gl;return[F.KEEP,F.KEEP,F.KEEP]}set(F){const Me=this.current;(F[0]!==Me[0]||F[1]!==Me[1]||F[2]!==Me[2]||this.dirty)&&(this.gl.stencilOp(F[0],F[1],F[2]),this.current=F,this.dirty=!1)}}class os extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;F?Me.enable(Me.STENCIL_TEST):Me.disable(Me.STENCIL_TEST),this.current=F,this.dirty=!1}}class ss extends $o{getDefault(){return[0,1]}set(F){const Me=this.current;(F[0]!==Me[0]||F[1]!==Me[1]||this.dirty)&&(this.gl.depthRange(F[0],F[1]),this.current=F,this.dirty=!1)}}class rs extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;F?Me.enable(Me.DEPTH_TEST):Me.disable(Me.DEPTH_TEST),this.current=F,this.dirty=!1}}class ns extends $o{getDefault(){return this.gl.LESS}set(F){(F!==this.current||this.dirty)&&(this.gl.depthFunc(F),this.current=F,this.dirty=!1)}}class as extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;F?Me.enable(Me.BLEND):Me.disable(Me.BLEND),this.current=F,this.dirty=!1}}class ls extends $o{getDefault(){const F=this.gl;return[F.ONE,F.ZERO,F.ONE,F.ZERO]}set(F){const Me=this.current;(F[0]!==Me[0]||F[1]!==Me[1]||F[2]!==Me[2]||F[3]!==Me[3]||this.dirty)&&(this.gl.blendFuncSeparate(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class cs extends $o{getDefault(){return F.al.transparent}set(F){const Me=this.current;(F.r!==Me.r||F.g!==Me.g||F.b!==Me.b||F.a!==Me.a||this.dirty)&&(this.gl.blendColor(F.r,F.g,F.b,F.a),this.current=F,this.dirty=!1)}}class hs extends $o{getDefault(){return this.gl.FUNC_ADD}set(F){(F!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(F,F),this.current=F,this.dirty=!1)}}class ds extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;F?Me.enable(Me.CULL_FACE):Me.disable(Me.CULL_FACE),this.current=F,this.dirty=!1}}class us extends $o{getDefault(){return this.gl.BACK}set(F){(F!==this.current||this.dirty)&&(this.gl.cullFace(F),this.current=F,this.dirty=!1)}}class _s extends $o{getDefault(){return this.gl.CCW}set(F){(F!==this.current||this.dirty)&&(this.gl.frontFace(F),this.current=F,this.dirty=!1)}}let qd=class extends $o{getDefault(){return null}set(F){(F!==this.current||this.dirty)&&(this.gl.useProgram(F),this.current=F,this.dirty=!1)}};class fs extends $o{getDefault(){return this.gl.TEXTURE0}set(F){(F!==this.current||this.dirty)&&(this.gl.activeTexture(F),this.current=F,this.dirty=!1)}}class ms extends $o{getDefault(){const F=this.gl;return[0,0,F.drawingBufferWidth,F.drawingBufferHeight]}set(F){const Me=this.current;(F[0]!==Me[0]||F[1]!==Me[1]||F[2]!==Me[2]||F[3]!==Me[3]||this.dirty)&&(this.gl.viewport(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class gs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;Me.bindFramebuffer(Me.FRAMEBUFFER,F),this.current=F,this.dirty=!1}}class vs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;Me.bindRenderbuffer(Me.RENDERBUFFER,F),this.current=F,this.dirty=!1}}class ys extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;Me.bindTexture(Me.TEXTURE_2D,F),this.current=F,this.dirty=!1}}class xs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;Me.bindBuffer(Me.ARRAY_BUFFER,F),this.current=F,this.dirty=!1}}class bs extends $o{getDefault(){return null}set(F){const Me=this.gl;Me.bindBuffer(Me.ELEMENT_ARRAY_BUFFER,F),this.current=F,this.dirty=!1}}class ws extends $o{getDefault(){return null}set(F){this.gl&&(F!==this.current||this.dirty)&&(this.gl.bindVertexArray(F),this.current=F,this.dirty=!1)}}class Ts extends $o{getDefault(){return 4}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;Me.pixelStorei(Me.UNPACK_ALIGNMENT,F),this.current=F,this.dirty=!1}}class Es extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;Me.pixelStorei(Me.UNPACK_PREMULTIPLY_ALPHA_WEBGL,F),this.current=F,this.dirty=!1}}class Ss extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Me=this.gl;Me.pixelStorei(Me.UNPACK_FLIP_Y_WEBGL,F),this.current=F,this.dirty=!1}}class Cs extends $o{constructor(F,Me){super(F),this.context=F,this.parent=Me}getDefault(){return null}}class Is extends Cs{setDirty(){this.dirty=!0}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Me=this.gl;Me.framebufferTexture2D(Me.FRAMEBUFFER,Me.COLOR_ATTACHMENT0,Me.TEXTURE_2D,F,0),this.current=F,this.dirty=!1}}class Rs extends Cs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Me=this.gl;Me.framebufferRenderbuffer(Me.FRAMEBUFFER,this.attachment(),Me.RENDERBUFFER,F),this.current=F,this.dirty=!1}}class Ds extends Cs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Me=this.gl;Me.framebufferTexture2D(Me.FRAMEBUFFER,this.attachment(),Me.TEXTURE_2D,F,0),this.current=F,this.dirty=!1}}class As extends Rs{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Ls=(F,Me,Le)=>({u_matrix:F,u_image0:0,u_skirt_height:Me,u_ground_shadow_factor:Le}),Ps=(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn)=>({u_proj_matrix:Float32Array.from(F),u_globe_matrix:Me,u_normalize_matrix:Float32Array.from(Oe),u_merc_matrix:Le,u_zoom_transition:Fe,u_merc_center:je,u_image0:0,u_frustum_tl:qe,u_frustum_tr:He,u_frustum_br:xt,u_frustum_bl:Pt,u_globe_pos:jt,u_globe_radius:Gt,u_viewport:bi,u_grid_matrix:Xn?Float32Array.from(Xn):new Float32Array(9),u_skirt_height:wi,u_far_z_cutoff:qr});function Ms(F,Me){return null!=F&&null!=Me&&!(!F.hasData()||!Me.hasData())&&null!=F.demTexture&&null!=Me.demTexture&&F.tileID.key!==Me.tileID.key}const $d=new class{constructor(){this.operations={}}newMorphing(F,Me,Le,Oe,Fe){if(F in this.operations){const Me=this.operations[F];Me.to.tileID.key!==Le.tileID.key&&(Me.queued=Le)}else this.operations[F]={startTime:Oe,phase:0,duration:Fe,from:Me,to:Le,queued:null}}getMorphValuesForProxy(F){if(!(F in this.operations))return null;const Me=this.operations[F];return{from:Me.from,to:Me.to,phase:Me.phase}}update(F){for(const Me in this.operations){const Le=this.operations[Me];for(Le.phase=(F-Le.startTime)/Le.duration;Le.phase>=1||!this._validOp(Le);)if(!this._nextOp(Le,F)){delete this.operations[Me];break}}}_nextOp(F,Me){return!!F.queued&&(F.from=F.to,F.to=F.queued,F.queued=null,F.phase=0,F.startTime=Me,!0)}_validOp(F){return F.from.hasData()&&F.to.hasData()}},Qd={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Fs(F,Me,Le){if(0===Me)return 0;const Oe=Me<1&&514===Le?.25/Me:1;return 6*Math.pow(1.5,22-F)*Math.max(Me,1)*Oe}function ks(F,Me){const Le=1<<F.z;return!Me&&(0===F.x||F.x===Le-1)||0===F.y||F.y===Le-1}const Bs=F=>({u_matrix:F});function Ns(Me,Le,Oe,Fe,je){if(je>0){const qe=F.q.now(),He=(qe-Me.timeAdded)/je,xt=Le?(qe-Le.timeAdded)/je:-1,Pt=Oe.getSource(),jt=Fe.coveringZoomLevel({tileSize:Pt.tileSize,roundZoom:Pt.roundZoom}),Gt=!Le||Math.abs(Le.tileID.overscaledZ-jt)>Math.abs(Me.tileID.overscaledZ-jt),bi=Gt&&Me.refreshedUponExpiration?1:F.ay(Gt?He:1-xt,0,1);return Me.refreshedUponExpiration&&He>=1&&(Me.refreshedUponExpiration=!1),Le?{opacity:1,mix:1-bi}:{opacity:bi,mix:0}}return{opacity:1,mix:0}}class Us extends St{constructor(Me){const Le={type:"raster-dem",maxzoom:Me.transform.maxZoom},Oe=new F.D(F.cj(),null),Fe=rt("mock-dem",Le,Oe,Me.style);super("mock-dem",Fe,!1),Fe.setEventedParent(this),this._sourceLoaded=!0}_loadTile(F,Me){F.state="loaded",Me(null)}}class Vs extends St{constructor(Me){const Le=rt("proxy",{type:"geojson",maxzoom:Me.transform.maxZoom},new F.D(F.cj(),null),Me.style);super("proxy",Le,!1),Le.setEventedParent(this),this.map=this.getSource().map=Me,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(F,Me,Le){if(F.freezeTileCoverage)return;this.transform=F;const Oe=F.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((Me,Le)=>{if(Me[Le.key]="",!this._tiles[Le.key]){const Me=new bt(Le,this._source.tileSize*Le.overscaleFactor(),F.tileZoom);Me.state="loaded",this._tiles[Le.key]=Me}return Me}),{});for(const F in this._tiles)F in Oe||(this.freeFBO(F),this._tiles[F].unloadVectorData(),delete this._tiles[F])}freeFBO(F){const Me=this.proxyCachedFBO[F];if(void 0!==Me){const Le=Object.values(Me);this.renderCachePool.push(...Le),delete this.proxyCachedFBO[F]}}deallocRenderCache(){this.renderCache.forEach((F=>F.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Gs extends F.aH{constructor(F,Me,Le){super(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y),this.proxyTileKey=Me,this.projMatrix=Le}}class js extends F.cK{constructor(Me,Le){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},Me.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),Me.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),Me.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=Me,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[Oe,Fe,je]=function(){const Me=new F.b5,Le=new F.aV,Oe=131;Me.reserve(17161),Le.reserve(33800);const Fe=F.ai/128,je=F.ai+Fe/2,qe=je+Fe;for(let Le=-Fe;Le<qe;Le+=Fe)for(let Oe=-Fe;Oe<qe;Oe+=Fe){const Fe=Oe<0||Oe>je||Le<0||Le>je?24575:0,qe=F.ay(Math.round(Oe),0,F.ai),He=F.ay(Math.round(Le),0,F.ai);Me.emplaceBack(qe+Fe,He)}const l=(F,Me)=>{const Fe=Me*Oe+F;Le.emplaceBack(Fe+1,Fe,Fe+Oe),Le.emplaceBack(Fe+Oe,Fe+Oe+1,Fe+1)};for(let F=1;F<129;F++)for(let Me=1;Me<129;Me++)l(Me,F);return[0,129].forEach((F=>{for(let Me=0;Me<130;Me++)l(Me,F),l(F,Me)})),[Me,Le,32768]}(),qe=Me.context;this.gridBuffer=qe.createVertexBuffer(Oe,F.b7.members),this.gridIndexBuffer=qe.createIndexBuffer(Fe),this.gridSegments=F.b8.simpleSegment(0,0,Oe.length,Fe.length),this.gridNoSkirtSegments=F.b8.simpleSegment(0,0,Oe.length,je),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Vs(Le.map),this.orthoMatrix=F.ad.mat4.create(),F.ad.mat4.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,F.ai,0,F.ai,0,1);const He=qe.gl;this._overlapStencilMode=new Ui({func:He.GEQUAL,mask:255},0,255,He.KEEP,He.KEEP,He.REPLACE),this._previousZoom=Me.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=Le,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Us(Le.map),this._pendingGroundEffectLayers=[]}set style(F){F.on("data",this._onStyleDataEvent.bind(this)),this._style=F,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(Me,Le,Oe){if(Me&&Me.terrain){this._style!==Me&&(this.style=Me,this._evaluationZoom=void 0);const Fe=Me.terrain.properties,je=0===Me.terrain.drapeRenderMode,qe=Me.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=F.q.now();const He=Me.terrain&&Me.terrain.scope,xt=Fe.get("source"),Pt=je?this._mockSourceCache:Me.getSourceCache(xt,He);if(!Pt)return void F.w(`Couldn't find terrain source "${xt}".`);if(this.sourceCache=Pt,this._attenuationRange=Me.terrain.getAttenuationRange(),this._exaggeration=qe?this.calculateExaggeration(Le):Fe.get("exaggeration"),!Le.projection.requiresDraping&&qe&&0===this._exaggeration)return void this._disable();this.enabled=!0;const h=()=>{this.sourceCache.used&&F.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const Me=this.getScaledDemTileSize();this.sourceCache.update(Le,Me,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,h(),this._initializing=!0),h(),Le.updateElevation(!0,Oe),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(Le),this._emptyDEMTextureDirty=!0,this._previousZoom=Le.zoom}else this._disable()}calculateExaggeration(Me){if(this._attenuationRange&&Me.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(Me.zoom);const Le=this._previousCameraAltitude,Oe=Me.getFreeCameraOptions().position.z/Me.pixelsPerMeter*Me.worldSize;this._previousCameraAltitude=Oe;const Fe=null!=Le?Oe-Le:Number.MAX_VALUE;if(Math.abs(Fe)<2)return this._exaggeration;const je=Me.zoom,qe=this._style.terrain;if(!this._previousUpdateTimestamp)return qe.getExaggeration(je);let He=je-this._previousZoom;const xt=this._previousUpdateTimestamp;let Pt=je;null!=this._evaluationZoom&&(Pt=this._evaluationZoom,Math.abs(je-Pt)>.5&&(He=.5*(je-Pt+He)),He*Fe<0&&(Pt+=He)),this._evaluationZoom=Pt;const jt=qe.getExaggeration(Pt),Gt=jt===qe.getExaggeration(Math.max(0,Pt-.1));if(Gt&&Math.abs(jt-this._exaggeration)<.01)return jt;let bi=Math.min(.1,.00375*(this._updateTimestamp-xt));return(Gt||jt<.1||Math.abs(He)<1e-4)&&(bi=Math.min(.2,4*bi)),F.ah(this._exaggeration,jt,bi)}resetTileLookupCache(F){this._findCoveringTileCache[F]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(F){F.coord&&"source"===F.dataType?this._clearRenderCacheForTile(F.sourceCacheId,F.coord):"style"===F.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const F in this._style._mergedSourceCaches)this._style._mergedSourceCaches[F].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((F=>F.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const F=2*this.proxySourceCache.getSource().tileSize;return[F,F]}set useVertexMorphing(F){this._useVertexMorphing=F}updateTileBinding(Me){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const Le=this.proxySourceCache,Oe=this.painter.transform;this._initializing&&(this._initializing=0===Oe._centerAltitude&&-1===this.getAtPointOrZero(F.ac.fromLngLat(Oe.center),-1),this._emptyDEMTextureDirty=!this._initializing);const Fe=this.proxyCoords=Le.getIds().map((F=>{const Me=Le.getTileByID(F).tileID;return Me.projMatrix=Oe.calculateProjMatrix(Me.toUnwrapped()),Me}));!function(Me,Le){const Oe=Le.transform.pointCoordinate(Le.transform.getCameraPoint()),Fe=new F.P(Oe.x,Oe.y);Me.sort(((Me,Le)=>{if(Le.overscaledZ-Me.overscaledZ)return Le.overscaledZ-Me.overscaledZ;const Oe=new F.P(Me.canonical.x+(1<<Me.canonical.z)*Me.wrap,Me.canonical.y),je=new F.P(Le.canonical.x+(1<<Le.canonical.z)*Le.wrap,Le.canonical.y),qe=Fe.mult(1<<Me.canonical.z);return qe.x-=.5,qe.y-=.5,qe.distSqr(Oe)-qe.distSqr(je)}))}(Fe,this.painter);const je=this.proxyToSource||{};this.proxyToSource={},Fe.forEach((F=>{this.proxyToSource[F.key]={}})),this.terrainTileForTile={};const qe=this._style._mergedSourceCaches;for(const F in qe){const Le=qe[F];if(!Le.used)continue;if(Le!==this.sourceCache&&this.resetTileLookupCache(Le.id),this._setupProxiedCoordsForOrtho(Le,Me[F],je),Le.usedForTerrain)continue;const Oe=Me[F];Le.getSource().reparseOverscaled&&this._assignTerrainTiles(Oe)}this.proxiedCoords[Le.id]=Fe.map((F=>new Gs(F,F.key,this.orthoMatrix))),this._assignTerrainTiles(Fe),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(je),this.renderingToTexture=!1;const He={};this._visibleDemTiles=[];for(const F of this.proxyCoords){const Me=this.terrainTileForTile[F.key];if(!Me)continue;const Le=Me.tileID.key;Le in He||(this._visibleDemTiles.push(Me),He[Le]=Le)}}_assignTerrainTiles(F){this._initializing||F.forEach((F=>{if(this.terrainTileForTile[F.key])return;const Me=this._findTileCoveringTileID(F,this.sourceCache);Me&&(this.terrainTileForTile[F.key]=Me)}))}_prepareDEMTextures(){const F=this.painter.context,Me=F.gl;for(const Le in this.terrainTileForTile){const Oe=this.terrainTileForTile[Le],Fe=Oe.dem;!Fe||Oe.demTexture&&!Oe.needsDEMTextureUpload||(F.activeTexture.set(Me.TEXTURE1),Zo(this.painter,Oe,Fe))}}_prepareDemTileUniforms(F,Me,Le,Oe){if(!Me||null==Me.demTexture)return!1;const Fe=F.tileID.canonical,je=Math.pow(2,Me.tileID.canonical.z-Fe.z),qe=Oe||"";return Le[`u_dem_tl${qe}`]=[Fe.x*je%1,Fe.y*je%1],Le[`u_dem_scale${qe}`]=je,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let F=0;const Me=this._visibleDemTiles.reduce(((Me,Le)=>{if(!Le.dem)return Me;const Oe=Le.dem.tree.minimums[0];return Oe>0&&F++,Me+Oe}),0);return F?Me/F:0}_updateEmptyDEMTexture(){const Me=this.painter.context,Le=Me.gl;Me.activeTexture.set(Le.TEXTURE2);const Oe=this._getLoadedAreaMinimum(),Fe=new F.cL({width:1,height:1},new Float32Array([Oe]));this._emptyDEMTextureDirty=!1;let je=this._emptyDEMTexture;return je?je.update(Fe,{premultiply:!1}):je=this._emptyDEMTexture=new F.T(Me,Fe,Le.R32F,{premultiply:!1}),je}setupElevationDraw(Me,Le,Oe){const Fe=this.painter.context,je=Fe.gl,qe={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};qe.u_exaggeration=this.exaggeration();let He=null,xt=null,Pt=1;if(Oe&&Oe.morphing&&this._useVertexMorphing){const F=Oe.morphing.srcDemTile,Le=Oe.morphing.dstDemTile;Pt=Oe.morphing.phase,F&&Le&&(this._prepareDemTileUniforms(Me,F,qe,"_prev")&&(xt=F),this._prepareDemTileUniforms(Me,Le,qe)&&(He=Le))}const h=F=>F&&F.demTexture&&this.painter.linearFloatFilteringSupported()?je.LINEAR:je.NEAREST;let jt=null;var Gt;if(this.enabled?xt&&He?(jt=He.demTexture,Fe.activeTexture.set(je.TEXTURE4),xt.demTexture.bind(h(xt),je.CLAMP_TO_EDGE),qe.u_dem_lerp=Pt):(He=this.terrainTileForTile[Me.tileID.key],jt=this._prepareDemTileUniforms(Me,He,qe)?He.demTexture:this.emptyDEMTexture):jt=this.emptyDEMTexture,Fe.activeTexture.set(je.TEXTURE2),jt&&(qe.u_dem_size=1===(Gt=jt).size[0]?1:Gt.size[0]-2,jt.bind(h(He),je.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(Oe&&Oe.useDepthForOcclusion,Le,qe),Oe&&Oe.useMeterToDem&&He){const Me=(1<<He.tileID.canonical.z)*F.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;qe.u_meter_to_dem=Me}if(Oe&&Oe.labelPlaneMatrixInv&&(qe.u_label_plane_matrix_inv=Oe.labelPlaneMatrixInv),Le.setTerrainUniformValues(Fe,qe),"globe"===this.painter.transform.projection.name){const F=this.globeUniformValues(this.painter.transform,Me.tileID.canonical,Oe&&Oe.useDenormalizedUpVectorScale);Le.setGlobeUniformValues(Fe,F)}}globeUniformValues(Me,Le,Oe){const Fe=Me.projection;return{u_tile_tl_up:Fe.upVector(Le,0,0),u_tile_tr_up:Fe.upVector(Le,F.ai,0),u_tile_br_up:Fe.upVector(Le,F.ai,F.ai),u_tile_bl_up:Fe.upVector(Le,0,F.ai),u_tile_up_scale:Oe?F.cM(1):Fe.upVectorScale(Le,Me.center.lat,Me.worldSize).metersToTile}}renderToBackBuffer(Me){const Le=this.painter,Oe=this.painter.context;0!==Me.length&&(Oe.bindFramebuffer.set(null),Oe.viewport.set([0,0,Le.width,Le.height]),Le.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(Me,Le,Oe,Fe,je){if("globe"===Me.transform.projection.name)!function(Me,Le,Oe,Fe,je){const qe=Me.context,He=qe.gl;let xt,Pt;const jt=Me.transform,Gt=F.cD(Me,qe,jt),u=(F,Le)=>{if(Pt===Le)return;const Oe=[Qd[Le],"PROJECTION_GLOBE_VIEW"];Gt&&Oe.push("CUSTOM_ANTIALIASING");const Fe=Me.isTileAffectedByFog(F);xt=Me.getOrCreateProgram("globeRaster",{defines:Oe,overrideFog:Fe}),Pt=Le},bi=Me.colorModeForRenderPass(),wi=new Bi(He.LEQUAL,Bi.ReadWrite,Me.depthRangeFor3D);$d.update(je);const qr=F.cE(jt),Xn=[F.av(jt.center.lng),F.aC(jt.center.lat)],Yn=Me.globeSharedBuffers,yo=[jt.width*F.q.devicePixelRatio,jt.height*F.q.devicePixelRatio],bo=Float32Array.from(jt.globeMatrix),Ro={useDenormalizedUpVectorScale:!0};{const jt=Me.transform,Gt=Fs(jt.zoom,Le.exaggeration(),Le.sourceCache._source.tileSize);Pt=-1;const Do=He.TRIANGLES;for(const Pt of Fe){const Fe=Oe.getTile(Pt),zs=Ui.disabled,Zs=Le.prevTerrainTileForTile[Pt.key],na=Le.terrainTileForTile[Pt.key];Ms(Zs,na)&&$d.newMorphing(Pt.key,Zs,na,je,250),qe.activeTexture.set(He.TEXTURE0),Fe.texture&&Fe.texture.bind(He.LINEAR,He.CLAMP_TO_EDGE);const el=$d.getMorphValuesForProxy(Pt.key),nl=el?1:0;el&&F.L(Ro,{morphing:{srcDemTile:el.from,dstDemTile:el.to,phase:F.cC(el.phase)}});const hl=F.cF(Pt.canonical),pl=F.cG(hl.getCenter().lat),bl=F.cH(Pt.canonical,hl,pl,jt.worldSize/jt._pixelsPerMercatorPixel),Tl=F.bc(F.cI(Pt.canonical)),kl=Ps(jt.expandedFarZProjMatrix,bo,qr,Tl,F.ag(jt.zoom),Xn,jt.frustumCorners.TL,jt.frustumCorners.TR,jt.frustumCorners.BR,jt.frustumCorners.BL,jt.globeCenterInViewSpace,jt.globeRadius,yo,Gt,jt._farZ,bl);if(u(Pt,nl),xt&&(Le.setupElevationDraw(Fe,xt,Ro),Me.uploadCommonUniforms(qe,xt,Pt.toUnwrapped()),Yn)){const[F,Le,Oe]=Yn.getGridBuffers(pl,0!==Gt);xt.draw(Me,Do,wi,zs,bi,ji.backCCW,kl,"globe_raster",F,Le,Oe)}}}if(Yn&&(Me.renderDefaultNorthPole||Me.renderDefaultSouthPole)){const je=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Gt&&je.push("CUSTOM_ANTIALIASING"),xt=Me.getOrCreateProgram("globeRaster",{defines:je});for(const je of Fe){const{x:Fe,y:Pt,z:Gt}=je.canonical,qr=0===Pt,bo=Pt===(1<<Gt)-1,[Do,zs,Zs,na]=Yn.getPoleBuffers(Gt,!1);if(na&&(qr||bo)){const Pt=Oe.getTile(je);qe.activeTexture.set(He.TEXTURE0),Pt.texture&&Pt.texture.bind(He.LINEAR,He.CLAMP_TO_EDGE);let Yn=F.cJ(Gt,Fe,jt);const el=F.bc(F.cI(je.canonical)),S=(F,Le)=>F.draw(Me,He.TRIANGLES,wi,Ui.disabled,bi,ji.disabled,Ps(jt.expandedFarZProjMatrix,Yn,Yn,el,0,Xn,jt.frustumCorners.TL,jt.frustumCorners.TR,jt.frustumCorners.BR,jt.frustumCorners.BL,jt.globeCenterInViewSpace,jt.globeRadius,yo,0,jt._farZ),"globe_pole_raster",Le,Zs,na);Le.setupElevationDraw(Pt,xt,Ro),Me.uploadCommonUniforms(qe,xt,je.toUnwrapped()),qr&&Me.renderDefaultNorthPole&&S(xt,Do),bo&&Me.renderDefaultSouthPole&&(Yn=F.ad.mat4.scale(F.ad.mat4.create(),Yn,[1,-1,1]),S(xt,zs))}}}}(Me,Le,Oe,Fe,je);else{const qe=Me.context,He=qe.gl;let xt,Pt;const jt=Me.shadowRenderer,Gt=Qi(Me,Me.longestCutoffRange),u=F=>{if(Pt===F)return;const Le=[];Le.push(Qd[F]),Gt.shouldRenderCutoff&&Le.push("RENDER_CUTOFF"),jt&&(Le.push("RENDER_SHADOWS","DEPTH_TEXTURE"),jt.useNormalOffset&&Le.push("NORMAL_OFFSET")),xt=Me.getOrCreateProgram("terrainRaster",{defines:Le}),Pt=F},bi=Me.colorModeForRenderPass(),wi=new Bi(He.LEQUAL,Bi.ReadWrite,Me.depthRangeFor3D);$d.update(je);const qr=Me.transform,Xn=Fs(qr.zoom,Le.exaggeration(),Le.sourceCache._source.tileSize);let Yn=[0,0,0];if(jt){const F=Me.style.directionalLight,Le=Me.style.ambientLight;F&&Le&&(Yn=no(Me.style,F,Le))}{Pt=-1;const yo=He.TRIANGLES,[bo,Ro]=[Le.gridIndexBuffer,Le.gridSegments];for(const Pt of Fe){const Fe=Oe.getTile(Pt),Do=Ui.disabled,zs=Le.prevTerrainTileForTile[Pt.key],Zs=Le.terrainTileForTile[Pt.key];Ms(zs,Zs)&&$d.newMorphing(Pt.key,zs,Zs,je,250),qe.activeTexture.set(He.TEXTURE0),Fe.texture&&Fe.texture.bind(He.LINEAR,He.CLAMP_TO_EDGE);const na=$d.getMorphValuesForProxy(Pt.key),el=na?1:0;let nl;na&&(nl={morphing:{srcDemTile:na.from,dstDemTile:na.to,phase:F.cC(na.phase)}});const hl=Ls(Pt.projMatrix,ks(Pt.canonical,qr.renderWorldCopies)?Xn/10:Xn,Yn);if(u(el),!xt)continue;Le.setupElevationDraw(Fe,xt,nl);const pl=Pt.toUnwrapped();jt&&jt.setupShadows(pl,xt),Me.uploadCommonUniforms(qe,xt,pl,null,Gt),xt.draw(Me,yo,wi,Do,bi,ji.backCCW,hl,"terrain_raster",Le.gridBuffer,bo,Ro)}}}}(Le,this,this.proxySourceCache,Me,this._updateTimestamp),this.renderingToTexture=!0,Le.gpuTimingDeferredRenderEnd(),Me.splice(0,Me.length))}renderBatch(Me){if(0===this._drapedRenderBatches.length)return Me+1;this.renderingToTexture=!0;const Le=this.painter,Oe=this.painter.context,Fe=this.proxySourceCache,je=this.proxiedCoords[Fe.id],qe=this._drapedRenderBatches.shift(),He=Le.style.order,xt=[];let Pt=0;for(const jt of je){const je=Fe.getTileByID(jt.proxyTileKey),Gt=Fe.proxyCachedFBO[jt.key]?Fe.proxyCachedFBO[jt.key][Me]:void 0,bi=void 0!==Gt?Fe.renderCache[Gt]:this.pool[Pt++],wi=void 0!==Gt;if(je.texture=bi.tex,wi&&!bi.dirty){xt.push(je.tileID);continue}let qr;Oe.bindFramebuffer.set(bi.fb.framebuffer),this.renderedToTile=!1,bi.dirty&&(Oe.clear({color:F.al.transparent,stencil:0}),bi.dirty=!1);for(let F=qe.start;F<=qe.end;++F){const Me=Le.style._mergedLayers[He[F]];if(Me.isHidden(Le.transform.zoom))continue;const Fe=Le.style.getLayerSourceCache(Me),je=Fe?this.proxyToSource[jt.key][Fe.id]:[jt];if(!je)continue;const qe=je;Oe.viewport.set([0,0,bi.fb.width,bi.fb.height]),qr!==(Fe?Fe.id:null)&&(this._setupStencil(bi,je,Me,Fe),qr=Fe?Fe.id:null),Le.renderLayer(Le,Fe,Me,qe)}if(0===this._drapedRenderBatches.length)for(const F of this._pendingGroundEffectLayers){const Me=Le.style._mergedLayers[He[F]];if(Me.isHidden(Le.transform.zoom))continue;const Fe=Le.style.getLayerSourceCache(Me),je=Fe?this.proxyToSource[jt.key][Fe.id]:[jt];if(!je)continue;const qe=je;Oe.viewport.set([0,0,bi.fb.width,bi.fb.height]),qr!==(Fe?Fe.id:null)&&(this._setupStencil(bi,je,Me,Fe),qr=Fe?Fe.id:null),Le.renderLayer(Le,Fe,Me,qe)}this.renderedToTile?(bi.dirty=!0,xt.push(je.tileID)):wi||--Pt,5===Pt&&(Pt=0,this.renderToBackBuffer(xt))}return this.renderToBackBuffer(xt),this.renderingToTexture=!1,Oe.bindFramebuffer.set(null),Oe.viewport.set([0,0,Le.width,Le.height]),qe.end+1}postRender(){}isLayerOrderingCorrect(F){const Me=F.order.length;let Le=-1,Oe=Me;for(let Fe=0;Fe<Me;++Fe)this._style.isLayerDraped(F._mergedLayers[F.order[Fe]])?Le=Math.max(Le,Fe):Oe=Math.min(Oe,Fe);return Oe>Le}getMinElevationBelowMSL(){let F=0;return this._visibleDemTiles.filter((F=>F.dem)).forEach((Me=>{F=Math.min(F,Me.dem.tree.minimums[0])})),0===F?F:(F-30)*this._exaggeration}raycast(F,Me,Le){if(!this._visibleDemTiles)return null;const Oe=this._visibleDemTiles.filter((F=>F.dem)).map((Oe=>{const Fe=Oe.tileID,je=1<<Fe.overscaledZ,{x:qe,y:He}=Fe.canonical,xt=qe/je,Pt=(qe+1)/je,jt=He/je,Gt=(He+1)/je;return{minx:xt,miny:jt,maxx:Pt,maxy:Gt,t:Oe.dem.tree.raycastRoot(xt,jt,Pt,Gt,F,Me,Le),tile:Oe}}));Oe.sort(((F,Me)=>(null!==F.t?F.t:Number.MAX_VALUE)-(null!==Me.t?Me.t:Number.MAX_VALUE)));for(const Fe of Oe){if(null==Fe.t)return null;const Oe=Fe.tile.dem.tree.raycast(Fe.minx,Fe.miny,Fe.maxx,Fe.maxy,F,Me,Le);if(null!=Oe)return Oe}return null}_createFBO(){const Me=this.painter.context,Le=Me.gl,Oe=this.drapeBufferSize;Me.activeTexture.set(Le.TEXTURE0);const Fe=new F.T(Me,{width:Oe[0],height:Oe[1],data:null},Le.RGBA8);Fe.bind(Le.LINEAR,Le.CLAMP_TO_EDGE);const je=Me.createFramebuffer(Oe[0],Oe[1],!0,null);return je.colorAttachment.set(Fe.texture),je.depthAttachment=new As(Me,je.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=Me.createRenderbuffer(Me.gl.DEPTH_STENCIL,Oe[0],Oe[1]),this._stencilRef=0,je.depthAttachment.set(this._sharedDepthStencil),Me.clear({stencil:0})):je.depthAttachment.set(this._sharedDepthStencil),Me.extTextureFilterAnisotropic&&Le.texParameterf(Le.TEXTURE_2D,Me.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Me.extTextureFilterAnisotropicMax),{fb:je,tex:Fe,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache)return!0;if(this._style.hasLightTransitions())return!0;for(const F in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[F].hasTransition())return!0;return this._style.order.some((F=>{const Me=this._style._mergedLayers[F],Le=Me.isHidden(this.painter.transform.zoom);return"hillshade"===Me.type||"custom"===Me.type?!Le&&Me.shouldRedrape():!Le&&Me.hasTransition()}))}_clearLineLayersFromRenderCache(){let Me=!1;for(const F of this._style.getSources())if(F instanceof tt){Me=!0;break}if(!Me)return;const Le={};for(let Me=0;Me<this._style.order.length;++Me){const Oe=this._style._mergedLayers[this._style.order[Me]],Fe=this._style.getLayerSourceCache(Oe);if(Fe&&!Le[Fe.id]&&!Oe.isHidden(this.painter.transform.zoom)&&"line"===Oe.type&&Oe.widthExpression()instanceof F.ab){Le[Fe.id]=!0;for(const F of this.proxyCoords){const Me=this.proxyToSource[F.key][Fe.id];if(Me)for(const F of Me)this._clearRenderCacheForTile(Fe.id,F)}}}}_clearRasterLayersFromRenderCache(){let F=!1;for(const Me in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[Me]._source instanceof it){F=!0;break}if(!F)return;const Me={};for(let F=0;F<this._style.order.length;++F){const Le=this._style._mergedLayers[this._style.order[F]],Oe=this._style.getLayerSourceCache(Le);if(!Oe||Me[Oe.id])continue;if(Le.isHidden(this.painter.transform.zoom)||"raster"!==Le.type)continue;const Fe=Le.paint.get("raster-fade-duration");for(const F of this.proxyCoords){const Me=this.proxyToSource[F.key][Oe.id];if(Me)for(const F of Me){const Me=Ns(Oe.getTile(F),Oe.findLoadedParent(F,0),Oe,this.painter.transform,Fe);(1!==Me.opacity||0!==Me.mix)&&this._clearRenderCacheForTile(Oe.id,F)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const Me=this._style.order,Le=Me.length;if(0===Le)return;const Oe=[];this._pendingGroundEffectLayers=[];let Fe,je=0,qe=this._style._mergedLayers[Me[je]];for(;!this._style.isLayerDraped(qe)&&qe.isHidden(this.painter.transform.zoom)&&++je<Le;)qe=this._style._mergedLayers[Me[je]];for(;je<Le;++je){const F=this._style._mergedLayers[Me[je]];F.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(F)?void 0===Fe&&(Fe=je):("fill-extrusion"===F.type&&this._pendingGroundEffectLayers.push(je),void 0!==Fe&&(Oe.push({start:Fe,end:je-1}),Fe=void 0)))}if(void 0!==Fe&&Oe.push({start:Fe,end:je-1}),0!==Oe.length){const Me=Oe[Oe.length-1];this._pendingGroundEffectLayers.every((F=>F>Me.end))||F.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=Oe}_setupRenderCache(F){const Me=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,Me.renderCache.length>Me.renderCachePool.length){const F=Object.values(Me.proxyCachedFBO);Me.proxyCachedFBO={};for(let Le=0;Le<F.length;++Le){const Oe=Object.values(F[Le]);Me.renderCachePool.push(...Oe)}}return}this._clearRasterLayersFromRenderCache();const Le=this.proxyCoords,Oe=this._tilesDirty;for(let Fe=Le.length-1;Fe>=0;Fe--){const je=Le[Fe];if(Me.getTileByID(je.key),void 0!==Me.proxyCachedFBO[je.key]){const Le=F[je.key],Fe=this.proxyToSource[je.key];let qe=0;for(const F in Fe){const Me=Fe[F],je=Le[F];if(!je||je.length!==Me.length||Me.some(((Me,Le)=>Me!==je[Le]||Oe[F]&&Oe[F].hasOwnProperty(Me.key)))){qe=-1;break}++qe}for(const F in Me.proxyCachedFBO[je.key])Me.renderCache[Me.proxyCachedFBO[je.key][F]].dirty=qe<0||qe!==Object.values(Le).length}}const Fe=[...this._drapedRenderBatches];Fe.sort(((F,Me)=>Me.end-Me.start-(F.end-F.start)));for(const F of Fe)for(const Oe of Le){if(Me.proxyCachedFBO[Oe.key])continue;let Le=Me.renderCachePool.pop();void 0===Le&&Me.renderCache.length<50&&(Le=Me.renderCache.length,Me.renderCache.push(this._createFBO())),void 0!==Le&&(Me.proxyCachedFBO[Oe.key]={},Me.proxyCachedFBO[Oe.key][F.start]=Le,Me.renderCache[Le].dirty=!0)}this._tilesDirty={}}_setupStencil(F,Me,Le,Oe){if(!Oe||!this._sourceTilesOverlap[Oe.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const Fe=this.painter.context,je=Fe.gl;if(Me.length<=1)return void(this._overlapStencilType=!1);let qe;if(Le.isTileClipped())qe=Me.length,this._overlapStencilMode.test={func:je.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(Me[0].overscaledZ>Me[Me.length-1].overscaledZ))return void(this._overlapStencilType=!1);qe=1,this._overlapStencilMode.test={func:je.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+qe>255&&(Fe.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=qe,this._overlapStencilMode.ref=this._stencilRef,Le.isTileClipped()&&this._renderTileClippingMasks(Me,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(F){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[F.key]),this._overlapStencilMode):Ui.disabled}_renderTileClippingMasks(F,Me){const Le=this.painter,Oe=this.painter.context,Fe=Oe.gl;Le._tileClippingMaskIDs={},Oe.setColorMode(ki.disabled),Oe.setDepthMode(Bi.disabled);const je=Le.getOrCreateProgram("clippingMask");for(const Oe of F){const F=Le._tileClippingMaskIDs[Oe.key]=--Me;je.draw(Le,Fe.TRIANGLES,Bi.disabled,new Ui({func:Fe.ALWAYS,mask:0},F,255,Fe.KEEP,Fe.KEEP,Fe.REPLACE),ki.disabled,ji.disabled,Bs(Oe.projMatrix),"$clipping",Le.tileExtentBuffer,Le.quadTriangleIndexBuffer,Le.tileExtentSegments)}}pointCoordinate(Me){const Le=this.painter.transform;if(Me.x<0||Me.x>Le.width||Me.y<0||Me.y>Le.height)return null;const Oe=[Me.x,Me.y,1,1];F.ad.vec4.transformMat4(Oe,Oe,Le.pixelMatrixInverse),F.ad.vec4.scale(Oe,Oe,1/Oe[3]),Oe[0]/=Le.worldSize,Oe[1]/=Le.worldSize;const Fe=Le._camera.position,je=F.bH(1,Le.center.lat),qe=[Fe[0],Fe[1],Fe[2]/je,0],He=F.ad.vec3.subtract([],Oe.slice(0,3),qe);F.ad.vec3.normalize(He,He);const xt=this.raycast(qe,He,this._exaggeration);return null!==xt&&xt?(F.ad.vec3.scaleAndAdd(qe,qe,He,xt),qe[3]=qe[2],qe[2]*=je,qe):null}_setupProxiedCoordsForOrtho(Me,Le,Oe){if(Me.getSource()instanceof F.aK)return this._setupProxiedCoordsForImageSource(Me,Le,Oe);this._findCoveringTileCache[Me.id]=this._findCoveringTileCache[Me.id]||{};const Fe=this.proxiedCoords[Me.id]=[],je=this.proxyCoords;for(let F=0;F<je.length;F++){const Le=je[F],qe=this._findTileCoveringTileID(Le,Me);if(qe){const F=this._createProxiedId(Le,qe,Oe[Le.key]&&Oe[Le.key][Me.id]);Fe.push(F),this.proxyToSource[Le.key][Me.id]=[F]}}let qe=!1;const He=new Set;for(let F=0;F<Le.length;F++){const je=Me.getTile(Le[F]);if(!je||!je.hasData())continue;const xt=this._findTileCoveringTileID(je.tileID,this.proxySourceCache);if(xt&&xt.tileID.canonical.z!==je.tileID.canonical.z){const F=this.proxyToSource[xt.tileID.key][Me.id],Le=this._createProxiedId(xt.tileID,je,Oe[xt.tileID.key]&&Oe[xt.tileID.key][Me.id]);F?F.splice(F.length-1,0,Le):this.proxyToSource[xt.tileID.key][Me.id]=[Le];const Pt=this.proxyToSource[xt.tileID.key][Me.id];He.has(Pt)||He.add(Pt),Fe.push(Le),qe=!0}}if(this._sourceTilesOverlap[Me.id]=qe,qe&&this._debugParams.sortTilesHiZFirst)for(const F of He)F.sort(((F,Me)=>Me.overscaledZ-F.overscaledZ))}_setupProxiedCoordsForImageSource(Me,Le,Oe){if(!Me.getSource().loaded())return;const Fe=this.proxiedCoords[Me.id]=[],je=this.proxyCoords,qe=Me.getSource(),He=qe.tileID;if(!He)return;const xt=new F.P(He.x,He.y)._div(1<<He.z),Pt=qe.coordinates.map(F.ac.fromLngLat).reduce(((F,Me)=>(F.min.x=Math.min(F.min.x,Me.x-xt.x),F.min.y=Math.min(F.min.y,Me.y-xt.y),F.max.x=Math.max(F.max.x,Me.x-xt.x),F.max.y=Math.max(F.max.y,Me.y-xt.y),F)),{min:new F.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new F.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),h=(Me,Le)=>{const Oe=Me.wrap+Me.canonical.x/(1<<Me.canonical.z),Fe=Me.canonical.y/(1<<Me.canonical.z),je=F.ai/(1<<Me.canonical.z),qe=Le.wrap+Le.canonical.x/(1<<Le.canonical.z),He=Le.canonical.y/(1<<Le.canonical.z);return Oe+je<qe+Pt.min.x||Oe>qe+Pt.max.x||Fe+je<He+Pt.min.y||Fe>He+Pt.max.y};for(let F=0;F<je.length;F++){const qe=je[F];for(let F=0;F<Le.length;F++){const je=Me.getTile(Le[F]);if(!je||!je.hasData())continue;if(h(qe,je.tileID))continue;const He=this._createProxiedId(qe,je,Oe[qe.key]&&Oe[qe.key][Me.id]),xt=this.proxyToSource[qe.key][Me.id];xt?xt.push(He):this.proxyToSource[qe.key][Me.id]=[He],Fe.push(He)}}}_createProxiedId(Me,Le,Oe){let Fe=this.orthoMatrix;if(Oe){const F=Oe.find((F=>F.key===Le.tileID.key));if(F)return F}if(Le.tileID.key!==Me.key){const Oe=Me.canonical.z-Le.tileID.canonical.z;let je,qe,He;Fe=F.ad.mat4.create();const xt=Le.tileID.wrap-Me.wrap<<Me.overscaledZ;Oe>0?(je=F.ai>>Oe,qe=je*((Le.tileID.canonical.x<<Oe)-Me.canonical.x+xt),He=je*((Le.tileID.canonical.y<<Oe)-Me.canonical.y)):(je=F.ai<<-Oe,qe=F.ai*(Le.tileID.canonical.x-(Me.canonical.x+xt<<-Oe)),He=F.ai*(Le.tileID.canonical.y-(Me.canonical.y<<-Oe))),F.ad.mat4.ortho(Fe,0,je,0,je,0,1),F.ad.mat4.translate(Fe,Fe,[qe,He,0])}return new Gs(Le.tileID,Me.key,Fe)}_findTileCoveringTileID(Me,Le){let Oe=Le.getTile(Me);if(Oe&&Oe.hasData())return Oe;const Fe=this._findCoveringTileCache[Le.id],je=Fe[Me.key];if(Oe=je?Le.getTileByID(je):null,Oe&&Oe.hasData()||null===je)return Oe;let qe=Oe?Oe.tileID:Me,He=qe.overscaledZ;const xt=Le.getSource().minzoom,Pt=[];if(!je){const Fe=Le.getSource().maxzoom;if(Me.canonical.z>=Fe){const Oe=Me.canonical.z-Fe;Le.getSource().reparseOverscaled?(He=Math.max(Me.canonical.z+2,Le.transform.tileZoom),qe=new F.aH(He,Me.wrap,Fe,Me.canonical.x>>Oe,Me.canonical.y>>Oe)):0!==Oe&&(He=Fe,qe=new F.aH(He,Me.wrap,Fe,Me.canonical.x>>Oe,Me.canonical.y>>Oe))}qe.key!==Me.key&&(Pt.push(qe.key),Oe=Le.getTile(qe))}const h=F=>{Pt.forEach((Me=>{Fe[Me]=F})),Pt.length=0};for(He-=1;He>=xt&&(!Oe||!Oe.hasData());He--){Oe&&h(Oe.tileID.key);const F=qe.calculateScaledKey(He);if(Oe=Le.getTileByID(F),Oe&&Oe.hasData())break;const Me=Fe[F];if(null===Me)break;void 0===Me?Pt.push(F):Oe=Le.getTileByID(Me)}return h(Oe?Oe.tileID.key:null),Oe&&Oe.hasData()?Oe:null}findDEMTileFor(F){return this.enabled?this._findTileCoveringTileID(F,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(F,Me){let Le=this._tilesDirty[F];Le||(Le=this._tilesDirty[F]={}),Le[Me.key]=!0}}function qs(Me,Le,Oe){const Fe=function(Me,Le,Oe){const Fe=F.ad.vec3.dot(Le,Me),je=F.ad.vec3.dot(Oe,[.2126,.7152,.0722]),n=(F,Me,Le)=>(1-Le)*F+Le*Me,qe=n(1-.3*Math.min(je,1),1,Math.min(Fe+1,1));return n(.92,1,Math.asin(F.ay(Le[2],-1,1))/Math.PI+.5)*qe}(Me,[0,0,1],Le),je=[0,0,0];F.ad.vec3.scale(je,Oe.slice(0,3),Fe);const qe=[0,0,0];F.ad.vec3.scale(qe,Le.slice(0,3),Me[2]);const He=[0,0,0];return F.ad.vec3.add(He,je,qe),F.cg(He)}const ep=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],ip=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Ws{static cacheKey(F,Me,Le,Oe){let Fe=`${Me}${Oe?Oe.cacheKey:""}`;for(const Me of Le)F.usedDefines.includes(Me)&&(Fe+=`/${Me}`);return Fe}constructor(Me,Le,Oe,Fe,je,qe){const He=Me.gl;this.program=He.createProgram(),this.configuration=Fe,this.name=Le,this.fixedDefines=[...qe];const xt=Fe?Fe.getBinderAttributes():[],Pt=(Oe.staticAttributes||[]).concat(xt);let jt=Fe?Fe.defines():[];jt=jt.concat(qe.map((F=>`#define ${F}`)));const Gt="#version 300 es\n";let bi=Gt+jt.concat("precision mediump float;",Bd,vd.fragmentSource).join("\n");for(const F of Oe.fragmentIncludes)bi+=`\n${_d[F]}`;bi+=`\n${Oe.fragmentSource}`;let wi=Gt+jt.concat("precision highp float;",Bd,vd.vertexSource).join("\n");for(const F of Oe.vertexIncludes)wi+=`\n${_d[F]}`;this.forceManualRenderingForInstanceIDShaders=Me.forceManualRenderingForInstanceIDShaders&&-1!==Oe.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(wi+="\nuniform int u_instanceID;\n"),wi+=`\n${Oe.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(wi=wi.replaceAll("gl_InstanceID","u_instanceID"));const qr=He.createShader(He.FRAGMENT_SHADER);if(He.isContextLost())return void(this.failedToCreate=!0);He.shaderSource(qr,bi),He.compileShader(qr),He.attachShader(this.program,qr);const Xn=He.createShader(He.VERTEX_SHADER);if(He.isContextLost())this.failedToCreate=!0;else{He.shaderSource(Xn,wi),He.compileShader(Xn),He.attachShader(this.program,Xn),this.attributes={},this.numAttributes=Pt.length;for(let F=0;F<this.numAttributes;F++)if(Pt[F]){const Me=Pt[F].startsWith("a_")?Pt[F]:`a_${Pt[F]}`;He.bindAttribLocation(this.program,F,Me),this.attributes[Me]=F}He.linkProgram(this.program),He.deleteShader(Xn),He.deleteShader(qr),this.fixedUniforms=je(Me),this.binderUniforms=Fe?Fe.getUniforms(Me):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(Me=>({u_instanceID:new F.bN(Me)}))(Me)),(qe.includes("TERRAIN")||-1!==Le.indexOf("symbol")||-1!==Le.indexOf("circle"))&&(this.terrainUniforms=(Me=>({u_dem:new F.bN(Me),u_dem_prev:new F.bN(Me),u_dem_tl:new F.bK(Me),u_dem_scale:new F.bM(Me),u_dem_tl_prev:new F.bK(Me),u_dem_scale_prev:new F.bM(Me),u_dem_size:new F.bM(Me),u_dem_lerp:new F.bM(Me),u_exaggeration:new F.bM(Me),u_depth:new F.bN(Me),u_depth_size_inv:new F.bK(Me),u_depth_range_unpack:new F.bK(Me),u_occluder_half_size:new F.bM(Me),u_occlusion_depth_offset:new F.bM(Me),u_meter_to_dem:new F.bM(Me),u_label_plane_matrix_inv:new F.bJ(Me)}))(Me)),qe.includes("GLOBE")&&(this.globeUniforms=(Me=>({u_tile_tl_up:new F.bL(Me),u_tile_tr_up:new F.bL(Me),u_tile_br_up:new F.bL(Me),u_tile_bl_up:new F.bL(Me),u_tile_up_scale:new F.bM(Me)}))(Me)),qe.includes("FOG")&&(this.fogUniforms=(Me=>({u_fog_matrix:new F.bJ(Me),u_fog_range:new F.bK(Me),u_fog_color:new F.cb(Me),u_fog_horizon_blend:new F.bM(Me),u_fog_vertical_limit:new F.bK(Me),u_fog_temporal_offset:new F.bM(Me),u_frustum_tl:new F.bL(Me),u_frustum_tr:new F.bL(Me),u_frustum_br:new F.bL(Me),u_frustum_bl:new F.bL(Me),u_globe_pos:new F.bL(Me),u_globe_radius:new F.bM(Me),u_globe_transition:new F.bM(Me),u_is_globe:new F.bN(Me),u_viewport:new F.bK(Me)}))(Me)),qe.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(Me=>({u_cutoff_params:new F.cb(Me)}))(Me)),qe.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(Me=>({u_lighting_ambient_color:new F.bL(Me),u_lighting_directional_dir:new F.bL(Me),u_lighting_directional_color:new F.bL(Me),u_ground_radiance:new F.bL(Me)}))(Me)),qe.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(Me=>({u_light_matrix_0:new F.bJ(Me),u_light_matrix_1:new F.bJ(Me),u_fade_range:new F.bK(Me),u_shadow_normal_offset:new F.bL(Me),u_shadow_intensity:new F.bM(Me),u_shadow_texel_size:new F.bM(Me),u_shadow_map_resolution:new F.bM(Me),u_shadow_direction:new F.bL(Me),u_shadow_bias:new F.bL(Me),u_shadowmap_0:new F.bN(Me),u_shadowmap_1:new F.bN(Me)}))(Me))}}setTerrainUniformValues(F,Me){if(!this.terrainUniforms)return;const Le=this.terrainUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Me)Le[F]&&Le[F].set(this.program,F,Me[F])}}setGlobeUniformValues(F,Me){if(!this.globeUniforms)return;const Le=this.globeUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Me)Le[F]&&Le[F].set(this.program,F,Me[F])}}setFogUniformValues(F,Me){if(!this.fogUniforms)return;const Le=this.fogUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Me)Le[F].set(this.program,F,Me[F])}}setCutoffUniformValues(F,Me){if(!this.cutoffUniforms)return;const Le=this.cutoffUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Me)Le[F].set(this.program,F,Me[F])}}setLightsUniformValues(F,Me){if(!this.lightsUniforms)return;const Le=this.lightsUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Me)Le[F].set(this.program,F,Me[F])}}setShadowUniformValues(F,Me){if(this.failedToCreate||!this.shadowUniforms)return;const Le=this.shadowUniforms;F.program.set(this.program);for(const F in Me)Le[F].set(this.program,F,Me[F])}_drawDebugWireframe(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt){const Gt=Me.options.wireframe;if(!1===Gt.terrain&&!1===Gt.layers2D&&!1===Gt.layers3D)return;const bi=Me.context;if(!(()=>!(!Gt.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!Gt.layers2D||Me._terrain&&Me._terrain.renderingToTexture||!ep.includes(this.name))||!(!Gt.layers3D||!ip.includes(this.name)))())return;const wi=bi.gl,qr=Me.wireframeDebugCache.getLinesFromTrianglesBuffer(Me.frameCounter,je,bi);if(!qr)return;const Xn=[...this.fixedDefines];Xn.push("DEBUG_WIREFRAME");const Yn=Me.getOrCreateProgram(this.name,{config:this.configuration,defines:Xn});bi.program.set(Yn.program);const g=(F,Me,Le)=>{if(Me[F]&&Le[F])for(const Oe in Me[F])Le[F][Oe]&&Le[F][Oe].set(Le.program,Oe,Me[F][Oe].current)};Pt&&Pt.setUniforms(Yn.program,bi,Yn.binderUniforms,He,{zoom:xt}),g("fixedUniforms",this,Yn),g("terrainUniforms",this,Yn),g("globeUniforms",this,Yn),g("fogUniforms",this,Yn),g("lightsUniforms",this,Yn),g("shadowUniforms",this,Yn),qr.bind(),bi.setColorMode(new ki([wi.ONE,wi.ONE_MINUS_SRC_ALPHA,wi.ZERO,wi.ONE],F.al.transparent,[!0,!0,!0,!1])),bi.setDepthMode(new Bi(Le.func===wi.LESS?wi.LEQUAL:Le.func,Bi.ReadOnly,Le.range)),bi.setStencilMode(Ui.disabled);const yo=3*qe.primitiveLength*2,bo=3*qe.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const F=jt||1;for(let Me=0;Me<F;++Me)Yn.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Me),wi.drawElements(wi.LINES,yo,wi.UNSIGNED_SHORT,bo)}else jt&&jt>1?wi.drawElementsInstanced(wi.LINES,yo,wi.UNSIGNED_SHORT,bo,jt):wi.drawElements(wi.LINES,yo,wi.UNSIGNED_SHORT,bo);je.bind(),bi.program.set(this.program),bi.setDepthMode(Le),bi.setStencilMode(Oe),bi.setColorMode(Fe)}checkUniforms(F,Me,Le){if(this.fixedDefines.includes(Me))for(const Oe of Object.keys(Le))if(!Le[Oe].initialized)throw new Error(`Program '${this.name}', from draw '${F}': uniform ${Oe} not set but required by ${Me} being defined`)}draw(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn){const Yn=F.context,yo=Yn.gl;if(this.failedToCreate)return;Yn.program.set(this.program),Yn.setDepthMode(Le),Yn.setStencilMode(Oe),Yn.setColorMode(Fe),Yn.setCullFace(je);for(const F of Object.keys(this.fixedUniforms))this.fixedUniforms[F].set(this.program,F,qe[F]);wi&&wi.setUniforms(this.program,Yn,this.binderUniforms,Gt,{zoom:bi});const bo={[yo.POINTS]:1,[yo.LINES]:2,[yo.TRIANGLES]:3,[yo.LINE_STRIP]:1}[Me];this.checkUniforms(He,"RENDER_SHADOWS",this.shadowUniforms);const Ro=Xn&&Xn>0?1:void 0;for(const je of jt.get()){const qe=je.vaos||(je.vaos={});if((qe[He]||(qe[He]=new jo)).bind(Yn,this,xt,wi?wi.getPaintVertexBuffers():[],Pt,je.vertexOffset,qr||[],Ro),this.forceManualRenderingForInstanceIDShaders){const F=Xn||1;for(let Le=0;Le<F;++Le)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Le),Pt?yo.drawElements(Me,je.primitiveLength*bo,yo.UNSIGNED_SHORT,je.primitiveOffset*bo*2):yo.drawArrays(Me,je.vertexOffset,je.vertexLength)}else Xn&&Xn>1?yo.drawElementsInstanced(Me,je.primitiveLength*bo,yo.UNSIGNED_SHORT,je.primitiveOffset*bo*2,Xn):Pt?yo.drawElements(Me,je.primitiveLength*bo,yo.UNSIGNED_SHORT,je.primitiveOffset*bo*2):yo.drawArrays(Me,je.vertexOffset,je.vertexLength);Me===yo.TRIANGLES&&Pt&&this._drawDebugWireframe(F,Le,Oe,Fe,Pt,je,Gt,bi,wi,Xn)}}}function $s(Me,Le){const Oe=Math.pow(2,Le.tileID.overscaledZ),Fe=Le.tileSize*Math.pow(2,Me.transform.tileZoom)/Oe,je=Fe*(Le.tileID.canonical.x+Le.tileID.wrap*Oe),qe=Fe*Le.tileID.canonical.y;return{u_image:0,u_texsize:Le.imageAtlasTexture?Le.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/F.at(Le,1,Me.transform.tileZoom),u_pixel_coord_upper:[je>>16,qe>>16],u_pixel_coord_lower:[65535&je,65535&qe]}}const rp={terrain:0,flat:1},np=F.ad.mat4.create(),Ys=(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo)=>{const Ro=Le.style.light,Do=Ro.properties.get("position"),zs=[Do.x,Do.y,Do.z],Zs=F.ad.mat3.create();"viewport"===Ro.properties.get("anchor")&&(F.ad.mat3.fromRotation(Zs,-Le.transform.angle),F.ad.vec3.transformMat3(zs,zs,Zs));const na=Ro.properties.get("color"),el=Le.transform,nl={u_matrix:Me,u_lightpos:zs,u_lightintensity:Ro.properties.get("intensity"),u_lightcolor:[na.r,na.g,na.b],u_vertical_gradient:+Oe,u_opacity:Fe,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:np,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:rp[jt],u_base_type:rp[Gt],u_ao:je,u_edge_radius:qe,u_width_scale:He,u_flood_light_color:Xn,u_vertical_scale:Yn,u_flood_light_intensity:yo,u_ground_shadow_factor:bo};return"globe"===el.projection.name&&(nl.u_tile_id=[xt.canonical.x,xt.canonical.y,1<<xt.canonical.z],nl.u_zoom_transition=bi,nl.u_inv_rot_matrix=qr,nl.u_merc_center=wi,nl.u_up_dir=el.projection.upVector(new F.bT(0,0,0),wi[0]*F.ai,wi[1]*F.ai),nl.u_height_lift=Pt),nl},Js=(F,Me,Le,Oe,Fe,je)=>({u_matrix:F,u_edge_radius:Me,u_width_scale:Le,u_vertical_scale:Oe,u_height_type:rp[Fe],u_base_type:rp[je]}),Qs=(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo)=>{const bo=Ys(Me,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,1,[0,0,0]),Ro={u_height_factor:-Math.pow(2,xt.overscaledZ)/Pt.tileSize/8};return F.l(bo,$s(Le,Pt),Ro)},er=(F,Me)=>({u_matrix:F,u_emissive_strength:Me}),tr=(Me,Le,Oe,Fe)=>F.l(er(Me,Le),$s(Oe,Fe)),ir=(F,Me,Le)=>({u_matrix:F,u_world:Le,u_emissive_strength:Me}),or=(Me,Le,Oe,Fe,je)=>F.l(tr(Me,Le,Oe,Fe),{u_world:je}),sr=(F,Me,Le,Oe,Fe)=>({u_matrix:F,u_camera_pos:[Me[0],Me[1],Me[2]],u_depth_bias:Le,u_height_scale:Oe,u_reset_depth:Fe}),rr=(Me,Le,Oe,Fe)=>{const je=F.ai/Oe.tileSize;return{u_matrix:Me,u_camera_to_center_distance:Le.getCameraToCenterDistance(Fe),u_extrude_scale:[Le.pixelsToGLUnits[0]/je,Le.pixelsToGLUnits[1]/je]}},nr=(F,Me,Le=1)=>({u_matrix:F,u_color:Me.toRenderColor(null),u_overlay:0,u_overlay_scale:Le}),op=F.ad.mat4.create(),lr=(Me,Le,Oe,Fe,je,qe,He)=>{const xt=Me.transform,Pt="globe"===xt.projection.name,jt=Pt?F.cO(xt.zoom,Le.canonical)*xt._pixelsPerMercatorPixel:F.at(Oe,1,qe),Gt={u_matrix:Le.projMatrix,u_extrude_scale:jt,u_intensity:He,u_inv_rot_matrix:op,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(Pt){Gt.u_inv_rot_matrix=Fe,Gt.u_merc_center=je,Gt.u_tile_id=[Le.canonical.x,Le.canonical.y,1<<Le.canonical.z],Gt.u_zoom_transition=F.ag(xt.zoom);const Me=je[0]*F.ai,Oe=je[1]*F.ai;Gt.u_up_dir=xt.projection.upVector(new F.bT(0,0,0),Me,Oe)}return Gt};function cr(F,[Me,Le,Oe,Fe],[je,qe]){if(je===qe)return[0,0,0,0];const He=255*(F-1)/(F*(qe-je));return[Me*He,Le*He,Oe*He,Fe*He]}function hr(F,Me,[Le,Oe]){return Le===Oe?0:.5/F+(Me-Le)*(F-1)/(F*(Oe-Le))}const dr=(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do,zs)=>({u_matrix:Me,u_normalize_matrix:Le,u_globe_matrix:Oe,u_merc_matrix:Fe,u_grid_matrix:je,u_tl_parent:qe,u_scale_parent:jt,u_fade_t:Gt.mix,u_opacity:Gt.opacity*bi.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:bi.paint.get("raster-brightness-min"),u_brightness_high:bi.paint.get("raster-brightness-max"),u_saturation_factor:F.cP(bi.paint.get("raster-saturation")),u_contrast_factor:F.cQ(bi.paint.get("raster-contrast")),u_spin_weights:ur(bi.paint.get("raster-hue-rotate")),u_perspective_transform:wi,u_raster_elevation:qr,u_zoom_transition:He,u_merc_center:xt,u_cutoff_params:Pt,u_colorization_mix:cr(F.cR,Yn,bo),u_colorization_offset:hr(F.cR,yo,bo),u_color_ramp:Xn,u_texture_offset:[Do/(Ro+2*Do),Ro/(Ro+2*Do)],u_texture_res:[Ro+2*Do,Ro+2*Do],u_emissive_strength:zs});function ur(F){F*=Math.PI/180;const Me=Math.sin(F),Le=Math.cos(F);return[(2*Le+1)/3,(-Math.sqrt(3)*Me-Le+1)/3,(Math.sqrt(3)*Me-Le+1)/3]}const sp=.05,pr=(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt)=>({u_matrix:F,u_normalize_matrix:Me,u_globe_matrix:Le,u_merc_matrix:Oe,u_grid_matrix:Fe,u_tl_parent:je,u_scale_parent:Pt,u_fade_t:jt.mix,u_opacity:jt.opacity,u_image0:0,u_image1:1,u_raster_elevation:Gt,u_zoom_transition:qe,u_merc_center:He,u_cutoff_params:xt}),fr=(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt)=>({u_particle_texture:F,u_particle_texture_side_len:Me,u_tile_offset:Le,u_velocity:Oe,u_color_ramp:je,u_velocity_res:Fe,u_max_speed:qe,u_uv_offset:He,u_data_scale:[255*xt[0],255*xt[1]],u_data_offset:Pt,u_particle_pos_scale:1.1,u_particle_pos_offset:[sp,sp]}),mr=(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt)=>({u_particle_texture:F,u_particle_texture_side_len:Me,u_velocity:Le,u_velocity_res:Oe,u_max_speed:Fe,u_speed_factor:je,u_reset_rate:qe,u_rand_seed:Math.random(),u_uv_offset:He,u_data_scale:[255*xt[0],255*xt[1]],u_data_offset:Pt,u_particle_pos_scale:1.1,u_particle_pos_offset:[sp,sp]}),ap=F.ad.mat4.create(),vr=(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro,Do,zs,Zs)=>{const na=je.transform,el={u_is_size_zoom_constant:+("constant"===Me||"source"===Me),u_is_size_feature_constant:+("constant"===Me||"camera"===Me),u_size_t:Le?Le.uSizeT:0,u_size:Le?Le.uSize:0,u_camera_to_center_distance:na.getCameraToCenterDistance(Ro),u_rotate_symbol:+Oe,u_aspect_ratio:na.width/na.height,u_fade_change:je.options.fadeDuration?je.symbolFadeChange:1,u_matrix:qe,u_label_plane_matrix:He,u_coord_matrix:xt,u_is_text:+jt,u_elevation_from_sea:Pt?1:0,u_pitch_with_map:+Fe,u_texsize:Gt,u_texsize_icon:bi,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:ap,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:ap,u_up_vector:[0,-1,0],u_color_adj_mat:Do,u_icon_transition:zs||0,u_gamma_scale:Fe?je.transform.getCameraToCenterDistance(Ro)*Math.cos(je.terrain?0:je.transform._pitch):1,u_device_pixel_ratio:F.q.devicePixelRatio,u_is_halo:+wi,u_scale_factor:Zs||1};return"globe"===Ro.name&&(el.u_tile_id=[qr.canonical.x,qr.canonical.y,1<<qr.canonical.z],el.u_zoom_transition=Xn,el.u_inv_rot_matrix=yo,el.u_merc_center=Yn,el.u_camera_forward=na._camera.forward(),el.u_ecef_origin=F.cS(na.globeMatrix,qr.toUnwrapped()),el.u_tile_matrix=Float32Array.from(na.globeMatrix),el.u_up_vector=bo),el},yr=(F,Me,Le,Oe)=>({u_matrix:F,u_emissive_strength:Me,u_opacity:Le,u_color:Oe}),xr=(Me,Le,Oe,Fe,je,qe,He,xt,Pt)=>F.l(function(Me,Le,Oe,Fe,je,qe){const{width:He,height:xt}=Fe.imageManager.getPixelSize(Le),Pt=Math.pow(2,qe.tileID.overscaledZ),jt=qe.tileSize*Math.pow(2,Fe.transform.tileZoom)/Pt,Gt=jt*(qe.tileID.canonical.x+qe.tileID.wrap*Pt),bi=jt*qe.tileID.canonical.y;return{u_image:0,u_pattern_tl:Oe.tl,u_pattern_br:Oe.br,u_texsize:[He,xt],u_pattern_size:Oe.displaySize,u_pattern_units_to_pixels:je?[Fe.transform.width,-1*Fe.transform.height]:[1/F.at(qe,1,Fe.transform.tileZoom),1/F.at(qe,1,Fe.transform.tileZoom)],u_pixel_coord_upper:[Gt>>16,bi>>16],u_pixel_coord_lower:[65535&Gt,65535&bi]}}(0,qe,He,Fe,xt,Pt),{u_matrix:Me,u_emissive_strength:Le,u_opacity:Oe}),yp=new Float32Array(F.ad.mat4.identity([])),wr=(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr=[0,0,0],Xn)=>{const Yn=je.style.light,yo=Yn.properties.get("position"),bo=[-yo.x,-yo.y,yo.z],Ro=F.ad.mat3.create();"viewport"===Yn.properties.get("anchor")&&(F.ad.mat3.fromRotation(Ro,-je.transform.angle),F.ad.vec3.transformMat3(bo,bo,Ro));const Do="MASK"===Gt.alphaMode,zs=Yn.properties.get("color").toRenderColor(null),Zs=wi.paint.get("model-ambient-occlusion-intensity"),na=wi.paint.get("model-color").constantOr(F.al.white).toRenderColor(null),el=wi.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:Me,u_lighting_matrix:Le,u_normal_matrix:Oe,u_node_matrix:Fe||yp,u_lightpos:bo,u_lightintensity:Yn.properties.get("intensity"),u_lightcolor:[zs.r,zs.g,zs.b],u_camera_pos:qr,u_opacity:qe,u_baseTextureIsAlpha:0,u_alphaMask:+Do,u_alphaCutoff:Gt.alphaCutoff,u_baseColorFactor:[He.r,He.g,He.b,He.a],u_emissiveFactor:[xt[0],xt[1],xt[2],1],u_metallicFactor:Pt,u_roughnessFactor:jt,u_baseColorTexture:Bh.BaseColor,u_metallicRoughnessTexture:Bh.MetallicRoughness,u_normalTexture:Bh.Normal,u_occlusionTexture:Bh.Occlusion,u_emissionTexture:Bh.Emission,u_lutTexture:Bh.LUT,u_color_mix:[na.r,na.g,na.b,el],u_aoIntensity:Zs,u_emissive_strength:bi,u_occlusionTextureTransform:Xn||[0,0,0,0]}},Tr=(F,Me=yp,Le=yp)=>({u_matrix:F,u_instance:Me,u_node_matrix:Le}),Tp={fillExtrusion:Me=>({u_matrix:new F.bJ(Me),u_lightpos:new F.bL(Me),u_lightintensity:new F.bM(Me),u_lightcolor:new F.bL(Me),u_vertical_gradient:new F.bM(Me),u_opacity:new F.bM(Me),u_edge_radius:new F.bM(Me),u_width_scale:new F.bM(Me),u_ao:new F.bK(Me),u_height_type:new F.bN(Me),u_base_type:new F.bN(Me),u_tile_id:new F.bL(Me),u_zoom_transition:new F.bM(Me),u_inv_rot_matrix:new F.bJ(Me),u_merc_center:new F.bK(Me),u_up_dir:new F.bL(Me),u_height_lift:new F.bM(Me),u_flood_light_color:new F.bL(Me),u_vertical_scale:new F.bM(Me),u_flood_light_intensity:new F.bM(Me),u_ground_shadow_factor:new F.bL(Me)}),fillExtrusionDepth:Me=>({u_matrix:new F.bJ(Me),u_edge_radius:new F.bM(Me),u_width_scale:new F.bM(Me),u_vertical_scale:new F.bM(Me),u_height_type:new F.bN(Me),u_base_type:new F.bN(Me)}),fillExtrusionPattern:Me=>({u_matrix:new F.bJ(Me),u_lightpos:new F.bL(Me),u_lightintensity:new F.bM(Me),u_lightcolor:new F.bL(Me),u_vertical_gradient:new F.bM(Me),u_height_factor:new F.bM(Me),u_edge_radius:new F.bM(Me),u_width_scale:new F.bM(Me),u_ao:new F.bK(Me),u_height_type:new F.bN(Me),u_base_type:new F.bN(Me),u_tile_id:new F.bL(Me),u_zoom_transition:new F.bM(Me),u_inv_rot_matrix:new F.bJ(Me),u_merc_center:new F.bK(Me),u_up_dir:new F.bL(Me),u_height_lift:new F.bM(Me),u_image:new F.bN(Me),u_texsize:new F.bK(Me),u_pixel_coord_upper:new F.bK(Me),u_pixel_coord_lower:new F.bK(Me),u_tile_units_to_pixels:new F.bM(Me),u_opacity:new F.bM(Me)}),fillExtrusionGroundEffect:Me=>({u_matrix:new F.bJ(Me),u_opacity:new F.bM(Me),u_ao_pass:new F.bM(Me),u_meter_to_tile:new F.bM(Me),u_ao:new F.bK(Me),u_flood_light_intensity:new F.bM(Me),u_flood_light_color:new F.bL(Me),u_attenuation:new F.bM(Me),u_edge_radius:new F.bM(Me),u_fb:new F.bN(Me),u_fb_size:new F.bM(Me),u_dynamic_offset:new F.bM(Me)}),fill:Me=>({u_matrix:new F.bJ(Me),u_emissive_strength:new F.bM(Me)}),fillPattern:Me=>({u_matrix:new F.bJ(Me),u_emissive_strength:new F.bM(Me),u_image:new F.bN(Me),u_texsize:new F.bK(Me),u_pixel_coord_upper:new F.bK(Me),u_pixel_coord_lower:new F.bK(Me),u_tile_units_to_pixels:new F.bM(Me)}),fillOutline:Me=>({u_matrix:new F.bJ(Me),u_emissive_strength:new F.bM(Me),u_world:new F.bK(Me)}),fillOutlinePattern:Me=>({u_matrix:new F.bJ(Me),u_emissive_strength:new F.bM(Me),u_world:new F.bK(Me),u_image:new F.bN(Me),u_texsize:new F.bK(Me),u_pixel_coord_upper:new F.bK(Me),u_pixel_coord_lower:new F.bK(Me),u_tile_units_to_pixels:new F.bM(Me)}),elevatedStructures:Me=>({u_matrix:new F.bJ(Me)}),elevatedStructuresDepthReconstruct:Me=>({u_matrix:new F.bJ(Me),u_camera_pos:new F.bL(Me),u_depth_bias:new F.bM(Me),u_height_scale:new F.bM(Me),u_reset_depth:new F.bM(Me)}),circle:F.cT,collisionBox:Me=>({u_matrix:new F.bJ(Me),u_camera_to_center_distance:new F.bM(Me),u_extrude_scale:new F.bK(Me)}),collisionCircle:Me=>({u_matrix:new F.bJ(Me),u_inv_matrix:new F.bJ(Me),u_camera_to_center_distance:new F.bM(Me),u_viewport_size:new F.bK(Me)}),debug:Me=>({u_color:new F.cA(Me),u_matrix:new F.bJ(Me),u_overlay:new F.bN(Me),u_overlay_scale:new F.bM(Me)}),clippingMask:Me=>({u_matrix:new F.bJ(Me)}),heatmap:Me=>({u_extrude_scale:new F.bM(Me),u_intensity:new F.bM(Me),u_matrix:new F.bJ(Me),u_inv_rot_matrix:new F.bJ(Me),u_merc_center:new F.bK(Me),u_tile_id:new F.bL(Me),u_zoom_transition:new F.bM(Me),u_up_dir:new F.bL(Me)}),heatmapTexture:Me=>({u_image:new F.bN(Me),u_color_ramp:new F.bN(Me),u_opacity:new F.bM(Me)}),hillshade:Me=>({u_matrix:new F.bJ(Me),u_image:new F.bN(Me),u_latrange:new F.bK(Me),u_light:new F.bK(Me),u_shadow:new F.cA(Me),u_highlight:new F.cA(Me),u_emissive_strength:new F.bM(Me),u_accent:new F.cA(Me)}),hillshadePrepare:Me=>({u_matrix:new F.bJ(Me),u_image:new F.bN(Me),u_dimension:new F.bK(Me),u_zoom:new F.bM(Me)}),line:F.cU,linePattern:F.cV,raster:Me=>({u_matrix:new F.bJ(Me),u_normalize_matrix:new F.bJ(Me),u_globe_matrix:new F.bJ(Me),u_merc_matrix:new F.bJ(Me),u_grid_matrix:new F.cB(Me),u_tl_parent:new F.bK(Me),u_scale_parent:new F.bM(Me),u_fade_t:new F.bM(Me),u_opacity:new F.bM(Me),u_image0:new F.bN(Me),u_image1:new F.bN(Me),u_brightness_low:new F.bM(Me),u_brightness_high:new F.bM(Me),u_saturation_factor:new F.bM(Me),u_contrast_factor:new F.bM(Me),u_spin_weights:new F.bL(Me),u_perspective_transform:new F.bK(Me),u_raster_elevation:new F.bM(Me),u_zoom_transition:new F.bM(Me),u_merc_center:new F.bK(Me),u_cutoff_params:new F.cb(Me),u_colorization_mix:new F.cb(Me),u_colorization_offset:new F.bM(Me),u_color_ramp:new F.bN(Me),u_texture_offset:new F.bK(Me),u_texture_res:new F.bK(Me),u_emissive_strength:new F.bM(Me)}),rasterParticle:Me=>({u_matrix:new F.bJ(Me),u_normalize_matrix:new F.bJ(Me),u_globe_matrix:new F.bJ(Me),u_merc_matrix:new F.bJ(Me),u_grid_matrix:new F.cB(Me),u_tl_parent:new F.bK(Me),u_scale_parent:new F.bM(Me),u_fade_t:new F.bM(Me),u_opacity:new F.bM(Me),u_image0:new F.bN(Me),u_image1:new F.bN(Me),u_raster_elevation:new F.bM(Me),u_zoom_transition:new F.bM(Me),u_merc_center:new F.bK(Me),u_cutoff_params:new F.cb(Me)}),rasterParticleTexture:Me=>({u_texture:new F.bN(Me),u_opacity:new F.bM(Me)}),rasterParticleDraw:Me=>({u_particle_texture:new F.bN(Me),u_particle_texture_side_len:new F.bM(Me),u_tile_offset:new F.bK(Me),u_velocity:new F.bN(Me),u_color_ramp:new F.bN(Me),u_velocity_res:new F.bK(Me),u_max_speed:new F.bM(Me),u_uv_offset:new F.bK(Me),u_data_scale:new F.bK(Me),u_data_offset:new F.bM(Me),u_particle_pos_scale:new F.bM(Me),u_particle_pos_offset:new F.bK(Me)}),rasterParticleUpdate:Me=>({u_particle_texture:new F.bN(Me),u_particle_texture_side_len:new F.bM(Me),u_velocity:new F.bN(Me),u_velocity_res:new F.bK(Me),u_max_speed:new F.bM(Me),u_speed_factor:new F.bM(Me),u_reset_rate:new F.bM(Me),u_rand_seed:new F.bM(Me),u_uv_offset:new F.bK(Me),u_data_scale:new F.bK(Me),u_data_offset:new F.bM(Me),u_particle_pos_scale:new F.bM(Me),u_particle_pos_offset:new F.bK(Me)}),symbol:Me=>({u_is_size_zoom_constant:new F.bN(Me),u_is_size_feature_constant:new F.bN(Me),u_size_t:new F.bM(Me),u_size:new F.bM(Me),u_camera_to_center_distance:new F.bM(Me),u_rotate_symbol:new F.bN(Me),u_aspect_ratio:new F.bM(Me),u_fade_change:new F.bM(Me),u_matrix:new F.bJ(Me),u_label_plane_matrix:new F.bJ(Me),u_coord_matrix:new F.bJ(Me),u_is_text:new F.bN(Me),u_elevation_from_sea:new F.bN(Me),u_pitch_with_map:new F.bN(Me),u_texsize:new F.bK(Me),u_texsize_icon:new F.bK(Me),u_texture:new F.bN(Me),u_texture_icon:new F.bN(Me),u_gamma_scale:new F.bM(Me),u_device_pixel_ratio:new F.bM(Me),u_tile_id:new F.bL(Me),u_zoom_transition:new F.bM(Me),u_inv_rot_matrix:new F.bJ(Me),u_merc_center:new F.bK(Me),u_camera_forward:new F.bL(Me),u_tile_matrix:new F.bJ(Me),u_up_vector:new F.bL(Me),u_ecef_origin:new F.bL(Me),u_is_halo:new F.bN(Me),u_icon_transition:new F.bM(Me),u_color_adj_mat:new F.bJ(Me),u_scale_factor:new F.bM(Me)}),background:Me=>({u_matrix:new F.bJ(Me),u_emissive_strength:new F.bM(Me),u_opacity:new F.bM(Me),u_color:new F.cA(Me)}),backgroundPattern:Me=>({u_matrix:new F.bJ(Me),u_emissive_strength:new F.bM(Me),u_opacity:new F.bM(Me),u_image:new F.bN(Me),u_pattern_tl:new F.bK(Me),u_pattern_br:new F.bK(Me),u_texsize:new F.bK(Me),u_pattern_size:new F.bK(Me),u_pixel_coord_upper:new F.bK(Me),u_pixel_coord_lower:new F.bK(Me),u_pattern_units_to_pixels:new F.bK(Me)}),terrainRaster:Me=>({u_matrix:new F.bJ(Me),u_image0:new F.bN(Me),u_skirt_height:new F.bM(Me),u_ground_shadow_factor:new F.bL(Me)}),skybox:Me=>({u_matrix:new F.bJ(Me),u_sun_direction:new F.bL(Me),u_cubemap:new F.bN(Me),u_opacity:new F.bM(Me),u_temporal_offset:new F.bM(Me)}),skyboxGradient:Me=>({u_matrix:new F.bJ(Me),u_color_ramp:new F.bN(Me),u_center_direction:new F.bL(Me),u_radius:new F.bM(Me),u_opacity:new F.bM(Me),u_temporal_offset:new F.bM(Me)}),skyboxCapture:Me=>({u_matrix_3f:new F.cB(Me),u_sun_direction:new F.bL(Me),u_sun_intensity:new F.bM(Me),u_color_tint_r:new F.cb(Me),u_color_tint_m:new F.cb(Me),u_luminance:new F.bM(Me)}),globeRaster:Me=>({u_proj_matrix:new F.bJ(Me),u_globe_matrix:new F.bJ(Me),u_normalize_matrix:new F.bJ(Me),u_merc_matrix:new F.bJ(Me),u_zoom_transition:new F.bM(Me),u_merc_center:new F.bK(Me),u_image0:new F.bN(Me),u_grid_matrix:new F.cB(Me),u_skirt_height:new F.bM(Me),u_far_z_cutoff:new F.bM(Me),u_frustum_tl:new F.bL(Me),u_frustum_tr:new F.bL(Me),u_frustum_br:new F.bL(Me),u_frustum_bl:new F.bL(Me),u_globe_pos:new F.bL(Me),u_globe_radius:new F.bM(Me),u_viewport:new F.bK(Me)}),globeAtmosphere:Me=>({u_frustum_tl:new F.bL(Me),u_frustum_tr:new F.bL(Me),u_frustum_br:new F.bL(Me),u_frustum_bl:new F.bL(Me),u_horizon:new F.bM(Me),u_transition:new F.bM(Me),u_fadeout_range:new F.bM(Me),u_color:new F.cb(Me),u_high_color:new F.cb(Me),u_space_color:new F.cb(Me),u_temporal_offset:new F.bM(Me),u_horizon_angle:new F.bM(Me)}),model:Me=>({u_matrix:new F.bJ(Me),u_lighting_matrix:new F.bJ(Me),u_normal_matrix:new F.bJ(Me),u_node_matrix:new F.bJ(Me),u_lightpos:new F.bL(Me),u_lightintensity:new F.bM(Me),u_lightcolor:new F.bL(Me),u_camera_pos:new F.bL(Me),u_opacity:new F.bM(Me),u_baseColorFactor:new F.cb(Me),u_emissiveFactor:new F.cb(Me),u_metallicFactor:new F.bM(Me),u_roughnessFactor:new F.bM(Me),u_baseTextureIsAlpha:new F.bN(Me),u_alphaMask:new F.bN(Me),u_alphaCutoff:new F.bM(Me),u_baseColorTexture:new F.bN(Me),u_metallicRoughnessTexture:new F.bN(Me),u_normalTexture:new F.bN(Me),u_occlusionTexture:new F.bN(Me),u_emissionTexture:new F.bN(Me),u_lutTexture:new F.bN(Me),u_color_mix:new F.cb(Me),u_aoIntensity:new F.bM(Me),u_emissive_strength:new F.bM(Me),u_occlusionTextureTransform:new F.cb(Me)}),modelDepth:Me=>({u_matrix:new F.bJ(Me),u_instance:new F.bJ(Me),u_node_matrix:new F.bJ(Me)}),groundShadow:Me=>({u_matrix:new F.bJ(Me),u_ground_shadow_factor:new F.bL(Me)}),stars:Me=>({u_matrix:new F.bJ(Me),u_up:new F.bL(Me),u_right:new F.bL(Me),u_intensity_multiplier:new F.bM(Me)}),snowParticle:Me=>({u_modelview:new F.bJ(Me),u_projection:new F.bJ(Me),u_time:new F.bM(Me),u_cam_pos:new F.bL(Me),u_velocityConeAperture:new F.bM(Me),u_velocity:new F.bM(Me),u_horizontalOscillationRadius:new F.bM(Me),u_horizontalOscillationRate:new F.bM(Me),u_boxSize:new F.bM(Me),u_billboardSize:new F.bM(Me),u_simpleShapeParameters:new F.bK(Me),u_screenSize:new F.bK(Me),u_thinningCenterPos:new F.bK(Me),u_thinningShape:new F.bL(Me),u_thinningAffectedRatio:new F.bM(Me),u_thinningParticleOffset:new F.bM(Me),u_particleColor:new F.cb(Me),u_direction:new F.bL(Me)}),rainParticle:Me=>({u_modelview:new F.bJ(Me),u_projection:new F.bJ(Me),u_time:new F.bM(Me),u_cam_pos:new F.bL(Me),u_texScreen:new F.bN(Me),u_velocityConeAperture:new F.bM(Me),u_velocity:new F.bM(Me),u_boxSize:new F.bM(Me),u_rainDropletSize:new F.bK(Me),u_distortionStrength:new F.bM(Me),u_rainDirection:new F.bL(Me),u_color:new F.cb(Me),u_screenSize:new F.bK(Me),u_thinningCenterPos:new F.bK(Me),u_thinningShape:new F.bL(Me),u_thinningAffectedRatio:new F.bM(Me),u_thinningParticleOffset:new F.bM(Me),u_shapeDirectionalPower:new F.bM(Me),u_shapeNormalPower:new F.bM(Me),u_mode:new F.bM(Me)}),vignette:Me=>({u_vignetteShape:new F.bL(Me),u_vignetteColor:new F.cb(Me)}),occlusion:Me=>({u_matrix:new F.bJ(Me),u_anchorPos:new F.bL(Me),u_screenSizePx:new F.bK(Me),u_occluderSizePx:new F.bK(Me),u_color:new F.cb(Me)})};class Sr{constructor(F,Me,Le,Oe){this.id=Sr.uniqueIdxCounter,Sr.uniqueIdxCounter++,this.context=F;const Fe=F.gl;this.buffer=Fe.createBuffer(),this.dynamicDraw=Boolean(Le),this.context.unbindVAO(),F.bindElementBuffer.set(this.buffer),Fe.bufferData(Fe.ELEMENT_ARRAY_BUFFER,Me.arrayBuffer,this.dynamicDraw?Fe.DYNAMIC_DRAW:Fe.STATIC_DRAW),this.dynamicDraw||Oe||Me.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(F){this.id=Sr.uniqueIdxCounter,Sr.uniqueIdxCounter++;const Me=this.context.gl;this.context.unbindVAO(),this.bind(),Me.bufferSubData(Me.ELEMENT_ARRAY_BUFFER,0,F.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Sr.uniqueIdxCounter=0;const Rp={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Ir{constructor(F,Me,Le,Oe,Fe,je){this.length=Me.length,this.attributes=Le,this.itemSize=Me.bytesPerElement,this.dynamicDraw=Oe,this.instanceCount=je,this.context=F;const qe=F.gl;this.buffer=qe.createBuffer(),F.bindVertexBuffer.set(this.buffer),qe.bufferData(qe.ARRAY_BUFFER,Me.arrayBuffer,this.dynamicDraw?qe.DYNAMIC_DRAW:qe.STATIC_DRAW),this.dynamicDraw||Fe||Me.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(F){const Me=this.context.gl;this.bind(),Me.bufferSubData(Me.ARRAY_BUFFER,0,F.arrayBuffer)}enableAttributes(F,Me){for(let Le=0;Le<this.attributes.length;Le++){const Oe=Me.attributes[this.attributes[Le].name];void 0!==Oe&&F.enableVertexAttribArray(Oe)}}setVertexAttribPointers(F,Me,Le){for(let Oe=0;Oe<this.attributes.length;Oe++){const Fe=this.attributes[Oe],je=Me.attributes[Fe.name];void 0!==je&&F.vertexAttribPointer(je,Fe.components,F[Rp[Fe.type]],!1,this.itemSize,Fe.offset+this.itemSize*(Le||0))}}setVertexAttribDivisor(F,Me,Le){for(let Oe=0;Oe<this.attributes.length;Oe++){const Fe=Me.attributes[this.attributes[Oe].name];void 0!==Fe&&this.instanceCount&&this.instanceCount>0&&F.vertexAttribDivisor(Fe,Le)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Rr{constructor(F,Me,Le,Oe,Fe){this.context=F,this.width=Me,this.height=Le;const je=this.framebuffer=F.gl.createFramebuffer();Oe&&(this.colorAttachment=new Is(F,je)),Fe&&(this.depthAttachmentType=Fe,this.depthAttachment="renderbuffer"===Fe?new Rs(F,je):new Ds(F,je))}destroy(){const F=this.context.gl;if(this.colorAttachment){const Me=this.colorAttachment.get();Me&&F.deleteTexture(Me)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const Me=this.depthAttachment.get();Me&&F.deleteRenderbuffer(Me)}else{const Me=this.depthAttachment.get();Me&&F.deleteTexture(Me)}F.deleteFramebuffer(this.framebuffer)}}class Dr{constructor(F,Me){this.gl=F,this.clearColor=new Xo(this),this.clearDepth=new Ko(this),this.clearStencil=new Yo(this),this.colorMask=new Jo(this),this.depthMask=new Qo(this),this.stencilMask=new es(this),this.stencilFunc=new ts(this),this.stencilOp=new is(this),this.stencilTest=new os(this),this.depthRange=new ss(this),this.depthTest=new rs(this),this.depthFunc=new ns(this),this.blend=new as(this),this.blendFunc=new ls(this),this.blendColor=new cs(this),this.blendEquation=new hs(this),this.cullFace=new ds(this),this.cullFaceSide=new us(this),this.frontFace=new _s(this),this.program=new qd(this),this.activeTexture=new fs(this),this.viewport=new ms(this),this.bindFramebuffer=new gs(this),this.bindRenderbuffer=new vs(this),this.bindTexture=new ys(this),this.bindVertexBuffer=new xs(this),this.bindElementBuffer=new bs(this),this.bindVertexArrayOES=new ws(this),this.pixelStoreUnpack=new Ts(this),this.pixelStoreUnpackPremultiplyAlpha=new Es(this),this.pixelStoreUnpackFlipY=new Ss(this),this.options=Me?Object.assign({},Me):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=F.getExtension("EXT_texture_filter_anisotropic")||F.getExtension("MOZ_EXT_texture_filter_anisotropic")||F.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=F.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=F.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=F.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=F.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=Me&&!!Me.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=F.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=F.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=F.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=F.getParameter(F.MAX_TEXTURE_SIZE),this.maxPointSize=F.getParameter(F.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(F,Me,Le){return new Sr(this,F,Me,Le)}createVertexBuffer(F,Me,Le,Oe,Fe){return new Ir(this,F,Me,Le,Oe,Fe)}createRenderbuffer(F,Me,Le){const Oe=this.gl,Fe=Oe.createRenderbuffer();return this.bindRenderbuffer.set(Fe),Oe.renderbufferStorage(Oe.RENDERBUFFER,F,Me,Le),this.bindRenderbuffer.set(null),Fe}createFramebuffer(F,Me,Le,Oe){return new Rr(this,F,Me,Le,Oe)}clear({color:F,depth:Me,stencil:Le,colorMask:Oe}){const Fe=this.gl;let je=0;F&&(je|=Fe.COLOR_BUFFER_BIT,this.clearColor.set(F),this.colorMask.set(Oe||[!0,!0,!0,!0])),void 0!==Me&&(je|=Fe.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(Me),this.depthMask.set(!0)),void 0!==Le&&(je|=Fe.STENCIL_BUFFER_BIT,this.clearStencil.set(Le),this.stencilMask.set(255)),Fe.clear(je)}setCullFace(F){!1===F.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(F.mode),this.frontFace.set(F.frontFace))}setDepthMode(F){F.func!==this.gl.ALWAYS||F.mask?(this.depthTest.set(!0),this.depthFunc.set(F.func),this.depthMask.set(F.mask),this.depthRange.set(F.range)):this.depthTest.set(!1)}setStencilMode(F){F.test.func!==this.gl.ALWAYS||F.mask?(this.stencilTest.set(!0),this.stencilMask.set(F.mask),this.stencilOp.set([F.fail,F.depthFail,F.pass]),this.stencilFunc.set({func:F.test.func,ref:F.ref,mask:F.test.mask})):this.stencilTest.set(!1)}setColorMode(Me){F.bn(Me.blendFunction,ki.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(Me.blendFunction),this.blendColor.set(Me.blendColor),Me.blendEquation?this.blendEquation.set(Me.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(Me.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Dp;function Lr(Me,Le,Oe,Fe,je,qe,He){const xt=Me.context,Pt=xt.gl,jt=Me.transform,Gt=Me.getOrCreateProgram("collisionBox"),bi=[];let wi=0,qr=0;for(let xt=0;xt<Fe.length;xt++){const Xn=Fe[xt],Yn=Le.getTile(Xn),yo=Yn.getBucket(Oe);if(!yo)continue;const bo=li(Xn,yo,jt);let Ro=bo;0===je[0]&&0===je[1]||(Ro=Me.translatePosMatrix(bo,Yn,je,qe));const Do=He?yo.textCollisionBox:yo.iconCollisionBox,zs=yo.collisionCircleArray;if(zs.length>0){const Me=F.ad.mat4.create(),Le=Ro;F.ad.mat4.mul(Me,yo.placementInvProjMatrix,jt.glCoordMatrix),F.ad.mat4.mul(Me,Me,yo.placementViewportMatrix),bi.push({circleArray:zs,circleOffset:qr,transform:Le,invTransform:Me,projection:yo.getProjection()}),wi+=zs.length/4,qr=wi}Do&&(Me.terrain&&Me.terrain.setupElevationDraw(Yn,Gt),Gt.draw(Me,Pt.LINES,Bi.disabled,Ui.disabled,Me.colorModeForRenderPass(),ji.disabled,rr(Ro,jt,Yn,yo.getProjection()),Oe.id,Do.layoutVertexBuffer,Do.indexBuffer,Do.segments,null,jt.zoom,null,[Do.collisionVertexBuffer,Do.collisionVertexBufferExt]))}if(!He||!bi.length)return;const Xn=Me.getOrCreateProgram("collisionCircle"),Yn=new F.cW;Yn.resize(4*wi),Yn._trim();let yo=0;for(const F of bi)for(let Me=0;Me<F.circleArray.length/4;Me++){const Le=4*Me,Oe=F.circleArray[Le+0],Fe=F.circleArray[Le+1],je=F.circleArray[Le+2],qe=F.circleArray[Le+3];Yn.emplace(yo++,Oe,Fe,je,qe,0),Yn.emplace(yo++,Oe,Fe,je,qe,1),Yn.emplace(yo++,Oe,Fe,je,qe,2),Yn.emplace(yo++,Oe,Fe,je,qe,3)}(!Dp||Dp.length<2*wi)&&(Dp=function(Me){const Le=2*Me,Oe=new F.aV;Oe.resize(Le),Oe._trim();for(let F=0;F<Le;F++){const Me=6*F;Oe.uint16[Me+0]=4*F+0,Oe.uint16[Me+1]=4*F+1,Oe.uint16[Me+2]=4*F+2,Oe.uint16[Me+3]=4*F+2,Oe.uint16[Me+4]=4*F+3,Oe.uint16[Me+5]=4*F+0}return Oe}(wi));const bo=xt.createIndexBuffer(Dp,!0),Ro=xt.createVertexBuffer(Yn,F.cX.members,!0);for(const Le of bi){const Fe={u_matrix:Le.transform,u_inv_matrix:Le.invTransform,u_camera_to_center_distance:(Do=jt).getCameraToCenterDistance(Le.projection),u_viewport_size:[Do.width,Do.height]};Xn.draw(Me,Pt.TRIANGLES,Bi.disabled,Ui.disabled,Me.colorModeForRenderPass(),ji.disabled,Fe,Oe.id,Ro,bo,F.b8.simpleSegment(0,2*Le.circleOffset,Le.circleArray.length,Le.circleArray.length/2),null,jt.zoom)}var Do;Ro.destroy(),bo.destroy()}const Lp=F.ad.mat4.create();function Mr(Me){const Le=Me._camera.getWorldToCamera(Me.worldSize,1),Oe=F.ad.mat4.multiply([],Le,Me.globeMatrix);F.ad.mat4.invert(Oe,Oe);const Fe=[0,0,0],je=[0,1,0,0];return F.ad.vec4.transformMat4(je,je,Oe),Fe[0]=je[0],Fe[1]=je[1],Fe[2]=je[2],F.ad.vec3.normalize(Fe,Fe),Fe}function zr({width:Me,height:Le,anchor:Oe,textOffset:Fe,textScale:je},qe){const{horizontalAlign:He,verticalAlign:xt}=F.bD(Oe),Pt=-(He-.5)*Me,jt=-(xt-.5)*Le,Gt=F.bC(Oe,Fe);return new F.P((Pt/je+Gt[0])*qe,(jt/je+Gt[1])*qe)}function Or(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt){const bi=Me.text.placedSymbolArray,wi=Me.text.dynamicLayoutVertexArray,qr=Me.icon.dynamicLayoutVertexArray,Xn={},Yn=Me.getProjection(),yo=ci(xt,Yn,qe),bo=qe.elevation,Ro=Yn.upVectorScale(xt.canonical,qe.center.lat,qe.worldSize).metersToTile;wi.clear();for(let qr=0;qr<bi.length;qr++){const Do=bi.get(qr),{tileAnchorX:zs,tileAnchorY:Zs,numGlyphs:na}=Do,el=Do.hidden||!Do.crossTileID||Me.allowVerticalPlacement&&!Do.placedOrientation?null:Fe[Do.crossTileID];if(el){let Fe=0,bi=0,qr=0;if(bo){const F=bo?bo.getAtTileOffset(xt,zs,Zs):0,[Me,Le,Oe]=Yn.upVector(xt.canonical,zs,Zs);Fe=F*Me*Ro,bi=F*Le*Ro,qr=F*Oe*Ro}let[nl,hl,pl,bl]=Wt(Do.projectedAnchorX+Fe,Do.projectedAnchorY+bi,Do.projectedAnchorZ+qr,Oe?yo:He);const Tl=$t(qe.getCameraToCenterDistance(Yn),bl);let kl=je.evaluateSizeForFeature(Me.textSizeData,jt,Do)*Tl/F.bw;Oe&&(kl*=Me.tilePixelRatio/Pt);const ec=zr(el,kl);Oe?(({x:nl,y:hl,z:pl}=Yn.projectTilePoint(zs+ec.x,Zs+ec.y,xt.canonical)),[nl,hl,pl]=Wt(nl+Fe,hl+bi,pl+qr,He)):(Le&&ec._rotate(-qe.angle),nl+=ec.x,hl+=ec.y,pl=0);const tc=Me.allowVerticalPlacement&&Do.placedOrientation===F.bq.vertical?Math.PI/2:0;for(let Me=0;Me<na;Me++)F.bt(wi,nl,hl,pl,tc);Gt&&Do.associatedIconIndex>=0&&(Xn[Do.associatedIconIndex]={x:nl,y:hl,z:pl,angle:tc})}else oi(na,wi)}if(Gt){qr.clear();const Le=Me.icon.placedSymbolArray;for(let Me=0;Me<Le.length;Me++){const Oe=Le.get(Me),{numGlyphs:Fe}=Oe,je=Xn[Me];if(Oe.hidden||!je)oi(Fe,qr);else{const{x:Me,y:Le,z:Oe,angle:qe}=je;for(let je=0;je<Fe;je++)F.bt(qr,Me,Le,Oe,qe)}}Me.icon.dynamicLayoutVertexBuffer.updateData(qr)}Me.text.dynamicLayoutVertexBuffer.updateData(wi)}function Fr(Me,Le,Oe,Fe,je,qe,He={}){const xt=Oe.paint.get("icon-translate"),Pt=Oe.paint.get("text-translate"),jt=Oe.paint.get("icon-translate-anchor"),Gt=Oe.paint.get("text-translate-anchor"),bi=Oe.layout.get("icon-rotation-alignment"),wi=Oe.layout.get("text-rotation-alignment"),qr=Oe.layout.get("icon-pitch-alignment"),Xn=Oe.layout.get("text-pitch-alignment"),Yn=Oe.layout.get("icon-keep-upright"),yo=Oe.layout.get("text-keep-upright"),bo=Oe.paint.get("icon-color-saturation"),Ro=Oe.paint.get("icon-color-contrast"),Do=Oe.paint.get("icon-color-brightness-min"),zs=Oe.paint.get("icon-color-brightness-max"),Zs="sea"===Oe.layout.get("symbol-elevation-reference"),na=Me.context,el=na.gl,nl=Me.transform,hl="map"===bi,pl="map"===wi,bl="map"===qr,Tl="map"===Xn,kl=void 0!==Oe.layout.get("symbol-sort-key").constantOr(1);let ec=!1;const tc=Me.depthModeForSublayer(0,Bi.ReadOnly),ic=[F.av(nl.center.lng),F.aC(nl.center.lat)],oc=Oe.layout.get("text-variable-anchor"),sc="globe"===nl.projection.name,ac=[],mc=[0,-1,0];for(const je of Fe){const Fe=Le.getTile(je),qe=Fe.getBucket(Oe);if(!qe)continue;if("mercator"===qe.projection.name&&sc)continue;if(qe.fullyClipped)continue;const bi="globe"===qe.projection.name,wi=bi?F.ag(nl.zoom):0,qr=ci(je,qe.getProjection(),nl),Xn=nl.calculatePixelsToTileUnitsMatrix(Fe),na=oc&&qe.hasTextData(),tc=qe.hasIconTextFit()&&na&&qe.hasIconData(),gc=qe.getProjection().createInversionMatrix(nl,je.canonical),N=F=>{nl.depthOcclusionForSymbolsAndCircles&&(Oe.hasInitialOcclusionOpacityProperties||Me.terrain)&&(F.push("DEPTH_D24"),F.push("DEPTH_OCCLUSION"))},U=()=>{const Le=hl&&"point"!==Oe.layout.get("symbol-placement"),He=[];N(He);const Pt=Le||tc,Gt=Oe.paint.get("icon-image-cross-fade").constantOr(0);Me.terrainRenderModeElevated()&&bl&&He.push("PITCH_WITH_MAP_TERRAIN"),bi&&(He.push("PROJECTION_GLOBE_VIEW"),Pt&&He.push("PROJECTED_POS_ON_VIEWPORT")),Gt>0&&He.push("ICON_TRANSITION"),qe.icon.zOffsetVertexBuffer&&He.push("Z_OFFSET"),0===bo&&0===Ro&&0===Do&&1===zs||He.push("COLOR_ADJUSTMENT"),qe.sdfIcons&&He.push("RENDER_SDF");const yo=qe.icon.programConfigurations.get(Oe.id),na=Me.getOrCreateProgram("symbol",{config:yo,defines:He}),pl=Fe.imageAtlasTexture?Fe.imageAtlasTexture.size:[0,0],Tl=qe.iconSizeData,kl=F.bp(Tl,nl.zoom),ec=bl||0!==nl.pitch,oc=qt(qr,Fe.tileID.canonical,bl,hl,nl,qe.getProjection(),Xn),ac=Zt(qr,Fe.tileID.canonical,bl,hl,nl,qe.getProjection(),Xn),yc=Me.translatePosMatrix(ac,Fe,xt,jt,!0),xc=Me.translatePosMatrix(qr,Fe,xt,jt),Zc=Pt?Lp:oc,Wc=hl&&!bl&&!Le;let Kc=mc;!sc&&!nl.mercatorFromTransition||hl||(Kc=Mr(nl));const Jc=bi?Kc:mc,Qc=Oe.getColorAdjustmentMatrix(bo,Ro,Do,zs),eh=vr(Tl.kind,kl,Wc,bl,Me,xc,Zc,yc,Zs,!1,pl,[0,0],!0,je,wi,ic,gc,Jc,qe.getProjection(),Qc,Gt),th=Fe.imageAtlasTexture?Fe.imageAtlasTexture:null,rh=1!==Oe.layout.get("icon-size").constantOr(0)||qe.iconsNeedLinear,oh=qe.sdfIcons||Me.options.rotating||Me.options.zooming||rh||ec?el.LINEAR:el.NEAREST,ah=qe.sdfIcons&&0!==Oe.paint.get("icon-halo-width").constantOr(1),lh=Me.terrain&&bl&&Le?F.ad.mat4.invert(F.ad.mat4.create(),oc):Lp;if(Le&&qe.icon){const F=nl.elevation,Le=F?F.getAtTileOffsetFunc(je,nl.center.lat,nl.worldSize,qe.getProjection()):null,Oe=Ht(qr,Fe.tileID.canonical,bl,hl,nl,qe.getProjection(),Xn);Kt(qe,qr,Me,!1,Oe,ac,bl,Yn,Le,je)}return{program:na,buffers:qe.icon,uniformValues:eh,atlasTexture:th,atlasTextureIcon:null,atlasInterpolation:oh,atlasInterpolationIcon:null,isSDF:qe.sdfIcons,hasHalo:ah,tile:Fe,labelPlaneMatrixInv:lh}},V=()=>{const Le=pl&&"point"!==Oe.layout.get("symbol-placement"),He=[],xt=Le||oc||tc;Me.terrainRenderModeElevated()&&Tl&&He.push("PITCH_WITH_MAP_TERRAIN"),bi&&(He.push("PROJECTION_GLOBE_VIEW"),xt&&He.push("PROJECTED_POS_ON_VIEWPORT")),qe.text.zOffsetVertexBuffer&&He.push("Z_OFFSET"),qe.iconsInText&&He.push("RENDER_TEXT_AND_SYMBOL"),He.push("RENDER_SDF"),N(He);const jt=qe.text.programConfigurations.get(Oe.id),Yn=Me.getOrCreateProgram("symbol",{config:jt,defines:He});let bo,Ro=[0,0],Do=null;const zs=qe.textSizeData;qe.iconsInText&&(Ro=Fe.imageAtlasTexture?Fe.imageAtlasTexture.size:[0,0],Do=Fe.imageAtlasTexture?Fe.imageAtlasTexture:null,bo=Tl||0!==nl.pitch||Me.options.rotating||Me.options.zooming||"composite"===zs.kind||"camera"===zs.kind?el.LINEAR:el.NEAREST);const na=Fe.glyphAtlasTexture?Fe.glyphAtlasTexture.size:[0,0],hl=Oe.layout.get("text-size-scale-range"),bl=F.ay(Me.scaleFactor,hl[0],hl[1]),kl=F.bp(zs,nl.zoom,bl),ec=qt(qr,Fe.tileID.canonical,Tl,pl,nl,qe.getProjection(),Xn),ac=Zt(qr,Fe.tileID.canonical,Tl,pl,nl,qe.getProjection(),Xn),yc=Me.translatePosMatrix(ac,Fe,Pt,Gt,!0),xc=Me.translatePosMatrix(qr,Fe,Pt,Gt),Zc=xt?Lp:ec,Wc=pl&&!Tl&&!Le;let Kc=mc;!sc&&!nl.mercatorFromTransition||pl||(Kc=Mr(nl));const Jc=vr(zs.kind,kl,Wc,Tl,Me,xc,Zc,yc,Zs,!0,na,Ro,!0,je,wi,ic,gc,bi?Kc:mc,qe.getProjection(),null,null,bl),Qc=Fe.glyphAtlasTexture?Fe.glyphAtlasTexture:null,eh=el.LINEAR,th=0!==Oe.paint.get("text-halo-width").constantOr(1),rh=Me.terrain&&Tl&&Le?F.ad.mat4.invert(F.ad.mat4.create(),ec):Lp;if(Le&&qe.text){const F=nl.elevation,Le=F?F.getAtTileOffsetFunc(je,nl.center.lat,nl.worldSize,qe.getProjection()):null,Oe=Ht(qr,Fe.tileID.canonical,Tl,pl,nl,qe.getProjection(),Xn);Kt(qe,qr,Me,!0,Oe,ac,Tl,yo,Le,je)}return{program:Yn,buffers:qe.text,uniformValues:Jc,atlasTexture:Qc,atlasTextureIcon:Do,atlasInterpolation:eh,atlasInterpolationIcon:bo,isSDF:!0,hasHalo:th,tile:Fe,labelPlaneMatrixInv:rh}},yc=qe.icon.segments.get().length,xc=qe.text.segments.get().length,Zc=yc&&!He.onlyText?U():null,Wc=xc&&!He.onlyIcons?V():null,Kc=Oe.paint.get("icon-opacity").constantOr(1),Jc=Oe.paint.get("text-opacity").constantOr(1);if(kl&&qe.canOverlap){ec=!0;const Me=Kc&&!He.onlyText?qe.icon.segments.get():[],Le=Jc&&!He.onlyIcons?qe.text.segments.get():[];for(const Le of Me)ac.push({segments:new F.b8([Le]),sortKey:Le.sortKey,state:Zc});for(const Me of Le)ac.push({segments:new F.b8([Me]),sortKey:Me.sortKey,state:Wc})}else He.onlyText||ac.push({segments:Kc?qe.icon.segments:new F.b8([]),sortKey:0,state:Zc}),He.onlyIcons||ac.push({segments:Jc?qe.text.segments:new F.b8([]),sortKey:0,state:Wc})}ec&&ac.sort(((F,Me)=>F.sortKey-Me.sortKey));for(const F of ac){const Le=F.state;if(Le)if(Me.terrain?Me.terrain.setupElevationDraw(Le.tile,Le.program,{useDepthForOcclusion:nl.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Le.labelPlaneMatrixInv}):Me.setupDepthForOcclusion(nl.depthOcclusionForSymbolsAndCircles,Le.program),na.activeTexture.set(el.TEXTURE0),Le.atlasTexture&&Le.atlasTexture.bind(Le.atlasInterpolation,el.CLAMP_TO_EDGE,!0),Le.atlasTextureIcon&&(na.activeTexture.set(el.TEXTURE1),Le.atlasTextureIcon&&Le.atlasTextureIcon.bind(Le.atlasInterpolationIcon,el.CLAMP_TO_EDGE,!0)),Me.uploadCommonLightUniforms(Me.context,Le.program),Le.hasHalo){const Fe=Le.uniformValues;Fe.u_is_halo=1,kr(Le.buffers,F.segments,Oe,Me,Le.program,tc,je,qe,Fe,2),Fe.u_is_halo=0}else{if(Le.isSDF){const Fe=Le.uniformValues;Le.hasHalo&&(Fe.u_is_halo=1,kr(Le.buffers,F.segments,Oe,Me,Le.program,tc,je,qe,Fe,1)),Fe.u_is_halo=0}kr(Le.buffers,F.segments,Oe,Me,Le.program,tc,je,qe,Le.uniformValues,1)}}}function kr(F,Me,Le,Oe,Fe,je,qe,He,xt,Pt){const jt=[F.dynamicLayoutVertexBuffer,F.opacityVertexBuffer,F.iconTransitioningVertexBuffer,F.globeExtVertexBuffer,F.zOffsetVertexBuffer];Fe.draw(Oe,Oe.context.gl.TRIANGLES,je,qe,He,ji.disabled,xt,Le.id,F.layoutVertexBuffer,F.indexBuffer,Me,Le.paint,Oe.transform.zoom,F.programConfigurations.get(Le.id),jt,Pt)}function Br(Me,Le){const Oe=1<<Me.canonical.z,Fe=(Le.x*Oe-Me.canonical.x-Me.wrap*Oe)*F.ai,je=(Le.y*Oe-Me.canonical.y)*F.ai,qe=F.d5(Le.z,Le.y);return F.ad.vec3.fromValues(Fe,je,qe)}function Nr(Me,Le,Oe,Fe,je){if(!Oe.layout||"none"===Oe.layout.get("fill-elevation-reference"))return;const qe=Me.context.gl,He=new Bi(Me.context.gl.LEQUAL,Bi.ReadWrite,Me.depthRangeFor3D),xt=new Bi(Me.context.gl.GREATER,Bi.ReadWrite,Me.depthRangeFor3D),Pt=function(Me){const Le=F.c4(Me.pitch);let Oe=.01;return Me.isOrthographic&&(Oe=F.ah(1e-4,Oe,F.c9(Le>=Vh?1:Le/Vh))),2*Oe}(Me.transform),jt=Me.transform.getFreeCameraOptions().position,Gt="elevatedStructuresDepthReconstruct",bi=Me.getOrCreateProgram(Gt,{defines:["DEPTH_RECONSTRUCTION"]}),wi=Me.getOrCreateProgram(Gt);for(const F of Fe){const Fe=Le.getTile(F),Gt=Fe.getBucket(Oe);if(!Gt)continue;const qr=Gt.elevatedStructures;if(!qr)continue;const Xn=Gt.elevationBufferData.heightRange,Yn=Br(F.toUnwrapped(),jt),yo=Me.translatePosMatrix(F.projMatrix,Fe,Oe.paint.get("fill-translate"),Oe.paint.get("fill-translate-anchor"));let bo,Ro,Do,zs;if("initialize"===je){if(!Xn||Xn.min>=1||0===qr.depthSegments.segments[0].primitiveLength)continue;bo=sr(yo,Yn,Pt,1,0),Ro=He,Do=qr.depthSegments,zs=bi}else if("reset"===je){if(!Xn||Xn.min>=0||0===qr.maskSegments.segments[0].primitiveLength)continue;bo=sr(yo,Yn,0,0,1),Ro=xt,Do=qr.maskSegments,zs=bi}else if("geometry"===je){if(0===qr.depthSegments.segments[0].primitiveLength)continue;bo=sr(yo,Yn,Pt,1,0),Ro=He,Do=qr.depthSegments,zs=wi}zs.draw(Me,qe.TRIANGLES,Ro,Ui.disabled,ki.disabled,ji.disabled,bo,Oe.id,qr.vertexBuffer,qr.indexBuffer,Do,Oe.paint,Me.transform.zoom)}}function Ur(Me,Le,Oe){const{painter:Fe,sourceCache:je,layer:qe,coords:He,colorMode:xt,elevationType:Pt,terrainEnabled:jt,pass:Gt}=Me,bi=Fe.context.gl,wi=qe.paint.get("fill-pattern");let qr=Pt;"road"!==Pt||Le&&!jt||(qr="none");const Xn="road"===qr,Yn=new Bi(Fe.context.gl.LEQUAL,Bi.ReadWrite,Fe.depthRangeFor3D),yo=wi&&wi.constantOr(1),v=(Me,Pt)=>{let jt,Gt,bo,Ro,Do;Pt?(Gt=yo&&!qe.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",jt=bi.LINES):(Gt=yo?"fillPattern":"fill",jt=bi.TRIANGLES);for(const zs of He){const He=je.getTile(zs);if(yo&&!He.patternsLoaded())continue;const Zs=He.getBucket(qe);if(!Zs)continue;const na=Le?Zs.elevationBufferData:Zs.bufferData;if(na.isEmpty())continue;Fe.prepareDrawTile();const el=na.programConfigurations.get(qe.id),nl=Fe.isTileAffectedByFog(zs),hl=[],pl=[];Xn&&(hl.push("ELEVATED_ROADS"),pl.push(na.elevatedLayoutVertexBuffer));const bl=Fe.getOrCreateProgram(Gt,{config:el,overrideFog:nl,defines:hl});yo&&(Fe.context.activeTexture.set(bi.TEXTURE0),He.imageAtlasTexture&&He.imageAtlasTexture.bind(bi.LINEAR,bi.CLAMP_TO_EDGE),el.updatePaintBuffers());const Tl=wi.constantOr(null);if(Tl&&He.imageAtlas){const Me=He.imageAtlas,Le=F.d0.from(Tl).getPrimary().scaleSelf(F.q.devicePixelRatio).toString(),Oe=Me.patternPositions.get(Le);Oe&&el.setConstantPatternPositions(Oe)}const kl=Fe.translatePosMatrix(zs.projMatrix,He,qe.paint.get("fill-translate"),qe.paint.get("fill-translate-anchor")),ec=qe.paint.get("fill-emissive-strength");if(Pt){Ro=na.lineIndexBuffer,Do=na.lineSegments;const F=Fe.terrain&&Fe.terrain.renderingToTexture?Fe.terrain.drapeBufferSize:[bi.drawingBufferWidth,bi.drawingBufferHeight];bo="fillOutlinePattern"===Gt&&yo?or(kl,ec,Fe,He,F):ir(kl,ec,F)}else Ro=na.indexBuffer,Do=na.triangleSegments,bo=yo?tr(kl,ec,Fe,He):er(kl,ec);Fe.uploadCommonUniforms(Fe.context,bl,zs.toUnwrapped()),bl.draw(Fe,jt,"none"!==qr?Yn:Me,Oe||Fe.stencilModeForClipping(zs),xt,ji.disabled,bo,qe.id,na.layoutVertexBuffer,Ro,Do,qe.paint,Fe.transform.zoom,el,pl)}};Fe.renderPass===Gt&&v(Fe.depthModeForSublayer(1,"opaque"===Fe.renderPass?Bi.ReadWrite:Bi.ReadOnly),!1),"none"===qr&&"translucent"===Fe.renderPass&&qe.paint.get("fill-antialias")&&v(Fe.depthModeForSublayer(qe.getPaintProperty("fill-outline-color")?2:0,Bi.ReadOnly),!0)}function Vr(Me,Le,Oe,Fe,je,qe,He,xt){Oe.resetLayerRenderingStats(Me);const Pt=Me.context,jt=Pt.gl,Gt=Me.transform,bi=Oe.paint.get("fill-extrusion-pattern"),wi=bi.constantOr(1),qr=Oe.paint.get("fill-extrusion-opacity"),Xn=Me.style.enable3dLights(),Yn=Oe.paint.get(Xn&&!wi?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),yo=[Oe.paint.get("fill-extrusion-ambient-occlusion-intensity"),Yn],bo=Oe.layout.get("fill-extrusion-edge-radius"),Ro=bo>0&&!Oe.paint.get("fill-extrusion-rounded-roof"),Do=Ro?0:bo,zs="globe"===Gt.projection.name?F.d6():0,Zs="globe"===Gt.projection.name,na=Zs?F.ag(Gt.zoom):0,el=[F.av(Gt.center.lng),F.aC(Gt.center.lat)],nl="none"===Oe.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),hl=Oe.paint.get("fill-extrusion-flood-light-color").toRenderColor(nl?null:Oe.lut).toArray01().slice(0,3),pl=Oe.paint.get("fill-extrusion-flood-light-intensity"),bl=Oe.paint.get("fill-extrusion-vertical-scale"),Tl=0!==Oe.paint.get("fill-extrusion-line-width").constantOr(1),kl=Oe.paint.get("fill-extrusion-height-alignment"),ec=Oe.paint.get("fill-extrusion-base-alignment"),tc=Qi(Me,Oe.paint.get("fill-extrusion-cutoff-fade-range")),ic=[];let oc;Zs&&ic.push("PROJECTION_GLOBE_VIEW"),yo[0]>0&&ic.push("FAUX_AO"),Ro&&ic.push("ZERO_ROOF_RADIUS"),xt&&ic.push("HAS_CENTROID"),pl>0&&ic.push("FLOOD_LIGHT"),tc.shouldRenderCutoff&&ic.push("RENDER_CUTOFF"),Tl&&ic.push("RENDER_WALL_MODE");const sc="shadow"===Me.renderPass,ac=Me.shadowRenderer,mc=sc&&!!ac;Me.shadowRenderer&&(Me.shadowRenderer.useNormalOffset=!0);let gc=[0,0,0];if(ac){const F=Me.style.directionalLight,Le=Me.style.ambientLight;F&&Le&&(gc=no(Me.style,F,Le)),sc||(ic.push("RENDER_SHADOWS","DEPTH_TEXTURE"),ac.useNormalOffset&&ic.push("NORMAL_OFFSET")),oc=ic.concat(["SHADOWS_SINGLE_CASCADE"])}const yc=mc?"fillExtrusionDepth":wi?"fillExtrusionPattern":"fillExtrusion",xc=Oe.getLayerRenderingStats();for(const Xn of Fe){const Fe=Le.getTile(Xn),Yn=Fe.getBucket(Oe);if(!Yn||Yn.projection.name!==Gt.projection.name)continue;let bo=!1;ac&&(bo=0===ac.getMaxCascadeForTile(Xn.toUnwrapped()));const Ro=Me.isTileAffectedByFog(Xn),nl=Yn.programConfigurations.get(Oe.id),mc=Me.getOrCreateProgram(yc,{config:nl,defines:bo?oc:ic,overrideFog:Ro});if(Me.terrain&&Me.terrain.setupElevationDraw(Fe,mc,{useMeterToDem:!0}),!Yn.centroidVertexBuffer){const F=mc.attributes.a_centroid_pos;void 0!==F&&jt.vertexAttrib2f(F,0,0)}!sc&&ac&&ac.setupShadows(Fe.tileID.toUnwrapped(),mc,"vector-tile",Fe.tileID.overscaledZ),wi&&(Me.context.activeTexture.set(jt.TEXTURE0),Fe.imageAtlasTexture&&Fe.imageAtlasTexture.bind(jt.LINEAR,jt.CLAMP_TO_EDGE),nl.updatePaintBuffers());const Zc=bi.constantOr(null);if(Zc&&Fe.imageAtlas){const Me=Fe.imageAtlas,Le=F.d0.from(Zc).getPrimary().scaleSelf(F.q.devicePixelRatio),Oe=Me.patternPositions.get(Le.toString());Oe&&nl.setConstantPatternPositions(Oe)}const Wc=Oe.paint.get("fill-extrusion-vertical-gradient"),Kc=1/Yn.tileToMeter;let Jc;if(sc&&ac){if(Wr(Fe.tileID,Yn,Me))continue;const F=ac.calculateShadowPassMatrixFromTile(Fe.tileID.toUnwrapped());Jc=Js(F,Do,Kc,bl,kl,ec)}else{const F=Me.translatePosMatrix(Xn.expandedProjMatrix,Fe,Oe.paint.get("fill-extrusion-translate"),Oe.paint.get("fill-extrusion-translate-anchor")),Le=Gt.projection.createInversionMatrix(Gt,Xn.canonical);Jc=wi?Qs(F,Me,Wc,qr,yo,Do,Kc,Xn,Fe,zs,kl,ec,na,el,Le,hl,bl):Ys(F,Me,Wc,qr,yo,Do,Kc,Xn,zs,kl,ec,na,el,Le,hl,bl,pl,gc)}Me.uploadCommonUniforms(Pt,mc,Xn.toUnwrapped(),null,tc);let Qc=Yn.segments;if("mercator"===Gt.projection.name&&!sc&&(Qc=Yn.getVisibleSegments(Fe.tileID,Me.terrain,Me.transform.getFrustum(0)),!Qc.get().length))continue;if(xc)if(sc)for(const F of Qc.get())xc.numRenderedVerticesInShadowPass+=F.primitiveLength;else for(const F of Qc.get())xc.numRenderedVerticesInTransparentPass+=F.primitiveLength;const eh=[];(Me.terrain||xt)&&eh.push(Yn.centroidVertexBuffer),Zs&&eh.push(Yn.layoutVertexExtBuffer),Tl&&eh.push(Yn.wallVertexBuffer),mc.draw(Me,Pt.gl.TRIANGLES,je,qe,He,ji.backCCW,Jc,Oe.id,Yn.layoutVertexBuffer,Yn.indexBuffer,Qc,Oe.paint,Me.transform.zoom,nl,eh)}Me.shadowRenderer&&(Me.shadowRenderer.useNormalOffset=!1)}function Gr(Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Ro){const Do=Me.context,zs=Do.gl,Zs=Me.transform,na=Me.transform.zoom,el=[],nl=Qi(Me,Oe.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===jt?(el.push("CLEAR_SUBPASS"),Ro&&(el.push("CLEAR_FROM_TEXTURE"),Do.activeTexture.set(zs.TEXTURE0),Ro.bind(zs.LINEAR,zs.CLAMP_TO_EDGE))):"sdf"===jt&&el.push("SDF_SUBPASS"),yo&&el.push("HAS_CENTROID"),nl.shouldRenderCutoff&&el.push("RENDER_CUTOFF");const hl=Oe.layout.get("fill-extrusion-edge-radius"),I=(F,Le,Fe,jt,bo)=>{const zs=Le.programConfigurations.get(Oe.id),Zs=Me.isTileAffectedByFog(F),pl=Me.getOrCreateProgram("fillExtrusionGroundEffect",{config:zs,defines:el,overrideFog:Zs}),bl=((F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt)=>({u_matrix:Me,u_opacity:Le,u_ao_pass:Oe?1:0,u_meter_to_tile:Fe,u_ao:je,u_flood_light_intensity:qe,u_flood_light_color:He,u_attenuation:xt,u_edge_radius:Pt,u_fb:0,u_fb_size:jt,u_dynamic_offset:1}))(0,jt,Gt,Pt,bo,[bi,wi*bo],qr,Xn,Yn,na>=17?0:hl*bo,Ro?Ro.size[0]:0),Tl=[];yo&&Tl.push(Le.hiddenByLandmarkVertexBuffer),Me.uploadCommonUniforms(Do,pl,F.toUnwrapped(),null,nl),pl.draw(Me,Do.gl.TRIANGLES,je,qe,He,xt,bl,Oe.id,Le.vertexBuffer,Le.indexBuffer,Fe,Oe.paint,na,zs,Tl)};for(const je of Fe){const Fe=Le.getTile(je),qe=Fe.getBucket(Oe);if(!qe||qe.projection.name!==Zs.projection.name||!qe.groundEffect||qe.groundEffect&&!qe.groundEffect.hasData())continue;const He=qe.groundEffect,xt=1/qe.tileToMeter;{const F=Me.translatePosMatrix(je.projMatrix,Fe,Oe.paint.get("fill-extrusion-translate"),Oe.paint.get("fill-extrusion-translate-anchor")),Le=He.getDefaultSegment();I(je,He,Le,F,xt)}if(bo)for(let qe=0;qe<4;qe++){const He=F.d7[qe](je),Pt=Le.getTile(He);if(!Pt)continue;const jt=Pt.getBucket(Oe);if(!jt||jt.projection.name!==Zs.projection.name||!jt.groundEffect||jt.groundEffect&&!jt.groundEffect.hasData())continue;const Gt=jt.groundEffect;let bi,wi;0===qe?(bi=[-F.ai,0,0],wi=1):1===qe?(bi=[F.ai,0,0],wi=0):2===qe?(bi=[0,-F.ai,0],wi=3):(bi=[0,F.ai,0],wi=2);const qr=Gt.regionSegments[wi];if(!qr)continue;const Xn=new Float32Array(16);F.ad.mat4.translate(Xn,je.projMatrix,bi),I(je,Gt,qr,Me.translatePosMatrix(Xn,Fe,Oe.paint.get("fill-extrusion-translate"),Oe.paint.get("fill-extrusion-translate-anchor")),xt)}}}function jr(Me,Le,Oe,Fe,je,qe,He){0===Fe.centroidVertexArray.length&&Fe.createCentroidsBuffer();const xt=qe?qe.findDEMTileFor(Oe):null;if(!(xt&&xt.dem||He))return;qe&&xt&&xt.dem&&Fe.selfDEMTileTimestamp!==xt.dem._timestamp&&(Fe.borderDoneWithNeighborZ=[-1,-1,-1,-1],Fe.selfDEMTileTimestamp=xt.dem._timestamp);const c=Me=>new F.P(Math.ceil((Me+F.da)*F.db),0),h=F=>{const Me=Le.getSource().minzoom,o=F=>{const Me=Le.getTileByID(F);if(Me&&Me.hasData())return Me.getBucket(je)},Oe=[0,-1,1];for(const Le of Oe){if(F.overscaledZ+Le<Me)continue;const Oe=o(F.calculateScaledKey(F.overscaledZ+Le));if(Oe)return Oe}},Pt=[0,0,0],u=(Me,Le)=>(Pt[0]=Math.min(Me.min.y,Le.min.y),Pt[1]=Math.max(Me.max.y,Le.max.y),Pt[2]=F.ai-Le.min.x>Me.max.x?Le.min.x-F.ai:Me.max.x,Pt),_=(Me,Le)=>(Pt[0]=Math.min(Me.min.x,Le.min.x),Pt[1]=Math.max(Me.max.x,Le.max.x),Pt[2]=F.ai-Le.min.y>Me.max.y?Le.min.y-F.ai:Me.max.y,Pt),jt=[(F,Me)=>u(F,Me),(F,Me)=>u(Me,F),(F,Me)=>_(F,Me),(F,Me)=>_(Me,F)],f=(Me,Le,Fe,je,He,Pt,jt)=>{if(!qe)return 0;const Gt=[[Pt?Fe:Me,Pt?Me:Fe,0],[Pt?Fe:Le,Pt?Le:Fe,0]],bi=jt<0?F.ai+jt:jt,wi=[Pt?bi:(Me+Le)/2,Pt?(Me+Le)/2:bi,0];return 0===Fe&&jt<0||0!==Fe&&jt>0?qe.getForTilePoints(He,[wi],!0,je):Gt.push(wi),qe.getForTilePoints(Oe,Gt,!0,xt),Math.max(Gt[0][2],Gt[1][2],wi[2])/qe.exaggeration()};for(let Me=0;Me<4;Me++){const Le=Fe.borderFeatureIndices[Me];if(0===Le.length)continue;const je=F.d7[Me](Oe),xt=h(je);if(!(xt&&xt instanceof F.d8))continue;const Pt=qe?qe.findDEMTileFor(je):null;if(!(Pt&&Pt.dem||He))continue;if(qe&&Pt&&Pt.dem&&Fe.borderDEMTileTimestamp[Me]!==Pt.dem._timestamp&&(Fe.borderDoneWithNeighborZ[Me]=-1,Fe.borderDEMTileTimestamp[Me]=Pt.dem._timestamp),Fe.borderDoneWithNeighborZ[Me]===xt.canonical.z)continue;0===xt.centroidVertexArray.length&&xt.createCentroidsBuffer();const wi=(Me<2?1:5)-Me,qr=xt.borderDoneWithNeighborZ[wi]!==Fe.canonical.z,Xn=xt.borderFeatureIndices[wi];let Yn=0;if(Fe.canonical.z!==xt.canonical.z){for(const F of Le)Fe.showCentroid(Fe.featuresOnBorder[F]);if(qr)for(const F of Xn)xt.showCentroid(xt.featuresOnBorder[F]);Fe.borderDoneWithNeighborZ[Me]=xt.canonical.z,xt.borderDoneWithNeighborZ[wi]=Fe.canonical.z}for(const Oe of Le){const Le=Fe.featuresOnBorder[Oe],qe=Fe.centroidData[Le.centroidDataIndex],qr=Le.borders[Me];let yo;for(;Yn<Xn.length;){yo=xt.featuresOnBorder[Xn[Yn]];const F=yo.borders[wi];if(F[1]>qr[0]+3||F[0]>qr[0]-3)break;xt.showCentroid(yo),Yn++}if(yo&&Yn<Xn.length){const Oe=Yn;let bo=0;for(;!(yo.borders[wi][0]>qr[1]-3)&&(bo++,++Yn!==Xn.length);)yo=xt.featuresOnBorder[Xn[Yn]];yo=xt.featuresOnBorder[Xn[Oe]];let Ro=!1;if(bo>=1){const F=yo.borders[wi];Math.abs(qr[0]-F[0])<3&&Math.abs(qr[1]-F[1])<3&&(bo=1,Ro=!0,Yn=Oe+1)}else if(0===bo){Fe.showCentroid(Le);continue}const Do=xt.centroidData[yo.centroidDataIndex];He&&Ro&&(((Gt=qe).flags|(bi=Do).flags)&F.d9?(Gt.flags|=F.d9,bi.flags|=F.d9):(Gt.flags&=~F.d9,bi.flags&=~F.d9));const zs=Le.intersectsCount()>1||yo.intersectsCount()>1;if(bo>1)Yn=Oe,qe.centroidXY=Do.centroidXY=new F.P(0,0);else if(Pt&&Pt.dem&&!zs){const Le=jt[Me](qe,Do),Oe=Me%2?F.ai-1:0,Fe=f(Le[0],Math.min(F.ai-1,Le[1]),Oe,Pt,je,Me<2,Le[2]);qe.centroidXY=Do.centroidXY=c(Fe)}else zs?qe.centroidXY=Do.centroidXY=new F.P(0,0):(qe.centroidXY=Fe.encodeBorderCentroid(Le),Do.centroidXY=xt.encodeBorderCentroid(yo));Fe.writeCentroidToBuffer(qe),xt.writeCentroidToBuffer(Do)}else Fe.showCentroid(Le)}Fe.borderDoneWithNeighborZ[Me]=xt.canonical.z,xt.borderDoneWithNeighborZ[wi]=Fe.canonical.z}var Gt,bi;(Fe.needsCentroidUpdate||!Fe.centroidVertexBuffer&&0!==Fe.centroidVertexArray.length)&&Fe.uploadCentroid(Me)}const Op=[1,0,0],kp=[0,1,0],Fp=[0,0,1];function Wr(Me,Le,Oe){const Fe=Oe.transform,je=Oe.shadowRenderer;if(!je)return!0;const qe=Me.toUnwrapped(),He=Fe.tileSize*je._cascades[Oe.currentShadowCascade].scale;let xt=Le.maxHeight;if(Fe.elevation){const F=Fe.elevation.getMinMaxForTile(Me);F&&(xt+=F.max)}const Pt=[...je.shadowDirection];Pt[2]=-Pt[2];const jt=je.computeSimplifiedTileShadowVolume(qe,xt,He,Pt);if(!jt)return!1;const Gt=[Op,kp,Fp,Pt,[Pt[0],0,Pt[2]],[0,Pt[1],Pt[2]]],bi="globe"===Fe.projection.name,wi=Fe.scaleZoom(He),qr=F.bR.fromInvProjectionMatrix(Fe.invProjMatrix,Fe.worldSize,wi,!bi),Xn=je.getCurrentCascadeFrustum();return 0===qr.intersectsPrecise(jt.vertices,jt.planes,Gt)||0===Xn.intersectsPrecise(jt.vertices,jt.planes,Gt)}function $r(Me){return[Me[0]*F.dc,Me[1]*F.dc,Me[2]*F.dc,0]}function Xr(Me,Le,Oe,Fe,je,qe,He,xt,Pt){const jt=Fe.getSource(),Gt=Oe.globeSharedBuffers;if(!Gt)return;let bi,wi,qr;if(Le&&(bi=Fe.getTile(Le)),jt instanceof F.aK?(wi=jt.texture,qr=F.cJ(0,0,Oe.transform)):bi&&Le&&(wi=bi.texture,qr=F.cJ(Le.canonical.z,Le.canonical.x,Oe.transform)),!wi||!qr)return;Me||(qr=F.ad.mat4.scale(F.ad.mat4.create(),qr,[1,-1,1]));const Xn=Oe.context,Yn=Xn.gl,yo="nearest"===je.paint.get("raster-resampling")?Yn.NEAREST:Yn.LINEAR,bo=Oe.colorModeForDrapableLayerRenderPass(qe),Ro=He.defines;Ro.push("GLOBE_POLES");const Do=new Bi(Yn.LEQUAL,Bi.ReadWrite,Oe.depthRangeFor3D),zs=Float32Array.from(Oe.transform.expandedFarZProjMatrix),Zs=Float32Array.from(F.bc(F.cI(new F.bT(0,0,0))));Oe.terrain&&Oe.terrain.prepareDrawTile(),Xn.activeTexture.set(Yn.TEXTURE0),wi.bind(yo,Yn.CLAMP_TO_EDGE),Xn.activeTexture.set(Yn.TEXTURE1),wi.bind(yo,Yn.CLAMP_TO_EDGE),"useMipmap"in wi&&Xn.extTextureFilterAnisotropic&&Oe.transform.pitch>20&&Yn.texParameterf(Yn.TEXTURE_2D,Xn.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Xn.extTextureFilterAnisotropicMax);const[na,el,nl,hl]=Le?Gt.getPoleBuffers(Le.canonical.z,!1):Gt.getPoleBuffers(0,!0),pl=je.paint.get("raster-elevation");let bl;Me?(bl=na,Oe.renderDefaultNorthPole=0!==pl):(bl=el,Oe.renderDefaultSouthPole=0!==pl);const Tl=$r(He.mix),kl=((F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi)=>dr(F,Me,Le,new Float32Array(16),new Float32Array(9),[0,0],Oe,[0,0],[0,0,0,0],1,{opacity:1,mix:0},je,[0,0]||[0,0],He,2,Pt,jt,Gt,1,0,bi))(zs,Zs,qr,F.ag(Oe.transform.zoom),0,je,0,pl,0,Tl,He.offset,He.range,qe),ec=Oe.getOrCreateProgram("raster",{defines:Ro});Oe.uploadCommonUniforms(Xn,ec,null),ec.draw(Oe,Yn.TRIANGLES,Do,Pt,bo,xt,kl,je.id,bl,nl,hl)}function Kr(F){const Me=F._nearZ,Le=F.projection.farthestPixelDistance(F),Oe=Le-Me,Fe=.2*F.height,je=Me+Fe;return[Me,Le,(je-Fe-Me)/Oe,(je-Me)/Oe]}function Yr(F,Me,Le,Oe){if(F)return Me instanceof ot&&F instanceof wt?Me.getTextureDescriptor(F,Le,!0):{texture:F.texture,mix:$r(Oe.mix),offset:Oe.offset,buffer:0,tileSize:1}}var Np=F.dd([{name:"a_index",type:"Int16",components:1}]);class Qr{constructor(Me,Le,Oe,Fe){const je={width:Oe[0],height:Oe[1],data:null},qe=Me.gl;this.targetColorTexture=new F.T(Me,je,qe.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new F.T(Me,je,qe.RGBA8,{useMipmap:!1}),this.context=Me,this.updateParticleTexture(Le,Fe),this.lastInvalidatedAt=0}updateParticleTexture(Me,Le){if(this.particleTextureDimension===Le.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const Oe=this.context.gl,Fe=Le.width*Le.height;this.particleTexture0=new F.T(this.context,Le,Oe.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new F.T(this.context,Le,Oe.RGBA8,{premultiply:!1,useMipmap:!1});const je=new F.de;je.reserve(Fe);for(let F=0;F<Fe;F++)je.emplaceBack(F);this.particleIndexBuffer=this.context.createVertexBuffer(je,Np.members,!0),this.particleSegment=F.b8.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=Le.width}update(Me){return!(this.lastInvalidatedAt<Me&&(this.lastInvalidatedAt=F.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function en(Me,Le,Oe){if(!Me)return null;const Fe=Le.getTextureDescriptor(Me,Oe,!0);if(!Fe)return null;let{texture:je,mix:qe,offset:He,tileSize:xt,buffer:Pt,format:jt}=Fe;if(!je||!jt)return null;let Gt=!1;return"uint32"===jt&&(Gt=!0,qe[3]=0,qe=cr(F.df,qe,[0,Oe.paint.get("raster-particle-max-speed")]),He=hr(F.df,He,[0,Oe.paint.get("raster-particle-max-speed")])),{texture:je,textureOffset:[Pt/(xt+2*Pt),xt/(xt+2*Pt)],tileSize:xt,scalarData:Gt,scale:qe,offset:He,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[jt]]}}function tn(F){const Me=F._nearZ,Le=F.projection.farthestPixelDistance(F),Oe=Le-Me,Fe=.2*F.height,je=Me+Fe;return[Me,Le,(je-Fe-Me)/Oe,(je-Me)/Oe]}const Up=new F.al(1,0,0,1),Gp=new F.al(0,1,0,1),qp=new F.al(0,0,1,1),$p=new F.al(1,0,1,1),Zp=new F.al(0,1,1,1);function ln(Me,Le,Oe,Fe,je,qe,He){const xt=Me.context,Pt=Me.transform,jt=xt.gl,Gt="globe"===Pt.projection.name,bi=Gt?["PROJECTION_GLOBE_VIEW"]:[];let wi=F.ad.mat4.clone(Oe.projMatrix);if(Gt&&F.ag(Pt.zoom)>0){const Me=F.bb(Oe.canonical,Pt),Le=F.dg(Me);wi=F.ad.mat4.multiply(new Float32Array(16),Pt.globeMatrix,Le),F.ad.mat4.multiply(wi,Pt.projMatrix,wi)}const qr=F.ad.mat4.create();qr[12]+=2*je/(F.q.devicePixelRatio*Pt.width),qr[13]+=2*qe/(F.q.devicePixelRatio*Pt.height),F.ad.mat4.multiply(wi,qr,wi);const Xn=Me.getOrCreateProgram("debug",{defines:bi}),Yn=Le.getTileByID(Oe.key);Me.terrain&&Me.terrain.setupElevationDraw(Yn,Xn);const yo=Bi.disabled,bo=Ui.disabled,Ro=Me.colorModeForRenderPass(),Do="$debug";xt.activeTexture.set(jt.TEXTURE0),Me.emptyTexture.bind(jt.LINEAR,jt.CLAMP_TO_EDGE),Gt?Yn._makeGlobeTileDebugBuffers(Me.context,Pt):Yn._makeDebugTileBoundsBuffers(Me.context,Pt.projection);const zs=Yn._tileDebugBuffer||Me.debugBuffer,Zs=Yn._tileDebugIndexBuffer||Me.debugIndexBuffer,na=Yn._tileDebugSegments||Me.debugSegments;if(Xn.draw(Me,jt.LINE_STRIP,yo,bo,Ro,ji.disabled,nr(wi,Fe),Do,zs,Zs,na,null,null,null,[Yn._globeTileDebugBorderBuffer]),He){const F=Yn.latestRawTileData,Le=Math.floor((F&&F.byteLength||0)/1024);let Fe=Oe.canonical.toString();Oe.overscaledZ!==Oe.canonical.z&&(Fe+=` => ${Oe.overscaledZ}`),Fe+=` ${Yn.state}`,Fe+=` ${Le}kb`,function(F,Me){F.initDebugOverlayCanvas();const Le=F.debugOverlayCanvas,Oe=F.context.gl,Fe=F.debugOverlayCanvas.getContext("2d");Fe.clearRect(0,0,Le.width,Le.height),Fe.shadowColor="white",Fe.shadowBlur=2,Fe.lineWidth=1.5,Fe.strokeStyle="white",Fe.textBaseline="top",Fe.font="bold 36px Open Sans, sans-serif",Fe.fillText(Me,5,5),Fe.strokeText(Me,5,5),F.debugOverlayTexture.update(Le),F.debugOverlayTexture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE)}(Me,Fe)}const el=Le.getTile(Oe).tileSize,nl=512/Math.min(el,512)*(Oe.overscaledZ/Pt.zoom)*.5,hl=Yn._tileDebugTextBuffer||Me.debugBuffer,pl=Yn._tileDebugTextIndexBuffer||Me.quadTriangleIndexBuffer,bl=Yn._tileDebugTextSegments||Me.debugSegments;Xn.draw(Me,jt.TRIANGLES,yo,bo,ki.alphaBlended,ji.disabled,nr(wi,F.al.transparent,nl),Do,hl,pl,bl,null,null,null,[Yn._globeTileDebugTextBuffer])}function cn(F,Me,Le,Oe){dn(F,0,Me+Le/2,F.transform.width,Le,Oe)}function hn(F,Me,Le,Oe){dn(F,Me-Le/2,0,Le,F.transform.height,Oe)}function dn(Me,Le,Oe,Fe,je,qe){const He=Me.context,xt=He.gl;xt.enable(xt.SCISSOR_TEST),xt.scissor(Le*F.q.devicePixelRatio,Oe*F.q.devicePixelRatio,Fe*F.q.devicePixelRatio,je*F.q.devicePixelRatio),He.clear({color:qe}),xt.disable(xt.SCISSOR_TEST)}const Xp=F.dd([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:rf}=Xp;function pn(F,Me,Le,Oe){F.emplaceBack(Me,Le,Oe)}class fn{constructor(Me){this.vertexArray=new F.dh,this.indices=new F.aV,pn(this.vertexArray,-1,-1,1),pn(this.vertexArray,1,-1,1),pn(this.vertexArray,-1,1,1),pn(this.vertexArray,1,1,1),pn(this.vertexArray,-1,-1,-1),pn(this.vertexArray,1,-1,-1),pn(this.vertexArray,-1,1,-1),pn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=Me.createVertexBuffer(this.vertexArray,rf),this.indexBuffer=Me.createIndexBuffer(this.indices),this.segment=F.b8.simpleSegment(0,0,36,12)}}function mn(Me,Le,Oe,Fe,je,qe){const He=Me.context.gl,xt=Le.paint.get("sky-atmosphere-color"),Pt=Le.paint.get("sky-atmosphere-halo-color"),jt=Le.paint.get("sky-atmosphere-sun-intensity"),Gt=((F,Me,Le,Oe,Fe)=>({u_matrix_3f:F,u_sun_direction:Me,u_sun_intensity:Le,u_color_tint_r:[Oe.r,Oe.g,Oe.b,Oe.a],u_color_tint_m:[Fe.r,Fe.g,Fe.b,Fe.a],u_luminance:5e-5}))(F.ad.mat3.fromMat4(F.ad.mat3.create(),Fe),je,jt,xt,Pt);He.framebufferTexture2D(He.FRAMEBUFFER,He.COLOR_ATTACHMENT0,He.TEXTURE_CUBE_MAP_POSITIVE_X+qe,Le.skyboxTexture,0),Oe.draw(Me,He.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.frontCW,Gt,"skyboxCapture",Le.skyboxGeometry.vertexBuffer,Le.skyboxGeometry.indexBuffer,Le.skyboxGeometry.segment)}const af=F.dd([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class vn{constructor(Me){const Le=new F.di;Le.emplaceBack(-1,1,1,0,0),Le.emplaceBack(1,1,1,1,0),Le.emplaceBack(1,-1,1,1,1),Le.emplaceBack(-1,-1,1,0,1);const Oe=new F.aV;Oe.emplaceBack(0,1,2),Oe.emplaceBack(2,3,0),this.vertexBuffer=Me.createVertexBuffer(Le,af.members),this.indexBuffer=Me.createIndexBuffer(Oe),this.segments=F.b8.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const lf=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class xn{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class bn{constructor(Me){this.colorModeAlphaBlendedWriteRGB=new ki([1,Ch,1,Ch],F.al.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ki([1,0,1,0],F.al.transparent,[!1,!1,!1,!0]),this.params=new xn,this.updateNeeded=!0,Me.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),Me.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),Me.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),Me.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(Me){const Le=Me.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new vn(Le);const Me=this.params.sizeRange,Oe=this.params.intensityRange,Fe=function(Me){const Le=F.dl(30),Oe=[];for(let Fe=0;Fe<Me;++Fe){const Me=2*Math.PI*Le(),Fe=Math.acos(1-2*Le())-.5*Math.PI;Oe.push(F.ad.vec3.fromValues(Math.cos(Fe)*Math.cos(Me),Math.cos(Fe)*Math.sin(Me),Math.sin(Fe)))}return Oe}(this.params.starsCount),je=F.dl(300),qe=new F.dj,He=new F.aV;let xt=0;for(let Le=0;Le<Fe.length;++Le){const Pt=F.ad.vec3.scale([],Fe[Le],200),jt=Math.max(0,1+.01*Me*(1*je()-.5)),Gt=Math.max(0,1+.01*Oe*(1*je()-.5));qe.emplaceBack(Pt[0],Pt[1],Pt[2],-1,-1,jt,Gt),qe.emplaceBack(Pt[0],Pt[1],Pt[2],1,-1,jt,Gt),qe.emplaceBack(Pt[0],Pt[1],Pt[2],1,1,jt,Gt),qe.emplaceBack(Pt[0],Pt[1],Pt[2],-1,1,jt,Gt),He.emplaceBack(xt+0,xt+1,xt+2),He.emplaceBack(xt+0,xt+2,xt+3),xt+=4}this.starsVx=Le.createVertexBuffer(qe,lf.members),this.starsIdx=Le.createIndexBuffer(He),this.starsSegments=F.b8.simpleSegment(0,0,qe.length,He.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(Me,Le){const Oe=Me.context,Fe=Oe.gl,je=Me.transform,qe=new Bi(Fe.LEQUAL,Bi.ReadOnly,[0,1]),He=F.ag(je.zoom),xt=Me.style.getLut(Le.scope),Pt="none"===Le.properties.get("color-use-theme"),jt=Le.properties.get("color").toRenderColor(Pt?null:xt).toArray01(),Gt="none"===Le.properties.get("high-color-use-theme"),bi=Le.properties.get("high-color").toRenderColor(Gt?null:xt).toArray01(),wi="none"===Le.properties.get("space-color-use-theme"),qr=Le.properties.get("space-color").toRenderColor(wi?null:xt).toArray01PremultipliedAlpha(),Xn=5e-4,Yn=F.dk(Le.properties.get("horizon-blend"),0,1,Xn,.25),yo=F.cD(Me,Oe,je)&&Yn===Xn?je.worldSize/(2*Math.PI*1.025)-1:je.globeRadius,bo=Me.frameCounter/1e3%1,Ro=F.ad.vec3.length(je.globeCenterInViewSpace),Do=Math.sqrt(Math.pow(Ro,2)-Math.pow(yo,2)),zs=Math.acos(Do/Ro),w=F=>{const Le="globe"===je.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];F&&Le.push("ALPHA_PASS");const xt=Me.getOrCreateProgram("globeAtmosphere",{defines:Le}),Pt=((F,Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt)=>({u_frustum_tl:F,u_frustum_tr:Me,u_frustum_br:Le,u_frustum_bl:Oe,u_horizon:Fe,u_transition:je,u_fadeout_range:qe,u_color:He,u_high_color:xt,u_space_color:Pt,u_temporal_offset:jt,u_horizon_angle:Gt}))(je.frustumCorners.TL,je.frustumCorners.TR,je.frustumCorners.BR,je.frustumCorners.BL,je.frustumCorners.horizon,He,Yn,jt,bi,qr,bo,zs);Me.uploadCommonUniforms(Oe,xt);const Gt=this.atmosphereBuffer;Gt&&xt.draw(Me,Fe.TRIANGLES,qe,Ui.disabled,F?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ji.backCW,Pt,F?"atmosphere_glow_alpha":"atmosphere_glow",Gt.vertexBuffer,Gt.indexBuffer,Gt.segments)};w(!1),w(!0)}drawStars(Me,Le){const Oe=F.ay(Le.properties.get("star-intensity"),0,1);if(0===Oe)return;const Fe=Me.context,je=Fe.gl,qe=Me.transform,He=Me.getOrCreateProgram("stars"),xt=F.ad.quat.identity([]);F.ad.quat.rotateX(xt,xt,-qe._pitch),F.ad.quat.rotateZ(xt,xt,-qe.angle),F.ad.quat.rotateX(xt,xt,F.ak(qe._center.lat)),F.ad.quat.rotateY(xt,xt,-F.ak(qe._center.lng));const Pt=F.ad.mat4.fromQuat(new Float32Array(16),xt),jt=F.ad.mat4.multiply([],qe.starsProjMatrix,Pt),Gt=F.ad.mat3.fromMat4([],Pt),bi=F.ad.mat3.invert([],Gt),wi=[0,1,0];F.ad.vec3.transformMat3(wi,wi,bi),F.ad.vec3.scale(wi,wi,this.params.sizeMultiplier);const qr=[1,0,0];F.ad.vec3.transformMat3(qr,qr,bi),F.ad.vec3.scale(qr,qr,this.params.sizeMultiplier);const Xn=(Yn=wi,yo=qr,bo=Oe,{u_matrix:Float32Array.from(jt),u_up:Yn,u_right:yo,u_intensity_multiplier:bo});var Yn,yo,bo;Me.uploadCommonUniforms(Fe,He),this.starsVx&&this.starsIdx&&He.draw(Me,je.TRIANGLES,Bi.disabled,Ui.disabled,this.colorModeAlphaBlendedWriteRGB,ji.disabled,Xn,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function wn(Me,Le){const Oe=[...Me],Fe=Le.cameraWorldSizeForFog/Le.worldSize,je=F.ad.mat4.identity([]);return F.ad.mat4.scale(je,je,[Fe,Fe,1]),F.ad.mat4.multiply(Oe,je,Oe),F.ad.mat4.multiply(Oe,Le.worldToFogMatrix,Oe),Oe}function Tn(Me,Le,Oe,Fe,je){const qe=Oe.material,He=Fe.context,{baseColorTexture:xt,metallicRoughnessTexture:Pt}=qe.pbrMetallicRoughness,{normalTexture:jt,occlusionTexture:Gt,emissionTexture:bi}=qe;function _(F,Le,Oe){if(F&&(Me.push(Le),He.activeTexture.set(He.gl.TEXTURE0+Oe),F.gfxTexture)){const{minFilter:Me,magFilter:Le,wrapS:Oe,wrapT:Fe}=F.sampler;F.gfxTexture.bindExtraParam(Me,Le,Oe,Fe)}}_(xt,"HAS_TEXTURE_u_baseColorTexture",Bh.BaseColor),_(Pt,"HAS_TEXTURE_u_metallicRoughnessTexture",Bh.MetallicRoughness),_(jt,"HAS_TEXTURE_u_normalTexture",Bh.Normal),_(Gt,"HAS_TEXTURE_u_occlusionTexture",Bh.Occlusion),_(bi,"HAS_TEXTURE_u_emissionTexture",Bh.Emission),je&&(je.texture||(je.texture=new F.dn(Fe.context,je.image,[je.image.height,je.image.height,je.image.height],He.gl.RGBA8)),He.activeTexture.set(He.gl.TEXTURE0+Bh.LUT),je.texture&&je.texture.bind(He.gl.LINEAR,He.gl.CLAMP_TO_EDGE),Me.push("APPLY_LUT_ON_GPU")),Oe.texcoordBuffer&&(Me.push("HAS_ATTRIBUTE_a_uv_2f"),Le.push(Oe.texcoordBuffer)),Oe.colorBuffer&&(Me.push(12===Oe.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),Le.push(Oe.colorBuffer)),Oe.normalBuffer&&(Me.push("HAS_ATTRIBUTE_a_normal_3f"),Le.push(Oe.normalBuffer)),Oe.pbrBuffer&&(Me.push("HAS_ATTRIBUTE_a_pbr"),Me.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),Le.push(Oe.pbrBuffer)),"OPAQUE"!==qe.alphaMode&&"MASK"!==qe.alphaMode||Me.push("UNPREMULT_TEXTURE_IN_SHADER"),qe.defined||Me.push("DIFFUSE_SHADED");const wi=Fe.shadowRenderer;wi&&(Me.push("RENDER_SHADOWS","DEPTH_TEXTURE"),wi.useNormalOffset&&Me.push("NORMAL_OFFSET"))}function En(Me,Le,Oe,Fe,je,qe){const He=Oe.paint.get("model-opacity").constantOr(1),xt=Le.context,Pt=new Bi(Le.context.gl.LEQUAL,Bi.ReadWrite,Le.depthRangeFor3D),jt=Le.transform,Gt=Me.mesh,bi=Gt.material,wi=bi.pbrMetallicRoughness,qr=Le.style.fog;let Xn;Xn="pixels"===Le.transform.projection.zAxisUnit?[...Me.nodeModelMatrix]:F.ad.mat4.multiply([],Fe.zScaleMatrix,Me.nodeModelMatrix),F.ad.mat4.multiply(Xn,Fe.negCameraPosMatrix,Xn);const Yn=F.ad.mat4.invert([],Xn);F.ad.mat4.transpose(Yn,Yn);const yo="none"===Oe.paint.get("model-color-use-theme").constantOr("default"),bo=Oe.paint.get("model-emissive-strength").constantOr(0),Ro=wr(new Float32Array(Me.worldViewProjection),new Float32Array(Xn),new Float32Array(Yn),null,Le,He,wi.baseColorFactor.toRenderColor(null),bi.emissiveFactor,wi.metallicFactor,wi.roughnessFactor,bi,bo,Oe),Do={defines:[]},zs=[],Zs=Le.shadowRenderer;Zs&&(Zs.useNormalOffset=!1),Tn(Do.defines,zs,Gt,Le,yo?null:Oe.lut);let na=null;if(qr){const F=wn(Me.nodeModelMatrix,Le.transform);if(na=new Float32Array(F),"globe"!==jt.projection.name){const Me=Gt.aabb.min,Le=Gt.aabb.max,[Oe,Fe]=qr.getOpacityForBounds(F,Me[0],Me[1],Le[0],Le[1]);Do.overrideFog=Oe>=ec||Fe>=ec}}const el=Qi(Le,Oe.paint.get("model-cutoff-fade-range"));el.shouldRenderCutoff&&Do.defines.push("RENDER_CUTOFF");const nl=Le.getOrCreateProgram("model",Do);Le.uploadCommonUniforms(xt,nl,null,na,el),"shadow"!==Le.renderPass&&Zs&&Zs.setupShadowsFromMatrix(Me.nodeModelMatrix,nl),nl.draw(Le,xt.gl.TRIANGLES,Pt,je,qe,Gt.material.doubleSided?ji.disabled:ji.backCCW,Ro,Oe.id,Gt.vertexBuffer,Gt.indexBuffer,Gt.segments,Oe.paint,Le.transform.zoom,void 0,zs)}function Sn(Me,Le,Oe,Fe,je,qe,He){let xt;xt="globe"===Me.projection.name?F.dp(Oe,Me):[...Oe],F.ad.mat4.multiply(xt,xt,Le.matrix);const Pt=F.ad.mat4.multiply([],Fe,xt);if(Le.meshes)for(const Oe of Le.meshes){if("BLEND"!==Oe.material.alphaMode){He.push({mesh:Oe,depth:0,modelIndex:je,worldViewProjection:Pt,nodeModelMatrix:xt});continue}const Le=F.ad.vec3.transformMat4([],Oe.centroid,Pt);!Me.isOrthographic&&Le[2]<=0||qe.push({mesh:Oe,depth:Le[2],modelIndex:je,worldViewProjection:Pt,nodeModelMatrix:xt})}if(Le.children)for(const F of Le.children)Sn(Me,F,Oe,Fe,je,qe,He)}function Cn(F,Me,Le,Oe){const Fe=Le.shadowRenderer;if(!Fe)return;const je=Fe.getShadowPassDepthMode(),qe=Fe.getShadowPassColorMode(),He=Fe.calculateShadowPassMatrixFromMatrix(Me),xt=Tr(He);Le.getOrCreateProgram("modelDepth",{defines:Le._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(Le,Le.context.gl.TRIANGLES,je,Ui.disabled,qe,ji.backCCW,xt,Oe.id,F.vertexBuffer,F.indexBuffer,F.segments,Oe.paint,Le.transform.zoom,void 0,void 0)}function In(Me,Le,Oe){const Fe=Le.updateZoomBasedPaintProperties(),je=function(Me,Le,Oe){let Fe,je,qe,He=Me.terrain?Me.terrain.exaggeration():0;if(Me.terrain&&He>0){const Le=Me.terrain,je=Le.findDEMTileFor(Oe);je&&je.dem?Fe=F.dr.create(Le,Oe,je):He=0}if(0===He&&(Le.terrainElevationMin=0,Le.terrainElevationMax=0),He===Le.validForExaggeration&&(0===He||Fe&&Fe._demTile&&Fe._demTile.tileID===Le.validForDEMTile.id&&Fe._dem._timestamp===Le.validForDEMTile.timestamp))return!1;for(const F in Le.instancesPerModel){const Me=Le.instancesPerModel[F];for(let F=0;F<Me.instancedDataArray.length;++F){const Oe=(Fe?He*Fe.getElevationAt(0|Me.instancedDataArray.float32[16*F],0|Me.instancedDataArray.float32[16*F+1],!0,!0):0)+Me.instancesEvaluatedElevation[F];Me.instancedDataArray.float32[16*F+6]=Oe,je=je?Math.min(Le.terrainElevationMin,Oe):Oe,qe=qe?Math.max(Le.terrainElevationMax,Oe):Oe}}return Le.terrainElevationMin=je||0,Le.terrainElevationMax=qe||0,Le.validForExaggeration=He,Le.validForDEMTile=Fe&&Fe._demTile?{id:Fe._demTile.tileID,timestamp:Fe._dem._timestamp}:{id:void 0,timestamp:0},!0}(Me,Le,Oe);(Fe||je)&&(Le.uploaded=!1,Le.upload(Me.context))}const cf={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new F.ce([0,0,0],[F.ai,F.ai,0])};function Dn(Me,Le){const Oe=1<<Me.canonical.z,Fe=Le.getFreeCameraOptions().position,je=Le.elevation,qe=Me.canonical.x/Oe,He=(Me.canonical.x+1)/Oe,xt=Me.canonical.y/Oe,Pt=(Me.canonical.y+1)/Oe;let jt=Le._centerAltitude;if(je){const F=je.getMinMaxForTile(Me);F&&F.max>jt&&(jt=F.max)}const Gt=F.ay(Fe.x,qe,He)-Fe.x,bi=F.ay(Fe.y,xt,Pt)-Fe.y,wi=F.bH(jt,Le.center.lat)-Fe.z;return Le._zoomFromMercatorZ(Math.sqrt(Gt*Gt+bi*bi+wi*wi))}function An(F,Me,Le,Oe,Fe,je,qe){const He=F.context,xt="shadow"===F.renderPass,Pt=F.shadowRenderer,jt=xt&&Pt?Pt.getShadowPassDepthMode():new Bi(He.gl.LEQUAL,Bi.ReadWrite,F.depthRangeFor3D),Gt=F.isTileAffectedByFog(je);if(Le.meshes)for(const bi of Le.meshes){const wi=["MODEL_POSITION_ON_GPU"],qr=[];let Xn,Yn,yo;Oe.instancedDataArray.length>20&&wi.push("INSTANCED_ARRAYS");const bo=Qi(F,Me.paint.get("model-cutoff-fade-range"));if(bo.shouldRenderCutoff&&wi.push("RENDER_CUTOFF"),xt&&Pt)Xn=F.getOrCreateProgram("modelDepth",{defines:wi}),Yn=Tr(qe.shadowTileMatrix,qe.shadowTileMatrix,Float32Array.from(Le.matrix)),yo=Pt.getShadowPassColorMode();else{Tn(wi,qr,bi,F,"none"===Me.paint.get("model-color-use-theme").constantOr("default")?null:Me.lut),Xn=F.getOrCreateProgram("model",{defines:wi,overrideFog:Gt});const Oe=bi.material,xt=Oe.pbrMetallicRoughness,jt=Me.paint.get("model-opacity").constantOr(1),Ro=Me.paint.get("model-emissive-strength").constantOr(0);Yn=wr(je.expandedProjMatrix,Float32Array.from(Le.matrix),new Float32Array(16),null,F,jt,xt.baseColorFactor.toRenderColor(null),Oe.emissiveFactor,xt.metallicFactor,xt.roughnessFactor,Oe,Ro,Me,Fe),Pt&&(qe.shadowUniformsInitialized?Xn.setShadowUniformValues(He,Pt.getShadowUniformValues()):(Pt.setupShadows(je.toUnwrapped(),Xn,"model-tile",je.overscaledZ),qe.shadowUniformsInitialized=!0)),yo=bo.shouldRenderCutoff||jt<1||"OPAQUE"!==Oe.alphaMode?ki.alphaBlended:ki.unblended}F.uploadCommonUniforms(He,Xn,je.toUnwrapped(),null,bo);const Ro=bi.material.doubleSided?ji.disabled:ji.backCCW;if(Oe.instancedDataArray.length>20)qr.push(Oe.instancedDataBuffer),Xn.draw(F,He.gl.TRIANGLES,jt,Ui.disabled,yo,Ro,Yn,Me.id,bi.vertexBuffer,bi.indexBuffer,bi.segments,Me.paint,F.transform.zoom,void 0,qr,Oe.instancedDataArray.length);else{const Le=xt?"u_instance":"u_normal_matrix";for(let Fe=0;Fe<Oe.instancedDataArray.length;++Fe)Yn[Le]=new Float32Array(Oe.instancedDataArray.arrayBuffer,64*Fe,16),Xn.draw(F,He.gl.TRIANGLES,jt,Ui.disabled,yo,Ro,Yn,Me.id,bi.vertexBuffer,bi.indexBuffer,bi.segments,Me.paint,F.transform.zoom,void 0,qr)}}if(Le.children)for(const He of Le.children)An(F,Me,He,Oe,Fe,je,qe)}const hf=[1,-1,1];function Pn(Me,Le,Oe,Fe){if(!Oe.modelManager)return!0;const je=Oe.modelManager;if(!Oe.shadowRenderer)return!0;const qe=Oe.shadowRenderer,He=Le.aabb;let xt=!0,Pt=Me.maxHeight;if(0===Pt){let F=0;for(const Le in Me.instancesPerModel){const Me=je.getModel(Le,Fe);Me?F=Math.max(F,Math.max(Math.max(Me.aabb.max[0],Me.aabb.max[1]),Me.aabb.max[2])):xt=!1}Pt=Me.maxScale*F*1.41+Me.maxVerticalOffset,xt&&(Me.maxHeight=Pt)}He.max[2]=Pt,He.min[2]+=Me.terrainElevationMin,He.max[2]+=Me.terrainElevationMax,F.ad.vec3.transformMat4(He.min,He.min,Le.tileMatrix),F.ad.vec3.transformMat4(He.max,He.max,Le.tileMatrix);const jt=He.intersects(qe.getCurrentCascadeFrustum());return 0===Oe.currentShadowCascade&&(Me.isInsideFirstShadowMapFrustum=2===jt),0===jt}function Mn(Me,Le){const Oe=Me.uniformValues.u_cutoff_params[0],Fe=Me.uniformValues.u_cutoff_params[1],je=Me.uniformValues.u_cutoff_params[2],qe=Me.uniformValues.u_cutoff_params[3];return Fe===Oe||qe===je?1:F.ay(((Le-Oe)/(Fe-Oe)-je)/(qe-je),0,1)}function zn(Me,Le,Oe,Fe){if(Le.pitch<20)return 1;const je=Le.getWorldToCameraMatrix();F.ad.mat4.multiply(je,je,Me);const qe=F.ad.vec4.fromValues(Oe.min[0],Oe.min[1],Oe.min[2],1);let He=F.ad.vec4.transformMat4(F.ad.vec4.create(),qe,je),xt=He,Pt=He;qe[1]=Oe.max[1],He=F.ad.vec4.transformMat4(F.ad.vec4.create(),qe,je),xt=He[1]<xt[1]?He:xt,Pt=He[1]>Pt[1]?He:Pt,qe[0]=Oe.max[0],He=F.ad.vec4.transformMat4(F.ad.vec4.create(),qe,je),xt=He[1]<xt[1]?He:xt,Pt=He[1]>Pt[1]?He:Pt,qe[1]=Oe.min[1],He=F.ad.vec4.transformMat4(F.ad.vec4.create(),qe,je),xt=He[1]<xt[1]?He:xt,Pt=He[1]>Pt[1]?He:Pt;const jt=F.ay(Fe[0],0,1),Gt=100*Le.pixelsPerMeter*F.ay(Fe[1],0,1),bi=F.ay(Fe[2],0,1),wi=F.ad.vec4.lerp(F.ad.vec4.create(),xt,Pt,jt),qr=Math.tan(.5*Le.fovX),Xn=-wi[2]*qr;if(0===Gt)return wi[1]<-Math.abs(Xn)?bi:1;const Yn=(-Math.abs(Xn)-wi[1])/Gt,g=(F,Me,Le)=>(1-Le)*F+Le*Me,yo=F.ay(g(1,bi,Yn),bi,1);return g(1,yo,F.ay((Le.pitch-20)/20,0,1))}class On{}class Fn{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(Me,Le,Oe){{const F=this._storage.get(Le.id);if(F)return F.lastUsedFrameIdx=Me,F.buf}const Fe=Oe.gl,je=Fe.getBufferParameter(Fe.ELEMENT_ARRAY_BUFFER,Fe.BUFFER_SIZE),qe=new ArrayBuffer(je),He=new Int16Array(qe);Fe.getBufferSubData(Fe.ELEMENT_ARRAY_BUFFER,0,new Int16Array(qe));const xt=new F.dt;for(let F=0;F<je/2;F+=3){const Me=He[F],Le=He[F+1],Oe=He[F+2];xt.emplaceBack(Me,Le),xt.emplaceBack(Le,Oe),xt.emplaceBack(Oe,Me)}const Pt=Oe.bindVertexArrayOES.current,jt=new On;return jt.buf=new Sr(Oe,xt),jt.lastUsedFrameIdx=Me,this._storage.set(Le.id,jt),Oe.bindVertexArrayOES.set(Pt),jt.buf}update(F){for(const[Me,Le]of this._storage)F-Le.lastUsedFrameIdx>30&&(Le.buf.destroy(),this._storage.delete(Me))}destroy(){for(const[F,Me]of this._storage)Me.buf.destroy(),this._storage.delete(F)}}class kn{constructor(F){this.occluderSize=30,this.depthOffset=-1e-4,F.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),F.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const uf=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Nn{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Un{constructor(F,Me){this.revealStart=11,this.revealRange=2,F.registerParameter(this,[...Me,"Reveal"],"revealStart",{min:0,max:17,step:.05}),F.registerParameter(this,[...Me,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const df=F.dd([{type:"Float32",name:"a_pos_2f",components:2}]);class Gn{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(Me,Le){const Oe=Me.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const Le=new F.du,Oe=new F.aV;Le.emplaceBack(-1,-1),Le.emplaceBack(1,-1),Le.emplaceBack(1,1),Le.emplaceBack(-1,1),Oe.emplaceBack(0,1,2),Oe.emplaceBack(0,2,3),this.vignetteVx=Me.context.createVertexBuffer(Le,df.members),this.vignetteIdx=Me.context.createIndexBuffer(Oe)}const Fe=F.b8.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){Me.uploadCommonUniforms(Me.context,Oe);const F={u_vignetteShape:(je={vignetteShape:[Le.start,Le.range,Math.pow(10,Le.fadePower)],vignetteColor:[Le.color.r,Le.color.g,Le.color.b,Le.color.a*Le.strength]}).vignetteShape,u_vignetteColor:je.vignetteColor};Oe.draw(Me,Me.context.gl.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,F,"vignette",this.vignetteVx,this.vignetteIdx,Fe)}var je}}class jn{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(Me,Le){const Oe=Me.getFreeCameraOptions().position,Fe=Oe.toAltitude(),je=Oe.toLngLat(),qe=F.ak(je.lng),He=F.ak(je.lat),xt=Me.pixelsPerMeter/Le,Pt=qe*F.dv,jt=F.dv*Math.log(Math.tan(Math.PI/4+He/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const F=-this._offsetYPrev+jt,Me=-this._elevationPrev+Fe;this._accumulatedOffsetX+=(-this._offsetXPrev+Pt)*xt,this._accumulatedOffsetY+=F*xt,this._accumulatedElevation+=Me*xt,this._offsetXPrev=Pt,this._offsetYPrev=jt,this._elevationPrev=Fe}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function qn(F,Me){return[-(F[0]-Math.floor(F[0]/Me)*Me),-(F[1]-Math.floor(F[1]/Me)*Me),-(F[2]-Math.floor(F[2]/Me)*Me)]}function Hn(Me){const Le=F.dl(1323123451230),Oe=[];for(let Fe=0;Fe<Me;++Fe){const Me=2*Le()-1,Fe=2*Le()-1,je=2*Le()-1;Oe.push(F.ad.vec3.fromValues(Me,Fe,je))}return Oe}function Zn(Me,Le,Oe,Fe,je){const qe=F.ay((je-Oe)/(Fe-Oe),0,1);return(1-qe)*Me+qe*Le}class Wn{constructor(F){this._movement=new jn,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Gn,this._ppmScaleFactor=F}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(Me,Le){const Oe=Me.transform;this._movement.update(Oe,this._ppmScaleFactor);const Fe=Oe.starsProjMatrix,je=F.ad.quat.identity([]);F.ad.quat.rotateX(je,je,F.ak(90)-Oe._pitch),F.ad.quat.rotateZ(je,je,-Oe.angle);const qe=F.ad.mat4.fromQuat(new Float32Array(16),je),He=F.ad.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),xt=F.ad.mat4.transpose([],He),Pt=F.ad.mat4.multiply([],xt,qe),jt=Date.now()/1e3;return this._accumulatedTimeFromStart+=(jt-this._prevTime)*Le,this._prevTime=jt,{projectionMatrix:Fe,modelviewMatrix:Pt}}}class $n extends Wn{constructor(F){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Un(F.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(Me){const Le=Me.context;if(!this.particlesVx){const Me=Hn(this.particlesCount),Oe=new F.dw,Fe=new F.aV;let je=0;const qe=F.dl(1323123451230);for(let F=0;F<Me.length;++F){const Le=Me[F],He=[2*qe()-1,qe(),qe(),qe()];Oe.emplaceBack(Le[0],Le[1],Le[2],-1,-1,...He),Oe.emplaceBack(Le[0],Le[1],Le[2],1,-1,...He),Oe.emplaceBack(Le[0],Le[1],Le[2],1,1,...He),Oe.emplaceBack(Le[0],Le[1],Le[2],-1,1,...He),Fe.emplaceBack(je+0,je+1,je+2),Fe.emplaceBack(je+0,je+2,je+3),je+=4}this.particlesVx=Le.createVertexBuffer(Oe,uf.members),this.particlesIdx=Le.createIndexBuffer(Fe)}}draw(Me){if(!this._params.overrideStyleParameters&&!Me.style.rain)return;const Le=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},Oe=Me.transform.zoom;if(Le.revealStart>Oe)return;const Fe=Zn(0,1,Le.revealStart,Le.revealStart+Le.revealRange,Oe);if(!this.particlesVx||!this.particlesIdx)return;const je=structuredClone(this._params);let qe=[-je.direction.x,je.direction.y,-100];F.ad.vec3.normalize(qe,qe);const He=structuredClone(this._vignetteParams);He.strength*=Fe,je.overrideStyleParameters||(je.intensity=Me.style.rain.state.density,je.timeFactor=Me.style.rain.state.intensity,je.color=structuredClone(Me.style.rain.state.color),qe=structuredClone(Me.style.rain.state.direction),je.screenThinning.intensity=Me.style.rain.state.centerThinning,je.dropletSizeX=Me.style.rain.state.dropletSize[0],je.dropletSizeYScale=Me.style.rain.state.dropletSize[1]/Me.style.rain.state.dropletSize[0],je.distortionStrength=100*Me.style.rain.state.distortionStrength,He.strength=1,He.color=structuredClone(Me.style.rain.state.vignetteColor));const xt=this.updateOnRender(Me,je.timeFactor),Pt=Me.context,jt=Pt.gl,Gt=Me.transform;this.screenTexture&&this.screenTexture.size[0]===Me.width&&this.screenTexture.size[1]===Me.height||(this.screenTexture=new F.T(Pt,{width:Me.width,height:Me.height,data:null},jt.RGBA8)),je.distortionStrength>0&&(Pt.activeTexture.set(jt.TEXTURE0),this.screenTexture.bind(jt.LINEAR,jt.CLAMP_TO_EDGE),jt.copyTexSubImage2D(jt.TEXTURE_2D,0,0,0,0,0,Me.width,Me.height));const bi=Me.getOrCreateProgram("rainParticle");Me.uploadCommonUniforms(Pt,bi),Pt.activeTexture.set(jt.TEXTURE0),this.screenTexture.bind(jt.LINEAR,jt.CLAMP_TO_EDGE);const wi=[je.color.r,je.color.g,je.color.b,je.color.a],p=(Le,Oe)=>{const Fe=qn(this._movement.getPosition(),Le),He=je.dropletSizeX,Pt=je.dropletSizeX*je.dropletSizeYScale,qr=Me.width/2,Xn=Me.height/2,Yn=Zn(0,je.screenThinning.start,0,1,je.screenThinning.intensity),yo=Zn(.001,je.screenThinning.range,0,1,je.screenThinning.intensity),bo=Zn(0,je.screenThinning.particleOffset,0,1,je.screenThinning.intensity),Ro=(Do={modelview:xt.modelviewMatrix,projection:xt.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:Fe,velocityConeAperture:je.velocityConeAperture,velocity:je.velocity,boxSize:Le,rainDropletSize:[He,Pt],distortionStrength:je.distortionStrength,rainDirection:qe,color:wi,screenSize:[Gt.width,Gt.height],thinningCenterPos:[qr,Xn],thinningShape:[Yn,yo,Math.pow(10,je.screenThinning.fadePower)],thinningAffectedRatio:je.screenThinning.affectedRatio,thinningParticleOffset:bo,shapeDirectionalPower:je.shapeDirPower,shapeNormalPower:je.shapeNormalPower,mode:Oe?0:1},{u_modelview:Float32Array.from(Do.modelview),u_projection:Float32Array.from(Do.projection),u_time:Do.time,u_cam_pos:Do.camPos,u_texScreen:0,u_velocityConeAperture:Do.velocityConeAperture,u_velocity:Do.velocity,u_boxSize:Do.boxSize,u_rainDropletSize:Do.rainDropletSize,u_distortionStrength:Do.distortionStrength,u_rainDirection:Do.rainDirection,u_color:Do.color,u_screenSize:Do.screenSize,u_thinningCenterPos:Do.thinningCenterPos,u_thinningShape:Do.thinningShape,u_thinningAffectedRatio:Do.thinningAffectedRatio,u_thinningParticleOffset:Do.thinningParticleOffset,u_shapeDirectionalPower:Do.shapeDirectionalPower,u_shapeNormalPower:Do.shapeNormalPower,u_mode:Do.mode});var Do;const zs=Math.round(je.intensity*this.particlesCount),Zs=F.b8.simpleSegment(0,0,4*zs,2*zs);bi.draw(Me,jt.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,Ro,"rain_particles",this.particlesVx,this.particlesIdx,Zs)};je.distortionStrength>0&&p(je.boxSize,!0),p(je.boxSize,!1),this._vignette.draw(Me,He)}}const pf=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class Kn extends Wn{constructor(F){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Un(F.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(Me){const Le=Me.context;if(!this.particlesVx){const Me=Hn(this.particlesCount),Oe=new F.dx,Fe=new F.aV;let je=0;const qe=F.dl(1323123451230);for(let F=0;F<Me.length;++F){const Le=Me[F],He=qe(),xt=qe(),Pt=qe(),jt=[F/Me.length,He,xt,Pt],Gt=[qe(),qe()];Oe.emplaceBack(Le[0],Le[1],Le[2],-1,-1,...jt,...Gt),Oe.emplaceBack(Le[0],Le[1],Le[2],1,-1,...jt,...Gt),Oe.emplaceBack(Le[0],Le[1],Le[2],1,1,...jt,...Gt),Oe.emplaceBack(Le[0],Le[1],Le[2],-1,1,...jt,...Gt),Fe.emplaceBack(je+0,je+1,je+2),Fe.emplaceBack(je+0,je+2,je+3),je+=4}this.particlesVx=Le.createVertexBuffer(Oe,pf.members),this.particlesIdx=Le.createIndexBuffer(Fe)}}draw(Me){if(!this._params.overrideStyleParameters&&!Me.style.snow)return;const Le=structuredClone(this._params);let Oe=[-Le.direction.x,Le.direction.y,-100];F.ad.vec3.normalize(Oe,Oe);const Fe=structuredClone(this._vignetteParams),je=Le.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},qe=Me.transform.zoom;if(je.revealStart>qe)return;const He=Zn(0,1,je.revealStart,je.revealStart+je.revealRange,qe);Fe.strength*=He,Le.overrideStyleParameters||(Le.intensity=Me.style.snow.state.density,Le.timeFactor=Me.style.snow.state.intensity,Le.color=structuredClone(Me.style.snow.state.color),Oe=structuredClone(Me.style.snow.state.direction),Le.screenThinning.intensity=Me.style.snow.state.centerThinning,Le.billboardSize=2.79*Me.style.snow.state.flakeSize,Fe.strength=1,Fe.color=structuredClone(Me.style.snow.state.vignetteColor));const xt=this.updateOnRender(Me,Le.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const Pt=Me.context,jt=Pt.gl,Gt=Me.transform,bi=Me.getOrCreateProgram("snowParticle");Me.uploadCommonUniforms(Pt,bi),((Le,Fe,je)=>{const qe=qn(this._movement.getPosition(),Le),He=Gt.width/2,Pt=Gt.height/2,wi=Zn(0,je.screenThinning.start,0,1,je.screenThinning.intensity),qr=Zn(.001,je.screenThinning.range,0,1,je.screenThinning.intensity),Xn=Zn(0,je.screenThinning.particleOffset,0,1,je.screenThinning.intensity),Yn=(yo={modelview:xt.modelviewMatrix,projection:xt.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:qe,velocityConeAperture:je.velocityConeAperture,velocity:je.velocity,horizontalOscillationRadius:je.horizontalOscillationRadius,horizontalOscillationRate:je.horizontalOscillationRate,boxSize:Le,billboardSize:1*je.billboardSize,simpleShapeParameters:[je.shapeFadeStart,je.shapeFadePower],screenSize:[Gt.width,Gt.height],thinningCenterPos:[He,Pt],thinningShape:[wi,qr,Math.pow(10,je.screenThinning.fadePower)],thinningAffectedRatio:je.screenThinning.affectedRatio,thinningParticleOffset:Xn,color:[je.color.r,je.color.g,je.color.b,je.color.a],direction:Oe},{u_modelview:Float32Array.from(yo.modelview),u_projection:Float32Array.from(yo.projection),u_time:yo.time,u_cam_pos:yo.camPos,u_velocityConeAperture:yo.velocityConeAperture,u_velocity:yo.velocity,u_horizontalOscillationRadius:yo.horizontalOscillationRadius,u_horizontalOscillationRate:yo.horizontalOscillationRate,u_boxSize:yo.boxSize,u_billboardSize:yo.billboardSize,u_simpleShapeParameters:yo.simpleShapeParameters,u_screenSize:yo.screenSize,u_thinningCenterPos:yo.thinningCenterPos,u_thinningShape:yo.thinningShape,u_thinningAffectedRatio:yo.thinningAffectedRatio,u_thinningParticleOffset:yo.thinningParticleOffset,u_particleColor:yo.color,u_direction:yo.direction});var yo;const bo=Math.round(je.intensity*this.particlesCount),Ro=F.b8.simpleSegment(0,0,4*bo,2*bo);this.particlesVx&&this.particlesIdx&&bi.draw(Me,jt.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,Yn,"snow_particles",this.particlesVx,this.particlesIdx,Ro)})(Le.boxSize,0,Le),this._vignette.draw(Me,Fe)}}const ff={symbol:function(Me,Le,Oe,Fe,je){if("translucent"!==Me.renderPass)return;const qe=Ui.disabled,He=Me.colorModeForRenderPass(),xt=Oe.layout.get("text-variable-anchor"),Pt=Oe.layout.get("text-size-scale-range"),jt=F.ay(Me.scaleFactor,Pt[0],Pt[1]);xt&&function(Me,Le,Oe,Fe,je,qe,He,xt){const Pt=Le.transform,jt="map"===je,Gt="map"===qe;for(const Le of Me){const Me=Fe.getTile(Le),je=Me.getBucket(Oe);if(!je||!je.text||!je.text.segments.get().length)continue;const qe=F.bp(je.textSizeData,Pt.zoom,xt),bi=ci(Le,je.getProjection(),Pt),wi=Pt.calculatePixelsToTileUnitsMatrix(Me),qr=qt(bi,Me.tileID.canonical,Gt,jt,Pt,je.getProjection(),wi),Xn=je.hasIconTextFit()&&je.hasIconData();if(qe){const Oe=Math.pow(2,Pt.zoom-Me.tileID.overscaledZ);Or(je,jt,Gt,He,F.cY,Pt,qr,Le,Oe,qe,Xn)}}}(Fe,Me,Oe,Le,Oe.layout.get("text-rotation-alignment"),Oe.layout.get("text-pitch-alignment"),je,jt);const Gt=0!==Oe.paint.get("icon-opacity").constantOr(1),bi=0!==Oe.paint.get("text-opacity").constantOr(1);void 0!==Oe.layout.get("symbol-sort-key").constantOr(1)&&(Gt||bi)?Fr(Me,Le,Oe,Fe,qe,He):(Gt&&Fr(Me,Le,Oe,Fe,qe,He,{onlyIcons:!0}),bi&&Fr(Me,Le,Oe,Fe,qe,He,{onlyText:!0})),Le.map.showCollisionBoxes&&(Lr(Me,Le,Oe,Fe,Oe.paint.get("text-translate"),Oe.paint.get("text-translate-anchor"),!0),Lr(Me,Le,Oe,Fe,Oe.paint.get("icon-translate"),Oe.paint.get("icon-translate-anchor"),!1))},circle:function(Me,Le,Oe,Fe){if("translucent"!==Me.renderPass)return;const je=Oe.paint.get("circle-opacity"),qe=Oe.paint.get("circle-stroke-width"),He=Oe.paint.get("circle-stroke-opacity"),xt=void 0!==Oe.layout.get("circle-sort-key").constantOr(1),Pt=Oe.paint.get("circle-emissive-strength");if(0===je.constantOr(1)&&(0===qe.constantOr(1)||0===He.constantOr(1)))return;const jt=Me.context,Gt=jt.gl,bi=Me.transform,wi=Me.depthModeForSublayer(0,Bi.ReadOnly),qr=Ui.disabled,Xn=Me.colorModeForDrapableLayerRenderPass(Pt),Yn="globe"===bi.projection.name,yo=[F.av(bi.center.lng),F.aC(bi.center.lat)],bo=[];for(let je=0;je<Fe.length;je++){const qe=Fe[je],He=Le.getTile(qe),Pt=He.getBucket(Oe);if(!Pt||Pt.projection.name!==bi.projection.name)continue;const jt=Pt.programConfigurations.get(Oe.id),Gt=F.cZ(Oe),wi=Me.isTileAffectedByFog(qe);Yn&&Gt.push("PROJECTION_GLOBE_VIEW"),Gt.push("DEPTH_D24"),Me.terrain&&bi.depthOcclusionForSymbolsAndCircles&&Gt.push("DEPTH_OCCLUSION");const qr=Me.getOrCreateProgram("circle",{config:jt,defines:Gt,overrideFog:wi}),Xn=Pt.layoutVertexBuffer,Ro=Pt.globeExtVertexBuffer,Do=Pt.indexBuffer,zs=bi.projection.createInversionMatrix(bi,qe.canonical),Zs={programConfiguration:jt,program:qr,layoutVertexBuffer:Xn,globeExtVertexBuffer:Ro,indexBuffer:Do,uniformValues:F.c_(Me,qe,He,zs,yo,Oe),tile:He};if(xt){const Me=Pt.segments.get();for(const Le of Me)bo.push({segments:new F.b8([Le]),sortKey:Le.sortKey,state:Zs})}else bo.push({segments:Pt.segments,sortKey:0,state:Zs})}xt&&bo.sort(((F,Me)=>F.sortKey-Me.sortKey));const Ro={useDepthForOcclusion:bi.depthOcclusionForSymbolsAndCircles};for(const F of bo){const{programConfiguration:Le,program:Fe,layoutVertexBuffer:je,globeExtVertexBuffer:qe,indexBuffer:He,uniformValues:xt,tile:Pt}=F.state,Yn=F.segments;Me.terrain&&Me.terrain.setupElevationDraw(Pt,Fe,Ro),Me.uploadCommonUniforms(jt,Fe,Pt.tileID.toUnwrapped()),Fe.draw(Me,Gt.TRIANGLES,wi,qr,Xn,ji.disabled,xt,Oe.id,je,He,Yn,Oe.paint,bi.zoom,Le,[qe])}},heatmap:function(Me,Le,Oe,Fe){if(0!==Oe.paint.get("heatmap-opacity"))if("offscreen"===Me.renderPass){const je=Me.context,qe=je.gl,He=Ui.disabled,xt=new ki([qe.ONE,qe.ONE,qe.ONE,qe.ONE],F.al.transparent,[!0,!0,!0,!0]);!function(F,Me,Le,Oe){const Fe=F.gl,je=Me.width*Oe,qe=Me.height*Oe;F.activeTexture.set(Fe.TEXTURE1),F.viewport.set([0,0,je,qe]);let He=Le.heatmapFbo;if(!He||He&&(He.width!==je||He.height!==qe)){He&&He.destroy();const Me=Fe.createTexture();Fe.bindTexture(Fe.TEXTURE_2D,Me),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_S,Fe.CLAMP_TO_EDGE),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_T,Fe.CLAMP_TO_EDGE),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MIN_FILTER,Fe.LINEAR),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MAG_FILTER,Fe.LINEAR),He=Le.heatmapFbo=F.createFramebuffer(je,qe,!0,null),function(F,Me,Le,Oe,Fe,je){const qe=F.gl;qe.texImage2D(qe.TEXTURE_2D,0,F.extRenderToTextureHalfFloat?qe.RGBA16F:qe.RGBA,Fe,je,0,qe.RGBA,F.extRenderToTextureHalfFloat?qe.HALF_FLOAT:qe.UNSIGNED_BYTE,null),Oe.colorAttachment.set(Le)}(F,0,Me,He,je,qe)}else Fe.bindTexture(Fe.TEXTURE_2D,He.colorAttachment.get()),F.bindFramebuffer.set(He.framebuffer)}(je,Me,Oe,"globe"===Me.transform.projection.name?.5:.25),je.clear({color:F.al.transparent});const Pt=Me.transform,jt="globe"===Pt.projection.name,Gt=jt?["PROJECTION_GLOBE_VIEW"]:[],bi=jt?ji.frontCCW:ji.disabled,wi=[F.av(Pt.center.lng),F.aC(Pt.center.lat)];for(let F=0;F<Fe.length;F++){const qr=Fe[F];if(Le.hasRenderableParent(qr))continue;const Xn=Le.getTile(qr),Yn=Xn.getBucket(Oe);if(!Yn||Yn.projection.name!==Pt.projection.name)continue;const yo=Me.isTileAffectedByFog(qr),bo=Yn.programConfigurations.get(Oe.id),Ro=Me.getOrCreateProgram("heatmap",{config:bo,defines:Gt,overrideFog:yo}),{zoom:Do}=Me.transform;Me.terrain&&Me.terrain.setupElevationDraw(Xn,Ro),Me.uploadCommonUniforms(je,Ro,qr.toUnwrapped());const zs=Pt.projection.createInversionMatrix(Pt,qr.canonical);Ro.draw(Me,qe.TRIANGLES,Bi.disabled,He,xt,bi,lr(Me,qr,Xn,zs,wi,Do,Oe.paint.get("heatmap-intensity")),Oe.id,Yn.layoutVertexBuffer,Yn.indexBuffer,Yn.segments,Oe.paint,Me.transform.zoom,bo,jt?[Yn.globeExtVertexBuffer]:null)}je.viewport.set([0,0,Me.width,Me.height])}else"translucent"===Me.renderPass&&(Me.context.setColorMode(Me.colorModeForRenderPass()),function(Me,Le){const Oe=Me.context,Fe=Oe.gl,je=Le.heatmapFbo;if(!je)return;Oe.activeTexture.set(Fe.TEXTURE0),Fe.bindTexture(Fe.TEXTURE_2D,je.colorAttachment.get()),Oe.activeTexture.set(Fe.TEXTURE1);let qe=Le.colorRampTexture;qe||(qe=Le.colorRampTexture=new F.T(Oe,Le.colorRamp,Fe.RGBA8)),qe.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE),Me.getOrCreateProgram("heatmapTexture").draw(Me,Fe.TRIANGLES,Bi.disabled,Ui.disabled,Me.colorModeForRenderPass(),ji.disabled,((F,Me)=>({u_image:0,u_color_ramp:1,u_opacity:Me.paint.get("heatmap-opacity")}))(0,Le),Le.id,Me.viewportBuffer,Me.quadTriangleIndexBuffer,Me.viewportSegments,Le.paint,Me.transform.zoom)}(Me,Oe))},line:function(Me,Le,Oe,Fe){if("translucent"!==Me.renderPass)return;const je=Oe.paint.get("line-opacity"),qe=Oe.paint.get("line-width");if(0===je.constantOr(1)||0===qe.constantOr(1))return;const He=Oe.paint.get("line-emissive-strength"),xt=Oe.paint.get("line-occlusion-opacity"),Pt=Oe.layout.get("line-elevation-reference"),jt="meters"===Oe.layout.get("line-width-unit"),Gt="sea"===Pt,bi=Me.context,wi=bi.gl;if(Oe.hasElevatedBuckets&&"globe"===Me.transform.projection.name)return;const qr=Oe.layout.get("line-cross-slope"),Xn=void 0!==qr,Yn=qr<1,yo=Me.colorModeForDrapableLayerRenderPass(He),bo=Me.terrain&&Me.terrain.renderingToTexture,Ro=bo?1:F.q.devicePixelRatio,Do=Oe.paint.get("line-dasharray"),zs=Do.constantOr(1),Zs=Oe.layout.get("line-cap"),na=Do.constantOr(null),el=Zs.constantOr(null),nl=Oe.paint.get("line-pattern"),hl=nl.constantOr(1),pl=nl.constantOr(null),bl=Oe.paint.get("line-opacity").constantOr(1);let Tl=!hl&&1!==bl||Me.depthOcclusion&&xt>0&&xt<1;const kl=Oe.paint.get("line-gradient"),ec=hl?"linePattern":"line",tc=F.c$(Oe);let ic;if(bo&&Me.terrain&&Me.terrain.clipOrMaskOverlapStencilType()&&(Tl=!1),0!==xt&&Me.depthOcclusion){const Me=Oe.paint._values["line-opacity"];Me&&Me.value&&"constant"===Me.value.kind?ic=Me.value:F.w(`Occlusion opacity for layer ${Oe.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==qe.value.kind&&!1===qe.value.isLineProgressConstant&&tc.push("VARIABLE_LINE_WIDTH");const z=(Fe,je,qe,He,Pt,qr)=>{for(const Xn of Fe){const Fe=Le.getTile(Xn);if(hl&&!Fe.patternsLoaded())continue;const Yn=Fe.getBucket(Oe);if(!Yn)continue;if(Yn.hasZOffset&&!Pt||!Yn.hasZOffset&&Pt)continue;Me.prepareDrawTile();const Do=Yn.programConfigurations.get(Oe.id),Zs=Me.isTileAffectedByFog(Xn),nl=Me.getOrCreateProgram(ec,{config:Do,defines:je,overrideFog:Zs,overrideRtt:!Pt&&void 0});if(pl&&Fe.imageAtlas){const Me=F.d0.from(pl).getPrimary().scaleSelf(Ro).toString(),Le=Fe.imageAtlas.patternPositions.get(Me);Le&&Do.setConstantPatternPositions(Le)}if(!hl&&na&&el&&Fe.lineAtlas){const F=Fe.lineAtlas.getDash(na,el);F&&Do.setConstantPatternPositions(F)}let[tc,oc]=Oe.paint.get("line-trim-offset");if("round"===el||"square"===el){const F=1;tc!==oc&&(0===tc&&(tc-=F),1===oc&&(oc+=F))}const sc=bo?Xn.projMatrix:null,ac=jt?1/Yn.tileToMeter/F.at(Fe,1,Me.transform.zoom):1,mc=jt?1/Yn.tileToMeter/F.at(Fe,1,Math.floor(Me.transform.zoom)):1,gc=hl?F.d1(Me,Fe,Oe,sc,Ro,ac,mc,[tc,oc]):F.d2(Me,Fe,Oe,sc,Yn.lineClipsArray.length,Ro,ac,mc,[tc,oc]);if(kl){const Fe=Yn.gradients[Oe.id];let je=Fe.texture;if(Oe.gradientVersion!==Fe.version){let qe=256;if(Oe.stepInterpolant){const Oe=Le.getSource().maxzoom,Fe=Xn.canonical.z===Oe?Math.ceil(1<<Me.transform.maxZoom-Xn.canonical.z):1;qe=F.ay(F.d3(Yn.maxLineLength/F.ai*1024*Fe),256,bi.maxTextureSize)}Fe.gradient=F.d4({expression:Oe.gradientExpression(),evaluationKey:"lineProgress",resolution:qe,image:Fe.gradient||void 0,clips:Yn.lineClipsArray}),Fe.texture?Fe.texture.update(Fe.gradient):Fe.texture=new F.T(bi,Fe.gradient,wi.RGBA8),Fe.version=Oe.gradientVersion,je=Fe.texture}bi.activeTexture.set(wi.TEXTURE1),je.bind(Oe.stepInterpolant?wi.NEAREST:wi.LINEAR,wi.CLAMP_TO_EDGE)}zs&&(bi.activeTexture.set(wi.TEXTURE0),Fe.lineAtlasTexture&&Fe.lineAtlasTexture.bind(wi.LINEAR,wi.REPEAT),Do.updatePaintBuffers()),hl&&(bi.activeTexture.set(wi.TEXTURE0),Fe.imageAtlasTexture&&Fe.imageAtlasTexture.bind(wi.LINEAR,wi.CLAMP_TO_EDGE),Do.updatePaintBuffers()),Pt&&!Gt&&Me.terrain.setupElevationDraw(Fe,nl),Me.uploadCommonUniforms(bi,nl,Xn.toUnwrapped());const N=F=>{null!=ic&&(ic.value=bl*xt),nl.draw(Me,wi.TRIANGLES,qe,F,yo,ji.disabled,gc,Oe.id,Yn.layoutVertexBuffer,Yn.indexBuffer,Yn.segments,Oe.paint,Me.transform.zoom,Do,[Yn.layoutVertexBuffer2,Yn.patternVertexBuffer,Yn.zOffsetVertexBuffer]),null!=ic&&(ic.value=bl)};if(Tl&&!Pt){const F=Me.stencilModeForClipping(Xn).ref;0===F&&bo&&bi.clear({stencil:0});const Le={func:wi.EQUAL,mask:255};gc.u_alpha_discard_threshold=.8,N(new Ui(Le,F,255,wi.KEEP,wi.KEEP,wi.INVERT)),gc.u_alpha_discard_threshold=0,N(new Ui(Le,F,255,wi.KEEP,wi.KEEP,wi.KEEP))}else gc.u_alpha_discard_threshold=Tl&&Pt&&qr?.8:0,N(Pt?He:Me.stencilModeForClipping(Xn))}};if(Oe.hasNonElevatedBuckets){const Le=!bo&&Me.terrain;0!==xt&&Le?F.w(`Occlusion opacity for layer ${Oe.id} is supported on terrain only if the layer has line-z-offset enabled.`):Le?F.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${Oe.id}.`):z(Fe,tc,Me.depthModeForSublayer(0,Bi.ReadOnly),Ui.disabled,!1,!0)}if(Oe.hasElevatedBuckets){tc.push("ELEVATED"),Xn&&tc.push(Yn?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),Gt&&tc.push("ELEVATION_REFERENCE_SEA");const F=Tl?Me.stencilModeFor3D():Ui.disabled,Le=new Bi(Me.depthOcclusion?wi.GREATER:wi.LEQUAL,Bi.ReadOnly,Me.depthRangeFor3D);Me.forceTerrainMode=!0,z(Fe,tc,Le,F,!0,!0),Tl&&z(Fe,tc,Le,F,!0,!1),Me.forceTerrainMode=!1}Tl&&(Me.resetStencilClippingMasks(),bo&&bi.clear({stencil:0})),0===xt||Me.depthOcclusion||bo||Me.layersWithOcclusionOpacity.push(Me.currentLayer)},fill:function(Me,Le,Oe,Fe){const je=Oe.paint.get("fill-color"),qe=Oe.paint.get("fill-opacity");if(0===qe.constantOr(1))return;const He=Oe.paint.get("fill-emissive-strength"),xt=Me.colorModeForDrapableLayerRenderPass(He),Pt=Oe.paint.get("fill-pattern"),jt=Me.opaquePassEnabledForLayer()&&!Pt.constantOr(1)&&1===je.constantOr(F.al.transparent).a&&1===qe.constantOr(0)?"opaque":"translucent";let Gt="none";"none"!==Oe.layout.get("fill-elevation-reference")?Gt="road":0!==Oe.paint.get("fill-z-offset").constantOr(1)&&(Gt="offset");const bi=!(!Me.terrain||!Me.terrain.enabled),wi={painter:Me,sourceCache:Le,layer:Oe,coords:Fe,colorMode:xt,elevationType:Gt,terrainEnabled:bi,pass:jt};if("offset"!==Gt){if(Ur(wi,!1),"road"===Gt){const F=!bi&&"translucent"===Me.renderPass;F&&Nr(Me,Le,Oe,Fe,"geometry"),Ur(wi,!0,Ui.disabled),F&&function(F){const{painter:Me,sourceCache:Le,layer:Oe,coords:Fe,colorMode:je}=F,qe=Me.context.gl,He=new Bi(Me.context.gl.LEQUAL,Bi.ReadOnly,Me.depthRangeFor3D);for(const F of Fe){const Fe=Le.getTile(F),xt=Fe.getBucket(Oe);if(!xt)continue;const Pt=xt.elevatedStructures;if(!Pt||!Pt.renderableSegments||0===Pt.renderableSegments.segments[0].primitiveLength)continue;Me.prepareDrawTile();const jt=xt.bufferData.programConfigurations.get(Oe.id),Gt=Me.isTileAffectedByFog(F),bi=Me.getOrCreateProgram("elevatedStructures",{config:jt,overrideFog:Gt,defines:["NORMAL_OFFSET"]}),wi={u_matrix:Me.translatePosMatrix(F.projMatrix,Fe,Oe.paint.get("fill-translate"),Oe.paint.get("fill-translate-anchor"))};Me.uploadCommonUniforms(Me.context,bi,F.toUnwrapped()),bi.draw(Me,qe.TRIANGLES,He,Ui.disabled,je,ji.backCCW,wi,Oe.id,Pt.vertexBuffer,Pt.indexBuffer,Pt.renderableSegments,Oe.paint,Me.transform.zoom,jt,[Pt.vertexBufferNormal])}}(wi)}}else Ur(wi,!1,Me.stencilModeFor3D())},"fill-extrusion":function(Me,Le,Oe,Fe){const je=Oe.paint.get("fill-extrusion-opacity"),qe=Me.context,He=qe.gl,xt=Me.terrain,Pt=xt&&xt.renderingToTexture;if(0===je)return;const jt=Me.conflationActive&&Me.style.isLayerClipped(Oe,Le.getSource()),Gt=Me.style.order.indexOf(Oe.fqid);if(jt&&function(F,Me,Le,Oe,Fe){for(const je of Oe){const Oe=Me.getTile(je).getBucket(Le);Oe&&(Oe.updateReplacement(je,F.replacementSource,Fe),Oe.uploadCentroid(F.context))}}(Me,Le,Oe,Fe,Gt),xt||jt)for(const F of Fe){const Fe=Le.getTile(F).getBucket(Oe);Fe&&jr(Me.context,Le,F,Fe,Oe,xt,jt)}if("shadow"===Me.renderPass&&Me.shadowRenderer){const qe=Me.shadowRenderer;if(xt&&je<.65&&Oe._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof F.ab)return;const He=qe.getShadowPassDepthMode(),Pt=qe.getShadowPassColorMode();Vr(Me,Le,Oe,Fe,He,Ui.disabled,Pt,jt)}else if("translucent"===Me.renderPass){const Gt=!Oe.paint.get("fill-extrusion-pattern").constantOr(1),bi=Oe.paint.get("fill-extrusion-color").constantOr(F.al.white);if(!Pt&&0!==bi.a){const F=new Bi(Me.context.gl.LEQUAL,Bi.ReadWrite,Me.depthRangeFor3D);1===je&&Gt?Vr(Me,Le,Oe,Fe,F,Ui.disabled,ki.unblended,jt):(Vr(Me,Le,Oe,Fe,F,Ui.disabled,ki.disabled,jt),Vr(Me,Le,Oe,Fe,F,Me.stencilModeFor3D(),Me.colorModeForRenderPass(),jt),Me.resetStencilClippingMasks())}if(Me.style.enable3dLights()&&Gt&&(!xt&&"globe"!==Me.transform.projection.name||Pt)){const je=Oe.paint.get("fill-extrusion-opacity"),Gt=Oe.paint.get("fill-extrusion-ambient-occlusion-intensity"),bi=Oe.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),wi=Oe.paint.get("fill-extrusion-flood-light-intensity"),qr="none"===Oe.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),Xn=Oe.paint.get("fill-extrusion-flood-light-color").toRenderColor(qr?null:Oe.lut).toArray01().slice(0,3),Yn=Gt>0&&bi>0,yo=wi>0,v=(F,Me,Le)=>(1-Le)*F+Le*Me,y=qe=>{const xt=Me.depthModeForSublayer(1,Bi.ReadOnly,He.LEQUAL,!0),Pt=Oe.paint.get(qe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),qr=v(.1,3,Pt),Yn=Me._showOverdrawInspector;if(!Yn){const Pt=new Ui({func:He.ALWAYS,mask:255},255,255,He.KEEP,He.KEEP,He.REPLACE),Yn=new ki([He.ONE,He.ONE,He.ONE,He.ONE],F.al.transparent,[!1,!1,!1,!0],He.MIN);Gr(Me,Le,Oe,Fe,xt,Pt,Yn,ji.disabled,qe,"sdf",je,Gt,bi,wi,Xn,qr,jt,!1)}{const Pt=Yn?Ui.disabled:new Ui({func:He.EQUAL,mask:255},255,255,He.KEEP,He.DECR,He.DECR),yo=Yn?Me.colorModeForRenderPass():new ki([He.ONE_MINUS_DST_ALPHA,He.DST_ALPHA,He.ONE,He.ONE],F.al.transparent,[!0,!0,!0,!0]);Gr(Me,Le,Oe,Fe,xt,Pt,yo,ji.disabled,qe,"color",je,Gt,bi,wi,Xn,qr,jt,!1)}};if(Pt){const c=(qe,xt,Pt)=>{const qr=Me.depthModeForSublayer(1,Bi.ReadOnly,He.LEQUAL,!1),Yn=Oe.paint.get(qe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),yo=v(.1,3,Yn);{const Pt=new ki([He.ONE,He.ONE,He.ONE,He.ONE],F.al.transparent,[!1,!1,!1,!0]);Gr(Me,Le,Oe,Fe,qr,Ui.disabled,Pt,ji.disabled,qe,"clear",je,Gt,bi,wi,Xn,yo,jt,xt)}{const Pt=new Ui({func:He.ALWAYS,mask:255},255,255,He.KEEP,He.KEEP,He.REPLACE),Yn=new ki([He.ONE,He.ONE,He.ONE,He.ONE],F.al.transparent,[!1,!1,!1,!0],He.MIN);Gr(Me,Le,Oe,Fe,qr,Pt,Yn,ji.disabled,qe,"sdf",je,Gt,bi,wi,Xn,yo,jt,xt)}{const Pt=qe?He.ZERO:He.ONE_MINUS_DST_ALPHA,Yn=new Ui({func:He.EQUAL,mask:255},255,255,He.KEEP,He.DECR,He.DECR),bo=new ki([Pt,He.DST_ALPHA,He.ONE_MINUS_DST_ALPHA,He.ZERO],F.al.transparent,[!0,!0,!0,!0]);Gr(Me,Le,Oe,Fe,qr,Yn,bo,ji.disabled,qe,"color",je,Gt,bi,wi,Xn,yo,jt,xt)}{const Yn=new ki([He.ONE,He.ONE,He.ONE,qe?He.ZERO:He.ONE],F.al.transparent,[!1,!1,!1,!0],qe?He.FUNC_ADD:He.MAX);Gr(Me,Le,Oe,Fe,qr,Ui.disabled,Yn,ji.disabled,qe,"clear",je,Gt,bi,wi,Xn,yo,jt,xt,Pt)}};if(Yn||yo){let Le;if(Me.prepareDrawTile(),xt){const Me=xt.drapeBufferSize[0],Oe=xt.drapeBufferSize[1];Le=xt.framebufferCopyTexture,Le&&(!Le||Le.size[0]===Me&&Le.size[1]===Oe)||(Le&&Le.destroy(),Le=xt.framebufferCopyTexture=new F.T(qe,new F.r({width:Me,height:Oe}),He.RGBA8)),Le.bind(He.LINEAR,He.CLAMP_TO_EDGE),He.copyTexSubImage2D(He.TEXTURE_2D,0,0,0,0,0,Me,Oe)}Yn&&c(!0,!1,Le),yo&&c(!1,!0,Le)}}else Yn&&y(!0),yo&&y(!1),(Yn||yo)&&Me.resetStencilClippingMasks()}}},hillshade:function(F,Me,Le,Oe){if("offscreen"!==F.renderPass&&"translucent"!==F.renderPass)return;if(F.style.disableElevatedTerrain)return;const Fe=F.context,je=F.terrain&&F.terrain.renderingToTexture,[qe,He]="translucent"!==F.renderPass||je?[{},Oe]:F.stencilConfigForOverlap(Oe);for(const Oe of He){const Fe=Me.getTile(Oe);if(Fe.needsHillshadePrepare&&"offscreen"===F.renderPass)Wo(F,Fe,Le);else if("translucent"===F.renderPass){const Me=F.depthModeForSublayer(0,Bi.ReadOnly),He=Le.paint.get("hillshade-emissive-strength"),xt=F.colorModeForDrapableLayerRenderPass(He),Pt=je&&F.terrain?F.terrain.stencilModeForRTTOverlap(Oe):qe[Oe.overscaledZ];Ho(F,Oe,Fe,Le,Me,Pt,xt)}}Fe.viewport.set([0,0,F.width,F.height]),F.resetStencilClippingMasks()},raster:function(Me,Le,Oe,Fe,je,qe){if("translucent"!==Me.renderPass)return;if(0===Oe.paint.get("raster-opacity"))return;const He="globe"===Me.transform.projection.name,xt=0!==Oe.paint.get("raster-elevation"),Pt=xt&&He;if(Me.renderElevatedRasterBackface&&!Pt)return;const jt=Me.context,Gt=jt.gl,bi=Le.getSource(),wi=function(Me,Le,Oe,Fe){const je=Le.paint.get("raster-color"),qe="raster-array"===Me.type,He=[],xt=Le.paint.get("raster-resampling"),Pt=Le.paint.get("raster-color-mix");let jt=Le.paint.get("raster-color-range");const Gt=[Pt[0],Pt[1],Pt[2],0],bi=Pt[3];let wi="nearest"===xt?Fe.NEAREST:Fe.LINEAR;if(qe&&(He.push("RASTER_ARRAY"),je||He.push("RASTER_COLOR"),"linear"===xt&&He.push("RASTER_ARRAY_LINEAR"),wi=Fe.NEAREST,!jt&&Me.rasterLayers)){const F=Me.rasterLayers.find((({id:F})=>F===Le.sourceLayer));F&&F.fields&&F.fields.range&&(jt=F.fields.range)}if(jt=jt||[0,1],je){He.push("RASTER_COLOR"),Oe.activeTexture.set(Fe.TEXTURE2),Le.updateColorRamp(jt);let Me=Le.colorRampTexture;Me||(Me=Le.colorRampTexture=new F.T(Oe,Le.colorRamp,Fe.RGBA8)),Me.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE)}return{mix:Gt,range:jt,offset:bi,defines:He,resampling:wi}}(bi,Oe,jt,Gt);if(bi instanceof F.aK&&!Fe.length&&!He)return;const qr=Oe.paint.get("raster-emissive-strength"),Xn=Me.colorModeForDrapableLayerRenderPass(qr),Yn=Me.terrain&&Me.terrain.renderingToTexture,yo=!Me.options.moving,bo="nearest"===Oe.paint.get("raster-resampling")?Gt.NEAREST:Gt.LINEAR;if(bi instanceof F.aK&&!Fe.length&&(bi.onNorthPole||bi.onSouthPole)){const F=xt?Me.stencilModeFor3D():Ui.disabled;return void Xr(!!bi.onNorthPole,null,Me,Le,Oe,qr,wi,ji.disabled,F)}if(!Fe.length)return;const[Ro,Do]=bi instanceof F.aK||Yn?[{},Fe]:Me.stencilConfigForOverlap(Fe),zs=Do[Do.length-1].overscaledZ;Pt&&wi.defines.push("PROJECTION_GLOBE_VIEW"),xt&&wi.defines.push("RENDER_CUTOFF");const w=(Fe,je,Do)=>{for(const Zs of Fe){const Fe=Zs.toUnwrapped(),na=Le.getTile(Zs);if(Yn&&(!na||!na.hasData()))continue;jt.activeTexture.set(Gt.TEXTURE0);const el=Yr(na,bi,Oe,wi);if(!el||!el.texture)continue;const{texture:nl,mix:hl,offset:pl,tileSize:bl,buffer:Tl}=el;let kl,ec;Yn?(kl=Bi.disabled,ec=Zs.projMatrix):xt?(kl=new Bi(Gt.LEQUAL,Bi.ReadWrite,Me.depthRangeFor3D),ec=He?Float32Array.from(Me.transform.expandedFarZProjMatrix):Me.transform.calculateProjMatrix(Fe,yo)):(kl=Me.depthModeForSublayer(Zs.overscaledZ-zs,1===Oe.paint.get("raster-opacity")?Bi.ReadWrite:Bi.ReadOnly,Gt.LESS),ec=Me.transform.calculateProjMatrix(Fe,yo));const tc=Me.terrain&&Yn?Me.terrain.stencilModeForRTTOverlap(Zs):Ro[Zs.overscaledZ],ic=qe?0:Oe.paint.get("raster-fade-duration");na.registerFadeDuration(ic);const oc=Le.findLoadedParent(Zs,0),sc=Ns(na,oc,Le,Me.transform,ic);let ac,mc;Me.terrain&&Me.terrain.prepareDrawTile(),jt.activeTexture.set(Gt.TEXTURE0),nl.bind(bo,Gt.CLAMP_TO_EDGE),jt.activeTexture.set(Gt.TEXTURE1),oc?(oc.texture&&oc.texture.bind(bo,Gt.CLAMP_TO_EDGE),ac=Math.pow(2,oc.tileID.overscaledZ-na.tileID.overscaledZ),mc=[na.tileID.canonical.x*ac%1,na.tileID.canonical.y*ac%1]):nl.bind(bo,Gt.CLAMP_TO_EDGE),"useMipmap"in nl&&jt.extTextureFilterAnisotropic&&Me.transform.pitch>20&&Gt.texParameterf(Gt.TEXTURE_2D,jt.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,jt.extTextureFilterAnisotropicMax);const gc=Me.transform;let yc;const xc=xt?Kr(gc):[0,0,0,0];let Zc,Wc,Kc,Jc,Qc,eh=0;if(Pt&&bi instanceof F.aK&&bi.coordinates.length>3)Zc=Float32Array.from(F.bc(F.cI(new F.bT(0,0,0)))),Wc=Float32Array.from(gc.globeMatrix),Kc=Float32Array.from(F.cE(gc)),Jc=[F.av(gc.center.lng),F.aC(gc.center.lat)],yc=bi.elevatedGlobePerspectiveTransform,Qc=bi.elevatedGlobeGridMatrix||new Float32Array(9);else if(Pt){const Me=F.cF(Zs.canonical);eh=F.cG(Me.getCenter().lat),Zc=Float32Array.from(F.bc(F.cI(Zs.canonical))),Wc=Float32Array.from(gc.globeMatrix),Kc=Float32Array.from(F.cE(gc)),Jc=[F.av(gc.center.lng),F.aC(gc.center.lat)],yc=[0,0],Qc=Float32Array.from(F.cH(Zs.canonical,Me,eh,gc.worldSize/gc._pixelsPerMercatorPixel))}else yc=bi instanceof F.aK?bi.perspectiveTransform:[0,0],Zc=new Float32Array(16),Wc=new Float32Array(9),Kc=new Float32Array(16),Jc=[0,0],Qc=new Float32Array(9);const th=dr(ec,Zc,Wc,Kc,Qc,mc||[0,0],F.ag(Me.transform.zoom),Jc,xc,ac||1,sc,Oe,yc,xt?Oe.paint.get("raster-elevation"):0,2,hl,pl,wi.range,bl,Tl,qr),rh=Me.isTileAffectedByFog(Zs),oh=Me.getOrCreateProgram("raster",{defines:wi.defines,overrideFog:rh});if(Me.uploadCommonUniforms(jt,oh,Fe),bi instanceof F.aK){const Le=bi.elevatedGlobeVertexBuffer,Fe=bi.elevatedGlobeIndexBuffer;if(Yn||!He)bi.boundsBuffer&&bi.boundsSegments&&oh.draw(Me,Gt.TRIANGLES,kl,Ui.disabled,Xn,ji.disabled,th,Oe.id,bi.boundsBuffer,Me.quadTriangleIndexBuffer,bi.boundsSegments);else if(Le&&Fe){const qe=gc.zoom<=F.c6?bi.elevatedGlobeSegments:bi.getSegmentsForLongitude(gc.center.lng);qe&&oh.draw(Me,Gt.TRIANGLES,kl,Ui.disabled,Xn,je,th,Oe.id,Le,Fe,qe)}}else if(Pt){kl=new Bi(Gt.LEQUAL,Bi.ReadOnly,Me.depthRangeFor3D);const F=Me.globeSharedBuffers;if(F){const[Le,Fe,qe]=F.getGridBuffers(eh,!1);oh.draw(Me,Gt.TRIANGLES,kl,Do||tc,Me.colorModeForRenderPass(),je,th,Oe.id,Le,Fe,qe)}}else{const{tileBoundsBuffer:F,tileBoundsIndexBuffer:Le,tileBoundsSegments:Fe}=Me.getTileBoundsBuffers(na);oh.draw(Me,Gt.TRIANGLES,kl,tc,Xn,ji.disabled,th,Oe.id,F,Le,Fe)}}if(!(bi instanceof F.aK)&&Pt)for(const F of Fe){const Fe=F.canonical.y===(1<<F.canonical.z)-1;0===F.canonical.y&&Xr(!0,F,Me,Le,Oe,qr,wi,je,Do||Ui.disabled),Fe&&Xr(!1,F,Me,Le,Oe,qr,wi,je===ji.frontCW?ji.backCW:ji.frontCW,Do||Ui.disabled)}};Pt?w(Do,Me.renderElevatedRasterBackface?ji.backCW:ji.frontCW,Me.stencilModeFor3D()):w(Do,ji.disabled,void 0),Me.resetStencilClippingMasks()},"raster-particle":function(Me,Le,Oe,Fe,je,qe){"offscreen"===Me.renderPass&&function(Me,Le,Oe,Fe){if(!Fe.length)return;const je=Me.context,qe=je.gl,He=Le.getSource();if(!(He instanceof ot))return;const xt=Math.ceil(Math.sqrt(Oe.paint.get("raster-particle-count")));let Pt=Oe.particlePositionRGBAImage;if(!Pt||Pt.width!==xt){const Me=function(F){const Me=F*F,Le=new Uint8Array(4*Me),o=function(F){return F|=0,F=Math.imul(2747636419^F,2654435769),F=Math.imul(F^F>>>16,2654435769),((F=Math.imul(F^F>>>16,2654435769))>>>0)/4294967296},Oe=1/1.1;for(let F=0;F<Me;F++){const Me=Oe*(o(2*F+0)+sp),Fe=Oe*(o(2*F+1)+sp),je=255*Me%1,qe=255*Fe%1,He=je,xt=Fe-qe/255,Pt=qe;Le[4*F+0]=255*(Me-je/255),Le[4*F+1]=255*He,Le[4*F+2]=255*xt,Le[4*F+3]=255*Pt}return Le}(xt);Pt=Oe.particlePositionRGBAImage=new F.r({width:xt,height:xt},Me)}let jt=Oe.particleFramebuffer;jt?jt.width!==xt&&(jt.destroy(),jt=Oe.particleFramebuffer=je.createFramebuffer(xt,xt,!0,null)):jt=Oe.particleFramebuffer=je.createFramebuffer(xt,xt,!0,null);const Gt=[];for(const F of Fe){const Me=Le.getTile(F);if(!(Me instanceof wt))continue;const Fe=en(Me,He,Oe);if(!Fe)continue;const qe=[Me.tileSize,Me.tileSize];let jt=Oe.tileFramebuffer;jt||(jt=Oe.tileFramebuffer=je.createFramebuffer(qe[0],qe[1],!0,null));let bi=Me.rasterParticleState;bi||(bi=Me.rasterParticleState=new Qr(je,F,qe,Pt));const wi=bi.update(Oe.lastInvalidatedAt);bi.particleTextureDimension!==xt&&bi.updateParticleTexture(F,Pt);const qr=bi.targetColorTexture;bi.targetColorTexture=bi.backgroundColorTexture,bi.backgroundColorTexture=qr;const Xn=bi.particleTexture0;bi.particleTexture0=bi.particleTexture1,bi.particleTexture1=Xn,Gt.push([F,Fe,bi,wi])}if(0===Gt.length)return;const bi=F.q.now(),wi=Oe.previousDrawTimestamp?.001*(bi-Oe.previousDrawTimestamp):.0167;if(Oe.previousDrawTimestamp=bi,Oe.hasColorMap()){je.activeTexture.set(qe.TEXTURE0+2);let Me=Oe.colorRampTexture;Me||(Me=Oe.colorRampTexture=new F.T(je,Oe.colorRamp,qe.RGBA8)),Me.bind(qe.LINEAR,qe.CLAMP_TO_EDGE)}je.bindFramebuffer.set(Oe.tileFramebuffer.framebuffer),function(Me,Le,Oe){const Fe=Me.context,je=Fe.gl,qe=Le.tileFramebuffer;Fe.activeTexture.set(je.TEXTURE0);const He={u_texture:0,u_opacity:1.05*(Pt=Le.paint.get("raster-particle-fade-opacity-factor"))/(Pt+.05)},xt=Me.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Pt;for(const Pt of Oe){const[,,Oe,jt]=Pt;qe.colorAttachment.set(Oe.targetColorTexture.texture),Fe.viewport.set([0,0,qe.width,qe.height]),Fe.clear({color:F.al.transparent}),jt&&(Oe.backgroundColorTexture.bind(je.NEAREST,je.CLAMP_TO_EDGE),xt.draw(Me,je.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,He,Le.id,Me.viewportBuffer,Me.quadTriangleIndexBuffer,Me.viewportSegments))}}(Me,Oe,Gt),function(Me,Le,Oe,Fe){const je=Me.context,qe=je.gl,He=Oe.tileFramebuffer,xt="globe"===Me.transform.projection.name,Pt=Oe.paint.get("raster-particle-max-speed");for(const jt of Fe){const[Fe,Gt,bi]=jt;je.activeTexture.set(qe.TEXTURE0+0),Gt.texture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),He.colorAttachment.set(bi.targetColorTexture.texture);const wi=Me.getOrCreateProgram("rasterParticleDraw",{defines:Gt.defines,overrideFog:!1});je.activeTexture.set(qe.TEXTURE0+1);const qr=Gt.scalarData?[]:[0,1,2,3].map((Me=>F.d7[Me](Fe)));qr.push(Fe);const Xn=Fe.canonical.x,Yn=Fe.canonical.y;for(const F of qr){const je=Le.getTile(xt?F.wrapped():F);if(!je)continue;const He=je.rasterParticleState;if(!He)continue;const jt=F.canonical.x+(1<<F.canonical.z)*(F.wrap-Fe.wrap),bi=F.canonical.y;He.particleTexture0.bind(qe.NEAREST,qe.CLAMP_TO_EDGE);const qr=fr(1,He.particleTexture0.size[0],[jt-Xn,bi-Yn],0,Gt.texture.size,2,Pt,Gt.textureOffset,Gt.scale,Gt.offset);wi.draw(Me,qe.POINTS,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,qr,Oe.id,He.particleIndexBuffer,void 0,He.particleSegment)}}}(Me,Le,Oe,Gt),je.bindFramebuffer.set(Oe.particleFramebuffer.framebuffer),function(Me,Le,Oe,Fe){const je=Me.context,qe=je.gl,He=Le.paint.get("raster-particle-max-speed"),xt=Fe*Le.paint.get("raster-particle-speed-factor")*.15,Pt=function(F){return Math.pow(F,6)}(.01+1*Le.paint.get("raster-particle-reset-rate-factor")),jt=Le.particleFramebuffer;je.viewport.set([0,0,jt.width,jt.height]);for(const Fe of Oe){const[,Oe,Gt]=Fe;je.activeTexture.set(qe.TEXTURE0+0),Oe.texture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),je.activeTexture.set(qe.TEXTURE0+1);const bi=Gt.particleTexture0;bi.bind(qe.NEAREST,qe.CLAMP_TO_EDGE);const wi=mr(1,bi.size[0],0,Oe.texture.size,He,xt,Pt,Oe.textureOffset,Oe.scale,Oe.offset);jt.colorAttachment.set(Gt.particleTexture1.texture),je.clear({color:F.al.transparent}),Me.getOrCreateProgram("rasterParticleUpdate",{defines:Oe.defines}).draw(Me,qe.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.disabled,wi,Le.id,Me.viewportBuffer,Me.quadTriangleIndexBuffer,Me.viewportSegments)}}(Me,Oe,Gt,wi)}(Me,Le,Oe,Fe),"translucent"===Me.renderPass&&(function(Me,Le,Oe,Fe){const je=Me.context,qe=je.gl,He=Le.getSource().tileSize,xt=5*(1-F.ae(F.bY,F.bY+1,Me.transform.zoom))*He+Oe.paint.get("raster-particle-elevation"),Pt=!Me.options.moving,jt="globe"===Me.transform.projection.name;if(!Fe.length)return;const[Gt,bi]=Me.stencilConfigForOverlap(Fe),wi=[];jt&&wi.push("PROJECTION_GLOBE_VIEW");const qr=Me.stencilModeFor3D();for(const Fe of bi){const He=Fe.toUnwrapped(),bi=Le.getTile(Fe);if(!bi.rasterParticleState)continue;const Xn=bi.rasterParticleState,Yn=100;bi.registerFadeDuration(Yn);const yo=Le.findLoadedParent(Fe,0),bo=Ns(bi,yo,Le,Me.transform,Yn);let Ro,Do;Me.terrain&&Me.terrain.prepareDrawTile(),je.activeTexture.set(qe.TEXTURE0),Xn.targetColorTexture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),je.activeTexture.set(qe.TEXTURE1),yo&&yo.rasterParticleState?(yo.rasterParticleState.targetColorTexture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),Ro=Math.pow(2,yo.tileID.overscaledZ-bi.tileID.overscaledZ),Do=[bi.tileID.canonical.x*Ro%1,bi.tileID.canonical.y*Ro%1]):Xn.targetColorTexture.bind(qe.LINEAR,qe.CLAMP_TO_EDGE);const zs=jt?Float32Array.from(Me.transform.expandedFarZProjMatrix):Me.transform.calculateProjMatrix(He,Pt),Zs=Me.transform,na=tn(Zs),el=F.cF(Fe.canonical),nl=F.cG(el.getCenter().lat);let hl,pl,bl,Tl,kl;jt?(hl=Float32Array.from(F.bc(F.cI(Fe.canonical))),pl=Float32Array.from(Zs.globeMatrix),bl=Float32Array.from(F.cE(Zs)),Tl=[F.av(Zs.center.lng),F.aC(Zs.center.lat)],kl=Float32Array.from(F.cH(Fe.canonical,el,nl,Zs.worldSize/Zs._pixelsPerMercatorPixel))):(hl=new Float32Array(16),pl=new Float32Array(9),bl=new Float32Array(16),Tl=[0,0],kl=new Float32Array(9));const ec=pr(zs,hl,pl,bl,kl,Do||[0,0],F.ag(Me.transform.zoom),Tl,na,Ro||1,bo,xt),tc=Me.isTileAffectedByFog(Fe),ic=Me.getOrCreateProgram("rasterParticle",{defines:wi,overrideFog:tc});if(Me.uploadCommonUniforms(je,ic,He),jt){const F=new Bi(qe.LEQUAL,Bi.ReadOnly,Me.depthRangeFor3D),Le=0,Fe=Me.globeSharedBuffers;if(Fe){const[je,He,xt]=Fe.getGridBuffers(nl,0!==Le);ic.draw(Me,qe.TRIANGLES,F,qr,ki.alphaBlended,Me.renderElevatedRasterBackface?ji.frontCCW:ji.backCCW,ec,Oe.id,je,He,xt)}}else{const F=Me.depthModeForSublayer(0,Bi.ReadOnly),Le=Gt[Fe.overscaledZ],{tileBoundsBuffer:je,tileBoundsIndexBuffer:He,tileBoundsSegments:xt}=Me.getTileBoundsBuffers(bi);ic.draw(Me,qe.TRIANGLES,F,Le,ki.alphaBlended,ji.disabled,ec,Oe.id,je,He,xt)}}Me.resetStencilClippingMasks()}(Me,Le,Oe,Fe),Me.style.map.triggerRepaint())},background:function(Me,Le,Oe,Fe){const je=Oe.paint.get("background-color"),qe="none"===Oe.paint.get("background-color-use-theme").constantOr("default"),He=Oe.paint.get("background-opacity"),xt=Oe.paint.get("background-emissive-strength"),Pt="viewport"===Oe.paint.get("background-pitch-alignment");if(0===He)return;const jt=Me.context,Gt=jt.gl,bi=Me.transform,wi=bi.tileSize,qr=Oe.paint.get("background-pattern");let Xn;if(void 0!==qr){if(null===qr)return;if(Xn=Me.imageManager.getPattern(F.I.from(qr.toString()),Oe.scope,Me.style.getLut(Oe.scope)),!Xn)return}const Yn=!qr&&1===je.a&&1===He&&Me.opaquePassEnabledForLayer()?"opaque":"translucent";if(Me.renderPass!==Yn)return;const yo=Ui.disabled,bo=Me.depthModeForSublayer(0,"opaque"===Yn?Bi.ReadWrite:Bi.ReadOnly),Ro=Me.colorModeForDrapableLayerRenderPass(xt),Do=qr?"backgroundPattern":"background";let zs,Zs=Fe;if(Zs||(zs=Me.getBackgroundTiles(),Zs=Object.values(zs).map((F=>F.tileID))),qr&&(jt.activeTexture.set(Gt.TEXTURE0),Me.imageManager.bind(Me.context,Oe.scope)),Pt){const Le=Me.getOrCreateProgram(Do,{overrideFog:!1,overrideRtt:!0}),Fe=new Float32Array(F.ad.mat4.identity([])),jt=new F.aH(0,0,0,0,0),bi=qr?xr(Fe,xt,He,Me,0,Oe.scope,Xn,Pt,{tileID:jt,tileSize:wi}):yr(Fe,xt,He,je.toRenderColor(qe?null:Oe.lut));Le.draw(Me,Gt.TRIANGLES,bo,yo,Ro,ji.disabled,bi,Oe.id,Me.viewportBuffer,Me.quadTriangleIndexBuffer,Me.viewportSegments)}else for(const F of Zs){const Yn=Me.isTileAffectedByFog(F),Zs=Me.getOrCreateProgram(Do,{overrideFog:Yn}),na=F.toUnwrapped(),el=Fe?F.projMatrix:Me.transform.calculateProjMatrix(na);Me.prepareDrawTile();const nl=Le?Le.getTile(F):zs?zs[F.key]:new bt(F,wi,bi.zoom,Me),hl=qr?xr(el,xt,He,Me,0,Oe.scope,Xn,Pt,{tileID:F,tileSize:wi}):yr(el,xt,He,je.toRenderColor(qe?null:Oe.lut));Me.uploadCommonUniforms(jt,Zs,na);const{tileBoundsBuffer:pl,tileBoundsIndexBuffer:bl,tileBoundsSegments:Tl}=Me.getTileBoundsBuffers(nl);Zs.draw(Me,Gt.TRIANGLES,bo,yo,Ro,ji.disabled,hl,Oe.id,pl,bl,Tl)}},sky:function(Me,Le,Oe){const Fe=Me._atmosphere?F.ag(Me.transform.zoom):1,je=Oe.paint.get("sky-opacity")*Fe;if(0===je)return;const qe=Me.context,He=Oe.paint.get("sky-type"),xt=new Bi(qe.gl.LEQUAL,Bi.ReadOnly,[0,1]),Pt=Me.frameCounter/1e3%1;"atmosphere"===He?"offscreen"===Me.renderPass?Oe.needsSkyboxCapture(Me)&&(function(Me,Le){const Oe=Me.context,Fe=Oe.gl;let je=Le.skyboxFbo;if(!je){je=Le.skyboxFbo=Oe.createFramebuffer(32,32,!0,null),Le.skyboxGeometry=new fn(Oe),Le.skyboxTexture=Oe.gl.createTexture(),Fe.bindTexture(Fe.TEXTURE_CUBE_MAP,Le.skyboxTexture),Fe.texParameteri(Fe.TEXTURE_CUBE_MAP,Fe.TEXTURE_WRAP_S,Fe.CLAMP_TO_EDGE),Fe.texParameteri(Fe.TEXTURE_CUBE_MAP,Fe.TEXTURE_WRAP_T,Fe.CLAMP_TO_EDGE),Fe.texParameteri(Fe.TEXTURE_CUBE_MAP,Fe.TEXTURE_MIN_FILTER,Fe.LINEAR),Fe.texParameteri(Fe.TEXTURE_CUBE_MAP,Fe.TEXTURE_MAG_FILTER,Fe.LINEAR);for(let F=0;F<6;++F)Fe.texImage2D(Fe.TEXTURE_CUBE_MAP_POSITIVE_X+F,0,Fe.RGBA,32,32,0,Fe.RGBA,Fe.UNSIGNED_BYTE,null)}Oe.bindFramebuffer.set(je.framebuffer),Oe.viewport.set([0,0,32,32]);const qe=Le.getCenter(Me,!0),He=Me.getOrCreateProgram("skyboxCapture"),xt=new Float64Array(16);F.ad.mat4.identity(xt),F.ad.mat4.rotateY(xt,xt,.5*-Math.PI),mn(Me,Le,He,xt,qe,0),F.ad.mat4.identity(xt),F.ad.mat4.rotateY(xt,xt,.5*Math.PI),mn(Me,Le,He,xt,qe,1),F.ad.mat4.identity(xt),F.ad.mat4.rotateX(xt,xt,.5*-Math.PI),mn(Me,Le,He,xt,qe,2),F.ad.mat4.identity(xt),F.ad.mat4.rotateX(xt,xt,.5*Math.PI),mn(Me,Le,He,xt,qe,3),F.ad.mat4.identity(xt),mn(Me,Le,He,xt,qe,4),F.ad.mat4.identity(xt),F.ad.mat4.rotateY(xt,xt,Math.PI),mn(Me,Le,He,xt,qe,5),Oe.viewport.set([0,0,Me.width,Me.height])}(Me,Oe),Oe.markSkyboxValid(Me)):"sky"===Me.renderPass&&function(F,Me,Le,Oe,Fe){const je=F.context,qe=je.gl,He=F.transform,xt=F.getOrCreateProgram("skybox");je.activeTexture.set(qe.TEXTURE0),qe.bindTexture(qe.TEXTURE_CUBE_MAP,Me.skyboxTexture);const Pt=((F,Me,Le,Oe,Fe)=>({u_matrix:F,u_sun_direction:Me,u_cubemap:0,u_opacity:Oe,u_temporal_offset:Fe}))(He.skyboxMatrix,Me.getCenter(F,!1),0,Oe,Fe);F.uploadCommonUniforms(je,xt),xt.draw(F,qe.TRIANGLES,Le,Ui.disabled,F.colorModeForRenderPass(),ji.backCW,Pt,"skybox",Me.skyboxGeometry.vertexBuffer,Me.skyboxGeometry.indexBuffer,Me.skyboxGeometry.segment)}(Me,Oe,xt,je,Pt):"gradient"===He&&"sky"===Me.renderPass&&function(Me,Le,Oe,Fe,je){const qe=Me.context,He=qe.gl,xt=Me.transform,Pt=Me.getOrCreateProgram("skyboxGradient");Le.skyboxGeometry||(Le.skyboxGeometry=new fn(qe)),qe.activeTexture.set(He.TEXTURE0);let jt=Le.colorRampTexture;jt||(jt=Le.colorRampTexture=new F.T(qe,Le.colorRamp,He.RGBA8)),jt.bind(He.LINEAR,He.CLAMP_TO_EDGE);const Gt=((Me,Le,Oe,Fe,je)=>({u_matrix:Me,u_color_ramp:0,u_center_direction:Le,u_radius:F.ak(Oe),u_opacity:Fe,u_temporal_offset:je}))(xt.skyboxMatrix,Le.getCenter(Me,!1),Le.paint.get("sky-gradient-radius"),Fe,je);Me.uploadCommonUniforms(qe,Pt),Pt.draw(Me,He.TRIANGLES,Oe,Ui.disabled,Me.colorModeForRenderPass(),ji.backCW,Gt,"skyboxGradient",Le.skyboxGeometry.vertexBuffer,Le.skyboxGeometry.indexBuffer,Le.skyboxGeometry.segment)}(Me,Oe,xt,je,Pt)},debug:function(Me,Le,Oe,Fe,je,qe){for(let He=0;He<Oe.length;He++)if(je){const je=1,xt=.8,Pt=new F.al(Fe.r*xt,Fe.g*xt,Fe.b*xt,1);ln(Me,Le,Oe[He],Fe,-je,-je,qe),ln(Me,Le,Oe[He],Fe,-je,je,qe),ln(Me,Le,Oe[He],Fe,je,je,qe),ln(Me,Le,Oe[He],Fe,je,-je,qe),ln(Me,Le,Oe[He],Pt,0,0,qe)}else ln(Me,Le,Oe[He],Fe,0,0,qe)},custom:function(Me,Le,Oe,Fe){const je=Me.context,qe=Oe.implementation;if(!Me.transform.projection.unsupportedLayers||!Me.transform.projection.unsupportedLayers.includes("custom")||Me.terrain&&(Me.terrain.renderingToTexture||"offscreen"===Me.renderPass)&&Oe.isDraped(Le)){if("offscreen"===Me.renderPass){const Le=qe.prerender;if(Le){if(Me.setCustomLayerDefaults(),je.setColorMode(Me.colorModeForRenderPass()),"globe"===Me.transform.projection.name){const Oe=Me.transform.pointMerc;Le.call(qe,je.gl,Me.transform.customLayerMatrix(),Me.transform.getProjection(),Me.transform.globeToMercatorMatrix(),F.ag(Me.transform.zoom),[Oe.x,Oe.y],Me.transform.pixelsPerMeterRatio)}else Le.call(qe,je.gl,Me.transform.customLayerMatrix());je.setDirty(),Me.setBaseState()}}else if("translucent"===Me.renderPass){if(Me.terrain&&Me.terrain.renderingToTexture){const Le=qe.renderToTile;if(Le){const Oe=Fe[0].canonical,He=new F.ac(Oe.x+Fe[0].wrap*(1<<Oe.z),Oe.y,Oe.z);je.setDepthMode(Bi.disabled),je.setStencilMode(Ui.disabled),je.setColorMode(Me.colorModeForRenderPass()),Me.setCustomLayerDefaults(),Le.call(qe,je.gl,He),je.setDirty(),Me.setBaseState()}return}Me.setCustomLayerDefaults(),je.setColorMode(Me.colorModeForRenderPass()),je.setStencilMode(Ui.disabled);const Le="3d"===qe.renderingMode?new Bi(Me.context.gl.LEQUAL,Bi.ReadWrite,Me.depthRangeFor3D):Me.depthModeForSublayer(0,Bi.ReadOnly);if(je.setDepthMode(Le),"globe"===Me.transform.projection.name){const Le=Me.transform.pointMerc;qe.render(je.gl,Me.transform.customLayerMatrix(),Me.transform.getProjection(),Me.transform.globeToMercatorMatrix(),F.ag(Me.transform.zoom),[Le.x,Le.y],Me.transform.pixelsPerMeterRatio)}else qe.render(je.gl,Me.transform.customLayerMatrix());je.setDirty(),Me.setBaseState(),je.bindFramebuffer.set(null)}}else F.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(Me,Le,Oe,Fe){if("opaque"===Me.renderPass)return;const je=Oe.paint.get("model-opacity").constantOr(1);if(0===je)return;const qe=Oe.paint.get("model-cast-shadows");if("shadow"===Me.renderPass){if(!qe)return;if(Me.terrain&&je<.65&&Oe._transitionablePaint._values["model-opacity"].value.expression instanceof F.ab)return}const He=Me.shadowRenderer,xt=Oe.paint.get("model-receive-shadows");He&&(He.useNormalOffset=!0,xt||(He.enabled=!1));const c=()=>{He&&(He.useNormalOffset=!0,xt||(He.enabled=!0))},Pt=Le.getSource();if("light-beam"===Me.renderPass&&"batched-model"!==Pt.type)return;if("vector"===Pt.type||"geojson"===Pt.type)return function(Me,Le,Oe,Fe,je){const qe=Me.transform;if("mercator"!==qe.projection.name)return void F.w(`Drawing 3D models for ${qe.projection.name} projection is not yet implemented`);const He=qe.getFreeCameraOptions().position;if(!Me.modelManager)return;const xt=Me.modelManager;Oe.modelManager=xt;const Pt=Me.shadowRenderer;if(!Oe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const jt=Oe._unevaluatedLayout._values["model-id"],Gt=Object.assign({},Oe.layout.get("model-id").parameters),bi=Me.style.order.indexOf(Oe.fqid);for(const wi of Fe){const Fe=Le.getTile(wi).getBucket(Oe);if(!Fe||Fe.projection.name!==qe.projection.name)continue;const qr=Fe.getModelUris();qr&&!Fe.modelsRequested&&(xt.addModelsFromBucket(qr,je),Fe.modelsRequested=!0);const Xn=Dn(wi,qe);Gt.zoom=Xn;const Yn=jt.possiblyEvaluate(Gt);if(In(Me,Fe,wi),cf.shadowUniformsInitialized=!1,cf.useSingleShadowCascade=!!Pt&&0===Pt.getMaxCascadeForTile(wi.toUnwrapped()),"shadow"===Me.renderPass&&Pt){if(1===Me.currentShadowCascade&&Fe.isInsideFirstShadowMapFrustum)continue;const Le=qe.calculatePosMatrix(wi.toUnwrapped(),qe.worldSize);if(cf.tileMatrix.set(Le),cf.shadowTileMatrix=Float32Array.from(Pt.calculateShadowPassMatrixFromMatrix(Le)),cf.aabb.min.fill(0),cf.aabb.max[0]=cf.aabb.max[1]=F.ai,cf.aabb.max[2]=0,Pn(Fe,cf,Me,Oe.scope))continue}const yo=1<<wi.canonical.z,bo=[((He.x-wi.wrap)*yo-wi.canonical.x)*F.ai,(He.y*yo-wi.canonical.y)*F.ai,He.z*yo*F.ai];Me.conflationActive&&Object.keys(Fe.instancesPerModel).length>0&&Me.style.isLayerClipped(Oe,Le.getSource())&&Fe.updateReplacement(wi,Me.replacementSource,bi,je)&&(Fe.uploaded=!1,Fe.upload(Me.context));for(let F in Fe.instancesPerModel){const Le=Fe.instancesPerModel[F];Le.features.length>0&&(F=Yn.evaluate(Le.features[0].feature,{}));const qe=xt.getModel(F,je);if(qe&&qe.uploaded)for(const F of qe.nodes)An(Me,Oe,F,Le,bo,wi,cf)}}}(Me,Le,Oe,Fe,"vector"===Pt.type?Oe.scope:""),void c();if(!Pt.loaded())return;if("batched-model"===Pt.type)return function(Me,Le,Oe,Fe){Oe.resetLayerRenderingStats(Me);const je=Me.context,qe=Me.transform,He=Me.style.fog,xt=Me.shadowRenderer;if("mercator"!==qe.projection.name)return void F.w(`Drawing 3D landmark models for ${qe.projection.name} projection is not yet implemented`);const Pt=Me.transform.getFreeCameraOptions().position,jt=F.ad.vec3.scale([],[Pt.x,Pt.y,Pt.z],Me.transform.worldSize),Gt=F.ad.vec3.negate([],jt),bi=F.ad.mat4.identity([]),wi=F.dm(qe.center.lat,qe.zoom),qr=F.ad.mat4.fromScaling([],[1,1,1/wi]);F.ad.mat4.translate(bi,bi,Gt);const Xn=Oe.paint.get("model-opacity").constantOr(1),Yn=new Bi(je.gl.LEQUAL,Bi.ReadWrite,Me.depthRangeFor3D),yo=new Bi(je.gl.LEQUAL,Bi.ReadOnly,Me.depthRangeFor3D),bo=new F.ce([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Ro="shadow"===Me.renderPass,Do=Ro&&xt?xt.getCurrentCascadeFrustum():qe.getFrustum(qe.scaleZoom(qe.worldSize)),zs=Oe.paint.get("model-front-cutoff"),Zs=zs[2]<1,na=Qi(Me,Oe.paint.get("model-cutoff-fade-range")),el=Oe.getLayerRenderingStats();(function(F,Me,Le,Oe){const Fe=F.terrain?F.terrain.exaggeration():0,je=F.transform.zoom;for(const qe of Oe){const Oe=Me.getTile(qe).getBucket(Le);Oe&&(Oe.setFilter(Le.filter),F.conflationActive&&Oe.updateReplacement(qe,F.replacementSource),Oe.evaluateScale(F,Le),F.terrain&&Fe>0&&Oe.elevationUpdate(F.terrain,Fe,qe,Le.source),Oe.needsReEvaluation(F,je,Le)&&Oe.evaluate(Le))}})(Me,Le,Oe,Fe),function(){let Pt,Gt,nl;Zs?(Pt=Fe.length-1,Gt=-1,nl=-1):(Pt=0,Gt=Fe.length,nl=1);const hl=new Float64Array(16),pl=F.ad.vec3.create(),bl=new F.P(0,0);for(let Tl=Pt;Tl!==Gt;Tl+=nl){const Pt=Fe[Tl],Gt=Le.getTile(Pt).getBucket(Oe);if(!Gt||!Gt.uploaded)continue;let nl=!1;xt&&(nl=0===xt.getMaxCascadeForTile(Pt.toUnwrapped()));const kl=qe.calculatePosMatrix(Pt.toUnwrapped(),qe.worldSize),tc=Gt.modelTraits;!Ro&&Zs&&(F.ad.mat4.invert(hl,kl),F.ad.vec3.transformMat4(pl,jt,hl),bl.x=pl[0],bl.y=pl[1]);const ic=[];Gt.setFilter(Oe.filter);for(const Le of Gt.getNodesInfo()){if(Le.hiddenByReplacement)continue;if(!Le.node.meshes)continue;const Oe=Le.node;let Fe=0;Me.terrain&&Oe.elevation&&(Fe=Oe.elevation*Me.terrain.exaggeration());const je=(()=>{const Me=Le.aabb;return bo.min=[...Me.min],bo.max=[...Me.max],bo.min[2]+=Fe,bo.max[2]+=Fe,F.ad.vec3.transformMat4(bo.min,bo.min,kl),F.ad.vec3.transformMat4(bo.max,bo.max,kl),bo})(),He=Le.evaluatedScale;if(He[0]<=1&&He[1]<=1&&He[2]<=1&&0===je.intersects(Do))continue;if(!Ro&&Zs){const Me=1/6;Le.cameraCollisionOpacity=jt[0]>je.min[0]&&jt[0]<je.max[0]&&jt[1]>je.min[1]&&jt[1]<je.max[1]&&jt[2]*wi<je.max[2]&&Oe.footprint&&F.bA(bl,Oe.footprint)?Math.max(Le.cameraCollisionOpacity-Me,0):Math.min(1,Le.cameraCollisionOpacity+Me)}const xt=[...kl],Pt=Oe.anchor?Oe.anchor[0]:0,Gt=Oe.anchor?Oe.anchor[1]:0;F.ad.mat4.translate(xt,xt,[Pt*(He[0]-1),Gt*(He[1]-1),Fe]),F.ad.vec3.exactEquals(He,F.dq)||F.ad.mat4.scale(xt,xt,He);const bi=F.ad.mat4.multiply([],xt,Oe.matrix),qr=F.ad.mat4.multiply([],qe.expandedFarZProjMatrix,bi),Yn=F.ad.mat4.multiply([],qe.expandedFarZProjMatrix,xt),yo=F.ad.vec4.transformMat4([],[Pt,Gt,Fe,1],qr)[2];Oe.hidden=!1;let el=Xn;Ro||(Zs&&(el*=Le.cameraCollisionOpacity,el*=zn(xt,qe,Le.aabb,zs)),el*=Mn(na,yo)),0!==el?ic.push({nodeInfo:Le,depth:yo,opacity:el,wvpForNode:qr,wvpForTile:Yn,nodeModelMatrix:bi,tileModelMatrix:xt}):Oe.hidden=!0}Ro||ic.sort(((F,Me)=>!Zs||1===F.opacity&&1===Me.opacity?F.depth<Me.depth?-1:1:1===F.opacity?-1:1===Me.opacity?1:F.depth>Me.depth?-1:1));for(const Le of ic){const Fe=Le.nodeInfo,Pt=Fe.node;let jt=F.ad.mat4.multiply([],qr,Le.tileModelMatrix);F.ad.mat4.multiply(jt,bi,jt);const Gt=F.ad.mat4.invert([],jt);F.ad.mat4.transpose(Gt,Gt),F.ad.mat4.scale(Gt,Gt,hf),jt=F.ad.mat4.multiply(jt,jt,Pt.matrix);const wi="light-beam"===Me.renderPass,Xn="none"===Oe.paint.get("model-color-use-theme").constantOr("default"),bo=tc&F.ds.HasMapboxMeshFeatures,Do=bo?0:Fe.evaluatedRMEA[0][2];for(let F=0;F<Pt.meshes.length;++F){const bi=Pt.meshes[F],qr=F===Pt.lightMeshIndex;let zs=Le.wvpForNode;if(qr){if(!wi&&!Me.terrain&&Me.shadowRenderer){Me.currentLayer<Me.firstLightBeamLayer&&(Me.firstLightBeamLayer=Me.currentLayer);continue}zs=Le.wvpForTile}else if(wi)continue;const Zs={defines:[]},na=[];if(!Ro&&xt&&(xt.useNormalOffset=!!bi.normalBuffer),Tn(Zs.defines,na,bi,Me,Xn?null:Oe.lut),bo||Zs.defines.push("DIFFUSE_SHADED"),nl&&Zs.defines.push("SHADOWS_SINGLE_CASCADE"),el&&(Ro?el.numRenderedVerticesInShadowPass+=bi.vertexArray.length:el.numRenderedVerticesInTransparentPass+=bi.vertexArray.length),Ro){Cn(bi,Le.nodeModelMatrix,Me,Oe);continue}let hl=null;if(He){const F=wn(Le.nodeModelMatrix,Me.transform);if(hl=new Float32Array(F),"globe"!==qe.projection.name){const Me=bi.aabb.min,Le=bi.aabb.max,[Oe,Fe]=He.getOpacityForBounds(F,Me[0],Me[1],Le[0],Le[1]);Zs.overrideFog=Oe>=ec||Fe>=ec}}const pl=bi.material;let bl;pl.occlusionTexture&&pl.occlusionTexture.offsetScale&&(bl=pl.occlusionTexture.offsetScale,Zs.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const Tl=Me.getOrCreateProgram("model",Zs);!Ro&&xt&&xt.setupShadowsFromMatrix(Le.tileModelMatrix,Tl,xt.useNormalOffset),Me.uploadCommonUniforms(je,Tl,null,hl);const kl=pl.pbrMetallicRoughness;kl.metallicFactor=.9,kl.roughnessFactor=.5;const tc=wr(new Float32Array(zs),new Float32Array(jt),new Float32Array(Gt),new Float32Array(Pt.matrix),Me,Le.opacity,kl.baseColorFactor.toRenderColor(null),pl.emissiveFactor,kl.metallicFactor,kl.roughnessFactor,pl,Do,Oe,[0,0,0],bl);!qr&&(Fe.hasTranslucentParts||Le.opacity<1)&&Tl.draw(Me,je.gl.TRIANGLES,Yn,Ui.disabled,ki.disabled,ji.backCCW,tc,Oe.id,bi.vertexBuffer,bi.indexBuffer,bi.segments,Oe.paint,Me.transform.zoom,void 0,na),Tl.draw(Me,je.gl.TRIANGLES,qr?yo:Yn,Ui.disabled,qr||Le.opacity<1||Fe.hasTranslucentParts?ki.alphaBlended:ki.unblended,ji.backCCW,tc,Oe.id,bi.vertexBuffer,bi.indexBuffer,bi.segments,Oe.paint,Me.transform.zoom,void 0,na)}}}}()}(Me,Le,Oe,Fe),void c();if("model"!==Pt.type)return;const jt=Pt.getModels(),Gt=[],bi=Me.transform.getFreeCameraOptions().position,wi=F.ad.vec3.scale([],[bi.x,bi.y,bi.z],Me.transform.worldSize);F.ad.vec3.negate(wi,wi);const qr=[],Xn=[];let Yn=0;for(const Le of jt){const Fe=Oe.paint.get("model-rotation").constantOr(null),je=Oe.paint.get("model-scale").constantOr(null),qe=Oe.paint.get("model-translation").constantOr(null);Le.computeModelMatrix(Me,Fe,je,qe,!0,!0,!1);const He=F.ad.mat4.identity([]),xt=F.dm(Le.position.lat,Me.transform.zoom),Pt=F.ad.mat4.fromScaling([],[1,1,1/xt]);F.ad.mat4.translate(He,He,wi),Gt.push({zScaleMatrix:Pt,negCameraPosMatrix:He});for(const F of Le.nodes)Sn(Me.transform,F,Le.matrix,Me.transform.expandedFarZProjMatrix,Yn,qr,Xn);Yn++}if(qr.sort(((F,Me)=>Me.depth-F.depth)),"shadow"!==Me.renderPass){if(1===je)for(const F of Xn)En(F,Me,Oe,Gt[F.modelIndex],Ui.disabled,Me.colorModeForRenderPass());else{for(const F of Xn)En(F,Me,Oe,Gt[F.modelIndex],Ui.disabled,ki.disabled);for(const F of Xn)En(F,Me,Oe,Gt[F.modelIndex],Me.stencilModeFor3D(),Me.colorModeForRenderPass());Me.resetStencilClippingMasks()}for(const F of qr)En(F,Me,Oe,Gt[F.modelIndex],Ui.disabled,Me.colorModeForRenderPass());c()}else{for(const F of Xn)Cn(F.mesh,F.nodeModelMatrix,Me,Oe);for(const F of qr)Cn(F.mesh,F.nodeModelMatrix,Me,Oe);c()}}},mf={line:function(F,Me,Le){if(F.hasElevatedBuckets=!1,F.hasNonElevatedBuckets=!1,void 0!==F._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==F._unevaluatedLayout.getValue("line-z-offset")){if(Me){const Le=Me.getVisibleCoordinates();for(const Oe of Le){const Le=Me.getTile(Oe).getBucket(F);if(Le&&(Le.hasZOffset?F.hasElevatedBuckets=!0:F.hasNonElevatedBuckets=!0,F.hasElevatedBuckets&&F.hasNonElevatedBuckets))break}}}else F.hasNonElevatedBuckets=!0},model:function(F,Me,Le){const Oe=Me.getSource();if(!Oe.loaded())return;if("vector"===Oe.type||"geojson"===Oe.type)return void(Le.modelManager&&Le.modelManager.upload(Le,"vector"===Oe.type?F.scope:""));if("batched-model"===Oe.type)return;if("model"!==Oe.type)return;const Fe=Oe.getModels();for(const F of Fe)F.upload(Le.context)},raster:function(F,Me,Le){const Oe=Me.getSource();if(!(Oe instanceof ot&&Oe.loaded()))return;const Fe=F.sourceLayer||Oe.rasterLayerIds&&Oe.rasterLayerIds[0];if(!Fe)return;const je=F.paint.get("raster-array-band")||Oe.getInitialBand(Fe);if(null==je)return;const qe=Me.getIds().map((F=>Me.getTileByID(F)));for(const F of qe)F.updateNeeded(Fe,je)&&Oe.prepareTile(F,Fe,je)},"raster-particle":function(F,Me,Le){const Oe=Me.getSource();if(!(Oe instanceof ot&&Oe.loaded()))return;const Fe=F.sourceLayer||Oe.rasterLayerIds&&Oe.rasterLayerIds[0];if(!Fe)return;const je=F.paint.get("raster-particle-array-band")||Oe.getInitialBand(Fe);if(null==je)return;const qe=Me.getIds().map((F=>Me.getTileByID(F)));for(const F of qe)F.updateNeeded(Fe,je)&&Oe.prepareTile(F,Fe,je)}},gf={fill:Nr};class ea{constructor(Me,Le,Oe,Fe,je){this.context=new Dr(Me,Le),this.transform=Oe,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=je,this._timeStamp=F.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const qe=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const F of qe)this._debugParams.enabledLayers[F]=!0;je.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),je.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),je.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),je.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),je.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),je.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const F of qe)je.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],F);this.occlusionParams=new kn(je),this.setup(),this.numSublayers=St.maxUnderzooming+St.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new F.dy,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new oo(this),this._wireframeDebugCache=new Fn,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const He=new F.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new F.T(this.context,He,Me.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=Fe}updateTerrain(F,Me){const Le=!!F&&!!F.terrain&&this.transform.projection.supportsTerrain;if(!(Le||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new js(this,F));const Oe=this._terrain;this.transform.elevation=Le?Oe:null,Oe.update(F,this.transform,Me),this.transform.elevation&&!Oe.enabled&&(this.transform.elevation=null)}_updateFog(F){const Me=F.fog;if(!Me||"globe"===this.transform.projection.name||Me.getOpacity(this.transform.pitch)<1||Me.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[Le,Oe]=Me.getFovAdjustedRange(this.transform._fov);if(Le>Oe)return void(this.transform.fogCullDistSq=null);const Fe=Le+.78*(Oe-Le);this.transform.fogCullDistSq=Fe*Fe}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(F){F&&!this._terrain&&(this._terrain=new js(this,this.style)),this._forceTerrainMode=F}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(Me,Le){if(this.width=Me*F.q.devicePixelRatio,this.height=Le*F.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const F of this.style.order)this.style._mergedLayers[F].resize()}setup(){const Me=this.context,Le=new F.b5;Le.emplaceBack(0,0),Le.emplaceBack(F.ai,0),Le.emplaceBack(0,F.ai),Le.emplaceBack(F.ai,F.ai),this.tileExtentBuffer=Me.createVertexBuffer(Le,F.b7.members),this.tileExtentSegments=F.b8.simpleSegment(0,0,4,2);const Oe=new F.b5;Oe.emplaceBack(0,0),Oe.emplaceBack(F.ai,0),Oe.emplaceBack(0,F.ai),Oe.emplaceBack(F.ai,F.ai),this.debugBuffer=Me.createVertexBuffer(Oe,F.b7.members),this.debugSegments=F.b8.simpleSegment(0,0,4,5);const Fe=new F.b5;Fe.emplaceBack(-1,-1),Fe.emplaceBack(1,-1),Fe.emplaceBack(-1,1),Fe.emplaceBack(1,1),this.viewportBuffer=Me.createVertexBuffer(Fe,F.b7.members),this.viewportSegments=F.b8.simpleSegment(0,0,4,2);const je=new F.aU;je.emplaceBack(0,0,0,0),je.emplaceBack(F.ai,0,F.ai,0),je.emplaceBack(0,F.ai,0,F.ai),je.emplaceBack(F.ai,F.ai,F.ai,F.ai),this.mercatorBoundsBuffer=Me.createVertexBuffer(je,F.ba.members),this.mercatorBoundsSegments=F.b8.simpleSegment(0,0,4,2);const qe=new F.aV;qe.emplaceBack(0,1,2),qe.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=Me.createIndexBuffer(qe);const He=new F.b6;for(const F of[0,1,3,2,0])He.emplaceBack(F);this.debugIndexBuffer=Me.createIndexBuffer(He),this.emptyTexture=new F.T(Me,new F.r({width:1,height:1},Uint8Array.of(0,0,0,0)),Me.gl.RGBA8),this.identityMat=F.ad.mat4.create();const xt=this.context.gl;this.stencilClearMode=new Ui({func:xt.ALWAYS,mask:0},0,255,xt.ZERO,xt.ZERO,xt.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(F){return F._makeTileBoundsBuffers(this.context,this.transform.projection),F._tileBoundsBuffer?{tileBoundsBuffer:F._tileBoundsBuffer,tileBoundsIndexBuffer:F._tileBoundsIndexBuffer,tileBoundsSegments:F._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const F=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,F.TRIANGLES,Bi.disabled,this.stencilClearMode,ki.disabled,ji.disabled,Bs(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(F,Me,Le){if(!Me||this.currentStencilSource===Me.id||!F.isTileClipped()||!Le||0===Le.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let F=!1;for(const Me of Le)if(void 0===this._tileClippingMaskIDs[Me.key]){F=!0;break}if(!F)return}this.currentStencilSource=Me.id;const Oe=this.context,Fe=Oe.gl;this.nextStencilID+Le.length>256&&this.clearStencil(),Oe.setColorMode(ki.disabled),Oe.setDepthMode(Bi.disabled);const je=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const F of Le){const Le=Me.getTile(F),Oe=this._tileClippingMaskIDs[F.key]=this.nextStencilID++,{tileBoundsBuffer:qe,tileBoundsIndexBuffer:He,tileBoundsSegments:xt}=this.getTileBoundsBuffers(Le);je.draw(this,Fe.TRIANGLES,Bi.disabled,new Ui({func:Fe.ALWAYS,mask:0},Oe,255,Fe.KEEP,Fe.KEEP,Fe.REPLACE),ki.disabled,ji.disabled,Bs(F.projMatrix),"$clipping",qe,He,xt)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const F=this.nextStencilID++,Me=this.context.gl;return new Ui({func:Me.NOTEQUAL,mask:255},F,255,Me.KEEP,Me.KEEP,Me.REPLACE)}stencilModeForClipping(F){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(F);const Me=this.context.gl;return new Ui({func:Me.EQUAL,mask:255},this._tileClippingMaskIDs[F.key],0,Me.KEEP,Me.KEEP,Me.REPLACE)}stencilConfigForOverlap(F){const Me=this.context.gl,Le=F.sort(((F,Me)=>Me.overscaledZ-F.overscaledZ)),Oe=Le[Le.length-1].overscaledZ,Fe=Le[0].overscaledZ-Oe+1;if(Fe>1){this.currentStencilSource=void 0,this.nextStencilID+Fe>256&&this.clearStencil();const F={};for(let Le=0;Le<Fe;Le++)F[Le+Oe]=new Ui({func:Me.GEQUAL,mask:255},Le+this.nextStencilID,255,Me.KEEP,Me.KEEP,Me.REPLACE);return this.nextStencilID+=Fe,[F,Le]}return[{[Oe]:Ui.disabled},Le]}colorModeForRenderPass(){const Me=this.context.gl;if(this._showOverdrawInspector){const Le=1/8;return new ki([Me.CONSTANT_COLOR,Me.ONE,Me.CONSTANT_COLOR,Me.ONE],new F.al(Le,Le,Le,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?ki.unblended:ki.alphaBlended}colorModeForDrapableLayerRenderPass(Me){const Le=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new ki([Le.ONE,Le.ONE_MINUS_SRC_ALPHA,Le.CONSTANT_ALPHA,Le.ONE_MINUS_SRC_ALPHA],new F.al(0,0,0,void 0===Me?0:Me),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(F,Me,Le,Oe=!1){if(this.depthOcclusion)return new Bi(this.context.gl.GREATER,Bi.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!Oe)return Bi.disabled;const Fe=1-((1+this.currentLayer)*this.numSublayers+F)*this.depthEpsilon;return new Bi(Le||this.context.gl.LEQUAL,Me,[Fe,Fe])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const Me=this.context.gl,Le=Math.ceil(this.width),Oe=Math.ceil(this.height),Fe=this.context.bindFramebuffer.get(),je=Me.getParameter(Me.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===Le&&this.depthFBO.height===Oe||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==Le&&0!==Oe&&(this.depthFBO=new Rr(this.context,Le,Oe,!1,"texture"),this.depthTexture=new F.T(this.context,{width:Le,height:Oe,data:null},Me.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(Fe),Me.bindTexture(Me.TEXTURE_2D,je),this.depthFBO&&(Me.bindFramebuffer(Me.READ_FRAMEBUFFER,null),Me.bindFramebuffer(Me.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),Me.blitFramebuffer(0,0,Le,Oe,0,0,Le,Oe,Me.DEPTH_BUFFER_BIT,Me.NEAREST),Me.bindFramebuffer(Me.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((F,Me)=>F+Me/this._fpsHistory.length),0))}render(Me,Le){const Oe=F.q.now();this._dt=Oe-this._timeStamp,this._timeStamp=Oe,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=Me.map.repaint,this.style=Me,this.options=Le;const Fe=this.style._mergedLayers,je=!(!this.terrain||!this.terrain.enabled),n=()=>this.style._getOrder(je).filter((F=>{const Me=Fe[F];return!(Me.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Me.type]}));let qe=n(),He=!1,xt=!1;for(const F of qe){const Me=Fe[F];"circle"===Me.type&&(He=!0),"symbol"===Me.type&&(Me.hasInitialOcclusionOpacityProperties?xt=!0:He=!0)}let Pt=qe.map((F=>Fe[F]));const jt=this.style._mergedSourceCaches;this.imageManager=Me.imageManager,this.modelManager=Me.modelManager,this.symbolFadeChange=Me.placement.symbolFadeChange(F.q.now()),this.imageManager.beginFrame();let Gt=0,bi=!1;for(const F in jt){const Me=jt[F];Me.used&&(Me.prepare(this.context),Me.getSource().usedInConflation&&++Gt)}let wi=!1;for(const F of Pt)F.isHidden(this.transform.zoom)||("clip"===F.type&&(wi=!0),this.prepareLayer(F));const qr={},Xn={},Yn={},yo={},bo={};for(const F in jt){const Me=jt[F];qr[F]=Me.getVisibleCoordinates(),Xn[F]=qr[F].slice().reverse(),Yn[F]=Me.getVisibleCoordinates(!0).reverse(),yo[F]=Me.getShadowCasterCoordinates(),bo[F]=Me.sortCoordinatesByDistance(qr[F])}const x=F=>{const Me=this.style.getLayerSourceCache(F);return Me&&Me.used?Me.getSource():null};if(Gt||wi||this._clippingActiveLastFrame){const Me=[],Le=[];let Oe=0;for(const F of Pt)this.isSourceForClippingOrConflation(F,x(F))&&(Me.push(F),Le.push(Oe)),Oe++;if(Me&&(wi||Me.length>1)||this._clippingActiveLastFrame){wi=!1;const Oe=[];for(let Fe=0;Fe<Me.length;Fe++){const je=Me[Fe],qe=Le[Fe],He=this.style.getLayerSourceCache(je);if(!He||!He.used||!He.getSource().usedInConflation&&"clip"!==je.type)continue;let xt=F.dA,Pt=F.by.None;const jt=[];let Gt=!0;if("clip"===je.type){xt=qe;for(const Me of je.layout.get("clip-layer-types"))Pt|="model"===Me?F.by.Model:"symbol"===Me?F.by.Symbol:F.by.FillExtrusion;for(const F of je.layout.get("clip-layer-scope"))jt.push(F);je.isHidden(this.transform.zoom)?Gt=!1:wi=!0}Gt&&Oe.push({layer:je.fqid,cache:He,order:xt,clipMask:Pt,clipScope:jt})}this.replacementSource.setSources(Oe),bi=!0}}this._clippingActiveLastFrame=wi,bi||this.replacementSource.clear(),this.conflationActive=bi,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let F=0;F<Pt.length;F++){const Me=Pt[F],Le=Me.cutoffRange();if(this.longestCutoffRange=Math.max(Le,this.longestCutoffRange),Le>0){const F=x(Me);F&&(this.minCutoffZoom=Math.max(F.minzoom,this.minCutoffZoom)),Me.minzoom&&(this.minCutoffZoom=Math.max(Me.minzoom,this.minCutoffZoom))}Me.is3D(je)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=F),this._lastOcclusionLayer=F)}const Ro=this.style&&this.style.fog;Ro?(this._fogVisible=0!==Ro.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=Ro.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Yn),this.opaquePassCutoff=0,qe=n(),Pt=qe.map((F=>Fe[F])));const Do=this._shadowRenderer;if(Do){Do.updateShadowParameters(this.transform,this.style.directionalLight);for(const F in jt)for(const Me of qr[F]){let F={min:0,max:0};this.terrain&&(F=this.terrain.getMinMaxForTile(Me)||F),Do.addShadowReceiver(Me.toUnwrapped(),F.min,F.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new F.dz(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new bn(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const zs=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),Zs=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(zs&&!this._snow&&(this._snow=new Kn(this)),!zs&&this._snow&&(this._snow.destroy(),delete this._snow),Zs&&!this._rain&&(this._rain=new $n(this)),!Zs&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!el.has(this.context.gl))return;this.renderPass="offscreen";for(const F of Pt){const Le=Me.getLayerSourceCache(F);if(!F.hasOffscreenPass()||F.isHidden(this.transform.zoom))continue;const Oe=Le?Xn[Le.id]:void 0;("custom"===F.type||"raster"===F.type||"raster-particle"===F.type||F.isSky()||Oe&&Oe.length)&&this.renderLayer(this,Le,F,Oe)}this.depthRangeFor3D=[0,1-(Pt.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,yo)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const na="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),nl=(()=>{if(Le.showOverdrawInspector)return F.al.black;const Me=this.style.fog;if(Me&&this.transform.projection.supportsFog){const Le=this.style.getLut(Me.scope);if(!na){const Oe="none"===Me.properties.get("color-use-theme"),Fe=Me.properties.get("color").toRenderColor(Oe?null:Le).toArray01();return new F.al(...Fe)}if(na){const Oe="none"===Me.properties.get("space-color-use-theme"),Fe=Me.properties.get("space-color").toRenderColor(Oe?null:Le).toArray01();return new F.al(...Fe)}}return F.al.transparent})();if(this.context.clear({color:nl,depth:1}),this.clearStencil(),this._showOverdrawInspector=Le.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&na&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=qe.length-1;this.currentLayer>=0;this.currentLayer--){const F=Pt[this.currentLayer],Le=Me.getLayerSourceCache(F);if(F.isSky())continue;const Oe=Le?(F.is3D(je)?bo:Xn)[Le.id]:void 0;this._renderTileClippingMasks(F,Le,Oe),this.renderLayer(this,Le,F,Oe)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&na&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||F.ag(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<qe.length;this.currentLayer++){const F=Pt[this.currentLayer],Le=Me.getLayerSourceCache(F);F.isSky()&&this.renderLayer(this,Le,F,Le?Xn[Le.id]:void 0)}function I(F,Me){let Le;return Me&&(Le=("symbol"===F.type?Yn:F.is3D(je)?bo:Xn)[Me.id]),Le}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<qe.length;){const F=Pt[this.currentLayer];if("raster"===F.type||"raster-particle"===F.type){const Le=Me.getLayerSourceCache(F);this.renderLayer(this,Le,F,I(F,Le))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let hl=0;Do&&(hl=Do.getShadowCastingLayerCount());let pl=!1,bl=-1;for(let F=0;F<qe.length;++F){const Me=Pt[F];Me.isHidden(this.transform.zoom)||Me.is3D(je)&&(bl=F)}xt&&-1===bl&&(He=!0);let Tl=!1;for(;this.currentLayer<qe.length;){const F=Pt[this.currentLayer],Le=Me.getLayerSourceCache(F);if(F.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(F)){if(F.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!Tl&&F.is3D(je)&&!je){const F=this.currentLayer,t=F=>{for(this.currentLayer=0;this.currentLayer<Pt.length;this.currentLayer++){const Me=Pt[this.currentLayer];if(gf[Me.type]){const Le=this.style.getLayerSourceCache(Me);gf[Me.type](this,Le,Me,I(Me,Le),F)}}};t("initialize"),t("reset"),this.currentLayer=F,Tl=!0}if(He&&!pl&&this.terrain&&!this.transform.isOrthographic&&(pl=!0,this.blitDepth()),xt&&-1!==bl&&this.currentLayer===bl+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(F,Le,Le?qr[Le.id]:void 0),this.renderLayer(this,Le,F,I(F,Le)),!this.terrain&&Do&&hl>0&&F.hasShadowPass()&&0==--hl&&(Do.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const F=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=F;this.currentLayer++){const F=Pt[this.currentLayer];if(!F.hasLightBeamPass())continue;const Le=Me.getLayerSourceCache(F);this.renderLayer(this,Le,F,Le?Xn[Le.id]:void 0)}this.currentLayer=F,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const F=this.currentLayer;this.depthOcclusion=!0;for(const F of this.layersWithOcclusionOpacity){this.currentLayer=F;const Le=Pt[this.currentLayer],Oe=Me.getLayerSourceCache(Le),Fe=Oe?Xn[Oe.id]:void 0;this.terrain||this._renderTileClippingMasks(Le,Oe,Oe?qr[Oe.id]:void 0),this.renderLayer(this,Oe,Le,Fe)}this.depthOcclusion=!1,this.currentLayer=F,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Le=null;Pt.forEach((F=>{const Oe=Me.getLayerSourceCache(F);Oe&&!F.isHidden(this.transform.zoom)&&Oe.getVisibleCoordinates().length&&(!Le||Le.getSource().maxzoom<Oe.getSource().maxzoom)&&(Le=Oe)})),Le&&this.options.showTileBoundaries&&ff.debug(this,Le,Le.getVisibleCoordinates(),F.al.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&ff.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new F.al(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(F){const Me=F.transform.padding;cn(F,F.transform.height-(Me.top||0),3,Up),cn(F,Me.bottom||0,3,Gp),hn(F,Me.left||0,3,qp),hn(F,F.transform.width-(Me.right||0),3,$p);const Le=F.transform.centerPoint;!function(F,Me,Le,Oe){dn(F,Me-1,Le-10,2,20,Oe),dn(F,Me-10,Le-1,20,2,Oe)}(F,Le.x,F.transform.height-Le.y,Zp)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),bi||(this.conflationActive=!1)}prepareLayer(F){this.gpuTimingStart(F);const{unsupportedLayers:Me}=this.transform.projection,Le=!Me||!Me.includes(F.type);if(mf[F.type]&&(Le||this.terrain&&"custom"===F.type)){const Me=this.style.getLayerSourceCache(F);mf[F.type](F,Me,this)}this.gpuTimingEnd()}renderLayer(F,Me,Le,Oe){Le.isHidden(this.transform.zoom)||("background"===Le.type||"sky"===Le.type||"custom"===Le.type||"model"===Le.type||"raster"===Le.type||"raster-particle"===Le.type||Oe&&Oe.length)&&(this.id=Le.id,this.gpuTimingStart(Le),F.transform.projection.unsupportedLayers&&F.transform.projection.unsupportedLayers.includes(Le.type)&&(!F.terrain||"custom"!==Le.type)||"clip"===Le.type||ff[Le.type](F,Me,Le,Oe,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(F){if(!this.options.gpuTiming)return;const Me=this.context.extTimerQuery,Le=this.context.gl;let Oe=this.gpuTimers[F.id];Oe||(Oe=this.gpuTimers[F.id]={calls:0,cpuTime:0,query:Le.createQuery()}),Oe.calls++,Le.beginQuery(Me.TIME_ELAPSED_EXT,Oe.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const F=this.context.extTimerQuery,Me=this.context.gl,Le=Me.createQuery();this.deferredRenderGpuTimeQueries.push(Le),Me.beginQuery(F.TIME_ELAPSED_EXT,Le)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const F=this.gpuTimers;return this.gpuTimers={},F}collectDeferredRenderGpuQueries(){const F=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],F}queryGpuTimers(F){const Me={};for(const Le in F){const Oe=F[Le],Fe=this.context.extTimerQuery,je=Fe.getQueryParameter(Oe.query,this.context.gl.QUERY_RESULT)/1e6;Fe.deleteQueryEXT(Oe.query),Me[Le]=je}return Me}queryGpuTimeDeferredRender(F){if(!this.options.gpuTimingDeferredRender)return 0;const Me=this.context.gl;let Le=0;for(const Oe of F)Le+=Me.getQueryParameter(Oe,Me.QUERY_RESULT)/1e6,Me.deleteQuery(Oe);return Le}translatePosMatrix(Me,Le,Oe,Fe,je){if(!Oe[0]&&!Oe[1])return Me;const qe=je?"map"===Fe?this.transform.angle:0:"viewport"===Fe?-this.transform.angle:0;if(qe){const F=Math.sin(qe),Me=Math.cos(qe);Oe=[Oe[0]*Me-Oe[1]*F,Oe[0]*F+Oe[1]*Me]}const He=[je?Oe[0]:F.at(Le,Oe[0],this.transform.zoom),je?Oe[1]:F.at(Le,Oe[1],this.transform.zoom),0],xt=new Float32Array(16);return F.ad.mat4.translate(xt,Me,He),xt}saveTileTexture(F){const Me=F.size[0],Le=this._tileTextures[Me];Le?Le.push(F):this._tileTextures[Me]=[F]}getTileTexture(F){const Me=this._tileTextures[F];return Me&&Me.length>0?Me.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(F,Me,Le){const Oe=void 0===Le?this.terrain&&this.terrain.renderingToTexture:Le,Fe=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===F||"terrainRaster"===F?(Fe.push("LIGHTING_3D_MODE"),Fe.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):Oe||Fe.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||Fe.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(Fe.push("TERRAIN"),this.linearFloatFilteringSupported()&&Fe.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&Fe.push("GLOBE"),!this._fogVisible||Oe||void 0!==Me&&!Me||Fe.push("FOG","FOG_DITHERING"),Oe&&Fe.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&Fe.push("OVERDRAW_INSPECTOR"),Fe}getOrCreateProgram(F,Me){this.cache=this.cache||{};const Le=Me&&Me.defines||[],Oe=Me&&Me.config,Fe=this.currentGlobalDefines(F,Me&&Me.overrideFog,Me&&Me.overrideRtt).concat(Le),je=Ws.cacheKey(Vd[F],F,Fe,Oe);return this.cache[je]||(this.cache[je]=new Ws(this.context,F,Vd[F],Oe,Tp[F],Fe)),this.cache[je]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const F=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(F.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new F.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(Me,Le){if(this.style.enable3dLights()){const Oe=this.style.directionalLight,Fe=this.style.ambientLight;if(Oe&&Fe){const je=((Me,Le,Oe)=>{const Fe=Me.properties.get("direction"),je="none"===Me.properties.get("color-use-theme"),qe=Me.properties.get("color").toRenderColor(je?null:Oe.getLut(Me.scope)).toArray01(),He=Me.properties.get("intensity"),xt="none"===Le.properties.get("color-use-theme"),Pt=Le.properties.get("color").toRenderColor(xt?null:Oe.getLut(Le.scope)).toArray01(),jt=Le.properties.get("intensity"),Gt=[Fe.x,Fe.y,Fe.z],bi=F.cN(Pt,jt),wi=F.cN(qe,He);return{u_lighting_ambient_color:bi,u_lighting_directional_dir:Gt,u_lighting_directional_color:wi,u_ground_radiance:qs(Gt,wi,bi)}})(Oe,Fe,this.style);Le.setLightsUniformValues(Me,je)}}}uploadCommonUniforms(Me,Le,Oe,Fe,je){if(this.uploadCommonLightUniforms(Me,Le),this.terrain&&this.terrain.renderingToTexture)return;const qe=this.style.fog;if(qe){const je=qe.getOpacity(this.transform.pitch),He=((Me,Le,Oe,Fe,je,qe,He,xt,Pt,jt,Gt,bi)=>{const wi=Me.transform,qr="none"===Le.properties.get("color-use-theme"),Xn=Le.properties.get("color").toRenderColor(qr?null:Me.style.getLut(Le.scope)).toArray01();Xn[3]=Fe;const Yn=Me.frameCounter/1e3%1,[yo,bo]=Le.properties.get("vertical-range");return{u_fog_matrix:Oe?wi.calculateFogTileMatrix(Oe):bi||Me.identityMat,u_fog_range:Le.getFovAdjustedRange(wi._fov),u_fog_color:Xn,u_fog_horizon_blend:Le.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(yo,bo),bo],u_fog_temporal_offset:Yn,u_frustum_tl:je,u_frustum_tr:qe,u_frustum_br:He,u_frustum_bl:xt,u_globe_pos:Pt,u_globe_radius:jt,u_viewport:Gt,u_globe_transition:F.ag(wi.zoom),u_is_globe:+("globe"===wi.projection.name)}})(this,qe,Oe,je,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*F.q.devicePixelRatio,this.transform.height*F.q.devicePixelRatio],Fe);Le.setFogUniformValues(Me,He)}je&&Le.setCutoffUniformValues(Me,je.uniformValues)}setTileLoadedFlag(F){this.tileLoaded=F}saveCanvasCopy(){const F=this.canvasCopy();F&&(this.frameCopies.push(F),this.tileLoaded=!1)}canvasCopy(){const F=this.context.gl,Me=F.createTexture();return F.bindTexture(F.TEXTURE_2D,Me),F.copyTexImage2D(F.TEXTURE_2D,0,F.RGBA,0,0,F.drawingBufferWidth,F.drawingBufferHeight,0),Me}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const F=this.style&&this.style.fog;return!!F&&0!==F.getOpacity(this.transform.pitch)}getBackgroundTiles(){const F=this._backgroundTiles,Me=this._backgroundTiles={},Le=this.transform.coveringTiles({tileSize:512});for(const Oe of Le)Me[Oe.key]=F[Oe.key]||new bt(Oe,512,this.transform.tileZoom,this);return Me}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(F,Me){return!(!F.is3D(!(!this.terrain||!this.terrain.enabled))||"clip"!==F.type&&(F.minzoom&&F.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==F.sourceLayer)&&(!Me||"batched-model"!==Me.type)))}isTileAffectedByFog(F){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let Me=this._cachedTileFogOpacities[F.key];return Me||(this._cachedTileFogOpacities[F.key]=Me=this.style.fog.getOpacityForTile(F)),Me[0]>=ec||Me[1]>=ec}setupDepthForOcclusion(F,Me,Le){const Oe=this.context,Fe=Oe.gl,je=!!Le;var qe;Le||(Le={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),Oe.activeTexture.set(Fe.TEXTURE3),F&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(Fe.NEAREST,Fe.CLAMP_TO_EDGE),Le.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],Le.u_depth_range_unpack=[2/((qe=this.depthRangeFor3D)[1]-qe[0]),-1-2*qe[0]/(qe[1]-qe[0])],Le.u_occluder_half_size=.5*this.occlusionParams.occluderSize,Le.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(Fe.NEAREST,Fe.CLAMP_TO_EDGE),Oe.activeTexture.set(Fe.TEXTURE0),je||Me.setTerrainUniformValues(Oe,Le)}}function ta(F,Me){let Le=!1,Oe=null;const s=()=>{Oe=null,Le&&(F(),Oe=setTimeout(s,Me),Le=!1)};return()=>(Le=!0,Oe||s(),Oe)}class ia{constructor(Me){this._hashName=Me&&encodeURIComponent(Me),F.aQ(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=ta(this._updateHashUnthrottled.bind(this),300)}addTo(F){return this._map=F,window.addEventListener("hashchange",this._onHashChange,!1),F.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const F=this._map;if(!F)return"";const Me=oa(F);if(this._hashName){const F=this._hashName;let Le=!1;const Oe=location.hash.slice(1).split("&").map((Oe=>{const Fe=Oe.split("=")[0];return Fe===F?(Le=!0,`${Fe}=${Me}`):Oe})).filter((F=>F));return Le||Oe.push(`${F}=${Me}`),`#${Oe.join("&")}`}return`#${Me}`}_getCurrentHash(){const F=location.hash.replace("#","");if(this._hashName){let Me;return F.split("&").map((F=>F.split("="))).forEach((F=>{F[0]===this._hashName&&(Me=F)})),(Me&&Me[1]||"").split("/")}return F.split("/")}_onHashChange(){const F=this._map;if(!F)return!1;const Me=this._getCurrentHash();if(Me.length>=3&&!Me.some((F=>isNaN(F)))){const Le=F.dragRotate.isEnabled()&&F.touchZoomRotate.isEnabled()?+(Me[3]||0):F.getBearing();return F.jumpTo({center:[+Me[2],+Me[1]],zoom:+Me[0],bearing:Le,pitch:+(Me[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function oa(F,Me){const Le=F.getCenter(),Oe=Math.round(100*F.getZoom())/100,Fe=Math.ceil((Oe*Math.LN2+Math.log(512/360/.5))/Math.LN10),je=Math.pow(10,Fe),qe=Math.round(Le.lng*je)/je,He=Math.round(Le.lat*je)/je,xt=F.getBearing(),Pt=F.getPitch();let jt=Me?`/${qe}/${He}/${Oe}`:`${Oe}/${He}/${qe}`;return(xt||Pt)&&(jt+="/"+Math.round(10*xt)/10),Pt&&(jt+=`/${Math.round(Pt)}`),jt}const yf={linearity:.3,easing:F.dB(0,0,.3,1)},xf=F.l({deceleration:2500,maxSpeed:1400},yf),Tf=F.l({deceleration:20,maxSpeed:1400},yf),Ef=F.l({deceleration:1e3,maxSpeed:360},yf),Mf=F.l({deceleration:1e3,maxSpeed:90},yf);class ca{constructor(F){this._map=F,this.clear()}clear(){this._inertiaBuffer=[]}record(Me){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:F.q.now(),settings:Me})}_drainInertiaBuffer(){const Me=this._inertiaBuffer,Le=F.q.now();for(;Me.length>0&&Le-Me[0].time>160;)Me.shift()}_onMoveEnd(Me){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const Le={zoom:0,bearing:0,pitch:0,pan:new F.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:F}of this._inertiaBuffer)Le.zoom+=F.zoomDelta||0,Le.bearing+=F.bearingDelta||0,Le.pitch+=F.pitchDelta||0,F.panDelta&&Le.pan._add(F.panDelta),F.around&&(Le.around=F.around),F.pinchAround&&(Le.pinchAround=F.pinchAround);const Oe=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,Fe={};if(Le.pan.mag()){const je=da(Le.pan.mag(),Oe,F.l({},xf,Me||{}));Fe.offset=Le.pan.mult(je.amount/Le.pan.mag()),Fe.center=this._map.transform.center,ha(Fe,je)}if(Le.zoom){const F=da(Le.zoom,Oe,Tf);Fe.zoom=this._map.transform.zoom+F.amount,ha(Fe,F)}if(Le.bearing){const Me=da(Le.bearing,Oe,Ef);Fe.bearing=this._map.transform.bearing+F.ay(Me.amount,-179,179),ha(Fe,Me)}if(Le.pitch){const F=da(Le.pitch,Oe,Mf);Fe.pitch=this._map.transform.pitch+F.amount,ha(Fe,F)}if(Fe.zoom||Fe.bearing){const F=void 0===Le.pinchAround?Le.around:Le.pinchAround;Fe.around=F?this._map.unproject(F):this._map.getCenter()}return this.clear(),Fe.noMoveStart=!0,Fe}}function ha(F,Me){(!F.duration||F.duration<Me.duration)&&(F.duration=Me.duration,F.easing=Me.easing)}function da(Me,Le,Oe){const{maxSpeed:Fe,linearity:je,deceleration:qe}=Oe,He=F.ay(Me*je/(Le/1e3),-Fe,Fe),xt=Math.abs(He)/(qe*je);return{easing:Oe.easing,duration:1e3*xt,amount:He*(xt/2)}}class ua extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(Me,Le,Oe,Fe={}){const je=g(Le.getCanvasContainer(),Oe),qe=Le.unproject(je);super(Me,F.l({point:je,lngLat:qe,originalEvent:Oe},Fe)),this._defaultPrevented=!1,this.target=Le}}class _a extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(Me,Le,Oe){const Fe="touchend"===Me?Oe.changedTouches:Oe.touches,je=v(Le.getCanvasContainer(),Fe),qe=je.map((F=>Le.unproject(F))),He=je.reduce(((F,Me,Le,Oe)=>F.add(Me.div(Oe.length))),new F.P(0,0));super(Me,{points:je,point:He,lngLats:qe,lngLat:Le.unproject(He),originalEvent:Oe}),this._defaultPrevented=!1}}class pa extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(F,Me){super("wheel",{originalEvent:Me}),this._defaultPrevented=!1}}class fa{constructor(F,Me){this._map=F,this._clickTolerance=Me.clickTolerance}reset(){this._mousedownPos=void 0}wheel(F){return this._firePreventable(new pa(this._map,F))}mousedown(F,Me){return this._mousedownPos=Me,this._firePreventable(new ua(F.type,this._map,F))}mouseup(F){this._map.fire(new ua(F.type,this._map,F))}preclick(Me){const Le=F.l({},Me);Le.type="preclick",this._map.fire(new ua(Le.type,this._map,Le))}click(F,Me){this._mousedownPos&&this._mousedownPos.dist(Me)>=this._clickTolerance||(this.preclick(F),this._map.fire(new ua(F.type,this._map,F)))}dblclick(F){return this._firePreventable(new ua(F.type,this._map,F))}mouseover(F){this._map.fire(new ua(F.type,this._map,F))}mouseout(F){this._map.fire(new ua(F.type,this._map,F))}touchstart(F){return this._firePreventable(new _a(F.type,this._map,F))}touchmove(F){this._map.fire(new _a(F.type,this._map,F))}touchend(F){this._map.fire(new _a(F.type,this._map,F))}touchcancel(F){this._map.fire(new _a(F.type,this._map,F))}_firePreventable(F){if(this._map.fire(F),F.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ma{constructor(F){this._map=F}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(F){this._map.fire(new ua(F.type,this._map,F))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ua("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(F){this._delayContextMenu?this._contextMenuEvent=F:this._map.fire(new ua(F.type,this._map,F)),this._map.listens("contextmenu")&&F.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ga{constructor(F,Me){this._map=F,this._el=F.getCanvasContainer(),this._container=F.getContainer(),this._clickTolerance=Me.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(F,Me){this.isEnabled()&&F.shiftKey&&0===F.button&&(_(),this._startPos=this._lastPos=Me,this._active=!0)}mousemoveWindow(F,Me){if(!this._active)return;const Le=Me,Oe=this._startPos,Fe=this._lastPos;if(!Oe||!Fe||Fe.equals(Le)||!this._box&&Le.dist(Oe)<this._clickTolerance)return;this._lastPos=Le,this._box||(this._box=l("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",F));const je=Math.min(Oe.x,Le.x),qe=Math.max(Oe.x,Le.x),He=Math.min(Oe.y,Le.y),xt=Math.max(Oe.y,Le.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${je}px,${He}px)`,this._box.style.width=qe-je+"px",this._box.style.height=xt-He+"px")}))}mouseupWindow(Me,Le){if(!this._active)return;const Oe=this._startPos,Fe=Le;if(Oe&&0===Me.button){if(this.reset(),m(),Oe.x!==Fe.x||Oe.y!==Fe.y)return this._map.fire(new F.A("boxzoomend",{originalEvent:Me})),{cameraAnimation:F=>F.fitScreenCoordinates(Oe,Fe,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",Me)}}keydown(F){this._active&&27===F.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",F))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),p(),delete this._startPos,delete this._lastPos}_fireEvent(Me,Le){return this._map.fire(new F.A(Me,{originalEvent:Le}))}}function va(F,Me){const Le={};for(let Oe=0;Oe<F.length;Oe++)Le[F[Oe].identifier]=Me[Oe];return Le}class ya{constructor(F){this.reset(),this.numTouches=F.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(Me,Le,Oe){(this.centroid||Oe.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=Me.timeStamp),Oe.length===this.numTouches&&(this.centroid=function(Me){const Le=new F.P(0,0);for(const F of Me)Le._add(F);return Le.div(Me.length)}(Le),this.touches=va(Oe,Le)))}touchmove(F,Me,Le){if(this.aborted||!this.centroid)return;const Oe=va(Le,Me);for(const F in this.touches){const Me=Oe[F];(!Me||Me.dist(this.touches[F])>30)&&(this.aborted=!0)}}touchend(F,Me,Le){if((!this.centroid||F.timeStamp-this.startTime>500)&&(this.aborted=!0),0===Le.length){const F=!this.aborted&&this.centroid;if(this.reset(),F)return F}}}class xa{constructor(F){this.singleTap=new ya(F),this.numTaps=F.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(F,Me,Le){this.singleTap.touchstart(F,Me,Le)}touchmove(F,Me,Le){this.singleTap.touchmove(F,Me,Le)}touchend(F,Me,Le){const Oe=this.singleTap.touchend(F,Me,Le);if(Oe){const Me=F.timeStamp-this.lastTime<500,Le=!this.lastTap||this.lastTap.dist(Oe)<30;if(Me&&Le||this.reset(),this.count++,this.lastTime=F.timeStamp,this.lastTap=Oe,this.count===this.numTaps)return this.reset(),Oe}}}class ba{constructor(){this._zoomIn=new xa({numTouches:1,numTaps:2}),this._zoomOut=new xa({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(F,Me,Le){this._zoomIn.touchstart(F,Me,Le),this._zoomOut.touchstart(F,Me,Le)}touchmove(F,Me,Le){this._zoomIn.touchmove(F,Me,Le),this._zoomOut.touchmove(F,Me,Le)}touchend(F,Me,Le){const Oe=this._zoomIn.touchend(F,Me,Le),Fe=this._zoomOut.touchend(F,Me,Le);return Oe?(this._active=!0,F.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:Me=>Me.easeTo({duration:300,zoom:Me.getZoom()+1,around:Me.unproject(Oe)},{originalEvent:F})}):Fe?(this._active=!0,F.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:Me=>Me.easeTo({duration:300,zoom:Me.getZoom()-1,around:Me.unproject(Fe)},{originalEvent:F})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const If={0:1,2:2},Cf={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Ea{constructor(F){this.reset(),this._clickTolerance=F.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(F,Me){return!1}_move(F,Me){return{}}mousedown(F,Me){if(this._lastPoint)return;const Le=y(F);this._correctButton(F,Le)&&(this._lastPoint=Me,this._eventButton=Le)}mousemoveWindow(F,Me){const Le=this._lastPoint;if(Le)if(F.preventDefault(),null!=this._eventButton&&function(F,Me){const Le=If[Me];return void 0===F.buttons||(F.buttons&Le)!==Le}(F,this._eventButton))this.reset();else if(this._moved||!(Me.dist(Le)<this._clickTolerance))return this._moved=!0,this._lastPoint=Me,this._move(Le,Me)}mouseupWindow(F){this._lastPoint&&y(F)===this._eventButton&&(this._moved&&m(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Sa extends Ea{mousedown(F,Me){super.mousedown(F,Me),this._lastPoint&&(this._active=!0)}_correctButton(F,Me){return 0===Me&&!F.ctrlKey}_move(F,Me){return{around:Me,panDelta:Me.sub(F)}}}class Ca extends Ea{constructor(F){super(F),this._pitchRotateKey=F.pitchRotateKey?Cf[F.pitchRotateKey]:void 0}_correctButton(F,Me){return this._pitchRotateKey?0===Me&&F[this._pitchRotateKey]:0===Me&&F.ctrlKey||2===Me}_move(F,Me){const Le=.8*(Me.x-F.x);if(Le)return this._active=!0,{bearingDelta:Le}}contextmenu(F){this._pitchRotateKey||F.preventDefault()}}class Ia extends Ea{constructor(F){super(F),this._pitchRotateKey=F.pitchRotateKey?Cf[F.pitchRotateKey]:void 0}_correctButton(F,Me){return this._pitchRotateKey?0===Me&&F[this._pitchRotateKey]:0===Me&&F.ctrlKey||2===Me}_move(F,Me){const Le=-.5*(Me.y-F.y);if(Le)return this._active=!0,{pitchDelta:Le}}contextmenu(F){this._pitchRotateKey||F.preventDefault()}}class Ra{constructor(Me,Le){this._map=Me,this._el=Me.getCanvasContainer(),this._minTouches=1,this._clickTolerance=Le.clickTolerance||1,this.reset(),F.aQ(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new F.P(0,0)}touchstart(F,Me,Le){return this._calculateTransform(F,Me,Le)}touchmove(Me,Le,Oe){if(this._active&&!(Oe.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===Oe.length&&!F.dC())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return Me.cancelable&&Me.preventDefault(),this._calculateTransform(Me,Le,Oe)}}touchend(F,Me,Le){this._calculateTransform(F,Me,Le),this._active&&Le.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(Me,Le,Oe){Oe.length>0&&(this._active=!0);const Fe=va(Oe,Le),je=new F.P(0,0),qe=new F.P(0,0);let He=0;for(const F in Fe){const Me=Fe[F],Le=this._touches[F];Le&&(je._add(Me),qe._add(Me.sub(Le)),He++,Fe[F]=Me)}if(this._touches=Fe,He<this._minTouches||!qe.mag())return;const xt=qe.div(He);return this._sum._add(xt),this._sum.mag()<this._clickTolerance?void 0:{around:je.div(He),panDelta:xt}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class Da{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(F){}_move(F,Me,Le){return{}}touchstart(F,Me,Le){this._firstTwoTouches||Le.length<2||(this._firstTwoTouches=[Le[0].identifier,Le[1].identifier],this._start([Me[0],Me[1]]))}touchmove(F,Me,Le){const Oe=this._firstTwoTouches;if(!Oe)return;F.preventDefault();const[Fe,je]=Oe,qe=Aa(Le,Me,Fe),He=Aa(Le,Me,je);if(!qe||!He)return;const xt=this._aroundCenter?null:qe.add(He).div(2);return this._move([qe,He],xt,F)}touchend(F,Me,Le){if(!this._firstTwoTouches)return;const[Oe,Fe]=this._firstTwoTouches,je=Aa(Le,Me,Oe),qe=Aa(Le,Me,Fe);je&&qe||(this._active&&m(),this.reset())}touchcancel(){this.reset()}enable(F){this._enabled=!0,this._aroundCenter=!!F&&"center"===F.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Aa(F,Me,Le){for(let Oe=0;Oe<F.length;Oe++)if(F[Oe].identifier===Le)return Me[Oe]}function La(F,Me){return Math.log(F/Me)/Math.LN2}class Pa extends Da{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(F){this._startDistance=this._distance=F[0].dist(F[1])}_move(F,Me){const Le=this._distance;if(this._distance=F[0].dist(F[1]),this._active||!(Math.abs(La(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:La(this._distance,Le),pinchAround:Me}}}function Ma(F,Me){return 180*F.angleWith(Me)/Math.PI}class za extends Da{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(F){this._startVector=this._vector=F[0].sub(F[1]),this._minDiameter=F[0].dist(F[1])}_move(F,Me){const Le=this._vector;if(this._vector=F[0].sub(F[1]),Le&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Ma(this._vector,Le),pinchAround:Me}}_isBelowThreshold(F){this._minDiameter=Math.min(this._minDiameter,F.mag());const Me=25/(Math.PI*this._minDiameter)*360,Le=this._startVector;if(!Le)return!1;const Oe=Ma(F,Le);return Math.abs(Oe)<Me}}function Oa(F){return Math.abs(F.y)>Math.abs(F.x)}class Fa extends Da{constructor(F){super(),this._map=F}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(F){this._lastPoints=F,Oa(F[0].sub(F[1]))&&(this._valid=!1)}_move(Me,Le,Oe){const Fe=this._lastPoints;if(!Fe)return;const je=Me[0].sub(Fe[0]),qe=Me[1].sub(Fe[1]);return this._map._cooperativeGestures&&!F.dC()&&Oe.touches.length<3||(this._valid=this.gestureBeginsVertically(je,qe,Oe.timeStamp),!this._valid)?void 0:(this._lastPoints=Me,this._active=!0,{pitchDelta:(je.y+qe.y)/2*-.5})}gestureBeginsVertically(F,Me,Le){if(void 0!==this._valid)return this._valid;const Oe=F.mag()>=2,Fe=Me.mag()>=2;if(!Oe&&!Fe)return;if(!Oe||!Fe)return null==this._firstMove&&(this._firstMove=Le),Le-this._firstMove<100&&void 0;const je=F.y>0==Me.y>0;return Oa(F)&&Oa(Me)&&je}}const zf={panStep:100,bearingStep:15,pitchStep:10};class Ba{constructor(){const F=zf;this._panStep=F.panStep,this._bearingStep=F.bearingStep,this._pitchStep=F.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(F){if(F.altKey||F.ctrlKey||F.metaKey)return;let Me=0,Le=0,Oe=0,Fe=0,je=0;switch(F.keyCode){case 61:case 107:case 171:case 187:Me=1;break;case 189:case 109:case 173:Me=-1;break;case 37:F.shiftKey?Le=-1:(F.preventDefault(),Fe=-1);break;case 39:F.shiftKey?Le=1:(F.preventDefault(),Fe=1);break;case 38:F.shiftKey?Oe=1:(F.preventDefault(),je=-1);break;case 40:F.shiftKey?Oe=-1:(F.preventDefault(),je=1);break;default:return}return this._rotationDisabled&&(Le=0,Oe=0),{cameraAnimation:qe=>{const He=qe.getZoom();qe.easeTo({duration:300,easeId:"keyboardHandler",easing:Na,zoom:Me?Math.round(He)+Me*(F.shiftKey?2:1):He,bearing:qe.getBearing()+Le*this._bearingStep,pitch:qe.getPitch()+Oe*this._pitchStep,offset:[-Fe*this._panStep,-je*this._panStep],center:qe.getCenter()},{originalEvent:F})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Na(F){return F*(2-F)}const Df=4.000244140625,Of=1/450;class Ga{constructor(Me,Le){this._map=Me,this._el=Me.getCanvasContainer(),this._handler=Le,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Of,F.aQ(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(F){this._defaultZoomRate=F}setWheelZoomRate(F){this._wheelZoomRate=F}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(F){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!F&&"center"===F.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(Me){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(Me.ctrlKey||Me.metaKey||this.isZooming()||F.dC()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let Le=Me.deltaMode===WheelEvent.DOM_DELTA_LINE?40*Me.deltaY:Me.deltaY;const Oe=F.q.now(),Fe=Oe-(this._lastWheelEventTime||0);this._lastWheelEventTime=Oe,0!==Le&&Le%Df==0?this._type="wheel":0!==Le&&Math.abs(Le)<4?this._type="trackpad":Fe>400?(this._type=null,this._lastValue=Le,this._timeout=window.setTimeout(this._onTimeout,40,Me)):this._type||(this._type=Math.abs(Fe*Le)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,Le+=this._lastValue)),Me.shiftKey&&Le&&(Le/=4),this._type&&(this._lastWheelEvent=Me,this._delta-=Le,this._active||this._start(Me)),Me.preventDefault()}_onTimeout(F){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(F)}_start(F){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const Me=g(this._el,F);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:Me,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const Me=this._map.transform;"wheel"===this._type&&Me.projection.wrap&&(Me._center.lng>=180||Me._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>Me._terrainEnabled()&&this._aroundCoord?Me.computeZoomRelativeTo(this._aroundCoord):Me.zoom;if(0!==this._delta){const F="wheel"===this._type&&Math.abs(this._delta)>Df?this._wheelZoomRate:this._defaultZoomRate;let Le=2/(1+Math.exp(-Math.abs(this._delta*F)));this._delta<0&&0!==Le&&(Le=1/Le);const Oe=i(),Fe=Math.pow(2,Oe),je="number"==typeof this._targetZoom?Me.zoomScale(this._targetZoom):Fe;this._targetZoom=Math.min(Me.maxZoom,Math.max(Me.minZoom,Me.scaleZoom(je*Le))),"wheel"===this._type&&(this._startZoom=Oe,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const Le="number"==typeof this._targetZoom?this._targetZoom:i(),Oe=this._startZoom,Fe=this._easing;let je,qe=!1;if("wheel"===this._type&&Oe&&Fe){const Me=Math.min((F.q.now()-this._lastWheelEventTime)/200,1),He=Fe(Me);je=F.ah(Oe,Le,He),Me<1?this._frameId||(this._frameId=!0):qe=!0}else je=Le,qe=!0;this._active=!0,qe&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let He=je-i();return He*this._lastDelta<0&&(He=0),{noInertia:!0,needsRenderFrame:!qe,zoomDelta:He,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(Me){let Le=F.dD;if(this._prevEase){const Me=this._prevEase,Oe=(F.q.now()-Me.start)/Me.duration,Fe=Me.easing(Oe+.01)-Me.easing(Oe),je=.27/Math.sqrt(Fe*Fe+1e-4)*.01,qe=Math.sqrt(.0729-je*je);Le=F.dB(je,qe,.25,1)}return this._prevEase={start:F.q.now(),duration:Me,easing:Le},Le}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class ja{constructor(F,Me){this._clickZoom=F,this._tapZoom=Me}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class qa{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(F,Me){return F.preventDefault(),{cameraAnimation:Le=>{Le.easeTo({duration:300,zoom:Le.getZoom()+(F.shiftKey?-1:1),around:Le.unproject(Me)},{originalEvent:F})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ha{constructor(){this._tap=new xa({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(F,Me,Le){this._swipePoint||(this._tapTime&&F.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?Le.length>0&&(this._swipePoint=Me[0],this._swipeTouch=Le[0].identifier):this._tap.touchstart(F,Me,Le))}touchmove(F,Me,Le){if(this._tapTime){if(this._swipePoint){if(Le[0].identifier!==this._swipeTouch)return;const Oe=Me[0],Fe=Oe.y-this._swipePoint.y;return this._swipePoint=Oe,F.preventDefault(),this._active=!0,{zoomDelta:Fe/128}}}else this._tap.touchmove(F,Me,Le)}touchend(F,Me,Le){this._tapTime?this._swipePoint&&0===Le.length&&this.reset():this._tap.touchend(F,Me,Le)&&(this._tapTime=F.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Za{constructor(F,Me,Le){this._el=F,this._mousePan=Me,this._touchPan=Le}enable(F){this._inertiaOptions=F||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Wa{constructor(F,Me,Le){this._pitchWithRotate=F.pitchWithRotate,this._mouseRotate=Me,this._mousePitch=Le}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class $a{constructor(F,Me,Le,Oe){this._el=F,this._touchZoom=Me,this._touchRotate=Le,this._tapDragZoom=Oe,this._rotationDisabled=!1,this._enabled=!0}enable(F){this._touchZoom.enable(F),this._rotationDisabled||this._touchRotate.enable(F),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Xa=F=>F.zoom||F.drag||F.pitch||F.rotate;class Ka extends F.A{}class Ya{constructor(){this.constants=[1,1,.01],this.radius=0}setup(Me,Le){const Oe=F.ad.vec3.sub([],Le,Me);this.radius=F.ad.vec3.length(Oe[2]<0?F.ad.vec3.div([],Oe,this.constants):[Oe[0],Oe[1],0])}projectRay(Me){F.ad.vec3.div(Me,Me,this.constants),F.ad.vec3.normalize(Me,Me),F.ad.vec3.mul(Me,Me,this.constants);const Le=F.ad.vec3.scale([],Me,this.radius);if(Le[2]>0){const Me=F.ad.vec3.scale([],[0,0,1],F.ad.vec3.dot(Le,[0,0,1])),Oe=F.ad.vec3.scale([],F.ad.vec3.normalize([],[Le[0],Le[1],0]),this.radius),Fe=F.ad.vec3.add([],Le,F.ad.vec3.scale([],F.ad.vec3.sub([],F.ad.vec3.add([],Oe,Me),Le),2));Le[0]=Fe[0],Le[1]=Fe[1]}return Le}}function Ja(F){return F.panDelta&&F.panDelta.mag()||F.zoomDelta||F.bearingDelta||F.pitchDelta}class Qa{constructor(Me,Le){this._map=Me,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ca(Me),this._bearingSnap=Le.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Ya,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(Le),F.aQ(["handleEvent","handleWindowEvent"],this);const Oe=this._el;this._listeners=[[Oe,"touchstart",{passive:!0}],[Oe,"touchmove",{passive:!1}],[Oe,"touchend",void 0],[Oe,"touchcancel",void 0],[Oe,"mousedown",void 0],[Oe,"mousemove",void 0],[Oe,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[Oe,"mouseover",void 0],[Oe,"mouseout",void 0],[Oe,"dblclick",void 0],[Oe,"click",void 0],[Oe,"keydown",{capture:!1}],[Oe,"keyup",void 0],[Oe,"wheel",{passive:!1}],[Oe,"contextmenu",void 0],[window,"blur",void 0]];for(const[F,Me,Le]of this._listeners){const Oe=F===document?this.handleWindowEvent:this.handleEvent;F.addEventListener(Me,Oe,Le)}}destroy(){for(const[F,Me,Le]of this._listeners){const Oe=F===document?this.handleWindowEvent:this.handleEvent;F.removeEventListener(Me,Oe,Le)}}_addDefaultHandlers(F){const Me=this._map,Le=Me.getCanvasContainer();this._add("mapEvent",new fa(Me,F));const Oe=Me.boxZoom=new ga(Me,F);this._add("boxZoom",Oe);const Fe=new ba,je=new qa;Me.doubleClickZoom=new ja(je,Fe),this._add("tapZoom",Fe),this._add("clickZoom",je);const qe=new Ha;this._add("tapDragZoom",qe);const He=Me.touchPitch=new Fa(Me);this._add("touchPitch",He);const xt=new Ca(F),Pt=new Ia(F);Me.dragRotate=new Wa(F,xt,Pt),this._add("mouseRotate",xt,["mousePitch"]),this._add("mousePitch",Pt,["mouseRotate"]);const jt=new Sa(F),Gt=new Ra(Me,F);Me.dragPan=new Za(Le,jt,Gt),this._add("mousePan",jt),this._add("touchPan",Gt,["touchZoom","touchRotate"]);const bi=new za,wi=new Pa;Me.touchZoomRotate=new $a(Le,wi,bi,qe),this._add("touchRotate",bi,["touchPan","touchZoom"]),this._add("touchZoom",wi,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ma(Me));const qr=Me.scrollZoom=new Ga(Me,this);this._add("scrollZoom",qr,["mousePan"]);const Xn=Me.keyboard=new Ba;this._add("keyboard",Xn);for(const Le of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])F.interactive&&F[Le]&&Me[Le].enable(F[Le])}_add(F,Me,Le){this._handlers.push({handlerName:F,handler:Me,allowed:Le}),this._handlersById[F]=Me}stop(F){if(!this._updatingCamera){for(const{handler:F}of this._handlers)F.reset();this._inertia.clear(),this._fireEvents({},{},F),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:F}of this._handlers)if(F.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Xa(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(F,Me,Le){for(const Oe in F)if(Oe!==Le&&(!Me||Me.indexOf(Oe)<0))return!0;return!1}handleWindowEvent(F){this.handleEvent(F,`${F.type}Window`)}_getMapTouches(F){const Me=[];for(const Le of F)this._el.contains(Le.target)&&Me.push(Le);return Me}handleEvent(F,Me){this._updatingCamera=!0;const Le="renderFrame"===F.type,Oe=Le?void 0:F,Fe={needsRenderFrame:!1},je={},qe={},He=F.touches?this._getMapTouches(F.touches):void 0,xt=He?v(this._el,He):Le?void 0:g(this._el,F);for(const{handlerName:Le,handler:Pt,allowed:jt}of this._handlers){if(!Pt.isEnabled())continue;let Gt;this._blockedByActive(qe,jt,Le)?Pt.reset():Pt[Me||F.type]&&(Gt=Pt[Me||F.type](F,xt,He),this.mergeHandlerResult(Fe,je,Gt,Le,Oe),Gt&&Gt.needsRenderFrame&&this._triggerRenderFrame()),(Gt||Pt.isActive())&&(qe[Le]=Pt)}const Pt={};for(const F in this._previousActiveHandlers)qe[F]||(Pt[F]=Oe);this._previousActiveHandlers=qe,(Object.keys(Pt).length||Ja(Fe))&&(this._changes.push([Fe,je,Pt]),this._triggerRenderFrame()),(Object.keys(qe).length||Ja(Fe))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:jt}=Fe;jt&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],jt(this._map))}mergeHandlerResult(Me,Le,Oe,Fe,je){if(!Oe)return;F.l(Me,Oe);const qe={handlerName:Fe,originalEvent:Oe.originalEvent||je};void 0!==Oe.zoomDelta&&(Le.zoom=qe),void 0!==Oe.panDelta&&(Le.drag=qe),void 0!==Oe.pitchDelta&&(Le.pitch=qe),void 0!==Oe.bearingDelta&&(Le.rotate=qe)}_applyChanges(){const Me={},Le={},Oe={};for(const[Fe,je,qe]of this._changes)Fe.panDelta&&(Me.panDelta=(Me.panDelta||new F.P(0,0))._add(Fe.panDelta)),Fe.zoomDelta&&(Me.zoomDelta=(Me.zoomDelta||0)+Fe.zoomDelta),Fe.bearingDelta&&(Me.bearingDelta=(Me.bearingDelta||0)+Fe.bearingDelta),Fe.pitchDelta&&(Me.pitchDelta=(Me.pitchDelta||0)+Fe.pitchDelta),void 0!==Fe.around&&(Me.around=Fe.around),void 0!==Fe.aroundCoord&&(Me.aroundCoord=Fe.aroundCoord),void 0!==Fe.pinchAround&&(Me.pinchAround=Fe.pinchAround),Fe.noInertia&&(Me.noInertia=Fe.noInertia),F.l(Le,je),F.l(Oe,qe);this._updateMapTransform(Me,Le,Oe),this._changes=[]}_updateMapTransform(Me,Le,Oe){const Fe=this._map,je=Fe.transform,n=F=>[F.x,F.y,F.z];if((()=>{const F=this._eventsInProgress.drag;return F&&!this._handlersById[F.handlerName].isActive()})()&&!Ja(Me)){const F=je.zoom;je.cameraElevationReference="sea",null!=this._originalZoom&&je._orthographicProjectionAtLowPitch&&"globe"!==je.projection.name&&0===je.pitch?(je.cameraElevationReference="ground",je.zoom=this._originalZoom):(je.recenterOnTerrain(),je.cameraElevationReference="ground"),F!==je.zoom&&this._map._update(!0)}if(je._isCameraConstrained&&Fe._stop(!0),!Ja(Me))return void this._fireEvents(Le,Oe,!0);let{panDelta:qe,zoomDelta:He,bearingDelta:xt,pitchDelta:Pt,around:jt,aroundCoord:Gt,pinchAround:bi}=Me;je._isCameraConstrained&&(He>0&&(He=0),je._isCameraConstrained=!1),void 0!==bi&&(jt=bi),(He||(F=>Le[F]&&!this._eventsInProgress[F])("drag"))&&jt&&(this._dragOrigin=n(je.pointCoordinate3D(jt)),this._originalZoom=je.zoom,this._trackingEllipsoid.setup(je._camera.position,this._dragOrigin)),je.cameraElevationReference="sea",Fe._stop(!0),jt=jt||Fe.transform.centerPoint,xt&&(je.bearing+=xt),Pt&&(je.pitch+=Pt),je._updateCameraState();const wi=[0,0,0];if(qe)if("mercator"===je.projection.name){const F=this._trackingEllipsoid.projectRay(je.screenPointToMercatorRay(jt).dir),Me=this._trackingEllipsoid.projectRay(je.screenPointToMercatorRay(jt.sub(qe)).dir);wi[0]=Me[0]-F[0],wi[1]=Me[1]-F[1]}else{const Me=je.pointCoordinate(jt);if("globe"===je.projection.name){qe=qe.rotate(-je.angle);const Le=je._pixelsPerMercatorPixel/je.worldSize;wi[0]=-qe.x*F.dE(F.aT(Me.y))*Le,wi[1]=-qe.y*F.dE(je.center.lat)*Le}else{const F=je.pointCoordinate(jt.sub(qe));Me&&F&&(wi[0]=F.x-Me.x,wi[1]=F.y-Me.y)}}const qr=je.zoom,Xn=[0,0,0];if(He){const Me=n(Gt||je.pointCoordinate3D(jt)),Le={dir:F.ad.vec3.normalize([],F.ad.vec3.sub([],Me,je._camera.position))};if(Le.dir[2]<0){const Oe=je.zoomDeltaToMovement(Me,He);F.ad.vec3.scale(Xn,Le.dir,Oe)}}const Yn=F.ad.vec3.add(wi,wi,Xn);je._translateCameraConstrained(Yn),He&&Math.abs(je.zoom-qr)>1e-4&&je.recenterOnTerrain(),je.cameraElevationReference="ground",this._map._update(),Me.noInertia||this._inertia.record(Me),this._fireEvents(Le,Oe,!0)}_fireEvents(Me,Le,Oe){const Fe=Xa(this._eventsInProgress),je=Xa(Me),qe={};for(const F in Me){const{originalEvent:Le}=Me[F];this._eventsInProgress[F]||(qe[`${F}start`]=Le),this._eventsInProgress[F]=Me[F]}!Fe&&je&&this._fireEvent("movestart",je.originalEvent);for(const F in qe)this._fireEvent(F,qe[F]);je&&this._fireEvent("move",je.originalEvent);for(const F in Me){const{originalEvent:Le}=Me[F];this._fireEvent(F,Le)}const He={};let xt;for(const F in this._eventsInProgress){const{handlerName:Me,originalEvent:Oe}=this._eventsInProgress[F];this._handlersById[Me].isActive()||(delete this._eventsInProgress[F],xt=Le[Me]||Oe,He[`${F}end`]=xt)}for(const F in He)this._fireEvent(F,He[F]);const Pt=Xa(this._eventsInProgress);if(Oe&&(Fe||je)&&!Pt){this._updatingCamera=!0;const Me=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=F=>0!==F&&-this._bearingSnap<F&&F<this._bearingSnap;Me?(i(Me.bearing||this._map.getBearing())&&(Me.bearing=0),this._map.easeTo(Me,{originalEvent:xt})):(this._map.fire(new F.A("moveend",{originalEvent:xt})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(Me,Le){this._map.fire(new F.A(Me,Le?{originalEvent:Le}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((F=>{this._frameId=void 0,this.handleEvent(new Ka("renderFrame",{timeStamp:F})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const kf="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class tl extends F.E{constructor(Me,Le){super(),this._moving=!1,this._zooming=!1,this.transform=Me,this._bearingSnap=Le.bearingSnap,this._respectPrefersReducedMotion=!1!==Le.respectPrefersReducedMotion,F.aQ(["_renderFrameCallback"],this)}getCenter(){return new F.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(F,Me){return this.jumpTo({center:F},Me)}panBy(Me,Le,Oe){return Me=F.P.convert(Me).mult(-1),this.panTo(this.transform.center,F.l({offset:Me},Le),Oe)}panTo(Me,Le,Oe){return this.easeTo(F.l({center:Me},Le),Oe)}getZoom(){return this.transform.zoom}setZoom(F,Me){return this.jumpTo({zoom:F},Me),this}zoomTo(Me,Le,Oe){return this.easeTo(F.l({zoom:Me},Le),Oe)}zoomIn(F,Me){return this.zoomTo(this.getZoom()+1,F,Me),this}zoomOut(F,Me){return this.zoomTo(this.getZoom()-1,F,Me),this}getBearing(){return this.transform.bearing}setBearing(F,Me){return this.jumpTo({bearing:F},Me),this}getPadding(){return this.transform.padding}setPadding(F,Me){return this.jumpTo({padding:F},Me),this}rotateTo(Me,Le,Oe){return this.easeTo(F.l({bearing:Me},Le),Oe)}resetNorth(Me,Le){return this.rotateTo(0,F.l({duration:1e3},Me),Le),this}resetNorthPitch(Me,Le){return this.easeTo(F.l({bearing:0,pitch:0,duration:1e3},Me),Le),this}snapToNorth(F,Me){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(F,Me):this}getPitch(){return this.transform.pitch}setPitch(F,Me){return this.jumpTo({pitch:F},Me),this}cameraForBounds(Me,Le){Me=F.aB.convert(Me);const Oe=Le&&Le.bearing||0,Fe=Le&&Le.pitch||0,je=Me.getNorthWest(),qe=Me.getSouthEast();return this._cameraForBounds(this.transform,je,qe,Oe,Fe,Le)}_extendPadding(Me){const Le={top:0,right:0,bottom:0,left:0};return null==Me?F.l({},Le,this.transform.padding):"number"==typeof Me?{top:Me,bottom:Me,right:Me,left:Me}:F.l({},Le,Me)}_extendCameraOptions(Me){return(Me=F.l({offset:[0,0],maxZoom:this.transform.maxZoom},Me)).padding=this._extendPadding(Me.padding),Me}_minimumAABBFrustumDistance(F,Me){const Le=Me.max[0]-Me.min[0],Oe=Me.max[1]-Me.min[1];return Le/Oe>F.aspect?Le/(2*Math.tan(.5*F.fovX)*F.aspect):Oe/(2*Math.tan(.5*F.fovY)*F.aspect)}_cameraForBoundsOnGlobe(Me,Le,Oe,Fe,je,qe){const He=Me.clone(),xt=this._extendCameraOptions(qe);He.bearing=Fe,He.pitch=je;const Pt=F.bO.convert(Le),jt=F.bO.convert(Oe),Gt=.5*(Pt.lat+jt.lat),bi=.5*(Pt.lng+jt.lng),wi=F.dF(Gt,bi),qr=F.ad.vec3.normalize([],wi),Xn=F.ad.vec3.normalize([],F.ad.vec3.cross([],qr,[0,1,0])),Yn=F.ad.vec3.cross([],Xn,qr),yo=[Xn[0],Xn[1],Xn[2],0,Yn[0],Yn[1],Yn[2],0,qr[0],qr[1],qr[2],0,0,0,0,1],bo=[wi,F.dF(Pt.lat,Pt.lng),F.dF(jt.lat,Pt.lng),F.dF(jt.lat,jt.lng),F.dF(Pt.lat,jt.lng),F.dF(Gt,Pt.lng),F.dF(Gt,jt.lng),F.dF(Pt.lat,bi),F.dF(jt.lat,bi)];let Ro=F.ce.fromPoints(bo.map((Me=>[F.ad.vec3.dot(Xn,Me),F.ad.vec3.dot(Yn,Me),F.ad.vec3.dot(qr,Me)])));const Do=F.ad.vec3.transformMat4([],Ro.center,yo);0===F.ad.vec3.squaredLength(Do)&&F.ad.vec3.set(Do,0,0,1),F.ad.vec3.normalize(Do,Do),F.ad.vec3.scale(Do,Do,F.az),He.center=F.dG(Do);const zs=He.getWorldToCameraMatrix(),Zs=F.ad.mat4.invert(new Float64Array(16),zs);Ro=F.ce.applyTransform(Ro,F.ad.mat4.multiply([],zs,yo));const na=this._extendAABB(Ro,He,xt,Fe);if(!na)return void F.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Ro=na,F.ad.vec3.transformMat4(Do,Do,zs);const el=.5*(Ro.max[2]-Ro.min[2]),nl=this._minimumAABBFrustumDistance(He,Ro),hl=F.ad.vec3.scale([],[0,0,1],el),pl=F.ad.vec3.add(hl,Do,hl),bl=nl+(0===He.pitch?0:F.ad.vec3.distance(Do,pl)),Tl=He.globeCenterInViewSpace,kl=F.ad.vec3.sub([],Do,[Tl[0],Tl[1],Tl[2]]);F.ad.vec3.normalize(kl,kl),F.ad.vec3.scale(kl,kl,bl);const ec=F.ad.vec3.add([],Do,kl);F.ad.vec3.transformMat4(ec,ec,Zs);const tc=F.dv/F.az,ic=F.ad.vec3.length(ec),oc=F.bH(Math.max(ic*tc-F.dv,Number.EPSILON),0),sc=Math.min(He.zoomFromMercatorZAdjusted(oc),xt.maxZoom);return sc>.5*(F.c6+F.bY)?(He.setProjection({name:"mercator"}),He.zoom=sc,this._cameraForBounds(He,Le,Oe,Fe,je,qe)):{center:He.center,zoom:sc,bearing:Fe,pitch:je}}_extendAABB(Me,Le,Oe,Fe){const je=.5*((Oe.padding.left||0)+(Oe.padding.right||0)),qe=.5*((Oe.padding.top||0)+(Oe.padding.bottom||0)),He=qe,xt=je,Pt=je,jt=qe,Gt=Le.width-(xt+Pt),bi=Le.height-(He+jt),wi=F.ad.vec3.sub([],Me.max,Me.min),qr=Math.min(Gt/wi[0],bi/wi[1]),Xn=Math.min(Le.scaleZoom(Le.scale*qr),Oe.maxZoom);if(isNaN(Xn))return null;const Yn=Le.scale/Le.zoomScale(Xn),yo=new F.ce([Me.min[0]-xt*Yn,Me.min[1]-jt*Yn,Me.min[2]],[Me.max[0]+Pt*Yn,Me.max[1]+He*Yn,Me.max[2]]),bo=("number"==typeof Oe.offset.x&&"number"==typeof Oe.offset.y?new F.P(Oe.offset.x,Oe.offset.y):F.P.convert(Oe.offset)).rotate(-F.ak(Fe));return yo.center[0]-=bo.x*Yn,yo.center[1]+=bo.y*Yn,yo}queryTerrainElevation(Me,Le){const Oe=this.transform.elevation;return Oe?(Le=F.l({},{exaggerated:!0},Le),Oe.getAtPoint(F.ac.fromLngLat(Me),null,Le.exaggerated)):null}_cameraForBounds(Me,Le,Oe,Fe,je,qe){if("globe"===Me.projection.name)return this._cameraForBoundsOnGlobe(Me,Le,Oe,Fe,je,qe);const He=Me.clone(),xt=this._extendCameraOptions(qe);He.bearing=Fe,He.pitch=je;const Pt=F.bO.convert(Le),jt=F.bO.convert(Oe),Gt=new F.bO(Pt.lng,jt.lat),bi=new F.bO(jt.lng,Pt.lat),wi=He.project(Pt),qr=He.project(jt),Xn=this.queryTerrainElevation(Pt),Yn=this.queryTerrainElevation(jt),yo=this.queryTerrainElevation(Gt),bo=this.queryTerrainElevation(bi),Ro=[[wi.x,wi.y,Math.min(Xn||0,Yn||0,yo||0,bo||0)],[qr.x,qr.y,Math.max(Xn||0,Yn||0,yo||0,bo||0)]];let Do=F.ce.fromPoints(Ro);const zs=He.getWorldToCameraMatrix(),Zs=F.ad.mat4.invert(new Float64Array(16),zs);Do=F.ce.applyTransform(Do,zs);const na=this._extendAABB(Do,He,xt,Fe);if(!na)return void F.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Do=na;const el=.5*F.ad.vec3.sub([],Do.max,Do.min)[2],nl=this._minimumAABBFrustumDistance(He,Do),hl=[0,0,1,0];F.ad.vec4.transformMat4(hl,hl,zs),F.ad.vec4.normalize(hl,hl);const pl=F.ad.vec3.scale([],hl,nl+el),bl=F.ad.vec3.add([],Do.center,pl);F.ad.vec3.transformMat4(Do.center,Do.center,Zs),F.ad.vec3.transformMat4(bl,bl,Zs);const Tl=He.unproject(new F.P(Do.center[0],Do.center[1])),kl=F.dH(He.projection,Tl),ec=Math.pow(2,kl),tc=Math.min(He._zoomFromMercatorZ(bl[2]*He.pixelsPerMeter*ec/He.worldSize),xt.maxZoom);return He.mercatorFromTransition&&tc<.5*(F.c6+F.bY)?(He.setProjection({name:"globe"}),He.zoom=tc,this._cameraForBounds(He,Le,Oe,Fe,je,qe)):{center:Tl,zoom:tc,bearing:Fe,pitch:je}}fitBounds(F,Me,Le){const Oe=this.cameraForBounds(F,Me);return this._fitInternal(Oe,Me,Le)}fitScreenCoordinates(Me,Le,Oe,Fe,je){const qe=F.P.convert(Me),He=F.P.convert(Le),xt=new F.P(Math.min(qe.x,He.x),Math.min(qe.y,He.y)),Pt=new F.P(Math.max(qe.x,He.x),Math.max(qe.y,He.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(qe,He))return this;const jt=this.transform.pointLocation3D(xt),Gt=this.transform.pointLocation3D(Pt),bi=this.transform.pointLocation3D(new F.P(xt.x,Pt.y)),wi=this.transform.pointLocation3D(new F.P(Pt.x,xt.y)),qr=[Math.min(jt.lng,Gt.lng,bi.lng,wi.lng),Math.min(jt.lat,Gt.lat,bi.lat,wi.lat)],Xn=[Math.max(jt.lng,Gt.lng,bi.lng,wi.lng),Math.max(jt.lat,Gt.lat,bi.lat,wi.lat)],Yn=Fe&&Fe.pitch?Fe.pitch:this.getPitch(),yo=this._cameraForBounds(this.transform,qr,Xn,Oe,Yn,Fe);return this._fitInternal(yo,Fe,je)}_fitInternal(Me,Le,Oe){return Me?(Le=F.l(Me,Le)).linear?this.easeTo(Le,Oe):this.flyTo(Le,Oe):this}jumpTo(Me,Le){this.stop();const Oe=Me.preloadOnly?this.transform.clone():this.transform;let Fe=!1,je=!1,qe=!1;"zoom"in Me&&Oe.zoom!==+Me.zoom&&(Fe=!0,Oe.zoom=+Me.zoom),void 0!==Me.center&&(Oe.center=F.bO.convert(Me.center)),"bearing"in Me&&Oe.bearing!==+Me.bearing&&(je=!0,Oe.bearing=+Me.bearing),"pitch"in Me&&Oe.pitch!==+Me.pitch&&(qe=!0,Oe.pitch=+Me.pitch);const He="number"==typeof Me.padding?this._extendPadding(Me.padding):Me.padding;if(null!=Me.padding&&!Oe.isPaddingEqual(He))if(!1===Me.retainPadding){const F=Oe.clone();F.padding=He,Oe.setLocationAtPoint(Oe.center,F.centerPoint)}else Oe.padding=He;return Me.preloadOnly?(this._preloadTiles(Oe),this):(this.fire(new F.A("movestart",Le)).fire(new F.A("move",Le)),Fe&&this.fire(new F.A("zoomstart",Le)).fire(new F.A("zoom",Le)).fire(new F.A("zoomend",Le)),je&&this.fire(new F.A("rotatestart",Le)).fire(new F.A("rotate",Le)).fire(new F.A("rotateend",Le)),qe&&this.fire(new F.A("pitchstart",Le)).fire(new F.A("pitch",Le)).fire(new F.A("pitchend",Le)),this.fire(new F.A("moveend",Le)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||F.w(kf),this.transform.getFreeCameraOptions()}setFreeCameraOptions(Me,Le){const Oe=this.transform;if(!Oe.projection.supportsFreeCamera)return F.w(kf),this;this.stop();const Fe=Oe.zoom,je=Oe.pitch,qe=Oe.bearing;Oe.setFreeCameraOptions(Me);const He=Fe!==Oe.zoom,xt=je!==Oe.pitch,Pt=qe!==Oe.bearing;return this.fire(new F.A("movestart",Le)).fire(new F.A("move",Le)),He&&this.fire(new F.A("zoomstart",Le)).fire(new F.A("zoom",Le)).fire(new F.A("zoomend",Le)),Pt&&this.fire(new F.A("rotatestart",Le)).fire(new F.A("rotate",Le)).fire(new F.A("rotateend",Le)),xt&&this.fire(new F.A("pitchstart",Le)).fire(new F.A("pitch",Le)).fire(new F.A("pitchend",Le)),this.fire(new F.A("moveend",Le)),this}easeTo(Me,Le){this._stop(!1,Me.easeId),(!1===(Me=F.l({offset:[0,0],duration:500,easing:F.dD},Me)).animate||this._prefersReducedMotion(Me))&&(Me.duration=0);const Oe=this.transform,Fe=this.getZoom(),je=this.getBearing(),qe=this.getPitch(),He=this.getPadding(),xt="zoom"in Me?+Me.zoom:Fe,Pt="bearing"in Me?this._normalizeBearing(Me.bearing,je):je,jt="pitch"in Me?+Me.pitch:qe,Gt=this._extendPadding(Me.padding),bi=F.P.convert(Me.offset);let wi,qr,Xn;if("globe"===Oe.projection.name){const Le=F.ac.fromLngLat(Oe.center),Fe=bi.rotate(-Oe.angle);Le.x+=Fe.x/Oe.worldSize,Le.y+=Fe.y/Oe.worldSize;const je=Le.toLngLat(),qe=F.bO.convert(Me.center||je);this._normalizeCenter(qe),wi=Oe.centerPoint.add(Fe),qr=new F.P(Le.x,Le.y).mult(Oe.worldSize),Xn=new F.P(F.av(qe.lng),F.aC(qe.lat)).mult(Oe.worldSize).sub(qr)}else{wi=Oe.centerPoint.add(bi);const Le=Oe.pointLocation(wi),Fe=F.bO.convert(Me.center||Le);this._normalizeCenter(Fe),qr=Oe.project(Le),Xn=Oe.project(Fe).sub(qr)}const Yn=Oe.zoomScale(xt-Fe);let yo,bo;Me.around&&(yo=F.bO.convert(Me.around),bo=Oe.locationPoint(yo));const Ro=this._zooming||xt!==Fe,Do=this._rotating||je!==Pt,zs=this._pitching||jt!==qe,Zs=!Oe.isPaddingEqual(Gt),na=!1===Me.retainPadding?Oe.clone():Oe,E=Oe=>el=>{if(Ro&&(Oe.zoom=F.ah(Fe,xt,el)),Do&&(Oe.bearing=F.ah(je,Pt,el)),zs&&(Oe.pitch=F.ah(qe,jt,el)),Zs&&(na.interpolatePadding(He,Gt,el),wi=na.centerPoint.add(bi)),yo)Oe.setLocationAtPoint(yo,bo);else{const F=Oe.zoomScale(Oe.zoom-Fe),Me=xt>Fe?Math.min(2,Yn):Math.max(.5,Yn),Le=Math.pow(Me,1-el),je=Oe.unproject(qr.add(Xn.mult(el*Le)).mult(F));Oe.setLocationAtPoint(Oe.renderWorldCopies?je.wrap():je,wi)}return Me.preloadOnly||this._fireMoveEvents(Le),Oe};if(Me.preloadOnly){const F=this._emulate(E,Me.duration,Oe);return this._preloadTiles(F),this}const el={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Ro,this._rotating=Do,this._pitching=zs,this._padding=Zs,this._easeId=Me.easeId,this._prepareEase(Le,Me.noMoveStart,el),this._ease(E(Oe),(F=>{"sea"===Oe.cameraElevationReference&&Oe.recenterOnTerrain(),this._afterEase(Le,F)}),Me),this}_prepareEase(Me,Le,Oe={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),Le||Oe.moving||this.fire(new F.A("movestart",Me)),this._zooming&&!Oe.zooming&&this.fire(new F.A("zoomstart",Me)),this._rotating&&!Oe.rotating&&this.fire(new F.A("rotatestart",Me)),this._pitching&&!Oe.pitching&&this.fire(new F.A("pitchstart",Me))}_fireMoveEvents(Me){this.fire(new F.A("move",Me)),this._zooming&&this.fire(new F.A("zoom",Me)),this._rotating&&this.fire(new F.A("rotate",Me)),this._pitching&&this.fire(new F.A("pitch",Me))}_afterEase(Me,Le){if(this._easeId&&Le&&this._easeId===Le)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const Oe=this._zooming,Fe=this._rotating,je=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,Oe&&this.fire(new F.A("zoomend",Me)),Fe&&this.fire(new F.A("rotateend",Me)),je&&this.fire(new F.A("pitchend",Me)),this.fire(new F.A("moveend",Me))}flyTo(Me,Le){if(this._prefersReducedMotion(Me)){const Oe=F.aA(Me,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Oe,Le)}this.stop(),Me=F.l({offset:[0,0],speed:1.2,curve:1.42,easing:F.dD},Me);const Oe=this.transform,Fe=this.getZoom(),je=this.getBearing(),qe=this.getPitch(),He=this.getPadding(),xt="zoom"in Me?F.ay(+Me.zoom,Oe.minZoom,Oe.maxZoom):Fe,Pt="bearing"in Me?this._normalizeBearing(Me.bearing,je):je,jt="pitch"in Me?+Me.pitch:qe,Gt=this._extendPadding(Me.padding),bi=Oe.zoomScale(xt-Fe),wi=F.P.convert(Me.offset);let qr=Oe.centerPoint.add(wi);const Xn=Oe.pointLocation(qr),Yn=F.bO.convert(Me.center||Xn);this._normalizeCenter(Yn);const yo=Oe.project(Xn),bo=Oe.project(Yn).sub(yo);let Ro=Me.curve;const Do=Math.max(Oe.width,Oe.height),zs=Do/bi,Zs=bo.mag();if("minZoom"in Me){const Le=F.ay(Math.min(Me.minZoom,Fe,xt),Oe.minZoom,Oe.maxZoom),je=Do/Oe.zoomScale(Le-Fe);Ro=Math.sqrt(je/Zs*2)}const na=Ro*Ro;function E(F){const Me=(zs*zs-Do*Do+(F?-1:1)*na*na*Zs*Zs)/(2*(F?zs:Do)*na*Zs);return Math.log(Math.sqrt(Me*Me+1)-Me)}function S(F){return(Math.exp(F)-Math.exp(-F))/2}function C(F){return(Math.exp(F)+Math.exp(-F))/2}const el=E(0);let R=function(F){return C(el)/C(el+Ro*F)},D=function(F){return Do*((C(el)*(S(Me=el+Ro*F)/C(Me))-S(el))/na)/Zs;var Me},nl=(E(1)-el)/Ro;if(Math.abs(Zs)<1e-6||!isFinite(nl)){if(Math.abs(Do-zs)<1e-6)return this.easeTo(Me,Le);const F=zs<Do?-1:1;nl=Math.abs(Math.log(zs/Do))/Ro,D=function(){return 0},R=function(Me){return Math.exp(F*Ro*Me)}}Me.duration="duration"in Me?+Me.duration:1e3*nl/("screenSpeed"in Me?+Me.screenSpeed/Ro:+Me.speed),Me.maxDuration&&Me.duration>Me.maxDuration&&(Me.duration=0);const hl=je!==Pt,pl=jt!==qe,bl=!Oe.isPaddingEqual(Gt),Tl=!1===Me.retainPadding?Oe.clone():Oe,O=Oe=>bi=>{const Xn=bi*nl,Ro=1/R(Xn);Oe.zoom=1===bi?xt:Fe+Oe.scaleZoom(Ro),hl&&(Oe.bearing=F.ah(je,Pt,bi)),pl&&(Oe.pitch=F.ah(qe,jt,bi)),bl&&(Tl.interpolatePadding(He,Gt,bi),qr=Tl.centerPoint.add(wi));const Do=1===bi?Yn:Oe.unproject(yo.add(bo.mult(D(Xn))).mult(Ro));return Oe.setLocationAtPoint(Oe.renderWorldCopies?Do.wrap():Do,qr),Oe._updateCameraOnTerrain(),Me.preloadOnly||this._fireMoveEvents(Le),Oe};if(Me.preloadOnly){const F=this._emulate(O,Me.duration,Oe);return this._preloadTiles(F),this}return this._zooming=!0,this._rotating=hl,this._pitching=pl,this._padding=bl,this._prepareEase(Le,!1),this._ease(O(Oe),(()=>this._afterEase(Le)),Me),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(F){}_cancelRenderFrame(F){}_stop(F,Me){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const F=this._onEaseEnd;this._onEaseEnd=void 0,F.call(this,Me)}if(!F){const F=this.handlers;F&&F.stop(!1)}return this}_ease(Me,Le,Oe){!1===Oe.animate||0===Oe.duration?(Me(1),Le()):(this._easeStart=F.q.now(),this._easeOptions=Oe,this._onEaseFrame=Me,this._onEaseEnd=Le,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const Me=Math.min((F.q.now()-this._easeStart)/this._easeOptions.duration,1),Le=this._onEaseFrame;Le&&Le(this._easeOptions.easing(Me)),Me<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(Me,Le){Me=F.bF(Me,-180,180);const Oe=Math.abs(Me-Le);return Math.abs(Me-360-Le)<Oe&&(Me-=360),Math.abs(Me+360-Le)<Oe&&(Me+=360),Me}_normalizeCenter(F){const Me=this.transform;if(Me.maxBounds)return;if("globe"!==Me.projection.name&&!Me.renderWorldCopies)return;const Le=F.lng-Me.center.lng;F.lng+=Le>180?-360:Le<-180?360:0}_prefersReducedMotion(Me){return this._respectPrefersReducedMotion&&F.q.prefersReducedMotion&&!(Me&&Me.essential)}_emulate(F,Me,Le){const Oe=Math.ceil(15*Me/1e3),Fe=[],je=F(Le.clone());for(let F=0;F<=Oe;F++){const Me=je(F/Oe);Fe.push(Me.clone())}return Fe}_preloadTiles(F,Me){}}class il{constructor(Me={}){this.options=Me,F.aQ(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(F){const Me=this.options&&this.options.compact,Le=F._getUIString("AttributionControl.ToggleAttribution");this._map=F,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=l("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",Le);const Oe=l("span","mapboxgl-ctrl-icon",this._compactButton);return Oe.setAttribute("aria-hidden","true"),Oe.setAttribute("title",Le),this._innerContainer=l("div","mapboxgl-ctrl-attrib-inner",this._container),Me&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===Me&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let Me=this._editLink;Me||(Me=this._editLink=this._container.querySelector(".mapbox-improve-map"));const Le=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||F.e.ACCESS_TOKEN}];if(Me){const Oe=Le.reduce(((F,Me,Oe)=>(Me.value&&(F+=`${Me.key}=${Me.value}${Oe<Le.length-1?"&":""}`),F)),"?");Me.href=`${F.e.FEEDBACK_URL}/${Oe}#${oa(this._map,!0)}`,Me.rel="noopener nofollow"}}_updateData(F){!F||"metadata"!==F.sourceDataType&&"visibility"!==F.sourceDataType&&"style"!==F.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let F=[];if(this._map.style.stylesheet){const F=this._map.style.stylesheet;this.styleOwner=F.owner,this.styleId=F.id}const Me=this._map.style._mergedSourceCaches;for(const Le in Me){const Oe=Me[Le];if(Oe.used){const Me=Oe.getSource();Me.attribution&&F.indexOf(Me.attribution)<0&&F.push(Me.attribution)}}F.sort(((F,Me)=>F.length-Me.length)),F=F.filter(((Me,Le)=>{for(let Oe=Le+1;Oe<F.length;Oe++)if(F[Oe].indexOf(Me)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?F=[...this.options.customAttribution,...F]:F.unshift(this.options.customAttribution));const Le=F.join(" | ");Le!==this._attribHTML&&(this._attribHTML=Le,F.length?(this._innerContainer.innerHTML=Le,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class ol{constructor(){F.aQ(["_updateLogo","_updateCompact"],this)}onAdd(F){this._map=F,this._container=l("div","mapboxgl-ctrl");const Me=l("a","mapboxgl-ctrl-logo");return Me.target="_blank",Me.rel="noopener nofollow",Me.href="https://www.mapbox.com/",Me.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),Me.setAttribute("rel","noopener nofollow"),this._container.appendChild(Me),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(F){F&&"metadata"!==F.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const F=this._map.style._sourceCaches;if(0===Object.entries(F).length)return!0;for(const Me in F){const Le=F[Me].getSource();if(Le.hasOwnProperty("mapbox_logo")&&!Le.mapbox_logo)return!1}return!0}_updateCompact(){const F=this._container.children;if(F.length){const Me=F[0];this._map.getCanvasContainer().offsetWidth<250?Me.classList.add("mapboxgl-compact"):Me.classList.remove("mapboxgl-compact")}}}class sl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(F){const Me=++this._id;return this._queue.push({callback:F,id:Me,cancelled:!1}),Me}remove(F){const Me=this._currentlyRunning,Le=Me?this._queue.concat(Me):this._queue;for(const Me of Le)if(Me.id===F)return void(Me.cancelled=!0)}run(F=0){const Me=this._currentlyRunning=this._queue;this._queue=[];for(const Le of Me)if(!Le.cancelled&&(Le.callback(F),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class rl{constructor(F){this.jumpTo(F)}getValue(Me){if(Me<=this._startTime)return this._start;if(Me>=this._endTime)return this._end;const Le=F.cC((Me-this._startTime)/(this._endTime-this._startTime));return this._start*(1-Le)+this._end*Le}isEasing(F){return F>=this._startTime&&F<=this._endTime}jumpTo(F){this._startTime=-1/0,this._endTime=-1/0,this._start=F,this._end=F}easeTo(F,Me,Le){this._start=this.getValue(Me),this._end=F,this._startTime=Me,this._endTime=Me+Le}}const Nf={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class al extends F.A{constructor(F,Me,Le,Oe){const{point:Fe,lngLat:je,originalEvent:qe,target:He}=F;super(F.type,{point:Fe,lngLat:je,originalEvent:qe,target:He}),this.preventDefault=()=>{F.preventDefault()},this.id=Me,this.interaction=Le,this.feature=Oe}}class ll{constructor(F){this.map=F,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(Me,Le){if(this.typeById.has(Me))throw new Error(`Interaction id "${Me}" already exists.`);const Oe=Le.filter;let Fe=Le.type;Oe&&this.filters.set(Me,F.a_(Oe)),"mouseover"===Fe&&(Fe="mouseenter"),"mouseout"===Fe&&(Fe="mouseleave");const je=this.interactionsByType.get(Fe)||new Map;"mouseenter"===Fe||"mouseleave"===Fe?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(Me,Le)):0===je.size&&this.map.on(Fe,this.handleType),0===je.size&&this.interactionsByType.set(Fe,je),je.set(Me,Le),this.typeById.set(Me,Fe)}get(F){const Me=this.typeById.get(F);if(!Me)return;const Le=this.interactionsByType.get(Me);return Le?Le.get(F):void 0}remove(F){const Me=this.typeById.get(F);if(!Me)return;this.typeById.delete(F),this.filters.delete(F);const Le=this.interactionsByType.get(Me);Le&&(Le.delete(F),"mouseenter"===Me||"mouseleave"===Me?(this.delegatedInteractions.delete(F),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===Le.size&&this.map.off(Me,this.handleType))}queryTargets(F,Me){const Le=[];for(const[F,Oe]of Me)Oe.target&&Le.push({targetId:F,target:Oe.target,filter:this.filters.get(F)});return this.map.style.queryRenderedTargets(F,Le,this.map.transform)}handleMove(F){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const Me=this.queryTargets(F.point,Array.from(this.delegatedInteractions).reverse());Me.length&&(F.type="mouseenter",this.handleType(F,Me));const Le=new Map;for(const[F,{feature:Me}]of this.prevHoveredFeatures)this.hoveredFeatures.has(F)||Le.set(Me.id,Me);Le.size&&(F.type="mouseleave",this.handleType(F,Array.from(Le.values())))}handleOut(F){const Me=Array.from(this.hoveredFeatures.values()).map((({feature:F})=>F));Me.length&&(F.type="mouseleave",this.handleType(F,Me)),this.hoveredFeatures.clear()}handleType(Me,Le){const Oe=Array.from(this.interactionsByType.get(Me.type)).reverse(),Fe=!!Le;Le=Le||this.queryTargets(Me.point,Oe);const je="mouseenter"===Me.type;let qe=!1;const He=new Set;for(const xt of Le){for(const[Le,Pt]of Oe){if(!Pt.target)continue;const Oe=xt.variants?xt.variants[Le]:null;if(Oe){for(const jt of Oe){if(at(jt,xt,He,Le))continue;const Oe=new F.cx(xt,jt),Gt=nt(jt,xt,Le);Fe&&(Oe.state=this.map.getFeatureState(Oe));const bi=je?this.prevHoveredFeatures.get(Gt):null,wi=new al(Me,Le,Pt,Oe),qr=bi?bi.stop:Pt.handler(wi);if(je&&this.hoveredFeatures.set(Gt,{feature:xt,stop:qr}),!1!==qr){qe=!0;break}}if(qe)break}}if(qe)break}if(!qe)for(const[F,Le]of Oe){const{handler:Oe,target:Fe}=Le;if(!Fe&&!1!==Oe(new al(Me,F,Le,null)))break}}}function cl(Me,Le){if(Array.isArray(Me)&&Array.isArray(Le)){const F=new Set(Me),Oe=new Set(Le);return F.size===Oe.size&&Me.every((F=>Oe.has(F)))}return F.bn(Me,Le)}const Gf={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},$f={showCompass:!0,showZoom:!0,visualizePitch:!1};class ul{constructor(Me,Le,Oe=!1){this._clickTolerance=10,this.element=Le,this.mouseRotate=new Ca({clickTolerance:Me.dragRotate._mouseRotate._clickTolerance}),this.map=Me,Oe&&(this.mousePitch=new Ia({clickTolerance:Me.dragRotate._mousePitch._clickTolerance})),F.aQ(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),Le.addEventListener("mousedown",this.mousedown),Le.addEventListener("touchstart",this.touchstart,{passive:!1}),Le.addEventListener("touchmove",this.touchmove),Le.addEventListener("touchend",this.touchend),Le.addEventListener("touchcancel",this.reset)}down(F,Me){this.mouseRotate.mousedown(F,Me),this.mousePitch&&this.mousePitch.mousedown(F,Me),_()}move(F,Me){const Le=this.map,Oe=this.mouseRotate.mousemoveWindow(F,Me),Fe=Oe&&Oe.bearingDelta;if(Fe&&Le.setBearing(Le.getBearing()+Fe),this.mousePitch){const Oe=this.mousePitch.mousemoveWindow(F,Me),Fe=Oe&&Oe.pitchDelta;Fe&&Le.setPitch(Le.getPitch()+Fe)}}off(){const F=this.element;F.removeEventListener("mousedown",this.mousedown),F.removeEventListener("touchstart",this.touchstart,{passive:!1}),F.removeEventListener("touchmove",this.touchmove),F.removeEventListener("touchend",this.touchend),F.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){p(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(Me){this.down(F.l({},Me,{ctrlKey:!0,preventDefault:()=>Me.preventDefault()}),g(this.element,Me)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(F){this.move(F,g(this.element,F))}mouseup(F){this.mouseRotate.mouseupWindow(F),this.mousePitch&&this.mousePitch.mouseupWindow(F),this.offTemp()}touchstart(F){1!==F.targetTouches.length?this.reset():(this._startPos=this._lastPos=v(this.element,F.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>F.preventDefault()},this._startPos))}touchmove(F){1!==F.targetTouches.length?this.reset():(this._lastPos=v(this.element,F.targetTouches)[0],this.move({preventDefault:()=>F.preventDefault()},this._lastPos))}touchend(F){0===F.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function _l(Me,Le,Oe){if(Me=new F.bO(Me.lng,Me.lat),Le){const Fe=new F.bO(Me.lng-360,Me.lat),je=new F.bO(Me.lng+360,Me.lat),qe=360*Math.ceil(Math.abs(Me.lng-Oe.center.lng)/360),He=Oe.locationPoint3D(Me).distSqr(Le),xt=Le.x<0||Le.y<0||Le.x>Oe.width||Le.y>Oe.height;Oe.locationPoint3D(Fe).distSqr(Le)<He&&(xt||Math.abs(Fe.lng-Oe.center.lng)<qe)?Me=Fe:Oe.locationPoint3D(je).distSqr(Le)<He&&(xt||Math.abs(je.lng-Oe.center.lng)<qe)&&(Me=je)}for(;Math.abs(Me.lng-Oe.center.lng)>180;){const F=Oe.locationPoint3D(Me);if(F.x>=0&&F.y>=0&&F.x<=Oe.width&&F.y<=Oe.height)break;Me.lng>Oe.center.lng?Me.lng-=360:Me.lng+=360}return Me}const im={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},rm={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class ml extends F.E{constructor(Me,Le){super(),(Me instanceof HTMLElement||Le)&&(Me=F.l({element:Me},Le)),F.aQ(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:Oe="center",color:Fe="#3FB1CE",scale:je=1,draggable:qe=!1,clickTolerance:He=0,rotation:xt=rm.rotation,rotationAlignment:Pt=rm.rotationAlignment,pitchAlignment:jt=rm.pitchAlignment,occludedOpacity:Gt=rm.occludedOpacity,altitude:bi=rm.altitude}=Me||{};this._anchor=Oe,this._color=Fe,this._scale=je,this._draggable=qe,this._clickTolerance=He,this._rotation=xt,this._rotationAlignment=Pt,this._pitchAlignment=jt,this._occludedOpacity=Gt,this._altitude=bi,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),Me&&Me.element?(this._element=Me.element,this._offset=F.P.convert(Me&&Me.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=F.P.convert(Me&&Me.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(F=>{F.preventDefault()})),this._element.addEventListener("mousedown",(F=>{F.preventDefault()}));const wi=this._element.classList;for(const F in im)wi.remove(`mapboxgl-marker-anchor-${F}`);wi.add(`mapboxgl-marker-anchor-${this._anchor}`);const qr=Me&&Me.className?Me.className.trim().split(/\s+/):[];wi.add(...qr),this._popup=null}_createDefaultMarker(){const F=l("div"),Me=c("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},F);if(0===this._altitude){const F=c("radialGradient",{id:"shadowGradient"},c("defs",{},Me));c("stop",{offset:"10%","stop-opacity":.4},F),c("stop",{offset:"100%","stop-opacity":.05},F),c("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},Me)}return c("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},Me),c("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},Me),c("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},Me),F}addTo(F){return F===this._map||(this.remove(),this._map=F,F.getCanvasContainer().appendChild(this._element),F.on("move",this._updateMoving),F.on("moveend",this._update),F.on("remove",this._clearFadeTimer),F._addMarker(this),this.setDraggable(this._draggable),this._update(),F.on("click",this._onMapClick)),this}remove(){const F=this._map;return F&&(F.off("click",this._onMapClick),F.off("move",this._updateMoving),F.off("moveend",this._update),F.off("mousedown",this._addDragHandler),F.off("touchstart",this._addDragHandler),F.off("mouseup",this._onUp),F.off("touchend",this._onUp),F.off("mousemove",this._onMove),F.off("touchmove",this._onMove),F.off("remove",this._clearFadeTimer),F._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(Me){return this._lngLat=F.bO.convert(Me),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(F){return F===this._altitude||(this._defaultMarker&&(0===this._altitude&&0!==F||0!==this._altitude&&0===F)&&(this._element=this._createDefaultMarker()),this._altitude=F||rm.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(F){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),F){if(!("offset"in F.options)){const Me=38.1,Le=13.5,Oe=Math.sqrt(Math.pow(Le,2)/2);F.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-Me],"bottom-left":[Oe,-1*(Me-Le+Oe)],"bottom-right":[-Oe,-1*(Me-Le+Oe)],left:[Le,-1*(Me-Le)],right:[-Le,-1*(Me-Le)]}:this._offset}this._popup=F,F._marker=this,F._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(F){const Me=F.code,Le=F.charCode||F.keyCode;"Space"!==Me&&"Enter"!==Me&&32!==Le&&13!==Le||this.togglePopup()}_onMapClick(F){const Me=F.originalEvent.target,Le=this._element;this._popup&&(Me===Le||Le.contains(Me))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const F=this._popup;return F?(F.isOpen()?(F.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(F.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const F=this._map,Me=this._pos;if(!F||!Me)return!1;const Le=F.unproject(Me,this._altitude),Oe=F.getFreeCameraOptions();if(!Oe.position)return!1;const Fe=Oe.position.toLngLat();return Fe.distanceTo(Le)<.9*Fe.distanceTo(this._lngLat)}_evaluateOpacity(){const Me=this._map;if(!Me)return;const Le=this._pos;if(!Le||Le.x<0||Le.x>Me.transform.width||Le.y<0||Le.y>Me.transform.height)return void this._clearFadeTimer();const Oe=Me.unproject(Le,this._altitude);let Fe;Me._showingGlobe()&&F.dK(Me.transform,this._lngLat)?Fe=0:(Fe=1-Me._queryFogOpacity(Oe),Me.transform._terrainEnabled()&&Me.getTerrain()&&this._behindTerrain()&&(Fe*=this._occludedOpacity)),this._element.style.opacity=`${Fe}`,this._element.style.pointerEvents=Fe>0?"auto":"none",this._popup&&this._popup._setOpacity(Fe),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const F=this._pos;if(!F||!this._map)return;const Me=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${F.x}px,${F.y}px)\n            ${im[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${Me.x}px,${Me.y}px)\n        `}_calculateXYTransform(){const Me=this._pos,Le=this._map,Oe=this.getPitchAlignment();if(!Le||!Me||"map"!==Oe)return"";if(!Le._showingGlobe()){const F=Le.getPitch();return F?`rotateX(${F}deg)`:""}const Fe=F.c4(F.dL(Le.transform,this._lngLat)),je=Me.sub(F.dM(Le.transform)),qe=Math.abs(je.x)+Math.abs(je.y);if(0===qe)return"";const He=Fe/qe;return`rotateX(${-je.y*He}deg) rotateY(${je.x*He}deg)`}_calculateZTransform(){const Me=this._pos,Le=this._map;if(!Le||!Me)return"";let Oe=0;const Fe=this.getRotationAlignment();if("map"===Fe)if(Le._showingGlobe()){const Me=Le.project(new F.bO(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),Fe=Le.project(new F.bO(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(Me);Oe=F.c4(Math.atan2(Fe.y,Fe.x))-90}else Oe=-Le.getBearing();else if("horizon"===Fe){const Fe=F.ae(4,6,Le.getZoom()),je=F.dM(Le.transform);je.y+=Fe*Le.transform.height;const qe=Me.sub(je),He=F.c4(Math.atan2(qe.y,qe.x));Oe=(He>90?He-270:He+90)*(1-Fe)}return Oe+=this._rotation,Oe?`rotateZ(${Oe}deg)`:""}_update(F){cancelAnimationFrame(this._updateFrameId);const Me=this._map;Me&&(Me.transform.renderWorldCopies&&(this._lngLat=_l(this._lngLat,this._pos,Me.transform)),this._pos=Me.project(this._lngLat,this._altitude),!0===F?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),Me._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(Me._showingGlobe()||Me.getTerrain()||Me.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(Me){return this._offset=F.P.convert(Me),this._update(),this}addClassName(F){return this._element.classList.add(F),this}removeClassName(F){return this._element.classList.remove(F),this}toggleClassName(F){return this._element.classList.toggle(F)}_onMove(Me){const Le=this._map;if(!Le)return;const Oe=this._pointerdownPos,Fe=this._positionDelta;if(Oe&&Fe){if(!this._isDragging){const F=this._clickTolerance||Le._clickTolerance;if(Me.point.dist(Oe)<F)return;this._isDragging=!0}this._pos=Me.point.sub(Fe),this._lngLat=Le.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new F.A("dragstart"))),this.fire(new F.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const Me=this._map;Me&&(Me.off("mousemove",this._onMove),Me.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new F.A("dragend")),this._state="inactive"}_addDragHandler(F){const Me=this._map,Le=this._pos;Me&&Le&&this._element.contains(F.originalEvent.target)&&(F.preventDefault(),this._positionDelta=F.point.sub(Le),this._pointerdownPos=F.point,this._state="pending",Me.on("mousemove",this._onMove),Me.on("touchmove",this._onMove),Me.once("mouseup",this._onUp),Me.once("touchend",this._onUp))}setDraggable(F){this._draggable=!!F;const Me=this._map;return Me&&(F?(Me.on("mousedown",this._addDragHandler),Me.on("touchstart",this._addDragHandler)):(Me.off("mousedown",this._addDragHandler),Me.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(F){return this._rotation=F||rm.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(F){return this._rotationAlignment=F||rm.rotationAlignment,this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(F){return this._pitchAlignment=F||rm.pitchAlignment,this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(F){return this._occludedOpacity=F||rm.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const nm={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},sm={maxWidth:100,unit:"metric"},am={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},um={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},fm=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function wl(Me=new F.P(0,0),Le="bottom"){if("number"==typeof Me){const Oe=Math.round(Math.sqrt(.5*Math.pow(Me,2)));switch(Le){case"top":return new F.P(0,Me);case"top-left":return new F.P(Oe,Oe);case"top-right":return new F.P(-Oe,Oe);case"bottom":return new F.P(0,-Me);case"bottom-left":return new F.P(Oe,-Oe);case"bottom-right":return new F.P(-Oe,-Oe);case"left":return new F.P(Me,0);case"right":return new F.P(-Me,0)}return new F.P(0,0)}return Me instanceof F.P||Array.isArray(Me)?F.P.convert(Me):F.P.convert(Me[Le]||[0,0])}const mm={version:Me,supported:qe.supported,setRTLTextPlugin:F.dN,getRTLTextPluginStatus:F.dO,Map:class extends tl{constructor(Me){Oe.mark(Le.create);const Fe=Me;if(null!=(Me=F.l({},Gf,Me)).minZoom&&null!=Me.maxZoom&&Me.minZoom>Me.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=Me.minPitch&&null!=Me.maxPitch&&Me.minPitch>Me.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=Me.minPitch&&Me.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=Me.maxPitch&&Me.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(Me.antialias&&F.dI(window)&&(Me.antialias=!1,F.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Ji(Me.minZoom,Me.maxZoom,Me.minPitch,Me.maxPitch,Me.renderWorldCopies,null,null),Me),this._repaint=!!Me.repaint,this._interactive=Me.interactive,this._minTileCacheSize=Me.minTileCacheSize,this._maxTileCacheSize=Me.maxTileCacheSize,this._failIfMajorPerformanceCaveat=Me.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=Me.preserveDrawingBuffer,this._antialias=Me.antialias,this._trackResize=Me.trackResize,this._bearingSnap=Me.bearingSnap,this._refreshExpiredTiles=Me.refreshExpiredTiles,this._fadeDuration=Me.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=Me.crossSourceCollisions,this._collectResourceTiming=Me.collectResourceTiming,this._language=this._parseLanguage(Me.language),this._worldview=Me.worldview,this._renderTaskQueue=new sl,this._domRenderTaskQueue=new sl,this._controls=[],this._markers=[],this._popups=[],this._mapId=F.aW(),this._locale=F.l({},Nf,Me.locale),this._clickTolerance=Me.clickTolerance,this._cooperativeGestures=Me.cooperativeGestures,this._performanceMetricsCollection=Me.performanceMetricsCollection,this._tessellationStep=Me.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=Me.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new rl(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=Me.scaleFactor,this._requestManager=new T(Me.transformRequest,Me.accessToken,Me.testMode),this._silenceAuthErrors=!!Me.testMode,this._contextCreateOptions=Me.contextCreateOptions?Object.assign({},Me.contextCreateOptions):{},"string"==typeof Me.container){const F=document.getElementById(Me.container);if(!F)throw new Error(`Container '${Me.container.toString()}' not found.`);this._container=F}else{if(!(Me.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=Me.container}if(this._container.childNodes.length>0&&F.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),Me.maxBounds&&this.setMaxBounds(Me.maxBounds),this._spriteFormat=Me.spriteFormat,F.aQ(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Nn),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},(()=>{this.setScaleFactor(this._scaleFactor)})),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Qa(this,Me),this._localFontFamily=Me.localFontFamily,this._localIdeographFontFamily=Me.localIdeographFontFamily,(Me.style||!Me.testMode)&&this.setStyle(Me.style||F.e.DEFAULT_STYLE,{config:Me.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),Me.projection&&this.setProjection(Me.projection),this.indoor=new _o(this),Me.hash&&(this._hash=new ia("string"==typeof Me.hash&&Me.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==Fe.center&&null==Fe.zoom||(this.transform._unmodified=!1),this.jumpTo({center:Me.center,zoom:Me.zoom,bearing:Me.bearing,pitch:Me.pitch});const Le=Me.bounds;Le&&(this.resize(),this.fitBounds(Le,F.l({},Me.fitBoundsOptions,{duration:0})))}this.resize(),Me.attributionControl&&this.addControl(new il({customAttribution:Me.customAttribution})),this._logoControl=new ol,this.addControl(this._logoControl,Me.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()})),this.on("data",(Me=>{this._update("style"===Me.dataType),this.fire(new F.A(`${Me.dataType}data`,Me))})),this.on("dataloading",(Me=>{this.fire(new F.A(`${Me.dataType}dataloading`,Me))})),this._interactions=new ll(this)}_getMapId(){return this._mapId}addControl(Me,Le){if(void 0===Le&&(Le=Me.getDefaultPosition?Me.getDefaultPosition():"top-right"),!Me||!Me.onAdd)return this.fire(new F.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const Oe=Me.onAdd(this);this._controls.push(Me);const Fe=this._controlPositions[Le];return-1!==Le.indexOf("bottom")?Fe.insertBefore(Oe,Fe.firstChild):Fe.appendChild(Oe),this}removeControl(Me){if(!Me||!Me.onRemove)return this.fire(new F.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const Le=this._controls.indexOf(Me);return Le>-1&&this._controls.splice(Le,1),Me.onRemove(this),this}hasControl(F){return this._controls.indexOf(F)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(Me){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const Le=!this._moving;return Le&&this.fire(new F.A("movestart",Me)).fire(new F.A("move",Me)),this.fire(new F.A("resize",Me)),Le&&this.fire(new F.A("moveend",Me)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(Me){return this.transform.setMaxBounds(F.aB.convert(Me)),this._update()}setMinZoom(Me){if((Me=Me??-2)>=-2&&Me<=this.transform.maxZoom)return this.transform.minZoom=Me,this._update(),this.getZoom()<Me?this.setZoom(Me):this.fire(new F.A("zoomstart")).fire(new F.A("zoom")).fire(new F.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(Me){if((Me=Me??22)>=this.transform.minZoom)return this.transform.maxZoom=Me,this._update(),this.getZoom()>Me?this.setZoom(Me):this.fire(new F.A("zoomstart")).fire(new F.A("zoom")).fire(new F.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(Me){if((Me=Me??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(Me>=0&&Me<=this.transform.maxPitch)return this.transform.minPitch=Me,this._update(),this.getPitch()<Me?this.setPitch(Me):this.fire(new F.A("pitchstart")).fire(new F.A("pitch")).fire(new F.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(Me){if((Me=Me??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(Me>=this.transform.minPitch)return this.transform.maxPitch=Me,this._update(),this.getPitch()>Me?this.setPitch(Me):this.fire(new F.A("pitchstart")).fire(new F.A("pitch")).fire(new F.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(F){return this._scaleFactor=F,this.painter.scaleFactor=F,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers((F=>"symbol"===F.type)),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(F){return this.transform.renderWorldCopies=F,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(F){return"auto"===F?navigator.language:Array.isArray(F)?0===F.length?void 0:F.map((F=>"auto"===F?navigator.language:F)):F}setLanguage(F){const Me=this._parseLanguage(F);if(!this.style||Me===this._language)return this;this._language=Me,this.style.reloadSources();for(const F of this._controls)F._setLanguage&&F._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(F){return this.style&&F!==this._worldview?(this._worldview=F,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(F){return this._lazyInitEmptyStyle(),F?"string"==typeof F&&(F={name:F}):F=null,this._useExplicitProjection=!!F,this._prioritizeAndUpdateProjection(F,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const Me=this.transform,Le=Me.projection.name;let Oe;"globe"===Le&&Me.zoom>=F.bY?(Me.setMercatorFromTransition(),Oe=!0):"mercator"===Le&&Me.zoom<F.bY&&(Me.setProjection({name:"globe"}),Oe=!0),Oe&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(F,Me){return this._updateProjection(F||Me||{name:"mercator"})}_updateProjection(Me){let Le;return Le="globe"===Me.name&&this.transform.zoom>=F.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(Me),this.style.applyProjectionUpdate(),Le&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(Me,Le){return this.transform.locationPoint3D(F.bO.convert(Me),Le)}unproject(Me,Le){return this.transform.pointLocation3D(F.P.convert(Me),Le)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(F,Me,Le){const o=F=>{let Le=[];if(Array.isArray(Me)){const Oe=Me.filter((F=>this.getLayer(F)));Le=Oe.length?this.queryRenderedFeatures(F,{layers:Oe}):[]}else Le=this.queryRenderedFeatures(F,{target:Me});return Le};if("mouseenter"===F||"mouseover"===F){let Oe=!1;const r=Me=>{const Fe=o(Me.point);Fe.length?Oe||(Oe=!0,Le.call(this,new ua(F,this,Me.originalEvent,{features:Fe}))):Oe=!1};return{listener:Le,targets:Me,delegates:{mousemove:r,mouseout:()=>{Oe=!1}}}}if("mouseleave"===F||"mouseout"===F){let Oe=!1;const r=Me=>{o(Me.point).length?Oe=!0:Oe&&(Oe=!1,Le.call(this,new ua(F,this,Me.originalEvent)))},n=Me=>{Oe&&(Oe=!1,Le.call(this,new ua(F,this,Me.originalEvent)))};return{listener:Le,targets:Me,delegates:{mousemove:r,mouseout:n}}}{const s=F=>{const Me=o(F.point);Me.length&&(F.features=Me,Le.call(this,F),delete F.features)};return{listener:Le,targets:Me,delegates:{[F]:s}}}}on(F,Me,Le){if("function"==typeof Me||void 0===Le)return super.on(F,Me);if("string"==typeof Me&&(Me=[Me]),!this._areTargetsValid(Me))return this;const Oe=this._createDelegatedListener(F,Me,Le);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[F]=this._delegatedListeners[F]||[],this._delegatedListeners[F].push(Oe);for(const F in Oe.delegates)this.on(F,Oe.delegates[F]);return this}once(F,Me,Le){if("function"==typeof Me||void 0===Le)return super.once(F,Me);if("string"==typeof Me&&(Me=[Me]),!this._areTargetsValid(Me))return this;const Oe=this._createDelegatedListener(F,Me,Le);for(const F in Oe.delegates)this.once(F,Oe.delegates[F]);return this}off(F,Me,Le){if("function"==typeof Me||void 0===Le)return super.off(F,Me);if("string"==typeof Me&&(Me=[Me]),!this._areTargetsValid(Me))return this;const Oe=this._delegatedListeners?this._delegatedListeners[F]:void 0;return Oe&&(F=>{for(let Oe=0;Oe<F.length;Oe++){const Fe=F[Oe];if(Fe.listener===Le&&cl(Fe.targets,Me)){for(const F in Fe.delegates)this.off(F,Fe.delegates[F]);return F.splice(Oe,1),this}}})(Oe),this}queryRenderedFeatures(Me,Le){if(!this.style)return[];if(void 0===Me||Me instanceof F.P||Array.isArray(Me)||void 0!==Le||(Le=Me,Me=void 0),Me=Me||[[0,0],[this.transform.width,this.transform.height]],!Le){const F=this.style.queryRenderedFeatures(Me,void 0,this.transform),Le=this.style.queryRenderedFeatureset(Me,void 0,this.transform);return F.concat(Le)}let Oe=!0;if(Le.target&&(Oe=this._isTargetValid(Le.target),Oe&&!Le.layers))return this.style.queryRenderedFeatureset(Me,Le,this.transform);let Fe=!0;if(Le.layers&&Array.isArray(Le.layers)){for(const F of Le.layers)if(!this._isValidId(F)){Fe=!1;break}if(Fe&&!Le.target)return this.style.queryRenderedFeatures(Me,Le,this.transform)}let je=[];return Fe&&(je=je.concat(this.style.queryRenderedFeatures(Me,Le,this.transform))),Oe&&(je=je.concat(this.style.queryRenderedFeatureset(Me,Le,this.transform))),je}querySourceFeatures(F,Me){return!F||"string"==typeof F&&!this._isValidId(F)?[]:this.style.querySourceFeatures(F,Me)}isPointOnSurface(Me){const{name:Le}=this.transform.projection;return"globe"!==Le&&"mercator"!==Le&&F.w(`${Le} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(F.P.convert(Me))}addInteraction(F,Me){return this._interactions.add(F,Me),this}removeInteraction(F){return this._interactions.remove(F),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(F){return this._cooperativeGestures=F,this}setStyle(Me,Le){return Le=F.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},Le),this.style&&Me&&!1!==Le.diff&&Le.localFontFamily===this._localFontFamily&&Le.localIdeographFontFamily===this._localIdeographFontFamily&&!Le.config?(this.style._diffStyle(Me,((Oe,Fe)=>{Oe?(F.w(`Unable to perform style diff: ${String(Oe.message||Oe.error||Oe)}. Rebuilding the style from scratch.`),this._updateStyle(Me,Le)):Fe&&this._update(!0)}),(()=>{this._postStyleLoadEvent()})),this):(this._localIdeographFontFamily=Le.localIdeographFontFamily,this._localFontFamily=Le.localFontFamily,this._updateStyle(Me,Le))}_getUIString(F){const Me=this._locale[F];if(null==Me)throw new Error(`Missing UI string '${F}'`);return Me}_updateStyle(Me,Le){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),Me){const Oe=F.l({},Le);Le&&Le.config&&(Oe.initialConfig=Le.config,delete Oe.config),this.style=new To(this,Oe).load(Me),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new To(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(F.w("There is no style added to the map."),!1)}_isValidId(Me){return null==Me?(this.fire(new F.z(new Error("IDs can't be empty."))),!1):!F.cs(Me)||(this.fire(new F.z(new Error(`IDs can't contain special symbols: "${Me}".`))),!1)}_isTargetValid(F){return"featuresetId"in F?this._isValidId("importId"in F?F.importId:F.featuresetId):"layerId"in F&&this._isValidId(F.layerId)}_areTargetsValid(F){if(Array.isArray(F)){for(const Me of F)if(!this._isValidId(Me))return!1;return!0}return this._isTargetValid(F)}addSource(F,Me){return this._isValidId(F)?(this._lazyInitEmptyStyle(),this.style.addSource(F,Me),this._update(!0)):this}isSourceLoaded(F){return!!this._isValidId(F)&&!!this.style&&this.style._isSourceCacheLoaded(F)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(F,Me,Le){this._lazyInitEmptyStyle(),this.style.addSourceType(F,Me,Le)}removeSource(F){return this._isValidId(F)?(this.style.removeSource(F),this._updateTerrain(),this._update(!0)):this}getSource(F){return this._isValidId(F)?this.style.getOwnSource(F):null}addImage(Me,Le,{pixelRatio:Oe=1,sdf:Fe=!1,stretchX:je,stretchY:qe,content:He}={}){this._lazyInitEmptyStyle();const xt=F.I.from(Me);if(Le instanceof HTMLImageElement||ImageBitmap&&Le instanceof ImageBitmap){const{width:Me,height:Pt,data:jt}=F.q.getImageData(Le);this.style.addImage(xt,this.style.scope,{data:new F.r({width:Me,height:Pt},jt),pixelRatio:Oe,stretchX:je,stretchY:qe,content:He,sdf:Fe,version:0,usvg:!1})}else if(void 0===Le.width||void 0===Le.height)this.fire(new F.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:Pt,height:jt}=Le,Gt=Le;this.style.addImage(xt,this.style.scope,{data:new F.r({width:Pt,height:jt},new Uint8Array(Gt.data)),pixelRatio:Oe,stretchX:je,stretchY:qe,content:He,sdf:Fe,usvg:!1,version:0,userImage:Gt}),Gt.onAdd&&Gt.onAdd(this,Me)}}updateImage(Me,Le){this._lazyInitEmptyStyle();const Oe=F.I.from(Me),Fe=this.style.getImage(Oe,this.style.scope);if(!Fe)return void this.fire(new F.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const je=Le instanceof HTMLImageElement||ImageBitmap&&Le instanceof ImageBitmap?F.q.getImageData(Le):Le,{width:qe,height:He,data:xt}=je;if(void 0===qe||void 0===He)return void this.fire(new F.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(qe!==(Fe.usvg?Fe.icon.usvg_tree.width:Fe.data.width)||He!==(Fe.usvg?Fe.icon.usvg_tree.height:Fe.data.height))return void this.fire(new F.z(new Error(`The width and height of the updated image (${qe}, ${He})\n                must be that same as the previous version of the image\n                (${Fe.data.width}, ${Fe.data.height})`)));const Pt=!(Le instanceof HTMLImageElement||ImageBitmap&&Le instanceof ImageBitmap);let jt=!1;Fe.usvg?(Fe.data=new F.r({width:qe,height:He},new Uint8Array(xt)),Fe.usvg=!1,Fe.icon=void 0,jt=!0):Fe.data.replace(xt,Pt),this.style.updateImage(Oe,this.style.scope,Fe,jt)}hasImage(Me){return Me?!!this.style&&!!this.style.getImage(F.I.from(Me),this.style.scope):(this.fire(new F.z(new Error("Missing required image id"))),!1)}removeImage(Me){this.style.removeImage(F.I.from(Me),this.style.scope)}loadImage(Me,Le){F.o(this._requestManager.transformRequest(Me,F.R.Image),((Me,Oe)=>{Le(Me,Oe instanceof HTMLImageElement?F.q.getImageData(Oe):Oe)}))}listImages(){return this.style.listImages().map((F=>F.name))}addModel(F,Me){this._lazyInitEmptyStyle(),this.style.addModel(F,Me)}hasModel(Me){return Me?this.style.hasModel(Me):(this.fire(new F.z(new Error("Missing required model id"))),!1)}removeModel(F){this.style.removeModel(F)}listModels(){return this.style.listModels()}addLayer(F,Me){return this._isValidId(F.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(F,Me),this._update(!0)):this}getSlot(F){const Me=this.getLayer(F);return Me&&Me.slot||null}setSlot(F,Me){return this.style.setSlot(F,Me),this.style.mergeLayers(),this._update(!0)}addImport(F,Me){return this.style.addImport(F,Me),this}updateImport(F,Me){return"string"!=typeof Me&&Me.id!==F?(this.removeImport(F),this.addImport(Me)):(this.style.updateImport(F,Me),this._update(!0))}removeImport(F){return this.style.removeImport(F),this}moveImport(F,Me){return this.style.moveImport(F,Me),this._update(!0)}moveLayer(F,Me){return this._isValidId(F)?(this.style.moveLayer(F,Me),this._update(!0)):this}removeLayer(F){return this._isValidId(F)?(this.style.removeLayer(F),this._update(!0)):this}getLayer(F){if(!this._isValidId(F))return null;const Me=this.style.getOwnLayer(F);return Me?"custom"===Me.type?Me.implementation:Me.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(F,Me,Le){return this._isValidId(F)?(this.style.setLayerZoomRange(F,Me,Le),this._update(!0)):this}setFilter(F,Me,Le={}){return this._isValidId(F)?(this.style.setFilter(F,Me,Le),this._update(!0)):this}getFilter(F){return this._isValidId(F)?this.style.getFilter(F):null}setPaintProperty(F,Me,Le,Oe={}){return this._isValidId(F)?(this.style.setPaintProperty(F,Me,Le,Oe),this._update(!0)):this}getPaintProperty(F,Me){return this._isValidId(F)?this.style.getPaintProperty(F,Me):null}setLayoutProperty(F,Me,Le,Oe={}){return this._isValidId(F)?(this.style.setLayoutProperty(F,Me,Le,Oe),this._update(!0)):this}getLayoutProperty(F,Me){return this._isValidId(F)?this.style.getLayoutProperty(F,Me):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(F){return this.style.setGlyphsUrl(F),this._update(!0)}getSchema(F){return this.style.getSchema(F)}setSchema(F,Me){return this.style.setSchema(F,Me),this._update(!0)}getConfig(F){return this.style.getConfig(F)}setConfig(F,Me){return this.style.setConfig(F,Me),this._update(!0)}getConfigProperty(F,Me){return this.style.getConfigProperty(F,Me)}setConfigProperty(F,Me,Le){return this.style.setConfigProperty(F,Me,Le),this._update(!0)}getFeaturesetDescriptors(F){return this.style.getFeaturesetDescriptors(F)}setLights(F){if(this._lazyInitEmptyStyle(),F&&1===F.length&&"flat"===F[0].type){const Me=F[0];Me.properties?this.style.setFlatLight(Me.properties,Me.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(F),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const F=this.style.getLights()||[];return 0===F.length&&F.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),F}setLight(F,Me={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:F}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(F){return this._lazyInitEmptyStyle(),!F&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(F),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(F){return this._lazyInitEmptyStyle(),this.style.setFog(F),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(F){return this._lazyInitEmptyStyle(),this.style.setSnow(F),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(F){return this._lazyInitEmptyStyle(),this.style.setRain(F),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(F){return this._lazyInitEmptyStyle(),this.style.setColorTheme(F),this._update(!0)}setImportColorTheme(F,Me){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(F,Me),this._update(!0)}setCamera(F){return this.style.setCamera(F),this._triggerCameraUpdate(F)}_triggerCameraUpdate(F){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===F["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(Me){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(F.bO.convert(Me),this.transform):0}setFeatureState(F,Me){return F.source&&!this._isValidId(F.source)?this:(this.style.setFeatureState(F,Me),this._update())}removeFeatureState(F,Me){return F.source&&!this._isValidId(F.source)?this:(this.style.removeFeatureState(F,Me),this._update())}getFeatureState(F){return F.source&&!this._isValidId(F.source)?null:this.style.getFeatureState(F)}_updateContainerDimensions(){if(!this._container)return;const F=this._container.getBoundingClientRect().width||400,Me=this._container.getBoundingClientRect().height||300;let Le,Oe,Fe,je=this._container;for(;je&&(!Oe||!Fe);){const F=window.getComputedStyle(je).transform;F&&"none"!==F&&(Le=F.match(/matrix.*\((.+)\)/)[1].split(", "),Le[0]&&"0"!==Le[0]&&"1"!==Le[0]&&(Oe=Le[0]),Le[3]&&"0"!==Le[3]&&"1"!==Le[3]&&(Fe=Le[3])),je=je.parentElement}this._containerWidth=Oe?Math.abs(F/Oe):F,this._containerHeight=Fe?Math.abs(Me/Fe):Me}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&F.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const F=this._container;F.classList.add("mapboxgl-map"),(this._missingCSSCanary=l("div","mapboxgl-canary",F)).style.visibility="hidden",this._detectMissingCSS();const Me=this._canvasContainer=l("div","mapboxgl-canvas-container",F);this._canvas=l("canvas","mapboxgl-canvas",Me),this._interactive&&(Me.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const Le=this._controlContainer=l("div","mapboxgl-control-container",F),Oe=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((F=>{Oe[F]=l("div",`mapboxgl-ctrl-${F}`,Le)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(Me,Le){const Oe=F.q.devicePixelRatio||1;this._canvas.width=Oe*Math.ceil(Me),this._canvas.height=Oe*Math.ceil(Le),this._canvas.style.width=`${Me}px`,this._canvas.style.height=`${Le}px`}_addMarker(F){this._markers.push(F)}_removeMarker(F){const Me=this._markers.indexOf(F);-1!==Me&&this._markers.splice(Me,1)}_addPopup(F){this._popups.push(F)}_removePopup(F){const Me=this._popups.indexOf(F);-1!==Me&&this._popups.splice(Me,1)}_setupPainter(){const Me=F.l({},qe.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),Le=this._canvas.getContext("webgl2",Me);Le?(V(Le,!0),this.painter=new ea(Le,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",(F=>{"source"===F.dataType&&this.painter.setTileLoadedFlag(!0)})),F.m.testSupport(Le)):this.fire(new F.z(new Error("Failed to initialize WebGL")))}_contextLost(Me){Me.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new F.A("webglcontextlost",{originalEvent:Me}))}_contextRestored(Me){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style.reloadModels(),this.style.clearSources(),this._update(),this.fire(new F.A("webglcontextrestored",{originalEvent:Me}))}_onMapScroll(F){if(F.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(F){return this.style?(this._styleDirty=this._styleDirty||F,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(F){return this._update(),this._renderTaskQueue.add(F)}_cancelRenderFrame(F){this._renderTaskQueue.remove(F)}_requestDomTask(F){!this.loaded()||this.loaded()&&!this.isMoving()?F():this._domRenderTaskQueue.add(F)}_render(Me){let Fe;this.fire(new F.A("renderstart")),++this._frameId;const je=this.painter.context.extTimerQuery,qe=F.q.now(),He=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(Fe=He.createQuery(),He.beginQuery(je.TIME_ELAPSED_EXT,Fe)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(Me),this._domRenderTaskQueue.run(Me),this._removed)return;this._updateProjectionTransition();const xt=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const Me=this.transform.zoom,Le=this.transform.pitch,Oe=F.q.now(),Fe=new F.aa(Me,{now:Oe,fadeDuration:xt,pitch:Le,transition:this.style.transition});this.style.update(Fe)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let Pt=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),Pt=this._updateAverageElevation(qe),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):Pt=this._updateAverageElevation(qe);const jt=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,xt,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),jt&&(this._placementDirty=jt.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:xt,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new F.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Oe.mark(Le.load),this.fire(new F.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),Fe){const Me=F.q.now()-qe;He.endQuery(je.TIME_ELAPSED_EXT),setTimeout((()=>{const Le=He.getQueryParameter(Fe,He.QUERY_RESULT)/1e6;He.deleteQuery(Fe),this.fire(new F.A("gpu-timing-frame",{cpuTime:Me,gpuTime:Le}))}),50)}if(this.listens("gpu-timing-layer")){const Me=this.painter.collectGpuTimers();setTimeout((()=>{const Le=this.painter.queryGpuTimers(Me);this.fire(new F.A("gpu-timing-layer",{layerTimes:Le}))}),50)}if(this.listens("gpu-timing-deferred-render")){const Me=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const Le=this.painter.queryGpuTimeDeferredRender(Me);this.fire(new F.A("gpu-timing-deferred-render",{gpuTime:Le}))}),50)}const Gt=this._sourcesDirty||this._styleDirty||this._placementDirty||Pt;if(Gt||this._repaint)this.triggerRepaint();else{const Me=this.idle();if(Me&&(Pt=this._updateAverageElevation(qe,!0)),Pt)this.triggerRepaint();else if(this._triggerFrame(!1),Me&&(this.fire(new F.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const Me=this._calculateSpeedIndex();this.fire(new F.A("speedindexcompleted",{speedIndex:Me})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||Gt||(this._fullyLoaded=!0,Oe.mark(Le.fullLoad),this._performanceMetricsCollection&&zs(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(F){for(const Me of this._markers)F&&!this.getRenderWorldCopies()&&(Me._lngLat=Me._lngLat.wrap()),Me._update();for(const Me of this._popups)!F||this.getRenderWorldCopies()||Me._trackPointer||(Me._lngLat=Me._lngLat.wrap()),Me._update()}_updateAverageElevation(F,Me=!1){const i=F=>(this.transform.averageElevation=F,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const Le=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(Le||(Me||F-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(F)){const Me=this.transform.averageElevation;let Oe=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(Oe)?Oe=0:this._averageElevationLastSampledAt=F;const Fe=Math.abs(Me-Oe);if(Fe>1){if(this._isInitialLoad||Le)return this._averageElevation.jumpTo(Oe),i(Oe);this._averageElevation.easeTo(Oe,F,300)}else if(Fe>1e-4)return this._averageElevation.jumpTo(Oe),i(Oe)}return!!this._averageElevation.isEasing(F)&&i(this._averageElevation.getValue(F))}_authenticate(){na(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(Me=>{if(Me&&(Me.message===Gt||401===Me.status)){const Me=this.painter.context.gl;V(Me,!1),this._logoControl instanceof ol&&this._logoControl._updateLogo(),Me&&Me.clear(Me.DEPTH_BUFFER_BIT|Me.COLOR_BUFFER_BIT|Me.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new F.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),yo(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&Ro(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const F=this._isDragging();this.painter.updateTerrain(this.style,F)}_calculateSpeedIndex(){const F=this.painter.canvasCopy(),Me=this.painter.getCanvasCopiesAndTimestamps();Me.timeStamps.push(performance.now());const Le=this.painter.context.gl,Oe=Le.createFramebuffer();function s(F){Le.framebufferTexture2D(Le.FRAMEBUFFER,Le.COLOR_ATTACHMENT0,Le.TEXTURE_2D,F,0);const Me=new Uint8Array(Le.drawingBufferWidth*Le.drawingBufferHeight*4);return Le.readPixels(0,0,Le.drawingBufferWidth,Le.drawingBufferHeight,Le.RGBA,Le.UNSIGNED_BYTE,Me),Me}return Le.bindFramebuffer(Le.FRAMEBUFFER,Oe),this._canvasPixelComparison(s(F),Me.canvasCopies.map(s),Me.timeStamps)}_canvasPixelComparison(F,Me,Le){let Oe=Le[1]-Le[0];const Fe=F.length/4;for(let je=0;je<Me.length;je++){const qe=Me[je];let He=0;for(let Me=0;Me<qe.length;Me+=4)qe[Me]===F[Me]&&qe[Me+1]===F[Me+1]&&qe[Me+2]===F[Me+2]&&qe[Me+3]===F[Me+3]&&(He+=1);Oe+=(Le[je+2]-Le[je+1])*(1-He/Fe)}return Oe}remove(){this._hash&&this._hash.remove();for(const F of this._controls)F.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const Me=this.painter.context.gl.getExtension("WEBGL_lose_context");Me&&Me.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),el.delete(this.painter.context.gl),Zs.remove(),Yn.remove(),this._removed=!0,this.fire(new F.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(Me){this._renderNextFrame=this._renderNextFrame||Me,this.style&&!this._frame&&(this._frame=F.q.frame((F=>{const Me=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,Me&&this._render(F)})))}_preloadTiles(Me){const Le=this.style?this.style.getSourceCaches():[];return F.bl(Le,((F,Le)=>F._preloadTiles(Me,Le)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(F){this._trackResize&&this.resize({originalEvent:F})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(F){this._showTileBoundaries!==F&&(this._showTileBoundaries=F,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(F){this._showParseStatus!==F&&(this._showParseStatus=F,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(F){this._showTerrainWireframe!==F&&(this._showTerrainWireframe=F,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(F){this._showLayers2DWireframe!==F&&(this._showLayers2DWireframe=F,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(F){this._showLayers3DWireframe!==F&&(this._showLayers3DWireframe=F,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(F){this._speedIndexTiming!==F&&(this._speedIndexTiming=F,this._update())}get showPadding(){return!!this._showPadding}set showPadding(F){this._showPadding!==F&&(this._showPadding=F,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(F){this._showCollisionBoxes!==F&&(this._showCollisionBoxes=F,this._tp.refreshUI(),F?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(F){this._showOverdrawInspector!==F&&(this._showOverdrawInspector=F,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(F){this._repaint!==F&&(this._repaint=F,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(F){this._vertices=F,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(F){this._showTileAABBs!==F&&(this._showTileAABBs=F,this._tp.refreshUI(),F&&this._update())}_setCacheLimits(Me,Le){F.dJ(Me,Le)}get version(){return Me}},NavigationControl:class{constructor(Me={}){this.options=F.l({},$f,Me),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(F=>F.preventDefault())),this.options.showZoom&&(F.aQ(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(F=>{this._map&&this._map.zoomIn({},{originalEvent:F})})),l("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(F=>{this._map&&this._map.zoomOut({},{originalEvent:F})})),l("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(F.aQ(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(F=>{const Me=this._map;Me&&(this.options.visualizePitch?Me.resetNorthPitch({},{originalEvent:F}):Me.resetNorth({},{originalEvent:F}))})),this._compassIcon=l("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const F=this._map;if(!F)return;const Me=F.getZoom(),Le=Me===F.getMaxZoom(),Oe=Me===F.getMinZoom();this._zoomInButton.disabled=Le,this._zoomOutButton.disabled=Oe,this._zoomInButton.setAttribute("aria-disabled",Le.toString()),this._zoomOutButton.setAttribute("aria-disabled",Oe.toString())}_rotateCompassArrow(){const F=this._map;if(!F)return;const Me=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(F.transform.pitch*(Math.PI/180)),.5)}) rotateX(${F.transform.pitch}deg) rotateZ(${F.transform.angle*(180/Math.PI)}deg)`:`rotate(${F.transform.angle*(180/Math.PI)}deg)`;F._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=Me)}))}onAdd(F){return this._map=F,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),F.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&F.on("pitch",this._rotateCompassArrow),F.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new ul(F,this._compass,this.options.visualizePitch)),this._container}onRemove(){const F=this._map;F&&(this._container.remove(),this.options.showZoom&&F.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&F.off("pitch",this._rotateCompassArrow),F.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(F,Me){const Le=l("button",F,this._container);return Le.type="button",Le.addEventListener("click",Me),Le}_setButtonTitle(F,Me){if(!this._map)return;const Le=this._map._getUIString(`NavigationControl.${Me}`);F.setAttribute("aria-label",Le),F.firstElementChild&&F.firstElementChild.setAttribute("title",Le)}},GeolocateControl:class extends F.E{constructor(Me={}){super();const Le=navigator.geolocation;this.options=F.l({geolocation:Le},nm,Me),F.aQ(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=ta(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(F){return this._map=F,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(F){const t=(Me=!!this.options.geolocation)=>{this._supportsGeolocation=Me,F(Me)};void 0!==this._supportsGeolocation?F(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((F=>t("denied"!==F.state))).catch((()=>t())):t()}_isOutOfMapMaxBounds(F){const Me=this._map.getMaxBounds(),Le=F.coords;return!!Me&&(Le.longitude<Me.getWest()||Le.longitude>Me.getEast()||Le.latitude<Me.getSouth()||Le.latitude>Me.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(Me){if(this._map){if(this._isOutOfMapMaxBounds(Me))return this._setErrorState(),this.fire(new F.A("outofmaxbounds",Me)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=Me,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(Me),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(Me),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new F.A("geolocate",Me)),this._finish()}}_updateCamera(Me){const Le=new F.bO(Me.coords.longitude,Me.coords.latitude),Oe=Me.coords.accuracy,Fe=this._map.getBearing(),je=F.l({bearing:Fe},this.options.fitBoundsOptions);this._map.fitBounds(Le.toBounds(Oe),je,{geolocateSource:!0})}_updateMarker(Me){if(Me){const Le=new F.bO(Me.coords.longitude,Me.coords.latitude);this._accuracyCircleMarker.setLngLat(Le).addTo(this._map),this._userLocationDotMarker.setLngLat(Le).addTo(this._map),this._accuracy=Me.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const Me=this._map.transform,Le=F.bH(1,Me._center.lat)*Me.worldSize,Oe=Math.ceil(2*this._accuracy*Le);this._circleElement.style.width=`${Oe}px`,this._circleElement.style.height=`${Oe}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(Me){if(this._map){if(this.options.trackUserLocation)if(1===Me.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const F=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===Me.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new F.A("error",Me)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(Me){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(F=>F.preventDefault())),this._geolocateButton=l("button","mapboxgl-ctrl-geolocate",this._container),l("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===Me){F.w("Geolocation support is not available so the GeolocateControl will be disabled.");const Me=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",Me),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",Me)}else{const F=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=l("div","mapboxgl-user-location"),this._dotElement.appendChild(l("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(l("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ml({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=l("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ml({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(Me=>{Me.geolocateSource||"ACTIVE_LOCK"!==this._watchState||Me.originalEvent&&"resize"===Me.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new F.A("trackuserlocationend")))}))}}_onDeviceOrientation(F){this._userLocationDotMarker&&(F.webkitCompassHeading?this._heading=F.webkitCompassHeading:!0===F.absolute&&(this._heading=-1*F.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return F.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new F.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new F.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new F.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let F;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(F={maximumAge:6e5,timeout:0},this._noTimeout=!0):(F=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,F),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((F=>{"granted"===F&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:il,ScaleControl:class{constructor(Me={}){this.options=F.l({},sm,Me),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(F){return!1}}(),F.aQ(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const F=this.options.maxWidth||100,Me=this._map,Le=Me._containerHeight/2,Oe=Me._containerWidth/2-F/2,Fe=Me.unproject([Oe,Le]),je=Me.unproject([Oe+F,Le]),qe=Fe.distanceTo(je);if("imperial"===this.options.unit){const Me=3.2808*qe;Me>5280?this._setScale(F,Me/5280,"mile"):this._setScale(F,Me,"foot")}else"nautical"===this.options.unit?this._setScale(F,qe/1852,"nautical-mile"):qe>=1e3?this._setScale(F,qe/1e3,"kilometer"):this._setScale(F,qe,"meter")}_setScale(F,Me,Le){this._map._requestDomTask((()=>{const Oe=function(F){const Me=Math.pow(10,`${Math.floor(F)}`.length-1);let Le=F/Me;return Le=Le>=10?10:Le>=5?5:Le>=3?3:Le>=2?2:Le>=1?1:function(F){const Me=Math.pow(10,Math.ceil(-Math.log(F)/Math.LN10));return Math.round(F*Me)/Me}(Le),Me*Le}(Me),Fe=Oe/Me;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==Le?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:Le}).format(Oe):`${Oe}&nbsp;${am[Le]}`,this._container.style.width=F*Fe+"px"}))}onAdd(F){return this._map=F,this._language=F.getLanguage(),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-scale",F.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(F){this._language=F,this._update()}setUnit(F){this.options.unit=F,this._update()}},FullscreenControl:class{constructor(Me={}){this._fullscreen=!1,Me&&Me.container&&(Me.container instanceof HTMLElement?this._container=Me.container:F.w("Full screen control 'container' must be a DOM element.")),F.aQ(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(Me){return this._map=Me,this._container||(this._container=this._map.getContainer()),this._controlContainer=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",F.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const F=this._fullscreenButton=l("button","mapboxgl-ctrl-fullscreen",this._controlContainer);l("span","mapboxgl-ctrl-icon",F).setAttribute("aria-hidden","true"),F.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const F=this._getTitle();this._fullscreenButton.setAttribute("aria-label",F),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",F)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends F.E{constructor(Me){super(),this.options=F.l(Object.create(um),Me),this._altitude=this.options.altitude,F.aQ(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(Me&&Me.className?Me.className.trim().split(/\s+/):[])}addTo(Me){return this._map&&this.remove(),this._map=Me,this.options.closeOnClick&&Me.on("preclick",this._onClose),this.options.closeOnMove&&Me.on("move",this._onClose),Me.on("remove",this.remove),this._update(),Me._addPopup(this),this._focusFirstElement(),this._trackPointer?(Me.on("mousemove",this._onMouseEvent),Me.on("mouseup",this._onMouseEvent),Me._canvasContainer.classList.add("mapboxgl-track-pointer")):Me.on("move",this._update),this.fire(new F.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const Me=this._map;return Me&&(Me.off("move",this._update),Me.off("move",this._onClose),Me.off("preclick",this._onClose),Me.off("click",this._onClose),Me.off("remove",this.remove),Me.off("mousemove",this._onMouseEvent),Me.off("mouseup",this._onMouseEvent),Me.off("drag",this._onMouseEvent),Me._canvasContainer&&Me._canvasContainer.classList.remove("mapboxgl-track-pointer"),Me._removePopup(this),this._map=void 0),this.fire(new F.A("close")),this}getLngLat(){return this._lngLat}setLngLat(Me){this._lngLat=F.bO.convert(Me),this._pos=null,this._trackPointer=!1,this._update();const Le=this._map;return Le&&(Le.on("move",this._update),Le.off("mousemove",this._onMouseEvent),Le._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(F){return this._altitude=F,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const F=this._map;return F&&(F.off("move",this._update),F.on("mousemove",this._onMouseEvent),F.on("drag",this._onMouseEvent),F._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(F){return this.setDOMContent(document.createTextNode(F))}setHTML(F){const Me=document.createDocumentFragment(),Le=document.createElement("body");let Oe;for(Le.innerHTML=F;Oe=Le.firstChild,Oe;)Me.appendChild(Oe);return this.setDOMContent(Me)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(F){return this.options.maxWidth=F,this._update(),this}setDOMContent(F){let Me=this._content;if(Me)for(;Me.hasChildNodes();)Me.firstChild&&Me.removeChild(Me.firstChild);else Me=this._content=l("div","mapboxgl-popup-content",this._container||void 0);if(Me.appendChild(F),this.options.closeButton){const F=this._closeButton=l("button","mapboxgl-popup-close-button",Me);F.type="button",F.setAttribute("aria-label","Close popup"),F.innerHTML='<span aria-hidden="true">&#215;</span>',F.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(F){return this._classList.add(F),this._updateClassList(),this}removeClassName(F){return this._classList.delete(F),this._updateClassList(),this}setOffset(F){return this.options.offset=F,this._update(),this}toggleClassName(F){let Me;return this._classList.delete(F)?Me=!1:(this._classList.add(F),Me=!0),this._updateClassList(),Me}_onMouseEvent(F){this._update(F.point)}_getAnchor(F){if(this.options.anchor)return this.options.anchor;const Me=this._map,Le=this._container,Oe=this._pos;if(!Me||!Le||!Oe)return"bottom";const Fe=Le.offsetWidth,je=Le.offsetHeight,qe=Oe.x<Fe/2,He=Oe.x>Me.transform.width-Fe/2;if(Oe.y+F<je)return qe?"top-left":He?"top-right":"top";if(Oe.y>Me.transform.height-je){if(qe)return"bottom-left";if(He)return"bottom-right"}return qe?"left":He?"right":"bottom"}_updateClassList(){const F=this._container;if(!F)return;const Me=[...this._classList];Me.push("mapboxgl-popup"),this._anchor&&Me.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&Me.push("mapboxgl-popup-track-pointer"),F.className=Me.join(" ")}_update(Me){const Le=this._map,Oe=this._content;if(!Le||!this._lngLat&&!this._trackPointer||!Oe)return;let Fe=this._container;if(Fe||(Fe=this._container=l("div","mapboxgl-popup",Le.getContainer()),this._tip=l("div","mapboxgl-popup-tip",Fe),Fe.appendChild(Oe)),this.options.maxWidth&&Fe.style.maxWidth!==this.options.maxWidth&&(Fe.style.maxWidth=this.options.maxWidth),Le.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=_l(this._lngLat,this._pos,Le.transform)),!this._trackPointer||Me){const Oe=this._pos=this._trackPointer&&Me instanceof F.P?Me:Le.project(this._lngLat,this._altitude),Fe=wl(this.options.offset),je=this._anchor=this._getAnchor(Fe.y),qe=wl(this.options.offset,je),He=Oe.add(qe).round();Le._requestDomTask((()=>{this._container&&je&&(this._container.style.transform=`${im[je]} translate(${He.x}px,${He.y}px)`)}))}if(!this._marker&&Le._showingGlobe()){const Me=F.dK(Le.transform,this._lngLat)?0:1;this._setOpacity(Me)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const F=this._container.querySelector(fm);F&&F.focus()}_onClose(){this.remove()}_setOpacity(F){this._container&&(this._container.style.opacity=`${F}`),this._content&&(this._content.style.pointerEvents=F?"auto":"none")}},Marker:ml,Style:To,LngLat:F.bO,LngLatBounds:F.aB,Point:F.P,MercatorCoordinate:F.ac,FreeCameraOptions:Wi,Evented:F.E,config:F.e,prewarm:F.dP,clearPrewarmedResources:F.dQ,get accessToken(){return F.e.ACCESS_TOKEN},set accessToken(Me){F.e.ACCESS_TOKEN=Me},get baseApiUrl(){return F.e.API_URL},set baseApiUrl(Me){F.e.API_URL=Me},get workerCount(){return F.dR.workerCount},set workerCount(Me){F.dR.workerCount=Me},get maxParallelImageRequests(){return F.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(Me){F.e.MAX_PARALLEL_IMAGE_REQUESTS=Me},clearStorage(Me){F.dS(Me)},get workerUrl(){return F.dT.workerUrl},set workerUrl(Me){F.dT.workerUrl=Me},get workerClass(){return F.dT.workerClass},set workerClass(Me){F.dT.workerClass=Me},get workerParams(){return F.dT.workerParams},set workerParams(Me){F.dT.workerParams=Me},get dracoUrl(){return F.dU()},set dracoUrl(Me){F.dV(Me)},get meshoptUrl(){return F.dW()},set meshoptUrl(Me){F.dX(Me)},setNow:F.q.setNow,restoreNow:F.q.restoreNow};return mm}));var Fe=Oe;return Fe}));var Le=Me;export{Le as default};

